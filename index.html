<!doctype html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <meta name="theme-color" content="#0f2027" />
    <link rel="manifest" href="./manifest.webmanifest" />
    <title>University Schedule |Amirmahdi</title>

    <!-- Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@500;700&family=Space+Grotesk:wght@500;700&family=Vazirmatn:wght@300;400;500;700;900&display=swap"
      rel="stylesheet"
    />

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              vazir: ["Vazirmatn", "Tahoma", "Segoe UI", "sans-serif"],
              inter: ["Inter", "Segoe UI", "Roboto", "Arial", "sans-serif"],
            },
            animation: {
              "pulse-slow": "pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite",
              float: "float 7s ease-in-out infinite",
              "fade-in": "fadeIn 0.55s ease-out",
              glow: "glow 2.8s ease-in-out infinite",
            },
            keyframes: {
              float: {
                "0%,100%": { transform: "translateY(0)" },
                "50%": { transform: "translateY(-10px)" },
              },
              fadeIn: {
                "0%": { opacity: "0", transform: "translateY(10px)" },
                "100%": { opacity: "1", transform: "translateY(0)" },
              },
              glow: {
                "0%,100%": { filter: "brightness(1) saturate(1)" },
                "50%": { filter: "brightness(1.12) saturate(1.15)" },
              },
            },
          },
        },
      };
    </script>

    <style>
      :root {
        --transition-speed: 260ms;
        --font-fa: "Vazirmatn", "Tahoma", "Segoe UI", sans-serif;
        --font-en: "Inter", "Segoe UI", "Roboto", "Arial", sans-serif;
        --font-time: "JetBrains Mono", "Inter", "Segoe UI", monospace;
        --font-attendance-num:
          "Space Grotesk", "JetBrains Mono", "Inter", "Segoe UI", monospace;
        --app-vh: 100vh;
        --app-vw: 100vw;
      }
      @supports (height: 100dvh) {
        :root {
          --app-vh: 100dvh;
          --app-vw: 100dvw;
        }
      }

      html {
        -webkit-text-size-adjust: 100%;
        text-size-adjust: 100%;
        font-kerning: normal;
        text-rendering: optimizeLegibility;
      }

      :lang(fa),
      [dir="rtl"] {
        font-feature-settings:
          "kern" 1,
          "liga" 1,
          "calt" 1,
          "ss01" 1;
      }

      body {
        transition:
          background-color var(--transition-speed),
          color var(--transition-speed);
        font-family: var(--font-fa);
        text-rendering: optimizeLegibility;
        font-kerning: normal;
        font-optical-sizing: auto;
        font-synthesis: none;
        letter-spacing: 0;
        word-spacing: 0;
        line-height: 1.6;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      input,
      select,
      textarea,
      button {
        font: inherit;
      }
      [dir="rtl"] input,
      [dir="rtl"] textarea {
        text-align: right;
        direction: rtl;
      }
      [dir="rtl"] input[type="time"],
      [dir="rtl"] input[type="date"] {
        text-align: left;
        direction: ltr;
        font-family: var(--font-en);
      }

      ::placeholder {
        opacity: 0.75;
      }

      /* Scrollbar */
      ::-webkit-scrollbar {
        width: 7px;
        height: 7px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: rgba(128, 128, 128, 0.35);
        border-radius: 999px;
      }

      /* ------------------------------
      THEME ENGINE (14 THEMES)
    ------------------------------ */

      /* 1) Glassmorphism 2.0 */
      body[data-theme="glass"] {
        --bg: #0b1226;
        --text: #f8fafc;
        --accent: #7c3aed;
        --accent2: #22d3ee;
        --card-bg: rgba(255, 255, 255, 0.06);
        --border: rgba(255, 255, 255, 0.12);
        --muted: rgba(248, 250, 252, 0.68);
      }
      body[data-theme="glass"] .theme-card {
        backdrop-filter: blur(18px);
        -webkit-backdrop-filter: blur(18px);
        border: 1px solid var(--border);
        border-radius: 22px;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.08),
          rgba(255, 255, 255, 0.04)
        );
        box-shadow:
          0 20px 60px rgba(0, 0, 0, 0.35),
          inset 0 1px 0 rgba(255, 255, 255, 0.08);
      }

      /* 2) Neo-Brutal Pro */
      body[data-theme="brutal"] {
        --bg: #f5f5f5;
        --text: #0b0b0b;
        --accent: #111;
        --accent2: #ff4d00;
        --card-bg: #ffffff;
        --border: #0b0b0b;
        --muted: rgba(0, 0, 0, 0.65);
        font-weight: 700;
      }
      body[data-theme="brutal"] .theme-card {
        border: 3px solid var(--border);
        box-shadow: 10px 10px 0 var(--border);
        border-radius: 16px;
        background: var(--card-bg);
      }

      /* 3) Dark Luxury */
      body[data-theme="luxury"] {
        --bg: #060606;
        --text: #f7e7b4;
        --accent: #d4af37;
        --accent2: #ff7a18;
        --card-bg: rgba(255, 255, 255, 0.05);
        --border: rgba(212, 175, 55, 0.28);
        --muted: rgba(247, 231, 180, 0.7);
      }
      body[data-theme="luxury"] .theme-card {
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-top: 1px solid rgba(212, 175, 55, 0.35);
        border-radius: 18px;
        background:
          radial-gradient(
            1200px 260px at 20% -10%,
            rgba(212, 175, 55, 0.1),
            transparent 60%
          ),
          linear-gradient(
            180deg,
            rgba(255, 255, 255, 0.06),
            rgba(255, 255, 255, 0.03)
          );
        box-shadow: 0 22px 70px rgba(0, 0, 0, 0.55);
      }

      /* 4) Hacker Clean */
      body[data-theme="hacker"] {
        --bg: #020617;
        --text: #00ff7a;
        --accent: #00ff41;
        --accent2: #22d3ee;
        --card-bg: rgba(0, 0, 0, 0.55);
        --border: rgba(0, 255, 65, 0.22);
        --muted: rgba(0, 255, 122, 0.62);
      }
      body[data-theme="hacker"] .theme-card {
        border: 1px solid var(--border);
        border-radius: 14px;
        background: linear-gradient(
          180deg,
          rgba(0, 0, 0, 0.55),
          rgba(0, 0, 0, 0.35)
        );
        box-shadow:
          0 0 0 1px rgba(0, 255, 65, 0.1) inset,
          0 18px 50px rgba(0, 0, 0, 0.55);
      }

      /* 5) Aurora / Gradient Mesh */
      body[data-theme="aurora"] {
        --bg: #0a0922;
        --text: #ffffff;
        --accent: #ff2da0;
        --accent2: #22d3ee;
        --card-bg: rgba(255, 255, 255, 0.08);
        --border: rgba(255, 255, 255, 0.16);
        --muted: rgba(255, 255, 255, 0.7);
      }
      body[data-theme="aurora"] .theme-card {
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid var(--border);
        border-radius: 26px;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.11),
          rgba(255, 255, 255, 0.05)
        );
        box-shadow: 0 26px 80px rgba(0, 0, 0, 0.45);
      }

      /* 6) Monochrome Minimal */
      body[data-theme="mono"] {
        --bg: #ffffff;
        --text: #0b0b0b;
        --accent: #111111;
        --accent2: #16a34a;
        --card-bg: rgba(255, 255, 255, 0.92);
        --border: rgba(0, 0, 0, 0.1);
        --muted: rgba(0, 0, 0, 0.62);
      }
      body[data-theme="mono"] .theme-card {
        border: 1px solid var(--border);
        border-radius: 18px;
        background: var(--card-bg);
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.06);
      }

      /* 7) Soft Neumorphism (Modern) */
      body[data-theme="soft"] {
        --bg: #e7ebf2;
        --text: #1f2937;
        --accent: #5865f2;
        --accent2: #06b6d4;
        --card-bg: #e7ebf2;
        --border: transparent;
        --muted: rgba(31, 41, 55, 0.62);
      }
      body[data-theme="soft"] .theme-card {
        border-radius: 22px;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.55),
          rgba(255, 255, 255, 0.25)
        );
        box-shadow:
          14px 14px 30px rgba(159, 170, 190, 0.5),
          -14px -14px 30px rgba(255, 255, 255, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.55);
      }

      /* 8) Material You */
      body[data-theme="material"] {
        --bg: #fef7ff;
        --text: #1d1b20;
        --accent: #6750a4;
        --accent2: #00b4d8;
        --card-bg: rgba(255, 255, 255, 0.8);
        --border: rgba(0, 0, 0, 0.08);
        --muted: rgba(29, 27, 32, 0.62);
      }
      body[data-theme="material"] .theme-card {
        border-radius: 30px;
        background: linear-gradient(to top, #a18cd1 0%, #fbc2eb 100%);
        border: 1px solid rgba(0, 0, 0, 0.06);
        box-shadow: 0 16px 40px rgba(0, 0, 0, 0.08);
      }

      /* 9) Frosted + Noise */
      body[data-theme="frosted"] {
        --bg: #151311;
        --text: #f3f4f6;
        --accent: #2dd4bf;
        --accent2: #a78bfa;
        --card-bg: rgba(255, 255, 255, 0.04);
        --border: rgba(255, 255, 255, 0.1);
        --muted: rgba(243, 244, 246, 0.7);
      }
      body[data-theme="frosted"] .theme-card {
        backdrop-filter: blur(42px);
        -webkit-backdrop-filter: blur(42px);
        border-radius: 18px;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.06),
          rgba(255, 255, 255, 0.02)
        );
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 26px 80px rgba(0, 0, 0, 0.55);
      }
      body[data-theme="frosted"] .theme-card:not(.top-nav) {
        position: relative;
        overflow: hidden;
      }
      body[data-theme="frosted"] .top-nav.theme-card {
        position: sticky !important;
      }

      /* 10) Editorial */
      body[data-theme="editorial"] {
        --bg: #fffbf0;
        --text: #141414;
        --accent: #d93025;
        --accent2: #111;
        --card-bg: rgba(255, 255, 255, 0.7);
        --border: rgba(0, 0, 0, 0.12);
        --muted: rgba(20, 20, 20, 0.62);
      }
      body[data-theme="editorial"] .theme-card {
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.7);
        border: 1px solid rgba(0, 0, 0, 0.12);
        box-shadow: 0 12px 26px rgba(0, 0, 0, 0.08);
      }

      /* 11) Mathematics Light */
      body[data-theme="mathlight"] {
        --bg: #fff9ea;
        --text: #4a2a34;
        --accent: #ff9a9e;
        --accent2: #fad0c4;
        --card-bg: rgba(255, 250, 236, 0.9);
        --border: rgba(255, 154, 158, 0.32);
        --muted: rgba(88, 52, 66, 0.66);
      }
      body[data-theme="mathlight"] .theme-card {
        border-radius: 20px;
        background:
          radial-gradient(
            1200px 240px at 10% -10%,
            rgba(255, 154, 158, 0.22),
            transparent 60%
          ),
          radial-gradient(
            1200px 260px at 90% 110%,
            rgba(250, 208, 196, 0.28),
            transparent 62%
          ),
          linear-gradient(45deg, #ff9a9e 0%, #fad0c4 99%, #fad0c4 100%);
        border: 1px solid color-mix(in srgb, var(--accent) 24%, var(--border));
        box-shadow:
          0 18px 44px rgba(74, 35, 52, 0.16),
          inset 0 1px 0 rgba(255, 255, 255, 0.72);
      }
      body[data-theme="mathlight"] .control-surface,
      body[data-theme="mathlight"] .control-btn:not(.danger-btn),
      body[data-theme="mathlight"] .week-toggle,
      body[data-theme="mathlight"] .tools-panel,
      body[data-theme="mathlight"] .top-nav,
      body[data-theme="mathlight"] .search-input,
      body[data-theme="mathlight"] .inp,
      body[data-theme="mathlight"] .chip,
      body[data-theme="mathlight"] .schedule-hint {
        background: linear-gradient(
          45deg,
          #ff9a9e 0%,
          #fad0c4 99%,
          #fad0c4 100%
        );
        color: #3f2135;
        border-color: rgba(83, 49, 66, 0.24) !important;
      }
      body[data-theme="mathlight"] .control-btn:not(.danger-btn):hover {
        filter: brightness(1.04);
      }
      body[data-theme="mathlight"] select option {
        background: #fad0c4;
        color: #3f2135;
      }

      /* 12) Mathematics Dark */
      body[data-theme="mathdark"] {
        --bg: #0f2027;
        --text: #deedf4;
        --accent: #2c5364;
        --accent2: #203a43;
        --card-bg: rgba(12, 27, 34, 0.78);
        --border: rgba(44, 83, 100, 0.34);
        --muted: rgba(177, 204, 216, 0.74);
      }
      body[data-theme="mathdark"] .theme-card {
        border-radius: 20px;
        border: 1px solid color-mix(in srgb, var(--accent) 30%, var(--border));
        background:
          linear-gradient(
            120deg,
            rgba(15, 32, 39, 0.28) 0%,
            rgba(32, 58, 67, 0.24) 52%,
            rgba(44, 83, 100, 0.22) 100%
          ),
          radial-gradient(
            1200px 260px at 90% -10%,
            rgba(44, 83, 100, 0.22),
            transparent 62%
          ),
          radial-gradient(
            1200px 320px at 0% 100%,
            rgba(32, 58, 67, 0.2),
            transparent 62%
          ),
          linear-gradient(180deg, rgba(9, 21, 27, 0.9), rgba(11, 24, 31, 0.82));
        box-shadow:
          0 24px 70px rgba(5, 12, 16, 0.65),
          inset 0 1px 0 rgba(157, 188, 201, 0.18);
      }

      /* 13) Chemistry Light */
      body[data-theme="chemistrylight"] {
        --bg: #f8fafc;
        --text: #1f2937;
        --accent: #8ec5fc;
        --accent2: #e0c3fc;
        --card-bg: rgba(255, 255, 255, 0.86);
        --border: rgba(71, 85, 105, 0.18);
        --muted: rgba(51, 65, 85, 0.7);
      }
      body[data-theme="chemistrylight"] .theme-card {
        border-radius: 20px;
        border: 1px solid color-mix(in srgb, var(--accent) 24%, var(--border));
        background:
          radial-gradient(
            1000px 220px at 10% -10%,
            rgba(255, 255, 255, 0.54),
            transparent 62%
          ),
          linear-gradient(
            160deg,
            rgba(255, 255, 255, 0.88),
            rgba(248, 250, 252, 0.72)
          );
        box-shadow:
          0 16px 40px rgba(100, 116, 139, 0.2),
          inset 0 1px 0 rgba(255, 255, 255, 0.8);
      }

      /* 14) Chemistry Dark */
      body[data-theme="chemistrydark"] {
        --bg: #111827;
        --text: #eff6ff;
        --accent: #8ec5fc;
        --accent2: #e0c3fc;
        --card-bg: rgba(15, 23, 42, 0.68);
        --border: rgba(148, 163, 184, 0.22);
        --muted: rgba(191, 219, 254, 0.72);
      }
      body[data-theme="chemistrydark"] .theme-card {
        border-radius: 20px;
        border: 1px solid color-mix(in srgb, var(--accent2) 26%, var(--border));
        background:
          radial-gradient(
            1000px 240px at 14% -8%,
            rgba(224, 195, 252, 0.2),
            transparent 62%
          ),
          linear-gradient(
            155deg,
            rgba(15, 23, 42, 0.86),
            rgba(17, 24, 39, 0.74)
          );
        box-shadow:
          0 24px 62px rgba(2, 6, 23, 0.52),
          inset 0 1px 0 rgba(255, 255, 255, 0.12);
      }

      /* ------------------------------
      BACKGROUND ENGINE (ALL THEMES)
      - each theme gets its own animated layer
    ------------------------------ */
      .bg-anim-layer {
        position: fixed;
        inset: 0;
        z-index: -10;
        overflow: hidden;
        pointer-events: none;
      }
      .bg-layer {
        position: absolute;
        inset: -2px;
        opacity: 0;
        transition: opacity 450ms ease;
      }
      .symbol-layer {
        position: absolute;
        inset: 0;
        opacity: 0;
        transition: opacity 450ms ease;
        overflow: hidden;
      }
      .scanline {
        position: absolute;
        inset: 0;
        opacity: 0;
        transition: opacity 450ms ease;
      }

      .orb {
        position: absolute;
        border-radius: 999px;
        filter: blur(110px);
        opacity: 0.22;
        mix-blend-mode: screen;
      }
      .orb-a {
        width: 640px;
        height: 640px;
        top: -220px;
        left: -220px;
        background: color-mix(in srgb, var(--accent) 78%, transparent);
      }
      .orb-b {
        width: 620px;
        height: 620px;
        bottom: -240px;
        right: -220px;
        background: color-mix(in srgb, var(--accent2) 70%, transparent);
      }
      .orb-c {
        width: 460px;
        height: 460px;
        top: 20%;
        right: -180px;
        background: rgba(59, 130, 246, 0.55);
        opacity: 0.14;
      }

      .grain {
        position: absolute;
        inset: 0;
        opacity: 0;
        transition: opacity 450ms ease;
      }

      body[data-theme="glass"] .bg-glass {
        opacity: 1;
      }
      body[data-theme="brutal"] .bg-brutal {
        opacity: 1;
      }
      body[data-theme="luxury"] .bg-luxury {
        opacity: 1;
      }
      body[data-theme="hacker"] .bg-hacker {
        opacity: 1;
      }
      body[data-theme="aurora"] .bg-aurora {
        opacity: 1;
      }
      body[data-theme="mono"] .bg-mono {
        opacity: 1;
      }
      body[data-theme="soft"] .bg-soft {
        opacity: 1;
      }
      body[data-theme="material"] .bg-material {
        opacity: 1;
      }
      body[data-theme="frosted"] .bg-frosted {
        opacity: 1;
      }
      body[data-theme="editorial"] .bg-editorial {
        opacity: 1;
      }
      body[data-theme="mathlight"] .bg-mathlight {
        opacity: 1;
      }
      body[data-theme="mathdark"] .bg-mathdark {
        opacity: 1;
      }
      body[data-theme="chemistrylight"] .bg-chemistrylight {
        opacity: 1;
      }
      body[data-theme="chemistrydark"] .bg-chemistrydark {
        opacity: 1;
      }
      body[data-theme="glass"] .sym-glass {
        opacity: 0.48;
      }
      body[data-theme="brutal"] .sym-brutal {
        opacity: 0.42;
      }
      body[data-theme="luxury"] .sym-luxury {
        opacity: 0.5;
      }
      body[data-theme="hacker"] .sym-hacker {
        opacity: 0.82;
      }
      body[data-theme="aurora"] .sym-aurora {
        opacity: 0.46;
      }
      body[data-theme="mono"] .sym-mono {
        opacity: 0.38;
      }
      body[data-theme="soft"] .sym-soft {
        opacity: 0.42;
      }
      body[data-theme="material"] .sym-material {
        opacity: 0.44;
      }
      body[data-theme="frosted"] .sym-frosted {
        opacity: 0.52;
      }
      body[data-theme="editorial"] .sym-editorial {
        opacity: 0.5;
      }
      body[data-theme="mathlight"] .sym-mathlight {
        opacity: 0.5;
      }
      body[data-theme="mathdark"] .sym-mathdark {
        opacity: 0.62;
      }
      body[data-theme="chemistrylight"] .sym-chemistrylight {
        opacity: 0.62;
      }
      body[data-theme="chemistrydark"] .sym-chemistrydark {
        opacity: 0.68;
      }

      body[data-theme="glass"] .grain,
      body[data-theme="frosted"] .grain,
      body[data-theme="editorial"] .grain {
        opacity: 0.16;
      }

      body[data-theme="hacker"] .scanline {
        opacity: 0.22;
      }
      .scanline {
        background: repeating-linear-gradient(
          to bottom,
          rgba(0, 255, 65, 0.06) 0px,
          rgba(0, 255, 65, 0.06) 1px,
          rgba(0, 0, 0, 0) 3px,
          rgba(0, 0, 0, 0) 8px
        );
        mix-blend-mode: screen;
      }

      .anim-off .bg-layer,
      .anim-off .symbol-layer,
      .anim-off .orb,
      .anim-off .scanline,
      .anim-off .grain {
        display: none !important;
      }

      /* Motion controls (performance mode + intensity) */
      body[data-anim-enabled="off"] #bgAnim {
        display: none !important;
      }
      body[data-anim-enabled="off"]:is(
          [data-theme="hacker"],
          [data-theme="mathlight"],
          [data-theme="mathdark"],
          [data-theme="chemistrylight"],
          [data-theme="chemistrydark"]
        )
        #bgAnim {
        display: block !important;
      }
      body[data-anim-enabled="off"]:is(
          [data-theme="hacker"],
          [data-theme="mathlight"],
          [data-theme="mathdark"],
          [data-theme="chemistrylight"],
          [data-theme="chemistrydark"]
        )
        #bgAnim
        .bg-layer,
      body[data-anim-enabled="off"]:is(
          [data-theme="hacker"],
          [data-theme="mathlight"],
          [data-theme="mathdark"],
          [data-theme="chemistrylight"],
          [data-theme="chemistrydark"]
        )
        #bgAnim
        .symbol-layer,
      body[data-anim-enabled="off"]:is(
          [data-theme="hacker"],
          [data-theme="mathlight"],
          [data-theme="mathdark"],
          [data-theme="chemistrylight"],
          [data-theme="chemistrydark"]
        )
        #bgAnim
        .orb,
      body[data-anim-enabled="off"]:is(
          [data-theme="hacker"],
          [data-theme="mathlight"],
          [data-theme="mathdark"],
          [data-theme="chemistrylight"],
          [data-theme="chemistrydark"]
        )
        #bgAnim
        .scanline,
      body[data-anim-enabled="off"]:is(
          [data-theme="hacker"],
          [data-theme="mathlight"],
          [data-theme="mathdark"],
          [data-theme="chemistrylight"],
          [data-theme="chemistrydark"]
        )
        #bgAnim
        .grain,
      body[data-anim-enabled="off"]:is(
          [data-theme="hacker"],
          [data-theme="mathlight"],
          [data-theme="mathdark"],
          [data-theme="chemistrylight"],
          [data-theme="chemistrydark"]
        )
        #bgAnim
        .theme-fx {
        display: none !important;
      }
      body[data-anim-enabled="off"][data-theme="mathlight"]
        #bgAnim
        .bg-mathlight,
      body[data-anim-enabled="off"][data-theme="mathlight"]
        #bgAnim
        .sym-mathlight,
      body[data-anim-enabled="off"][data-theme="mathdark"] #bgAnim .bg-mathdark,
      body[data-anim-enabled="off"][data-theme="mathdark"]
        #bgAnim
        .sym-mathdark {
        display: block !important;
      }
      body[data-anim-enabled="off"][data-theme="chemistrylight"]
        #bgAnim
        .bg-chemistrylight,
      body[data-anim-enabled="off"][data-theme="chemistrylight"]
        #bgAnim
        .sym-chemistrylight,
      body[data-anim-enabled="off"][data-theme="chemistrydark"]
        #bgAnim
        .bg-chemistrydark,
      body[data-anim-enabled="off"][data-theme="chemistrydark"]
        #bgAnim
        .sym-chemistrydark {
        display: block !important;
      }
      body[data-anim-enabled="off"][data-theme="hacker"] #bgAnim .bg-hacker {
        display: block !important;
        animation: none !important;
        filter: saturate(1.28) contrast(1.16)
          drop-shadow(0 0 10px rgba(0, 255, 65, 0.22));
        background:
          radial-gradient(
            980px 460px at 50% -6%,
            rgba(0, 255, 65, 0.18),
            transparent 68%
          ),
          radial-gradient(
            860px 340px at 88% 88%,
            rgba(34, 211, 238, 0.14),
            transparent 72%
          ),
          linear-gradient(180deg, rgba(0, 18, 0, 0.52), rgba(0, 0, 0, 0.78));
      }
      body[data-anim-enabled="off"][data-theme="hacker"]
        #bgAnim
        .bg-hacker::before {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        opacity: 0.42;
        background:
          repeating-linear-gradient(
            to right,
            rgba(0, 255, 65, 0.1) 0 1px,
            transparent 1px 52px
          ),
          repeating-linear-gradient(
            to bottom,
            rgba(0, 255, 65, 0.07) 0 1px,
            transparent 1px 38px
          ),
          linear-gradient(
            90deg,
            transparent 0 18%,
            rgba(0, 255, 65, 0.14) 18% 19%,
            transparent 19% 81%,
            rgba(0, 255, 65, 0.14) 81% 82%,
            transparent 82% 100%
          );
        mix-blend-mode: screen;
      }
      body[data-anim-enabled="off"][data-theme="hacker"]
        #bgAnim
        .bg-hacker::after {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        opacity: 0.46;
        background:
          radial-gradient(
            220px 110px at 8% 10%,
            rgba(0, 255, 65, 0.26),
            transparent 72%
          ),
          radial-gradient(
            190px 100px at 92% 16%,
            rgba(34, 211, 238, 0.2),
            transparent 74%
          ),
          radial-gradient(
            560px 180px at 50% 102%,
            rgba(0, 255, 65, 0.16),
            transparent 72%
          );
        mix-blend-mode: screen;
      }
      body[data-anim-enabled="off"][data-theme="hacker"]
        #bgAnim
        .bg-hacker
        .col {
        top: var(--static-top, 8%);
        animation: none !important;
        transform: translate3d(0, 0, 0) !important;
        opacity: var(--static-alpha, 0.24);
        color: rgba(140, 255, 180, 0.95);
        font-weight: 900;
        letter-spacing: 0.03em;
        text-shadow:
          0 0 8px rgba(0, 255, 65, 0.8),
          0 0 18px rgba(0, 255, 65, 0.42);
        will-change: auto;
      }
      body[data-anim-enabled="off"][data-theme="hacker"] #bgAnim .sym-hacker {
        display: block !important;
        opacity: 0.86 !important;
      }
      body[data-anim-enabled="off"][data-theme="hacker"]
        .sym-hacker
        .symbol-node {
        top: var(--y, 50%);
        animation: none !important;
        transform: translate3d(0, 0, 0) rotate(var(--rot, 0deg));
        opacity: calc(var(--alpha, 0.46) * 0.94);
        font-weight: 900;
        text-shadow:
          0 0 9px rgba(0, 255, 65, 0.88),
          0 0 16px rgba(34, 211, 238, 0.28);
      }
      body[data-anim-enabled="off"][data-theme="hacker"] #bgAnim .scanline {
        display: block !important;
        opacity: 0.2 !important;
        background: repeating-linear-gradient(
          to bottom,
          rgba(0, 255, 65, 0.12) 0px,
          rgba(0, 255, 65, 0.12) 1px,
          rgba(0, 0, 0, 0) 3px,
          rgba(0, 0, 0, 0) 7px
        );
      }
      body[data-ui-mode="mobile"][data-anim-enabled="off"][data-theme="hacker"]
        #bgAnim
        .sym-hacker {
        display: none !important;
      }
      body[data-ui-mode="mobile"][data-anim-enabled="off"][data-theme="hacker"]
        #bgAnim
        .bg-hacker::before {
        opacity: 0.28;
      }
      body[data-ui-mode="mobile"][data-anim-enabled="off"][data-theme="hacker"]
        #bgAnim
        .bg-hacker::after {
        opacity: 0.22;
      }
      body[data-ui-mode="mobile"][data-anim-enabled="off"][data-theme="hacker"]
        #bgAnim
        .bg-hacker
        .col {
        text-shadow:
          0 0 6px rgba(0, 255, 65, 0.66),
          0 0 12px rgba(0, 255, 65, 0.3);
        letter-spacing: 0.02em;
      }
      @media (max-width: 1024px) {
        body[data-ui-mode="auto"][data-anim-enabled="off"][data-theme="hacker"]
          #bgAnim
          .sym-hacker {
          display: none !important;
        }
        body[data-ui-mode="auto"][data-anim-enabled="off"][data-theme="hacker"]
          #bgAnim
          .bg-hacker::before {
          opacity: 0.28;
        }
        body[data-ui-mode="auto"][data-anim-enabled="off"][data-theme="hacker"]
          #bgAnim
          .bg-hacker::after {
          opacity: 0.22;
        }
        body[data-ui-mode="auto"][data-anim-enabled="off"][data-theme="hacker"]
          #bgAnim
          .bg-hacker
          .col {
          text-shadow:
            0 0 6px rgba(0, 255, 65, 0.66),
            0 0 12px rgba(0, 255, 65, 0.3);
          letter-spacing: 0.02em;
        }
      }
      body[data-anim-enabled="off"] *,
      body[data-anim-enabled="off"] *::before,
      body[data-anim-enabled="off"] *::after {
        animation: none !important;
        transition: none !important;
      }

      body[data-anim-intensity="low"] .orb {
        opacity: 0.12;
        filter: blur(90px);
      }
      body[data-anim-intensity="low"] .bg-layer,
      body[data-anim-intensity="low"] .bg-layer::before,
      body[data-anim-intensity="low"] .bg-layer::after {
        animation-duration: 22s !important;
      }
      body[data-anim-intensity="low"] .theme-fx .fx-node {
        animation-duration: calc(var(--dur, 12s) * 1.65) !important;
        opacity: calc(var(--alpha, 0.2) * 0.62);
      }
      body[data-anim-intensity="low"] .symbol-layer .symbol-node {
        animation-duration: calc(var(--dur, 9s) * 1.6) !important;
        opacity: calc(var(--alpha, 0.46) * 0.56);
      }
      body[data-anim-intensity="low"] .theme-fx .fx-node:nth-child(2n),
      body[data-anim-intensity="low"] .symbol-layer .symbol-node:nth-child(2n),
      body[data-anim-intensity="low"] .bg-hacker .col:nth-child(2n) {
        display: none !important;
      }
      body[data-anim-intensity="low"] .bg-hacker .col {
        animation-duration: calc(var(--dur, 8s) * 1.75) !important;
      }
      body[data-anim-intensity="low"] .grain {
        opacity: 0.08 !important;
      }
      body[data-anim-intensity="low"] .scanline {
        opacity: 0.1 !important;
      }

      body[data-anim-intensity="ultra-low"] .orb {
        opacity: 0.07;
        filter: blur(110px);
      }
      body[data-anim-intensity="ultra-low"] .bg-layer,
      body[data-anim-intensity="ultra-low"] .bg-layer::before,
      body[data-anim-intensity="ultra-low"] .bg-layer::after {
        animation-duration: 30s !important;
      }
      body[data-anim-intensity="ultra-low"] .theme-fx .fx-node {
        animation-duration: calc(var(--dur, 12s) * 2.8) !important;
        opacity: calc(var(--alpha, 0.2) * 0.34);
      }
      body[data-anim-intensity="ultra-low"] .symbol-layer .symbol-node {
        animation-duration: calc(var(--dur, 9s) * 2.8) !important;
        opacity: calc(var(--alpha, 0.46) * 0.26);
      }
      body[data-anim-intensity="ultra-low"] .theme-fx .fx-node:nth-child(2n),
      body[data-anim-intensity="ultra-low"] .theme-fx .fx-node:nth-child(3n),
      body[data-anim-intensity="ultra-low"] .theme-fx .fx-node:nth-child(5n),
      body[data-anim-intensity="ultra-low"]
        .symbol-layer
        .symbol-node:nth-child(2n),
      body[data-anim-intensity="ultra-low"]
        .symbol-layer
        .symbol-node:nth-child(3n),
      body[data-anim-intensity="ultra-low"]
        .symbol-layer
        .symbol-node:nth-child(5n),
      body[data-anim-intensity="ultra-low"] .bg-hacker .col:nth-child(2n),
      body[data-anim-intensity="ultra-low"] .bg-hacker .col:nth-child(3n),
      body[data-anim-intensity="ultra-low"] .orb-c {
        display: none !important;
      }
      body[data-anim-intensity="ultra-low"] .theme-fx .fx-node:nth-child(n + 7),
      body[data-anim-intensity="ultra-low"] .bg-hacker .col:nth-child(n + 5) {
        display: none !important;
      }
      body[data-anim-intensity="ultra-low"] .symbol-layer {
        display: none !important;
      }
      body[data-anim-intensity="ultra-low"] .bg-hacker .col {
        animation-duration: calc(var(--dur, 8s) * 3.2) !important;
        opacity: 0.22 !important;
      }
      body[data-anim-intensity="ultra-low"] .grain,
      body[data-anim-intensity="ultra-low"] .scanline {
        display: none !important;
      }

      body[data-anim-intensity="high"] .theme-fx .fx-node {
        animation-duration: calc(var(--dur, 12s) * 0.92);
      }
      body[data-anim-intensity="high"] .symbol-layer .symbol-node {
        animation-duration: calc(var(--dur, 9s) * 0.92);
      }
      body[data-anim-enabled="off"][data-theme="mathlight"]
        .sym-mathlight
        .symbol-node,
      body[data-anim-enabled="off"][data-theme="mathdark"]
        .sym-mathdark
        .symbol-node {
        top: var(--y, 50%);
        animation: none !important;
        transform: translate3d(0, 0, 0) rotate(var(--rot, 0deg));
        opacity: calc(var(--alpha, 0.46) * 0.9);
        font-weight: 800;
      }
      body[data-anim-enabled="off"][data-theme="chemistrylight"]
        .sym-chemistrylight
        .symbol-node,
      body[data-anim-enabled="off"][data-theme="chemistrydark"]
        .sym-chemistrydark
        .symbol-node {
        top: var(--y, 50%);
        animation: none !important;
        transform: translate3d(0, 0, 0) rotate(var(--rot, 0deg));
        opacity: calc(var(--alpha, 0.46) * 0.92);
        font-weight: 900;
      }

      /* Symbol Rain Layer (visible but subtle per-theme) */
      .symbol-layer .symbol-node {
        position: absolute;
        top: -22%;
        left: var(--x, 50%);
        font-size: var(--size, 18px);
        line-height: 1;
        opacity: var(--alpha, 0.46);
        transform: translate3d(0, 0, 0) rotate(var(--rot, 0deg));
        animation: fallSymbols var(--dur, 9s) linear infinite;
        animation-delay: var(--delay, 0s);
        user-select: none;
        pointer-events: none;
        will-change: transform, opacity;
      }
      .sym-glass .symbol-node {
        color: rgba(255, 255, 255, 0.7);
        text-shadow: 0 0 10px rgba(124, 58, 237, 0.4);
      }
      .sym-brutal .symbol-node {
        color: rgba(0, 0, 0, 0.42);
        font-weight: 900;
      }
      .sym-luxury .symbol-node {
        color: rgba(247, 231, 180, 0.82);
        text-shadow: 0 0 12px rgba(212, 175, 55, 0.35);
      }
      .sym-hacker .symbol-node {
        color: rgba(0, 255, 65, 0.95);
        font-family: var(--font-en);
        font-weight: 900;
        text-shadow:
          0 0 8px rgba(0, 255, 65, 0.9),
          0 0 20px rgba(0, 255, 65, 0.75);
      }
      .sym-aurora .symbol-node {
        color: rgba(255, 255, 255, 0.7);
        text-shadow:
          0 0 10px rgba(255, 45, 154, 0.45),
          0 0 16px rgba(34, 211, 238, 0.35);
      }
      .sym-mono .symbol-node {
        color: rgba(0, 0, 0, 0.35);
        font-family: var(--font-en);
      }
      .sym-soft .symbol-node {
        color: rgba(88, 101, 242, 0.42);
        text-shadow: 0 0 8px rgba(6, 182, 212, 0.3);
      }
      .sym-material .symbol-node {
        color: rgba(103, 80, 164, 0.44);
      }
      .sym-frosted .symbol-node {
        color: rgba(255, 255, 255, 0.72);
        text-shadow: 0 0 8px rgba(255, 255, 255, 0.4);
      }
      .sym-editorial .symbol-node {
        animation-name: fallLeaf;
      }
      .sym-editorial .symbol-node.leaf {
        width: var(--size, 12px);
        height: calc(var(--size, 12px) * 0.72);
        font-size: 0;
        border-radius: 0 100% 0 100%;
        background: linear-gradient(
          135deg,
          rgba(217, 48, 37, 0.8),
          rgba(190, 120, 30, 0.9)
        );
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      }
      .sym-editorial .symbol-node.leaf::before {
        content: "";
        position: absolute;
        right: 42%;
        top: 15%;
        width: 1px;
        height: 70%;
        background: rgba(70, 48, 22, 0.6);
        transform: rotate(26deg);
      }
      .sym-mathlight .symbol-node {
        color: rgba(131, 34, 77, 0.84);
        text-shadow:
          0 0 8px rgba(255, 154, 158, 0.34),
          0 0 12px rgba(250, 208, 196, 0.32);
      }
      .sym-mathdark .symbol-node {
        color: rgba(169, 205, 220, 0.92);
        text-shadow:
          0 0 9px rgba(44, 83, 100, 0.58),
          0 0 16px rgba(32, 58, 67, 0.42);
      }
      .sym-chemistrylight .symbol-node {
        color: rgba(37, 99, 235, 0.88);
        text-shadow:
          0 0 8px rgba(142, 197, 252, 0.52),
          0 0 12px rgba(148, 163, 184, 0.34);
        font-weight: 900;
      }
      .sym-chemistrydark .symbol-node {
        color: rgba(219, 234, 254, 0.94);
        text-shadow:
          0 0 9px rgba(14, 165, 233, 0.56),
          0 0 16px rgba(224, 195, 252, 0.42);
        font-weight: 900;
      }

      @keyframes fallSymbols {
        0% {
          transform: translate3d(0, -15vh, 0) rotate(var(--rot, 0deg));
          opacity: 0;
        }
        12% {
          opacity: var(--alpha, 0.28);
        }
        100% {
          transform: translate3d(var(--drift, 0px), 120vh, 0)
            rotate(calc(var(--rot, 0deg) + 180deg));
          opacity: 0;
        }
      }
      @keyframes fallLeaf {
        0% {
          transform: translate3d(0, -16vh, 0) rotate(var(--rot, 0deg));
          opacity: 0;
        }
        12% {
          opacity: var(--alpha, 0.28);
        }
        50% {
          transform: translate3d(var(--drift, 28px), 52vh, 0)
            rotate(calc(var(--rot, 0deg) + 90deg));
        }
        100% {
          transform: translate3d(calc(var(--drift, 28px) * -1), 120vh, 0)
            rotate(calc(var(--rot, 0deg) + 220deg));
          opacity: 0;
        }
      }

      /* Glass: floating sparkles + subtle conic light */
      .bg-glass {
        background:
          radial-gradient(
            900px 420px at 18% 20%,
            rgba(124, 58, 237, 0.25),
            transparent 60%
          ),
          radial-gradient(
            900px 420px at 80% 28%,
            rgba(34, 211, 238, 0.18),
            transparent 62%
          ),
          radial-gradient(
            900px 420px at 50% 90%,
            rgba(59, 130, 246, 0.14),
            transparent 62%
          ),
          conic-gradient(
            from 210deg at 60% 20%,
            rgba(255, 255, 255, 0.06),
            rgba(255, 255, 255, 0) 45%,
            rgba(255, 255, 255, 0.04) 70%,
            rgba(255, 255, 255, 0) 100%
          );
        background-size: 160% 160%;
        animation: meshMove 14s ease-in-out infinite;
        filter: saturate(1.05);
      }
      .bg-glass::before {
        content: "";
        position: absolute;
        inset: -30%;
        background-image: radial-gradient(
          rgba(255, 255, 255, 0.18) 1px,
          transparent 1px
        );
        background-size: 44px 44px;
        opacity: 0.08;
        animation: drift 22s linear infinite;
        transform: rotate(8deg);
      }

      /* Brutal: animated halftone + bold diagonal stripes */
      .bg-brutal {
        background:
          repeating-linear-gradient(
            135deg,
            rgba(0, 0, 0, 0.04) 0 10px,
            rgba(0, 0, 0, 0) 10px 20px
          ),
          radial-gradient(
            1200px 420px at 10% 10%,
            rgba(255, 77, 0, 0.1),
            transparent 60%
          ),
          radial-gradient(
            1200px 420px at 90% 35%,
            rgba(0, 0, 0, 0.06),
            transparent 60%
          );
        animation: brutalShift 12s ease-in-out infinite;
      }
      .bg-brutal::before {
        content: "";
        position: absolute;
        inset: -40px;
        background-image: radial-gradient(
          rgba(0, 0, 0, 0.2) 1px,
          transparent 1px
        );
        background-size: 26px 26px;
        opacity: 0.08;
        animation: drift 16s linear infinite;
      }
      @keyframes brutalShift {
        0% {
          transform: translate3d(0, 0, 0) rotate(0deg);
        }
        50% {
          transform: translate3d(-10px, 8px, 0) rotate(-0.25deg);
        }
        100% {
          transform: translate3d(0, 0, 0) rotate(0deg);
        }
      }

      /* Luxury: gold dust + slow drift */
      .bg-luxury {
        background:
          radial-gradient(
            900px 260px at 18% 12%,
            rgba(212, 175, 55, 0.18),
            transparent 65%
          ),
          radial-gradient(
            900px 320px at 80% 22%,
            rgba(255, 122, 24, 0.1),
            transparent 62%
          ),
          radial-gradient(
            900px 320px at 50% 100%,
            rgba(212, 175, 55, 0.08),
            transparent 62%
          );
        background-size: 150% 150%;
        animation: luxuryShift 18s ease-in-out infinite;
      }
      .bg-luxury::before {
        content: "";
        position: absolute;
        inset: -60px;
        background-image: radial-gradient(
          rgba(212, 175, 55, 0.26) 1px,
          transparent 1px
        );
        background-size: 32px 32px;
        opacity: 0.1;
        animation: drift 18s linear infinite;
      }

      /* Hacker: binary rain (JS) */
      .bg-hacker {
        font-family: var(--font-en);
        color: rgba(0, 255, 65, 0.22);
        filter: drop-shadow(0 0 6px rgba(0, 255, 65, 0.1));
        background:
          radial-gradient(
            900px 440px at 50% 0%,
            rgba(0, 255, 65, 0.08),
            transparent 66%
          ),
          linear-gradient(180deg, rgba(0, 10, 0, 0.22), rgba(0, 0, 0, 0.22));
        animation: hackerPulse 9s ease-in-out infinite;
      }
      .bg-hacker .col {
        position: absolute;
        top: -120vh;
        width: 22px;
        white-space: pre;
        line-height: 1.05;
        animation: rain linear infinite;
      }
      @keyframes rain {
        0% {
          transform: translateY(-10vh);
          opacity: 0.18;
        }
        10% {
          opacity: 0.55;
        }
        100% {
          transform: translateY(220vh);
          opacity: 0.06;
        }
      }

      /* Aurora mesh */
      .bg-aurora {
        background:
          radial-gradient(
            1100px 520px at 10% 20%,
            rgba(255, 45, 154, 0.26),
            transparent 60%
          ),
          radial-gradient(
            1100px 520px at 90% 30%,
            rgba(34, 211, 238, 0.2),
            transparent 62%
          ),
          radial-gradient(
            1100px 520px at 50% 90%,
            rgba(167, 139, 250, 0.22),
            transparent 62%
          ),
          linear-gradient(
            120deg,
            rgba(255, 255, 255, 0.05),
            rgba(255, 255, 255, 0)
          );
        background-size: 170% 170%;
        animation: meshMove 14s ease-in-out infinite;
      }

      /* Mono: subtle moving grid */
      .bg-mono {
        background:
          linear-gradient(to right, rgba(0, 0, 0, 0.05) 1px, transparent 1px),
          linear-gradient(to bottom, rgba(0, 0, 0, 0.05) 1px, transparent 1px);
        background-size: 44px 44px;
        opacity: 0.55;
        animation: gridShift 18s linear infinite;
      }
      @keyframes gridShift {
        0% {
          background-position: 0 0;
        }
        100% {
          background-position: 88px 88px;
        }
      }

      /* Soft: light sweep */
      .bg-soft {
        background:
          radial-gradient(
            1000px 560px at 30% 20%,
            rgba(88, 101, 242, 0.18),
            transparent 60%
          ),
          radial-gradient(
            1000px 560px at 70% 70%,
            rgba(6, 182, 212, 0.14),
            transparent 60%
          );
        background-size: 160% 160%;
        animation: softDrift 16s ease-in-out infinite;
      }
      .bg-soft::before {
        content: "";
        position: absolute;
        inset: -20%;
        background: linear-gradient(
          120deg,
          transparent 30%,
          rgba(255, 255, 255, 0.35) 50%,
          transparent 70%
        );
        transform: rotate(12deg);
        opacity: 0.1;
        animation: sweep 10s ease-in-out infinite;
      }
      @keyframes sweep {
        0% {
          transform: translateX(-12%) rotate(12deg);
        }
        50% {
          transform: translateX(12%) rotate(12deg);
        }
        100% {
          transform: translateX(-12%) rotate(12deg);
        }
      }

      /* Material: pulsing blobs */
      .bg-material {
        background:
          radial-gradient(
            760px 520px at 20% 30%,
            rgba(161, 140, 209, 0.24),
            transparent 62%
          ),
          radial-gradient(
            760px 520px at 75% 70%,
            rgba(251, 194, 235, 0.22),
            transparent 62%
          ),
          radial-gradient(
            760px 520px at 50% 95%,
            rgba(255, 255, 255, 0.18),
            transparent 60%
          ),
          linear-gradient(to top, #a18cd1 0%, #fbc2eb 100%);
        animation: matPulse 12s ease-in-out infinite;
      }
      @keyframes matPulse {
        0% {
          filter: saturate(1);
        }
        50% {
          filter: saturate(1.18);
        }
        100% {
          filter: saturate(1);
        }
      }

      /* Frosted: moving noise */
      .bg-frosted {
        background: radial-gradient(
          1100px 620px at 30% 30%,
          rgba(45, 212, 191, 0.12),
          transparent 60%
        );
        background-size: 170% 170%;
        animation: frostedDrift 15s ease-in-out infinite;
      }
      .bg-frosted::before {
        content: "";
        position: absolute;
        inset: -60px;
        opacity: 0.18;
        background-image: url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIj48ZmlsdGVyIGlkPSJmIj48ZmVUdXJidWxlbmNlIHR5cGU9ImZyYWN0YWxOb2lzZSIgYmFzZUZyZXF1ZW5jeT0iMC42NSIgbnVtT2N0YXZlcz0iMyIgc3RpdGNoVGlsZXM9InN0aXRjaCIvPjwvZmlsdGVyPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbHRlcj0idXJsKCNmKSIgb3BhY2l0eT0iMC4yMCIvPjwvc3ZnPg==");
        animation: noiseMove 6s linear infinite;
      }
      @keyframes noiseMove {
        0% {
          transform: translate3d(0, 0, 0);
        }
        100% {
          transform: translate3d(70px, -70px, 0);
        }
      }

      /* Editorial: paper vignette */
      .bg-editorial {
        background:
          radial-gradient(
            1000px 520px at 50% 12%,
            rgba(0, 0, 0, 0.08),
            transparent 60%
          ),
          radial-gradient(
            900px 460px at 50% 100%,
            rgba(0, 0, 0, 0.06),
            transparent 60%
          ),
          linear-gradient(
            0deg,
            rgba(255, 255, 255, 0.25),
            rgba(255, 255, 255, 0)
          );
        background-size: 160% 160%;
        animation: editorialDrift 19s ease-in-out infinite;
      }
      .bg-editorial::before {
        content: "";
        position: absolute;
        inset: -14%;
        opacity: 0.17;
        background:
          repeating-linear-gradient(
            0deg,
            rgba(0, 0, 0, 0.05) 0 2px,
            transparent 2px 18px
          ),
          radial-gradient(
            1000px 280px at 20% 20%,
            rgba(217, 48, 37, 0.1),
            transparent 65%
          );
        animation: editorialTexture 21s linear infinite;
      }

      /* Mathematics Light: paper grid + formula glow */
      .bg-mathlight {
        background:
          linear-gradient(
            to right,
            rgba(255, 154, 158, 0.14) 1px,
            transparent 1px
          ),
          linear-gradient(
            to bottom,
            rgba(250, 208, 196, 0.16) 1px,
            transparent 1px
          ),
          radial-gradient(
            860px 420px at 14% 18%,
            rgba(255, 154, 158, 0.24),
            transparent 62%
          ),
          radial-gradient(
            860px 420px at 88% 76%,
            rgba(250, 208, 196, 0.3),
            transparent 62%
          ),
          linear-gradient(45deg, #ff9a9e 0%, #fad0c4 99%, #fad0c4 100%);
        background-size:
          34px 34px,
          34px 34px,
          160% 160%,
          160% 160%,
          100% 100%;
        animation: mathGridShift 14s linear infinite;
      }
      .bg-mathlight::before {
        content: "";
        position: absolute;
        inset: -18%;
        opacity: 0.28;
        background:
          radial-gradient(
            640px 220px at 20% 20%,
            rgba(255, 255, 255, 0.82),
            transparent 66%
          ),
          radial-gradient(
            520px 180px at 78% 70%,
            rgba(250, 208, 196, 0.34),
            transparent 68%
          );
        animation: mathFieldShift 18s ease-in-out infinite;
      }
      .bg-mathlight::after {
        content: "";
        position: absolute;
        inset: 0;
        opacity: 0.44;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 360 210'%3E%3Cpath d='M0 105H360M180 0V210' stroke='%23c7687f' stroke-opacity='0.22' stroke-width='1.2'/%3E%3Cpath d='M0 136 C45 68,90 68,135 136 S225 204,270 136 S315 68,360 136' fill='none' stroke='%23ff9a9e' stroke-opacity='0.55' stroke-width='2.4'/%3E%3Cpath d='M24 174 Q180 24 336 174' fill='none' stroke='%23fad0c4' stroke-opacity='0.44' stroke-width='1.9'/%3E%3C/svg%3E");
        background-size: 430px 250px;
        background-repeat: repeat;
        mix-blend-mode: multiply;
        animation: mathFuncDriftLight 24s linear infinite;
      }

      /* Mathematics Dark: neon graph field */
      .bg-mathdark {
        background:
          linear-gradient(
            to right,
            rgba(169, 205, 220, 0.13) 1px,
            transparent 1px
          ),
          linear-gradient(
            to bottom,
            rgba(119, 159, 176, 0.11) 1px,
            transparent 1px
          ),
          radial-gradient(
            920px 520px at 18% 12%,
            rgba(32, 58, 67, 0.28),
            transparent 64%
          ),
          radial-gradient(
            920px 520px at 82% 84%,
            rgba(44, 83, 100, 0.22),
            transparent 66%
          ),
          linear-gradient(180deg, rgba(8, 17, 22, 0.74), rgba(6, 14, 18, 0.92)),
          linear-gradient(120deg, #0f2027 0%, #203a43 52%, #2c5364 100%);
        background-size:
          36px 36px,
          36px 36px,
          170% 170%,
          170% 170%,
          100% 100%;
        animation: mathGridShift 16s linear infinite;
      }
      .bg-mathdark::before {
        content: "";
        position: absolute;
        inset: -16%;
        opacity: 0.28;
        background:
          radial-gradient(
            720px 260px at 24% 16%,
            rgba(44, 83, 100, 0.3),
            transparent 66%
          ),
          radial-gradient(
            620px 240px at 80% 76%,
            rgba(32, 58, 67, 0.24),
            transparent 68%
          );
        animation: mathFieldShift 20s ease-in-out infinite;
      }
      .bg-mathdark::after {
        content: "";
        position: absolute;
        inset: 0;
        opacity: 0.5;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 360 210'%3E%3Cpath d='M0 105H360M180 0V210' stroke='%23203a43' stroke-opacity='0.28' stroke-width='1.2'/%3E%3Cpath d='M0 136 C45 58,90 58,135 136 S225 214,270 136 S315 58,360 136' fill='none' stroke='%232c5364' stroke-opacity='0.68' stroke-width='2.3'/%3E%3Cpath d='M18 182 Q180 18 342 182' fill='none' stroke='%230f2027' stroke-opacity='0.52' stroke-width='1.9'/%3E%3C/svg%3E");
        background-size: 430px 250px;
        background-repeat: repeat;
        mix-blend-mode: screen;
        animation: mathFuncDriftDark 22s linear infinite;
      }

      /* Chemistry Light: Cloudy Knoxville gradient + lab lattice */
      .bg-chemistrylight {
        background: #fdfbfb;
        background: linear-gradient(to right, #fdfbfb, #ebedee);
      }
      .bg-chemistrylight::before {
        content: "";
        position: absolute;
        inset: -12%;
        opacity: 0.42;
        background:
          radial-gradient(
            860px 260px at 12% 6%,
            rgba(142, 197, 252, 0.28),
            transparent 66%
          ),
          radial-gradient(
            760px 240px at 88% 92%,
            rgba(224, 195, 252, 0.22),
            transparent 66%
          ),
          linear-gradient(
            to right,
            rgba(148, 163, 184, 0.16) 1px,
            transparent 1px
          ),
          linear-gradient(
            to bottom,
            rgba(148, 163, 184, 0.14) 1px,
            transparent 1px
          );
        background-size:
          160% 160%,
          160% 160%,
          38px 38px,
          38px 38px;
        animation: chemistryGridShift 20s linear infinite;
      }
      .bg-chemistrylight::after {
        content: "";
        position: absolute;
        inset: 0;
        opacity: 0.34;
        background-image: radial-gradient(
          circle,
          rgba(37, 99, 235, 0.26) 1.6px,
          transparent 1.6px
        );
        background-size: 44px 44px;
        animation: chemistryDotDrift 24s linear infinite;
      }

      /* Chemistry Dark: Deep Blue gradient + molecular glow */
      .bg-chemistrydark {
        background: #e0c3fc;
        background: linear-gradient(to right, #e0c3fc, #8ec5fc);
      }
      .bg-chemistrydark::before {
        content: "";
        position: absolute;
        inset: -12%;
        opacity: 0.38;
        background:
          radial-gradient(
            940px 320px at 14% 8%,
            rgba(30, 41, 59, 0.28),
            transparent 64%
          ),
          radial-gradient(
            860px 300px at 86% 88%,
            rgba(49, 46, 129, 0.24),
            transparent 66%
          ),
          linear-gradient(
            to right,
            rgba(30, 58, 138, 0.16) 1px,
            transparent 1px
          ),
          linear-gradient(
            to bottom,
            rgba(15, 23, 42, 0.16) 1px,
            transparent 1px
          );
        background-size:
          170% 170%,
          170% 170%,
          42px 42px,
          42px 42px;
        animation: chemistryGridShift 24s linear infinite;
      }
      .bg-chemistrydark::after {
        content: "";
        position: absolute;
        inset: 0;
        opacity: 0.36;
        background-image: radial-gradient(
          circle,
          rgba(15, 23, 42, 0.28) 1.5px,
          transparent 1.5px
        );
        background-size: 46px 46px;
        animation: chemistryDotDrift 26s linear infinite;
      }

      /* Grain overlay (for premium tactile feel) */
      .grain {
        background-image: url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIj48ZmlsdGVyIGlkPSJnoiPjxmZVR1cmJ1bGVuY2UgdHlwZT0iZnJhY3RhbE5vaXNlIiBiYXNlRnJlcXVlbmN5PSIwLjY1IiBudW1PY3RhdmVzPSIzIi8+PC9maWx0ZXI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsdGVyPSJ1cmwoI2cpIiBvcGFjaXR5PSIwLjI1Ii8+PC9zdmc+");
        opacity: 0.14;
        mix-blend-mode: overlay;
        animation: noiseMove 7s linear infinite;
      }

      @keyframes meshMove {
        0% {
          background-position: 0% 20%;
        }
        50% {
          background-position: 90% 80%;
        }
        100% {
          background-position: 0% 20%;
        }
      }
      @keyframes drift {
        0% {
          transform: translate3d(0, 0, 0);
        }
        100% {
          transform: translate3d(70px, -70px, 0);
        }
      }
      @keyframes luxuryShift {
        0% {
          background-position: 15% 20%;
        }
        50% {
          background-position: 78% 75%;
        }
        100% {
          background-position: 15% 20%;
        }
      }
      @keyframes hackerPulse {
        0% {
          filter: drop-shadow(0 0 5px rgba(0, 255, 65, 0.08));
        }
        50% {
          filter: drop-shadow(0 0 11px rgba(0, 255, 65, 0.22));
        }
        100% {
          filter: drop-shadow(0 0 5px rgba(0, 255, 65, 0.08));
        }
      }
      @keyframes softDrift {
        0% {
          background-position: 10% 20%;
        }
        50% {
          background-position: 80% 82%;
        }
        100% {
          background-position: 10% 20%;
        }
      }
      @keyframes frostedDrift {
        0% {
          background-position: 20% 25%;
        }
        50% {
          background-position: 85% 70%;
        }
        100% {
          background-position: 20% 25%;
        }
      }
      @keyframes editorialDrift {
        0% {
          background-position: 0% 25%;
        }
        50% {
          background-position: 100% 78%;
        }
        100% {
          background-position: 0% 25%;
        }
      }
      @keyframes editorialTexture {
        0% {
          transform: translate3d(0, 0, 0);
        }
        100% {
          transform: translate3d(-120px, 80px, 0);
        }
      }
      @keyframes mathGridShift {
        0% {
          background-position:
            0 0,
            0 0,
            12% 18%,
            88% 82%,
            0 0;
        }
        50% {
          background-position:
            34px 34px,
            -34px 34px,
            82% 74%,
            18% 22%,
            0 0;
        }
        100% {
          background-position:
            68px 68px,
            -68px 68px,
            12% 18%,
            88% 82%,
            0 0;
        }
      }
      @keyframes mathFieldShift {
        0% {
          transform: translate3d(0, 0, 0);
        }
        50% {
          transform: translate3d(26px, -16px, 0);
        }
        100% {
          transform: translate3d(0, 0, 0);
        }
      }
      @keyframes mathFuncDriftLight {
        0% {
          background-position: 0 0;
        }
        100% {
          background-position: 430px -40px;
        }
      }
      @keyframes mathFuncDriftDark {
        0% {
          background-position: 0 0;
        }
        100% {
          background-position: -430px 36px;
        }
      }
      @keyframes chemistryGridShift {
        0% {
          background-position:
            12% 18%,
            88% 82%,
            0 0,
            0 0;
        }
        50% {
          background-position:
            82% 76%,
            18% 24%,
            38px 38px,
            -38px 38px;
        }
        100% {
          background-position:
            12% 18%,
            88% 82%,
            76px 76px,
            -76px 76px;
        }
      }
      @keyframes chemistryDotDrift {
        0% {
          background-position: 0 0;
        }
        100% {
          background-position: 220px -120px;
        }
      }

      /* Theme FX Layer (per-theme animated particles) */
      .theme-fx {
        position: absolute;
        inset: 0;
        overflow: hidden;
        pointer-events: none;
      }
      .theme-fx .fx-node {
        position: absolute;
        left: var(--x, 50%);
        top: var(--y, 50%);
        width: var(--size, 8px);
        height: var(--size, 8px);
        opacity: var(--alpha, 0.2);
        will-change: transform, opacity;
        animation-duration: var(--dur, 12s);
        animation-delay: var(--delay, 0s);
        animation-iteration-count: infinite;
        animation-timing-function: ease-in-out;
      }
      .fx-glass .fx-node {
        border-radius: 999px;
        background: radial-gradient(
          circle,
          rgba(255, 255, 255, 0.9),
          rgba(124, 58, 237, 0.2) 62%,
          transparent 100%
        );
        filter: blur(var(--blur, 0.5px));
        mix-blend-mode: screen;
        animation-name: fxFloat;
      }
      .fx-brutal .fx-node {
        border-radius: 2px;
        border: 2px solid rgba(11, 11, 11, 0.22);
        background: rgba(255, 77, 0, 0.2);
        animation-name: fxBrutal;
      }
      .fx-luxury .fx-node {
        border-radius: 999px;
        background: radial-gradient(
          circle,
          rgba(255, 246, 208, 0.95),
          rgba(212, 175, 55, 0.2) 66%,
          transparent 100%
        );
        box-shadow: 0 0 16px rgba(212, 175, 55, 0.3);
        animation-name: fxPulse;
      }
      .fx-hacker .fx-node {
        width: 2px;
        height: var(--size, 24px);
        border-radius: 999px;
        background: linear-gradient(
          180deg,
          rgba(0, 255, 65, 0),
          rgba(0, 255, 65, 0.8),
          rgba(0, 255, 65, 0)
        );
        mix-blend-mode: screen;
        animation-name: fxFall;
      }
      .fx-aurora .fx-node {
        width: calc(var(--size, 10px) * 3.6);
        height: calc(var(--size, 10px) * 0.42);
        border-radius: 999px;
        background: linear-gradient(
          90deg,
          rgba(255, 45, 154, 0),
          rgba(255, 45, 154, 0.42),
          rgba(34, 211, 238, 0.48),
          rgba(34, 211, 238, 0)
        );
        filter: blur(0.4px);
        animation-name: fxSweep;
      }
      .fx-mono .fx-node {
        width: 1px;
        height: var(--size, 30px);
        background: linear-gradient(
          180deg,
          rgba(0, 0, 0, 0),
          rgba(0, 0, 0, 0.18),
          rgba(0, 0, 0, 0)
        );
        animation-name: fxSweep;
      }
      .fx-soft .fx-node {
        border-radius: 999px;
        background: radial-gradient(
          circle,
          rgba(255, 255, 255, 0.8),
          rgba(88, 101, 242, 0.22) 66%,
          transparent 100%
        );
        filter: blur(var(--blur, 0.4px));
        animation-name: fxFloat;
      }
      .fx-material .fx-node {
        border-radius: 34% 66% 58% 42% / 44% 38% 62% 56%;
        background: radial-gradient(
          circle at 30% 30%,
          rgba(255, 255, 255, 0.72),
          rgba(103, 80, 164, 0.24) 64%,
          transparent 100%
        );
        animation-name: fxPulse;
      }
      .fx-frosted .fx-node {
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.36);
        background: rgba(255, 255, 255, 0.1);
        animation-name: fxFall;
      }
      .fx-editorial .fx-node {
        width: calc(var(--size, 8px) * 1.5);
        height: var(--size, 8px);
        border-radius: 2px;
        background: rgba(20, 20, 20, 0.16);
        animation-name: fxPaper;
      }
      .fx-mathlight .fx-node {
        border-radius: 8px;
        border: 1px solid rgba(255, 154, 158, 0.46);
        background: rgba(255, 255, 255, 0.52);
        box-shadow: 0 0 10px rgba(250, 208, 196, 0.34);
        animation-name: fxSweep;
      }
      .fx-mathdark .fx-node {
        border-radius: 999px;
        background: radial-gradient(
          circle,
          rgba(169, 205, 220, 0.84),
          rgba(44, 83, 100, 0.3) 64%,
          transparent 100%
        );
        box-shadow: 0 0 16px rgba(44, 83, 100, 0.4);
        animation-name: fxPulse;
      }

      /* Custom Theme FX: Material (bouncing balls) */
      .fx-material-bounce {
        contain: layout paint style;
      }
      .fx-material-bounce .fx-ball {
        position: absolute;
        left: 0;
        top: 0;
        width: var(--size, 28px);
        height: var(--size, 28px);
        opacity: var(--alpha, 0.82);
        border-radius: 999px;
        animation: none !important;
        transform: translate3d(0, 0, 0);
        will-change: transform;
        border: 1px solid color-mix(in srgb, var(--accent2) 36%, transparent);
        background:
          radial-gradient(
            circle at 30% 28%,
            rgba(255, 255, 255, 0.82),
            rgba(255, 255, 255, 0.08) 38%,
            transparent 64%
          ),
          linear-gradient(
            140deg,
            color-mix(in srgb, var(--accent) 62%, #ffffff 38%),
            color-mix(in srgb, var(--accent2) 62%, #ffffff 38%)
          );
        box-shadow:
          0 10px 26px rgba(31, 41, 55, 0.18),
          inset -8px -8px 16px rgba(0, 0, 0, 0.08),
          inset 6px 6px 14px rgba(255, 255, 255, 0.36);
      }
      .fx-material-bounce .fx-ball.tone-0 {
        background:
          radial-gradient(
            circle at 32% 28%,
            rgba(255, 255, 255, 0.86),
            rgba(255, 255, 255, 0.12) 40%,
            transparent 66%
          ),
          linear-gradient(
            145deg,
            rgba(161, 140, 209, 0.95),
            rgba(196, 181, 253, 0.9)
          );
      }
      .fx-material-bounce .fx-ball.tone-1 {
        background:
          radial-gradient(
            circle at 32% 28%,
            rgba(255, 255, 255, 0.85),
            rgba(255, 255, 255, 0.1) 40%,
            transparent 66%
          ),
          linear-gradient(
            145deg,
            rgba(251, 194, 235, 0.94),
            rgba(244, 114, 182, 0.86)
          );
      }
      .fx-material-bounce .fx-ball.tone-2 {
        background:
          radial-gradient(
            circle at 34% 26%,
            rgba(255, 255, 255, 0.84),
            rgba(255, 255, 255, 0.1) 38%,
            transparent 64%
          ),
          linear-gradient(
            145deg,
            rgba(125, 211, 252, 0.9),
            rgba(56, 189, 248, 0.84)
          );
      }
      .fx-material-bounce .fx-ball.tone-3 {
        background:
          radial-gradient(
            circle at 34% 26%,
            rgba(255, 255, 255, 0.84),
            rgba(255, 255, 255, 0.12) 38%,
            transparent 64%
          ),
          linear-gradient(
            145deg,
            rgba(165, 243, 252, 0.9),
            rgba(45, 212, 191, 0.84)
          );
      }

      /* Custom Theme FX: Soft (clearer premium animated animals) */
      .fx-soft-animals .fx-animal {
        width: var(--size, 62px);
        height: var(--size, 62px);
        opacity: var(--alpha, 0.92);
        border-radius: 20px;
        animation:
          fxSoftAnimalDrift var(--drift-dur, 20s) ease-in-out infinite,
          fxSoftAnimalBob var(--bob-dur, 6.2s) ease-in-out infinite;
        animation-delay: var(--delay, 0s), var(--delay, 0s);
        transform-origin: 50% 50%;
        filter: drop-shadow(0 12px 22px rgba(51, 65, 85, 0.24));
        will-change: transform, filter;
      }
      .fx-soft-animals .fx-animal::before {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: 20px;
        background: linear-gradient(
          145deg,
          rgba(255, 255, 255, 0.84),
          rgba(226, 232, 240, 0.62)
        );
        border: 1px solid rgba(148, 163, 184, 0.3);
        box-shadow:
          8px 8px 18px rgba(148, 163, 184, 0.36),
          -8px -8px 18px rgba(255, 255, 255, 0.74),
          inset 0 1px 0 rgba(255, 255, 255, 0.84);
      }
      .fx-soft-animals .fx-animal::after {
        content: "";
        position: absolute;
        inset: 2px;
        border-radius: 17px;
        pointer-events: none;
        background: linear-gradient(
          140deg,
          rgba(255, 255, 255, 0.4),
          rgba(255, 255, 255, 0) 38%
        );
        opacity: 0.62;
        animation: fxSoftAnimalSheen 4.3s ease-in-out infinite;
      }
      .fx-soft-animals .fx-animal svg {
        position: relative;
        z-index: 1;
        width: 100%;
        height: 100%;
        padding: 6px;
        overflow: visible;
        filter: saturate(1.12) contrast(1.09);
      }
      .fx-soft-animals .fx-animal .soft-outline {
        stroke: rgba(51, 65, 85, 0.74);
        stroke-width: 1.45;
        stroke-linecap: round;
        stroke-linejoin: round;
        vector-effect: non-scaling-stroke;
      }
      .fx-soft-animals .fx-animal .soft-eye {
        fill: #1f2937;
      }
      .fx-soft-animals .fx-animal .soft-paw {
        fill: #94a3b8;
      }
      .fx-soft-animals .fx-animal[data-animal="chicken-family"] .soft-chick-a,
      .fx-soft-animals .fx-animal[data-animal="chicken-family"] .soft-chick-b {
        transform-box: fill-box;
        transform-origin: center;
        animation: softChickWalk 1.5s ease-in-out infinite;
      }
      .fx-soft-animals .fx-animal[data-animal="chicken-family"] .soft-chick-b {
        animation-delay: 0.18s;
      }
      .fx-soft-animals .fx-animal[data-animal="chicken-family"] .soft-hen-head {
        transform-box: fill-box;
        transform-origin: 52% 42%;
        animation: softSheepBob 2.35s ease-in-out infinite;
      }
      .fx-soft-animals .fx-animal[data-animal="dog-sheep"] .soft-sheep-a,
      .fx-soft-animals .fx-animal[data-animal="dog-sheep"] .soft-sheep-b {
        transform-box: fill-box;
        transform-origin: center;
        animation: softSheepBob 2.2s ease-in-out infinite;
      }
      .fx-soft-animals .fx-animal[data-animal="dog-sheep"] .soft-sheep-b {
        animation-delay: 0.22s;
      }
      .fx-soft-animals .fx-animal[data-animal="dog-sheep"] .soft-dog-tail,
      .fx-soft-animals .fx-animal[data-animal="cat"] .soft-cat-tail,
      .fx-soft-animals .fx-animal[data-animal="cat-chase"] .soft-cat-tail,
      .fx-soft-animals .fx-animal[data-animal="cat-chase"] .soft-mouse-tail {
        transform-box: fill-box;
        transform-origin: center;
        animation: softTailSwing 1.25s ease-in-out infinite;
      }
      .fx-soft-animals .fx-animal[data-animal="cat-chase"] .soft-cat {
        transform-box: fill-box;
        transform-origin: center;
        animation: softCatChase 2.6s ease-in-out infinite;
      }
      .fx-soft-animals .fx-animal[data-animal="cat-chase"] .soft-mouse {
        transform-box: fill-box;
        transform-origin: center;
        animation: softMouseEscape 2.6s ease-in-out infinite;
      }
      body[data-anim-intensity="low"]
        .fx-soft-animals
        .fx-animal[data-animal="cat-chase"]
        .soft-cat,
      body[data-anim-intensity="low"]
        .fx-soft-animals
        .fx-animal[data-animal="cat-chase"]
        .soft-mouse,
      body[data-anim-intensity="low"]
        .fx-soft-animals
        .fx-animal[data-animal="chicken-family"]
        .soft-chick-a,
      body[data-anim-intensity="low"]
        .fx-soft-animals
        .fx-animal[data-animal="chicken-family"]
        .soft-chick-b {
        animation-duration: 3.4s !important;
      }
      body[data-anim-intensity="ultra-low"]
        .fx-soft-animals
        .fx-animal
        .soft-chick-a,
      body[data-anim-intensity="ultra-low"]
        .fx-soft-animals
        .fx-animal
        .soft-chick-b,
      body[data-anim-intensity="ultra-low"]
        .fx-soft-animals
        .fx-animal
        .soft-cat,
      body[data-anim-intensity="ultra-low"]
        .fx-soft-animals
        .fx-animal
        .soft-mouse {
        animation: none !important;
      }

      /* Custom Theme FX: Aurora (cyberpunk) */
      .fx-aurora-cyber .cyber-line {
        width: var(--w, 140px);
        height: 2px;
        border-radius: 999px;
        left: var(--x, 10%);
        top: var(--y, 50%);
        opacity: var(--alpha, 0.32);
        transform: rotate(var(--rot, 0deg));
        background: linear-gradient(
          90deg,
          rgba(255, 45, 154, 0),
          rgba(236, 72, 153, 0.8),
          rgba(34, 211, 238, 0.9),
          rgba(34, 211, 238, 0)
        );
        box-shadow:
          0 0 10px rgba(236, 72, 153, 0.44),
          0 0 14px rgba(34, 211, 238, 0.4);
        mix-blend-mode: screen;
        animation: fxCyberLine var(--dur, 9s) linear infinite;
        animation-delay: var(--delay, 0s);
      }
      .fx-aurora-cyber .cyber-particle {
        width: var(--size, 4px);
        height: var(--size, 4px);
        border-radius: 999px;
        left: var(--x, 50%);
        top: var(--y, 50%);
        background: radial-gradient(
          circle,
          rgba(224, 242, 254, 0.95),
          rgba(34, 211, 238, 0.52) 58%,
          transparent 100%
        );
        box-shadow:
          0 0 10px rgba(34, 211, 238, 0.6),
          0 0 16px rgba(236, 72, 153, 0.28);
        animation: fxCyberParticle var(--dur, 8s) ease-in-out infinite;
        animation-delay: var(--delay, 0s);
      }
      .fx-aurora-cyber .cyber-wave {
        width: var(--w, 220px);
        height: var(--h, 120px);
        left: var(--x, 50%);
        top: var(--y, 50%);
        border-radius: 999px;
        border: 1px solid rgba(34, 211, 238, 0.24);
        background: radial-gradient(
          circle,
          rgba(34, 211, 238, 0.08),
          rgba(255, 45, 154, 0.05) 56%,
          transparent 100%
        );
        filter: blur(0.2px);
        animation: fxCyberWave var(--dur, 12s) ease-in-out infinite;
        animation-delay: var(--delay, 0s);
      }
      .fx-aurora-cyber .cyber-scan {
        right: 0;
        left: 0;
        width: 100%;
        height: 1px;
        top: 0;
        opacity: 0.18;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(34, 211, 238, 0.9),
          transparent
        );
        box-shadow: 0 0 14px rgba(34, 211, 238, 0.4);
        mix-blend-mode: screen;
        animation: fxCyberScan var(--dur, 13s) linear infinite;
        animation-delay: var(--delay, 0s);
      }

      /* Custom Theme FX: Luxury (gold drop set) */
      .fx-luxury-gold .gold-drop {
        left: var(--x, 50%);
        top: -14%;
        opacity: var(--alpha, 0.26);
        transform-origin: 50% 50%;
        animation: fxGoldFall var(--dur, 16s) linear infinite;
        animation-delay: var(--delay, 0s);
        filter: drop-shadow(0 10px 16px rgba(30, 18, 2, 0.34));
      }
      .fx-luxury-gold .kind-coin {
        width: var(--size, 18px);
        height: var(--size, 18px);
        border-radius: 999px;
        border: 1px solid rgba(255, 220, 132, 0.5);
        background: radial-gradient(
          circle at 30% 30%,
          rgba(255, 246, 208, 0.95),
          rgba(245, 158, 11, 0.5) 56%,
          rgba(120, 53, 15, 0.26) 100%
        );
        box-shadow:
          inset 0 1px 0 rgba(255, 255, 255, 0.48),
          0 0 10px rgba(245, 158, 11, 0.34);
      }
      .fx-luxury-gold .kind-bar {
        width: calc(var(--size, 16px) * 1.62);
        height: calc(var(--size, 16px) * 0.7);
        border-radius: 6px;
        border: 1px solid rgba(255, 220, 132, 0.46);
        background: linear-gradient(
          145deg,
          rgba(255, 243, 189, 0.94),
          rgba(245, 158, 11, 0.6),
          rgba(146, 64, 14, 0.4)
        );
        box-shadow:
          inset 0 1px 0 rgba(255, 255, 255, 0.44),
          0 0 12px rgba(217, 119, 6, 0.34);
      }
      .fx-luxury-gold .kind-chain {
        width: calc(var(--size, 17px) * 1.34);
        height: calc(var(--size, 17px) * 1.34);
        border-radius: 999px;
        border: 2px solid rgba(251, 191, 36, 0.7);
        background: radial-gradient(
          circle,
          rgba(255, 255, 255, 0.05),
          rgba(251, 191, 36, 0.08)
        );
        box-shadow: 0 0 12px rgba(245, 158, 11, 0.3);
      }
      .fx-luxury-gold .kind-chain::after {
        content: "";
        position: absolute;
        left: 50%;
        bottom: -22%;
        width: 40%;
        height: 40%;
        transform: translateX(-50%);
        border-radius: 999px;
        border: 1px solid rgba(255, 220, 132, 0.48);
        background: radial-gradient(
          circle at 32% 28%,
          rgba(255, 246, 208, 0.96),
          rgba(245, 158, 11, 0.62)
        );
      }

      /* Custom Theme FX: Glass (shards) */
      .fx-glass-shards .glass-shard {
        left: var(--x, 50%);
        top: var(--y, 50%);
        width: var(--size, 42px);
        height: calc(var(--size, 42px) * 0.72);
        clip-path: var(
          --clip,
          polygon(8% 20%, 78% 4%, 96% 44%, 72% 96%, 6% 78%)
        );
        border: 1px solid rgba(255, 255, 255, 0.34);
        background:
          linear-gradient(
            130deg,
            rgba(255, 255, 255, 0.5),
            rgba(255, 255, 255, 0.08) 42%,
            rgba(34, 211, 238, 0.18) 100%
          ),
          radial-gradient(
            120px 60px at 18% 10%,
            rgba(255, 255, 255, 0.4),
            rgba(255, 255, 255, 0)
          );
        box-shadow:
          0 0 12px rgba(124, 58, 237, 0.24),
          0 0 16px rgba(34, 211, 238, 0.22),
          inset 0 1px 0 rgba(255, 255, 255, 0.42);
        mix-blend-mode: screen;
        transform-origin: 50% 50%;
        animation:
          fxShardDrift var(--dur, 15s) ease-in-out infinite,
          fxShardShimmer calc(var(--dur, 15s) * 0.62) ease-in-out infinite;
        animation-delay: var(--delay, 0s), var(--delay, 0s);
      }
      @keyframes fxFloat {
        0% {
          transform: translate3d(0, 0, 0) scale(0.84);
          opacity: 0;
        }
        20% {
          opacity: var(--alpha, 0.22);
        }
        50% {
          transform: translate3d(var(--dx, 26px), var(--dy, -30px), 0)
            scale(1.08);
        }
        80% {
          opacity: var(--alpha, 0.22);
        }
        100% {
          transform: translate3d(0, 0, 0) scale(0.84);
          opacity: 0;
        }
      }
      @keyframes fxPulse {
        0%,
        100% {
          transform: translate3d(0, 0, 0) scale(0.92);
          opacity: var(--alpha, 0.2);
        }
        50% {
          transform: translate3d(var(--dx, 12px), var(--dy, -10px), 0)
            scale(1.25);
          opacity: calc(var(--alpha, 0.2) + 0.15);
        }
      }
      @keyframes fxBrutal {
        0% {
          transform: translate3d(0, 0, 0) rotate(0deg);
        }
        25% {
          transform: translate3d(var(--dx, 26px), 0, 0) rotate(var(--rot, 8deg));
        }
        50% {
          transform: translate3d(var(--dx, 26px), var(--dy, 22px), 0)
            rotate(calc(var(--rot, 8deg) * -1));
        }
        75% {
          transform: translate3d(0, var(--dy, 22px), 0) rotate(var(--rot, 8deg));
        }
        100% {
          transform: translate3d(0, 0, 0) rotate(0deg);
        }
      }
      @keyframes fxSweep {
        0% {
          transform: translate3d(-24px, 0, 0);
          opacity: 0;
        }
        20% {
          opacity: var(--alpha, 0.2);
        }
        50% {
          transform: translate3d(var(--dx, 72px), var(--dy, 12px), 0);
        }
        100% {
          transform: translate3d(24px, 0, 0);
          opacity: 0;
        }
      }
      @keyframes fxFall {
        0% {
          transform: translate3d(0, -120%, 0) rotate(0deg);
          opacity: 0;
        }
        15% {
          opacity: var(--alpha, 0.2);
        }
        100% {
          transform: translate3d(var(--dx, 16px), 120vh, 0) rotate(170deg);
          opacity: 0;
        }
      }
      @keyframes fxPaper {
        0% {
          transform: translate3d(0, 0, 0) rotate(0deg);
          opacity: var(--alpha, 0.16);
        }
        50% {
          transform: translate3d(var(--dx, 36px), var(--dy, 30px), 0)
            rotate(var(--rot, 12deg));
          opacity: calc(var(--alpha, 0.16) + 0.14);
        }
        100% {
          transform: translate3d(0, 0, 0) rotate(0deg);
          opacity: var(--alpha, 0.16);
        }
      }
      @keyframes fxSoftAnimalDrift {
        0% {
          transform: translate3d(0, 0, 0) rotate(-1deg);
        }
        35% {
          transform: translate3d(var(--dx, 18px), var(--dy, -10px), 0)
            rotate(1.5deg);
        }
        70% {
          transform: translate3d(
              calc(var(--dx, 18px) * -0.75),
              calc(var(--dy, -10px) * 0.6),
              0
            )
            rotate(-1deg);
        }
        100% {
          transform: translate3d(0, 0, 0) rotate(-1deg);
        }
      }
      @keyframes fxSoftAnimalBob {
        0%,
        100% {
          filter: drop-shadow(0 12px 22px rgba(51, 65, 85, 0.22));
        }
        50% {
          filter: drop-shadow(0 15px 26px rgba(51, 65, 85, 0.3));
        }
      }
      @keyframes fxSoftAnimalSheen {
        0%,
        100% {
          opacity: 0.5;
          transform: translateX(-4%);
        }
        50% {
          opacity: 0.76;
          transform: translateX(4%);
        }
      }
      @keyframes softChickWalk {
        0%,
        100% {
          transform: translate3d(0, 0, 0);
        }
        40% {
          transform: translate3d(1.2px, -1px, 0);
        }
        75% {
          transform: translate3d(2.2px, 0, 0);
        }
      }
      @keyframes softSheepBob {
        0%,
        100% {
          transform: translate3d(0, 0, 0);
        }
        50% {
          transform: translate3d(0, -1.4px, 0);
        }
      }
      @keyframes softCatChase {
        0%,
        100% {
          transform: translate3d(0, 0, 0);
        }
        48% {
          transform: translate3d(10px, -0.8px, 0);
        }
        70% {
          transform: translate3d(11px, 0, 0);
        }
      }
      @keyframes softMouseEscape {
        0%,
        100% {
          transform: translate3d(0, 0, 0);
        }
        42% {
          transform: translate3d(-8px, -1px, 0);
        }
        70% {
          transform: translate3d(-10px, 0, 0);
        }
      }
      @keyframes softTailSwing {
        0%,
        100% {
          transform: rotate(0deg);
        }
        50% {
          transform: rotate(-11deg);
        }
      }
      @keyframes fxCyberLine {
        0% {
          transform: translate3d(-20px, 0, 0) rotate(var(--rot, 0deg));
          opacity: 0;
        }
        16% {
          opacity: var(--alpha, 0.34);
        }
        50% {
          transform: translate3d(var(--dx, 90px), var(--dy, 10px), 0)
            rotate(var(--rot, 0deg));
        }
        100% {
          transform: translate3d(24px, 0, 0) rotate(var(--rot, 0deg));
          opacity: 0;
        }
      }
      @keyframes fxCyberParticle {
        0%,
        100% {
          transform: translate3d(0, 0, 0) scale(0.9);
          opacity: calc(var(--alpha, 0.28) * 0.7);
        }
        50% {
          transform: translate3d(var(--dx, 20px), var(--dy, -16px), 0)
            scale(1.25);
          opacity: calc(var(--alpha, 0.28) + 0.18);
        }
      }
      @keyframes fxCyberWave {
        0%,
        100% {
          transform: translate3d(0, 0, 0) scale(0.92);
          opacity: 0.16;
        }
        50% {
          transform: translate3d(var(--dx, 20px), var(--dy, -8px), 0)
            scale(1.04);
          opacity: 0.3;
        }
      }
      @keyframes fxCyberScan {
        0% {
          transform: translateY(-8%);
          opacity: 0.08;
        }
        50% {
          transform: translateY(108%);
          opacity: 0.24;
        }
        100% {
          transform: translateY(-8%);
          opacity: 0.08;
        }
      }
      @keyframes fxGoldFall {
        0% {
          transform: translate3d(0, -22vh, 0) rotate(var(--rot-start, -12deg));
          opacity: 0;
        }
        14% {
          opacity: var(--alpha, 0.28);
        }
        100% {
          transform: translate3d(var(--drift, 16px), 120vh, 0)
            rotate(calc(var(--rot-start, -12deg) + var(--rot-spin, 120deg)));
          opacity: 0;
        }
      }
      @keyframes fxShardDrift {
        0% {
          transform: translate3d(0, 0, 0) rotate(var(--rot, -8deg));
          opacity: calc(var(--alpha, 0.24) * 0.72);
        }
        50% {
          transform: translate3d(var(--dx, 22px), var(--dy, -14px), 0)
            rotate(calc(var(--rot, -8deg) + 12deg));
          opacity: var(--alpha, 0.24);
        }
        100% {
          transform: translate3d(0, 0, 0) rotate(var(--rot, -8deg));
          opacity: calc(var(--alpha, 0.24) * 0.72);
        }
      }
      @keyframes fxShardShimmer {
        0%,
        100% {
          filter: brightness(1) saturate(1);
        }
        50% {
          filter: brightness(1.2) saturate(1.1);
        }
      }

      @media (prefers-reduced-motion: reduce) {
        *,
        *::before,
        *::after {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
        }
        .theme-fx {
          display: none !important;
        }
      }

      /* ------------------------------
      Premium UI atoms
    ------------------------------ */
      .theme-card {
        position: relative;
        isolation: isolate;
        transition:
          transform 0.2s ease,
          box-shadow 0.22s ease,
          border-color 0.22s ease;
      }
      .theme-card::before {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        border-radius: inherit;
        background: radial-gradient(
          900px 200px at 10% 0%,
          rgba(255, 255, 255, 0.08),
          transparent 65%
        );
        opacity: 0.55;
        z-index: 0;
      }
      .theme-card > * {
        position: relative;
        z-index: 1;
      }

      .chip {
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 900;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.06);
        color: var(--text);
        backdrop-filter: blur(14px);
        -webkit-backdrop-filter: blur(14px);
      }
      body[data-theme="mono"] .chip,
      body[data-theme="editorial"] .chip,
      body[data-theme="material"] .chip {
        background: rgba(255, 255, 255, 0.8);
        border: 1px solid rgba(0, 0, 0, 0.1);
      }
      .profile-head {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 12px;
      }
      .profile-name-stack {
        min-width: 0;
        display: flex;
        align-items: flex-start;
        gap: 10px;
      }
      .profile-name-icon {
        width: 32px;
        height: 32px;
        border-radius: 11px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: color-mix(in srgb, var(--bg) 88%, #000000 12%);
        border: 1px solid color-mix(in srgb, var(--accent2) 32%, transparent);
        background: linear-gradient(
          145deg,
          color-mix(in srgb, var(--accent) 86%, #ffffff 14%),
          color-mix(in srgb, var(--accent2) 74%, #ffffff 26%)
        );
        box-shadow:
          0 8px 18px rgba(0, 0, 0, 0.2),
          inset 0 1px 0 rgba(255, 255, 255, 0.32);
      }
      .profile-name-meta {
        min-width: 0;
      }
      .profile-major-pill {
        margin-top: 6px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border-radius: 999px;
        padding: 4px 10px;
        font-size: 11px;
        font-weight: 900;
        border: 1px solid color-mix(in srgb, var(--accent2) 34%, transparent);
        background: linear-gradient(
          120deg,
          color-mix(in srgb, var(--accent) 20%, transparent),
          color-mix(in srgb, var(--accent2) 18%, transparent)
        );
        color: var(--text);
        max-width: min(42ch, 100%);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2);
      }
      .profile-term-chip {
        position: relative;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 5px 11px !important;
        font-size: 11px;
        font-weight: 950;
        letter-spacing: 0.01em;
        border-color: color-mix(in srgb, var(--accent2) 42%, transparent);
        background: linear-gradient(
          125deg,
          color-mix(in srgb, var(--accent2) 26%, transparent),
          color-mix(in srgb, var(--accent) 20%, transparent)
        );
        box-shadow:
          0 6px 16px rgba(0, 0, 0, 0.16),
          inset 0 1px 0 rgba(255, 255, 255, 0.24);
      }
      .profile-term-chip::before {
        content: "";
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: color-mix(in srgb, var(--accent2) 85%, #ffffff 15%);
        box-shadow:
          0 0 0 1px rgba(255, 255, 255, 0.24),
          0 0 10px color-mix(in srgb, var(--accent2) 45%, transparent);
        flex: 0 0 auto;
      }
      .profile-start-row {
        margin-top: 10px;
        border-radius: 16px;
        border: 1px solid color-mix(in srgb, var(--accent2) 34%, var(--border));
        background:
          radial-gradient(
            320px 80px at 6% 0%,
            color-mix(in srgb, var(--accent2) 14%, transparent),
            transparent 72%
          ),
          color-mix(in srgb, var(--card-bg) 84%, transparent);
        padding: 9px 10px;
        display: grid;
        gap: 7px;
        box-shadow:
          0 10px 22px rgba(2, 6, 23, 0.16),
          inset 0 1px 0 rgba(255, 255, 255, 0.16);
      }
      .profile-start-head {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .profile-start-icon {
        width: 30px;
        height: 30px;
        border-radius: 10px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: color-mix(in srgb, var(--text) 88%, #ffffff 12%);
        border: 1px solid color-mix(in srgb, var(--accent2) 40%, transparent);
        background: linear-gradient(
          145deg,
          color-mix(in srgb, var(--accent) 24%, transparent),
          color-mix(in srgb, var(--accent2) 18%, transparent)
        );
        box-shadow:
          0 8px 18px rgba(2, 6, 23, 0.22),
          inset 0 1px 0 rgba(255, 255, 255, 0.28);
        flex: 0 0 auto;
      }
      .profile-start-icon svg {
        width: 15px;
        height: 15px;
      }
      .profile-start-text {
        min-width: 0;
        flex: 1 1 auto;
      }
      .profile-start-label {
        font-size: 10px;
        font-weight: 900;
        opacity: 0.72;
        line-height: 1.45;
      }
      .profile-start-value {
        margin-top: 2px;
        font-size: 13px;
        font-weight: 900;
        color: color-mix(in srgb, var(--text) 92%, #ffffff 8%);
        line-height: 1.45;
      }
      .profile-start-value.is-empty {
        color: #f59e0b;
      }
      .profile-start-edit {
        flex: 0 0 auto;
        min-height: 30px;
        padding: 0 10px;
        border-radius: 999px;
        border: 1px solid color-mix(in srgb, var(--accent2) 42%, var(--border));
        background: color-mix(in srgb, var(--card-bg) 84%, transparent);
        color: color-mix(in srgb, var(--text) 90%, #ffffff 10%);
        font-size: 10px;
        font-weight: 900;
        transition:
          transform 0.15s ease,
          filter 0.18s ease,
          border-color 0.18s ease;
      }
      .profile-start-edit:hover {
        transform: translateY(-1px);
        filter: brightness(1.06);
        border-color: color-mix(in srgb, var(--accent2) 58%, var(--border));
      }
      .profile-start-meta {
        display: inline-flex;
        align-items: center;
        border-radius: 999px;
        padding: 3px 9px;
        font-size: 10px;
        font-weight: 900;
        border: 1px solid color-mix(in srgb, var(--accent2) 34%, var(--border));
        background: color-mix(in srgb, var(--card-bg) 82%, transparent);
        color: color-mix(in srgb, var(--text) 84%, #ffffff 16%);
        max-width: 100%;
      }
      .profile-start-meta.is-empty {
        border-color: rgba(245, 158, 11, 0.56);
        color: #fcd34d;
        background: linear-gradient(
          140deg,
          rgba(245, 158, 11, 0.22),
          rgba(251, 191, 36, 0.12)
        );
      }
      .next-title-wrap {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
      }
      .class-number-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border-radius: 999px;
        padding: 3px 9px;
        font-size: 10px;
        font-weight: 950;
        border: 1px solid rgba(251, 146, 60, 0.7);
        color: #fff7ed;
        background: linear-gradient(
          125deg,
          rgba(251, 146, 60, 0.9),
          rgba(239, 68, 68, 0.86)
        );
        box-shadow:
          0 7px 16px rgba(239, 68, 68, 0.24),
          inset 0 1px 0 rgba(255, 255, 255, 0.26);
        white-space: nowrap;
      }
      .class-number-chip::before {
        content: "#";
        width: 14px;
        height: 14px;
        border-radius: 999px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 8px;
        font-weight: 900;
        border: 1px solid rgba(255, 255, 255, 0.35);
        background: rgba(0, 0, 0, 0.22);
      }
      .class-number-chip__label {
        opacity: 0.9;
      }
      .class-number-chip__value {
        font-family: var(--font-time);
        font-size: 11px;
        letter-spacing: 0.03em;
      }
      .class-number-chip--lg {
        padding: 4px 10px;
        font-size: 11px;
      }
      .class-number-line {
        margin-top: 7px;
      }
      .session-pill {
        display: inline-flex;
        align-items: center;
        justify-content: flex-start;
        gap: 7px;
        border-radius: 999px;
        padding: 4px 12px;
        font-size: 10.5px;
        font-weight: 950;
        border: 1px solid color-mix(in srgb, var(--accent2) 44%, var(--border));
        background: linear-gradient(
          132deg,
          color-mix(in srgb, var(--accent2) 28%, transparent),
          color-mix(in srgb, var(--accent) 20%, transparent)
        );
        color: color-mix(in srgb, var(--text) 96%, #ffffff 4%);
        box-shadow:
          0 8px 18px rgba(2, 6, 23, 0.22),
          inset 0 1px 0 rgba(255, 255, 255, 0.22);
        line-height: 1.4;
        white-space: nowrap;
      }
      .session-pill-gem {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: color-mix(in srgb, var(--accent2) 84%, #ffffff 16%);
        box-shadow:
          0 0 10px color-mix(in srgb, var(--accent2) 48%, transparent),
          0 0 0 1px rgba(255, 255, 255, 0.24);
        flex: 0 0 auto;
      }
      .session-pill--ok {
        border-color: rgba(14, 165, 233, 0.52);
      }
      .session-pill--ok .session-pill-gem {
        background: #38bdf8;
      }
      .session-pill--pending {
        border-color: rgba(245, 158, 11, 0.58);
        background: linear-gradient(
          140deg,
          rgba(245, 158, 11, 0.28),
          rgba(251, 191, 36, 0.2)
        );
        color: #fffbeb;
      }
      .session-pill--pending .session-pill-gem {
        background: #f59e0b;
      }
      .session-pill--missing {
        border-color: rgba(249, 115, 22, 0.64);
        background: linear-gradient(
          140deg,
          rgba(249, 115, 22, 0.32),
          rgba(239, 68, 68, 0.28)
        );
        color: #fff7ed;
      }
      .session-pill--missing .session-pill-gem {
        background: #fb923c;
      }
      .class-session-line,
      .mobile-session-line {
        margin-top: 8px;
        position: relative;
        z-index: 1;
      }
      .session-hint {
        margin-top: 6px;
        font-size: 10px;
        line-height: 1.68;
        opacity: 0.84;
        position: relative;
        z-index: 1;
      }
      .session-hint--missing {
        color: #fdba74;
      }
      .session-hint--pending {
        color: #fcd34d;
      }
      .schedule-hint--session-start {
        border-color: color-mix(in srgb, var(--accent2) 44%, var(--border));
        background:
          radial-gradient(
            560px 130px at 4% -10%,
            color-mix(in srgb, var(--accent2) 16%, transparent),
            transparent 72%
          ),
          color-mix(in srgb, var(--card-bg) 86%, transparent);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }
      .schedule-hint-copy {
        min-width: 0;
      }
      .schedule-hint-title {
        font-size: 11px;
        font-weight: 900;
      }
      .schedule-hint-note {
        margin-top: 2px;
        font-size: 10px;
        line-height: 1.68;
        opacity: 0.84;
      }
      .schedule-hint-action {
        border-radius: 999px;
        border: 1px solid color-mix(in srgb, var(--accent2) 48%, var(--border));
        min-height: 32px;
        padding: 0 12px;
        background: color-mix(in srgb, var(--card-bg) 88%, transparent);
        color: var(--text);
        font-size: 10px;
        font-weight: 900;
        white-space: nowrap;
        transition:
          transform 0.15s ease,
          filter 0.18s ease,
          border-color 0.18s ease;
      }
      .schedule-hint-action:hover {
        transform: translateY(-1px);
        filter: brightness(1.07);
        border-color: color-mix(in srgb, var(--accent2) 64%, var(--border));
      }
      @media (max-width: 1024px) {
        .schedule-hint--session-start {
          flex-direction: column;
          align-items: stretch;
        }
        .schedule-hint-action {
          width: 100%;
        }
      }
      .profile-meta-modal {
        width: min(100%, 760px);
        max-height: min(
          calc(
            var(--profile-modal-vh, var(--app-vh)) - env(safe-area-inset-top) -
              env(safe-area-inset-bottom) - 24px
          ),
          90vh
        );
        border-radius: 26px;
        border: 1px solid color-mix(in srgb, var(--accent2) 28%, var(--border));
        background:
          radial-gradient(
            180% 110% at 2% -24%,
            color-mix(in srgb, var(--accent2) 18%, transparent),
            transparent 52%
          ),
          radial-gradient(
            150% 90% at 100% -20%,
            color-mix(in srgb, var(--accent) 14%, transparent),
            transparent 48%
          ),
          color-mix(in srgb, var(--card-bg) 92%, transparent);
        padding: 18px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        overflow: hidden;
      }
      .profile-meta-modal.is-compact {
        border-radius: 18px;
        padding: 12px;
        gap: 8px;
      }
      .profile-meta-modal.is-compact .profile-meta-title {
        font-size: 17px;
      }
      .profile-meta-modal.is-compact .profile-meta-sub {
        display: none;
      }
      .profile-meta-modal.is-compact .profile-meta-badge {
        padding: 4px 8px;
        font-size: 9px;
      }
      .profile-meta-modal.is-compact .profile-meta-grid {
        gap: 8px;
      }
      .profile-meta-modal.is-compact .profile-term-field {
        padding: 8px;
      }
      .profile-meta-modal.is-compact .profile-term-stats {
        display: none;
      }
      .profile-meta-modal.is-compact .profile-meta-actions {
        padding-top: 8px;
      }
      .profile-meta-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }
      .profile-meta-title-wrap {
        min-width: 0;
        display: grid;
        gap: 3px;
      }
      .profile-meta-title {
        margin: 0;
        font-size: 20px;
        font-weight: 950;
        line-height: 1.35;
      }
      .profile-meta-sub {
        font-size: 10px;
        line-height: 1.62;
        opacity: 0.84;
      }
      .profile-meta-badge {
        border-radius: 999px;
        padding: 6px 10px;
        border: 1px solid color-mix(in srgb, var(--accent2) 42%, var(--border));
        background: color-mix(in srgb, var(--card-bg) 84%, transparent);
        font-size: 10px;
        font-weight: 900;
        white-space: nowrap;
      }
      .profile-meta-form {
        min-height: 0;
        min-width: 0;
        flex: 1 1 auto;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .profile-meta-scroll {
        min-height: 0;
        min-width: 0;
        flex: 1 1 auto;
        overflow-y: auto;
        overflow-x: hidden;
        overscroll-behavior-y: contain;
        -webkit-overflow-scrolling: touch;
        display: grid;
        gap: 10px;
        padding-inline-end: 4px;
        padding-bottom: 2px;
        scrollbar-gutter: stable;
      }
      .profile-meta-scroll::-webkit-scrollbar {
        width: 8px;
      }
      .profile-meta-scroll::-webkit-scrollbar-track {
        background: color-mix(in srgb, var(--card-bg) 80%, transparent);
        border-radius: 999px;
      }
      .profile-meta-scroll::-webkit-scrollbar-thumb {
        background: color-mix(in srgb, var(--accent2) 40%, var(--border));
        border-radius: 999px;
      }
      .profile-meta-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 10px;
      }
      .profile-field {
        display: grid;
        gap: 6px;
      }
      .profile-field-label {
        font-size: 11px;
        opacity: 0.78;
        font-weight: 900;
      }
      .profile-input-shell {
        display: flex;
        align-items: center;
        gap: 8px;
        border-radius: 14px;
        border: 1px solid color-mix(in srgb, var(--accent2) 34%, var(--border));
        background: color-mix(in srgb, var(--card-bg) 84%, transparent);
        padding: 8px 10px;
        transition:
          border-color 0.18s ease,
          box-shadow 0.18s ease,
          filter 0.18s ease;
      }
      .profile-input-shell:focus-within {
        border-color: color-mix(in srgb, var(--accent2) 62%, var(--border));
        box-shadow: 0 0 0 4px
          color-mix(in srgb, var(--accent2) 16%, transparent);
      }
      .profile-input-icon {
        width: 24px;
        height: 24px;
        border-radius: 8px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: 1px solid color-mix(in srgb, var(--accent2) 38%, transparent);
        background: linear-gradient(
          142deg,
          color-mix(in srgb, var(--accent) 26%, transparent),
          color-mix(in srgb, var(--accent2) 18%, transparent)
        );
        color: color-mix(in srgb, var(--text) 90%, #ffffff 10%);
        flex: 0 0 auto;
      }
      .profile-input-icon svg {
        width: 13px;
        height: 13px;
      }
      .profile-text-input {
        flex: 1 1 auto;
        border: none !important;
        box-shadow: none !important;
        background: transparent !important;
        padding: 0 !important;
        min-height: 28px;
      }
      .profile-term-field {
        display: grid;
        min-width: 0;
        gap: 8px;
        padding: 10px;
        border-radius: 16px;
        border: 1px solid color-mix(in srgb, var(--accent2) 30%, var(--border));
        background: linear-gradient(
          155deg,
          color-mix(in srgb, var(--card-bg) 90%, transparent),
          color-mix(in srgb, var(--card-bg) 80%, transparent)
        );
      }
      .profile-term-head {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 8px;
      }
      .profile-term-stats {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        flex-wrap: wrap;
        gap: 6px;
      }
      .profile-term-stat {
        border-radius: 999px;
        padding: 3px 7px;
        border: 1px solid color-mix(in srgb, var(--accent2) 34%, var(--border));
        background: color-mix(in srgb, var(--card-bg) 82%, transparent);
        font-size: 9px;
        font-weight: 900;
        line-height: 1.4;
      }
      .profile-term-stat--current {
        border-color: rgba(59, 130, 246, 0.56);
      }
      .profile-term-stat--saved {
        border-color: rgba(16, 185, 129, 0.52);
      }
      .profile-term-stat--new {
        border-color: rgba(245, 158, 11, 0.52);
      }
      .profile-term-shell {
        display: flex;
        align-items: center;
        gap: 8px;
        border-radius: 14px;
        border: 1px solid color-mix(in srgb, var(--accent2) 34%, var(--border));
        background: color-mix(in srgb, var(--card-bg) 86%, transparent);
        padding: 10px 12px;
        transition:
          border-color 0.18s ease,
          box-shadow 0.18s ease,
          filter 0.18s ease;
      }
      .profile-term-shell::after {
        content: "";
        width: 7px;
        height: 7px;
        border-right: 2px solid currentColor;
        border-bottom: 2px solid currentColor;
        transform: rotate(45deg) translateY(-1px);
        opacity: 0.72;
        margin-inline-start: auto;
      }
      .profile-term-shell:focus-within {
        border-color: color-mix(in srgb, var(--accent2) 60%, var(--border));
        box-shadow: 0 0 0 4px
          color-mix(in srgb, var(--accent2) 15%, transparent);
      }
      .profile-term-icon {
        width: 24px;
        height: 24px;
        border-radius: 8px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: 1px solid color-mix(in srgb, var(--accent2) 36%, transparent);
        background: linear-gradient(
          140deg,
          color-mix(in srgb, var(--accent) 26%, transparent),
          color-mix(in srgb, var(--accent2) 18%, transparent)
        );
        color: color-mix(in srgb, var(--text) 90%, #ffffff 10%);
        flex: 0 0 auto;
      }
      .profile-term-icon svg {
        width: 13px;
        height: 13px;
      }
      .profile-term-select {
        flex: 1 1 auto;
        border: none !important;
        box-shadow: none !important;
        background: transparent !important;
        padding: 0 !important;
        min-height: 30px;
        font-size: 13px !important;
        font-weight: 900;
        appearance: none;
        -webkit-appearance: none;
      }
      .profile-term-helper {
        font-size: 10px;
        line-height: 1.68;
        opacity: 0.84;
      }
      .profile-term-grid-wrap {
        position: relative;
      }
      .profile-term-grid {
        display: grid;
        grid-template-columns: repeat(5, minmax(0, 1fr));
        gap: 8px;
        min-width: 0;
      }
      .profile-term-pill {
        min-height: 54px;
        min-width: 0;
        border-radius: 12px;
        padding: 6px 7px;
        border: 1px solid color-mix(in srgb, var(--accent2) 34%, var(--border));
        background:
          linear-gradient(
            145deg,
            color-mix(in srgb, var(--card-bg) 88%, transparent),
            color-mix(in srgb, var(--bg) 20%, transparent)
          ),
          radial-gradient(
            140px 44px at 14% -22%,
            color-mix(in srgb, var(--accent2) 18%, transparent),
            transparent 72%
          );
        color: color-mix(in srgb, var(--text) 92%, #ffffff 8%);
        display: grid;
        place-items: center;
        gap: 3px;
        transition:
          transform 0.16s ease,
          filter 0.18s ease,
          border-color 0.18s ease,
          box-shadow 0.18s ease;
      }
      .profile-term-pill:hover {
        transform: translateY(-1px);
        filter: brightness(1.06);
      }
      .profile-term-pill__name {
        font-size: 11px;
        font-weight: 950;
        line-height: 1.35;
      }
      .profile-term-pill__meta {
        font-size: 9px;
        line-height: 1.3;
        opacity: 0.86;
      }
      .profile-term-pill__state {
        border-radius: 999px;
        padding: 1px 6px;
        border: 1px solid color-mix(in srgb, var(--accent2) 34%, var(--border));
        background: color-mix(in srgb, var(--card-bg) 80%, transparent);
        font-size: 8px;
        font-weight: 900;
        line-height: 1.35;
      }
      .profile-term-pill[data-state="current"] {
        border-color: rgba(59, 130, 246, 0.72);
        box-shadow:
          0 8px 18px rgba(59, 130, 246, 0.22),
          inset 0 1px 0 rgba(255, 255, 255, 0.28);
      }
      .profile-term-pill[data-state="current"] .profile-term-pill__state {
        border-color: rgba(59, 130, 246, 0.68);
      }
      .profile-term-pill[data-state="saved"] {
        border-color: rgba(16, 185, 129, 0.58);
      }
      .profile-term-pill[data-state="saved"] .profile-term-pill__state {
        border-color: rgba(16, 185, 129, 0.64);
      }
      .profile-term-pill[data-state="new"] {
        border-color: rgba(245, 158, 11, 0.56);
      }
      .profile-term-pill[data-state="new"] .profile-term-pill__state {
        border-color: rgba(245, 158, 11, 0.66);
      }
      .profile-term-pill.is-selected {
        border-color: color-mix(in srgb, var(--accent2) 68%, var(--border));
        background:
          linear-gradient(
            142deg,
            color-mix(in srgb, var(--accent2) 34%, transparent),
            color-mix(in srgb, var(--accent) 26%, transparent)
          ),
          color-mix(in srgb, var(--card-bg) 84%, transparent);
        box-shadow:
          0 12px 24px rgba(2, 6, 23, 0.24),
          inset 0 1px 0 rgba(255, 255, 255, 0.26);
      }
      .profile-term-existing {
        border-radius: 11px;
        border: 1px dashed color-mix(in srgb, var(--accent2) 30%, var(--border));
        background: color-mix(in srgb, var(--card-bg) 82%, transparent);
        font-size: 10px;
        line-height: 1.64;
        opacity: 0.88;
        padding: 7px 8px;
        overflow-wrap: anywhere;
      }
      .profile-term-warning {
        border-radius: 11px;
        border: 1px solid rgba(245, 158, 11, 0.62);
        background: linear-gradient(
          145deg,
          rgba(245, 158, 11, 0.22),
          rgba(251, 191, 36, 0.12)
        );
        color: #fcd34d;
        font-size: 11px;
        font-weight: 900;
        line-height: 1.65;
        padding: 8px 9px;
        overflow-wrap: anywhere;
      }
      .profile-term-confirm {
        border-radius: 12px;
        border: 1px dashed color-mix(in srgb, var(--accent2) 46%, var(--border));
        background: color-mix(in srgb, var(--card-bg) 82%, transparent);
        padding: 9px;
        display: grid;
        gap: 8px;
      }
      .profile-term-confirm-title {
        font-size: 11px;
        font-weight: 900;
        line-height: 1.62;
        overflow-wrap: anywhere;
      }
      .profile-term-confirm-actions {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 8px;
      }
      .profile-term-confirm-btn {
        min-height: 34px;
        border-radius: 10px;
        font-size: 11px;
        font-weight: 900;
        border: 1px solid var(--border);
        transition:
          transform 0.15s ease,
          filter 0.18s ease,
          border-color 0.18s ease;
      }
      .profile-term-confirm-btn:hover {
        transform: translateY(-1px);
        filter: brightness(1.07);
      }
      .profile-term-confirm-btn--yes {
        border-color: rgba(16, 185, 129, 0.62);
        background: linear-gradient(
          140deg,
          rgba(16, 185, 129, 0.26),
          rgba(16, 185, 129, 0.14)
        );
      }
      .profile-term-confirm-btn--no {
        border-color: rgba(239, 68, 68, 0.62);
        background: linear-gradient(
          140deg,
          rgba(239, 68, 68, 0.24),
          rgba(239, 68, 68, 0.12)
        );
      }
      .profile-date-field {
        display: grid;
        gap: 6px;
      }
      .profile-date-shell {
        display: flex;
        align-items: center;
        gap: 8px;
        border-radius: 14px;
        border: 1px solid color-mix(in srgb, var(--accent2) 34%, var(--border));
        background: color-mix(in srgb, var(--card-bg) 84%, transparent);
        padding: 8px 10px;
        transition:
          border-color 0.18s ease,
          box-shadow 0.18s ease,
          filter 0.18s ease;
      }
      .profile-date-shell:focus-within {
        border-color: color-mix(in srgb, var(--accent2) 60%, var(--border));
        box-shadow: 0 0 0 4px
          color-mix(in srgb, var(--accent2) 15%, transparent);
      }
      .profile-date-icon {
        width: 24px;
        height: 24px;
        border-radius: 8px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: 1px solid color-mix(in srgb, var(--accent2) 36%, transparent);
        background: linear-gradient(
          140deg,
          color-mix(in srgb, var(--accent) 22%, transparent),
          color-mix(in srgb, var(--accent2) 14%, transparent)
        );
        color: color-mix(in srgb, var(--text) 90%, #ffffff 10%);
        flex: 0 0 auto;
      }
      .profile-date-icon svg {
        width: 13px;
        height: 13px;
      }
      .profile-date-input {
        flex: 1 1 auto;
        border: none !important;
        box-shadow: none !important;
        background: transparent !important;
        padding: 0 !important;
        min-height: 28px;
        font-family: var(--font-en);
      }
      .profile-date-input::-webkit-calendar-picker-indicator {
        opacity: 0.9;
        cursor: pointer;
      }
      .profile-date-helper {
        font-size: 10px;
        line-height: 1.68;
        opacity: 0.78;
      }
      .profile-meta-actions {
        margin-top: 2px;
        padding-top: 10px;
        padding-bottom: calc(2px + env(safe-area-inset-bottom));
        border-top: 1px solid var(--border);
        display: flex;
        gap: 8px;
        align-items: center;
        justify-content: flex-end;
      }
      .profile-meta-save {
        min-height: 40px;
        border-radius: 13px;
        padding: 0 16px;
        border: 1px solid color-mix(in srgb, var(--accent) 50%, transparent);
        background: linear-gradient(
          135deg,
          color-mix(in srgb, var(--accent) 88%, transparent),
          color-mix(in srgb, var(--accent2) 74%, transparent)
        );
        color: var(--bg);
        font-weight: 900;
        transition:
          transform 0.15s ease,
          filter 0.18s ease,
          box-shadow 0.18s ease;
      }
      .profile-meta-save:hover {
        transform: translateY(-1px);
        filter: brightness(1.08);
      }
      .profile-meta-cancel {
        min-height: 40px;
        border-radius: 13px;
        padding: 0 14px;
        border: 1px solid color-mix(in srgb, var(--accent2) 30%, var(--border));
        background: color-mix(in srgb, var(--card-bg) 82%, transparent);
        font-weight: 900;
      }
      @media (max-width: 860px) {
        .profile-meta-modal {
          width: min(100%, 650px);
          border-radius: 22px;
          padding: 15px;
        }
        .profile-meta-grid {
          grid-template-columns: 1fr;
        }
      }
      @media (max-width: 640px) {
        .profile-meta-modal {
          width: min(100%, 100%);
          border-radius: 18px;
          padding: 12px;
        }
        .profile-meta-title {
          font-size: 18px;
        }
        .profile-meta-sub {
          font-size: 9px;
        }
        .profile-meta-badge {
          display: none;
        }
        .profile-term-head {
          display: grid;
          gap: 6px;
        }
        .profile-term-stats {
          justify-content: flex-start;
        }
        .profile-term-shell {
          padding: 9px 10px;
        }
        .profile-term-grid-wrap::before,
        .profile-term-grid-wrap::after {
          content: none;
        }
        .profile-term-grid {
          grid-template-columns: repeat(2, minmax(0, 1fr));
          grid-auto-flow: row;
          grid-auto-columns: auto;
          overflow-x: hidden;
          overflow-y: visible;
          padding-bottom: 0;
          -webkit-overflow-scrolling: auto;
          scroll-snap-type: none;
        }
        .profile-term-pill {
          min-height: 48px;
          border-radius: 11px;
          padding: 6px;
          scroll-snap-align: none;
        }
        .profile-term-pill__name {
          font-size: 10px;
          line-height: 1.25;
        }
        .profile-term-pill__meta {
          font-size: 8px;
          line-height: 1.2;
        }
        .profile-term-confirm-actions {
          grid-template-columns: 1fr;
        }
        .profile-term-confirm-btn {
          min-height: 36px;
        }
        .profile-meta-actions {
          display: grid;
          grid-template-columns: 1fr 1fr;
        }
      }
      @media (max-width: 390px) {
        .profile-term-grid {
          grid-template-columns: 1fr;
        }
      }
      @media (max-width: 1024px) and (max-height: 720px) {
        .profile-meta-modal {
          border-radius: 16px;
          padding: 10px;
          gap: 8px;
        }
        .profile-meta-title {
          font-size: 16px;
        }
        .profile-meta-sub,
        .profile-term-stats {
          display: none;
        }
        .profile-meta-grid {
          gap: 8px;
        }
        .profile-term-field {
          padding: 8px;
        }
        .profile-meta-actions {
          padding-top: 8px;
        }
      }

      .attendance-summary {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 9px;
        margin-bottom: 12px;
      }
      .attendance-num {
        font-family: var(--font-attendance-num);
        font-variant-numeric: tabular-nums;
        font-feature-settings:
          "tnum" 1,
          "lnum" 1;
        direction: ltr;
        unicode-bidi: isolate;
        letter-spacing: 0.015em;
      }
      .attendance-summary-item {
        border-radius: 14px;
        border: 1px solid color-mix(in srgb, var(--accent2) 26%, var(--border));
        background:
          linear-gradient(
            145deg,
            color-mix(in srgb, var(--card-bg) 74%, transparent),
            color-mix(in srgb, var(--card-bg) 90%, transparent)
          ),
          radial-gradient(
            140px 52px at 12% -16%,
            color-mix(in srgb, var(--accent2) 16%, transparent),
            transparent 76%
          );
        padding: 8px 7px;
        text-align: center;
      }
      .attendance-summary-item .value {
        font-size: 14px;
        font-weight: 950;
        line-height: 1.1;
        font-family: var(--font-attendance-num);
        font-variant-numeric: tabular-nums;
        font-feature-settings:
          "tnum" 1,
          "lnum" 1;
        letter-spacing: 0.02em;
        direction: ltr;
        unicode-bidi: isolate;
        text-shadow: 0 1px 0 rgba(255, 255, 255, 0.2);
      }
      .attendance-summary-item .label {
        margin-top: 2px;
        font-size: 9px;
        font-weight: 900;
        opacity: 0.82;
      }
      .attendance-panel-head {
        border-radius: 14px;
        border: 1px solid color-mix(in srgb, var(--accent2) 32%, var(--border));
        background:
          radial-gradient(
            360px 90px at 8% -20%,
            color-mix(in srgb, var(--accent2) 16%, transparent),
            transparent 72%
          ),
          color-mix(in srgb, var(--card-bg) 86%, transparent);
        padding: 8px;
        margin-bottom: 10px;
      }
      .attendance-panel-top {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 8px;
        flex-wrap: wrap;
      }
      .attendance-filter-bar {
        display: grid;
        gap: 8px;
        margin-bottom: 0;
      }
      .attendance-filter-stack {
        display: grid;
        align-items: start;
        gap: 6px;
        min-width: min(100%, 480px);
      }
      .attendance-segment {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        border-radius: 999px;
        border: 1px solid color-mix(in srgb, var(--accent2) 44%, var(--border));
        background: color-mix(in srgb, var(--card-bg) 82%, transparent);
        padding: 3px;
      }
      .attendance-segment-btn {
        min-height: 29px;
        border-radius: 999px;
        border: 1px solid transparent;
        background: transparent;
        color: color-mix(in srgb, var(--text) 90%, #fff 10%);
        padding: 0 10px;
        font-size: 10px;
        font-weight: 900;
        transition:
          filter 0.18s ease,
          transform 0.14s ease,
          border-color 0.18s ease;
      }
      .attendance-segment-btn:hover {
        filter: brightness(1.06);
      }
      .attendance-segment-btn.is-active {
        border-color: color-mix(in srgb, var(--accent2) 66%, var(--border));
        background: color-mix(in srgb, var(--accent2) 28%, transparent);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2);
      }
      .attendance-segment-btn .count {
        margin-inline-start: 4px;
        opacity: 0.86;
        font-family: var(--font-attendance-num);
        direction: ltr;
        unicode-bidi: isolate;
        font-size: 9px;
      }
      .attendance-tools {
        display: inline-flex;
        align-items: center;
        gap: 7px;
        flex-wrap: wrap;
      }
      .attendance-tools.attendance-bulk-actions {
        margin-bottom: 10px;
        margin-top: 2px;
        flex-wrap: wrap;
      }
      .attendance-tool-btn {
        min-height: 30px;
        border-radius: 999px;
        border: 1px solid color-mix(in srgb, var(--accent2) 44%, var(--border));
        background: color-mix(in srgb, var(--card-bg) 84%, transparent);
        color: color-mix(in srgb, var(--text) 92%, #fff 8%);
        padding: 0 10px;
        font-size: 10px;
        font-weight: 900;
        transition:
          transform 0.14s ease,
          filter 0.18s ease,
          border-color 0.18s ease;
      }
      .attendance-tool-btn:hover {
        transform: translateY(-1px);
        filter: brightness(1.06);
      }
      .attendance-tool-btn:disabled {
        opacity: 0.55;
        cursor: not-allowed;
        transform: none !important;
      }
      .attendance-date-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border-radius: 999px;
        padding: 4px 10px;
        border: 1px solid color-mix(in srgb, var(--accent2) 42%, var(--border));
        background: color-mix(in srgb, var(--card-bg) 84%, transparent);
        font-size: 10px;
        font-weight: 900;
        margin-bottom: 0;
      }
      .attendance-date-chip .attendance-num {
        font-family: var(--font-attendance-num);
        direction: ltr;
        unicode-bidi: isolate;
      }
      .attendance-alert-rack {
        display: grid;
        gap: 7px;
        margin-bottom: 8px;
      }
      .attendance-alert-card {
        position: relative;
        overflow: hidden;
        border-radius: 14px;
        border: 1px solid color-mix(in srgb, var(--border) 82%, transparent);
        background:
          radial-gradient(
            420px 120px at 6% -14%,
            color-mix(in srgb, var(--accent2) 16%, transparent),
            transparent 72%
          ),
          color-mix(in srgb, var(--card-bg) 86%, transparent);
        padding: 8px 10px;
      }
      .attendance-alert-card::after {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        background: linear-gradient(
          140deg,
          rgba(255, 255, 255, 0.2),
          rgba(255, 255, 255, 0) 34%
        );
        opacity: 0.5;
      }
      .attendance-alert-card > * {
        position: relative;
        z-index: 1;
      }
      .attendance-alert-title {
        font-size: 11px;
        font-weight: 950;
        line-height: 1.6;
        color: color-mix(in srgb, var(--text) 94%, #fff 6%);
      }
      .attendance-alert-title .attendance-num {
        font-size: 10.5px;
      }
      .attendance-alert-note {
        margin-top: 2px;
        font-size: 10px;
        line-height: 1.68;
        opacity: 0.84;
      }
      .attendance-alert-card.tone-warn {
        border-color: rgba(245, 158, 11, 0.5);
        background:
          radial-gradient(
            420px 130px at 8% -10%,
            rgba(245, 158, 11, 0.2),
            transparent 72%
          ),
          color-mix(in srgb, var(--card-bg) 84%, transparent);
      }
      .attendance-alert-card.tone-risk {
        border-color: rgba(249, 115, 22, 0.52);
        background:
          radial-gradient(
            420px 130px at 8% -10%,
            rgba(249, 115, 22, 0.22),
            transparent 72%
          ),
          color-mix(in srgb, var(--card-bg) 84%, transparent);
      }
      .attendance-alert-card.tone-ok {
        border-color: rgba(16, 185, 129, 0.48);
        background:
          radial-gradient(
            420px 130px at 8% -10%,
            rgba(16, 185, 129, 0.2),
            transparent 72%
          ),
          color-mix(in srgb, var(--card-bg) 84%, transparent);
      }
      .attendance-alert-card.tone-info {
        border-color: rgba(14, 165, 233, 0.48);
        background:
          radial-gradient(
            420px 130px at 8% -10%,
            rgba(14, 165, 233, 0.2),
            transparent 72%
          ),
          color-mix(in srgb, var(--card-bg) 84%, transparent);
      }
      .attendance-list-item {
        position: relative;
        overflow: hidden;
        contain: layout paint;
        border-radius: 16px;
        border: 1px solid color-mix(in srgb, var(--accent2) 30%, var(--border));
        background:
          radial-gradient(
            520px 150px at 10% -10%,
            color-mix(in srgb, var(--accent2) 20%, transparent),
            transparent 72%
          ),
          color-mix(in srgb, var(--card-bg) 86%, transparent);
        padding: 11px;
        transition:
          transform 0.14s ease,
          filter 0.18s ease,
          border-color 0.18s ease;
      }
      .attendance-list-item::after {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        background: linear-gradient(
          140deg,
          rgba(255, 255, 255, 0.16),
          rgba(255, 255, 255, 0) 34%
        );
        opacity: 0.52;
      }
      .attendance-list-item > * {
        position: relative;
        z-index: 1;
      }
      .attendance-list-item:hover {
        transform: translateY(-1px);
        filter: brightness(1.06);
        border-color: color-mix(in srgb, var(--accent2) 56%, var(--border));
      }
      .attendance-list-item.is-risk {
        border-color: rgba(245, 158, 11, 0.56);
        box-shadow:
          0 10px 24px rgba(245, 158, 11, 0.14),
          inset 0 1px 0 rgba(255, 255, 255, 0.16);
      }
      .attendance-head {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 8px;
      }
      .attendance-course {
        min-width: 0;
      }
      .attendance-course-title {
        font-size: 12px;
        line-height: 1.5;
        font-weight: 950;
        color: color-mix(in srgb, var(--text) 95%, #fff 5%);
      }
      .attendance-course-meta {
        margin-top: 2px;
        font-size: 10px;
        opacity: 0.88;
      }
      .attendance-status-pill {
        flex: 0 0 auto;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border-radius: 999px;
        padding: 4px 10px;
        font-size: 10px;
        font-weight: 900;
        border: 1px solid color-mix(in srgb, var(--border) 72%, transparent);
        background: color-mix(in srgb, var(--card-bg) 88%, transparent);
        text-shadow: 0 1px 0 rgba(255, 255, 255, 0.1);
      }
      .attendance-status-pill::before {
        content: "";
        width: 6px;
        height: 6px;
        border-radius: 999px;
        background: currentColor;
        opacity: 0.9;
        box-shadow: 0 0 8px currentColor;
      }
      .attendance-status-pill.status-present {
        border-color: color-mix(in srgb, #10b981 62%, var(--border));
        background: color-mix(in srgb, #10b981 28%, var(--card-bg));
        color: color-mix(in srgb, var(--text) 86%, #052e16 14%);
      }
      .attendance-status-pill.status-absent {
        border-color: color-mix(in srgb, #ef4444 62%, var(--border));
        background: color-mix(in srgb, #ef4444 28%, var(--card-bg));
        color: color-mix(in srgb, var(--text) 86%, #7f1d1d 14%);
      }
      .attendance-status-pill.status-pending {
        border-color: color-mix(in srgb, #f59e0b 64%, var(--border));
        background: color-mix(in srgb, #f59e0b 30%, var(--card-bg));
        color: color-mix(in srgb, var(--text) 88%, #78350f 12%);
      }
      .attendance-status-pill.status-no-class {
        opacity: 0.92;
        color: color-mix(in srgb, var(--text) 80%, #64748b 20%);
      }
      .attendance-status-pill.status-no-class::before {
        opacity: 0.55;
      }
      .attendance-count-row {
        margin-top: 8px;
        display: flex;
        align-items: center;
        gap: 7px;
        flex-wrap: wrap;
      }
      .attendance-count-badge {
        border-radius: 999px;
        padding: 4px 10px;
        font-size: 10px;
        font-weight: 900;
        border: 1px solid color-mix(in srgb, var(--border) 68%, transparent);
        background: color-mix(in srgb, var(--card-bg) 84%, transparent);
        color: color-mix(in srgb, var(--text) 92%, #fff 8%);
      }
      .attendance-count-badge .num {
        font-family: var(--font-attendance-num);
        font-size: 11px;
        font-weight: 950;
        font-variant-numeric: tabular-nums;
        font-feature-settings:
          "tnum" 1,
          "lnum" 1;
        letter-spacing: 0.02em;
        direction: ltr;
        unicode-bidi: isolate;
        margin-inline-start: 4px;
        min-width: 2.1em;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 1px 7px;
        border-radius: 999px;
        border: 1px solid color-mix(in srgb, var(--border) 74%, transparent);
        background: color-mix(in srgb, var(--bg) 44%, transparent);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.16);
      }
      .attendance-count-badge.is-absent {
        border-color: color-mix(in srgb, #ef4444 70%, var(--border));
        background: linear-gradient(
          135deg,
          color-mix(in srgb, #ef4444 34%, transparent),
          color-mix(in srgb, #fb7185 22%, transparent)
        );
        color: color-mix(in srgb, var(--text) 88%, #7f1d1d 12%);
      }
      .attendance-count-badge.is-present {
        border-color: color-mix(in srgb, #0ea5e9 64%, var(--border));
        background: linear-gradient(
          135deg,
          color-mix(in srgb, #0ea5e9 30%, transparent),
          color-mix(in srgb, #10b981 22%, transparent)
        );
        color: color-mix(in srgb, var(--text) 90%, #082f49 10%);
      }
      .attendance-ratio-text {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-size: 10.5px;
        font-weight: 800;
        opacity: 0.92;
        line-height: 1.6;
      }
      .attendance-ratio-text .attendance-num {
        font-family: var(--font-attendance-num);
        font-size: 11px;
        font-weight: 950;
        font-variant-numeric: tabular-nums;
        font-feature-settings:
          "tnum" 1,
          "lnum" 1;
        letter-spacing: 0.02em;
        direction: ltr;
        unicode-bidi: isolate;
        padding: 1px 7px;
        border-radius: 999px;
        border: 1px solid color-mix(in srgb, var(--border) 74%, transparent);
        background: color-mix(in srgb, var(--card-bg) 82%, transparent);
        line-height: 1.4;
      }
      .attendance-ratio-line {
        position: relative;
        isolation: isolate;
        direction: ltr;
        margin-top: 6px;
        width: 100%;
        height: 7px;
        border-radius: 999px;
        border: 1px solid color-mix(in srgb, var(--border) 72%, transparent);
        background: color-mix(in srgb, var(--bg) 42%, transparent);
        overflow: hidden;
      }
      .attendance-ratio-line > span {
        display: block;
        height: 100%;
        border-radius: inherit;
        min-width: 0%;
        max-width: 100%;
        width: var(--attendance-ratio, 0%);
        background: linear-gradient(
          90deg,
          #22c55e 0%,
          #06b6d4 55%,
          #60a5fa 100%
        );
        box-shadow: 0 0 12px rgba(14, 165, 233, 0.28);
        transition: width 420ms cubic-bezier(0.22, 1, 0.36, 1);
      }
      .attendance-actions {
        margin-top: 9px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        flex-wrap: wrap;
      }
      .attendance-meta-badges {
        margin-top: 8px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        flex-wrap: wrap;
      }
      .attendance-action-btn {
        min-height: 31px;
        border-radius: 999px;
        border: 1px solid color-mix(in srgb, var(--border) 70%, transparent);
        background: color-mix(in srgb, var(--card-bg) 84%, transparent);
        color: color-mix(in srgb, var(--text) 94%, #fff 6%);
        padding: 0 11px;
        font-size: 10px;
        font-weight: 900;
        transition:
          filter 0.18s ease,
          transform 0.14s ease,
          border-color 0.18s ease;
      }
      .attendance-action-btn:hover {
        transform: translateY(-1px);
        filter: brightness(1.07);
      }
      .attendance-action-btn:disabled {
        opacity: 0.55;
        cursor: not-allowed;
        transform: none !important;
      }
      .attendance-action-btn.is-active {
        border-color: color-mix(in srgb, var(--accent2) 60%, var(--border));
        box-shadow:
          0 9px 18px rgba(2, 6, 23, 0.22),
          inset 0 1px 0 rgba(255, 255, 255, 0.22);
      }
      .attendance-action-btn.action-present.is-active {
        background: linear-gradient(
          132deg,
          rgba(16, 185, 129, 0.34),
          rgba(14, 165, 233, 0.24)
        );
      }
      .attendance-action-btn.action-absent.is-active {
        background: linear-gradient(
          132deg,
          rgba(239, 68, 68, 0.32),
          rgba(251, 113, 133, 0.24)
        );
      }
      .attendance-action-btn.action-clear {
        border-style: dashed;
      }
      .attendance-warning {
        margin-top: 7px;
        border-radius: 12px;
        padding: 5px 8px;
        font-size: 10px;
        line-height: 1.65;
        border: 1px dashed rgba(245, 158, 11, 0.52);
        background: rgba(245, 158, 11, 0.14);
        color: #fde68a;
      }
      .attendance-empty {
        border-radius: 14px;
        border: 1px dashed color-mix(in srgb, var(--border) 76%, transparent);
        padding: 10px;
        font-size: 11px;
        font-weight: 800;
        opacity: 0.9;
        text-align: center;
      }
      .attendance-settings-modal {
        width: min(860px, calc(100vw - 20px));
        max-height: min(88vh, 860px);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .attendance-settings-head {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 8px;
      }
      .attendance-settings-stats {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 6px;
        margin-bottom: 10px;
      }
      .attendance-settings-chip {
        border-radius: 12px;
        padding: 6px 8px;
        font-size: 10px;
        font-weight: 900;
        border: 1px solid color-mix(in srgb, var(--border) 76%, transparent);
        background: color-mix(in srgb, var(--card-bg) 82%, transparent);
      }
      .attendance-settings-chip .attendance-num {
        font-size: 10.5px;
      }
      .attendance-settings-form {
        min-height: 0;
        flex: 1 1 auto;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .attendance-settings-scroll {
        min-height: 0;
        flex: 1 1 auto;
        overflow-y: auto;
        overflow-x: hidden;
        padding-inline-end: 2px;
      }
      .attendance-settings-scroll::-webkit-scrollbar {
        width: 8px;
      }
      .attendance-settings-scroll::-webkit-scrollbar-track {
        border-radius: 999px;
        background: color-mix(in srgb, var(--bg) 24%, transparent);
      }
      .attendance-settings-scroll::-webkit-scrollbar-thumb {
        border-radius: 999px;
        border: 2px solid transparent;
        background: linear-gradient(180deg, var(--accent), var(--accent2));
        background-clip: padding-box;
      }
      .attendance-settings-inline {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .attendance-settings-inline .inp {
        flex: 1 1 auto;
      }
      .attendance-settings-two-col {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 8px;
      }
      .attendance-settings-advanced {
        border-radius: 14px;
        border: 1px solid color-mix(in srgb, var(--border) 78%, transparent);
        background: color-mix(in srgb, var(--card-bg) 76%, transparent);
        overflow: hidden;
      }
      .attendance-settings-advanced > summary {
        list-style: none;
        cursor: pointer;
        user-select: none;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        padding: 9px 10px;
        font-size: 11px;
        font-weight: 900;
        border-bottom: 1px solid transparent;
      }
      .attendance-settings-advanced > summary::-webkit-details-marker {
        display: none;
      }
      .attendance-settings-advanced[open] > summary {
        border-bottom-color: color-mix(in srgb, var(--border) 74%, transparent);
      }
      .attendance-settings-adv-meta {
        border-radius: 999px;
        padding: 2px 8px;
        border: 1px solid color-mix(in srgb, var(--accent2) 36%, var(--border));
        background: color-mix(in srgb, var(--card-bg) 84%, transparent);
        font-size: 10px;
        font-family: var(--font-attendance-num);
        direction: ltr;
        unicode-bidi: isolate;
      }
      .attendance-settings-advanced-body {
        padding: 8px 10px 10px;
        display: grid;
        gap: 8px;
      }
      .attendance-settings-tools {
        display: grid;
        grid-template-columns: minmax(0, 1fr) auto;
        gap: 8px;
        align-items: center;
      }
      .attendance-settings-tools .attendance-settings-quick {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 6px;
      }
      .attendance-settings-tools .attendance-settings-quick button {
        min-height: 34px;
      }
      .attendance-settings-tools button,
      .attendance-settings-footer button,
      .attendance-settings-advanced > summary {
        touch-action: manipulation;
      }
      .attendance-settings-limit-list {
        max-height: min(34vh, 280px);
        overflow-y: auto;
        padding-inline-end: 2px;
      }
      .attendance-settings-limit-list::-webkit-scrollbar {
        width: 7px;
      }
      .att-course-limit-row {
        contain: layout paint;
      }
      .attendance-settings-footer {
        border-top: 1px solid color-mix(in srgb, var(--border) 80%, transparent);
        padding-top: 8px;
        display: grid;
        grid-template-columns: minmax(0, 1fr) auto auto;
        gap: 8px;
        background: linear-gradient(
          180deg,
          color-mix(in srgb, var(--card-bg) 24%, transparent),
          color-mix(in srgb, var(--card-bg) 82%, transparent) 32%
        );
      }
      .attendance-settings-footer button {
        min-height: 38px;
      }
      body[data-ui-mode="mobile"] .attendance-settings-modal {
        width: 100%;
        max-height: calc(
          var(--app-vh) - env(safe-area-inset-top) -
            env(safe-area-inset-bottom) - 10px
        );
        padding: 10px !important;
        border-radius: 16px !important;
      }
      body[data-ui-mode="mobile"] .attendance-settings-head h3 {
        font-size: 1rem;
      }
      body[data-ui-mode="mobile"] .attendance-settings-stats {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      body[data-ui-mode="mobile"] .attendance-settings-inline {
        flex-direction: column;
        align-items: stretch;
      }
      body[data-ui-mode="mobile"] .attendance-settings-two-col {
        grid-template-columns: 1fr;
      }
      body[data-ui-mode="mobile"] .attendance-settings-tools {
        grid-template-columns: 1fr;
      }
      body[data-ui-mode="mobile"]
        .attendance-settings-tools
        .attendance-settings-quick {
        grid-template-columns: 1fr;
      }
      body[data-ui-mode="mobile"] .att-course-limit-row {
        align-items: flex-start;
      }
      body[data-ui-mode="mobile"] .att-course-limit-row .att-course-limit {
        width: 84px !important;
        min-width: 84px !important;
      }
      body[data-ui-mode="mobile"] .attendance-settings-footer {
        grid-template-columns: 1fr;
        position: sticky;
        bottom: 0;
        padding-bottom: calc(2px + env(safe-area-inset-bottom));
      }
      body[data-ui-mode="mobile"] .attendance-settings-footer button {
        width: 100%;
      }
      @media (max-width: 1024px) {
        body[data-ui-mode="auto"] .attendance-settings-modal {
          width: 100%;
          max-height: calc(
            var(--app-vh) - env(safe-area-inset-top) -
              env(safe-area-inset-bottom) - 10px
          );
          padding: 10px !important;
          border-radius: 16px !important;
        }
        body[data-ui-mode="auto"] .attendance-settings-head h3 {
          font-size: 1rem;
        }
        body[data-ui-mode="auto"] .attendance-settings-stats {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
        body[data-ui-mode="auto"] .attendance-settings-inline {
          flex-direction: column;
          align-items: stretch;
        }
        body[data-ui-mode="auto"] .attendance-settings-two-col {
          grid-template-columns: 1fr;
        }
        body[data-ui-mode="auto"] .attendance-settings-tools {
          grid-template-columns: 1fr;
        }
        body[data-ui-mode="auto"]
          .attendance-settings-tools
          .attendance-settings-quick {
          grid-template-columns: 1fr;
        }
        body[data-ui-mode="auto"] .att-course-limit-row {
          align-items: flex-start;
        }
        body[data-ui-mode="auto"] .att-course-limit-row .att-course-limit {
          width: 84px !important;
          min-width: 84px !important;
        }
        body[data-ui-mode="auto"] .attendance-settings-footer {
          grid-template-columns: 1fr;
          position: sticky;
          bottom: 0;
          padding-bottom: calc(2px + env(safe-area-inset-bottom));
        }
        body[data-ui-mode="auto"] .attendance-settings-footer button {
          width: 100%;
        }
      }

      .badge {
        padding: 3px 10px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 900;
        white-space: nowrap;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .badge-odd {
        background: rgba(254, 240, 138, 0.95);
        color: #854d0e;
        border-color: rgba(133, 77, 14, 0.25);
      }
      .badge-even {
        background: rgba(219, 234, 254, 0.95);
        color: #1e40af;
        border-color: rgba(30, 64, 175, 0.25);
      }
      .badge-normal {
        background: rgba(128, 128, 128, 0.16);
        color: var(--text);
        border-color: rgba(255, 255, 255, 0.1);
      }
      .badge-alert {
        background: rgba(254, 226, 226, 0.96);
        color: #b91c1c;
        border-color: rgba(185, 28, 28, 0.25);
      }
      .notify-perm-btn {
        width: 32px;
        height: 32px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: color-mix(in srgb, var(--card-bg) 78%, transparent);
        color: var(--text);
        transition:
          transform 0.15s ease,
          filter 0.2s ease,
          border-color 0.2s ease;
      }
      .notify-perm-btn:hover {
        filter: brightness(1.08);
        transform: translateY(-1px);
      }
      .notify-perm-btn[data-state="granted"] {
        border-color: rgba(16, 185, 129, 0.65);
        box-shadow:
          0 0 0 1px rgba(16, 185, 129, 0.2) inset,
          0 6px 16px rgba(16, 185, 129, 0.2);
      }
      .notify-perm-btn[data-state="denied"] {
        border-color: rgba(239, 68, 68, 0.62);
        color: #ef4444;
      }
      .notify-perm-btn[data-state="unsupported"] {
        opacity: 0.55;
        cursor: not-allowed;
      }
      .notify-perm-btn[data-state="partial"] {
        border-color: rgba(245, 158, 11, 0.62);
        color: #f59e0b;
      }
      .notify-bell-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        min-height: 38px;
        padding: 0 11px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: color-mix(in srgb, var(--card-bg) 84%, transparent);
        color: var(--text);
        font-size: 11px;
        font-weight: 900;
        transition:
          transform 0.16s ease,
          filter 0.2s ease,
          border-color 0.2s ease;
      }
      .notify-bell-btn:hover {
        transform: translateY(-1px);
        filter: brightness(1.07);
      }
      .notify-bell-dot {
        width: 9px;
        height: 9px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.25);
        background: #64748b;
        box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.08) inset;
      }
      .notify-bell-btn[data-state="on"] {
        border-color: rgba(16, 185, 129, 0.66);
        box-shadow:
          0 0 0 1px rgba(16, 185, 129, 0.16) inset,
          0 8px 20px rgba(16, 185, 129, 0.2);
      }
      .notify-bell-btn[data-state="on"] .notify-bell-dot {
        background: #10b981;
        box-shadow:
          0 0 10px rgba(16, 185, 129, 0.65),
          0 0 0 1px rgba(0, 0, 0, 0.08) inset;
      }
      .notify-bell-btn[data-state="off"] {
        border-color: rgba(239, 68, 68, 0.58);
      }
      .notify-bell-btn[data-state="off"] .notify-bell-dot,
      .notify-bell-btn[data-state="blocked"] .notify-bell-dot {
        background: #ef4444;
      }
      .notify-bell-btn[data-state="partial"] {
        border-color: rgba(245, 158, 11, 0.62);
      }
      .notify-bell-btn[data-state="partial"] .notify-bell-dot {
        background: #f59e0b;
      }
      .notify-bell-btn[data-state="unsupported"] {
        opacity: 0.72;
      }
      .notify-bell-state {
        white-space: nowrap;
      }
      .notify-status-hint {
        width: 100%;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        border-radius: 13px;
        border: 1px solid var(--border);
        background: color-mix(in srgb, var(--card-bg) 72%, transparent);
        padding: 7px 10px;
        font-size: 11px;
        font-weight: 800;
        color: var(--text);
        text-align: right;
        transition:
          border-color 0.18s ease,
          filter 0.18s ease,
          transform 0.16s ease;
      }
      .notify-status-hint:hover {
        filter: brightness(1.07);
        transform: translateY(-1px);
      }
      .notify-status-title {
        white-space: nowrap;
      }
      .notify-status-detail {
        opacity: 0.82;
        font-size: 10px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 66%;
      }
      .notify-status-hint[data-state="on"] {
        border-color: rgba(16, 185, 129, 0.58);
        background: linear-gradient(
          145deg,
          rgba(16, 185, 129, 0.2),
          color-mix(in srgb, var(--card-bg) 76%, transparent) 42%,
          rgba(16, 185, 129, 0.1)
        );
        box-shadow:
          0 10px 20px rgba(16, 185, 129, 0.16),
          inset 0 1px 0 rgba(255, 255, 255, 0.2);
      }
      .notify-status-hint[data-state="off"],
      .notify-status-hint[data-state="blocked"] {
        border-color: rgba(239, 68, 68, 0.58);
      }
      .notify-status-hint[data-state="partial"] {
        border-color: rgba(245, 158, 11, 0.62);
      }
      .notify-status-hint[data-state="unsupported"] {
        opacity: 0.74;
      }
      .notify-connect-panel {
        position: relative;
        border: 1px solid color-mix(in srgb, var(--border) 84%, transparent);
        border-radius: 16px;
        padding: 10px;
        margin-bottom: 10px;
        max-height: min(46vh, 320px);
        overflow-y: auto;
        overflow-x: hidden;
        overscroll-behavior: contain;
        scrollbar-gutter: stable both-edges;
        -webkit-overflow-scrolling: touch;
        background: linear-gradient(
          135deg,
          color-mix(in srgb, var(--accent) 14%, transparent),
          color-mix(in srgb, var(--card-bg) 84%, transparent) 34%,
          color-mix(in srgb, var(--accent2) 12%, transparent)
        );
        box-shadow:
          0 12px 24px rgba(0, 0, 0, 0.2),
          inset 0 1px 0 rgba(255, 255, 255, 0.16);
        transition:
          max-height 0.3s ease,
          opacity 0.24s ease,
          transform 0.24s ease,
          margin 0.24s ease,
          padding 0.24s ease,
          border-color 0.24s ease,
          box-shadow 0.24s ease;
        transform-origin: top center;
      }
      .notify-connect-panel::before {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: inherit;
        pointer-events: none;
        background: linear-gradient(
          118deg,
          transparent 12%,
          color-mix(in srgb, var(--accent2) 20%, transparent) 48%,
          transparent 84%
        );
        opacity: 0.36;
      }
      .notify-connect-panel.notify-connect-panel--hidden {
        max-height: 0 !important;
        opacity: 0;
        transform: translateY(-5px) scaleY(0.97);
        margin-bottom: 0;
        padding-top: 0;
        padding-bottom: 0;
        border-color: transparent;
        box-shadow: none;
        overflow: hidden;
        pointer-events: none;
      }
      .notify-connect-panel::-webkit-scrollbar {
        width: 9px;
      }
      .notify-connect-panel::-webkit-scrollbar-track {
        border-radius: 999px;
        background: color-mix(in srgb, var(--bg) 26%, transparent);
      }
      .notify-connect-panel::-webkit-scrollbar-thumb {
        border-radius: 999px;
        border: 2px solid transparent;
        background: linear-gradient(180deg, var(--accent), var(--accent2));
        background-clip: padding-box;
      }
      .notify-connect-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        margin-bottom: 8px;
      }
      .notify-connect-state {
        display: inline-flex;
        align-items: center;
        gap: 7px;
        font-size: 11px;
        font-weight: 900;
      }
      .notify-connect-dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: #64748b;
        box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.22);
      }
      .notify-connect-state[data-state="on"] .notify-connect-dot {
        background: #10b981;
        box-shadow:
          0 0 10px rgba(16, 185, 129, 0.6),
          0 0 0 1px rgba(255, 255, 255, 0.2);
      }
      .notify-connect-state[data-state="partial"] .notify-connect-dot {
        background: #f59e0b;
      }
      .notify-connect-state[data-state="off"],
      .notify-connect-state[data-state="blocked"] {
        color: #ef4444;
      }
      .notify-connect-state[data-state="off"] .notify-connect-dot,
      .notify-connect-state[data-state="blocked"] .notify-connect-dot {
        background: #ef4444;
      }
      .notify-connect-state[data-state="unsupported"] {
        opacity: 0.72;
      }
      .notify-connect-meta {
        font-size: 10px;
        opacity: 0.72;
        text-align: left;
        white-space: nowrap;
      }
      .notify-sw-explain {
        margin-bottom: 8px;
        border-radius: 11px;
        border: 1px dashed color-mix(in srgb, var(--accent2) 36%, var(--border));
        background: color-mix(in srgb, var(--bg) 20%, transparent);
        padding: 7px 9px;
        font-size: 10px;
        line-height: 1.62;
        opacity: 0.9;
        white-space: pre-line;
      }
      .notify-checklist {
        display: grid;
        gap: 7px;
      }
      .notify-check-item {
        display: grid;
        grid-template-columns: 18px 1fr;
        gap: 8px;
        align-items: start;
        border-radius: 11px;
        border: 1px solid color-mix(in srgb, var(--border) 76%, transparent);
        background: color-mix(in srgb, var(--bg) 22%, transparent);
        padding: 6px 8px;
        min-height: 36px;
      }
      .notify-check-item__icon {
        width: 18px;
        height: 18px;
        border-radius: 999px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        line-height: 1;
        font-weight: 900;
      }
      .notify-check-item__text {
        min-width: 0;
      }
      .notify-check-item__title {
        display: block;
        font-size: 10px;
        font-weight: 900;
        opacity: 0.82;
      }
      .notify-check-item__desc {
        display: block;
        margin-top: 1px;
        font-size: 10px;
        line-height: 1.5;
        opacity: 0.9;
      }
      .notify-check-item.is-ok {
        border-color: rgba(16, 185, 129, 0.48);
      }
      .notify-check-item.is-ok .notify-check-item__icon {
        color: #065f46;
        background: rgba(16, 185, 129, 0.3);
      }
      .notify-check-item.is-warn {
        border-color: rgba(245, 158, 11, 0.48);
      }
      .notify-check-item.is-warn .notify-check-item__icon {
        color: #78350f;
        background: rgba(245, 158, 11, 0.34);
      }
      .notify-check-item.is-bad {
        border-color: rgba(239, 68, 68, 0.48);
      }
      .notify-check-item.is-bad .notify-check-item__icon {
        color: #7f1d1d;
        background: rgba(239, 68, 68, 0.34);
      }
      .notify-guide-modal {
        width: min(920px, calc(100vw - 22px));
        max-height: min(84vh, 860px);
        border-radius: 24px;
        border: 1px solid color-mix(in srgb, var(--accent2) 42%, var(--border));
        background:
          radial-gradient(
            860px 160px at 8% -12%,
            color-mix(in srgb, var(--accent) 18%, transparent),
            transparent 68%
          ),
          color-mix(in srgb, var(--card-bg) 92%, transparent);
        box-shadow:
          0 28px 76px rgba(0, 0, 0, 0.42),
          inset 0 1px 0 rgba(255, 255, 255, 0.22);
      }
      .notify-guide-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 10px;
      }
      .notify-guide-state {
        border-radius: 999px;
        padding: 5px 10px;
        font-size: 11px;
        font-weight: 900;
        border: 1px solid color-mix(in srgb, var(--accent2) 48%, var(--border));
        background: color-mix(in srgb, var(--accent2) 14%, transparent);
        white-space: nowrap;
      }
      .notify-guide-scroll {
        max-height: min(62vh, 600px);
        overflow-y: auto;
        padding-inline-end: 6px;
        display: grid;
        gap: 10px;
      }
      .notify-guide-scroll::-webkit-scrollbar {
        width: 10px;
      }
      .notify-guide-scroll::-webkit-scrollbar-track {
        border-radius: 999px;
        background: color-mix(in srgb, var(--bg) 26%, transparent);
      }
      .notify-guide-scroll::-webkit-scrollbar-thumb {
        border-radius: 999px;
        border: 2px solid transparent;
        background: linear-gradient(180deg, var(--accent), var(--accent2));
        background-clip: padding-box;
      }
      .notify-guide-block {
        border-radius: 15px;
        border: 1px solid color-mix(in srgb, var(--border) 82%, transparent);
        background: color-mix(in srgb, var(--bg) 24%, transparent);
        padding: 10px 11px;
      }
      .notify-guide-block h4 {
        margin: 0 0 6px;
        font-size: 12px;
        font-weight: 900;
        letter-spacing: 0.01em;
      }
      .notify-guide-pre {
        margin: 0;
        white-space: pre-wrap;
        word-break: break-word;
        line-height: 1.75;
        font-size: 12px;
        font-family: var(--font-fa);
        color: color-mix(in srgb, var(--text) 92%, #ffffff 8%);
      }
      .notify-guide-actions {
        margin-top: 12px;
        padding-top: 10px;
        border-top: 1px solid color-mix(in srgb, var(--border) 84%, transparent);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 8px;
      }
      .notify-guide-actions-group {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .notify-guide-actions .notify-action-btn {
        min-height: 36px;
        padding-inline: 12px;
        font-size: 11px;
      }
      .notify-guide-actions .notify-action-btn:disabled {
        opacity: 0.52;
        cursor: not-allowed;
        filter: saturate(0.72);
      }
      .notify-connect-actions {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 7px;
        margin-top: 8px;
      }
      .notify-action-btn {
        min-height: 34px;
        border-radius: 11px;
        border: 1px solid var(--border);
        background: color-mix(in srgb, var(--card-bg) 84%, transparent);
        color: var(--text);
        font-size: 10px;
        font-weight: 900;
        transition:
          border-color 0.18s ease,
          transform 0.15s ease,
          filter 0.18s ease;
      }
      .notify-action-btn:hover {
        transform: translateY(-1px);
        filter: brightness(1.06);
      }
      .notify-action-btn--fix {
        border-color: rgba(14, 165, 233, 0.5);
        background: linear-gradient(
          140deg,
          rgba(14, 165, 233, 0.28),
          rgba(14, 165, 233, 0.12)
        );
      }
      .notify-action-btn--test {
        border-color: rgba(16, 185, 129, 0.52);
        background: linear-gradient(
          140deg,
          rgba(16, 185, 129, 0.28),
          rgba(16, 185, 129, 0.11)
        );
      }
      .notify-action-btn--guide {
        border-color: rgba(245, 158, 11, 0.52);
        background: linear-gradient(
          140deg,
          rgba(245, 158, 11, 0.28),
          rgba(245, 158, 11, 0.12)
        );
      }
      .notify-widget-focus {
        animation: notifyWidgetFocus 1.25s ease;
      }
      @keyframes notifyWidgetFocus {
        0% {
          box-shadow:
            0 0 0 0 rgba(14, 165, 233, 0.55),
            0 0 0 1px rgba(14, 165, 233, 0.45) inset;
        }
        100% {
          box-shadow:
            0 0 0 26px rgba(14, 165, 233, 0),
            0 0 0 1px rgba(14, 165, 233, 0) inset;
        }
      }

      .anim-status-btn {
        min-width: 0;
        width: auto;
        height: 42px;
        padding: 0 12px;
        gap: 8px;
        display: inline-flex;
        align-items: center;
        justify-content: flex-start;
        border-radius: 14px;
        border: 1px solid var(--border);
        background: color-mix(in srgb, var(--card-bg) 82%, transparent);
        color: var(--text);
        transition:
          transform 0.16s ease,
          filter 0.2s ease,
          border-color 0.2s ease,
          box-shadow 0.2s ease;
      }
      .anim-status-btn:hover {
        transform: translateY(-1px);
        filter: brightness(1.06);
      }
      .anim-status-visual {
        position: relative;
        width: 18px;
        height: 18px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      .anim-status-short {
        display: inline-block;
        min-width: 0;
        font-size: 11px;
        font-weight: 900;
        letter-spacing: 0.015em;
        white-space: nowrap;
        color: color-mix(in srgb, var(--text) 86%, var(--muted));
      }
      .anim-status-ring {
        position: absolute;
        inset: 1px;
        border-radius: 999px;
        border: 2px solid color-mix(in srgb, var(--accent2) 70%, var(--border));
      }
      .anim-status-core {
        width: 6px;
        height: 6px;
        border-radius: 999px;
        background: color-mix(in srgb, var(--accent) 88%, #ffffff 12%);
        box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.08) inset;
      }
      .anim-status-orbit {
        position: absolute;
        inset: 0;
        transform-origin: 50% 50%;
      }
      .anim-status-dot {
        position: absolute;
        left: 50%;
        width: 5px;
        height: 5px;
        border-radius: 999px;
        margin-left: -2.5px;
      }
      .anim-status-dot--a {
        top: -1px;
        background: color-mix(in srgb, var(--accent) 92%, #ffffff 8%);
      }
      .anim-status-dot--b {
        bottom: -1px;
        background: color-mix(in srgb, var(--accent2) 88%, #ffffff 12%);
      }
      .anim-status-btn[data-state="on"] {
        border-color: rgba(16, 185, 129, 0.66);
        box-shadow:
          0 0 0 1px rgba(16, 185, 129, 0.16) inset,
          0 8px 20px rgba(16, 185, 129, 0.2);
      }
      .anim-status-btn[data-state="on"] .anim-status-orbit {
        animation: animStatusSpin 1.25s linear infinite;
      }
      .anim-status-btn[data-state="on"] .anim-status-core {
        box-shadow:
          0 0 12px rgba(16, 185, 129, 0.62),
          0 0 0 1px rgba(0, 0, 0, 0.08) inset;
      }
      .anim-status-btn[data-state="on"] .anim-status-short {
        color: color-mix(in srgb, #10b981 72%, var(--text));
      }
      .anim-status-btn[data-state="off"] {
        border-color: rgba(239, 68, 68, 0.58);
      }
      .anim-status-btn[data-state="off"] .anim-status-orbit {
        animation: none;
        opacity: 0.74;
      }
      .anim-status-btn[data-state="off"] .anim-status-core {
        background: #ef4444;
        box-shadow:
          0 0 0 1px rgba(0, 0, 0, 0.08) inset,
          0 0 8px rgba(239, 68, 68, 0.46);
      }
      .anim-status-btn[data-state="off"] .anim-status-short {
        color: color-mix(in srgb, #ef4444 68%, var(--text));
      }
      @keyframes animStatusSpin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      .top-nav {
        position: sticky;
        overflow: hidden;
        border: 1px solid color-mix(in srgb, var(--border) 86%, transparent);
        border-radius: 24px;
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        box-shadow:
          0 16px 42px rgba(0, 0, 0, 0.26),
          inset 0 1px 0 rgba(255, 255, 255, 0.16);
      }
      .top-nav.theme-card::before {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        background:
          radial-gradient(
            860px 140px at 8% -14%,
            color-mix(in srgb, var(--accent) 16%, transparent),
            transparent 72%
          ),
          radial-gradient(
            920px 150px at 94% 120%,
            color-mix(in srgb, var(--accent2) 14%, transparent),
            transparent 72%
          );
        opacity: 0.84;
      }
      .top-nav.theme-card::after {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        border-radius: inherit;
        border: 1px solid color-mix(in srgb, var(--accent2) 24%, transparent);
      }
      .top-nav > * {
        position: relative;
        z-index: 1;
      }
      .nav-brand {
        position: relative;
        isolation: isolate;
        display: inline-flex;
        align-items: center;
        gap: 12px;
        border-radius: 20px;
        padding: 7px 12px 7px 8px;
        border: 1px solid color-mix(in srgb, var(--accent2) 34%, var(--border));
        background:
          radial-gradient(
            520px 110px at 0% -10%,
            color-mix(in srgb, var(--accent) 20%, transparent),
            transparent 72%
          ),
          linear-gradient(
            150deg,
            color-mix(in srgb, var(--bg) 30%, transparent),
            color-mix(in srgb, var(--card-bg) 78%, transparent)
          );
        box-shadow:
          0 12px 28px rgba(0, 0, 0, 0.2),
          inset 0 1px 0 rgba(255, 255, 255, 0.22);
        overflow: hidden;
      }
      .nav-brand::before {
        content: "";
        position: absolute;
        inset: -1px;
        pointer-events: none;
        z-index: 0;
        background: linear-gradient(
          118deg,
          transparent 12%,
          rgba(255, 255, 255, 0.32) 45%,
          transparent 76%
        );
        transform: translateX(-145%);
        animation: navBrandSheen 9.4s ease-in-out infinite;
      }
      .nav-brand::after {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        z-index: 0;
        border-radius: inherit;
        border: 1px solid color-mix(in srgb, var(--accent2) 26%, transparent);
      }
      .nav-brand > * {
        position: relative;
        z-index: 1;
      }
      @keyframes navBrandSheen {
        0%,
        100% {
          transform: translateX(-145%);
        }
        45% {
          transform: translateX(185%);
        }
      }
      .nav-title-block {
        min-width: 0;
        display: grid;
        align-content: center;
      }
      .nav-title-text {
        margin: 0;
        line-height: 1.15;
        letter-spacing: 0.018em;
        text-shadow:
          0 1px 0 rgba(0, 0, 0, 0.22),
          0 0 18px color-mix(in srgb, var(--accent2) 20%, transparent);
      }
      .nav-sub-text {
        margin: 3px 0 0;
        opacity: 0.84;
        font-weight: 900;
        letter-spacing: 0.016em;
      }

      .top-nav .week-toggle {
        border-color: color-mix(in srgb, var(--accent2) 38%, var(--border));
        background:
          radial-gradient(
            420px 110px at 12% -10%,
            color-mix(in srgb, var(--accent2) 12%, transparent),
            transparent 72%
          ),
          color-mix(in srgb, var(--bg) 30%, transparent);
        box-shadow:
          0 12px 22px rgba(0, 0, 0, 0.2),
          inset 0 1px 0 rgba(255, 255, 255, 0.15);
      }
      .top-nav .week-toggle button {
        min-width: 78px;
      }
      .top-nav .control-surface,
      .top-nav .control-btn:not(.danger-btn),
      .top-nav .notify-bell-btn {
        border-color: color-mix(in srgb, var(--accent2) 34%, var(--border));
        background:
          radial-gradient(
            360px 100px at 10% -10%,
            color-mix(in srgb, var(--accent) 10%, transparent),
            transparent 70%
          ),
          linear-gradient(
            150deg,
            color-mix(in srgb, var(--card-bg) 90%, transparent),
            color-mix(in srgb, var(--card-bg) 72%, transparent)
          );
        box-shadow:
          0 10px 22px rgba(0, 0, 0, 0.2),
          inset 0 1px 0 rgba(255, 255, 255, 0.16);
      }
      .top-nav .control-surface:hover,
      .top-nav .control-btn:not(.danger-btn):hover,
      .top-nav .notify-bell-btn:hover,
      .top-nav .week-toggle button:hover {
        border-color: color-mix(in srgb, var(--accent2) 54%, var(--border));
        filter: brightness(1.08) saturate(1.04);
      }
      .top-nav .control-btn svg,
      .top-nav .notify-bell-btn svg {
        filter: drop-shadow(0 2px 6px rgba(2, 6, 23, 0.34));
        transition:
          transform 0.16s ease,
          filter 0.16s ease;
      }
      .top-nav .control-btn:not(.danger-btn):hover svg,
      .top-nav .notify-bell-btn:hover svg {
        transform: translateY(-1px) scale(1.07);
        filter: drop-shadow(0 4px 10px rgba(2, 6, 23, 0.46));
      }
      .top-nav .danger-btn svg {
        filter: none;
      }
      .premium-select {
        position: relative;
        display: inline-flex;
        align-items: stretch;
        min-width: 0;
        isolation: isolate;
        z-index: 0;
      }
      .premium-select-input {
        position: relative;
        z-index: 1;
        width: 100%;
        min-height: 42px;
        padding-inline-start: 46px !important;
        padding-inline-end: 30px !important;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: none;
        color: color-mix(in srgb, var(--text) 96%, #ffffff 4%);
        font-weight: 900;
        line-height: 1.25;
        letter-spacing: 0.012em;
        text-shadow: none;
        text-rendering: geometricPrecision;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        transition:
          border-color 0.22s ease,
          box-shadow 0.22s ease,
          filter 0.22s ease,
          color 0.22s ease,
          background-color 0.22s ease;
      }
      .premium-select-input:focus-visible {
        border-color: color-mix(in srgb, var(--accent2) 66%, var(--border));
        box-shadow:
          0 0 0 1px color-mix(in srgb, var(--accent2) 42%, transparent),
          0 8px 18px color-mix(in srgb, var(--accent2) 22%, transparent),
          inset 0 1px 0 rgba(255, 255, 255, 0.2);
        filter: brightness(1.03);
      }
      .premium-select-input option,
      .premium-select-input optgroup {
        background: color-mix(in srgb, var(--bg) 92%, #020617 8%);
        color: color-mix(in srgb, var(--text) 98%, #ffffff 2%);
        font-family: var(--font-fa);
        font-weight: 800;
        letter-spacing: 0.01em;
        text-shadow: none;
      }
      #themeSelectShell .premium-select-input,
      #packSelectShell .premium-select-input {
        background: linear-gradient(
          158deg,
          color-mix(in srgb, var(--card-bg) 94%, rgba(255, 255, 255, 0.04)),
          color-mix(in srgb, var(--bg) 76%, rgba(255, 255, 255, 0.02))
        ) !important;
        border-color: color-mix(
          in srgb,
          var(--accent2) 44%,
          var(--border)
        ) !important;
        box-shadow:
          inset 0 1px 0 rgba(255, 255, 255, 0.19),
          0 5px 14px rgba(2, 6, 23, 0.22);
      }
      .premium-select-icon {
        position: absolute;
        inset-inline-start: 8px;
        top: 50%;
        transform: translateY(-50%);
        width: 26px;
        height: 26px;
        border-radius: 9px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        pointer-events: none;
        z-index: 2;
        color: color-mix(in srgb, var(--accent2) 62%, var(--text));
        background:
          radial-gradient(
            14px 14px at 24% 22%,
            rgba(255, 255, 255, 0.34),
            transparent 72%
          ),
          linear-gradient(
            150deg,
            color-mix(in srgb, var(--card-bg) 84%, transparent),
            color-mix(in srgb, var(--card-bg) 58%, transparent)
          );
        border: 1px solid color-mix(in srgb, var(--accent2) 34%, var(--border));
        box-shadow:
          inset 0 1px 0 rgba(255, 255, 255, 0.2),
          0 6px 14px rgba(2, 6, 23, 0.25);
        overflow: hidden;
        backface-visibility: hidden;
        -webkit-backface-visibility: hidden;
        transform-style: preserve-3d;
      }
      .premium-select-icon::after {
        content: "";
        position: absolute;
        inset: -2px;
        border-radius: inherit;
        border: 1px solid color-mix(in srgb, var(--accent) 18%, transparent);
        opacity: 0.7;
      }
      .premium-icon-stack {
        position: relative;
        width: 16px;
        height: 16px;
        display: block;
      }
      .premium-icon-state {
        position: absolute;
        inset: 0;
        opacity: 0;
        transform: translateY(2px) scale(0.82);
        backface-visibility: hidden;
        -webkit-backface-visibility: hidden;
        transition:
          opacity 0.24s ease,
          transform 0.24s ease;
      }
      #uiModeShell[data-ui-mode="desktop"] .premium-icon-state--desktop,
      #uiModeShell[data-ui-mode="mobile"] .premium-icon-state--mobile,
      #uiModeShell[data-ui-mode="auto"] .premium-icon-state--auto,
      #themeSelectShell .premium-icon-state--theme,
      #packSelectShell[data-pack="base"] .premium-icon-state--base,
      #packSelectShell[data-pack="ultra"] .premium-icon-state--ultra,
      #packSelectShell[data-pack="pro"] .premium-icon-state--pro,
      #animIntensityShell[data-intensity="ultra-low"]
        .premium-icon-state--ultra-low,
      #animIntensityShell[data-intensity="low"] .premium-icon-state--low,
      #animIntensityShell[data-intensity="high"] .premium-icon-state--high {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
      .premium-select-icon svg {
        width: 100%;
        height: 100%;
        display: block;
      }
      .premium-select-icon .pi-stroke {
        fill: none;
        stroke: currentColor;
        stroke-width: 1.75;
        stroke-linecap: round;
        stroke-linejoin: round;
      }
      .premium-select-icon .pi-fill {
        fill: color-mix(in srgb, var(--accent2) 36%, transparent);
        opacity: 0.62;
      }
      .premium-select-icon .pi-dot {
        fill: currentColor;
      }
      .premium-select-icon .pi-bolt {
        fill: currentColor;
        transform-origin: center;
      }
      .premium-select-icon .pi-bar {
        transform-origin: center bottom;
      }
      .premium-select-icon .pi-anim {
        transform-origin: center;
      }
      #themeSelectShell .premium-select-icon {
        color: color-mix(in srgb, var(--accent2) 62%, var(--accent) 38%);
        box-shadow:
          inset 0 1px 0 rgba(255, 255, 255, 0.24),
          0 7px 16px color-mix(in srgb, var(--accent2) 26%, transparent);
      }
      #themeSelectShell .premium-select-input {
        min-width: 136px !important;
        font-family: var(--font-fa);
        font-size: 13.2px;
        font-weight: 900;
        letter-spacing: 0.015em;
      }
      #packSelectShell .premium-select-input {
        min-width: 122px !important;
        padding-inline-start: 43px !important;
        padding-inline-end: 24px !important;
        font-family: var(--font-fa);
        font-size: 13px;
        font-weight: 900;
        letter-spacing: 0.014em;
      }
      #themeSelectShell .pi-theme-core {
        fill: color-mix(in srgb, var(--accent2) 74%, #ffffff 26%);
        opacity: 0.94;
        filter: drop-shadow(
          0 0 4px color-mix(in srgb, var(--accent2) 42%, transparent)
        );
        animation: premiumThemeCorePulse 2s ease-in-out infinite;
      }
      #themeSelectShell .pi-theme-orbit {
        animation: premiumThemeOrbit 5.4s linear infinite;
        opacity: 0.86;
      }
      #themeSelectShell .pi-theme-spark {
        animation: premiumThemeSpark 2.05s ease-in-out infinite;
      }
      #themeSelectShell .pi-theme-sheen {
        animation: premiumThemeSheen 2.2s ease-in-out infinite;
        opacity: 0.74;
      }
      #uiModeShell.ui-mode-icon-picker {
        position: relative;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        min-height: 42px;
        border-radius: 14px;
        border: 1px solid color-mix(in srgb, var(--accent2) 42%, var(--border));
        background:
          radial-gradient(
            54px 28px at 50% -28%,
            color-mix(in srgb, var(--accent2) 20%, transparent),
            transparent 72%
          ),
          color-mix(in srgb, var(--card-bg) 84%, transparent);
        padding: 4px;
        box-shadow:
          inset 0 1px 0 rgba(255, 255, 255, 0.18),
          0 8px 18px rgba(2, 6, 23, 0.24);
        width: auto;
        min-width: 126px;
        isolation: isolate;
      }
      .ui-mode-icon-btn {
        position: relative;
        width: 34px;
        height: 34px;
        border-radius: 10px;
        border: 1px solid color-mix(in srgb, var(--border) 74%, transparent);
        background: linear-gradient(
          145deg,
          color-mix(in srgb, var(--bg) 30%, transparent),
          color-mix(in srgb, var(--bg) 16%, transparent)
        );
        color: color-mix(in srgb, var(--accent2) 42%, var(--text) 58%);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition:
          transform 0.18s ease,
          filter 0.18s ease,
          border-color 0.18s ease,
          box-shadow 0.18s ease;
      }
      .ui-mode-icon-btn::after {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: inherit;
        pointer-events: none;
        background: linear-gradient(
          130deg,
          transparent 14%,
          color-mix(in srgb, var(--accent2) 16%, transparent) 56%,
          transparent 88%
        );
        opacity: 0.56;
      }
      .ui-mode-icon-btn svg {
        width: 18px;
        height: 18px;
        display: block;
      }
      .ui-mode-icon-btn .umi-stroke {
        fill: none;
        stroke: currentColor;
        stroke-width: 1.72;
        stroke-linecap: round;
        stroke-linejoin: round;
      }
      .ui-mode-icon-btn .umi-fill {
        fill: color-mix(in srgb, currentColor 20%, transparent);
        opacity: 0.86;
      }
      .ui-mode-icon-btn .umi-dot {
        fill: currentColor;
      }
      .ui-mode-icon-btn .uii-anim {
        transform-origin: center;
      }
      .ui-mode-icon-btn:hover {
        transform: translateY(-1px);
        filter: brightness(1.08);
        border-color: color-mix(in srgb, var(--accent2) 52%, var(--border));
      }
      #uiModeShell[data-ui-mode="desktop"]
        .ui-mode-icon-btn[data-mode="desktop"],
      #uiModeShell[data-ui-mode="mobile"] .ui-mode-icon-btn[data-mode="mobile"],
      #uiModeShell[data-ui-mode="auto"] .ui-mode-icon-btn[data-mode="auto"] {
        border-color: color-mix(in srgb, var(--accent2) 66%, var(--accent));
        background:
          radial-gradient(
            40px 20px at 50% -14%,
            color-mix(in srgb, var(--accent2) 24%, transparent),
            transparent 76%
          ),
          color-mix(in srgb, var(--bg) 24%, transparent);
        color: color-mix(in srgb, var(--accent2) 74%, #ffffff 26%);
        box-shadow:
          inset 0 1px 0 rgba(255, 255, 255, 0.22),
          0 6px 14px color-mix(in srgb, var(--accent2) 24%, transparent);
      }
      #uiModeShell[data-ui-mode="desktop"]
        .ui-mode-icon-btn[data-mode="desktop"] {
        color: color-mix(in srgb, #60a5fa 76%, #dbeafe 24%);
      }
      #uiModeShell[data-ui-mode="mobile"]
        .ui-mode-icon-btn[data-mode="mobile"] {
        color: color-mix(in srgb, #22d3ee 78%, #a5f3fc 22%);
      }
      #uiModeShell[data-ui-mode="auto"] .ui-mode-icon-btn[data-mode="auto"] {
        color: color-mix(in srgb, var(--accent2) 68%, var(--accent) 32%);
      }
      #uiModeShell[data-ui-mode="desktop"]
        .ui-mode-icon-btn[data-mode="desktop"]
        .umi-scan {
        animation: premiumLaptopScan 2.3s ease-in-out infinite;
      }
      #uiModeShell[data-ui-mode="mobile"]
        .ui-mode-icon-btn[data-mode="mobile"]
        .umi-wave {
        animation: premiumPhoneWave 2.2s ease-in-out infinite;
      }
      #uiModeShell[data-ui-mode="mobile"]
        .ui-mode-icon-btn[data-mode="mobile"]
        .umi-swipe {
        animation: premiumPhoneSwipe 1.8s ease-in-out infinite;
      }
      #uiModeShell[data-ui-mode="auto"]
        .ui-mode-icon-btn[data-mode="auto"]
        .umi-orbit {
        animation: premiumAutoOrbit 4.2s linear infinite;
      }
      #uiModeShell[data-ui-mode="auto"]
        .ui-mode-icon-btn[data-mode="auto"]
        .umi-spark {
        animation: premiumAutoSpark 1.7s ease-in-out infinite;
      }
      #packSelectShell .premium-select-icon {
        color: color-mix(in srgb, var(--accent) 62%, #fbbf24 38%);
      }
      #packSelectShell[data-pack="ultra"] .premium-select-icon {
        color: color-mix(in srgb, #f59e0b 58%, var(--accent2) 42%);
        box-shadow:
          inset 0 1px 0 rgba(255, 255, 255, 0.24),
          0 8px 16px rgba(245, 158, 11, 0.28);
      }
      #packSelectShell[data-pack="pro"] .premium-select-icon {
        color: color-mix(in srgb, #22d3ee 64%, #a78bfa 36%);
        box-shadow:
          inset 0 1px 0 rgba(255, 255, 255, 0.28),
          0 9px 18px rgba(34, 211, 238, 0.24);
      }
      #animIntensityShell.intensity-icon-picker {
        min-width: 126px;
      }
      .intensity-icon-picker {
        position: relative;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        min-height: 42px;
        border-radius: 14px;
        border: 1px solid color-mix(in srgb, var(--accent2) 40%, var(--border));
        background:
          radial-gradient(
            50px 26px at 50% -30%,
            color-mix(in srgb, var(--accent2) 18%, transparent),
            transparent 72%
          ),
          color-mix(in srgb, var(--card-bg) 84%, transparent);
        padding: 4px;
        box-shadow:
          inset 0 1px 0 rgba(255, 255, 255, 0.18),
          0 7px 16px rgba(2, 6, 23, 0.22);
        width: auto;
        min-width: 126px;
        isolation: isolate;
      }
      .intensity-icon-btn {
        position: relative;
        width: 34px;
        height: 34px;
        border-radius: 10px;
        border: 1px solid color-mix(in srgb, var(--border) 74%, transparent);
        background: linear-gradient(
          145deg,
          color-mix(in srgb, var(--bg) 32%, transparent),
          color-mix(in srgb, var(--bg) 18%, transparent)
        );
        color: color-mix(in srgb, var(--accent2) 46%, var(--text) 54%);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition:
          transform 0.18s ease,
          filter 0.18s ease,
          border-color 0.18s ease,
          box-shadow 0.18s ease;
      }
      .intensity-icon-btn::after {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: inherit;
        pointer-events: none;
        background: linear-gradient(
          130deg,
          transparent 14%,
          color-mix(in srgb, var(--accent2) 16%, transparent) 56%,
          transparent 88%
        );
        opacity: 0.58;
      }
      .intensity-icon-btn svg {
        width: 18px;
        height: 18px;
        display: block;
      }
      .intensity-icon-btn .ii-stroke {
        fill: none;
        stroke: currentColor;
        stroke-width: 1.7;
        stroke-linecap: round;
        stroke-linejoin: round;
      }
      .intensity-icon-btn .ii-bolt {
        fill: currentColor;
        transform-origin: center;
      }
      .intensity-icon-btn .ii-dot {
        fill: currentColor;
      }
      .intensity-icon-btn:hover:not(:disabled) {
        transform: translateY(-1px);
        filter: brightness(1.08);
        border-color: color-mix(in srgb, var(--accent2) 52%, var(--border));
      }
      #animIntensityShell[data-intensity="ultra-low"]
        .intensity-icon-btn[data-value="ultra-low"],
      #animIntensityShell[data-intensity="low"]
        .intensity-icon-btn[data-value="low"],
      #animIntensityShell[data-intensity="high"]
        .intensity-icon-btn[data-value="high"] {
        border-color: color-mix(in srgb, var(--accent2) 64%, var(--accent));
        background:
          radial-gradient(
            40px 20px at 50% -14%,
            color-mix(in srgb, var(--accent2) 24%, transparent),
            transparent 76%
          ),
          color-mix(in srgb, var(--bg) 24%, transparent);
        color: color-mix(in srgb, var(--accent2) 72%, #fff 28%);
        box-shadow:
          inset 0 1px 0 rgba(255, 255, 255, 0.22),
          0 6px 14px color-mix(in srgb, var(--accent2) 24%, transparent);
      }
      #animIntensityShell[data-intensity="ultra-low"]
        .intensity-icon-btn[data-value="ultra-low"] {
        color: color-mix(in srgb, #38bdf8 74%, #e0f2fe 26%);
      }
      #animIntensityShell[data-intensity="low"]
        .intensity-icon-btn[data-value="low"] {
        color: color-mix(in srgb, #f59e0b 78%, #fef3c7 22%);
      }
      #animIntensityShell[data-intensity="high"]
        .intensity-icon-btn[data-value="high"] {
        color: color-mix(in srgb, #fb7185 72%, #fde68a 28%);
      }
      #animIntensityShell[data-intensity="ultra-low"]
        .intensity-icon-btn[data-value="ultra-low"]
        .ii-anim-ultra {
        animation: premiumIntensityBoltPulse 2.3s ease-in-out infinite;
      }
      #animIntensityShell[data-intensity="low"]
        .intensity-icon-btn[data-value="low"]
        .ii-anim-low-a,
      #animIntensityShell[data-intensity="low"]
        .intensity-icon-btn[data-value="low"]
        .ii-anim-low-b {
        animation: premiumIntensityBoltPulse 1.85s ease-in-out infinite;
      }
      #animIntensityShell[data-intensity="low"]
        .intensity-icon-btn[data-value="low"]
        .ii-anim-low-b {
        animation-delay: 0.16s;
      }
      #animIntensityShell[data-intensity="high"]
        .intensity-icon-btn[data-value="high"]
        .ii-anim-high-a,
      #animIntensityShell[data-intensity="high"]
        .intensity-icon-btn[data-value="high"]
        .ii-anim-high-b,
      #animIntensityShell[data-intensity="high"]
        .intensity-icon-btn[data-value="high"]
        .ii-anim-high-c {
        animation: premiumIntensityBoltPulse 1.08s ease-in-out infinite;
      }
      #animIntensityShell[data-intensity="high"]
        .intensity-icon-btn[data-value="high"]
        .ii-anim-high-b {
        animation-delay: 0.12s;
      }
      #animIntensityShell[data-intensity="high"]
        .intensity-icon-btn[data-value="high"]
        .ii-anim-high-c {
        animation-delay: 0.24s;
      }
      #animIntensityShell[data-intensity="high"]
        .intensity-icon-btn[data-value="high"]
        .ii-core-ring {
        animation: premiumIntensityRingSpin 2.8s linear infinite;
      }
      #animIntensityShell[data-intensity="high"]
        .intensity-icon-btn[data-value="high"]
        .ii-core-dot {
        animation: premiumIntensityDotPulse 1.06s ease-in-out infinite;
      }
      #animIntensityShell[data-anim-enabled="off"] .intensity-icon-btn {
        opacity: 0.54;
        filter: grayscale(0.2) saturate(0.8);
        box-shadow: none;
      }
      #animIntensityShell[data-anim-enabled="off"]
        .intensity-icon-btn:disabled {
        cursor: not-allowed;
      }
      #uiModeShell[data-ui-mode="desktop"] .pi-laptop-scan {
        animation: premiumLaptopScan 2.3s ease-in-out infinite;
      }
      #uiModeShell[data-ui-mode="mobile"] .pi-phone-pulse,
      #uiModeShell[data-ui-mode="mobile"] .pi-phone-swipe {
        animation: none !important;
      }
      #uiModeShell[data-ui-mode="auto"] .pi-auto-orbit {
        animation: premiumAutoOrbit 4.2s linear infinite;
      }
      #uiModeShell[data-ui-mode="auto"] .pi-auto-spark {
        animation: premiumAutoSpark 1.7s ease-in-out infinite;
      }
      #packSelectShell[data-pack="base"] .pi-pack-base-float {
        animation: premiumPackBaseFloat 2.4s ease-in-out infinite;
      }
      #packSelectShell[data-pack="ultra"] .pi-pack-ultra-ring {
        animation: premiumPackUltraRing 4.8s linear infinite;
      }
      #packSelectShell[data-pack="ultra"] .pi-pack-ultra-glint {
        animation: premiumPackUltraGlow 1.9s ease-in-out infinite;
      }
      #packSelectShell[data-pack="pro"] .pi-pack-pro-orbit {
        animation: premiumPackProOrbit 5.4s linear infinite;
      }
      #packSelectShell[data-pack="pro"] .pi-pack-pro-core {
        animation: premiumPackProCore 1.9s ease-in-out infinite;
      }
      #packSelectShell[data-pack="pro"] .pi-pack-pro-grid {
        animation: premiumPackProGrid 2.4s ease-in-out infinite;
      }
      #animIntensityShell[data-intensity="ultra-low"] .pi-bolt-ultra {
        animation: premiumIntensityBoltPulse 2.4s ease-in-out infinite;
      }
      #animIntensityShell[data-intensity="low"] .pi-bolt-low {
        animation: premiumIntensityBoltPulse 1.8s ease-in-out infinite;
      }
      #animIntensityShell[data-intensity="low"] .pi-bolt-low--b {
        animation-delay: 0.16s;
      }
      #animIntensityShell[data-intensity="high"] .pi-bolt-high {
        animation: premiumIntensityBoltPulse 1.06s ease-in-out infinite;
      }
      #animIntensityShell[data-intensity="high"] .pi-bolt-high--b {
        animation-delay: 0.12s;
      }
      #animIntensityShell[data-intensity="high"] .pi-bolt-high--c {
        animation-delay: 0.24s;
      }
      #animIntensityShell[data-intensity="high"] .pi-intensity-core-ring {
        animation: premiumIntensityRingSpin 2.8s linear infinite;
      }
      #animIntensityShell[data-intensity="high"] .pi-intensity-core-dot {
        animation: premiumIntensityDotPulse 1.08s ease-in-out infinite;
      }
      @keyframes premiumLaptopScan {
        0%,
        100% {
          transform: translateX(-6px);
          opacity: 0;
        }
        24% {
          opacity: 0.92;
        }
        78% {
          transform: translateX(8px);
          opacity: 0.08;
        }
      }
      @keyframes premiumPhonePulse {
        0%,
        100% {
          transform: scale(0.74);
          opacity: 0.24;
        }
        55% {
          transform: scale(1.12);
          opacity: 0.9;
        }
      }
      @keyframes premiumPhoneWave {
        0%,
        100% {
          transform: scale(0.82);
          opacity: 0.24;
        }
        50% {
          transform: scale(1.08);
          opacity: 0.92;
        }
      }
      @keyframes premiumPhoneSwipe {
        0%,
        100% {
          transform: translateY(-1.5px);
          opacity: 0.28;
        }
        50% {
          transform: translateY(1.5px);
          opacity: 0.96;
        }
      }
      @keyframes premiumAutoOrbit {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }
      @keyframes premiumAutoSpark {
        0%,
        100% {
          transform: scale(0.82);
          opacity: 0.38;
        }
        50% {
          transform: scale(1.08);
          opacity: 1;
        }
      }
      @keyframes premiumPackBaseFloat {
        0%,
        100% {
          transform: translateY(0);
          opacity: 0.68;
        }
        50% {
          transform: translateY(-1.6px);
          opacity: 1;
        }
      }
      @keyframes premiumPackUltraRing {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }
      @keyframes premiumPackUltraGlow {
        0%,
        100% {
          transform: translateX(-3px);
          opacity: 0.3;
        }
        50% {
          transform: translateX(3px);
          opacity: 1;
        }
      }
      @keyframes premiumPackProOrbit {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }
      @keyframes premiumPackProCore {
        0%,
        100% {
          transform: scale(0.76);
          opacity: 0.42;
        }
        50% {
          transform: scale(1.08);
          opacity: 1;
        }
      }
      @keyframes premiumPackProGrid {
        0%,
        100% {
          transform: translateY(-0.4px);
          opacity: 0.45;
        }
        50% {
          transform: translateY(0.65px);
          opacity: 1;
        }
      }
      @keyframes premiumThemeOrbit {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }
      @keyframes premiumThemeSpark {
        0%,
        100% {
          transform: translateY(0.2px) scale(0.74);
          opacity: 0.28;
        }
        50% {
          transform: translateY(-0.3px) scale(1.08);
          opacity: 1;
        }
      }
      @keyframes premiumThemeCorePulse {
        0%,
        100% {
          transform: scale(0.82);
          opacity: 0.72;
        }
        50% {
          transform: scale(1.08);
          opacity: 1;
        }
      }
      @keyframes premiumThemeSheen {
        0%,
        100% {
          transform: translateX(-0.55px);
          opacity: 0.34;
        }
        50% {
          transform: translateX(0.55px);
          opacity: 0.96;
        }
      }
      @keyframes premiumIntensityBoltPulse {
        0%,
        100% {
          transform: translateY(0) scale(0.72);
          opacity: 0.34;
        }
        52% {
          transform: translateY(-0.25px) scale(1);
          opacity: 1;
        }
      }
      @keyframes premiumIntensityRingSpin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }
      @keyframes premiumIntensityDotPulse {
        0%,
        100% {
          transform: scale(0.72);
          opacity: 0.44;
        }
        50% {
          transform: scale(1.06);
          opacity: 1;
        }
      }
      body[data-anim-enabled="off"] .premium-select-icon .pi-anim {
        animation: none !important;
      }
      body[data-anim-enabled="off"] .intensity-icon-picker .ii-anim {
        animation: none !important;
      }
      body[data-anim-enabled="off"] .ui-mode-icon-picker .uii-anim {
        animation: none !important;
      }
      @media (prefers-reduced-motion: reduce) {
        .premium-select-icon .pi-anim,
        .intensity-icon-picker .ii-anim,
        .ui-mode-icon-picker .uii-anim,
        .premium-icon-state,
        .premium-select-input {
          animation: none !important;
          transition: none !important;
        }
      }
      body[data-ui-mode="mobile"] .premium-select-icon {
        width: 24px;
        height: 24px;
        inset-inline-start: 7px;
      }
      body[data-ui-mode="mobile"] .premium-icon-stack {
        width: 15px;
        height: 15px;
      }
      body[data-ui-mode="mobile"] .premium-select-input {
        padding-inline-start: 40px !important;
      }
      body[data-ui-mode="mobile"] .top-nav .premium-icon-state,
      body[data-ui-mode="mobile"] .top-nav .premium-select-icon {
        transition: none !important;
      }
      body[data-ui-mode="mobile"] .top-nav .premium-select-icon .pi-anim {
        animation: none !important;
        opacity: 1 !important;
        transform: none !important;
      }
      body[data-ui-mode="mobile"] .top-nav .ui-mode-icon-picker .uii-anim {
        animation: none !important;
        opacity: 1 !important;
        transform: none !important;
      }
      @media (max-width: 1023.98px) {
        body[data-ui-mode="auto"] .premium-select-icon {
          width: 24px;
          height: 24px;
          inset-inline-start: 7px;
        }
        body[data-ui-mode="auto"] .premium-icon-stack {
          width: 15px;
          height: 15px;
        }
        body[data-ui-mode="auto"] .premium-select-input {
          padding-inline-start: 40px !important;
        }
        body[data-ui-mode="auto"] .top-nav .premium-icon-state,
        body[data-ui-mode="auto"] .top-nav .premium-select-icon {
          transition: none !important;
        }
        body[data-ui-mode="auto"] .top-nav .premium-select-icon .pi-anim {
          animation: none !important;
          opacity: 1 !important;
          transform: none !important;
        }
        body[data-ui-mode="auto"] .top-nav .ui-mode-icon-picker .uii-anim {
          animation: none !important;
          opacity: 1 !important;
          transform: none !important;
        }
      }
      .top-nav .control-surface,
      .top-nav .control-btn:not(.danger-btn),
      .top-nav .notify-bell-btn {
        min-height: 42px;
        inline-size: auto;
      }
      .top-nav .notify-bell-state {
        display: inline-block;
        max-width: 56px;
        overflow: hidden;
        text-overflow: ellipsis;
        vertical-align: bottom;
      }
      .sync-auth-btn {
        position: relative;
        isolation: isolate;
        min-width: 0;
        width: auto;
        padding: 0 12px;
        gap: 8px;
        display: inline-flex;
        align-items: center;
        justify-content: flex-start;
        border-radius: 14px;
        border: 1px solid color-mix(in srgb, var(--accent2) 42%, var(--border));
        background: linear-gradient(
          142deg,
          color-mix(in srgb, var(--card-bg) 90%, rgba(255, 255, 255, 0.04)),
          color-mix(in srgb, var(--bg) 80%, rgba(255, 255, 255, 0.04))
        );
        box-shadow:
          0 6px 18px rgba(0, 0, 0, 0.2),
          inset 0 1px 0 rgba(255, 255, 255, 0.14);
        transition:
          transform 0.2s ease,
          filter 0.2s ease,
          border-color 0.2s ease,
          box-shadow 0.2s ease;
      }
      .sync-auth-btn::before {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: inherit;
        pointer-events: none;
        background: linear-gradient(
          120deg,
          transparent 10%,
          color-mix(in srgb, var(--accent2) 30%, transparent) 48%,
          transparent 85%
        );
        opacity: 0.52;
      }
      .sync-auth-btn:hover:not(:disabled) {
        filter: brightness(1.06);
        transform: translateY(-1px);
        border-color: color-mix(in srgb, var(--accent2) 62%, var(--border));
        box-shadow:
          0 10px 22px rgba(0, 0, 0, 0.26),
          inset 0 1px 0 rgba(255, 255, 255, 0.16);
      }
      .sync-auth-visual {
        position: relative;
        width: 20px;
        height: 20px;
        flex: 0 0 auto;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 999px;
        background: color-mix(in srgb, var(--bg) 42%, transparent);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.14);
        z-index: 1;
      }
      .sync-auth-ring {
        position: absolute;
        inset: 1px;
        border-radius: 999px;
        border: 1.8px solid
          color-mix(in srgb, var(--accent2) 64%, var(--border));
      }
      .sync-auth-core {
        width: 6px;
        height: 6px;
        border-radius: 999px;
        background: color-mix(in srgb, var(--accent2) 72%, var(--accent) 28%);
        box-shadow:
          0 0 0 1px rgba(0, 0, 0, 0.08) inset,
          0 0 10px color-mix(in srgb, var(--accent2) 32%, transparent);
      }
      .sync-auth-orbit {
        position: absolute;
        inset: -1px;
        border-radius: 999px;
        border: 1.5px dashed color-mix(in srgb, var(--accent) 48%, transparent);
        opacity: 0.84;
      }
      .sync-auth-dot {
        position: absolute;
        inset-inline-start: -1px;
        top: 50%;
        width: 4.5px;
        height: 4.5px;
        margin-top: -2.25px;
        border-radius: 999px;
        background: color-mix(in srgb, var(--accent) 78%, #ffffff 22%);
      }
      .sync-auth-meta {
        min-width: 0;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        line-height: 1;
        z-index: 1;
      }
      .sync-auth-label {
        font-size: 9px;
        font-weight: 800;
        letter-spacing: 0.09em;
        text-transform: uppercase;
        opacity: 0.76;
        font-family: var(--font-en);
      }
      .sync-auth-state {
        font-size: 11px;
        font-weight: 900;
        letter-spacing: 0.012em;
        white-space: nowrap;
        font-family: var(--font-en);
        font-variant-numeric: tabular-nums;
      }
      .sync-auth-state[data-state="syncing"] {
        color: color-mix(in srgb, #38bdf8 64%, var(--text));
      }
      .sync-auth-state[data-state="synced"] {
        color: color-mix(in srgb, #10b981 74%, var(--text));
      }
      .sync-auth-state[data-state="offline"] {
        color: color-mix(in srgb, #94a3b8 72%, var(--text));
      }
      .sync-auth-state[data-state="error"] {
        color: color-mix(in srgb, #ef4444 74%, var(--text));
      }
      .sync-auth-btn[data-state="syncing"] .sync-auth-orbit {
        animation: syncAuthOrbit 1.18s linear infinite;
      }
      .sync-auth-btn[data-state="syncing"] .sync-auth-core {
        animation: syncAuthPulse 1.1s ease-in-out infinite;
      }
      .sync-auth-btn[data-state="synced"] .sync-auth-orbit {
        animation: syncAuthOrbit 3.8s linear infinite;
      }
      .sync-auth-btn[data-state="synced"] .sync-auth-core {
        background: #10b981;
      }
      .sync-auth-btn[data-state="offline"] .sync-auth-orbit {
        animation: none;
        opacity: 0.5;
      }
      .sync-auth-btn[data-state="offline"] .sync-auth-core {
        background: #94a3b8;
        box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.08) inset;
      }
      .sync-auth-btn[data-state="error"] .sync-auth-orbit {
        animation: syncAuthOrbit 2.4s linear infinite;
      }
      .sync-auth-btn[data-state="error"] .sync-auth-core {
        background: #ef4444;
        animation: syncAuthPulse 1.25s ease-in-out infinite;
      }
      @keyframes syncAuthOrbit {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }
      @keyframes syncAuthPulse {
        0%,
        100% {
          transform: scale(0.84);
          opacity: 0.62;
        }
        50% {
          transform: scale(1.05);
          opacity: 1;
        }
      }
      .data-io-inline {
        --dio-shell-gap: 4px;
        --dio-shell-pad: 4px;
        --dio-shell-radius: 14px;
        --dio-btn-size: 34px;
        --dio-btn-icon-size: 15.5px;
        --dio-btn-radius: 10px;
        position: relative;
        min-width: 0;
        display: inline-flex;
        align-items: center;
        gap: var(--dio-shell-gap);
        padding: var(--dio-shell-pad);
        min-height: 42px;
        border-radius: var(--dio-shell-radius);
        border: 1px solid color-mix(in srgb, var(--accent2) 40%, var(--border));
        background:
          radial-gradient(
            56px 30px at 50% -34%,
            color-mix(in srgb, var(--accent2) 18%, transparent),
            transparent 72%
          ),
          color-mix(in srgb, var(--card-bg) 84%, transparent);
        box-shadow:
          inset 0 1px 0 rgba(255, 255, 255, 0.18),
          0 7px 16px rgba(2, 6, 23, 0.22);
        isolation: isolate;
      }
      .data-io-action {
        position: relative;
        overflow: hidden;
        appearance: none;
        width: var(--dio-btn-size);
        height: var(--dio-btn-size);
        min-width: var(--dio-btn-size);
        min-height: var(--dio-btn-size);
        border-radius: var(--dio-btn-radius);
        border: 1px solid color-mix(in srgb, var(--border) 78%, transparent);
        background: linear-gradient(
          145deg,
          color-mix(in srgb, var(--bg) 32%, transparent),
          color-mix(in srgb, var(--bg) 18%, transparent)
        );
        color: var(--text);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        aspect-ratio: 1 / 1;
        transition:
          transform 0.18s ease,
          filter 0.18s ease,
          border-color 0.18s ease;
      }
      .data-io-action::after {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: inherit;
        pointer-events: none;
        background: linear-gradient(
          130deg,
          transparent 14%,
          color-mix(in srgb, var(--accent2) 16%, transparent) 56%,
          transparent 88%
        );
        opacity: 0.54;
      }
      .data-io-action svg {
        width: var(--dio-btn-icon-size);
        height: var(--dio-btn-icon-size);
      }
      .data-io-action .dio-action-stroke {
        fill: none;
        stroke: currentColor;
        stroke-linecap: round;
        stroke-linejoin: round;
        stroke-width: 1.84;
      }
      .data-io-action .dio-action-core {
        fill: currentColor;
        opacity: 0.85;
      }
      .data-io-action .dio-action-soft {
        fill: currentColor;
        opacity: 0.11;
      }
      .data-io-action .dio-action-accent {
        fill: none;
        stroke: currentColor;
        stroke-width: 1.46;
        stroke-linecap: round;
        stroke-linejoin: round;
        opacity: 0.8;
      }
      .data-io-action:hover {
        filter: brightness(1.1);
        transform: translateY(-1px);
      }
      .data-io-action:hover .dio-action-soft {
        opacity: 0.18;
      }
      .data-io-action--download {
        border-color: color-mix(in srgb, #10b981 56%, var(--border));
        color: color-mix(in srgb, #10b981 84%, var(--text));
        box-shadow: 0 5px 12px color-mix(in srgb, #10b981 16%, transparent);
      }
      .data-io-action--download svg {
        transform: translateY(0.15px);
      }
      .data-io-action--upload {
        border-color: color-mix(in srgb, #38bdf8 58%, var(--border));
        color: color-mix(in srgb, #38bdf8 86%, var(--text));
        box-shadow: 0 5px 12px color-mix(in srgb, #38bdf8 16%, transparent);
      }
      .data-io-action--upload svg {
        transform: translateY(-0.15px);
      }
      .data-io-action .dio-anim-down {
        animation: dataIoSlideDown 1.3s ease-in-out infinite;
      }
      .data-io-action .dio-anim-up {
        animation: dataIoSlideUp 1.3s ease-in-out infinite;
      }
      .data-io-action .dio-flow-down {
        animation: dataIoFlowDown 1.35s ease-in-out infinite;
      }
      .data-io-action .dio-flow-up {
        animation: dataIoFlowUp 1.35s ease-in-out infinite;
      }
      @keyframes dataIoSlideDown {
        0%,
        100% {
          transform: translateY(-0.6px);
          opacity: 0.72;
        }
        50% {
          transform: translateY(1.2px);
          opacity: 1;
        }
      }
      @keyframes dataIoSlideUp {
        0%,
        100% {
          transform: translateY(0.8px);
          opacity: 0.72;
        }
        50% {
          transform: translateY(-1.2px);
          opacity: 1;
        }
      }
      @keyframes dataIoFlowDown {
        0%,
        100% {
          opacity: 0.3;
          transform: translateY(-0.7px);
        }
        50% {
          opacity: 0.95;
          transform: translateY(0.7px);
        }
      }
      @keyframes dataIoFlowUp {
        0%,
        100% {
          opacity: 0.3;
          transform: translateY(0.7px);
        }
        50% {
          opacity: 0.95;
          transform: translateY(-0.7px);
        }
      }
      body[data-anim-enabled="off"] .data-io-action .dio-anim-down,
      body[data-anim-enabled="off"] .data-io-action .dio-anim-up,
      body[data-anim-enabled="off"] .data-io-action .dio-flow-down,
      body[data-anim-enabled="off"] .data-io-action .dio-flow-up {
        animation: none !important;
      }
      .sync-modal-shell {
        width: min(650px, calc(100vw - 20px));
        max-height: calc(
          var(--app-vh) - env(safe-area-inset-top) -
            env(safe-area-inset-bottom) - 16px
        );
        padding: 14px;
        display: flex;
        flex-direction: column;
        overflow: hidden !important;
      }
      .sync-modal-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        flex: 0 0 auto;
      }
      .sync-modal-title {
        margin: 0;
        font-size: 0.98rem;
        font-weight: 900;
        font-family: var(--font-en);
        letter-spacing: 0.015em;
        display: inline-flex;
        align-items: center;
        gap: 7px;
      }
      .sync-modal-title::before {
        content: "";
        width: 11px;
        height: 11px;
        border-radius: 4px;
        background: conic-gradient(
          from 30deg,
          color-mix(in srgb, var(--accent2) 78%, #ffffff 22%),
          color-mix(in srgb, var(--accent) 72%, #ffffff 28%),
          color-mix(in srgb, var(--accent2) 78%, #ffffff 22%)
        );
        box-shadow: 0 0 8px color-mix(in srgb, var(--accent2) 44%, transparent);
      }
      .sync-modal-scroll {
        margin-top: 10px;
        min-height: 0;
        flex: 1 1 auto;
        display: grid;
        gap: 10px;
        overflow-y: auto;
        overflow-x: hidden;
        padding-inline-end: 2px;
        scrollbar-width: thin;
        scrollbar-color: color-mix(in srgb, var(--accent2) 64%, var(--accent))
          color-mix(in srgb, var(--bg) 74%, transparent);
      }
      .sync-modal-scroll::-webkit-scrollbar {
        width: 7px;
      }
      .sync-modal-scroll::-webkit-scrollbar-track {
        background: color-mix(in srgb, var(--bg) 76%, transparent);
        border-radius: 999px;
      }
      .sync-modal-scroll::-webkit-scrollbar-thumb {
        background: linear-gradient(
          180deg,
          color-mix(in srgb, var(--accent2) 70%, var(--accent)),
          color-mix(in srgb, var(--accent) 70%, var(--accent2))
        );
        border-radius: 999px;
      }
      .sync-modal-foot {
        margin-top: 10px;
        padding-top: 9px;
        border-top: 1px solid color-mix(in srgb, var(--border) 82%, transparent);
        flex: 0 0 auto;
      }
      .sync-modal-close-btn {
        width: 100%;
        min-height: 42px;
        border-radius: 14px;
        border: 1px solid color-mix(in srgb, var(--accent) 30%, transparent);
        background: linear-gradient(
          135deg,
          color-mix(in srgb, var(--accent) 82%, #ffffff 18%),
          color-mix(in srgb, var(--accent2) 72%, var(--accent))
        );
        color: var(--bg);
        font-size: 13px;
        font-weight: 900;
        letter-spacing: 0.01em;
        box-shadow:
          0 8px 18px rgba(0, 0, 0, 0.25),
          inset 0 1px 0 rgba(255, 255, 255, 0.18);
        transition:
          transform 0.16s ease,
          filter 0.16s ease;
      }
      .sync-modal-close-btn:hover {
        transform: translateY(-1px);
        filter: brightness(1.08);
      }
      .sync-modal-state {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border-radius: 999px;
        padding: 4px 9px;
        font-size: 11px;
        font-weight: 900;
        border: 1px solid color-mix(in srgb, var(--accent2) 36%, transparent);
        background: color-mix(in srgb, var(--card-bg) 84%, transparent);
      }
      .sync-modal-state-dot {
        width: 7px;
        height: 7px;
        border-radius: 999px;
        background: #94a3b8;
      }
      .sync-modal-state[data-state="syncing"] .sync-modal-state-dot {
        background: #38bdf8;
      }
      .sync-modal-state[data-state="synced"] .sync-modal-state-dot {
        background: #10b981;
      }
      .sync-modal-state[data-state="error"] .sync-modal-state-dot {
        background: #ef4444;
      }
      .sync-modal-user {
        margin-top: 0;
        border-radius: 14px;
        border: 1px solid color-mix(in srgb, var(--border) 82%, transparent);
        background: color-mix(in srgb, var(--card-bg) 86%, transparent);
        padding: 10px;
      }
      .sync-modal-user-email {
        font-size: 12px;
        font-weight: 900;
        direction: ltr;
        text-align: left;
        word-break: break-word;
      }
      .sync-modal-user-meta {
        margin-top: 5px;
        font-size: 11px;
        opacity: 0.76;
      }
      .sync-client-config {
        margin-top: 0;
        min-width: 0;
        border-radius: 14px;
        border: 1px solid color-mix(in srgb, var(--border) 82%, transparent);
        background: color-mix(in srgb, var(--card-bg) 86%, transparent);
        padding: 10px;
        display: grid;
        gap: 8px;
      }
      .sync-client-label {
        margin: 0;
        font-size: 11px;
        font-weight: 900;
        letter-spacing: 0.01em;
        opacity: 0.88;
      }
      .sync-client-row {
        display: grid;
        grid-template-columns: minmax(0, 1fr) auto;
        gap: 8px;
        align-items: center;
        min-width: 0;
      }
      .sync-client-input {
        appearance: none;
        width: 100%;
        min-width: 0;
        min-height: 38px;
        border-radius: 10px;
        border: 1px solid color-mix(in srgb, var(--border) 78%, transparent);
        background: color-mix(in srgb, var(--bg) 34%, transparent);
        color: var(--text);
        padding: 0 10px;
        direction: ltr;
        text-align: left;
        font-size: 11.2px;
        font-family: var(--font-en);
      }
      .sync-client-input:focus {
        border-color: color-mix(in srgb, var(--accent2) 56%, var(--border));
        box-shadow: 0 0 0 2px
          color-mix(in srgb, var(--accent2) 22%, transparent);
        outline: none;
      }
      .sync-client-input::placeholder {
        opacity: 0.55;
      }
      .sync-client-meta {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        flex-wrap: wrap;
      }
      .sync-client-status {
        font-size: 10px;
        line-height: 1.6;
        opacity: 0.8;
        word-break: break-word;
      }
      .sync-client-status[data-state="ok"] {
        color: color-mix(in srgb, #10b981 78%, var(--text));
      }
      .sync-client-status[data-state="warn"] {
        color: color-mix(in srgb, #f59e0b 82%, var(--text));
      }
      .sync-ultra-config {
        margin-top: 0;
        min-width: 0;
        border-radius: 12px;
        border: 1px solid color-mix(in srgb, var(--border) 80%, transparent);
        background: color-mix(in srgb, var(--bg) 30%, transparent);
        padding: 8px;
        display: grid;
        gap: 7px;
      }
      .sync-ultra-row {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 7px;
      }
      .sync-ultra-btn {
        min-height: 34px;
        border-radius: 10px;
        border: 1px solid color-mix(in srgb, var(--border) 76%, transparent);
        background: color-mix(in srgb, var(--card-bg) 84%, transparent);
        color: var(--text);
        font-size: 10.2px;
        font-weight: 900;
        line-height: 1.45;
        padding: 6px 8px;
        transition:
          filter 0.18s ease,
          transform 0.14s ease,
          border-color 0.18s ease;
      }
      .sync-ultra-btn:hover {
        filter: brightness(1.07);
        transform: translateY(-1px);
      }
      .sync-ultra-btn.is-on {
        border-color: color-mix(in srgb, #10b981 56%, var(--border));
        background: linear-gradient(
          140deg,
          rgba(16, 185, 129, 0.28),
          rgba(14, 165, 233, 0.18)
        );
      }
      .sync-ultra-btn.is-battery {
        border-color: color-mix(in srgb, #f59e0b 58%, var(--border));
        background: linear-gradient(
          140deg,
          rgba(245, 158, 11, 0.26),
          rgba(251, 191, 36, 0.15)
        );
      }
      .sync-ultra-hint {
        font-size: 10px;
        line-height: 1.68;
        opacity: 0.86;
      }
      .sync-modal-actions {
        margin-top: 0;
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 8px;
      }
      .sync-modal-btn {
        appearance: none;
        border-radius: 12px;
        border: 1px solid color-mix(in srgb, var(--border) 76%, transparent);
        background: color-mix(in srgb, var(--card-bg) 88%, transparent);
        color: var(--text);
        min-height: 38px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 7px 8px;
        font-size: 11.5px;
        font-weight: 900;
        line-height: 1.4;
        text-align: center;
        word-break: break-word;
        transition:
          filter 0.2s ease,
          border-color 0.2s ease,
          transform 0.15s ease;
      }
      .sync-modal-btn:hover:not(:disabled) {
        filter: brightness(1.07);
        transform: translateY(-1px);
      }
      .sync-modal-btn:disabled {
        opacity: 0.52;
        cursor: not-allowed;
      }
      .sync-modal-btn--google {
        border-color: color-mix(in srgb, #60a5fa 48%, var(--border));
      }
      .sync-modal-btn--sync {
        border-color: color-mix(in srgb, #10b981 46%, var(--border));
      }
      .sync-modal-btn--logout {
        border-color: color-mix(in srgb, #f59e0b 46%, var(--border));
      }
      .sync-modal-btn--clear {
        border-color: color-mix(in srgb, #ef4444 48%, var(--border));
      }
      .sync-modal-footnote {
        margin-top: 0;
        font-size: 11px;
        line-height: 1.75;
        opacity: 0.76;
      }
      .sync-guide-panel {
        margin-top: 0;
        border-radius: 14px;
        border: 1px solid color-mix(in srgb, var(--border) 82%, transparent);
        background:
          radial-gradient(
            380px 130px at 0% -20%,
            color-mix(in srgb, var(--accent2) 14%, transparent),
            transparent 72%
          ),
          color-mix(in srgb, var(--card-bg) 86%, transparent);
        padding: 10px;
        display: grid;
        gap: 8px;
        max-height: min(36vh, 290px);
        overflow-y: auto;
        overflow-x: hidden;
        overscroll-behavior: contain;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
        scrollbar-color: color-mix(in srgb, var(--accent2) 64%, var(--accent))
          color-mix(in srgb, var(--bg) 76%, transparent);
      }
      .sync-guide-panel::-webkit-scrollbar {
        width: 7px;
      }
      .sync-guide-panel::-webkit-scrollbar-track {
        background: color-mix(in srgb, var(--bg) 76%, transparent);
        border-radius: 999px;
      }
      .sync-guide-panel::-webkit-scrollbar-thumb {
        background: linear-gradient(
          180deg,
          color-mix(in srgb, var(--accent2) 70%, var(--accent)),
          color-mix(in srgb, var(--accent) 70%, var(--accent2))
        );
        border-radius: 999px;
      }
      .sync-guide-headline {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }
      .sync-guide-title {
        margin: 0;
        font-size: 12px;
        font-weight: 950;
      }
      .sync-guide-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 999px;
        min-height: 24px;
        padding: 0 10px;
        border: 1px solid color-mix(in srgb, var(--border) 76%, transparent);
        font-size: 10px;
        font-weight: 900;
        letter-spacing: 0.015em;
        background: color-mix(in srgb, var(--bg) 34%, transparent);
      }
      .sync-guide-badge[data-level="ok"] {
        border-color: color-mix(in srgb, #10b981 52%, var(--border));
        color: color-mix(in srgb, #10b981 74%, var(--text));
      }
      .sync-guide-badge[data-level="warn"] {
        border-color: color-mix(in srgb, #f59e0b 54%, var(--border));
        color: color-mix(in srgb, #f59e0b 76%, var(--text));
      }
      .sync-guide-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 8px;
      }
      .sync-guide-section {
        border-radius: 11px;
        border: 1px solid color-mix(in srgb, var(--border) 78%, transparent);
        background: color-mix(in srgb, var(--bg) 32%, transparent);
        padding: 8px;
      }
      .sync-guide-section-title {
        margin: 0 0 4px;
        font-size: 11px;
        font-weight: 900;
        opacity: 0.86;
      }
      .sync-guide-list {
        margin: 0;
        padding-inline-start: 18px;
        font-size: 11px;
        line-height: 1.85;
        opacity: 0.92;
      }
      .sync-guide-list li {
        margin: 2px 0;
      }
      .sync-guide-list--plain {
        list-style: none;
        padding-inline-start: 0;
        display: grid;
        gap: 6px;
      }
      .sync-guide-list--plain li {
        margin: 0;
        border-radius: 10px;
        border: 1px solid color-mix(in srgb, var(--border) 78%, transparent);
        background: color-mix(in srgb, var(--bg) 38%, transparent);
        padding: 7px 8px;
      }
      .sync-guide-list--plain li[data-level="ok"] {
        border-color: color-mix(in srgb, #10b981 44%, var(--border));
      }
      .sync-guide-list--plain li[data-level="warn"] {
        border-color: color-mix(in srgb, #f59e0b 44%, var(--border));
      }
      .sync-guide-list--plain li[data-level="error"] {
        border-color: color-mix(in srgb, #ef4444 46%, var(--border));
      }
      .sync-trouble-title {
        font-size: 10.7px;
        font-weight: 900;
        line-height: 1.7;
      }
      .sync-trouble-action {
        margin-top: 2px;
        font-size: 10.1px;
        opacity: 0.84;
        line-height: 1.7;
      }
      .sync-trouble-signal {
        margin-top: 3px;
        font-size: 9.2px;
        opacity: 0.62;
        direction: ltr;
        text-align: left;
        font-family: var(--font-en);
      }
      .sync-guide-checks-title {
        font-size: 11px;
        font-weight: 900;
        opacity: 0.78;
      }
      .sync-guide-checks {
        margin: 0;
        padding: 0;
        list-style: none;
        display: grid;
        gap: 5px;
        font-size: 11px;
      }
      .sync-guide-checks li {
        position: relative;
        padding-inline-start: 14px;
        opacity: 0.9;
      }
      .sync-guide-checks li::before {
        content: "";
        position: absolute;
        inset-inline-start: 0;
        top: 5px;
        width: 7px;
        height: 7px;
        border-radius: 999px;
        background: #94a3b8;
      }
      .sync-guide-checks li[data-level="ok"]::before {
        background: #10b981;
      }
      .sync-guide-checks li[data-level="warn"]::before {
        background: #f59e0b;
      }
      .sync-guide-checks li[data-level="error"]::before {
        background: #ef4444;
      }
      .sync-guide-diag {
        margin: 0;
        border-radius: 10px;
        border: 1px dashed color-mix(in srgb, var(--border) 74%, transparent);
        background: color-mix(in srgb, var(--bg) 38%, transparent);
        padding: 8px;
        font-size: 10px;
        line-height: 1.7;
        white-space: pre-wrap;
        word-break: break-word;
        direction: ltr;
        text-align: left;
        max-height: 126px;
        overflow: auto;
      }
      .sync-guide-actions {
        display: flex;
        align-items: center;
        gap: 6px;
        flex-wrap: wrap;
      }
      .sync-guide-btn {
        appearance: none;
        border-radius: 10px;
        border: 1px solid color-mix(in srgb, var(--border) 76%, transparent);
        background: color-mix(in srgb, var(--bg) 30%, transparent);
        color: var(--text);
        min-height: 34px;
        padding: 6px 10px;
        font-size: 11px;
        font-weight: 900;
        transition:
          filter 0.2s ease,
          border-color 0.2s ease,
          transform 0.15s ease;
      }
      .sync-guide-btn:hover {
        filter: brightness(1.08);
        transform: translateY(-1px);
      }
      .sync-guide-btn--copy {
        border-color: color-mix(in srgb, #38bdf8 46%, var(--border));
      }
      .sync-guide-btn--apply {
        border-color: color-mix(in srgb, #10b981 46%, var(--border));
      }
      .sync-guide-btn--ghost {
        border-color: color-mix(in srgb, #f59e0b 48%, var(--border));
      }
      body[data-ui-mode="mobile"] .sync-auth-btn {
        min-width: 0;
      }
      body[data-ui-mode="mobile"] .top-nav .sync-auth-btn,
      body[data-ui-mode="mobile"] .top-nav .anim-status-btn {
        flex: 0 0 auto;
        min-width: 0;
      }
      @media (max-width: 1023.98px) {
        body[data-ui-mode="auto"] .sync-auth-btn {
          min-width: 0;
        }
        body[data-ui-mode="auto"] .top-nav .sync-auth-btn,
        body[data-ui-mode="auto"] .top-nav .anim-status-btn {
          flex: 0 0 auto;
          min-width: 0;
        }
        body[data-ui-mode="mobile"] .sync-modal-shell,
        body[data-ui-mode="auto"] .sync-modal-shell {
          width: calc(100vw - 14px);
          max-height: calc(
            var(--app-vh) - env(safe-area-inset-top) -
              env(safe-area-inset-bottom) - 10px
          );
          padding: 10px;
          border-radius: 17px;
        }
        body[data-ui-mode="mobile"] .sync-modal-scroll,
        body[data-ui-mode="auto"] .sync-modal-scroll {
          gap: 8px;
          margin-top: 8px;
        }
        body[data-ui-mode="mobile"] .sync-client-config,
        body[data-ui-mode="auto"] .sync-client-config {
          border-radius: 12px;
          padding: 8px;
          gap: 7px;
        }
        body[data-ui-mode="mobile"] .sync-client-label,
        body[data-ui-mode="auto"] .sync-client-label {
          font-size: 10.4px;
        }
        body[data-ui-mode="mobile"] .sync-client-row,
        body[data-ui-mode="auto"] .sync-client-row {
          grid-template-columns: 1fr;
          gap: 7px;
        }
        body[data-ui-mode="mobile"] .sync-ultra-row,
        body[data-ui-mode="auto"] .sync-ultra-row {
          grid-template-columns: 1fr;
          gap: 6px;
        }
        body[data-ui-mode="mobile"] .sync-client-row .sync-guide-btn,
        body[data-ui-mode="auto"] .sync-client-row .sync-guide-btn {
          width: 100%;
        }
        body[data-ui-mode="mobile"] .sync-ultra-btn,
        body[data-ui-mode="auto"] .sync-ultra-btn {
          min-height: 36px;
          font-size: 10px;
        }
        body[data-ui-mode="mobile"] .sync-client-input,
        body[data-ui-mode="auto"] .sync-client-input {
          min-height: 36px;
          font-size: 10.4px;
        }
        body[data-ui-mode="mobile"] .sync-client-meta,
        body[data-ui-mode="auto"] .sync-client-meta {
          display: grid;
          grid-template-columns: 1fr;
          gap: 6px;
        }
        body[data-ui-mode="mobile"] .sync-client-status,
        body[data-ui-mode="auto"] .sync-client-status {
          font-size: 9.4px;
          line-height: 1.65;
        }
        body[data-ui-mode="mobile"] .sync-modal-actions,
        body[data-ui-mode="auto"] .sync-modal-actions {
          grid-template-columns: repeat(2, minmax(0, 1fr));
          gap: 7px;
        }
        body[data-ui-mode="mobile"] .sync-modal-btn,
        body[data-ui-mode="auto"] .sync-modal-btn {
          min-height: 36px;
          padding: 6px 7px;
          font-size: 10.4px;
        }
        body[data-ui-mode="mobile"] .sync-modal-close-btn,
        body[data-ui-mode="auto"] .sync-modal-close-btn {
          min-height: 40px;
          font-size: 12px;
        }
        body[data-ui-mode="mobile"] .sync-guide-panel,
        body[data-ui-mode="auto"] .sync-guide-panel {
          max-height: min(34vh, 248px);
          border-radius: 12px;
          padding: 8px;
          overflow: auto;
        }
        body[data-ui-mode="mobile"] .sync-guide-badge,
        body[data-ui-mode="auto"] .sync-guide-badge {
          min-height: 22px;
          padding-inline: 8px;
          font-size: 9.5px;
        }
        body[data-ui-mode="mobile"] .sync-guide-section,
        body[data-ui-mode="auto"] .sync-guide-section {
          padding: 7px;
          border-radius: 10px;
        }
        body[data-ui-mode="mobile"] .sync-guide-list,
        body[data-ui-mode="auto"] .sync-guide-list {
          font-size: 10px;
          line-height: 1.75;
        }
        body[data-ui-mode="mobile"] .sync-guide-diag,
        body[data-ui-mode="auto"] .sync-guide-diag {
          font-size: 9.5px;
          max-height: 98px;
        }
        body[data-ui-mode="mobile"] .sync-guide-actions,
        body[data-ui-mode="auto"] .sync-guide-actions {
          display: grid;
          grid-template-columns: 1fr;
        }
        body[data-ui-mode="mobile"] .sync-guide-btn,
        body[data-ui-mode="auto"] .sync-guide-btn {
          width: 100%;
          min-height: 38px;
        }
      }
      @media (max-width: 420px) {
        body[data-ui-mode="mobile"] .sync-modal-actions,
        body[data-ui-mode="auto"] .sync-modal-actions {
          grid-template-columns: 1fr;
        }
      }

      .widget-title-wrap {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border-radius: 14px;
        padding: 4px 8px 4px 4px;
        border: 1px solid color-mix(in srgb, var(--border) 86%, transparent);
        background: color-mix(in srgb, var(--bg) 18%, transparent);
      }
      .side-widget > div:first-child h4 {
        letter-spacing: 0.015em;
      }
      .widget-title-icon {
        width: 28px;
        height: 28px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: color-mix(in srgb, var(--bg) 36%, transparent);
        box-shadow:
          inset 0 1px 0 rgba(255, 255, 255, 0.18),
          0 6px 16px rgba(0, 0, 0, 0.16);
      }
      .widget-title-icon svg {
        width: 15px;
        height: 15px;
      }
      .widget-title-icon--exam {
        color: #0f766e;
        border-color: rgba(15, 118, 110, 0.3);
        background: linear-gradient(
          145deg,
          rgba(94, 234, 212, 0.36),
          rgba(45, 212, 191, 0.14)
        );
      }
      .widget-title-icon--note {
        color: #1d4ed8;
        border-color: rgba(29, 78, 216, 0.3);
        background: linear-gradient(
          145deg,
          rgba(147, 197, 253, 0.36),
          rgba(96, 165, 250, 0.14)
        );
      }
      .widget-title-icon--next {
        color: #0e7490;
        border-color: rgba(14, 116, 144, 0.32);
        background: linear-gradient(
          145deg,
          rgba(125, 211, 252, 0.34),
          rgba(56, 189, 248, 0.14)
        );
      }
      .widget-title-icon--alert {
        color: #b91c1c;
        border-color: rgba(185, 28, 28, 0.34);
        background: linear-gradient(
          145deg,
          rgba(252, 165, 165, 0.36),
          rgba(248, 113, 113, 0.14)
        );
      }
      .widget-title-icon--attendance {
        color: #0f766e;
        border-color: rgba(15, 118, 110, 0.35);
        background: linear-gradient(
          145deg,
          rgba(45, 212, 191, 0.34),
          rgba(14, 165, 233, 0.16)
        );
      }

      .logo-badge {
        position: relative;
        width: 54px;
        height: 54px;
        border-radius: 20px;
        display: grid;
        place-items: center;
        border: 1px solid color-mix(in srgb, var(--accent2) 42%, transparent);
        background:
          radial-gradient(
            120px 70px at 16% 0%,
            rgba(255, 255, 255, 0.34),
            rgba(255, 255, 255, 0) 68%
          ),
          linear-gradient(
            145deg,
            color-mix(in srgb, var(--accent) 88%, #ffffff 12%),
            color-mix(in srgb, var(--accent2) 75%, #ffffff 25%)
          );
        box-shadow:
          0 14px 28px rgba(0, 0, 0, 0.28),
          0 0 0 1px color-mix(in srgb, var(--accent2) 18%, transparent),
          inset 0 1px 0 rgba(255, 255, 255, 0.46);
        overflow: hidden;
        transition:
          transform 0.2s ease,
          box-shadow 0.22s ease;
      }
      .logo-badge::before {
        content: "";
        position: absolute;
        inset: 3px;
        border-radius: 16px;
        background:
          linear-gradient(
            165deg,
            rgba(255, 255, 255, 0.34),
            rgba(255, 255, 255, 0) 38%
          ),
          radial-gradient(
            140px 74px at 18% -2%,
            rgba(255, 255, 255, 0.46),
            rgba(255, 255, 255, 0) 68%
          );
      }
      .logo-badge::after {
        content: "";
        position: absolute;
        width: 140%;
        height: 140%;
        background: conic-gradient(
          from 0deg,
          rgba(255, 255, 255, 0.42),
          rgba(255, 255, 255, 0) 40%,
          rgba(255, 255, 255, 0.36) 70%,
          rgba(255, 255, 255, 0)
        );
        animation: logoSpin 7.4s linear infinite;
        opacity: 0.9;
      }
      .top-nav:hover .logo-badge {
        transform: translateY(-1px) scale(1.02);
        box-shadow:
          0 18px 34px rgba(0, 0, 0, 0.3),
          0 0 0 1px color-mix(in srgb, var(--accent2) 24%, transparent),
          inset 0 1px 0 rgba(255, 255, 255, 0.5);
      }
      .logo-icon {
        width: 25px;
        height: 25px;
        color: color-mix(in srgb, var(--bg) 86%, #000000 14%);
        z-index: 2;
        filter: drop-shadow(0 1px 0 rgba(255, 255, 255, 0.22))
          drop-shadow(0 2px 6px rgba(15, 23, 42, 0.28));
      }
      .logo-icon path {
        stroke-width: 2;
      }
      @keyframes logoSpin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      /* ------------------------------
      PREMIUM SCHEDULE GRID (SUPER)
    ------------------------------ */
      .schedule-shell {
        border-radius: 24px;
        overflow: hidden;
        padding: 1px;
        background: linear-gradient(
          140deg,
          color-mix(in srgb, var(--accent) 38%, transparent),
          transparent 28%,
          color-mix(in srgb, var(--accent2) 36%, transparent)
        );
      }
      .schedule-grid {
        display: grid;
        grid-template-columns: 106px repeat(6, minmax(190px, 1fr));
        gap: 1px;
        overflow: auto;
        background: color-mix(in srgb, var(--border) 55%, transparent);
        border-radius: 24px;
        position: relative;
        border: 1px solid color-mix(in srgb, var(--border) 75%, transparent);
        box-shadow:
          inset 0 1px 0 rgba(255, 255, 255, 0.07),
          inset 0 -1px 0 rgba(0, 0, 0, 0.15);
      }

      /* stronger "premium" frame */
      .schedule-frame {
        position: relative;
        border-radius: 24px;
        overflow: hidden;
      }
      .schedule-frame::before {
        content: "";
        position: absolute;
        inset: -1px;
        background: linear-gradient(
          135deg,
          color-mix(in srgb, var(--accent) 60%, transparent),
          transparent 35%,
          color-mix(in srgb, var(--accent2) 55%, transparent)
        );
        opacity: 0.22;
        filter: blur(0px);
        pointer-events: none;
      }
      .schedule-frame::after {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: 24px;
        box-shadow:
          0 26px 90px rgba(0, 0, 0, 0.35),
          inset 0 1px 0 rgba(255, 255, 255, 0.1);
        pointer-events: none;
      }

      .grid-header,
      .grid-cell {
        background: var(--card-bg);
        padding: 12px;
        min-height: 132px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        position: relative;
      }

      .grid-header {
        min-height: 60px;
        align-items: center;
        justify-content: center;
        font-weight: 900;
        text-shadow: 0 1px 0 rgba(0, 0, 0, 0.16);
        background:
          radial-gradient(
            900px 70px at 50% 0%,
            rgba(255, 255, 255, 0.1),
            transparent 70%
          ),
          linear-gradient(180deg, rgba(0, 0, 0, 0.2), rgba(0, 0, 0, 0.06));
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        z-index: 6;
      }
      .grid-header::after {
        content: "";
        position: absolute;
        right: 10px;
        left: 10px;
        bottom: 0;
        height: 1px;
        background: linear-gradient(
          90deg,
          transparent,
          color-mix(in srgb, var(--accent2) 45%, transparent),
          transparent
        );
        opacity: 0.7;
      }
      body[data-theme="mono"] .grid-header,
      body[data-theme="editorial"] .grid-header,
      body[data-theme="material"] .grid-header {
        background: rgba(255, 255, 255, 0.9);
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      }

      .sticky-top {
        position: sticky;
        top: 0;
        z-index: 8;
      }
      .time-col {
        position: sticky;
        right: 0;
        z-index: 9;
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
      }

      .time-slot {
        min-height: 132px;
        align-items: center;
        justify-content: center;
        font-family: var(--font-en);
        font-variant-numeric: tabular-nums;
        font-weight: 900;
        font-size: 12px;
        letter-spacing: 0.02em;
        border-left: 1px solid rgba(255, 255, 255, 0.06);
        background:
          radial-gradient(
            700px 120px at 50% 10%,
            rgba(255, 255, 255, 0.1),
            transparent 70%
          ),
          linear-gradient(
            180deg,
            rgba(255, 255, 255, 0.06),
            rgba(255, 255, 255, 0.02)
          );
      }
      body[data-theme="mono"] .time-slot,
      body[data-theme="editorial"] .time-slot,
      body[data-theme="material"] .time-slot {
        border-left: 1px solid rgba(0, 0, 0, 0.08);
        background: rgba(255, 255, 255, 0.9);
      }

      .grid-cell {
        cursor: pointer;
        isolation: isolate;
        transition:
          transform 0.12s ease,
          filter 0.18s ease,
          background-color 0.2s ease;
        background:
          radial-gradient(
            700px 220px at 40% 0%,
            rgba(255, 255, 255, 0.08),
            transparent 70%
          ),
          linear-gradient(
            180deg,
            rgba(255, 255, 255, 0.04),
            rgba(255, 255, 255, 0.02)
          );
      }
      body[data-theme="mono"] .grid-cell,
      body[data-theme="editorial"] .grid-cell,
      body[data-theme="material"] .grid-cell {
        background: rgba(255, 255, 255, 0.88);
      }

      /* row/col highlight */
      .grid-cell::after {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.22s ease;
        background: radial-gradient(
          700px 260px at 50% 15%,
          color-mix(in srgb, var(--accent) 20%, transparent),
          transparent 70%
        );
      }
      .grid-cell.hl::after {
        opacity: 1;
      }
      .grid-cell:hover {
        transform: translateY(-1px);
        filter: brightness(1.06);
      }

      /* "+ add" hint on empty cell hover */
      .grid-cell .add-ghost {
        position: absolute;
        left: 10px;
        bottom: 10px;
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 900;
        opacity: 0;
        transform: translateY(4px);
        transition:
          opacity 0.18s ease,
          transform 0.18s ease;
        border: 1px dashed color-mix(in srgb, var(--accent) 55%, transparent);
        background: color-mix(in srgb, var(--card-bg) 80%, transparent);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }
      .grid-cell:hover .add-ghost {
        opacity: 0.85;
        transform: translateY(0);
      }

      /* class card (premium) */
      .class-card {
        position: relative;
        border-radius: 18px;
        padding: 12px 12px 10px;
        overflow: hidden;
        border: 1px solid color-mix(in srgb, var(--border) 65%, transparent);
        background:
          radial-gradient(
            700px 220px at 20% 0%,
            rgba(255, 255, 255, 0.12),
            transparent 60%
          ),
          linear-gradient(180deg, rgba(0, 0, 0, 0.22), rgba(0, 0, 0, 0.1));
        backdrop-filter: blur(14px);
        -webkit-backdrop-filter: blur(14px);
        box-shadow:
          0 8px 20px rgba(0, 0, 0, 0.2),
          inset 0 1px 0 rgba(255, 255, 255, 0.12);
        transition:
          transform 0.12s ease,
          filter 0.18s ease,
          border-color 0.18s ease;
      }
      body[data-theme="mono"] .class-card,
      body[data-theme="editorial"] .class-card,
      body[data-theme="material"] .class-card {
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(0, 0, 0, 0.1);
      }

      .class-card::before {
        content: "";
        position: absolute;
        inset: -1px;
        background: linear-gradient(
          135deg,
          color-mix(in srgb, var(--accent) 30%, transparent),
          transparent 35%,
          color-mix(in srgb, var(--accent2) 26%, transparent)
        );
        opacity: 0.35;
        pointer-events: none;
      }
      .class-card::after {
        content: "";
        position: absolute;
        inset: 0;
        background: radial-gradient(
          800px 200px at 20% 0%,
          rgba(255, 255, 255, 0.12),
          transparent 60%
        );
        opacity: 0.7;
        pointer-events: none;
      }
      .class-card:hover {
        transform: translateY(-1px) scale(1.012);
        border-color: color-mix(in srgb, var(--accent) 35%, var(--border));
        filter: brightness(1.05);
      }
      .class-title {
        font-weight: 950;
        font-size: 12.5px;
        line-height: 1.5;
        position: relative;
        z-index: 1;
      }
      .class-meta {
        font-size: 10.5px;
        opacity: 0.82;
        position: relative;
        z-index: 1;
      }
      .class-foot {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-top: 10px;
        position: relative;
        z-index: 1;
      }

      /* Mobile schedule cards */
      .mobile-schedule-board {
        display: grid;
        gap: 14px;
      }
      .mobile-schedule-board .schedule-hint {
        margin-bottom: 2px;
      }
      .mobile-day-card {
        position: relative;
        padding: 14px;
        border-radius: 22px;
        border: 1px solid color-mix(in srgb, var(--border) 78%, transparent);
        background:
          linear-gradient(
            165deg,
            color-mix(in srgb, var(--accent) 12%, transparent),
            transparent 42%,
            color-mix(in srgb, var(--accent2) 10%, transparent)
          ),
          color-mix(in srgb, var(--card-bg) 88%, transparent);
        overflow: hidden;
      }
      .mobile-day-card::before {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        border-radius: inherit;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.12),
          rgba(255, 255, 255, 0) 36%
        );
        opacity: 0.72;
      }
      .mobile-day-card--today {
        border-color: color-mix(in srgb, var(--accent) 52%, var(--border));
        box-shadow:
          0 16px 36px rgba(0, 0, 0, 0.24),
          inset 0 0 0 1px color-mix(in srgb, var(--accent2) 24%, transparent);
      }
      .mobile-day-head {
        position: relative;
        z-index: 1;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 10px;
      }
      .mobile-day-title-wrap {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .mobile-day-title {
        font-size: 1rem;
        font-weight: 950;
        letter-spacing: 0.01em;
      }
      .mobile-today-pill {
        border-radius: 999px;
        padding: 2px 8px;
        font-size: 10px;
        font-weight: 900;
        border: 1px solid color-mix(in srgb, var(--accent2) 46%, transparent);
        background: color-mix(in srgb, var(--accent) 18%, transparent);
      }
      .mobile-day-head-right {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .mobile-add-btn {
        border: 1px solid color-mix(in srgb, var(--accent) 42%, var(--border));
        background: color-mix(in srgb, var(--card-bg) 78%, transparent);
        color: var(--text);
        border-radius: 999px;
        font-size: 11px;
        font-weight: 900;
        padding: 6px 11px;
        transition:
          transform 0.14s ease,
          filter 0.18s ease;
      }
      .mobile-add-btn:active {
        transform: scale(0.98);
      }
      .mobile-day-meta {
        position: relative;
        z-index: 1;
        margin-bottom: 8px;
      }
      .mobile-day-classes {
        position: relative;
        z-index: 1;
        display: grid;
        gap: 10px;
      }
      .mobile-day-classes::before {
        content: "";
        position: absolute;
        top: 4px;
        bottom: 4px;
        right: 4px;
        width: 2px;
        border-radius: 999px;
        background: linear-gradient(
          180deg,
          color-mix(in srgb, var(--accent2) 36%, transparent),
          transparent 88%
        );
        opacity: 0.7;
        pointer-events: none;
      }
      .mobile-empty-slot {
        width: 100%;
        border: 1px dashed color-mix(in srgb, var(--accent2) 48%, var(--border));
        background: color-mix(in srgb, var(--card-bg) 70%, transparent);
        color: var(--text);
        border-radius: 14px;
        font-size: 12px;
        font-weight: 900;
        padding: 10px 12px;
        text-align: center;
        opacity: 0.9;
      }
      .mobile-class-card {
        position: relative;
        border: 1px solid color-mix(in srgb, var(--border) 76%, transparent);
        background:
          radial-gradient(
            700px 180px at 20% 0%,
            rgba(255, 255, 255, 0.1),
            transparent 65%
          ),
          color-mix(in srgb, var(--card-bg) 84%, transparent);
        border-radius: 16px;
        padding: 11px 11px 11px 14px;
        transition:
          transform 0.12s ease,
          filter 0.18s ease;
        overflow: hidden;
      }
      .mobile-class-card::before {
        content: "";
        position: absolute;
        top: 10px;
        bottom: 10px;
        right: 0;
        width: 3px;
        border-radius: 999px;
        background: color-mix(in srgb, var(--accent2) 76%, transparent);
        opacity: 0.8;
      }
      .mobile-class-card::after {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.18),
          rgba(255, 255, 255, 0) 34%
        );
        opacity: 0.55;
      }
      .mobile-class-card.is-now {
        border-color: color-mix(in srgb, var(--accent) 64%, var(--border));
        box-shadow:
          0 14px 26px rgba(0, 0, 0, 0.24),
          0 0 0 1px color-mix(in srgb, var(--accent2) 28%, transparent) inset;
      }
      .mobile-class-card.is-upcoming {
        border-color: color-mix(in srgb, var(--accent2) 48%, var(--border));
      }
      .mobile-class-card.is-past {
        opacity: 0.8;
      }
      .mobile-class-card:active {
        transform: scale(0.992);
      }
      .mobile-class-top {
        position: relative;
        z-index: 1;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        margin-bottom: 6px;
      }
      .mobile-class-time {
        font-family: var(--font-en);
        font-size: 11px;
        font-weight: 900;
        opacity: 0.92;
        border: 1px solid color-mix(in srgb, var(--border) 68%, transparent);
        border-radius: 999px;
        padding: 2px 7px;
      }
      .mobile-class-title {
        position: relative;
        z-index: 1;
        font-size: 12.5px;
        font-weight: 950;
        line-height: 1.45;
      }
      .mobile-class-prof {
        position: relative;
        z-index: 1;
        font-size: 10.5px;
        opacity: 0.76;
        margin-top: 2px;
      }
      .mobile-class-note {
        position: relative;
        z-index: 1;
        font-size: 10px;
        opacity: 0.78;
        margin-top: 4px;
      }
      .mobile-class-foot {
        position: relative;
        z-index: 1;
        margin-top: 8px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }
      .mobile-state-chip {
        border-radius: 999px;
        padding: 2px 9px;
        font-size: 10px;
        font-weight: 900;
        border: 1px solid color-mix(in srgb, var(--border) 70%, transparent);
        background: color-mix(in srgb, var(--card-bg) 80%, transparent);
      }
      .mobile-state-chip.state-now {
        border-color: color-mix(in srgb, var(--accent) 62%, transparent);
        background: color-mix(in srgb, var(--accent) 18%, transparent);
      }
      .mobile-state-chip.state-upcoming {
        border-color: color-mix(in srgb, var(--accent2) 52%, transparent);
        background: color-mix(in srgb, var(--accent2) 16%, transparent);
      }
      .mobile-state-chip.state-past {
        opacity: 0.75;
      }
      .mobile-class-unit {
        font-size: 10px;
        font-weight: 900;
        opacity: 0.76;
      }
      .mobile-class-conflict {
        position: relative;
        z-index: 1;
        margin-top: 6px;
        color: #ef4444;
        font-size: 10px;
        font-weight: 900;
      }

      /* mobile */
      @media (max-width: 1024px) {
        .schedule-grid {
          display: flex;
          flex-direction: column;
          gap: 14px;
          background: transparent;
          border-radius: 0;
        }
        .grid-header {
          display: none;
        }
        .grid-cell {
          border-radius: 18px;
          min-height: auto;
        }
        .time-col {
          position: static;
        }
        .time-slot {
          border-radius: 18px;
          border-left: none;
        }
        .mobile-day-header {
          display: block;
          font-size: 1.05rem;
          font-weight: 950;
          margin-bottom: 0.5rem;
        }
        .grid-cell .add-ghost {
          display: none;
        }
        .schedule-frame::before,
        .schedule-frame::after {
          display: none;
        }
      }
      @media (min-width: 1024px) {
        .mobile-day-header {
          display: none;
        }
      }

      /* ------------------------------
      UI Mode Switch (Auto/Desktop/Mobile)
    ------------------------------ */
      body[data-ui-mode="mobile"] #appLayout {
        max-width: 820px;
        gap: 14px;
        padding: 10px;
      }
      body[data-ui-mode="mobile"] .top-nav,
      body[data-ui-mode="mobile"] #sidePanel,
      body[data-ui-mode="mobile"] #mainPanel {
        grid-column: 1 / -1 !important;
      }
      body[data-ui-mode="mobile"] .top-nav {
        top: 8px;
        padding: 0.75rem;
      }
      body[data-ui-mode="mobile"] .pinned-alerts-bar {
        top: 72px;
        width: calc(100% - 14px);
      }
      body[data-ui-mode="mobile"].has-pinned-alerts #appLayout {
        margin-top: 64px;
      }
      body[data-ui-mode="mobile"] .top-nav > div:last-child {
        width: 100%;
        gap: 0.5rem;
      }
      body[data-ui-mode="mobile"] .top-nav .week-toggle {
        width: 100%;
        justify-content: space-between;
      }
      body[data-ui-mode="mobile"] .top-nav .premium-select,
      body[data-ui-mode="mobile"] .top-nav .control-surface {
        flex: 1 1 calc(50% - 0.5rem);
        min-width: 122px;
      }
      body[data-ui-mode="mobile"] .top-nav .control-btn {
        flex: 0 0 auto;
      }
      body[data-ui-mode="mobile"] .top-nav .sync-auth-btn,
      body[data-ui-mode="mobile"] .top-nav .anim-status-btn {
        flex: 1 1 calc(50% - 0.5rem);
        min-width: 122px;
      }
      body[data-ui-mode="mobile"] .notify-bell-btn {
        min-height: 42px;
        min-width: 92px;
        justify-content: center;
        padding: 0 10px;
      }
      body[data-ui-mode="mobile"] .side-widget {
        height: auto !important;
      }
      body[data-ui-mode="mobile"] #examList,
      body[data-ui-mode="mobile"] #noteList,
      body[data-ui-mode="mobile"] #alertList,
      body[data-ui-mode="mobile"] #handoutList,
      body[data-ui-mode="mobile"] #courseProgressList {
        max-height: 240px;
      }
      body[data-ui-mode="mobile"] .schedule-grid {
        display: flex;
        flex-direction: column;
        gap: 14px;
        background: transparent;
        border-radius: 0;
      }
      body[data-ui-mode="mobile"] .grid-header {
        display: none;
      }
      body[data-ui-mode="mobile"] .grid-cell {
        border-radius: 18px;
        min-height: auto;
      }
      body[data-ui-mode="mobile"] .time-col {
        position: static;
      }
      body[data-ui-mode="mobile"] .time-slot {
        border-radius: 18px;
        border-left: none;
      }
      body[data-ui-mode="mobile"] .mobile-day-header {
        display: block;
        font-size: 1.05rem;
        font-weight: 950;
        margin-bottom: 0.5rem;
      }
      body[data-ui-mode="mobile"] .grid-cell .add-ghost {
        display: none;
      }
      body[data-ui-mode="mobile"] .schedule-frame::before,
      body[data-ui-mode="mobile"] .schedule-frame::after {
        display: none;
      }

      body[data-ui-mode="desktop"] {
        overflow-x: auto;
      }
      body[data-ui-mode="desktop"] #appLayout {
        min-width: 1240px;
      }
      body[data-ui-mode="desktop"] #sidePanel {
        grid-column: span 3 / span 3 !important;
      }
      body[data-ui-mode="desktop"] #mainPanel {
        grid-column: span 9 / span 9 !important;
      }
      body[data-ui-mode="desktop"] .schedule-grid {
        display: grid !important;
        grid-template-columns: 106px repeat(6, minmax(190px, 1fr));
        gap: 1px;
        background: color-mix(in srgb, var(--border) 55%, transparent);
        border-radius: 24px;
      }
      body[data-ui-mode="desktop"] .grid-header {
        display: flex !important;
      }
      body[data-ui-mode="desktop"] .grid-cell {
        min-height: 132px;
        border-radius: 0;
      }
      body[data-ui-mode="desktop"] .time-col {
        position: sticky;
        right: 0;
      }
      body[data-ui-mode="desktop"] .time-slot {
        border-radius: 0;
        border-left: 1px solid rgba(255, 255, 255, 0.06);
      }
      body[data-theme="mono"][data-ui-mode="desktop"] .time-slot,
      body[data-theme="editorial"][data-ui-mode="desktop"] .time-slot,
      body[data-theme="material"][data-ui-mode="desktop"] .time-slot {
        border-left: 1px solid rgba(0, 0, 0, 0.08);
      }
      body[data-ui-mode="desktop"] .mobile-day-header {
        display: none !important;
      }
      body[data-ui-mode="desktop"] .grid-cell .add-ghost {
        display: block;
      }
      body[data-ui-mode="desktop"] .schedule-frame::before,
      body[data-ui-mode="desktop"] .schedule-frame::after {
        display: block;
      }

      /* ------------------------------
      Premium polish overrides
    ------------------------------ */
      .theme-card {
        border: 1px solid color-mix(in srgb, var(--border) 72%, transparent);
        box-shadow:
          0 20px 52px rgba(0, 0, 0, 0.24),
          inset 0 1px 0 rgba(255, 255, 255, 0.11);
      }
      .theme-card::after {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        border-radius: inherit;
        border: 1px solid color-mix(in srgb, var(--accent2) 24%, transparent);
        opacity: 0.4;
        z-index: 0;
      }
      .theme-card:hover {
        transform: translateY(-2px);
        box-shadow:
          0 28px 70px rgba(0, 0, 0, 0.3),
          inset 0 1px 0 rgba(255, 255, 255, 0.14);
      }
      nav.theme-card:hover {
        transform: none;
      }
      aside .theme-card {
        border-radius: 24px;
        backdrop-filter: blur(18px);
        -webkit-backdrop-filter: blur(18px);
      }
      aside .theme-card h3,
      aside .theme-card h4 {
        letter-spacing: 0.01em;
        text-shadow: 0 1px 0 rgba(0, 0, 0, 0.12);
      }
      .next-class-card {
        border-color: color-mix(in srgb, var(--accent2) 36%, var(--border));
        background:
          radial-gradient(
            640px 180px at 12% -8%,
            color-mix(in srgb, var(--accent) 18%, transparent),
            transparent 68%
          ),
          linear-gradient(
            160deg,
            color-mix(in srgb, var(--card-bg) 93%, transparent),
            color-mix(in srgb, var(--card-bg) 78%, transparent)
          ) !important;
        box-shadow:
          0 20px 44px rgba(0, 0, 0, 0.26),
          inset 0 1px 0 rgba(255, 255, 255, 0.16);
      }
      .next-class-card::before {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        border-radius: inherit;
        background: linear-gradient(
          125deg,
          rgba(255, 255, 255, 0.24),
          rgba(255, 255, 255, 0) 38%
        );
        opacity: 0.7;
      }
      #nextClassContainer .next-premium-shell {
        position: relative;
        z-index: 1;
      }
      #nextClassContainer h3 {
        font-size: 1.3rem;
        margin-top: 2px;
        text-shadow: 0 0 16px
          color-mix(in srgb, var(--accent2) 22%, transparent);
      }
      #nextClassContainer .next-live-meta {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border-radius: 999px;
        padding: 5px 11px;
        margin-bottom: 10px;
        border: 1px solid color-mix(in srgb, var(--border) 76%, transparent);
        background: color-mix(in srgb, var(--card-bg) 82%, transparent);
        font-size: 11px;
        font-weight: 900;
      }
      #nextClassContainer .next-now-chip {
        border-radius: 999px;
        padding: 2px 8px;
        background: color-mix(in srgb, var(--accent2) 20%, transparent);
        border: 1px solid color-mix(in srgb, var(--accent2) 44%, transparent);
        font-size: 10px;
      }
      #nextClassContainer .next-course-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }
      #nextClassContainer .next-status-pill {
        border-radius: 999px;
        padding: 3px 9px;
        border: 1px solid color-mix(in srgb, var(--accent2) 44%, transparent);
        background: color-mix(in srgb, var(--accent2) 18%, transparent);
        font-size: 10px;
        font-weight: 900;
        white-space: nowrap;
      }
      #nextClassContainer .next-status-pill--session {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        box-shadow:
          0 8px 18px rgba(2, 6, 23, 0.2),
          inset 0 1px 0 rgba(255, 255, 255, 0.22);
        border-color: color-mix(in srgb, var(--accent2) 56%, transparent);
      }
      #nextClassContainer .next-status-pill--soon {
        border-color: rgba(249, 115, 22, 0.62);
        background: rgba(249, 115, 22, 0.2);
        color: #ffedd5;
      }
      #nextClassContainer .next-status-pill--mid {
        border-color: rgba(14, 165, 233, 0.56);
        background: rgba(14, 165, 233, 0.18);
      }
      #nextClassContainer .next-status-pill--far {
        border-color: rgba(16, 185, 129, 0.56);
        background: rgba(16, 185, 129, 0.18);
      }
      #nextClassContainer .next-status-pill--session-ok {
        border-color: rgba(14, 165, 233, 0.58);
        background: rgba(14, 165, 233, 0.2);
      }
      #nextClassContainer .next-status-pill--session-pending {
        border-color: rgba(245, 158, 11, 0.62);
        background: rgba(245, 158, 11, 0.24);
        color: #fef3c7;
      }
      #nextClassContainer .next-status-pill--session-missing {
        border-color: rgba(249, 115, 22, 0.68);
        background: rgba(249, 115, 22, 0.24);
        color: #ffedd5;
      }
      #nextClassContainer .next-session-warning {
        margin-top: 8px;
        border-radius: 12px;
        border: 1px dashed color-mix(in srgb, var(--border) 72%, transparent);
        padding: 7px 9px;
        font-size: 10px;
        line-height: 1.7;
      }
      #nextClassContainer .next-session-warning--missing {
        border-color: rgba(249, 115, 22, 0.62);
        color: #fdba74;
      }
      #nextClassContainer .next-session-warning--pending {
        border-color: rgba(245, 158, 11, 0.62);
        color: #fde68a;
      }
      #nextClassContainer .next-prof-line {
        font-size: 12px;
        margin-top: 4px;
        margin-bottom: 8px;
        color: var(--muted);
      }
      #nextClassContainer .next-note-line {
        margin-top: 0;
        margin-bottom: 10px;
        font-size: 11px;
        line-height: 1.72;
        color: var(--muted);
      }
      #nextClassContainer .next-chip-row {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }
      #nextClassContainer .next-chip-row .chip {
        border-color: color-mix(in srgb, var(--accent2) 38%, var(--border));
        background: color-mix(in srgb, var(--card-bg) 82%, transparent);
      }
      #nextClassContainer .next-class-no-wrap {
        margin-top: 9px;
        margin-bottom: 10px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border-radius: 14px;
        padding: 6px 10px;
        border: 1px solid rgba(56, 189, 248, 0.58);
        background: linear-gradient(
          125deg,
          rgba(6, 182, 212, 0.34),
          rgba(37, 99, 235, 0.28)
        );
        box-shadow:
          0 10px 20px rgba(8, 47, 73, 0.3),
          inset 0 1px 0 rgba(255, 255, 255, 0.2);
      }
      #nextClassContainer .next-class-no-label {
        font-size: 10px;
        font-weight: 900;
        color: #e0f2fe;
      }
      #nextClassContainer .next-class-no-badge {
        font-family: var(--font-time);
        font-size: 1rem;
        font-weight: 800;
        letter-spacing: 0.04em;
        color: #ecfeff;
        border-radius: 999px;
        padding: 4px 11px;
        border: 1px solid rgba(125, 211, 252, 0.5);
        background: rgba(15, 23, 42, 0.35);
      }
      #nextClassContainer .next-time-panel {
        margin-top: 8px;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        border-radius: 14px;
        padding: 7px 10px;
        border: 1px solid color-mix(in srgb, var(--accent2) 44%, transparent);
        background: color-mix(in srgb, var(--card-bg) 82%, transparent);
      }
      #nextClassContainer .next-time-clock {
        font-family: var(--font-time);
        font-size: 1.16rem;
        letter-spacing: 0.04em;
        font-weight: 700;
        border-radius: 10px;
        padding: 4px 9px;
        border: 1px solid color-mix(in srgb, var(--accent) 42%, transparent);
        background: linear-gradient(
          130deg,
          color-mix(in srgb, var(--accent) 24%, transparent),
          color-mix(in srgb, var(--accent2) 16%, transparent)
        );
      }
      #nextClassContainer .next-time-date {
        font-size: 11px;
        opacity: 0.84;
      }
      #nextClassContainer .next-minute-left {
        margin-top: 9px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        border-radius: 16px;
        padding: 8px 10px;
        border: 1px solid color-mix(in srgb, var(--accent2) 46%, transparent);
        background: linear-gradient(
          122deg,
          rgba(2, 12, 24, 0.88),
          rgba(3, 26, 44, 0.82) 52%,
          rgba(6, 44, 68, 0.78)
        );
        box-shadow:
          0 12px 26px rgba(2, 12, 24, 0.36),
          inset 0 1px 0 rgba(255, 255, 255, 0.15);
        white-space: nowrap;
      }
      #nextClassContainer .next-minute-caption {
        opacity: 0.88;
        font-size: 10px;
        font-weight: 900;
        letter-spacing: 0.01em;
        flex: 0 0 auto;
      }
      #nextClassContainer .next-minute-digital {
        margin-inline-start: auto;
        display: inline-flex;
        align-items: center;
        gap: 7px;
        direction: ltr;
        white-space: nowrap;
      }
      #nextClassContainer .next-minute-digital.is-compact {
        gap: 5px;
      }
      #nextClassContainer .next-flip-track {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        perspective: 360px;
      }
      #nextClassContainer .next-minute-digital.is-compact .next-flip-track {
        gap: 3px;
      }
      #nextClassContainer .next-flip-digit {
        position: relative;
        width: 30px;
        height: 42px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        border: 1px solid rgba(148, 163, 184, 0.38);
        background: linear-gradient(
          180deg,
          rgba(16, 23, 36, 0.98) 0%,
          rgba(2, 8, 18, 0.96) 100%
        );
        box-shadow:
          0 8px 18px rgba(0, 0, 0, 0.48),
          inset 0 1px 0 rgba(255, 255, 255, 0.09);
        overflow: hidden;
      }
      #nextClassContainer .next-flip-digit::before {
        content: "";
        position: absolute;
        inset: 0 0 50% 0;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.14),
          rgba(255, 255, 255, 0)
        );
        pointer-events: none;
      }
      #nextClassContainer .next-flip-digit::after {
        content: "";
        position: absolute;
        left: 0;
        right: 0;
        top: 50%;
        height: 1px;
        background: rgba(148, 163, 184, 0.34);
        box-shadow: 0 1px 0 rgba(0, 0, 0, 0.55);
        pointer-events: none;
      }
      #nextClassContainer .next-flip-digit__num {
        font-family: var(--font-time);
        font-size: 1.36rem;
        line-height: 1;
        font-weight: 700;
        letter-spacing: 0.01em;
        color: #e2e8f0;
        text-shadow: 0 2px 8px rgba(2, 6, 23, 0.68);
        transform: translateY(1px);
      }
      #nextClassContainer .next-minute-unit {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 34px;
        height: 20px;
        border-radius: 999px;
        padding: 0 8px;
        border: 1px solid rgba(56, 189, 248, 0.44);
        background: linear-gradient(
          130deg,
          rgba(14, 165, 233, 0.26),
          rgba(6, 182, 212, 0.16)
        );
        font-family: var(--font-en);
        font-size: 9px;
        font-weight: 900;
        letter-spacing: 0.08em;
        color: #e0f2fe;
      }
      #nextClassContainer .next-urgency-track {
        direction: ltr;
        position: relative;
        isolation: isolate;
        margin-top: 7px;
        width: 100%;
        height: 8px;
        border-radius: 999px;
        border: 1px solid color-mix(in srgb, var(--accent2) 36%, transparent);
        background: color-mix(in srgb, var(--card-bg) 78%, transparent);
        overflow: hidden;
      }
      #nextClassContainer .next-urgency-fill {
        display: block;
        height: 100%;
        border-radius: inherit;
        min-width: 0%;
        max-width: 100%;
        background: linear-gradient(
          90deg,
          #f59e0b 0%,
          #06b6d4 52%,
          #22c55e 100%
        );
        box-shadow: 0 0 14px rgba(14, 165, 233, 0.45);
        transition: width 440ms cubic-bezier(0.22, 1, 0.36, 1);
      }
      #nextClassContainer .next-urgency-note {
        margin-top: 6px;
        font-size: 10px;
        opacity: 0.78;
      }
      #nextClassContainer .next-next-at {
        margin-top: 8px;
        font-size: 11px;
        opacity: 0.84;
      }
      #nextClassContainer .next-countdown {
        margin-top: 10px;
        display: inline-block;
        border-radius: 999px;
        padding: 4px 10px;
        border: 1px solid color-mix(in srgb, var(--accent) 46%, transparent);
        background: color-mix(in srgb, var(--accent) 15%, transparent);
        font-size: 11px;
        font-weight: 900;
      }
      #nextClassContainer .next-empty-state {
        margin-top: 8px;
        border-radius: 12px;
        border: 1px dashed color-mix(in srgb, var(--border) 76%, transparent);
        background: color-mix(in srgb, var(--card-bg) 82%, transparent);
        padding: 10px;
        font-size: 12px;
        font-weight: 800;
        opacity: 0.8;
      }
      .pinned-alerts-bar {
        position: fixed;
        top: 86px;
        left: 50%;
        transform: translateX(-50%);
        width: min(980px, calc(100% - 20px));
        z-index: 45;
        display: flex;
        flex-direction: column;
        gap: 8px;
        pointer-events: none;
      }
      .pinned-alerts-bar.hidden {
        display: none !important;
      }
      .pinned-alert-item {
        width: 100%;
        appearance: none;
        text-align: right;
        color: var(--text);
        pointer-events: auto;
        border-radius: 16px;
        border: 1px solid rgba(239, 68, 68, 0.36);
        background: linear-gradient(
          145deg,
          rgba(239, 68, 68, 0.2),
          rgba(185, 28, 28, 0.08) 40%,
          color-mix(in srgb, var(--card-bg) 84%, transparent)
        );
        backdrop-filter: blur(14px);
        -webkit-backdrop-filter: blur(14px);
        box-shadow:
          0 12px 28px rgba(0, 0, 0, 0.26),
          inset 0 1px 0 rgba(255, 255, 255, 0.14);
        padding: 10px 14px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 14px;
      }
      .pinned-alert-item--note {
        border-color: rgba(239, 68, 68, 0.5);
      }
      .pinned-alert-main-btn {
        width: 100%;
        min-width: 0;
        appearance: none;
        border: 0;
        background: transparent;
        color: inherit;
        text-align: right;
        padding: 0;
        cursor: pointer;
      }
      .pinned-alert-main-btn:focus-visible {
        outline: 2px solid color-mix(in srgb, var(--accent2) 56%, transparent);
        outline-offset: 3px;
        border-radius: 10px;
      }
      .pinned-alert-main {
        min-width: 0;
        display: flex;
        flex-direction: column;
      }
      .pinned-alert-title {
        display: block;
        font-size: 13px;
        font-weight: 900;
        line-height: 1.65;
      }
      .pinned-alert-sub {
        display: block;
        margin-top: 3px;
        font-size: 11px;
        opacity: 0.9;
      }
      .pinned-alert-icon {
        flex: 0 0 auto;
        width: 26px;
        height: 26px;
        border-radius: 999px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 13px;
        border: 1px solid rgba(239, 68, 68, 0.42);
        background: rgba(239, 68, 68, 0.16);
      }
      .pinned-alert-item--food {
        border-color: rgba(220, 38, 38, 0.56);
        background: linear-gradient(
          145deg,
          rgba(248, 113, 113, 0.32),
          rgba(239, 68, 68, 0.2) 42%,
          rgba(127, 29, 29, 0.18)
        );
        border-radius: 18px;
        padding: 13px 16px;
        box-shadow:
          0 14px 30px rgba(127, 29, 29, 0.28),
          inset 0 1px 0 rgba(255, 255, 255, 0.22);
      }
      .pinned-alert-item--food .pinned-alert-title {
        font-size: 15px;
        line-height: 1.5;
      }
      .pinned-alert-item--food .pinned-alert-sub {
        font-size: 12px;
        margin-top: 4px;
        opacity: 0.9;
      }
      .pinned-alert-actions {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        flex: 0 0 auto;
      }
      .pinned-alert-icon--food {
        width: 34px;
        height: 34px;
        font-size: 17px;
        border-color: rgba(220, 38, 38, 0.64);
        background: rgba(220, 38, 38, 0.28);
      }
      .pinned-alert-close {
        width: 30px;
        height: 30px;
        border-radius: 999px;
        border: 1px solid rgba(248, 113, 113, 0.58);
        background: rgba(127, 29, 29, 0.2);
        color: #fee2e2;
        font-size: 20px;
        line-height: 1;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }
      .pinned-alert-close:hover {
        background: rgba(127, 29, 29, 0.36);
      }
      body.has-pinned-alerts #appLayout {
        margin-top: 58px;
      }
      #examList > div,
      #noteList > div,
      #alertList > div,
      #handoutList > div,
      #courseProgressList > div {
        position: relative;
        overflow: hidden;
        border-radius: 18px !important;
        border: 1px solid color-mix(in srgb, var(--border) 82%, transparent) !important;
        box-shadow:
          0 10px 26px rgba(0, 0, 0, 0.2),
          inset 0 1px 0 rgba(255, 255, 255, 0.1);
        transition:
          transform 0.16s ease,
          box-shadow 0.2s ease,
          border-color 0.2s ease;
      }
      #alertList .alert-card-title {
        font-size: 13px;
        line-height: 1.7;
        font-weight: 900;
      }
      #alertList .alert-card-meta {
        font-size: 11px;
        line-height: 1.65;
        opacity: 0.9;
      }
      #alertList .alert-card-highlight {
        font-size: 12px;
        line-height: 1.75;
        font-weight: 800;
      }
      .exam-widget {
        min-height: 340px;
        height: min(52vh, 440px);
        overflow: hidden;
      }
      .exam-widget-head {
        flex: 0 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        margin-bottom: 12px;
      }
      .exam-widget-add-btn {
        width: 34px;
        height: 34px;
        border-radius: 999px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: 1px solid color-mix(in srgb, var(--accent2) 28%, var(--border));
        background:
          radial-gradient(
            130% 130% at 25% 20%,
            color-mix(in srgb, var(--accent2) 28%, transparent),
            transparent 56%
          ),
          var(--accent);
        color: var(--bg);
        font-size: 21px;
        font-weight: 900;
        line-height: 1;
        box-shadow:
          0 10px 18px rgba(0, 0, 0, 0.18),
          inset 0 1px 0 rgba(255, 255, 255, 0.22);
        transition:
          transform 0.16s ease,
          filter 0.16s ease;
      }
      .exam-widget-add-btn:hover {
        transform: translateY(-1px) scale(1.04);
        filter: brightness(1.04);
      }
      .exam-widget-scroll {
        min-height: 0;
        flex: 1 1 auto;
        overflow-y: auto;
        overscroll-behavior-y: contain;
        scrollbar-gutter: stable;
        padding-inline-end: 6px;
      }
      .exam-widget-scroll::-webkit-scrollbar {
        width: 8px;
      }
      .exam-widget-scroll::-webkit-scrollbar-track {
        background: color-mix(in srgb, var(--card-bg) 80%, transparent);
        border-radius: 999px;
      }
      .exam-widget-scroll::-webkit-scrollbar-thumb {
        background: color-mix(in srgb, var(--accent2) 40%, var(--border));
        border-radius: 999px;
      }
      #examList .exam-card {
        padding: 12px;
      }
      #examList .exam-card-head {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 10px;
      }
      #examList .exam-card-title {
        font-size: 13px;
        line-height: 1.7;
        font-weight: 900;
        flex: 1;
        min-width: 0;
      }
      #examList .exam-course-chip {
        font-size: 10px;
        line-height: 1.4;
        padding: 3px 8px;
        border-radius: 999px;
        border: 1px solid color-mix(in srgb, var(--accent2) 40%, var(--border));
        background: color-mix(in srgb, var(--accent2) 16%, transparent);
        max-width: 46%;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      #examList .exam-meta-row {
        margin-top: 6px;
        font-size: 11px;
        line-height: 1.7;
        color: color-mix(in srgb, var(--muted) 88%, #fff 12%);
      }
      #examList .exam-meta-key {
        font-weight: 900;
        opacity: 0.9;
      }
      #examList .exam-notify-box {
        margin-top: 8px;
        padding: 8px 9px;
        border-radius: 12px;
        border: 1px dashed color-mix(in srgb, var(--border) 72%, transparent);
        background: color-mix(in srgb, var(--card-bg) 90%, transparent);
      }
      #examList .exam-notify-box.is-on {
        border-color: color-mix(in srgb, #10b981 50%, var(--border));
      }
      #examList .exam-notify-box.is-off {
        border-color: color-mix(in srgb, #ef4444 44%, var(--border));
        opacity: 0.85;
      }
      #examList .exam-remain-row {
        margin-top: 8px;
        font-size: 11px;
        line-height: 1.75;
        font-weight: 900;
      }
      #examList .exam-remain-row.is-upcoming {
        color: #22c55e;
      }
      #examList .exam-remain-row.is-past {
        color: #f43f5e;
      }
      #examList .exam-remain-row.is-neutral {
        color: var(--muted);
      }
      .exam-modal-card {
        width: min(96vw, 760px);
        max-height: min(92vh, 880px);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .exam-modal-title {
        margin: 0;
        font-size: 22px;
        line-height: 1.45;
        font-weight: 900;
      }
      .exam-form-layout {
        min-height: 0;
        flex: 1 1 auto;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .exam-form-scroll {
        min-height: 0;
        flex: 1 1 auto;
        display: grid;
        gap: 10px;
        overflow-y: auto;
        overscroll-behavior-y: contain;
        padding-inline-end: 4px;
      }
      .exam-form-scroll::-webkit-scrollbar {
        width: 8px;
      }
      .exam-form-scroll::-webkit-scrollbar-track {
        background: color-mix(in srgb, var(--card-bg) 80%, transparent);
        border-radius: 999px;
      }
      .exam-form-scroll::-webkit-scrollbar-thumb {
        background: color-mix(in srgb, var(--accent2) 40%, var(--border));
        border-radius: 999px;
      }
      .exam-form-actions {
        margin-top: 2px;
        padding-top: 10px;
        border-top: 1px solid var(--border);
        flex: 0 0 auto;
      }
      .exam-modal-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 10px;
      }
      .exam-modal-note {
        font-size: 11px;
        line-height: 1.75;
        opacity: 0.8;
      }
      @media (max-width: 1023.98px) {
        .exam-widget {
          height: min(54vh, 460px);
          min-height: 260px;
        }
        .exam-widget-scroll {
          padding-inline-end: 3px;
        }
        .exam-modal-card {
          max-height: calc(
            var(--app-vh) - env(safe-area-inset-top) -
              env(safe-area-inset-bottom) - 10px
          );
        }
        .exam-modal-title {
          font-size: 19px;
        }
        .exam-form-scroll {
          padding-inline-end: 2px;
        }
        .exam-modal-grid {
          grid-template-columns: minmax(0, 1fr);
        }
        #examList .exam-card-head {
          flex-direction: column;
          gap: 7px;
        }
        #examList .exam-course-chip {
          max-width: 100%;
        }
      }
      #handoutList .handout-course {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border-radius: 999px;
        padding: 3px 8px;
        font-size: 10px;
        font-weight: 900;
        border: 1px solid color-mix(in srgb, var(--accent2) 44%, var(--border));
        background: color-mix(in srgb, var(--accent2) 15%, transparent);
      }
      #handoutList .handout-meta {
        font-size: 10px;
        opacity: 0.75;
      }
      #handoutList .handout-note {
        font-size: 11px;
        line-height: 1.7;
      }
      #handoutList .handout-thumb {
        margin-top: 8px;
        width: 100%;
        aspect-ratio: 16 / 9;
        object-fit: cover;
        border-radius: 12px;
        border: 1px solid color-mix(in srgb, var(--border) 75%, transparent);
      }
      #handoutList .handout-action {
        padding: 4px 9px;
        border-radius: 999px;
        font-size: 10px;
        font-weight: 900;
        border: 1px solid color-mix(in srgb, var(--accent) 34%, var(--border));
        background: color-mix(in srgb, var(--card-bg) 88%, transparent);
      }
      #examList > div::before,
      #noteList > div::before,
      #alertList > div::before,
      #handoutList > div::before,
      #courseProgressList > div::before {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(
          140deg,
          color-mix(in srgb, var(--accent) 18%, transparent),
          transparent 44%,
          color-mix(in srgb, var(--accent2) 16%, transparent)
        );
        opacity: 0.55;
        pointer-events: none;
      }
      #examList > div:hover,
      #noteList > div:hover,
      #alertList > div:hover,
      #handoutList > div:hover,
      #courseProgressList > div:hover {
        transform: translateY(-2px);
        border-color: color-mix(
          in srgb,
          var(--accent2) 36%,
          var(--border)
        ) !important;
        box-shadow:
          0 16px 35px rgba(0, 0, 0, 0.26),
          inset 0 1px 0 rgba(255, 255, 255, 0.12);
      }
      .course-progress-stats {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 8px;
        margin-bottom: 10px;
      }
      .course-progress-stat {
        border-radius: 14px;
        border: 1px solid color-mix(in srgb, var(--border) 80%, transparent);
        background: color-mix(in srgb, var(--card-bg) 86%, transparent);
        padding: 7px 8px;
        text-align: center;
      }
      .course-progress-stat .value {
        font-size: 12px;
        font-weight: 900;
        line-height: 1.2;
      }
      .course-progress-stat .label {
        margin-top: 2px;
        font-size: 10px;
        opacity: 0.68;
        font-weight: 800;
      }
      .course-progress-line {
        direction: ltr;
        position: relative;
        isolation: isolate;
        width: 100%;
        height: 8px;
        border-radius: 999px;
        border: 1px solid color-mix(in srgb, var(--border) 70%, transparent);
        background: color-mix(in srgb, var(--bg) 45%, transparent);
        overflow: hidden;
      }
      .course-progress-line > span {
        display: block;
        height: 100%;
        border-radius: inherit;
        min-width: 0%;
        max-width: 100%;
        width: var(--progress, 0%);
        background: linear-gradient(
          90deg,
          color-mix(in srgb, var(--accent) 82%, #ffffff 18%),
          color-mix(in srgb, var(--accent2) 84%, #ffffff 16%)
        );
        box-shadow: 0 0 14px color-mix(in srgb, var(--accent2) 34%, transparent);
        transition: width 420ms cubic-bezier(0.22, 1, 0.36, 1);
      }
      body[data-style-pack="ultra"] .course-progress-stat {
        border-color: color-mix(in srgb, var(--accent2) 32%, var(--border));
      }
      body[data-style-pack="ultra"] .course-progress-line {
        border-color: color-mix(in srgb, var(--accent2) 28%, var(--border));
      }

      .schedule-frame::before {
        opacity: 0.34;
        background-size: 170% 170%;
        animation: frameFlow 9s ease-in-out infinite;
      }
      @keyframes frameFlow {
        0% {
          background-position: 0% 30%;
        }
        50% {
          background-position: 100% 70%;
        }
        100% {
          background-position: 0% 30%;
        }
      }
      .schedule-shell {
        position: relative;
        padding: 1.5px;
        background: linear-gradient(
          140deg,
          color-mix(in srgb, var(--accent) 42%, transparent),
          transparent 30%,
          color-mix(in srgb, var(--accent2) 40%, transparent)
        );
      }
      .schedule-shell::before {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: inherit;
        pointer-events: none;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.12),
          rgba(255, 255, 255, 0) 28%
        );
        opacity: 0.65;
      }
      .schedule-grid {
        border: 1px solid color-mix(in srgb, var(--border) 88%, transparent);
        box-shadow:
          inset 0 1px 0 rgba(255, 255, 255, 0.08),
          inset 0 -1px 0 rgba(0, 0, 0, 0.18),
          0 28px 80px rgba(0, 0, 0, 0.28);
      }
      .grid-header {
        letter-spacing: 0.03em;
        font-size: 12.5px;
        text-transform: uppercase;
      }
      .grid-cell {
        border: 1px solid transparent;
      }
      .grid-cell.hl {
        border-color: color-mix(in srgb, var(--accent) 34%, transparent);
      }
      .grid-cell:hover {
        transform: translateY(-2px);
        border-color: color-mix(in srgb, var(--accent2) 30%, transparent);
      }
      .time-slot {
        border-left: 1px solid
          color-mix(in srgb, var(--accent2) 22%, transparent);
      }
      .class-card {
        border-radius: 20px;
        box-shadow:
          0 12px 30px rgba(0, 0, 0, 0.24),
          inset 0 1px 0 rgba(255, 255, 255, 0.14);
      }
      .class-card::before {
        opacity: 0.42;
      }
      .class-card .badge {
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.26);
      }
      .class-title {
        font-size: 13px;
        letter-spacing: 0.01em;
      }

      body[data-style-pack="ultra"] .theme-card {
        border-color: color-mix(in srgb, var(--accent2) 34%, var(--border));
        box-shadow:
          0 30px 86px rgba(0, 0, 0, 0.34),
          inset 0 1px 0 rgba(255, 255, 255, 0.16);
      }
      body[data-style-pack="ultra"] .theme-card::after {
        opacity: 0.72;
        border-color: color-mix(in srgb, var(--accent2) 40%, transparent);
      }
      body[data-style-pack="ultra"] aside .theme-card {
        border-radius: 26px;
      }
      body[data-style-pack="ultra"] .logo-badge {
        box-shadow:
          0 16px 36px rgba(0, 0, 0, 0.34),
          inset 0 1px 0 rgba(255, 255, 255, 0.42);
      }
      body[data-style-pack="ultra"] .logo-badge::after {
        animation-duration: 4.6s;
      }
      body[data-style-pack="ultra"] .schedule-frame::before {
        opacity: 0.5;
        animation-duration: 6.2s;
      }
      body[data-style-pack="ultra"] .schedule-frame::after {
        box-shadow:
          0 34px 100px rgba(0, 0, 0, 0.42),
          inset 0 1px 0 rgba(255, 255, 255, 0.14);
      }
      body[data-style-pack="ultra"] .schedule-grid {
        border-color: color-mix(in srgb, var(--accent2) 30%, var(--border));
        box-shadow:
          inset 0 1px 0 rgba(255, 255, 255, 0.1),
          inset 0 -1px 0 rgba(0, 0, 0, 0.2),
          0 40px 98px rgba(0, 0, 0, 0.34);
      }
      body[data-style-pack="ultra"] .grid-header {
        font-size: 13px;
        letter-spacing: 0.055em;
      }
      body[data-style-pack="ultra"] .grid-cell.hl::after {
        opacity: 1;
      }
      body[data-style-pack="ultra"] .class-card {
        border-color: color-mix(in srgb, var(--accent) 28%, var(--border));
        box-shadow:
          0 18px 34px rgba(0, 0, 0, 0.3),
          inset 0 1px 0 rgba(255, 255, 255, 0.16);
      }
      body[data-style-pack="ultra"] .class-card:hover {
        transform: translateY(-2px) scale(1.018);
        filter: brightness(1.09);
      }
      body[data-style-pack="ultra"] #examList > div,
      body[data-style-pack="ultra"] #noteList > div,
      body[data-style-pack="ultra"] #alertList > div,
      body[data-style-pack="ultra"] #handoutList > div,
      body[data-style-pack="ultra"] #courseProgressList > div {
        border-color: color-mix(
          in srgb,
          var(--accent2) 32%,
          var(--border)
        ) !important;
      }
      body[data-style-pack="ultra"] #examList > div::before,
      body[data-style-pack="ultra"] #noteList > div::before,
      body[data-style-pack="ultra"] #alertList > div::before,
      body[data-style-pack="ultra"] #handoutList > div::before,
      body[data-style-pack="ultra"] #courseProgressList > div::before {
        opacity: 0.82;
      }
      body[data-style-pack="ultra"] #examList > div:hover,
      body[data-style-pack="ultra"] #noteList > div:hover,
      body[data-style-pack="ultra"] #alertList > div:hover,
      body[data-style-pack="ultra"] #handoutList > div:hover,
      body[data-style-pack="ultra"] #courseProgressList > div:hover {
        transform: translateY(-3px);
      }
      @keyframes ultraAuraDrift {
        0% {
          transform: translate3d(0, 0, 0) scale(1);
          opacity: 0.42;
        }
        50% {
          transform: translate3d(14px, -10px, 0) scale(1.03);
          opacity: 0.66;
        }
        100% {
          transform: translate3d(0, 0, 0) scale(1);
          opacity: 0.42;
        }
      }
      @keyframes ultraLineFlow {
        0% {
          background-position: 0% 35%;
        }
        50% {
          background-position: 100% 65%;
        }
        100% {
          background-position: 0% 35%;
        }
      }
      @keyframes ultraSheenSweep {
        0% {
          transform: translateX(-140%);
        }
        100% {
          transform: translateX(220%);
        }
      }
      body[data-style-pack="ultra"] #appLayout {
        position: relative;
        isolation: isolate;
      }
      body[data-style-pack="ultra"] #appLayout::before {
        content: "";
        position: absolute;
        inset: -18px -16px;
        border-radius: 34px;
        pointer-events: none;
        z-index: -1;
        background:
          radial-gradient(
            900px 260px at 8% 0%,
            color-mix(in srgb, var(--accent) 24%, transparent),
            transparent 65%
          ),
          radial-gradient(
            1000px 280px at 92% 100%,
            color-mix(in srgb, var(--accent2) 24%, transparent),
            transparent 66%
          );
        filter: blur(3px);
        animation: ultraAuraDrift 10.8s ease-in-out infinite;
      }
      body[data-style-pack="ultra"] .top-nav {
        border-radius: 28px;
        border-color: color-mix(in srgb, var(--accent2) 40%, var(--border));
        background: color-mix(in srgb, var(--bg) 74%, transparent) !important;
        backdrop-filter: blur(24px);
        -webkit-backdrop-filter: blur(24px);
        box-shadow:
          0 26px 58px rgba(0, 0, 0, 0.33),
          inset 0 1px 0 rgba(255, 255, 255, 0.22);
      }
      body[data-style-pack="ultra"] .top-nav::before {
        opacity: 0.78;
      }
      body[data-style-pack="ultra"] .top-nav::after {
        border-width: 1.25px;
        border-color: color-mix(in srgb, var(--accent2) 52%, transparent);
      }
      body[data-style-pack="ultra"] .top-nav .control-surface,
      body[data-style-pack="ultra"] .top-nav .control-btn,
      body[data-style-pack="ultra"] .top-nav .week-toggle {
        border-color: color-mix(
          in srgb,
          var(--accent2) 34%,
          var(--border)
        ) !important;
        box-shadow:
          0 10px 20px rgba(0, 0, 0, 0.18),
          inset 0 1px 0 rgba(255, 255, 255, 0.14);
      }
      body[data-style-pack="ultra"] .top-nav .control-btn:hover,
      body[data-style-pack="ultra"] .top-nav .control-surface:focus {
        border-color: color-mix(
          in srgb,
          var(--accent2) 58%,
          var(--border)
        ) !important;
      }
      body[data-style-pack="ultra"] .tools-panel {
        border-radius: 24px;
        border-color: color-mix(in srgb, var(--accent2) 30%, var(--border));
      }
      body[data-style-pack="ultra"] .view-switch {
        border-color: color-mix(in srgb, var(--accent) 30%, var(--border));
      }
      body[data-style-pack="ultra"] .search-input {
        border-color: color-mix(in srgb, var(--accent2) 36%, var(--border));
      }
      body[data-style-pack="ultra"] .add-class-btn {
        position: relative;
        overflow: hidden;
        box-shadow:
          0 14px 34px color-mix(in srgb, var(--accent) 28%, transparent),
          inset 0 1px 0 rgba(255, 255, 255, 0.28);
      }
      body[data-style-pack="ultra"] .add-class-btn::before {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(
          120deg,
          transparent 15%,
          rgba(255, 255, 255, 0.38) 50%,
          transparent 80%
        );
        transform: translateX(-140%);
        animation: ultraSheenSweep 2.7s ease-in-out infinite;
        pointer-events: none;
      }
      body[data-style-pack="ultra"] .profile-card .stat-tile {
        position: relative;
        overflow: hidden;
        border-color: color-mix(in srgb, var(--accent2) 30%, var(--border));
        box-shadow:
          0 12px 26px rgba(0, 0, 0, 0.22),
          inset 0 1px 0 rgba(255, 255, 255, 0.16);
      }
      body[data-style-pack="ultra"] .profile-card .stat-tile::before {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        background: linear-gradient(
          135deg,
          color-mix(in srgb, var(--accent) 18%, transparent),
          transparent 45%,
          color-mix(in srgb, var(--accent2) 15%, transparent)
        );
        opacity: 0.7;
      }
      body[data-style-pack="ultra"] #statUnits,
      body[data-style-pack="ultra"] #statHours,
      body[data-style-pack="ultra"] #statClasses {
        letter-spacing: 0.01em;
        text-shadow: 0 2px 14px
          color-mix(in srgb, var(--accent2) 20%, transparent);
      }
      body[data-style-pack="ultra"] .side-widget {
        border-radius: 26px;
        border-color: color-mix(in srgb, var(--accent2) 34%, var(--border));
      }
      body[data-style-pack="ultra"] .side-widget > div:first-child h4 {
        letter-spacing: 0.03em;
      }
      body[data-style-pack="ultra"] .next-class-card {
        border-right-width: 5px;
      }
      body[data-style-pack="ultra"] .schedule-hint {
        border-radius: 18px;
        border-color: color-mix(in srgb, var(--accent2) 32%, var(--border));
      }
      body[data-style-pack="ultra"] .schedule-grid::before {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        background:
          linear-gradient(
            120deg,
            color-mix(in srgb, var(--accent) 10%, transparent),
            transparent 38%,
            color-mix(in srgb, var(--accent2) 10%, transparent)
          ),
          linear-gradient(
            90deg,
            transparent,
            rgba(255, 255, 255, 0.08),
            transparent
          );
        background-size:
          100% 100%,
          180% 100%;
        background-position:
          0 0,
          0 0;
        opacity: 0.42;
        animation: ultraLineFlow 7.6s ease-in-out infinite;
        z-index: 1;
      }
      body[data-style-pack="ultra"] .schedule-grid > * {
        position: relative;
        z-index: 2;
      }
      body[data-style-pack="ultra"] .grid-header::before {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.16),
          rgba(255, 255, 255, 0)
        );
        opacity: 0.85;
      }
      body[data-style-pack="ultra"] .class-card[data-type="odd"] {
        border-color: rgba(245, 158, 11, 0.45);
        box-shadow:
          0 18px 34px rgba(0, 0, 0, 0.3),
          inset -3px 0 0 rgba(245, 158, 11, 0.85),
          inset 0 1px 0 rgba(255, 255, 255, 0.16);
      }
      body[data-style-pack="ultra"] .class-card[data-type="even"] {
        border-color: rgba(59, 130, 246, 0.44);
        box-shadow:
          0 18px 34px rgba(0, 0, 0, 0.3),
          inset -3px 0 0 rgba(59, 130, 246, 0.88),
          inset 0 1px 0 rgba(255, 255, 255, 0.16);
      }
      body[data-style-pack="ultra"] .class-card[data-type="normal"] {
        border-color: color-mix(in srgb, var(--accent2) 38%, var(--border));
        box-shadow:
          0 18px 34px rgba(0, 0, 0, 0.3),
          inset -3px 0 0 color-mix(in srgb, var(--accent2) 72%, transparent),
          inset 0 1px 0 rgba(255, 255, 255, 0.16);
      }
      body[data-style-pack="ultra"] .list-class-card[data-type="odd"] {
        border-right: 4px solid rgba(245, 158, 11, 0.8) !important;
      }
      body[data-style-pack="ultra"] .list-class-card[data-type="even"] {
        border-right: 4px solid rgba(59, 130, 246, 0.82) !important;
      }
      body[data-style-pack="ultra"] .list-class-card[data-type="normal"] {
        border-right: 4px solid
          color-mix(in srgb, var(--accent2) 64%, transparent) !important;
      }
      body[data-style-pack="ultra"] .class-foot .badge {
        box-shadow:
          inset 0 1px 0 rgba(255, 255, 255, 0.28),
          0 5px 14px rgba(0, 0, 0, 0.18);
      }
      @keyframes ultraNavHalo {
        0% {
          transform: translate3d(0, 0, 0) scale(1);
          opacity: 0.4;
        }
        50% {
          transform: translate3d(-10px, 6px, 0) scale(1.04);
          opacity: 0.72;
        }
        100% {
          transform: translate3d(0, 0, 0) scale(1);
          opacity: 0.4;
        }
      }
      @keyframes ultraPanelFlow {
        0% {
          background-position: 0% 32%;
        }
        50% {
          background-position: 100% 68%;
        }
        100% {
          background-position: 0% 32%;
        }
      }
      @keyframes ultraGlassSweep {
        0% {
          transform: translateX(-140%);
          opacity: 0;
        }
        20% {
          opacity: 0.5;
        }
        100% {
          transform: translateX(220%);
          opacity: 0;
        }
      }
      @keyframes ultraCardLift {
        0% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-2px);
        }
        100% {
          transform: translateY(0);
        }
      }
      body[data-style-pack="ultra"] {
        --ultra-edge: color-mix(in srgb, var(--accent2) 45%, transparent);
        --ultra-fill: color-mix(in srgb, var(--accent) 22%, transparent);
      }
      body[data-style-pack="ultra"] .top-nav {
        overflow: hidden;
      }
      body[data-style-pack="ultra"] .top-nav::before {
        background:
          radial-gradient(
            900px 140px at 12% -10%,
            color-mix(in srgb, var(--accent) 26%, transparent),
            transparent 70%
          ),
          radial-gradient(
            900px 140px at 88% 120%,
            color-mix(in srgb, var(--accent2) 25%, transparent),
            transparent 70%
          );
        animation: ultraNavHalo 8.2s ease-in-out infinite;
      }
      body[data-style-pack="ultra"] .top-nav::after {
        background: linear-gradient(
          135deg,
          color-mix(in srgb, var(--accent) 38%, transparent),
          transparent 35%,
          color-mix(in srgb, var(--accent2) 38%, transparent)
        );
      }
      body[data-style-pack="ultra"] .week-toggle,
      body[data-style-pack="ultra"] .control-surface,
      body[data-style-pack="ultra"] .control-btn {
        background: color-mix(
          in srgb,
          var(--card-bg) 68%,
          transparent
        ) !important;
      }
      body[data-style-pack="ultra"] .week-toggle {
        box-shadow:
          inset 0 1px 0 rgba(255, 255, 255, 0.16),
          0 10px 26px rgba(0, 0, 0, 0.2);
      }
      body[data-style-pack="ultra"] .profile-card,
      body[data-style-pack="ultra"] .side-widget,
      body[data-style-pack="ultra"] .tools-panel {
        position: relative;
        overflow: hidden;
      }
      body[data-style-pack="ultra"] .profile-card::before,
      body[data-style-pack="ultra"] .side-widget::before,
      body[data-style-pack="ultra"] .tools-panel::before {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        background: linear-gradient(
          130deg,
          color-mix(in srgb, var(--accent) 16%, transparent),
          transparent 42%,
          color-mix(in srgb, var(--accent2) 15%, transparent)
        );
        background-size: 180% 180%;
        animation: ultraPanelFlow 7.8s ease-in-out infinite;
        opacity: 0.75;
        z-index: 0;
      }
      body[data-style-pack="ultra"] .profile-card > *,
      body[data-style-pack="ultra"] .side-widget > *,
      body[data-style-pack="ultra"] .tools-panel > * {
        position: relative;
        z-index: 1;
      }
      body[data-style-pack="ultra"] .stat-tile {
        animation: ultraCardLift 5.4s ease-in-out infinite;
      }
      body[data-style-pack="ultra"] .stat-tile:nth-child(2) {
        animation-delay: 0.6s;
      }
      body[data-style-pack="ultra"] .next-class-card {
        border-right-color: color-mix(
          in srgb,
          var(--accent2) 65%,
          var(--accent)
        ) !important;
      }
      body[data-style-pack="ultra"] .schedule-frame {
        isolation: isolate;
      }
      body[data-style-pack="ultra"] .schedule-frame::after {
        border: 1px solid color-mix(in srgb, var(--accent2) 32%, transparent);
      }
      body[data-style-pack="ultra"] .schedule-shell::after {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        border-radius: inherit;
        background: linear-gradient(
          120deg,
          transparent 15%,
          rgba(255, 255, 255, 0.35) 48%,
          transparent 82%
        );
        transform: translateX(-140%);
        animation: ultraGlassSweep 4.8s ease-in-out infinite;
        opacity: 0.5;
      }
      body[data-style-pack="ultra"] .grid-header {
        text-shadow:
          0 1px 0 rgba(0, 0, 0, 0.18),
          0 0 16px color-mix(in srgb, var(--accent2) 22%, transparent);
      }
      body[data-style-pack="ultra"] .time-slot {
        background:
          radial-gradient(
            500px 180px at 50% 0%,
            color-mix(in srgb, var(--accent2) 20%, transparent),
            transparent 70%
          ),
          linear-gradient(
            180deg,
            rgba(255, 255, 255, 0.08),
            rgba(255, 255, 255, 0.02)
          );
      }
      body[data-style-pack="ultra"] .grid-cell::after {
        background: radial-gradient(
          800px 300px at 50% 15%,
          color-mix(in srgb, var(--accent2) 28%, transparent),
          transparent 72%
        );
      }
      body[data-style-pack="ultra"] .grid-cell:hover {
        filter: brightness(1.1);
      }
      body[data-style-pack="ultra"] .class-card {
        backdrop-filter: blur(18px) saturate(1.08);
        -webkit-backdrop-filter: blur(18px) saturate(1.08);
      }
      body[data-style-pack="ultra"] .class-card::after {
        background:
          radial-gradient(
            900px 220px at 0% 0%,
            rgba(255, 255, 255, 0.2),
            transparent 62%
          ),
          linear-gradient(
            130deg,
            color-mix(in srgb, var(--accent2) 12%, transparent),
            transparent 45%
          );
      }
      body[data-style-pack="ultra"] .class-card .class-title {
        text-shadow: 0 0 12px
          color-mix(in srgb, var(--accent2) 14%, transparent);
      }
      body[data-style-pack="ultra"] .class-card:hover .class-title {
        letter-spacing: 0.02em;
      }
      body[data-style-pack="ultra"] .class-foot {
        margin-top: 11px;
      }
      body[data-style-pack="ultra"] .badge {
        border-color: rgba(255, 255, 255, 0.2);
      }
      body[data-style-pack="ultra"] .list-class-card {
        overflow: hidden;
      }
      body[data-style-pack="ultra"] .list-class-card::before {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        background: linear-gradient(
          130deg,
          color-mix(in srgb, var(--accent2) 20%, transparent),
          transparent 42%,
          color-mix(in srgb, var(--accent) 16%, transparent)
        );
        opacity: 0.52;
      }
      body[data-style-pack="ultra"] .list-class-card > * {
        position: relative;
        z-index: 1;
      }
      body[data-style-pack="ultra"] .chip {
        border-color: color-mix(in srgb, var(--accent2) 34%, var(--border));
      }
      body[data-style-pack="ultra"] .inp {
        border-color: color-mix(in srgb, var(--accent2) 32%, var(--border));
        background: color-mix(in srgb, var(--card-bg) 78%, transparent);
      }
      body[data-style-pack="ultra"] .inp:focus {
        box-shadow:
          0 0 0 4px color-mix(in srgb, var(--accent2) 18%, transparent),
          0 10px 26px rgba(0, 0, 0, 0.18);
      }
      body[data-style-pack="ultra"] ::-webkit-scrollbar-thumb {
        background: linear-gradient(
          180deg,
          color-mix(in srgb, var(--accent) 54%, transparent),
          color-mix(in srgb, var(--accent2) 56%, transparent)
        );
      }

      /* Ultra Pack v2: trend palettes + richer premium surfaces */
      body[data-style-pack="ultra"] {
        --ultra-tone-a: color-mix(in srgb, var(--accent) 30%, transparent);
        --ultra-tone-b: color-mix(in srgb, var(--accent2) 30%, transparent);
        --ultra-tone-c: color-mix(in srgb, var(--accent) 18%, #ffffff 4%);
        --ultra-edge-soft: color-mix(
          in srgb,
          var(--accent2) 36%,
          var(--border)
        );
        --ultra-edge-strong: color-mix(
          in srgb,
          var(--accent2) 60%,
          var(--border)
        );
        --ultra-surface-main: linear-gradient(
          150deg,
          color-mix(in srgb, var(--card-bg) 90%, transparent),
          color-mix(in srgb, var(--card-bg) 74%, transparent)
        );
        --ultra-surface-alt: linear-gradient(
          145deg,
          color-mix(in srgb, var(--bg) 14%, transparent),
          color-mix(in srgb, var(--card-bg) 82%, transparent)
        );
      }
      body[data-style-pack="ultra"][data-theme="mathdark"] {
        --ultra-tone-a: rgba(59, 130, 246, 0.34);
        --ultra-tone-b: rgba(14, 165, 233, 0.3);
      }
      body[data-style-pack="ultra"][data-theme="mathlight"] {
        --ultra-tone-a: rgba(251, 113, 133, 0.3);
        --ultra-tone-b: rgba(251, 191, 36, 0.26);
      }
      body[data-style-pack="ultra"][data-theme="material"] {
        --ultra-tone-a: rgba(161, 140, 209, 0.34);
        --ultra-tone-b: rgba(251, 194, 235, 0.3);
      }
      body[data-style-pack="ultra"][data-theme="hacker"] {
        --ultra-tone-a: rgba(16, 185, 129, 0.32);
        --ultra-tone-b: rgba(34, 197, 94, 0.28);
      }
      body[data-style-pack="ultra"][data-theme="luxury"] {
        --ultra-tone-a: rgba(245, 158, 11, 0.3);
        --ultra-tone-b: rgba(212, 175, 55, 0.3);
      }
      body[data-style-pack="ultra"][data-ultra-mood="sunrise"] {
        --ultra-tone-a: rgba(251, 146, 60, 0.36);
        --ultra-tone-b: rgba(250, 204, 21, 0.28);
      }
      body[data-style-pack="ultra"][data-ultra-mood="day"] {
        --ultra-tone-a: rgba(56, 189, 248, 0.32);
        --ultra-tone-b: rgba(45, 212, 191, 0.26);
      }
      body[data-style-pack="ultra"][data-ultra-mood="sunset"] {
        --ultra-tone-a: rgba(251, 113, 133, 0.32);
        --ultra-tone-b: rgba(244, 114, 182, 0.26);
      }
      body[data-style-pack="ultra"][data-ultra-mood="night"] {
        --ultra-tone-a: rgba(99, 102, 241, 0.34);
        --ultra-tone-b: rgba(59, 130, 246, 0.28);
      }
      body[data-style-pack="ultra"] #appLayout::before {
        background:
          radial-gradient(
            940px 280px at 6% -6%,
            var(--ultra-tone-a),
            transparent 66%
          ),
          radial-gradient(
            980px 300px at 94% 106%,
            var(--ultra-tone-b),
            transparent 68%
          ) !important;
      }
      body[data-style-pack="ultra"] .theme-card,
      body[data-style-pack="ultra"] .profile-card,
      body[data-style-pack="ultra"] .tools-panel,
      body[data-style-pack="ultra"] .side-widget {
        border-color: var(--ultra-edge-soft);
        background:
          radial-gradient(
            680px 220px at 0% 0%,
            var(--ultra-tone-a),
            transparent 68%
          ),
          radial-gradient(
            740px 230px at 100% 100%,
            var(--ultra-tone-b),
            transparent 72%
          ),
          var(--ultra-surface-main) !important;
      }
      body[data-style-pack="ultra"] .top-nav .control-surface,
      body[data-style-pack="ultra"] .top-nav .control-btn,
      body[data-style-pack="ultra"] .top-nav .week-toggle,
      body[data-style-pack="ultra"] .notify-bell-btn {
        border-color: var(--ultra-edge-strong) !important;
        background: var(--ultra-surface-alt) !important;
      }
      body[data-style-pack="ultra"] .class-card,
      body[data-style-pack="ultra"] .list-class-card {
        border-color: var(--ultra-edge-soft);
      }
      body[data-style-pack="ultra"] .class-card:hover,
      body[data-style-pack="ultra"] .list-class-card:hover {
        filter: brightness(1.08) saturate(1.08);
      }
      body[data-style-pack="ultra"] #nextClassContainer .next-minute-left {
        border-color: var(--ultra-edge-strong);
        background:
          radial-gradient(
            420px 160px at 8% 0%,
            var(--ultra-tone-a),
            transparent 70%
          ),
          radial-gradient(
            460px 170px at 90% 110%,
            var(--ultra-tone-b),
            transparent 74%
          ),
          linear-gradient(
            122deg,
            rgba(2, 12, 24, 0.9),
            rgba(3, 26, 44, 0.86) 52%,
            rgba(6, 44, 68, 0.82)
          );
      }
      body[data-style-pack="ultra"] #nextClassContainer .next-flip-digit {
        border-color: color-mix(
          in srgb,
          var(--accent2) 42%,
          rgba(148, 163, 184, 0.38)
        );
        background: linear-gradient(
          180deg,
          color-mix(in srgb, var(--ultra-tone-c) 48%, rgba(16, 23, 36, 0.98)),
          rgba(2, 8, 18, 0.96) 100%
        );
      }
      body[data-style-pack="ultra"] #nextClassContainer .next-flip-digit__num {
        color: color-mix(in srgb, #ffffff 88%, var(--accent2) 12%);
      }
      body[data-style-pack="ultra"] .next-class-card {
        background:
          radial-gradient(
            760px 220px at 4% -10%,
            var(--ultra-tone-a),
            transparent 70%
          ),
          radial-gradient(
            800px 250px at 96% 120%,
            var(--ultra-tone-b),
            transparent 72%
          ),
          linear-gradient(
            162deg,
            color-mix(in srgb, var(--card-bg) 92%, transparent),
            color-mix(in srgb, var(--card-bg) 76%, transparent)
          ) !important;
      }

      /* Pro Pack: ultra-modern glass + mesh depth */
      @keyframes proFluxField {
        0% {
          transform: translate3d(0, 0, 0) scale(1);
          opacity: 0.46;
        }
        50% {
          transform: translate3d(12px, -8px, 0) scale(1.04);
          opacity: 0.8;
        }
        100% {
          transform: translate3d(0, 0, 0) scale(1);
          opacity: 0.46;
        }
      }
      @keyframes proAuroraSweep {
        0% {
          background-position:
            0% 30%,
            0% 42%;
        }
        50% {
          background-position:
            100% 70%,
            100% 58%;
        }
        100% {
          background-position:
            0% 30%,
            0% 42%;
        }
      }
      @keyframes proPrismLine {
        0% {
          transform: translateX(-150%);
          opacity: 0;
        }
        18% {
          opacity: 0.52;
        }
        100% {
          transform: translateX(220%);
          opacity: 0;
        }
      }
      @keyframes proMicroPulse {
        0%,
        100% {
          transform: scale(0.84);
          opacity: 0.44;
        }
        50% {
          transform: scale(1.12);
          opacity: 1;
        }
      }
      @keyframes proOrbitCast {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }
      body[data-style-pack="pro"] {
        --pro-tone-a: color-mix(in srgb, #22d3ee 34%, transparent);
        --pro-tone-b: color-mix(in srgb, #a78bfa 32%, transparent);
        --pro-tone-c: color-mix(in srgb, #38bdf8 22%, transparent);
        --pro-edge-soft: color-mix(in srgb, var(--accent2) 44%, var(--border));
        --pro-edge-strong: color-mix(
          in srgb,
          var(--accent2) 68%,
          var(--border)
        );
        --pro-glass: color-mix(in srgb, var(--card-bg) 86%, transparent);
      }
      body[data-style-pack="pro"][data-theme="mathlight"] {
        --pro-tone-a: rgba(244, 114, 182, 0.28);
        --pro-tone-b: rgba(56, 189, 248, 0.24);
      }
      body[data-style-pack="pro"][data-theme="hacker"] {
        --pro-tone-a: rgba(16, 185, 129, 0.3);
        --pro-tone-b: rgba(45, 212, 191, 0.24);
      }
      body[data-style-pack="pro"][data-theme="luxury"] {
        --pro-tone-a: rgba(245, 158, 11, 0.26);
        --pro-tone-b: rgba(56, 189, 248, 0.22);
      }
      body[data-style-pack="pro"][data-theme="chemistrylight"] {
        --pro-tone-a: rgba(56, 189, 248, 0.26);
        --pro-tone-b: rgba(224, 195, 252, 0.28);
      }
      body[data-style-pack="pro"][data-theme="chemistrydark"] {
        --pro-tone-a: rgba(30, 58, 138, 0.28);
        --pro-tone-b: rgba(124, 58, 237, 0.24);
      }
      body[data-style-pack="pro"][data-ultra-mood="sunrise"] {
        --pro-tone-a: rgba(251, 146, 60, 0.32);
        --pro-tone-b: rgba(236, 72, 153, 0.24);
      }
      body[data-style-pack="pro"][data-ultra-mood="day"] {
        --pro-tone-a: rgba(56, 189, 248, 0.33);
        --pro-tone-b: rgba(34, 211, 238, 0.26);
      }
      body[data-style-pack="pro"][data-ultra-mood="sunset"] {
        --pro-tone-a: rgba(244, 114, 182, 0.32);
        --pro-tone-b: rgba(139, 92, 246, 0.24);
      }
      body[data-style-pack="pro"][data-ultra-mood="night"] {
        --pro-tone-a: rgba(99, 102, 241, 0.34);
        --pro-tone-b: rgba(6, 182, 212, 0.24);
      }
      body[data-style-pack="pro"] #appLayout {
        position: relative;
        isolation: isolate;
      }
      body[data-style-pack="pro"] #appLayout::before {
        content: "";
        position: absolute;
        inset: -20px -18px;
        border-radius: 36px;
        pointer-events: none;
        z-index: -1;
        background:
          radial-gradient(
            980px 300px at 8% -8%,
            var(--pro-tone-a),
            transparent 66%
          ),
          radial-gradient(
            1040px 320px at 94% 108%,
            var(--pro-tone-b),
            transparent 68%
          );
        filter: blur(4px);
        animation: proFluxField 10.2s ease-in-out infinite;
      }
      body[data-style-pack="pro"] .top-nav {
        border-radius: 30px;
        border-color: var(--pro-edge-soft);
        background: linear-gradient(
          160deg,
          color-mix(in srgb, var(--bg) 72%, transparent),
          color-mix(in srgb, var(--card-bg) 74%, transparent)
        ) !important;
        backdrop-filter: blur(28px) saturate(1.18);
        -webkit-backdrop-filter: blur(28px) saturate(1.18);
        box-shadow:
          0 28px 66px rgba(2, 8, 24, 0.38),
          inset 0 1px 0 rgba(255, 255, 255, 0.24);
      }
      body[data-style-pack="pro"] .top-nav::before {
        background:
          radial-gradient(
            940px 160px at 12% -14%,
            color-mix(in srgb, var(--pro-tone-a) 88%, transparent),
            transparent 72%
          ),
          radial-gradient(
            920px 150px at 88% 122%,
            color-mix(in srgb, var(--pro-tone-b) 86%, transparent),
            transparent 72%
          );
        animation: proFluxField 8.4s ease-in-out infinite;
        opacity: 0.88;
      }
      body[data-style-pack="pro"] .top-nav::after {
        border-width: 1.3px;
        border-color: color-mix(
          in srgb,
          var(--pro-edge-strong) 92%,
          transparent
        );
      }
      body[data-style-pack="pro"] .top-nav .control-surface,
      body[data-style-pack="pro"] .top-nav .control-btn:not(.danger-btn),
      body[data-style-pack="pro"] .top-nav .week-toggle,
      body[data-style-pack="pro"] .notify-bell-btn {
        border-color: var(--pro-edge-strong) !important;
        background: linear-gradient(
          150deg,
          color-mix(in srgb, var(--pro-glass) 88%, transparent),
          color-mix(in srgb, var(--bg) 22%, transparent)
        ) !important;
        box-shadow:
          0 10px 22px rgba(0, 0, 0, 0.2),
          inset 0 1px 0 rgba(255, 255, 255, 0.18);
      }
      body[data-style-pack="pro"]
        #packSelectShell[data-pack="pro"]
        .premium-select-icon {
        box-shadow:
          inset 0 1px 0 rgba(255, 255, 255, 0.3),
          0 0 0 1px rgba(34, 211, 238, 0.38),
          0 10px 20px rgba(34, 211, 238, 0.22);
      }
      body[data-style-pack="pro"] .theme-card:not(.top-nav),
      body[data-style-pack="pro"] .profile-card,
      body[data-style-pack="pro"] .tools-panel,
      body[data-style-pack="pro"] .side-widget {
        position: relative;
        overflow: hidden;
        border-color: var(--pro-edge-soft);
        background:
          radial-gradient(
            720px 220px at 0% 0%,
            var(--pro-tone-a),
            transparent 70%
          ),
          radial-gradient(
            760px 230px at 100% 100%,
            var(--pro-tone-b),
            transparent 72%
          ),
          linear-gradient(
            165deg,
            color-mix(in srgb, var(--card-bg) 92%, transparent),
            color-mix(in srgb, var(--card-bg) 76%, transparent)
          ) !important;
        box-shadow:
          0 24px 58px rgba(2, 10, 28, 0.32),
          inset 0 1px 0 rgba(255, 255, 255, 0.2);
      }
      body[data-style-pack="pro"] .top-nav.theme-card {
        position: sticky !important;
      }
      body[data-style-pack="pro"] .theme-card::before,
      body[data-style-pack="pro"] .profile-card::before,
      body[data-style-pack="pro"] .tools-panel::before,
      body[data-style-pack="pro"] .side-widget::before {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        background:
          linear-gradient(
            130deg,
            color-mix(in srgb, var(--pro-tone-a) 82%, transparent),
            transparent 42%,
            color-mix(in srgb, var(--pro-tone-b) 84%, transparent)
          ),
          linear-gradient(
            90deg,
            transparent,
            rgba(255, 255, 255, 0.2),
            transparent
          );
        background-size:
          170% 170%,
          220% 100%;
        animation: proAuroraSweep 8.6s ease-in-out infinite;
        opacity: 0.72;
        z-index: 0;
      }
      body[data-style-pack="pro"] .theme-card > *,
      body[data-style-pack="pro"] .profile-card > *,
      body[data-style-pack="pro"] .tools-panel > *,
      body[data-style-pack="pro"] .side-widget > * {
        position: relative;
        z-index: 1;
      }
      body[data-style-pack="pro"] .profile-card .stat-tile {
        border-color: color-mix(in srgb, var(--pro-edge-soft) 90%, transparent);
        box-shadow:
          0 14px 28px rgba(2, 10, 28, 0.22),
          inset 0 1px 0 rgba(255, 255, 255, 0.2);
      }
      body[data-style-pack="pro"] .profile-card .stat-tile::before {
        opacity: 0.82;
      }
      body[data-style-pack="pro"] .schedule-frame {
        border-radius: 28px;
        padding: 2px;
        background: linear-gradient(
          132deg,
          color-mix(in srgb, var(--pro-tone-a) 88%, transparent),
          transparent 36%,
          color-mix(in srgb, var(--pro-tone-b) 88%, transparent)
        );
        box-shadow: 0 24px 66px rgba(2, 12, 30, 0.34);
      }
      body[data-style-pack="pro"] .schedule-grid {
        border-color: var(--pro-edge-soft);
        box-shadow:
          inset 0 1px 0 rgba(255, 255, 255, 0.14),
          0 42px 106px rgba(2, 10, 28, 0.34);
      }
      body[data-style-pack="pro"] .schedule-grid::before {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        border-radius: inherit;
        z-index: 1;
        background:
          linear-gradient(
            120deg,
            color-mix(in srgb, var(--pro-tone-a) 70%, transparent),
            transparent 38%,
            color-mix(in srgb, var(--pro-tone-b) 70%, transparent)
          ),
          linear-gradient(
            90deg,
            transparent,
            rgba(255, 255, 255, 0.18),
            transparent
          );
        background-size:
          170% 170%,
          220% 100%;
        animation: proAuroraSweep 7.2s ease-in-out infinite;
        opacity: 0.5;
      }
      body[data-style-pack="pro"] .schedule-grid > * {
        position: relative;
        z-index: 2;
      }
      body[data-style-pack="pro"] .grid-header {
        text-shadow:
          0 1px 0 rgba(0, 0, 0, 0.18),
          0 0 18px color-mix(in srgb, var(--accent2) 28%, transparent);
        letter-spacing: 0.06em;
      }
      body[data-style-pack="pro"] .grid-cell:hover {
        filter: brightness(1.1) saturate(1.08);
      }
      body[data-style-pack="pro"] .class-card,
      body[data-style-pack="pro"] .list-class-card {
        border-color: color-mix(in srgb, var(--pro-edge-soft) 88%, transparent);
        backdrop-filter: blur(18px) saturate(1.08);
        -webkit-backdrop-filter: blur(18px) saturate(1.08);
      }
      body[data-style-pack="pro"] .class-card::after {
        background:
          radial-gradient(
            920px 260px at 0% 0%,
            rgba(255, 255, 255, 0.22),
            transparent 62%
          ),
          linear-gradient(
            128deg,
            color-mix(in srgb, var(--pro-tone-a) 60%, transparent),
            transparent 44%
          );
      }
      body[data-style-pack="pro"] .class-card:hover,
      body[data-style-pack="pro"] .list-class-card:hover {
        transform: translateY(-3px) scale(1.015);
      }
      body[data-style-pack="pro"] .class-card[data-type="odd"] {
        border-color: rgba(251, 191, 36, 0.46);
        box-shadow:
          0 20px 38px rgba(0, 0, 0, 0.3),
          inset -3px 0 0 rgba(251, 191, 36, 0.88),
          inset 0 1px 0 rgba(255, 255, 255, 0.16);
      }
      body[data-style-pack="pro"] .class-card[data-type="even"] {
        border-color: rgba(56, 189, 248, 0.48);
        box-shadow:
          0 20px 38px rgba(0, 0, 0, 0.3),
          inset -3px 0 0 rgba(56, 189, 248, 0.9),
          inset 0 1px 0 rgba(255, 255, 255, 0.16);
      }
      body[data-style-pack="pro"] .class-card[data-type="normal"] {
        border-color: color-mix(
          in srgb,
          var(--pro-edge-strong) 86%,
          transparent
        );
        box-shadow:
          0 20px 38px rgba(0, 0, 0, 0.3),
          inset -3px 0 0 color-mix(in srgb, var(--accent2) 72%, transparent),
          inset 0 1px 0 rgba(255, 255, 255, 0.16);
      }
      body[data-style-pack="pro"] .add-class-btn {
        position: relative;
        overflow: hidden;
        background: linear-gradient(
          135deg,
          color-mix(in srgb, var(--accent2) 88%, #0ea5e9 12%),
          color-mix(in srgb, var(--accent) 76%, #8b5cf6 24%)
        ) !important;
        box-shadow:
          0 18px 42px color-mix(in srgb, var(--accent2) 34%, transparent),
          inset 0 1px 0 rgba(255, 255, 255, 0.34);
      }
      body[data-style-pack="pro"] .add-class-btn::before {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(
          120deg,
          transparent 12%,
          rgba(255, 255, 255, 0.48) 50%,
          transparent 82%
        );
        transform: translateX(-150%);
        animation: proPrismLine 2.6s ease-in-out infinite;
        pointer-events: none;
      }
      body[data-style-pack="pro"] .search-input,
      body[data-style-pack="pro"] .view-switch,
      body[data-style-pack="pro"] .schedule-hint,
      body[data-style-pack="pro"] .inp {
        border-color: color-mix(in srgb, var(--pro-edge-soft) 90%, transparent);
      }
      body[data-style-pack="pro"] .inp:focus {
        box-shadow:
          0 0 0 4px color-mix(in srgb, var(--accent2) 20%, transparent),
          0 12px 30px rgba(2, 10, 28, 0.24);
      }
      body[data-style-pack="pro"] #nextClassContainer .next-minute-left {
        border-color: var(--pro-edge-strong);
        background:
          radial-gradient(
            420px 170px at 8% 0%,
            var(--pro-tone-a),
            transparent 70%
          ),
          radial-gradient(
            460px 180px at 90% 110%,
            var(--pro-tone-b),
            transparent 74%
          ),
          linear-gradient(
            122deg,
            rgba(4, 14, 28, 0.92),
            rgba(6, 30, 52, 0.86) 52%,
            rgba(7, 40, 66, 0.82)
          );
      }
      body[data-style-pack="pro"] #nextClassContainer .next-flip-digit {
        border-color: color-mix(
          in srgb,
          var(--accent2) 48%,
          rgba(148, 163, 184, 0.34)
        );
        background: linear-gradient(
          180deg,
          color-mix(in srgb, #38bdf8 18%, rgba(12, 20, 34, 0.98)),
          rgba(4, 10, 22, 0.96)
        );
      }
      body[data-style-pack="pro"] #nextClassContainer .next-flip-digit__num {
        color: color-mix(in srgb, #ffffff 90%, var(--accent2) 10%);
        text-shadow: 0 0 12px rgba(56, 189, 248, 0.36);
      }
      body[data-style-pack="pro"] .next-class-card {
        border-right-color: color-mix(
          in srgb,
          var(--accent2) 76%,
          var(--accent)
        ) !important;
        background:
          radial-gradient(
            760px 220px at 4% -10%,
            var(--pro-tone-a),
            transparent 70%
          ),
          radial-gradient(
            800px 250px at 96% 120%,
            var(--pro-tone-b),
            transparent 72%
          ),
          linear-gradient(
            162deg,
            color-mix(in srgb, var(--card-bg) 93%, transparent),
            color-mix(in srgb, var(--card-bg) 76%, transparent)
          ) !important;
      }
      body[data-style-pack="pro"] ::-webkit-scrollbar-thumb {
        background: linear-gradient(
          180deg,
          color-mix(in srgb, #22d3ee 62%, transparent),
          color-mix(in srgb, #8b5cf6 58%, transparent)
        );
      }
      @supports not (backdrop-filter: blur(2px)) {
        body[data-style-pack="pro"] .top-nav,
        body[data-style-pack="pro"] .class-card,
        body[data-style-pack="pro"] .list-class-card {
          backdrop-filter: none !important;
          -webkit-backdrop-filter: none !important;
        }
      }
      body[data-style-pack="pro"][data-anim-enabled="off"] #appLayout::before,
      body[data-style-pack="pro"][data-anim-enabled="off"] .top-nav::before,
      body[data-style-pack="pro"][data-anim-enabled="off"] .theme-card::before,
      body[data-style-pack="pro"][data-anim-enabled="off"]
        .profile-card::before,
      body[data-style-pack="pro"][data-anim-enabled="off"] .tools-panel::before,
      body[data-style-pack="pro"][data-anim-enabled="off"] .side-widget::before,
      body[data-style-pack="pro"][data-anim-enabled="off"]
        .schedule-grid::before,
      body[data-style-pack="pro"][data-anim-enabled="off"]
        .add-class-btn::before {
        animation: none !important;
        display: none !important;
      }
      body[data-perf-mode="lite"][data-style-pack="pro"] #appLayout::before,
      body[data-perf-mode="lite"][data-style-pack="pro"] .top-nav::before,
      body[data-perf-mode="lite"][data-style-pack="pro"] .theme-card::before,
      body[data-perf-mode="lite"][data-style-pack="pro"] .profile-card::before,
      body[data-perf-mode="lite"][data-style-pack="pro"] .tools-panel::before,
      body[data-perf-mode="lite"][data-style-pack="pro"] .side-widget::before,
      body[data-perf-mode="lite"][data-style-pack="pro"] .schedule-grid::before,
      body[data-perf-mode="lite"][data-style-pack="pro"]
        .add-class-btn::before {
        animation: none !important;
        display: none !important;
      }
      body[data-perf-mode="lite"][data-style-pack="pro"] .top-nav {
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
        box-shadow:
          0 10px 24px rgba(0, 0, 0, 0.22),
          inset 0 1px 0 rgba(255, 255, 255, 0.12) !important;
      }
      body[data-perf-mode="lite"][data-style-pack="pro"] .theme-card,
      body[data-perf-mode="lite"][data-style-pack="pro"] .profile-card,
      body[data-perf-mode="lite"][data-style-pack="pro"] .tools-panel,
      body[data-perf-mode="lite"][data-style-pack="pro"] .side-widget,
      body[data-perf-mode="lite"][data-style-pack="pro"] .class-card,
      body[data-perf-mode="lite"][data-style-pack="pro"] .list-class-card,
      body[data-perf-mode="lite"][data-style-pack="pro"] .mobile-day-card,
      body[data-perf-mode="lite"][data-style-pack="pro"] .mobile-class-card {
        box-shadow:
          0 10px 24px rgba(0, 0, 0, 0.2),
          inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
      }

      /* Inputs premium */
      .inp {
        width: 100%;
        padding: 0.55rem 0.7rem;
        border-radius: 14px;
        border: 1px solid var(--border);
        background: color-mix(in srgb, var(--card-bg) 70%, transparent);
        color: var(--text);
        outline: none;
        transition:
          border-color 0.18s ease,
          box-shadow 0.18s ease;
      }
      .inp:focus {
        border-color: color-mix(in srgb, var(--accent) 55%, var(--border));
        box-shadow: 0 0 0 4px color-mix(in srgb, var(--accent) 14%, transparent);
      }
      body[data-theme="mono"] .inp,
      body[data-theme="material"] .inp,
      body[data-theme="editorial"] .inp {
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(0, 0, 0, 0.12);
        color: var(--text);
      }
      .class-number-label {
        color: #fb923c;
      }
      .inp-class-number {
        border-color: rgba(251, 146, 60, 0.72);
        background: linear-gradient(
          120deg,
          rgba(251, 146, 60, 0.16),
          rgba(239, 68, 68, 0.12)
        );
      }
      .inp-class-number:focus {
        border-color: rgba(249, 115, 22, 0.94);
        box-shadow: 0 0 0 4px rgba(249, 115, 22, 0.18);
      }
      .class-suggest-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .class-suggest-row {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .class-suggest-row .inp {
        min-width: 0;
        flex: 1 1 auto;
      }
      .class-suggest-btn {
        flex: 0 0 auto;
        white-space: nowrap;
        border-radius: 12px;
        border: 1px solid color-mix(in srgb, var(--accent2) 38%, var(--border));
        background: color-mix(in srgb, var(--card-bg) 80%, transparent);
        color: var(--text);
        padding: 0.5rem 0.65rem;
        font-size: 11px;
        font-weight: 900;
        transition:
          border-color 0.18s ease,
          box-shadow 0.18s ease,
          filter 0.18s ease;
      }
      .class-suggest-btn:hover {
        filter: brightness(1.05);
      }
      .class-suggest-btn[aria-expanded="true"] {
        border-color: color-mix(in srgb, var(--accent) 50%, var(--border));
        box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 16%, transparent);
      }
      .class-suggest-panel {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }
      .class-suggest-chip {
        border: 1px solid var(--border);
        border-radius: 999px;
        padding: 4px 10px;
        font-size: 11px;
        font-weight: 800;
        line-height: 1.4;
        background: color-mix(in srgb, var(--card-bg) 82%, transparent);
        color: var(--text);
        max-width: 100%;
      }
      .class-suggest-chip:hover {
        border-color: color-mix(in srgb, var(--accent) 44%, var(--border));
        background: color-mix(in srgb, var(--accent) 14%, var(--card-bg));
      }
      .class-suggest-empty {
        font-size: 11px;
        font-weight: 700;
        opacity: 0.8;
        padding: 2px 2px 0;
      }
      .class-field-head {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 11px;
        font-weight: 900;
        line-height: 1.5;
        opacity: 0.96;
        margin-bottom: 2px;
        color: var(
          --field-label-color,
          color-mix(in srgb, var(--text) 90%, #fff 10%)
        );
      }
      .class-field-icon {
        width: 22px;
        height: 22px;
        border-radius: 9px;
        border: 1px solid
          color-mix(
            in srgb,
            var(--field-accent, var(--accent2)) 42%,
            var(--border)
          );
        background:
          radial-gradient(
            125% 125% at 28% 18%,
            color-mix(
              in srgb,
              var(--field-accent, var(--accent2)) 38%,
              transparent
            ),
            transparent 54%
          ),
          color-mix(in srgb, var(--card-bg) 86%, transparent);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        box-shadow:
          0 8px 14px rgba(0, 0, 0, 0.12),
          inset 0 1px 0 rgba(255, 255, 255, 0.18);
        flex: 0 0 auto;
        color: var(--field-icon-color, currentColor);
      }
      .class-field-icon svg {
        width: 13px;
        height: 13px;
      }
      .class-field-head--course {
        --field-accent: var(--field-course-accent, #22d3ee);
      }
      .class-field-head--prof {
        --field-accent: var(--field-prof-accent, #4ade80);
      }
      .class-field-head--classno {
        --field-accent: var(--field-classno-accent, #fb923c);
      }
      .class-form-layout {
        --field-course-accent: #22d3ee;
        --field-prof-accent: #4ade80;
        --field-classno-accent: #fb923c;
        --field-label-color: color-mix(in srgb, var(--text) 90%, #fff 10%);
      }
      body[data-theme="glass"] .class-form-layout {
        --field-course-accent: #0ea5e9;
        --field-prof-accent: #10b981;
        --field-classno-accent: #f97316;
      }
      body[data-theme="brutal"] .class-form-layout {
        --field-course-accent: #2563eb;
        --field-prof-accent: #16a34a;
        --field-classno-accent: #ea580c;
        --field-label-color: color-mix(in srgb, var(--text) 94%, #000 6%);
      }
      body[data-theme="luxury"] .class-form-layout {
        --field-course-accent: #38bdf8;
        --field-prof-accent: #34d399;
        --field-classno-accent: #f59e0b;
      }
      body[data-theme="hacker"] .class-form-layout {
        --field-course-accent: #22d3ee;
        --field-prof-accent: #22c55e;
        --field-classno-accent: #84cc16;
      }
      body[data-theme="aurora"] .class-form-layout {
        --field-course-accent: #60a5fa;
        --field-prof-accent: #34d399;
        --field-classno-accent: #fbbf24;
      }
      body[data-theme="mono"] .class-form-layout {
        --field-course-accent: #6b7280;
        --field-prof-accent: #4b5563;
        --field-classno-accent: #374151;
        --field-label-color: color-mix(in srgb, var(--text) 88%, #000 12%);
      }
      body[data-theme="soft"] .class-form-layout {
        --field-course-accent: #3b82f6;
        --field-prof-accent: #10b981;
        --field-classno-accent: #f59e0b;
      }
      body[data-theme="material"] .class-form-layout {
        --field-course-accent: #0284c7;
        --field-prof-accent: #16a34a;
        --field-classno-accent: #d97706;
        --field-label-color: color-mix(in srgb, var(--text) 94%, #000 6%);
      }
      body[data-theme="frosted"] .class-form-layout {
        --field-course-accent: #22d3ee;
        --field-prof-accent: #6ee7b7;
        --field-classno-accent: #fbbf24;
      }
      body[data-theme="editorial"] .class-form-layout {
        --field-course-accent: #2563eb;
        --field-prof-accent: #15803d;
        --field-classno-accent: #c2410c;
      }
      body[data-theme="mathlight"] .class-form-layout {
        --field-course-accent: #2563eb;
        --field-prof-accent: #0f766e;
        --field-classno-accent: #d97706;
      }
      body[data-theme="mathdark"] .class-form-layout {
        --field-course-accent: #38bdf8;
        --field-prof-accent: #2dd4bf;
        --field-classno-accent: #f59e0b;
      }
      body[data-theme="chemistrylight"] .class-form-layout {
        --field-course-accent: #0891b2;
        --field-prof-accent: #16a34a;
        --field-classno-accent: #ea580c;
      }
      body[data-theme="chemistrydark"] .class-form-layout {
        --field-course-accent: #22d3ee;
        --field-prof-accent: #4ade80;
        --field-classno-accent: #f59e0b;
      }
      .class-modal-shell {
        width: min(100%, 560px);
        max-height: min(
          calc(
            var(--app-vh) - env(safe-area-inset-top) -
              env(safe-area-inset-bottom) - 24px
          ),
          86vh
        );
        border-radius: 24px;
        border: 1px solid color-mix(in srgb, var(--accent2) 24%, var(--border));
        background:
          radial-gradient(
            140% 86% at 8% -16%,
            color-mix(in srgb, var(--accent) 12%, transparent),
            transparent 48%
          ),
          radial-gradient(
            130% 76% at 100% -18%,
            color-mix(in srgb, var(--accent2) 12%, transparent),
            transparent 44%
          ),
          color-mix(in srgb, var(--card-bg) 92%, transparent);
        padding: 18px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        overflow: hidden;
      }
      .class-modal-shell::-webkit-scrollbar {
        width: 8px;
      }
      .class-modal-shell::-webkit-scrollbar-track {
        background: color-mix(in srgb, var(--card-bg) 80%, transparent);
        border-radius: 999px;
      }
      .class-modal-shell::-webkit-scrollbar-thumb {
        background: color-mix(in srgb, var(--accent2) 40%, var(--border));
        border-radius: 999px;
      }
      .class-modal-title {
        margin: 0;
        font-size: 20px;
        line-height: 1.4;
        font-weight: 900;
      }
      .class-form-layout {
        min-height: 0;
        flex: 1 1 auto;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .class-form-scroll {
        min-height: 0;
        flex: 1 1 auto;
        display: grid;
        gap: 10px;
        overflow-y: auto;
        overscroll-behavior-y: contain;
        padding-inline-end: 4px;
        scrollbar-gutter: stable;
      }
      .class-form-scroll::-webkit-scrollbar {
        width: 8px;
      }
      .class-form-scroll::-webkit-scrollbar-track {
        background: color-mix(in srgb, var(--card-bg) 80%, transparent);
        border-radius: 999px;
      }
      .class-form-scroll::-webkit-scrollbar-thumb {
        background: color-mix(in srgb, var(--accent2) 42%, var(--border));
        border-radius: 999px;
      }
      .class-form-actions {
        margin-top: 2px;
        padding-top: 10px;
        border-top: 1px solid var(--border);
        flex: 0 0 auto;
      }
      .class-details-shell {
        margin-top: 2px;
        border-radius: 18px;
        border: 1px solid color-mix(in srgb, var(--accent2) 28%, var(--border));
        background: linear-gradient(
          160deg,
          color-mix(in srgb, var(--card-bg) 92%, transparent),
          color-mix(in srgb, var(--card-bg) 78%, transparent)
        );
        box-shadow:
          0 10px 26px rgba(0, 0, 0, 0.12),
          inset 0 1px 0 rgba(255, 255, 255, 0.08);
        overflow: hidden;
      }
      .class-details-shell--always {
        margin-top: 0;
        flex: 0 0 auto;
        border-color: color-mix(in srgb, var(--accent2) 46%, var(--border));
        box-shadow:
          0 12px 28px rgba(0, 0, 0, 0.16),
          inset 0 1px 0 rgba(255, 255, 255, 0.14);
      }
      .class-details-shell--always .class-details-toggle {
        background: linear-gradient(
          135deg,
          color-mix(in srgb, var(--accent2) 18%, transparent),
          color-mix(in srgb, var(--card-bg) 90%, transparent)
        );
      }
      .class-details-shell--always .class-details-body-wrap {
        max-height: min(34vh, 250px);
      }
      .class-details-accordion {
        border: 0;
      }
      .class-details-accordion > summary {
        list-style: none;
      }
      .class-details-accordion > summary::-webkit-details-marker {
        display: none;
      }
      .class-details-toggle {
        display: grid;
        grid-template-columns: minmax(0, 1fr) auto auto;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        padding: 11px 12px;
        user-select: none;
        transition: background-color 0.18s ease;
        color: var(--text);
      }
      .class-details-toggle:hover {
        background: color-mix(in srgb, var(--accent2) 8%, transparent);
      }
      .class-details-heading {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        min-width: 0;
      }
      .class-details-icon {
        width: 24px;
        height: 24px;
        border-radius: 8px;
        border: 1px solid color-mix(in srgb, var(--accent2) 38%, var(--border));
        background:
          radial-gradient(
            120% 120% at 30% 20%,
            color-mix(in srgb, var(--accent2) 42%, transparent),
            transparent 58%
          ),
          color-mix(in srgb, var(--accent2) 16%, transparent);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        flex: 0 0 auto;
        position: relative;
        box-shadow:
          0 6px 12px rgba(0, 0, 0, 0.14),
          inset 0 1px 0 rgba(255, 255, 255, 0.18);
      }
      .class-details-icon::after {
        content: "";
        position: absolute;
        top: -2px;
        right: -2px;
        width: 7px;
        height: 7px;
        border-radius: 999px;
        background: color-mix(in srgb, var(--accent) 78%, #fff 22%);
        box-shadow: 0 0 10px color-mix(in srgb, var(--accent) 42%, transparent);
      }
      .class-details-icon svg {
        width: 13px;
        height: 13px;
      }
      .class-details-title-copy {
        min-width: 0;
        display: grid;
        gap: 1px;
      }
      .class-details-toggle-title {
        font-size: 12px;
        font-weight: 900;
        letter-spacing: 0.01em;
        opacity: 0.96;
      }
      .class-details-toggle-sub {
        font-size: 10px;
        opacity: 0.86;
        line-height: 1.5;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .class-details-meta {
        font-size: 10px;
        font-weight: 800;
        opacity: 0.84;
        text-align: end;
        max-width: min(34vw, 18ch);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .class-details-chevron {
        width: 18px;
        height: 18px;
        border-radius: 999px;
        border: 1px solid color-mix(in srgb, var(--accent2) 38%, var(--border));
        background: color-mix(in srgb, var(--card-bg) 80%, transparent);
        position: relative;
        transition:
          transform 0.18s ease,
          border-color 0.18s ease;
      }
      .class-details-chevron::before {
        content: "";
        position: absolute;
        inset: 0;
        margin: auto;
        width: 6px;
        height: 6px;
        border-right: 2px solid currentColor;
        border-bottom: 2px solid currentColor;
        transform: rotate(45deg) translate(-1px, -1px);
        opacity: 0.84;
      }
      .class-details-accordion[open] .class-details-chevron {
        transform: rotate(180deg);
        border-color: color-mix(in srgb, var(--accent) 45%, var(--border));
      }
      .class-details-body-wrap {
        padding: 0 10px 10px;
        max-height: min(46vh, 340px);
        overflow-y: auto;
        overscroll-behavior-y: contain;
      }
      .class-details-body-wrap::-webkit-scrollbar {
        width: 7px;
      }
      .class-details-body-wrap::-webkit-scrollbar-track {
        background: color-mix(in srgb, var(--card-bg) 82%, transparent);
        border-radius: 999px;
      }
      .class-details-body-wrap::-webkit-scrollbar-thumb {
        background: color-mix(in srgb, var(--accent2) 40%, var(--border));
        border-radius: 999px;
      }
      .class-details-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 8px;
        padding-bottom: 2px;
      }
      .class-details-card {
        border-radius: 14px;
        border: 1px solid color-mix(in srgb, var(--border) 80%, transparent);
        background: color-mix(in srgb, var(--card-bg) 88%, transparent);
        padding: 8px;
        box-shadow:
          0 8px 20px rgba(0, 0, 0, 0.11),
          inset 0 1px 0 rgba(255, 255, 255, 0.09);
      }
      .class-details-card-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        margin-bottom: 6px;
      }
      .class-details-card-title {
        font-size: 11px;
        font-weight: 900;
      }
      .class-details-count {
        border-radius: 999px;
        border: 1px solid color-mix(in srgb, var(--accent) 34%, var(--border));
        background: linear-gradient(
          135deg,
          color-mix(in srgb, var(--accent2) 34%, transparent),
          color-mix(in srgb, var(--accent) 16%, var(--card-bg))
        );
        font-size: 10px;
        font-weight: 900;
        line-height: 1;
        padding: 4px 8px;
        min-width: 40px;
        text-align: center;
        letter-spacing: 0.04em;
      }
      .class-details-list {
        display: grid;
        gap: 6px;
        max-height: 128px;
        overflow-y: auto;
        padding-inline-start: 0;
        margin: 0;
        list-style: none;
      }
      .class-details-item {
        border-radius: 11px;
        padding: 6px 8px;
        border: 1px solid color-mix(in srgb, var(--border) 80%, transparent);
        background: color-mix(in srgb, var(--card-bg) 92%, transparent);
      }
      .class-details-item-title {
        font-size: 10px;
        font-weight: 900;
        line-height: 1.5;
      }
      .class-details-item-meta {
        font-size: 10px;
        opacity: 0.78;
        line-height: 1.65;
      }
      .class-details-item-sub {
        font-size: 10px;
        opacity: 0.75;
        margin-top: 2px;
      }
      .class-details-empty {
        border-radius: 10px;
        border: 1px dashed color-mix(in srgb, var(--border) 86%, transparent);
        padding: 8px;
        font-size: 10px;
        font-weight: 800;
        opacity: 0.76;
      }
      .class-details-attendance {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 6px;
      }
      .class-details-kpi {
        border-radius: 10px;
        border: 1px solid color-mix(in srgb, var(--border) 80%, transparent);
        background: color-mix(in srgb, var(--card-bg) 92%, transparent);
        padding: 6px 7px;
      }
      .class-details-kpi-label {
        font-size: 9px;
        opacity: 0.72;
        font-weight: 700;
      }
      .class-details-kpi-value {
        font-size: 12px;
        font-weight: 900;
        margin-top: 1px;
        font-family: var(--font-attendance-num);
        letter-spacing: 0.05em;
        color: color-mix(in srgb, var(--text) 88%, #fff 12%);
      }
      .class-details-count,
      .class-details-kpi-value,
      .class-details-num {
        font-family:
          var(--font-en), var(--font-attendance-num), "JetBrains Mono",
          "Fira Code", monospace;
        font-variant-numeric: tabular-nums lining-nums;
        direction: ltr;
        unicode-bidi: isolate;
      }
      .class-details-num {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0 6px;
        border-radius: 8px;
        border: 1px solid color-mix(in srgb, var(--accent2) 34%, var(--border));
        background: color-mix(in srgb, var(--accent2) 12%, var(--card-bg));
        margin-inline: 2px;
        line-height: 1.55;
        font-size: 10px;
        font-weight: 900;
      }
      @media (max-width: 1024px) {
        .class-modal-shell {
          width: min(100%, 96vw);
          max-height: calc(
            var(--app-vh) - env(safe-area-inset-top) -
              env(safe-area-inset-bottom) - 10px
          );
          border-radius: 20px;
          padding: 14px;
        }
        .class-modal-title {
          font-size: 18px;
        }
        .class-form-scroll {
          gap: 9px;
          padding-inline-end: 2px;
        }
        .class-details-body-wrap {
          max-height: min(42vh, 300px);
          padding: 0 8px 8px;
        }
        .class-details-toggle-sub {
          max-width: min(42vw, 230px);
        }
      }

      /* Table polish */
      .schedule-grid::before {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        border-radius: inherit;
        background:
          linear-gradient(
            180deg,
            color-mix(in srgb, var(--accent2) 12%, transparent),
            transparent 26%
          ),
          linear-gradient(
            90deg,
            transparent 0,
            color-mix(in srgb, var(--accent) 6%, transparent) 50%,
            transparent 100%
          );
        opacity: 0.58;
      }
      .grid-header[data-col]::before {
        content: "";
        width: 6px;
        height: 6px;
        border-radius: 999px;
        background: color-mix(in srgb, var(--accent2) 58%, transparent);
        box-shadow: 0 0 10px color-mix(in srgb, var(--accent2) 42%, transparent);
        position: absolute;
        top: 8px;
        right: 12px;
      }
      .class-card-normal {
        border-right: 3px solid
          color-mix(in srgb, var(--accent2) 40%, transparent);
      }
      .class-card-odd {
        border-right: 3px solid rgba(251, 191, 36, 0.7);
      }
      .class-card-even {
        border-right: 3px solid rgba(59, 130, 246, 0.72);
      }

      /* Profile + Schedule premium polish */
      .profile-card {
        border: 1px solid color-mix(in srgb, var(--accent2) 22%, var(--border));
        background:
          radial-gradient(
            520px 160px at 12% -10%,
            color-mix(in srgb, var(--accent) 16%, transparent),
            transparent 68%
          ),
          linear-gradient(
            170deg,
            color-mix(in srgb, var(--card-bg) 90%, transparent),
            color-mix(in srgb, var(--card-bg) 78%, transparent)
          );
        box-shadow:
          0 18px 44px rgba(0, 0, 0, 0.24),
          inset 0 1px 0 rgba(255, 255, 255, 0.18);
      }
      .profile-card::after {
        content: "";
        position: absolute;
        inset: 0 auto auto 0;
        width: 100%;
        height: 2px;
        border-radius: inherit;
        background: linear-gradient(
          90deg,
          color-mix(in srgb, var(--accent) 64%, transparent),
          color-mix(in srgb, var(--accent2) 72%, transparent)
        );
        opacity: 0.65;
        pointer-events: none;
      }
      #txtProfile {
        text-shadow: 0 0 14px
          color-mix(in srgb, var(--accent2) 20%, transparent);
      }
      .profile-card .stat-tile {
        border: 1px solid color-mix(in srgb, var(--accent2) 20%, var(--border));
        background: linear-gradient(
          145deg,
          color-mix(in srgb, var(--card-bg) 90%, transparent),
          color-mix(in srgb, var(--card-bg) 76%, transparent)
        ) !important;
        box-shadow:
          0 9px 20px rgba(0, 0, 0, 0.16),
          inset 0 1px 0 rgba(255, 255, 255, 0.14);
      }
      .profile-card .stat-tile:hover {
        transform: translateY(-2px);
        border-color: color-mix(in srgb, var(--accent2) 44%, var(--border));
      }
      .profile-card .stat-tile > div:first-child {
        font-family: var(--font-time);
        letter-spacing: 0.02em;
      }

      .schedule-frame {
        border-radius: 26px;
        padding: 2px;
        background: linear-gradient(
          135deg,
          color-mix(in srgb, var(--accent) 32%, transparent),
          transparent 28%,
          color-mix(in srgb, var(--accent2) 34%, transparent)
        );
        box-shadow: 0 22px 56px rgba(0, 0, 0, 0.26);
      }
      .schedule-grid {
        border-radius: 24px;
        isolation: isolate;
      }
      .grid-header {
        font-weight: 950;
        background: linear-gradient(
          180deg,
          color-mix(in srgb, var(--card-bg) 96%, transparent),
          color-mix(in srgb, var(--card-bg) 74%, transparent)
        );
        border-bottom: 1px solid
          color-mix(in srgb, var(--accent2) 16%, var(--border));
      }
      .time-slot {
        font-family: var(--font-time);
        letter-spacing: 0.02em;
      }
      .grid-cell {
        background: linear-gradient(
          145deg,
          color-mix(in srgb, var(--card-bg) 90%, transparent),
          color-mix(in srgb, var(--card-bg) 78%, transparent)
        );
      }
      .class-card {
        border: 1px solid color-mix(in srgb, var(--accent2) 24%, var(--border));
        background: linear-gradient(
          145deg,
          color-mix(in srgb, var(--card-bg) 96%, transparent),
          color-mix(in srgb, var(--card-bg) 78%, transparent)
        );
      }
      .class-card:hover {
        transform: translateY(-2px);
        filter: brightness(1.05);
      }
      .list-class-card {
        border: 1px solid color-mix(in srgb, var(--accent2) 24%, var(--border));
        box-shadow:
          0 10px 26px rgba(0, 0, 0, 0.18),
          inset 0 1px 0 rgba(255, 255, 255, 0.12);
      }
      .list-class-card:hover {
        transform: translateY(-2px);
      }

      body[data-perf-mode="lite"] .profile-card::after,
      body[data-perf-mode="lite"] .schedule-grid::before,
      body[data-perf-mode="lite"] .schedule-frame::before,
      body[data-perf-mode="lite"] .schedule-frame::after {
        display: none !important;
      }
      body[data-perf-mode="lite"] .profile-card .stat-tile:hover,
      body[data-perf-mode="lite"] .class-card:hover,
      body[data-perf-mode="lite"] .list-class-card:hover {
        transform: none !important;
        filter: none !important;
      }
      body[data-anim-intensity="ultra-low"] .profile-card .stat-tile:hover,
      body[data-anim-intensity="ultra-low"] .class-card:hover,
      body[data-anim-intensity="ultra-low"] .list-class-card:hover {
        transform: none !important;
      }
      /* Mobile performance + smooth scroll */
      body[data-ui-mode="mobile"] {
        overflow-x: hidden;
        overscroll-behavior-y: auto;
        scroll-behavior: auto;
        -webkit-tap-highlight-color: transparent;
        -webkit-overflow-scrolling: touch;
        -webkit-text-size-adjust: 100%;
        text-size-adjust: 100%;
      }
      body[data-ui-mode="mobile"] input,
      body[data-ui-mode="mobile"] select,
      body[data-ui-mode="mobile"] textarea,
      body[data-ui-mode="mobile"] button {
        touch-action: manipulation;
      }
      body[data-ui-mode="mobile"]
        input:not([type="checkbox"]):not([type="radio"]),
      body[data-ui-mode="mobile"] select,
      body[data-ui-mode="mobile"] textarea {
        font-size: 16px !important;
      }
      body[data-ui-mode="mobile"] .top-nav input,
      body[data-ui-mode="mobile"] .top-nav select,
      body[data-ui-mode="mobile"] .top-nav textarea {
        font-size: 12px !important;
      }
      body[data-ui-mode="mobile"] #mainPanel,
      body[data-ui-mode="mobile"] #sidePanel {
        contain: layout paint style;
      }
      body[data-ui-mode="mobile"] #scheduleContainer {
        content-visibility: auto;
        contain-intrinsic-size: 1200px;
      }
      body[data-ui-mode="mobile"] .mobile-schedule-board,
      body[data-ui-mode="mobile"] #scheduleContainer {
        touch-action: pan-y;
      }
      body[data-ui-mode="mobile"] .mobile-day-card {
        content-visibility: auto;
        contain-intrinsic-size: 250px;
        scroll-margin-top: 68px;
      }
      body[data-ui-mode="mobile"] .theme-card,
      body[data-ui-mode="mobile"] .class-card,
      body[data-ui-mode="mobile"] .mobile-class-card {
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
        box-shadow:
          0 8px 20px rgba(0, 0, 0, 0.16),
          inset 0 1px 0 rgba(255, 255, 255, 0.08) !important;
      }
      body[data-ui-mode="mobile"] .theme-card:hover,
      body[data-ui-mode="mobile"] .class-card:hover,
      body[data-ui-mode="mobile"] .mobile-class-card:hover {
        transform: none !important;
        filter: none !important;
      }
      body[data-ui-mode="mobile"] .mobile-day-card,
      body[data-ui-mode="mobile"] .mobile-class-card {
        box-shadow:
          0 12px 26px rgba(0, 0, 0, 0.2),
          inset 0 1px 0 rgba(255, 255, 255, 0.12) !important;
      }
      body[data-ui-mode="mobile"] .mobile-class-card.is-now {
        box-shadow:
          0 16px 30px rgba(0, 0, 0, 0.24),
          0 0 0 1px color-mix(in srgb, var(--accent2) 26%, transparent) inset !important;
      }
      body[data-ui-mode="mobile"] #examList,
      body[data-ui-mode="mobile"] #noteList,
      body[data-ui-mode="mobile"] #handoutList,
      body[data-ui-mode="mobile"] #alertList {
        max-height: min(42vh, 320px);
        overflow-y: auto;
        overscroll-behavior-y: auto;
        -webkit-overflow-scrolling: touch;
      }
      body[data-ui-mode="mobile"] #examList > div,
      body[data-ui-mode="mobile"] #noteList > div,
      body[data-ui-mode="mobile"] #handoutList > div,
      body[data-ui-mode="mobile"] #alertList > div,
      body[data-ui-mode="mobile"] #courseProgressList > div {
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
        transition: none !important;
      }
      body[data-ui-mode="mobile"] #examList > div,
      body[data-ui-mode="mobile"] #noteList > div,
      body[data-ui-mode="mobile"] #handoutList > div,
      body[data-ui-mode="mobile"] #alertList > div,
      body[data-ui-mode="mobile"] #courseProgressList > div {
        content-visibility: auto;
        contain: layout paint style;
        contain-intrinsic-size: 128px;
      }
      body[data-ui-mode="mobile"] .side-widget,
      body[data-ui-mode="mobile"] .profile-card,
      body[data-ui-mode="mobile"] .tools-panel,
      body[data-ui-mode="mobile"] .next-class-card {
        content-visibility: auto;
        contain-intrinsic-size: 320px;
        contain: layout paint style;
      }
      body[data-ui-mode="mobile"] #attendanceList {
        max-height: min(42vh, 320px);
        overflow-y: auto;
        overscroll-behavior-y: auto;
        -webkit-overflow-scrolling: touch;
        content-visibility: auto;
        contain: layout paint style;
        contain-intrinsic-size: 340px;
      }
      body[data-ui-mode="mobile"] .attendance-summary {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      body[data-ui-mode="mobile"] .attendance-panel-top {
        flex-direction: column;
        align-items: stretch;
      }
      body[data-ui-mode="mobile"] .attendance-filter-stack {
        min-width: 0;
      }
      body[data-ui-mode="mobile"] .attendance-tools {
        width: 100%;
      }
      body[data-ui-mode="mobile"] .attendance-tools .attendance-tool-btn {
        flex: 1 1 calc(50% - 4px);
        text-align: center;
      }
      body[data-ui-mode="mobile"] .attendance-actions {
        width: 100%;
      }
      body[data-ui-mode="mobile"] .attendance-action-btn {
        flex: 1 1 calc(33.33% - 6px);
        text-align: center;
      }
      body[data-ui-mode="mobile"] .attendance-meta-badges {
        width: 100%;
      }
      body[data-ui-mode="mobile"] .attendance-ratio-text {
        flex: 1 1 auto;
      }
      body[data-ui-mode="mobile"] #attendanceList .attendance-list-item {
        content-visibility: auto;
        contain: layout paint style;
        contain-intrinsic-size: 136px;
      }
      body[data-ui-mode="mobile"] #courseProgressList,
      body[data-ui-mode="mobile"] #attendanceSummary,
      body[data-ui-mode="mobile"] #attendanceList,
      body[data-ui-mode="mobile"] #attendanceList .attendance-list-item,
      body[data-ui-mode="mobile"] .attendance-alert-card,
      body[data-ui-mode="mobile"] .attendance-summary-item,
      body[data-ui-mode="mobile"] .attendance-segment,
      body[data-ui-mode="mobile"] .attendance-date-chip,
      body[data-ui-mode="mobile"] .attendance-tool-btn,
      body[data-ui-mode="mobile"] .attendance-action-btn,
      body[data-ui-mode="mobile"] .attendance-count-badge,
      body[data-ui-mode="mobile"] .attendance-status-pill,
      body[data-ui-mode="mobile"] .attendance-ratio-text .attendance-num,
      body[data-ui-mode="mobile"] .course-progress-stat,
      body[data-ui-mode="mobile"] #courseProgressList > div {
        background: color-mix(
          in srgb,
          var(--card-bg) 90%,
          transparent
        ) !important;
        box-shadow: none !important;
        filter: none !important;
        text-shadow: none !important;
      }
      body[data-ui-mode="mobile"] #attendanceList .attendance-list-item,
      body[data-ui-mode="mobile"] .attendance-alert-card {
        border-color: color-mix(
          in srgb,
          var(--border) 86%,
          transparent
        ) !important;
      }
      body[data-ui-mode="mobile"] #attendanceList .attendance-list-item::after,
      body[data-ui-mode="mobile"] .attendance-alert-card::after,
      body[data-ui-mode="mobile"] #courseProgressList > div::before {
        display: none !important;
      }
      body[data-ui-mode="mobile"]
        #attendanceList
        .attendance-list-item.is-risk {
        box-shadow: none !important;
      }
      body[data-ui-mode="mobile"] .attendance-status-pill::before {
        box-shadow: none !important;
      }
      body[data-ui-mode="mobile"] #attendanceList .attendance-list-item:hover,
      body[data-ui-mode="mobile"] #courseProgressList > div:hover {
        transform: none !important;
        filter: none !important;
      }
      body[data-ui-mode="mobile"] .course-progress-line > span,
      body[data-ui-mode="mobile"] .attendance-ratio-line > span {
        transition: none !important;
        box-shadow: none !important;
      }
      body[data-ui-mode="mobile"] .top-nav .top-nav-controls {
        scroll-snap-type: none;
      }
      body[data-ui-mode="mobile"] #handoutList > div {
        padding: 10px !important;
      }
      body[data-ui-mode="mobile"] #handoutList .handout-action {
        min-height: 34px;
        font-size: 11px;
        padding: 5px 10px;
      }
      body[data-ui-mode="mobile"] #handoutList .handout-thumb {
        aspect-ratio: 4 / 3;
      }
      body[data-ui-mode="mobile"] .theme-fx .fx-node:nth-child(2n),
      body[data-ui-mode="mobile"] .symbol-layer .symbol-node:nth-child(2n),
      body[data-ui-mode="mobile"] .bg-hacker .col:nth-child(2n),
      body[data-ui-mode="mobile"] .orb-c,
      body[data-ui-mode="mobile"] .grain {
        display: none !important;
      }
      body[data-ui-mode="mobile"] .theme-fx .fx-node,
      body[data-ui-mode="mobile"] .symbol-layer .symbol-node {
        animation-duration: calc(var(--dur, 10s) * 1.28) !important;
      }
      body[data-ui-mode="mobile"][data-anim-intensity="ultra-low"] .theme-fx,
      body[data-ui-mode="mobile"][data-anim-intensity="ultra-low"]
        .symbol-layer,
      body[data-ui-mode="mobile"][data-anim-intensity="ultra-low"]
        .bg-hacker
        .col,
      body[data-ui-mode="mobile"][data-anim-intensity="ultra-low"] .orb {
        display: none !important;
      }
      body[data-ui-mode="mobile"][data-anim-intensity="ultra-low"] .bg-layer,
      body[data-ui-mode="mobile"][data-anim-intensity="ultra-low"]
        .bg-layer::before,
      body[data-ui-mode="mobile"][data-anim-intensity="ultra-low"]
        .bg-layer::after {
        animation: none !important;
      }
      body[data-perf-mode="lite"] .theme-fx,
      body[data-perf-mode="lite"] .symbol-layer,
      body[data-perf-mode="lite"] .scanline,
      body[data-perf-mode="lite"] .grain,
      body[data-perf-mode="lite"] .orb-c {
        display: none !important;
      }
      body[data-perf-mode="lite"] .theme-card,
      body[data-perf-mode="lite"] .class-card,
      body[data-perf-mode="lite"] .mobile-class-card,
      body[data-perf-mode="lite"] .pinned-alert-item {
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
      }
      body[data-perf-mode="lite"] .theme-card:hover,
      body[data-perf-mode="lite"] .class-card:hover,
      body[data-perf-mode="lite"] .mobile-class-card:hover {
        transform: none !important;
        filter: none !important;
      }
      body[data-perf-mode="lite"] .theme-fx .fx-node,
      body[data-perf-mode="lite"] .symbol-layer .symbol-node,
      body[data-perf-mode="lite"] .bg-hacker .col {
        animation: none !important;
      }
      body[data-perf-mode="lite"] .notify-connect-panel,
      body[data-perf-mode="lite"] .notify-check-item,
      body[data-perf-mode="lite"] .profile-card,
      body[data-perf-mode="lite"] .schedule-frame,
      body[data-perf-mode="lite"] .schedule-grid {
        box-shadow: none !important;
      }
      body[data-perf-mode="lite"] .notify-connect-panel,
      body[data-perf-mode="lite"] .notify-check-item {
        background: color-mix(
          in srgb,
          var(--card-bg) 88%,
          transparent
        ) !important;
      }
      body[data-perf-mode="lite"] .notify-action-btn:hover,
      body[data-perf-mode="lite"] .profile-card .stat-tile:hover,
      body[data-perf-mode="lite"] .list-class-card:hover {
        transform: none !important;
      }
      body[data-perf-tier="ultra"][data-ui-mode="mobile"] #bgAnim {
        display: none !important;
      }
      body[data-perf-tier="ultra"][data-ui-mode="mobile"] .theme-card,
      body[data-perf-tier="ultra"][data-ui-mode="mobile"] .class-card,
      body[data-perf-tier="ultra"][data-ui-mode="mobile"] .mobile-class-card,
      body[data-perf-tier="ultra"][data-ui-mode="mobile"] .list-class-card,
      body[data-perf-tier="ultra"][data-ui-mode="mobile"] .side-widget,
      body[data-perf-tier="ultra"][data-ui-mode="mobile"] .profile-card {
        box-shadow: none !important;
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
      }

      /* Ultra Mobile Smooth mode (forced mobile) */
      body[data-mobile-ultra-smooth="on"][data-ui-mode="mobile"]
        #bgAnim
        .theme-fx,
      body[data-mobile-ultra-smooth="on"][data-ui-mode="mobile"]
        #bgAnim
        .symbol-layer,
      body[data-mobile-ultra-smooth="on"][data-ui-mode="mobile"]
        #bgAnim
        .scanline,
      body[data-mobile-ultra-smooth="on"][data-ui-mode="mobile"]
        #bgAnim
        .grain {
        display: none !important;
      }
      body[data-mobile-ultra-smooth="on"][data-ui-mode="mobile"] #bgAnim .orb {
        opacity: 0.08 !important;
        filter: blur(72px) !important;
      }
      body[data-mobile-ultra-smooth="on"][data-ui-mode="mobile"] .theme-card,
      body[data-mobile-ultra-smooth="on"][data-ui-mode="mobile"] .class-card,
      body[data-mobile-ultra-smooth="on"][data-ui-mode="mobile"]
        .mobile-class-card,
      body[data-mobile-ultra-smooth="on"][data-ui-mode="mobile"]
        .list-class-card,
      body[data-mobile-ultra-smooth="on"][data-ui-mode="mobile"] .tools-panel,
      body[data-mobile-ultra-smooth="on"][data-ui-mode="mobile"] .side-widget {
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
        transition: none !important;
        box-shadow:
          0 8px 18px rgba(0, 0, 0, 0.16),
          inset 0 1px 0 rgba(255, 255, 255, 0.08) !important;
      }
      body[data-mobile-ultra-smooth="on"][data-ui-mode="mobile"]
        #examList
        > div,
      body[data-mobile-ultra-smooth="on"][data-ui-mode="mobile"]
        #noteList
        > div,
      body[data-mobile-ultra-smooth="on"][data-ui-mode="mobile"]
        #alertList
        > div,
      body[data-mobile-ultra-smooth="on"][data-ui-mode="mobile"]
        #handoutList
        > div,
      body[data-mobile-ultra-smooth="on"][data-ui-mode="mobile"]
        #courseProgressList
        > div,
      body[data-mobile-ultra-smooth="on"][data-ui-mode="mobile"]
        .attendance-list-item,
      body[data-mobile-ultra-smooth="on"][data-ui-mode="mobile"]
        .pinned-alert-item {
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
        box-shadow: none !important;
        filter: none !important;
        transition: none !important;
      }
      body[data-mobile-ultra-smooth="on"][data-ui-mode="mobile"]
        .top-nav
        .top-nav-controls {
        scroll-snap-type: none !important;
      }
      body.mobile-scrolling-ultra[data-ui-mode="mobile"] #bgAnim .bg-layer,
      body.mobile-scrolling-ultra[data-ui-mode="mobile"] #bgAnim .orb {
        animation-play-state: paused !important;
      }
      body.mobile-scrolling-ultra[data-ui-mode="mobile"] #bgAnim {
        opacity: 0.35 !important;
      }

      @media (max-width: 1024px) {
        body[data-perf-tier="ultra"][data-ui-mode="auto"] #bgAnim {
          display: none !important;
        }
        body[data-perf-tier="ultra"][data-ui-mode="auto"] .theme-card,
        body[data-perf-tier="ultra"][data-ui-mode="auto"] .class-card,
        body[data-perf-tier="ultra"][data-ui-mode="auto"] .mobile-class-card,
        body[data-perf-tier="ultra"][data-ui-mode="auto"] .list-class-card,
        body[data-perf-tier="ultra"][data-ui-mode="auto"] .side-widget,
        body[data-perf-tier="ultra"][data-ui-mode="auto"] .profile-card {
          box-shadow: none !important;
          backdrop-filter: none !important;
          -webkit-backdrop-filter: none !important;
        }

        /* Ultra Mobile Smooth mode (auto in narrow viewport) */
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"]
          #bgAnim
          .theme-fx,
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"]
          #bgAnim
          .symbol-layer,
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"]
          #bgAnim
          .scanline,
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"]
          #bgAnim
          .grain {
          display: none !important;
        }
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"] #bgAnim {
          display: none !important;
        }
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"] #bgAnim .orb {
          opacity: 0.08 !important;
          filter: blur(72px) !important;
        }
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"] .theme-card,
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"] .class-card,
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"]
          .mobile-class-card,
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"]
          .list-class-card,
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"] .tools-panel,
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"] .side-widget {
          backdrop-filter: none !important;
          -webkit-backdrop-filter: none !important;
          transition: none !important;
          box-shadow:
            0 8px 18px rgba(0, 0, 0, 0.16),
            inset 0 1px 0 rgba(255, 255, 255, 0.08) !important;
        }
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"]
          #examList
          > div,
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"]
          #noteList
          > div,
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"]
          #alertList
          > div,
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"]
          #handoutList
          > div,
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"]
          #courseProgressList
          > div,
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"]
          .attendance-list-item,
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"]
          .pinned-alert-item {
          backdrop-filter: none !important;
          -webkit-backdrop-filter: none !important;
          box-shadow: none !important;
          filter: none !important;
          transition: none !important;
        }
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"]
          .top-nav
          .top-nav-controls {
          scroll-snap-type: none !important;
        }
        body.mobile-scrolling-ultra[data-ui-mode="auto"] #bgAnim .bg-layer,
        body.mobile-scrolling-ultra[data-ui-mode="auto"] #bgAnim .orb {
          animation-play-state: paused !important;
        }
        body.mobile-scrolling-ultra[data-ui-mode="auto"] #bgAnim {
          opacity: 0.35 !important;
        }
        body[data-ui-mode="auto"] {
          overflow-x: hidden;
          overscroll-behavior-y: auto;
          scroll-behavior: auto;
          -webkit-tap-highlight-color: transparent;
          -webkit-overflow-scrolling: touch;
          -webkit-text-size-adjust: 100%;
          text-size-adjust: 100%;
        }
        body[data-ui-mode="auto"] input,
        body[data-ui-mode="auto"] select,
        body[data-ui-mode="auto"] textarea,
        body[data-ui-mode="auto"] button {
          touch-action: manipulation;
        }
        body[data-ui-mode="auto"]
          input:not([type="checkbox"]):not([type="radio"]),
        body[data-ui-mode="auto"] select,
        body[data-ui-mode="auto"] textarea {
          font-size: 16px !important;
        }
        body[data-ui-mode="auto"] .top-nav input,
        body[data-ui-mode="auto"] .top-nav select,
        body[data-ui-mode="auto"] .top-nav textarea {
          font-size: 12px !important;
        }
        body[data-ui-mode="auto"] .pinned-alerts-bar {
          top: 72px;
          width: calc(100% - 14px);
        }
        body[data-ui-mode="auto"].has-pinned-alerts #appLayout {
          margin-top: 64px;
        }
        body[data-ui-mode="auto"] #mainPanel,
        body[data-ui-mode="auto"] #sidePanel {
          contain: layout paint style;
        }
        body[data-ui-mode="auto"] #scheduleContainer {
          content-visibility: auto;
          contain-intrinsic-size: 1200px;
        }
        body[data-ui-mode="auto"] .mobile-schedule-board,
        body[data-ui-mode="auto"] #scheduleContainer {
          touch-action: pan-y;
        }
        body[data-ui-mode="auto"] .mobile-day-card {
          content-visibility: auto;
          contain-intrinsic-size: 250px;
          scroll-margin-top: 68px;
        }
        body[data-ui-mode="auto"] .theme-card,
        body[data-ui-mode="auto"] .class-card,
        body[data-ui-mode="auto"] .mobile-class-card {
          backdrop-filter: none !important;
          -webkit-backdrop-filter: none !important;
          box-shadow:
            0 8px 20px rgba(0, 0, 0, 0.16),
            inset 0 1px 0 rgba(255, 255, 255, 0.08) !important;
        }
        body[data-ui-mode="auto"] .mobile-day-card,
        body[data-ui-mode="auto"] .mobile-class-card {
          box-shadow:
            0 12px 26px rgba(0, 0, 0, 0.2),
            inset 0 1px 0 rgba(255, 255, 255, 0.12) !important;
        }
        body[data-ui-mode="auto"] .mobile-class-card.is-now {
          box-shadow:
            0 16px 30px rgba(0, 0, 0, 0.24),
            0 0 0 1px color-mix(in srgb, var(--accent2) 26%, transparent) inset !important;
        }
        body[data-ui-mode="auto"] #examList,
        body[data-ui-mode="auto"] #noteList,
        body[data-ui-mode="auto"] #handoutList,
        body[data-ui-mode="auto"] #alertList {
          max-height: min(42vh, 320px);
          overflow-y: auto;
          overscroll-behavior-y: auto;
          -webkit-overflow-scrolling: touch;
        }
        body[data-ui-mode="auto"] #examList > div,
        body[data-ui-mode="auto"] #noteList > div,
        body[data-ui-mode="auto"] #handoutList > div,
        body[data-ui-mode="auto"] #alertList > div,
        body[data-ui-mode="auto"] #courseProgressList > div {
          backdrop-filter: none !important;
          -webkit-backdrop-filter: none !important;
          transition: none !important;
        }
        body[data-ui-mode="auto"] #examList > div,
        body[data-ui-mode="auto"] #noteList > div,
        body[data-ui-mode="auto"] #handoutList > div,
        body[data-ui-mode="auto"] #alertList > div,
        body[data-ui-mode="auto"] #courseProgressList > div {
          content-visibility: auto;
          contain: layout paint style;
          contain-intrinsic-size: 128px;
        }
        body[data-ui-mode="auto"] .side-widget,
        body[data-ui-mode="auto"] .profile-card,
        body[data-ui-mode="auto"] .tools-panel,
        body[data-ui-mode="auto"] .next-class-card {
          content-visibility: auto;
          contain-intrinsic-size: 320px;
          contain: layout paint style;
        }
        body[data-ui-mode="auto"] #attendanceList {
          max-height: min(42vh, 320px);
          overflow-y: auto;
          overscroll-behavior-y: auto;
          -webkit-overflow-scrolling: touch;
          content-visibility: auto;
          contain: layout paint style;
          contain-intrinsic-size: 340px;
        }
        body[data-ui-mode="auto"] .attendance-summary {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
        body[data-ui-mode="auto"] .attendance-panel-top {
          flex-direction: column;
          align-items: stretch;
        }
        body[data-ui-mode="auto"] .attendance-filter-stack {
          min-width: 0;
        }
        body[data-ui-mode="auto"] .attendance-tools {
          width: 100%;
        }
        body[data-ui-mode="auto"] .attendance-tools .attendance-tool-btn {
          flex: 1 1 calc(50% - 4px);
          text-align: center;
        }
        body[data-ui-mode="auto"] .attendance-actions {
          width: 100%;
        }
        body[data-ui-mode="auto"] .attendance-action-btn {
          flex: 1 1 calc(33.33% - 6px);
          text-align: center;
        }
        body[data-ui-mode="auto"] .attendance-meta-badges {
          width: 100%;
        }
        body[data-ui-mode="auto"] .attendance-ratio-text {
          flex: 1 1 auto;
        }
        body[data-ui-mode="auto"] #attendanceList .attendance-list-item {
          content-visibility: auto;
          contain: layout paint style;
          contain-intrinsic-size: 136px;
        }
        body[data-ui-mode="auto"] #courseProgressList,
        body[data-ui-mode="auto"] #attendanceSummary,
        body[data-ui-mode="auto"] #attendanceList,
        body[data-ui-mode="auto"] #attendanceList .attendance-list-item,
        body[data-ui-mode="auto"] .attendance-alert-card,
        body[data-ui-mode="auto"] .attendance-summary-item,
        body[data-ui-mode="auto"] .attendance-segment,
        body[data-ui-mode="auto"] .attendance-date-chip,
        body[data-ui-mode="auto"] .attendance-tool-btn,
        body[data-ui-mode="auto"] .attendance-action-btn,
        body[data-ui-mode="auto"] .attendance-count-badge,
        body[data-ui-mode="auto"] .attendance-status-pill,
        body[data-ui-mode="auto"] .attendance-ratio-text .attendance-num,
        body[data-ui-mode="auto"] .course-progress-stat,
        body[data-ui-mode="auto"] #courseProgressList > div {
          background: color-mix(
            in srgb,
            var(--card-bg) 90%,
            transparent
          ) !important;
          box-shadow: none !important;
          filter: none !important;
          text-shadow: none !important;
        }
        body[data-ui-mode="auto"] #attendanceList .attendance-list-item,
        body[data-ui-mode="auto"] .attendance-alert-card {
          border-color: color-mix(
            in srgb,
            var(--border) 86%,
            transparent
          ) !important;
        }
        body[data-ui-mode="auto"] #attendanceList .attendance-list-item::after,
        body[data-ui-mode="auto"] .attendance-alert-card::after,
        body[data-ui-mode="auto"] #courseProgressList > div::before {
          display: none !important;
        }
        body[data-ui-mode="auto"]
          #attendanceList
          .attendance-list-item.is-risk {
          box-shadow: none !important;
        }
        body[data-ui-mode="auto"] .attendance-status-pill::before {
          box-shadow: none !important;
        }
        body[data-ui-mode="auto"] #attendanceList .attendance-list-item:hover,
        body[data-ui-mode="auto"] #courseProgressList > div:hover {
          transform: none !important;
          filter: none !important;
        }
        body[data-ui-mode="auto"] .course-progress-line > span,
        body[data-ui-mode="auto"] .attendance-ratio-line > span {
          transition: none !important;
          box-shadow: none !important;
        }
        body[data-ui-mode="auto"] .top-nav .top-nav-controls {
          scroll-snap-type: none;
        }
        body[data-ui-mode="auto"] #handoutList > div {
          padding: 10px !important;
        }
        body[data-ui-mode="auto"] #handoutList .handout-action {
          min-height: 34px;
          font-size: 11px;
          padding: 5px 10px;
        }
        body[data-ui-mode="auto"] #handoutList .handout-thumb {
          aspect-ratio: 4 / 3;
        }
        body[data-ui-mode="auto"] .theme-fx .fx-node:nth-child(2n),
        body[data-ui-mode="auto"] .symbol-layer .symbol-node:nth-child(2n),
        body[data-ui-mode="auto"] .bg-hacker .col:nth-child(2n),
        body[data-ui-mode="auto"] .orb-c,
        body[data-ui-mode="auto"] .grain {
          display: none !important;
        }
        body[data-ui-mode="auto"] .theme-fx .fx-node,
        body[data-ui-mode="auto"] .symbol-layer .symbol-node {
          animation-duration: calc(var(--dur, 10s) * 1.28) !important;
        }
        body[data-ui-mode="auto"][data-anim-intensity="ultra-low"] .theme-fx,
        body[data-ui-mode="auto"][data-anim-intensity="ultra-low"]
          .symbol-layer,
        body[data-ui-mode="auto"][data-anim-intensity="ultra-low"]
          .bg-hacker
          .col,
        body[data-ui-mode="auto"][data-anim-intensity="ultra-low"] .orb {
          display: none !important;
        }
        body[data-ui-mode="auto"][data-anim-intensity="ultra-low"] .bg-layer,
        body[data-ui-mode="auto"][data-anim-intensity="ultra-low"]
          .bg-layer::before,
        body[data-ui-mode="auto"][data-anim-intensity="ultra-low"]
          .bg-layer::after {
          animation: none !important;
        }
      }

      /* Mobile interaction phase: pause costly paint while user is scrolling */
      body.mobile-scrolling[data-ui-mode="mobile"] #bgAnim .bg-layer,
      body.mobile-scrolling[data-ui-mode="mobile"] #bgAnim .orb,
      body.mobile-scrolling[data-ui-mode="mobile"] #bgAnim .theme-fx .fx-node,
      body.mobile-scrolling[data-ui-mode="mobile"]
        #bgAnim
        .symbol-layer
        .symbol-node {
        animation-play-state: paused !important;
      }
      body.mobile-scrolling[data-ui-mode="mobile"] .theme-card,
      body.mobile-scrolling[data-ui-mode="mobile"] .class-card,
      body.mobile-scrolling[data-ui-mode="mobile"] .list-class-card,
      body.mobile-scrolling[data-ui-mode="mobile"] .mobile-class-card {
        transition: none !important;
        box-shadow: none !important;
      }
      body.mobile-scrolling[data-ui-mode="mobile"] #examList > div,
      body.mobile-scrolling[data-ui-mode="mobile"] #noteList > div,
      body.mobile-scrolling[data-ui-mode="mobile"] #alertList > div,
      body.mobile-scrolling[data-ui-mode="mobile"] #handoutList > div,
      body.mobile-scrolling[data-ui-mode="mobile"] #courseProgressList > div,
      body.mobile-scrolling[data-ui-mode="mobile"] .attendance-list-item,
      body.mobile-scrolling[data-ui-mode="mobile"] .pinned-alert-item {
        transition: none !important;
        box-shadow: none !important;
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
      }
      body.mobile-scrolling[data-ui-mode="mobile"] .top-nav .top-nav-controls {
        scroll-snap-type: none !important;
      }
      body.mobile-scrolling[data-ui-mode="mobile"] #scheduleContainer {
        will-change: transform;
      }
      @media (max-width: 1024px) {
        body.mobile-scrolling[data-ui-mode="auto"] #bgAnim .bg-layer,
        body.mobile-scrolling[data-ui-mode="auto"] #bgAnim .orb,
        body.mobile-scrolling[data-ui-mode="auto"] #bgAnim .theme-fx .fx-node,
        body.mobile-scrolling[data-ui-mode="auto"]
          #bgAnim
          .symbol-layer
          .symbol-node {
          animation-play-state: paused !important;
        }
        body.mobile-scrolling[data-ui-mode="auto"] .theme-card,
        body.mobile-scrolling[data-ui-mode="auto"] .class-card,
        body.mobile-scrolling[data-ui-mode="auto"] .list-class-card,
        body.mobile-scrolling[data-ui-mode="auto"] .mobile-class-card {
          transition: none !important;
          box-shadow: none !important;
        }
        body.mobile-scrolling[data-ui-mode="auto"] #examList > div,
        body.mobile-scrolling[data-ui-mode="auto"] #noteList > div,
        body.mobile-scrolling[data-ui-mode="auto"] #alertList > div,
        body.mobile-scrolling[data-ui-mode="auto"] #handoutList > div,
        body.mobile-scrolling[data-ui-mode="auto"] #courseProgressList > div,
        body.mobile-scrolling[data-ui-mode="auto"] .attendance-list-item,
        body.mobile-scrolling[data-ui-mode="auto"] .pinned-alert-item {
          transition: none !important;
          box-shadow: none !important;
          backdrop-filter: none !important;
          -webkit-backdrop-filter: none !important;
        }
        body.mobile-scrolling[data-ui-mode="auto"] .top-nav .top-nav-controls {
          scroll-snap-type: none !important;
        }
        body.mobile-scrolling[data-ui-mode="auto"] #scheduleContainer {
          will-change: transform;
        }
      }

      /* Mobile Web Frame + UX Refinements */
      body[data-ui-mode="mobile"] {
        -webkit-tap-highlight-color: transparent;
      }
      body[data-ui-mode="mobile"] #mainPanel,
      body[data-ui-mode="mobile"] #sidePanel {
        min-width: 0;
      }
      body[data-ui-mode="mobile"] #appLayout {
        padding-top: calc(10px + env(safe-area-inset-top));
        padding-right: max(10px, env(safe-area-inset-right));
        padding-bottom: calc(12px + env(safe-area-inset-bottom));
        padding-left: max(10px, env(safe-area-inset-left));
        gap: 12px;
      }
      body[data-ui-mode="mobile"] .top-nav {
        top: calc(6px + env(safe-area-inset-top));
        border-radius: 18px;
      }
      body[data-ui-mode="mobile"] .nav-brand {
        width: 100%;
      }
      body[data-ui-mode="mobile"] .nav-title-text {
        font-size: 1rem;
      }
      body[data-ui-mode="mobile"] .nav-sub-text {
        font-size: 10px;
      }
      body[data-ui-mode="mobile"] .pinned-alerts-bar {
        top: calc(70px + env(safe-area-inset-top));
      }
      body[data-ui-mode="mobile"].has-pinned-alerts #appLayout {
        margin-top: calc(68px + env(safe-area-inset-top));
      }
      body[data-ui-mode="mobile"] .theme-card,
      body[data-ui-mode="mobile"] .mobile-day-card,
      body[data-ui-mode="mobile"] .mobile-class-card,
      body[data-ui-mode="mobile"] .list-class-card {
        border-radius: 18px !important;
      }
      body[data-ui-mode="mobile"] .top-nav .premium-select,
      body[data-ui-mode="mobile"] .top-nav .control-surface,
      body[data-ui-mode="mobile"] .top-nav .control-btn,
      body[data-ui-mode="mobile"] .top-nav .week-toggle button,
      body[data-ui-mode="mobile"] .notify-perm-btn,
      body[data-ui-mode="mobile"] .notify-bell-btn,
      body[data-ui-mode="mobile"] .mobile-add-btn,
      body[data-ui-mode="mobile"] .pinned-alert-item {
        min-height: 42px;
        touch-action: manipulation;
      }
      body[data-ui-mode="mobile"] .notify-status-hint {
        min-height: 40px;
        border-radius: 12px;
      }
      body[data-ui-mode="mobile"] .notify-connect-panel {
        padding: 8px;
        border-radius: 14px;
        max-height: min(52vh, 380px);
      }
      body[data-ui-mode="mobile"] .notify-connect-actions {
        grid-template-columns: 1fr;
      }
      body[data-ui-mode="mobile"] .notify-connect-meta {
        display: none;
      }
      body[data-ui-mode="mobile"] .notify-sw-explain {
        padding: 6px 8px;
        font-size: 10px;
      }
      body[data-ui-mode="mobile"] .notify-guide-modal {
        width: calc(100vw - 14px);
        max-height: calc(90vh - env(safe-area-inset-top));
        border-radius: 18px;
      }
      body[data-ui-mode="mobile"] .notify-guide-scroll {
        max-height: min(66vh, 520px);
      }
      body[data-ui-mode="mobile"] .notify-guide-pre {
        font-size: 11px;
        line-height: 1.68;
      }
      body[data-ui-mode="mobile"] .notify-guide-actions,
      body[data-ui-mode="mobile"] .notify-guide-actions-group {
        display: grid;
        grid-template-columns: 1fr;
      }
      body[data-ui-mode="mobile"] .notify-guide-actions .notify-action-btn {
        width: 100%;
      }
      body[data-ui-mode="mobile"] .notify-check-item {
        min-height: 32px;
      }
      body[data-ui-mode="mobile"] #examList,
      body[data-ui-mode="mobile"] #noteList,
      body[data-ui-mode="mobile"] #alertList,
      body[data-ui-mode="mobile"] #handoutList,
      body[data-ui-mode="mobile"] #courseProgressList {
        max-height: min(44vh, 320px);
      }
      body[data-ui-mode="mobile"] .symbol-layer,
      body[data-ui-mode="mobile"] .scanline {
        display: none !important;
      }
      body[data-ui-mode="mobile"] #modalOverlay {
        align-items: flex-end;
        padding-top: calc(8px + env(safe-area-inset-top));
        padding-right: max(8px, env(safe-area-inset-right));
        padding-bottom: calc(10px + env(safe-area-inset-bottom));
        padding-left: max(8px, env(safe-area-inset-left));
      }
      body[data-ui-mode="mobile"] #modalOverlay .theme-card {
        width: 100%;
        max-width: 100%;
        max-height: calc(88vh - env(safe-area-inset-top));
        overflow-y: auto;
      }
      body[data-ui-mode="mobile"] .next-class-card {
        padding: 14px !important;
      }
      body[data-ui-mode="mobile"] #nextClassContainer .next-live-meta {
        width: 100%;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 6px;
      }
      body[data-ui-mode="mobile"] #nextClassContainer .next-course-row {
        flex-direction: column;
        align-items: flex-start;
      }
      body[data-ui-mode="mobile"] #nextClassContainer .next-status-pill {
        align-self: flex-start;
      }
      body[data-ui-mode="mobile"] #nextClassContainer .next-time-panel,
      body[data-ui-mode="mobile"] #nextClassContainer .next-minute-left,
      body[data-ui-mode="mobile"] #nextClassContainer .next-countdown {
        width: 100%;
        justify-content: space-between;
      }
      body[data-ui-mode="mobile"] #nextClassContainer .next-minute-left {
        gap: 6px;
        padding: 7px 8px;
      }
      body[data-ui-mode="mobile"] #nextClassContainer .next-minute-caption {
        font-size: 8px;
        max-width: 45%;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      body[data-ui-mode="mobile"] #nextClassContainer .next-flip-track {
        gap: 2px;
      }
      body[data-ui-mode="mobile"] #nextClassContainer .next-flip-digit {
        width: 24px;
        height: 34px;
        border-radius: 7px;
      }
      body[data-ui-mode="mobile"] #nextClassContainer .next-flip-digit__num {
        font-size: 1.06rem;
      }
      body[data-ui-mode="mobile"] #nextClassContainer .next-minute-unit {
        min-width: 30px;
        height: 18px;
        padding: 0 6px;
        font-size: 8px;
      }
      body[data-ui-mode="mobile"] #nextClassContainer .next-urgency-track {
        width: 100%;
      }

      @media (max-width: 1024px) {
        body[data-ui-mode="auto"] #mainPanel,
        body[data-ui-mode="auto"] #sidePanel {
          min-width: 0;
        }
        body[data-ui-mode="auto"] #appLayout {
          padding-top: calc(10px + env(safe-area-inset-top));
          padding-right: max(10px, env(safe-area-inset-right));
          padding-bottom: calc(12px + env(safe-area-inset-bottom));
          padding-left: max(10px, env(safe-area-inset-left));
          gap: 12px;
        }
        body[data-ui-mode="auto"] .top-nav {
          top: calc(6px + env(safe-area-inset-top));
          border-radius: 18px;
        }
        body[data-ui-mode="auto"] .nav-brand {
          width: 100%;
        }
        body[data-ui-mode="auto"] .nav-title-text {
          font-size: 1rem;
        }
        body[data-ui-mode="auto"] .nav-sub-text {
          font-size: 10px;
        }
        body[data-ui-mode="auto"] .pinned-alerts-bar {
          top: calc(70px + env(safe-area-inset-top));
        }
        body[data-ui-mode="auto"].has-pinned-alerts #appLayout {
          margin-top: calc(68px + env(safe-area-inset-top));
        }
        body[data-ui-mode="auto"] .theme-card,
        body[data-ui-mode="auto"] .mobile-day-card,
        body[data-ui-mode="auto"] .mobile-class-card,
        body[data-ui-mode="auto"] .list-class-card {
          border-radius: 18px !important;
        }
        body[data-ui-mode="auto"] .top-nav .premium-select,
        body[data-ui-mode="auto"] .top-nav .control-surface,
        body[data-ui-mode="auto"] .top-nav .control-btn,
        body[data-ui-mode="auto"] .top-nav .week-toggle button,
        body[data-ui-mode="auto"] .notify-perm-btn,
        body[data-ui-mode="auto"] .notify-bell-btn,
        body[data-ui-mode="auto"] .mobile-add-btn,
        body[data-ui-mode="auto"] .pinned-alert-item {
          min-height: 42px;
          touch-action: manipulation;
        }
        body[data-ui-mode="auto"] .notify-status-hint {
          min-height: 40px;
          border-radius: 12px;
        }
        body[data-ui-mode="auto"] .top-nav .sync-auth-btn,
        body[data-ui-mode="auto"] .top-nav .anim-status-btn {
          flex: 1 1 calc(50% - 0.5rem);
          min-width: 122px;
        }
        body[data-ui-mode="auto"] .notify-connect-panel {
          padding: 8px;
          border-radius: 14px;
          max-height: min(52vh, 380px);
        }
        body[data-ui-mode="auto"] .notify-connect-actions {
          grid-template-columns: 1fr;
        }
        body[data-ui-mode="auto"] .notify-connect-meta {
          display: none;
        }
        body[data-ui-mode="auto"] .notify-sw-explain {
          padding: 6px 8px;
          font-size: 10px;
        }
        body[data-ui-mode="auto"] .notify-guide-modal {
          width: calc(100vw - 14px);
          max-height: calc(90vh - env(safe-area-inset-top));
          border-radius: 18px;
        }
        body[data-ui-mode="auto"] .notify-guide-scroll {
          max-height: min(66vh, 520px);
        }
        body[data-ui-mode="auto"] .notify-guide-pre {
          font-size: 11px;
          line-height: 1.68;
        }
        body[data-ui-mode="auto"] .notify-guide-actions,
        body[data-ui-mode="auto"] .notify-guide-actions-group {
          display: grid;
          grid-template-columns: 1fr;
        }
        body[data-ui-mode="auto"] .notify-guide-actions .notify-action-btn {
          width: 100%;
        }
        body[data-ui-mode="auto"] .notify-check-item {
          min-height: 32px;
        }
        body[data-ui-mode="auto"] #examList,
        body[data-ui-mode="auto"] #noteList,
        body[data-ui-mode="auto"] #alertList,
        body[data-ui-mode="auto"] #handoutList,
        body[data-ui-mode="auto"] #courseProgressList {
          max-height: min(44vh, 320px);
        }
        body[data-ui-mode="auto"] .symbol-layer,
        body[data-ui-mode="auto"] .scanline {
          display: none !important;
        }
        body[data-ui-mode="auto"] #modalOverlay {
          align-items: flex-end;
          padding-top: calc(8px + env(safe-area-inset-top));
          padding-right: max(8px, env(safe-area-inset-right));
          padding-bottom: calc(10px + env(safe-area-inset-bottom));
          padding-left: max(8px, env(safe-area-inset-left));
        }
        body[data-ui-mode="auto"] #modalOverlay .theme-card {
          width: 100%;
          max-width: 100%;
          max-height: calc(88vh - env(safe-area-inset-top));
          overflow-y: auto;
        }
        body[data-ui-mode="auto"] .next-class-card {
          padding: 14px !important;
        }
        body[data-ui-mode="auto"] #nextClassContainer .next-live-meta {
          width: 100%;
          justify-content: space-between;
          flex-wrap: wrap;
          gap: 6px;
        }
        body[data-ui-mode="auto"] #nextClassContainer .next-course-row {
          flex-direction: column;
          align-items: flex-start;
        }
        body[data-ui-mode="auto"] #nextClassContainer .next-status-pill {
          align-self: flex-start;
        }
        body[data-ui-mode="auto"] #nextClassContainer .next-time-panel,
        body[data-ui-mode="auto"] #nextClassContainer .next-minute-left,
        body[data-ui-mode="auto"] #nextClassContainer .next-countdown {
          width: 100%;
          justify-content: space-between;
        }
        body[data-ui-mode="auto"] #nextClassContainer .next-minute-left {
          gap: 6px;
          padding: 7px 8px;
        }
        body[data-ui-mode="auto"] #nextClassContainer .next-minute-caption {
          font-size: 8px;
          max-width: 45%;
          overflow: hidden;
          text-overflow: ellipsis;
        }
        body[data-ui-mode="auto"] #nextClassContainer .next-flip-track {
          gap: 2px;
        }
        body[data-ui-mode="auto"] #nextClassContainer .next-flip-digit {
          width: 24px;
          height: 34px;
          border-radius: 7px;
        }
        body[data-ui-mode="auto"] #nextClassContainer .next-flip-digit__num {
          font-size: 1.06rem;
        }
        body[data-ui-mode="auto"] #nextClassContainer .next-minute-unit {
          min-width: 30px;
          height: 18px;
          padding: 0 6px;
          font-size: 8px;
        }
        body[data-ui-mode="auto"] #nextClassContainer .next-urgency-track {
          width: 100%;
        }
      }

      /* Ultra Pack: mobile framing + smoother cards */
      body[data-style-pack="ultra"][data-ui-mode="mobile"] #appLayout::before,
      body[data-style-pack="ultra"][data-ui-mode="mobile"] .top-nav::before,
      body[data-style-pack="ultra"][data-ui-mode="mobile"] .top-nav::after,
      body[data-style-pack="ultra"][data-ui-mode="mobile"] .logo-badge::after,
      body[data-style-pack="ultra"][data-ui-mode="mobile"]
        .schedule-grid::before,
      body[data-style-pack="ultra"][data-ui-mode="mobile"]
        .schedule-frame::before,
      body[data-style-pack="ultra"][data-ui-mode="mobile"]
        .schedule-frame::after,
      body[data-style-pack="ultra"][data-ui-mode="mobile"]
        .profile-card::before,
      body[data-style-pack="ultra"][data-ui-mode="mobile"] .side-widget::before,
      body[data-style-pack="ultra"][data-ui-mode="mobile"] .tools-panel::before,
      body[data-style-pack="ultra"][data-ui-mode="mobile"]
        .schedule-shell::after,
      body[data-style-pack="ultra"][data-ui-mode="mobile"]
        .add-class-btn::before {
        animation: none !important;
        display: none !important;
      }
      body[data-style-pack="ultra"][data-ui-mode="mobile"] .top-nav {
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
        border-radius: 18px !important;
        box-shadow:
          0 12px 28px rgba(0, 0, 0, 0.22),
          inset 0 1px 0 rgba(255, 255, 255, 0.12) !important;
      }
      body[data-style-pack="ultra"][data-ui-mode="mobile"] .theme-card,
      body[data-style-pack="ultra"][data-ui-mode="mobile"] .tools-panel,
      body[data-style-pack="ultra"][data-ui-mode="mobile"] .mobile-day-card,
      body[data-style-pack="ultra"][data-ui-mode="mobile"] .mobile-class-card,
      body[data-style-pack="ultra"][data-ui-mode="mobile"] .list-class-card,
      body[data-style-pack="ultra"][data-ui-mode="mobile"] .class-card {
        background: color-mix(
          in srgb,
          var(--card-bg) 90%,
          transparent
        ) !important;
        border-radius: 18px !important;
        box-shadow:
          0 10px 22px rgba(0, 0, 0, 0.2),
          inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
      }
      body[data-style-pack="ultra"][data-ui-mode="mobile"] .class-card:hover,
      body[data-style-pack="ultra"][data-ui-mode="mobile"]
        .list-class-card:hover {
        transform: none !important;
        filter: none !important;
      }
      body[data-style-pack="ultra"][data-ui-mode="mobile"] .stat-tile,
      body[data-style-pack="ultra"][data-ui-mode="mobile"] .profile-card,
      body[data-style-pack="ultra"][data-ui-mode="mobile"] .side-widget {
        animation: none !important;
      }
      body[data-style-pack="ultra"][data-ui-mode="mobile"]
        .top-nav
        > div:last-child {
        width: 100%;
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 8px;
      }
      body[data-style-pack="ultra"][data-ui-mode="mobile"]
        .top-nav
        .week-toggle {
        grid-column: 1 / -1;
        width: 100%;
      }
      body[data-style-pack="ultra"][data-ui-mode="mobile"]
        .top-nav
        .premium-select,
      body[data-style-pack="ultra"][data-ui-mode="mobile"]
        .top-nav
        .control-surface,
      body[data-style-pack="ultra"][data-ui-mode="mobile"]
        .top-nav
        .control-btn,
      body[data-style-pack="ultra"][data-ui-mode="mobile"] .notify-bell-btn {
        width: 100%;
        min-width: 0 !important;
        justify-content: center;
      }
      body[data-style-pack="ultra"][data-ui-mode="mobile"] .tools-panel {
        padding: 10px !important;
        gap: 10px !important;
      }
      body[data-style-pack="ultra"][data-ui-mode="mobile"] .view-switch,
      body[data-style-pack="ultra"][data-ui-mode="mobile"] .search-input,
      body[data-style-pack="ultra"][data-ui-mode="mobile"] .add-class-btn {
        width: 100%;
      }
      body[data-style-pack="ultra"][data-ui-mode="mobile"] #examList > div,
      body[data-style-pack="ultra"][data-ui-mode="mobile"] #noteList > div,
      body[data-style-pack="ultra"][data-ui-mode="mobile"] #alertList > div,
      body[data-style-pack="ultra"][data-ui-mode="mobile"] #handoutList > div,
      body[data-style-pack="ultra"][data-ui-mode="mobile"]
        #courseProgressList
        > div {
        padding: 10px !important;
      }
      body[data-style-pack="ultra"][data-ui-mode="mobile"]
        .notify-connect-panel,
      body[data-style-pack="ultra"][data-ui-mode="mobile"] .notify-check-item {
        box-shadow: none !important;
        background: color-mix(
          in srgb,
          var(--card-bg) 90%,
          transparent
        ) !important;
      }
      body[data-style-pack="ultra"][data-ui-mode="mobile"]
        .notify-status-detail {
        max-width: 58%;
      }

      @media (max-width: 1024px) {
        body[data-style-pack="ultra"][data-ui-mode="auto"] #appLayout::before,
        body[data-style-pack="ultra"][data-ui-mode="auto"] .top-nav::before,
        body[data-style-pack="ultra"][data-ui-mode="auto"] .top-nav::after,
        body[data-style-pack="ultra"][data-ui-mode="auto"] .logo-badge::after,
        body[data-style-pack="ultra"][data-ui-mode="auto"]
          .schedule-grid::before,
        body[data-style-pack="ultra"][data-ui-mode="auto"]
          .schedule-frame::before,
        body[data-style-pack="ultra"][data-ui-mode="auto"]
          .schedule-frame::after,
        body[data-style-pack="ultra"][data-ui-mode="auto"]
          .profile-card::before,
        body[data-style-pack="ultra"][data-ui-mode="auto"] .side-widget::before,
        body[data-style-pack="ultra"][data-ui-mode="auto"] .tools-panel::before,
        body[data-style-pack="ultra"][data-ui-mode="auto"]
          .schedule-shell::after,
        body[data-style-pack="ultra"][data-ui-mode="auto"]
          .add-class-btn::before {
          animation: none !important;
          display: none !important;
        }
        body[data-style-pack="ultra"][data-ui-mode="auto"] .top-nav {
          backdrop-filter: none !important;
          -webkit-backdrop-filter: none !important;
          border-radius: 18px !important;
          box-shadow:
            0 12px 28px rgba(0, 0, 0, 0.22),
            inset 0 1px 0 rgba(255, 255, 255, 0.12) !important;
        }
        body[data-style-pack="ultra"][data-ui-mode="auto"] .theme-card,
        body[data-style-pack="ultra"][data-ui-mode="auto"] .tools-panel,
        body[data-style-pack="ultra"][data-ui-mode="auto"] .mobile-day-card,
        body[data-style-pack="ultra"][data-ui-mode="auto"] .mobile-class-card,
        body[data-style-pack="ultra"][data-ui-mode="auto"] .list-class-card,
        body[data-style-pack="ultra"][data-ui-mode="auto"] .class-card {
          background: color-mix(
            in srgb,
            var(--card-bg) 90%,
            transparent
          ) !important;
          border-radius: 18px !important;
          box-shadow:
            0 10px 22px rgba(0, 0, 0, 0.2),
            inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
        }
        body[data-style-pack="ultra"][data-ui-mode="auto"] .class-card:hover,
        body[data-style-pack="ultra"][data-ui-mode="auto"]
          .list-class-card:hover {
          transform: none !important;
          filter: none !important;
        }
        body[data-style-pack="ultra"][data-ui-mode="auto"] .stat-tile,
        body[data-style-pack="ultra"][data-ui-mode="auto"] .profile-card,
        body[data-style-pack="ultra"][data-ui-mode="auto"] .side-widget {
          animation: none !important;
        }
        body[data-style-pack="ultra"][data-ui-mode="auto"]
          .top-nav
          > div:last-child {
          width: 100%;
          display: grid;
          grid-template-columns: repeat(2, minmax(0, 1fr));
          gap: 8px;
        }
        body[data-style-pack="ultra"][data-ui-mode="auto"]
          .top-nav
          .week-toggle {
          grid-column: 1 / -1;
          width: 100%;
        }
        body[data-style-pack="ultra"][data-ui-mode="auto"]
          .top-nav
          .premium-select,
        body[data-style-pack="ultra"][data-ui-mode="auto"]
          .top-nav
          .control-surface,
        body[data-style-pack="ultra"][data-ui-mode="auto"]
          .top-nav
          .control-btn,
        body[data-style-pack="ultra"][data-ui-mode="auto"] .notify-bell-btn {
          width: 100%;
          min-width: 0 !important;
          justify-content: center;
        }
        body[data-style-pack="ultra"][data-ui-mode="auto"] .tools-panel {
          padding: 10px !important;
          gap: 10px !important;
        }
        body[data-style-pack="ultra"][data-ui-mode="auto"] .view-switch,
        body[data-style-pack="ultra"][data-ui-mode="auto"] .search-input,
        body[data-style-pack="ultra"][data-ui-mode="auto"] .add-class-btn {
          width: 100%;
        }
        body[data-style-pack="ultra"][data-ui-mode="auto"] #examList > div,
        body[data-style-pack="ultra"][data-ui-mode="auto"] #noteList > div,
        body[data-style-pack="ultra"][data-ui-mode="auto"] #alertList > div,
        body[data-style-pack="ultra"][data-ui-mode="auto"] #handoutList > div,
        body[data-style-pack="ultra"][data-ui-mode="auto"]
          #courseProgressList
          > div {
          padding: 10px !important;
        }
        body[data-style-pack="ultra"][data-ui-mode="auto"]
          .notify-connect-panel,
        body[data-style-pack="ultra"][data-ui-mode="auto"] .notify-check-item {
          box-shadow: none !important;
          background: color-mix(
            in srgb,
            var(--card-bg) 90%,
            transparent
          ) !important;
        }
        body[data-style-pack="ultra"][data-ui-mode="auto"]
          .notify-status-detail {
          max-width: 58%;
        }
      }

      /* Pro Pack: mobile/auto lite rendering */
      body[data-style-pack="pro"][data-ui-mode="mobile"] #appLayout::before,
      body[data-style-pack="pro"][data-ui-mode="mobile"] .top-nav::before,
      body[data-style-pack="pro"][data-ui-mode="mobile"] .top-nav::after,
      body[data-style-pack="pro"][data-ui-mode="mobile"] .theme-card::before,
      body[data-style-pack="pro"][data-ui-mode="mobile"] .profile-card::before,
      body[data-style-pack="pro"][data-ui-mode="mobile"] .tools-panel::before,
      body[data-style-pack="pro"][data-ui-mode="mobile"] .side-widget::before,
      body[data-style-pack="pro"][data-ui-mode="mobile"] .schedule-grid::before,
      body[data-style-pack="pro"][data-ui-mode="mobile"]
        .add-class-btn::before {
        animation: none !important;
        display: none !important;
      }
      body[data-style-pack="pro"][data-ui-mode="mobile"] .top-nav {
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
        border-radius: 18px !important;
        box-shadow:
          0 12px 28px rgba(0, 0, 0, 0.24),
          inset 0 1px 0 rgba(255, 255, 255, 0.12) !important;
      }
      body[data-style-pack="pro"][data-ui-mode="mobile"] .theme-card,
      body[data-style-pack="pro"][data-ui-mode="mobile"] .tools-panel,
      body[data-style-pack="pro"][data-ui-mode="mobile"] .mobile-day-card,
      body[data-style-pack="pro"][data-ui-mode="mobile"] .mobile-class-card,
      body[data-style-pack="pro"][data-ui-mode="mobile"] .list-class-card,
      body[data-style-pack="pro"][data-ui-mode="mobile"] .class-card {
        background: color-mix(
          in srgb,
          var(--card-bg) 92%,
          transparent
        ) !important;
        border-radius: 18px !important;
        box-shadow:
          0 10px 24px rgba(0, 0, 0, 0.22),
          inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
      }
      body[data-style-pack="pro"][data-ui-mode="mobile"] .class-card:hover,
      body[data-style-pack="pro"][data-ui-mode="mobile"]
        .list-class-card:hover {
        transform: none !important;
        filter: none !important;
      }

      @media (max-width: 1024px) {
        body[data-style-pack="pro"][data-ui-mode="auto"] #appLayout::before,
        body[data-style-pack="pro"][data-ui-mode="auto"] .top-nav::before,
        body[data-style-pack="pro"][data-ui-mode="auto"] .top-nav::after,
        body[data-style-pack="pro"][data-ui-mode="auto"] .theme-card::before,
        body[data-style-pack="pro"][data-ui-mode="auto"] .profile-card::before,
        body[data-style-pack="pro"][data-ui-mode="auto"] .tools-panel::before,
        body[data-style-pack="pro"][data-ui-mode="auto"] .side-widget::before,
        body[data-style-pack="pro"][data-ui-mode="auto"] .schedule-grid::before,
        body[data-style-pack="pro"][data-ui-mode="auto"]
          .add-class-btn::before {
          animation: none !important;
          display: none !important;
        }
        body[data-style-pack="pro"][data-ui-mode="auto"] .top-nav {
          backdrop-filter: none !important;
          -webkit-backdrop-filter: none !important;
          border-radius: 18px !important;
          box-shadow:
            0 12px 28px rgba(0, 0, 0, 0.24),
            inset 0 1px 0 rgba(255, 255, 255, 0.12) !important;
        }
        body[data-style-pack="pro"][data-ui-mode="auto"] .theme-card,
        body[data-style-pack="pro"][data-ui-mode="auto"] .tools-panel,
        body[data-style-pack="pro"][data-ui-mode="auto"] .mobile-day-card,
        body[data-style-pack="pro"][data-ui-mode="auto"] .mobile-class-card,
        body[data-style-pack="pro"][data-ui-mode="auto"] .list-class-card,
        body[data-style-pack="pro"][data-ui-mode="auto"] .class-card {
          background: color-mix(
            in srgb,
            var(--card-bg) 92%,
            transparent
          ) !important;
          border-radius: 18px !important;
          box-shadow:
            0 10px 24px rgba(0, 0, 0, 0.22),
            inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
        }
        body[data-style-pack="pro"][data-ui-mode="auto"] .class-card:hover,
        body[data-style-pack="pro"][data-ui-mode="auto"]
          .list-class-card:hover {
          transform: none !important;
          filter: none !important;
        }
      }

      /* Mobile smoothness hardening (scroll + framing + lighter paint) */
      body[data-ui-mode="mobile"] {
        touch-action: pan-y;
        overflow-anchor: auto;
      }
      body[data-ui-mode="mobile"][data-anim-enabled="on"] #bgAnim .orb {
        opacity: 0.1 !important;
        filter: blur(82px) !important;
      }
      body[data-ui-mode="mobile"][data-anim-enabled="on"]
        #bgAnim
        .theme-fx
        .fx-node {
        opacity: 0.5 !important;
      }
      body[data-ui-mode="mobile"] .side-widget {
        height: auto !important;
        min-height: 260px;
      }
      body[data-ui-mode="mobile"] .side-widget.exam-widget {
        height: min(54vh, 460px) !important;
        min-height: 260px !important;
      }
      body[data-ui-mode="mobile"] .top-nav.theme-card::before,
      body[data-ui-mode="mobile"] .top-nav.theme-card::after,
      body[data-ui-mode="mobile"] .nav-brand::before,
      body[data-ui-mode="mobile"] .logo-badge::after,
      body[data-ui-mode="mobile"] .schedule-frame::before,
      body[data-ui-mode="mobile"] .schedule-frame::after {
        display: none !important;
      }
      body[data-ui-mode="mobile"] .top-nav,
      body[data-ui-mode="mobile"] .nav-brand,
      body[data-ui-mode="mobile"] .profile-card,
      body[data-ui-mode="mobile"] .side-widget,
      body[data-ui-mode="mobile"] .pinned-alert-item {
        box-shadow: 0 8px 18px rgba(0, 0, 0, 0.18) !important;
      }
      body[data-ui-mode="mobile"] #examList,
      body[data-ui-mode="mobile"] #noteList,
      body[data-ui-mode="mobile"] #alertList,
      body[data-ui-mode="mobile"] #handoutList,
      body[data-ui-mode="mobile"] #courseProgressList,
      body[data-ui-mode="mobile"] .notify-guide-scroll,
      body[data-ui-mode="mobile"] #modalOverlay .theme-card {
        scrollbar-gutter: stable both-edges;
        overscroll-behavior-y: auto;
        touch-action: pan-y;
        -webkit-overflow-scrolling: touch;
      }

      @media (max-width: 1024px) {
        body[data-ui-mode="auto"] {
          touch-action: pan-y;
          overflow-anchor: auto;
        }
        body[data-ui-mode="auto"][data-anim-enabled="on"] #bgAnim .orb {
          opacity: 0.1 !important;
          filter: blur(82px) !important;
        }
        body[data-ui-mode="auto"][data-anim-enabled="on"]
          #bgAnim
          .theme-fx
          .fx-node {
          opacity: 0.5 !important;
        }
        body[data-ui-mode="auto"] .side-widget {
          height: auto !important;
          min-height: 260px;
        }
        body[data-ui-mode="auto"] .side-widget.exam-widget {
          height: min(54vh, 460px) !important;
          min-height: 260px !important;
        }
        body[data-ui-mode="auto"] .top-nav.theme-card::before,
        body[data-ui-mode="auto"] .top-nav.theme-card::after,
        body[data-ui-mode="auto"] .nav-brand::before,
        body[data-ui-mode="auto"] .logo-badge::after,
        body[data-ui-mode="auto"] .schedule-frame::before,
        body[data-ui-mode="auto"] .schedule-frame::after {
          display: none !important;
        }
        body[data-ui-mode="auto"] .top-nav,
        body[data-ui-mode="auto"] .nav-brand,
        body[data-ui-mode="auto"] .profile-card,
        body[data-ui-mode="auto"] .side-widget,
        body[data-ui-mode="auto"] .pinned-alert-item {
          box-shadow: 0 8px 18px rgba(0, 0, 0, 0.18) !important;
        }
        body[data-ui-mode="auto"] #examList,
        body[data-ui-mode="auto"] #noteList,
        body[data-ui-mode="auto"] #alertList,
        body[data-ui-mode="auto"] #handoutList,
        body[data-ui-mode="auto"] #courseProgressList,
        body[data-ui-mode="auto"] .notify-guide-scroll,
        body[data-ui-mode="auto"] #modalOverlay .theme-card {
          scrollbar-gutter: stable both-edges;
          overscroll-behavior-y: auto;
          touch-action: pan-y;
          -webkit-overflow-scrolling: touch;
        }
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"] .top-nav,
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"] .nav-brand,
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"] .profile-card,
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"] .side-widget,
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"] .tools-panel,
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"] .theme-card,
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"]
          .pinned-alert-item,
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"]
          #modalOverlay
          .theme-card {
          box-shadow: none !important;
          backdrop-filter: none !important;
          -webkit-backdrop-filter: none !important;
          filter: none !important;
          text-shadow: none !important;
        }
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"] #appLayout {
          max-width: 820px;
          gap: 12px;
        }
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"] .side-widget {
          min-height: 220px !important;
        }
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"]
          .side-widget.exam-widget {
          height: min(48vh, 380px) !important;
          min-height: 220px !important;
        }
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"] #examList,
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"] #noteList,
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"] #alertList,
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"] #handoutList,
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"]
          #courseProgressList,
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"]
          #attendanceList {
          max-height: min(38vh, 260px) !important;
          content-visibility: auto;
          contain: layout paint style;
          contain-intrinsic-size: 280px;
        }
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"]
          #examList
          > div,
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"]
          #noteList
          > div,
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"]
          #alertList
          > div,
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"]
          #handoutList
          > div,
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"]
          #courseProgressList
          > div,
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"]
          .attendance-list-item {
          box-shadow: none !important;
          backdrop-filter: none !important;
          -webkit-backdrop-filter: none !important;
          transition: none !important;
          content-visibility: auto;
          contain: layout paint style;
          contain-intrinsic-size: 120px;
        }
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"]
          #examList
          > div::before,
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"]
          #noteList
          > div::before,
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"]
          #alertList
          > div::before,
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"]
          #handoutList
          > div::before,
        body[data-mobile-ultra-smooth="on"][data-ui-mode="auto"]
          #courseProgressList
          > div::before {
          display: none !important;
        }
      }

      @media (hover: none), (pointer: coarse) {
        .theme-card:hover,
        .class-card:hover,
        .list-class-card:hover,
        .mobile-class-card:hover,
        #examList > div:hover,
        #noteList > div:hover,
        #alertList > div:hover,
        #handoutList > div:hover,
        #courseProgressList > div:hover {
          transform: none !important;
          filter: none !important;
        }
        .top-nav .control-btn:not(.danger-btn):hover svg,
        .top-nav .notify-bell-btn:hover svg {
          transform: none !important;
          filter: none !important;
        }
      }

      /* Mobile viewport + modal scroll stability */
      body[data-ui-mode="mobile"] {
        min-height: max(100vh, var(--app-vh));
        -webkit-overflow-scrolling: touch;
        overscroll-behavior-y: auto;
      }
      body[data-ui-mode="mobile"] #modalOverlay {
        height: var(--app-vh);
        max-height: var(--app-vh);
        overflow-y: auto;
        overscroll-behavior-y: auto;
      }
      body[data-ui-mode="mobile"] #modalOverlay .theme-card {
        max-height: calc(
          var(--app-vh) - env(safe-area-inset-top) -
            env(safe-area-inset-bottom) - 12px
        );
      }
      body[data-ui-mode="mobile"] #examList,
      body[data-ui-mode="mobile"] #noteList,
      body[data-ui-mode="mobile"] #alertList,
      body[data-ui-mode="mobile"] #handoutList,
      body[data-ui-mode="mobile"] #courseProgressList {
        max-height: min(calc(var(--app-vh) * 0.44), 320px);
      }
      body.modal-open[data-ui-mode="mobile"] {
        overflow: hidden !important;
      }

      @media (max-width: 1024px) {
        body[data-ui-mode="auto"] {
          min-height: max(100vh, var(--app-vh));
          -webkit-overflow-scrolling: touch;
          overscroll-behavior-y: auto;
        }
        body[data-ui-mode="auto"] #modalOverlay {
          height: var(--app-vh);
          max-height: var(--app-vh);
          overflow-y: auto;
          overscroll-behavior-y: auto;
        }
        body[data-ui-mode="auto"] #modalOverlay .theme-card {
          max-height: calc(
            var(--app-vh) - env(safe-area-inset-top) -
              env(safe-area-inset-bottom) - 12px
          );
        }
        body[data-ui-mode="auto"] #examList,
        body[data-ui-mode="auto"] #noteList,
        body[data-ui-mode="auto"] #alertList,
        body[data-ui-mode="auto"] #handoutList,
        body[data-ui-mode="auto"] #courseProgressList {
          max-height: min(calc(var(--app-vh) * 0.44), 320px);
        }
        body.modal-open[data-ui-mode="auto"] {
          overflow: hidden !important;
        }
      }

      /* Mobile scroll chain reliability (avoid stuck nested scroll areas) */
      body[data-ui-mode="mobile"] #mainPanel,
      body[data-ui-mode="mobile"] #sidePanel,
      body[data-ui-mode="mobile"] #mainPanel [class~="overflow-y-auto"],
      body[data-ui-mode="mobile"] #sidePanel [class~="overflow-y-auto"],
      body[data-ui-mode="mobile"] #modalOverlay [class~="overflow-y-auto"],
      body[data-ui-mode="mobile"] #examList,
      body[data-ui-mode="mobile"] #noteList,
      body[data-ui-mode="mobile"] #alertList,
      body[data-ui-mode="mobile"] #handoutList,
      body[data-ui-mode="mobile"] #courseProgressList,
      body[data-ui-mode="mobile"] #attendanceList,
      body[data-ui-mode="mobile"] .notify-connect-panel,
      body[data-ui-mode="mobile"] .notify-guide-scroll,
      body[data-ui-mode="mobile"] .sync-modal-scroll,
      body[data-ui-mode="mobile"] .sync-guide-panel,
      body[data-ui-mode="mobile"] .attendance-settings-scroll,
      body[data-ui-mode="mobile"] .attendance-settings-limit-list,
      body[data-ui-mode="mobile"] .class-form-scroll,
      body[data-ui-mode="mobile"] .class-details-body-wrap,
      body[data-ui-mode="mobile"] .class-details-list,
      body[data-ui-mode="mobile"] .exam-form-scroll,
      body[data-ui-mode="mobile"] .exam-widget-scroll,
      body[data-ui-mode="mobile"] #modalOverlay,
      body[data-ui-mode="mobile"] #modalOverlay .theme-card {
        overscroll-behavior-y: auto !important;
        -webkit-overflow-scrolling: touch !important;
        touch-action: pan-y;
      }
      body[data-ui-mode="mobile"] #mainPanel [class~="overflow-y-auto"],
      body[data-ui-mode="mobile"] #sidePanel [class~="overflow-y-auto"],
      body[data-ui-mode="mobile"] #modalOverlay [class~="overflow-y-auto"] {
        min-height: 0 !important;
        overflow-y: auto !important;
      }
      body[data-ui-mode="mobile"] #modalOverlay .profile-meta-modal {
        width: clamp(280px, 92vw, 430px) !important;
        max-width: calc(100% - 12px) !important;
        margin-inline: auto;
        display: flex !important;
        flex-direction: column;
        min-height: 0;
        max-height: calc(
          var(--profile-modal-vh, var(--app-vh)) - env(safe-area-inset-top) -
            env(safe-area-inset-bottom) - 8px
        ) !important;
        overflow: hidden !important;
      }
      body[data-ui-mode="mobile"] #modalOverlay .profile-meta-form {
        min-height: 0 !important;
        min-width: 0 !important;
        flex: 1 1 auto;
      }
      body[data-ui-mode="mobile"] #modalOverlay .profile-meta-scroll {
        min-height: 0 !important;
        overflow-y: auto !important;
        overflow-x: hidden !important;
        overscroll-behavior-y: contain !important;
        -webkit-overflow-scrolling: touch !important;
      }
      body[data-ui-mode="mobile"] .top-nav .top-nav-controls {
        overscroll-behavior-x: auto;
      }
      body[data-ui-mode="mobile"] .mobile-class-card,
      body[data-ui-mode="mobile"] .class-card,
      body[data-ui-mode="mobile"] .list-class-card,
      body[data-ui-mode="mobile"] #examList > div,
      body[data-ui-mode="mobile"] #noteList > div,
      body[data-ui-mode="mobile"] #alertList > div,
      body[data-ui-mode="mobile"] #handoutList > div,
      body[data-ui-mode="mobile"] #courseProgressList > div,
      body[data-ui-mode="mobile"] .attendance-list-item,
      body[data-ui-mode="mobile"] .pinned-alert-item {
        touch-action: pan-y !important;
      }
      body[data-ui-mode="mobile"] .mobile-class-card.is-touch-dragging,
      body[data-ui-mode="mobile"] .class-card.is-touch-dragging,
      body[data-ui-mode="mobile"] .list-class-card.is-touch-dragging,
      body[data-ui-mode="mobile"] #examList > div.is-touch-dragging,
      body[data-ui-mode="mobile"] #noteList > div.is-touch-dragging,
      body[data-ui-mode="mobile"] #alertList > div.is-touch-dragging,
      body[data-ui-mode="mobile"] #handoutList > div.is-touch-dragging,
      body[data-ui-mode="mobile"] #courseProgressList > div.is-touch-dragging,
      body[data-ui-mode="mobile"] .attendance-list-item.is-touch-dragging,
      body[data-ui-mode="mobile"] .pinned-alert-item.is-touch-dragging {
        cursor: grabbing;
      }

      @media (max-width: 1024px) {
        body[data-ui-mode="auto"] #mainPanel,
        body[data-ui-mode="auto"] #sidePanel,
        body[data-ui-mode="auto"] #mainPanel [class~="overflow-y-auto"],
        body[data-ui-mode="auto"] #sidePanel [class~="overflow-y-auto"],
        body[data-ui-mode="auto"] #modalOverlay [class~="overflow-y-auto"],
        body[data-ui-mode="auto"] #examList,
        body[data-ui-mode="auto"] #noteList,
        body[data-ui-mode="auto"] #alertList,
        body[data-ui-mode="auto"] #handoutList,
        body[data-ui-mode="auto"] #courseProgressList,
        body[data-ui-mode="auto"] #attendanceList,
        body[data-ui-mode="auto"] .notify-connect-panel,
        body[data-ui-mode="auto"] .notify-guide-scroll,
        body[data-ui-mode="auto"] .sync-modal-scroll,
        body[data-ui-mode="auto"] .sync-guide-panel,
        body[data-ui-mode="auto"] .attendance-settings-scroll,
        body[data-ui-mode="auto"] .attendance-settings-limit-list,
        body[data-ui-mode="auto"] .class-form-scroll,
        body[data-ui-mode="auto"] .class-details-body-wrap,
        body[data-ui-mode="auto"] .class-details-list,
        body[data-ui-mode="auto"] .exam-form-scroll,
        body[data-ui-mode="auto"] .exam-widget-scroll,
        body[data-ui-mode="auto"] #modalOverlay,
        body[data-ui-mode="auto"] #modalOverlay .theme-card {
          overscroll-behavior-y: auto !important;
          -webkit-overflow-scrolling: touch !important;
          touch-action: pan-y;
        }
        body[data-ui-mode="auto"] #mainPanel [class~="overflow-y-auto"],
        body[data-ui-mode="auto"] #sidePanel [class~="overflow-y-auto"],
        body[data-ui-mode="auto"] #modalOverlay [class~="overflow-y-auto"] {
          min-height: 0 !important;
          overflow-y: auto !important;
        }
        body[data-ui-mode="auto"] #modalOverlay .profile-meta-modal {
          width: clamp(280px, 92vw, 430px) !important;
          max-width: calc(100% - 12px) !important;
          margin-inline: auto;
          display: flex !important;
          flex-direction: column;
          min-height: 0;
          max-height: calc(
            var(--profile-modal-vh, var(--app-vh)) - env(safe-area-inset-top) -
              env(safe-area-inset-bottom) - 8px
          ) !important;
          overflow: hidden !important;
        }
        body[data-ui-mode="auto"] #modalOverlay .profile-meta-form {
          min-height: 0 !important;
          min-width: 0 !important;
          flex: 1 1 auto;
        }
        body[data-ui-mode="auto"] #modalOverlay .profile-meta-scroll {
          min-height: 0 !important;
          overflow-y: auto !important;
          overflow-x: hidden !important;
          overscroll-behavior-y: contain !important;
          -webkit-overflow-scrolling: touch !important;
        }
        body[data-ui-mode="auto"] .top-nav .top-nav-controls {
          overscroll-behavior-x: auto;
        }
        body[data-ui-mode="auto"] .mobile-class-card,
        body[data-ui-mode="auto"] .class-card,
        body[data-ui-mode="auto"] .list-class-card,
        body[data-ui-mode="auto"] #examList > div,
        body[data-ui-mode="auto"] #noteList > div,
        body[data-ui-mode="auto"] #alertList > div,
        body[data-ui-mode="auto"] #handoutList > div,
        body[data-ui-mode="auto"] #courseProgressList > div,
        body[data-ui-mode="auto"] .attendance-list-item,
        body[data-ui-mode="auto"] .pinned-alert-item {
          touch-action: pan-y !important;
        }
        body[data-ui-mode="auto"] .mobile-class-card.is-touch-dragging,
        body[data-ui-mode="auto"] .class-card.is-touch-dragging,
        body[data-ui-mode="auto"] .list-class-card.is-touch-dragging,
        body[data-ui-mode="auto"] #examList > div.is-touch-dragging,
        body[data-ui-mode="auto"] #noteList > div.is-touch-dragging,
        body[data-ui-mode="auto"] #alertList > div.is-touch-dragging,
        body[data-ui-mode="auto"] #handoutList > div.is-touch-dragging,
        body[data-ui-mode="auto"] #courseProgressList > div.is-touch-dragging,
        body[data-ui-mode="auto"] .attendance-list-item.is-touch-dragging,
        body[data-ui-mode="auto"] .pinned-alert-item.is-touch-dragging {
          cursor: grabbing;
        }
      }

      /* Header: fit-safe layout (desktop + mobile) */
      .top-nav {
        flex-wrap: nowrap !important;
      }
      .top-nav .nav-brand {
        flex: 0 0 auto;
        min-width: 0;
      }
      .top-nav .top-nav-controls {
        flex: 1 1 auto;
        min-width: 0;
        width: auto !important;
        max-width: 100%;
        display: flex !important;
        grid-template-columns: none !important;
        flex-wrap: nowrap !important;
        align-items: center;
        justify-content: flex-start;
        gap: 8px;
        overflow-x: auto;
        overflow-y: visible;
        overscroll-behavior-x: contain;
        scrollbar-width: none;
        -ms-overflow-style: none;
        -webkit-overflow-scrolling: touch;
        scroll-snap-type: x proximity;
        padding-bottom: 2px;
      }
      .top-nav .top-nav-controls::-webkit-scrollbar {
        display: none;
      }
      .top-nav .top-nav-controls > * {
        flex: 0 0 auto !important;
        scroll-snap-align: start;
      }
      .top-nav .top-nav-controls .week-toggle {
        width: auto !important;
        min-width: 0 !important;
      }
      .top-nav .top-nav-controls .premium-select,
      .top-nav .top-nav-controls .control-surface,
      .top-nav .top-nav-controls .control-btn,
      .top-nav .top-nav-controls .sync-auth-btn {
        width: auto !important;
        min-width: 0 !important;
        max-width: none !important;
      }
      .top-nav .top-nav-controls .premium-select-input {
        width: auto !important;
        min-width: 112px !important;
        min-height: 42px;
      }
      .top-nav .top-nav-controls #themeSelectShell .premium-select-input {
        min-width: 136px !important;
      }
      .top-nav .top-nav-controls #animIntensityShell.intensity-icon-picker {
        min-width: 126px !important;
      }
      .top-nav .top-nav-controls #uiModeShell.ui-mode-icon-picker {
        min-width: 126px !important;
        padding: 4px;
        gap: 4px;
      }
      .top-nav .ui-mode-icon-picker .ui-mode-icon-btn {
        width: 34px;
        height: 34px;
        border-radius: 10px;
      }
      .top-nav .ui-mode-icon-picker .ui-mode-icon-btn svg {
        width: 18px;
        height: 18px;
      }
      .top-nav .top-nav-controls .week-toggle button {
        min-width: 82px;
        min-height: 42px;
      }

      body[data-ui-mode="mobile"] .top-nav {
        flex-wrap: wrap !important;
        align-items: stretch;
        row-gap: 8px;
        overflow: visible;
      }
      body[data-ui-mode="mobile"] .top-nav .nav-brand {
        width: 100% !important;
        max-width: 100%;
        flex: 1 1 100%;
      }
      body[data-ui-mode="mobile"] .top-nav .top-nav-controls {
        flex: 1 1 100%;
        width: 100% !important;
        margin-top: 0;
        gap: 6px;
        overflow-x: auto !important;
        overflow-y: visible;
        scrollbar-width: thin;
        scrollbar-color: color-mix(in srgb, var(--accent2) 62%, var(--accent))
          color-mix(in srgb, var(--bg) 78%, transparent);
        -ms-overflow-style: auto;
        touch-action: pan-x pan-y;
        contain: none;
        padding-bottom: 4px;
      }
      body[data-ui-mode="mobile"]
        .top-nav
        .top-nav-controls::-webkit-scrollbar {
        display: block;
        height: 6px;
      }
      body[data-ui-mode="mobile"]
        .top-nav
        .top-nav-controls::-webkit-scrollbar-track {
        background: color-mix(in srgb, var(--bg) 78%, transparent);
        border-radius: 999px;
      }
      body[data-ui-mode="mobile"]
        .top-nav
        .top-nav-controls::-webkit-scrollbar-thumb {
        background: linear-gradient(
          90deg,
          color-mix(in srgb, var(--accent2) 70%, var(--accent)),
          color-mix(in srgb, var(--accent) 74%, var(--accent2))
        );
        border-radius: 999px;
      }
      body[data-ui-mode="mobile"] .top-nav .top-nav-controls > * {
        flex: 0 0 auto !important;
      }
      body[data-ui-mode="mobile"] .top-nav .top-nav-controls .premium-select,
      body[data-ui-mode="mobile"] .top-nav .top-nav-controls .control-surface,
      body[data-ui-mode="mobile"] .top-nav .top-nav-controls .control-btn,
      body[data-ui-mode="mobile"] .top-nav .top-nav-controls .sync-auth-btn {
        width: auto !important;
        min-width: 0 !important;
        max-width: none !important;
      }
      body[data-ui-mode="mobile"]
        .top-nav
        .top-nav-controls
        .premium-select-input {
        min-width: 100px !important;
        min-height: 40px;
        padding-inline-end: 26px !important;
      }
      body[data-ui-mode="mobile"]
        .top-nav
        .top-nav-controls
        #themeSelectShell
        .premium-select-input {
        min-width: 118px !important;
      }
      body[data-ui-mode="mobile"]
        .top-nav
        .top-nav-controls
        #packSelectShell
        .premium-select-input {
        min-width: 108px !important;
        padding-inline-start: 39px !important;
        padding-inline-end: 22px !important;
      }
      body[data-ui-mode="mobile"] .top-nav #themeSelect,
      body[data-ui-mode="mobile"] .top-nav #packSelect {
        font-size: 12.8px !important;
        font-weight: 900;
        letter-spacing: 0.015em;
        line-height: 1.2;
        text-shadow: none;
      }
      body[data-ui-mode="mobile"]
        .top-nav
        .top-nav-controls
        #animIntensityShell.intensity-icon-picker {
        min-width: 112px !important;
        padding: 3px;
        gap: 3px;
      }
      body[data-ui-mode="mobile"]
        .top-nav
        .top-nav-controls
        #uiModeShell.ui-mode-icon-picker {
        min-width: 112px !important;
        padding: 3px;
        gap: 3px;
      }
      body[data-ui-mode="mobile"]
        .top-nav
        .intensity-icon-picker
        .intensity-icon-btn {
        width: 30px;
        height: 30px;
        border-radius: 9px;
      }
      body[data-ui-mode="mobile"]
        .top-nav
        .intensity-icon-picker
        .intensity-icon-btn
        svg {
        width: 16px;
        height: 16px;
      }
      body[data-ui-mode="mobile"]
        .top-nav
        .ui-mode-icon-picker
        .ui-mode-icon-btn {
        width: 30px;
        height: 30px;
        border-radius: 9px;
      }
      body[data-ui-mode="mobile"]
        .top-nav
        .ui-mode-icon-picker
        .ui-mode-icon-btn
        svg {
        width: 16px;
        height: 16px;
      }
      body[data-ui-mode="mobile"]
        .top-nav
        .top-nav-controls
        .week-toggle
        button {
        min-width: 66px;
        min-height: 40px;
        padding-inline: 10px;
      }
      body[data-ui-mode="mobile"] .top-nav .control-surface,
      body[data-ui-mode="mobile"] .top-nav .anim-status-btn,
      body[data-ui-mode="mobile"] .top-nav .sync-auth-btn {
        height: 40px;
        min-height: 40px;
        font-size: 12px;
      }
      body[data-ui-mode="mobile"] .top-nav .anim-status-btn,
      body[data-ui-mode="mobile"] .top-nav .sync-auth-btn {
        padding-inline: 10px;
      }
      body[data-ui-mode="mobile"] .top-nav #dataIoShell.data-io-inline {
        --dio-shell-gap: 3px;
        --dio-shell-pad: 3px;
        --dio-shell-radius: 12px;
        --dio-btn-size: 30px;
        --dio-btn-icon-size: 14.5px;
        --dio-btn-radius: 9px;
        min-height: 40px;
      }
      body[data-ui-mode="mobile"] .top-nav .sync-auth-label {
        display: none;
      }
      body[data-ui-mode="mobile"] .top-nav .sync-auth-meta {
        gap: 0;
      }
      body[data-ui-mode="mobile"] .top-nav .sync-auth-state {
        max-width: 58px;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      body[data-ui-mode="mobile"] .top-nav .anim-status-short {
        max-width: 44px;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      @media (max-width: 1023.98px) {
        body[data-ui-mode="auto"] .top-nav {
          flex-wrap: wrap !important;
          align-items: stretch;
          row-gap: 8px;
          overflow: visible;
        }
        body[data-ui-mode="auto"] .top-nav .nav-brand {
          width: 100% !important;
          max-width: 100%;
          flex: 1 1 100%;
        }
        body[data-ui-mode="auto"] .top-nav .top-nav-controls {
          flex: 1 1 100%;
          width: 100% !important;
          margin-top: 0;
          gap: 6px;
          overflow-x: auto !important;
          overflow-y: visible;
          scrollbar-width: thin;
          scrollbar-color: color-mix(in srgb, var(--accent2) 62%, var(--accent))
            color-mix(in srgb, var(--bg) 78%, transparent);
          -ms-overflow-style: auto;
          touch-action: pan-x pan-y;
          contain: none;
          padding-bottom: 4px;
        }
        body[data-ui-mode="auto"]
          .top-nav
          .top-nav-controls::-webkit-scrollbar {
          display: block;
          height: 6px;
        }
        body[data-ui-mode="auto"]
          .top-nav
          .top-nav-controls::-webkit-scrollbar-track {
          background: color-mix(in srgb, var(--bg) 78%, transparent);
          border-radius: 999px;
        }
        body[data-ui-mode="auto"]
          .top-nav
          .top-nav-controls::-webkit-scrollbar-thumb {
          background: linear-gradient(
            90deg,
            color-mix(in srgb, var(--accent2) 70%, var(--accent)),
            color-mix(in srgb, var(--accent) 74%, var(--accent2))
          );
          border-radius: 999px;
        }
        body[data-ui-mode="auto"] .top-nav .top-nav-controls > * {
          flex: 0 0 auto !important;
        }
        body[data-ui-mode="auto"] .top-nav .top-nav-controls .premium-select,
        body[data-ui-mode="auto"] .top-nav .top-nav-controls .control-surface,
        body[data-ui-mode="auto"] .top-nav .top-nav-controls .control-btn,
        body[data-ui-mode="auto"] .top-nav .top-nav-controls .sync-auth-btn {
          width: auto !important;
          min-width: 0 !important;
          max-width: none !important;
        }
        body[data-ui-mode="auto"]
          .top-nav
          .top-nav-controls
          .premium-select-input {
          min-width: 100px !important;
          min-height: 40px;
          padding-inline-end: 26px !important;
        }
        body[data-ui-mode="auto"]
          .top-nav
          .top-nav-controls
          #themeSelectShell
          .premium-select-input {
          min-width: 118px !important;
        }
        body[data-ui-mode="auto"]
          .top-nav
          .top-nav-controls
          #packSelectShell
          .premium-select-input {
          min-width: 108px !important;
          padding-inline-start: 39px !important;
          padding-inline-end: 22px !important;
        }
        body[data-ui-mode="auto"] .top-nav #themeSelect,
        body[data-ui-mode="auto"] .top-nav #packSelect {
          font-size: 12.8px !important;
          font-weight: 900;
          letter-spacing: 0.015em;
          line-height: 1.2;
          text-shadow: none;
        }
        body[data-ui-mode="auto"]
          .top-nav
          .top-nav-controls
          #animIntensityShell.intensity-icon-picker {
          min-width: 112px !important;
          padding: 3px;
          gap: 3px;
        }
        body[data-ui-mode="auto"]
          .top-nav
          .top-nav-controls
          #uiModeShell.ui-mode-icon-picker {
          min-width: 112px !important;
          padding: 3px;
          gap: 3px;
        }
        body[data-ui-mode="auto"]
          .top-nav
          .intensity-icon-picker
          .intensity-icon-btn {
          width: 30px;
          height: 30px;
          border-radius: 9px;
        }
        body[data-ui-mode="auto"]
          .top-nav
          .intensity-icon-picker
          .intensity-icon-btn
          svg {
          width: 16px;
          height: 16px;
        }
        body[data-ui-mode="auto"]
          .top-nav
          .ui-mode-icon-picker
          .ui-mode-icon-btn {
          width: 30px;
          height: 30px;
          border-radius: 9px;
        }
        body[data-ui-mode="auto"]
          .top-nav
          .ui-mode-icon-picker
          .ui-mode-icon-btn
          svg {
          width: 16px;
          height: 16px;
        }
        body[data-ui-mode="auto"]
          .top-nav
          .top-nav-controls
          .week-toggle
          button {
          min-width: 66px;
          min-height: 40px;
          padding-inline: 10px;
        }
        body[data-ui-mode="auto"] .top-nav .control-surface,
        body[data-ui-mode="auto"] .top-nav .anim-status-btn,
        body[data-ui-mode="auto"] .top-nav .sync-auth-btn {
          height: 40px;
          min-height: 40px;
          font-size: 12px;
        }
        body[data-ui-mode="auto"] .top-nav .anim-status-btn,
        body[data-ui-mode="auto"] .top-nav .sync-auth-btn {
          padding-inline: 10px;
        }
        body[data-ui-mode="auto"] .top-nav #dataIoShell.data-io-inline {
          --dio-shell-gap: 3px;
          --dio-shell-pad: 3px;
          --dio-shell-radius: 12px;
          --dio-btn-size: 30px;
          --dio-btn-icon-size: 14.5px;
          --dio-btn-radius: 9px;
          min-height: 40px;
        }
        body[data-ui-mode="auto"] .top-nav .sync-auth-label {
          display: none;
        }
        body[data-ui-mode="auto"] .top-nav .sync-auth-meta {
          gap: 0;
        }
        body[data-ui-mode="auto"] .top-nav .sync-auth-state {
          max-width: 58px;
          overflow: hidden;
          text-overflow: ellipsis;
        }
        body[data-ui-mode="auto"] .top-nav .anim-status-short {
          max-width: 44px;
          overflow: hidden;
          text-overflow: ellipsis;
        }
      }

      /* ------------------------------
      UI Polish Layer (lightweight)
    ------------------------------ */
      :root {
        --ui-polish-ring: color-mix(in srgb, var(--accent2) 34%, transparent);
        --ui-polish-glow: color-mix(in srgb, var(--accent2) 22%, transparent);
      }
      .side-widget {
        position: relative;
        overflow: hidden;
        border: 1px solid color-mix(in srgb, var(--border) 84%, transparent);
        transition:
          transform 0.2s ease,
          border-color 0.2s ease,
          box-shadow 0.22s ease,
          filter 0.2s ease;
      }
      .side-widget::after {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        border-radius: inherit;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.14),
          rgba(255, 255, 255, 0) 42%
        );
        opacity: 0.4;
      }
      @media (hover: hover) and (pointer: fine) {
        .side-widget:hover {
          transform: translateY(-2px);
          border-color: color-mix(in srgb, var(--accent2) 52%, var(--border));
          box-shadow:
            0 14px 30px rgba(2, 6, 23, 0.24),
            0 0 0 1px var(--ui-polish-glow) inset;
          filter: brightness(1.03);
        }
      }
      .widget-title-wrap {
        border-color: color-mix(in srgb, var(--accent2) 40%, var(--border));
        background:
          radial-gradient(
            220px 64px at 0% -25%,
            color-mix(in srgb, var(--accent2) 16%, transparent),
            transparent 72%
          ),
          color-mix(in srgb, var(--bg) 24%, transparent);
        box-shadow:
          inset 0 1px 0 rgba(255, 255, 255, 0.16),
          0 8px 16px rgba(2, 6, 23, 0.14);
      }
      .mobile-day-card,
      .mobile-class-card {
        border-color: color-mix(in srgb, var(--accent2) 30%, var(--border));
      }
      .mobile-class-card.is-now {
        box-shadow:
          0 14px 28px rgba(2, 6, 23, 0.22),
          0 0 0 1px color-mix(in srgb, var(--accent2) 26%, transparent) inset;
      }
      .schedule-shell {
        position: relative;
        isolation: isolate;
      }
      .schedule-shell::after {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        border-radius: inherit;
        background: linear-gradient(
          120deg,
          transparent 12%,
          color-mix(in srgb, var(--accent2) 12%, transparent) 48%,
          transparent 84%
        );
        opacity: 0.55;
      }
      .control-btn:focus-visible,
      .sync-modal-btn:focus-visible,
      .sync-guide-btn:focus-visible,
      .attendance-action-btn:focus-visible,
      .attendance-tool-btn:focus-visible,
      .notify-action-btn:focus-visible {
        outline: none;
        border-color: color-mix(in srgb, var(--accent2) 64%, var(--border));
        box-shadow:
          0 0 0 3px color-mix(in srgb, var(--accent2) 18%, transparent),
          0 0 0 1px var(--ui-polish-ring) inset;
      }

      /* Theme-specific polish: Hacker */
      body[data-theme="hacker"] .top-nav {
        border-color: rgba(0, 255, 65, 0.28);
        background:
          radial-gradient(
            720px 170px at 8% -16%,
            rgba(0, 255, 65, 0.12),
            transparent 72%
          ),
          radial-gradient(
            860px 180px at 96% 120%,
            rgba(34, 211, 238, 0.12),
            transparent 74%
          ),
          color-mix(in srgb, var(--bg) 40%, transparent);
        box-shadow:
          0 18px 44px rgba(0, 0, 0, 0.48),
          inset 0 0 0 1px rgba(0, 255, 65, 0.12),
          inset 0 1px 0 rgba(255, 255, 255, 0.08);
      }
      body[data-theme="hacker"] .top-nav.theme-card::after {
        border-color: rgba(0, 255, 65, 0.26);
      }
      body[data-theme="hacker"] .side-widget {
        border-color: rgba(0, 255, 65, 0.24);
        background:
          radial-gradient(
            420px 120px at 8% -20%,
            rgba(0, 255, 65, 0.1),
            transparent 72%
          ),
          color-mix(in srgb, var(--card-bg) 86%, transparent);
        box-shadow:
          0 14px 28px rgba(0, 0, 0, 0.36),
          inset 0 0 0 1px rgba(0, 255, 65, 0.1);
      }
      body[data-theme="hacker"] .side-widget::before {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        border-radius: inherit;
        background: repeating-linear-gradient(
          to bottom,
          rgba(0, 255, 65, 0.06) 0px,
          rgba(0, 255, 65, 0.06) 1px,
          rgba(0, 0, 0, 0) 4px,
          rgba(0, 0, 0, 0) 9px
        );
        opacity: 0.24;
      }
      body[data-theme="hacker"] .widget-title-wrap {
        border-color: rgba(0, 255, 65, 0.3);
        background:
          radial-gradient(
            180px 54px at 6% -30%,
            rgba(0, 255, 65, 0.14),
            transparent 74%
          ),
          color-mix(in srgb, var(--bg) 30%, transparent);
        box-shadow:
          inset 0 1px 0 rgba(255, 255, 255, 0.1),
          0 8px 18px rgba(0, 0, 0, 0.28);
      }
      body[data-theme="hacker"] .class-card,
      body[data-theme="hacker"] .mobile-day-card,
      body[data-theme="hacker"] .mobile-class-card {
        border-color: rgba(0, 255, 65, 0.25);
        box-shadow:
          0 12px 24px rgba(0, 0, 0, 0.34),
          inset 0 0 0 1px rgba(0, 255, 65, 0.1);
      }
      body[data-theme="hacker"] .mobile-class-card.is-now {
        box-shadow:
          0 16px 30px rgba(0, 0, 0, 0.42),
          0 0 0 1px rgba(0, 255, 65, 0.34) inset,
          0 0 16px rgba(0, 255, 65, 0.18);
      }
      body[data-theme="hacker"] .top-nav .control-surface,
      body[data-theme="hacker"] .top-nav .control-btn:not(.danger-btn),
      body[data-theme="hacker"] .top-nav .week-toggle,
      body[data-theme="hacker"] .top-nav .notify-bell-btn {
        border-color: rgba(0, 255, 65, 0.28);
        box-shadow:
          0 8px 18px rgba(0, 0, 0, 0.3),
          inset 0 0 0 1px rgba(0, 255, 65, 0.08);
      }
      body[data-theme="hacker"][data-anim-enabled="off"] .side-widget::before {
        opacity: 0.32;
      }

      /* Theme-specific polish: Frosted */
      body[data-theme="frosted"] .top-nav {
        border-color: rgba(255, 255, 255, 0.2);
        background:
          radial-gradient(
            780px 180px at 8% -20%,
            rgba(45, 212, 191, 0.12),
            transparent 72%
          ),
          radial-gradient(
            900px 190px at 96% 120%,
            rgba(167, 139, 250, 0.12),
            transparent 74%
          ),
          color-mix(in srgb, var(--card-bg) 92%, transparent);
        box-shadow:
          0 20px 48px rgba(0, 0, 0, 0.4),
          inset 0 1px 0 rgba(255, 255, 255, 0.26),
          inset 0 0 0 1px rgba(255, 255, 255, 0.08);
      }
      body[data-theme="frosted"] .top-nav.theme-card::after {
        border-color: rgba(167, 139, 250, 0.28);
      }
      body[data-theme="frosted"] .side-widget {
        border-color: rgba(255, 255, 255, 0.17);
        background:
          radial-gradient(
            380px 110px at 10% -18%,
            rgba(45, 212, 191, 0.1),
            transparent 74%
          ),
          radial-gradient(
            420px 110px at 92% 118%,
            rgba(167, 139, 250, 0.1),
            transparent 74%
          ),
          color-mix(in srgb, var(--card-bg) 90%, transparent);
        box-shadow:
          0 16px 34px rgba(0, 0, 0, 0.34),
          inset 0 1px 0 rgba(255, 255, 255, 0.24);
      }
      body[data-theme="frosted"] .widget-title-wrap {
        border-color: rgba(255, 255, 255, 0.2);
        background:
          radial-gradient(
            220px 62px at 8% -24%,
            rgba(45, 212, 191, 0.16),
            transparent 74%
          ),
          color-mix(in srgb, var(--card-bg) 84%, transparent);
        box-shadow:
          inset 0 1px 0 rgba(255, 255, 255, 0.28),
          0 10px 20px rgba(0, 0, 0, 0.24);
      }
      body[data-theme="frosted"] .class-card,
      body[data-theme="frosted"] .mobile-day-card,
      body[data-theme="frosted"] .mobile-class-card {
        border-color: rgba(255, 255, 255, 0.18);
        background:
          radial-gradient(
            520px 140px at 12% -20%,
            rgba(45, 212, 191, 0.08),
            transparent 74%
          ),
          color-mix(in srgb, var(--card-bg) 88%, transparent);
        box-shadow:
          0 14px 28px rgba(0, 0, 0, 0.3),
          inset 0 1px 0 rgba(255, 255, 255, 0.24);
      }
      body[data-theme="frosted"] .mobile-class-card.is-now {
        box-shadow:
          0 16px 32px rgba(0, 0, 0, 0.36),
          0 0 0 1px rgba(167, 139, 250, 0.26) inset,
          0 0 18px rgba(45, 212, 191, 0.16);
      }
      body[data-theme="frosted"] .top-nav .control-surface,
      body[data-theme="frosted"] .top-nav .control-btn:not(.danger-btn),
      body[data-theme="frosted"] .top-nav .week-toggle,
      body[data-theme="frosted"] .top-nav .notify-bell-btn {
        border-color: rgba(255, 255, 255, 0.2);
        background:
          linear-gradient(
            145deg,
            rgba(255, 255, 255, 0.16),
            rgba(255, 255, 255, 0.06)
          ),
          color-mix(in srgb, var(--card-bg) 84%, transparent);
      }
      @media (prefers-reduced-motion: reduce) {
        .side-widget,
        .mobile-day-card,
        .mobile-class-card {
          transition: none !important;
        }
      }
    </style>
  </head>

  <body
    data-theme="mathdark"
    data-style-pack="base"
    data-anim-enabled="on"
    data-anim-intensity="high"
    data-ui-mode="auto"
    data-perf-mode="normal"
    data-mobile-ultra-smooth="off"
    class="min-h-screen text-[var(--text)] bg-[var(--bg)] font-vazir relative overflow-x-hidden"
  >
    <!-- Background Engine -->
    <div id="bgAnim" class="bg-anim-layer">
      <div class="orb orb-a animate-pulse-slow"></div>
      <div class="orb orb-b animate-float"></div>
      <div class="orb orb-c animate-float" style="animation-duration: 9s"></div>

      <div class="bg-layer bg-glass" aria-hidden="true"></div>
      <div class="bg-layer bg-brutal" aria-hidden="true"></div>
      <div class="bg-layer bg-luxury" aria-hidden="true"></div>
      <div class="bg-layer bg-hacker" aria-hidden="true"></div>
      <div class="bg-layer bg-aurora" aria-hidden="true"></div>
      <div class="bg-layer bg-mono" aria-hidden="true"></div>
      <div class="bg-layer bg-soft" aria-hidden="true"></div>
      <div class="bg-layer bg-material" aria-hidden="true"></div>
      <div class="bg-layer bg-frosted" aria-hidden="true"></div>
      <div class="bg-layer bg-editorial" aria-hidden="true"></div>
      <div class="bg-layer bg-mathlight" aria-hidden="true"></div>
      <div class="bg-layer bg-mathdark" aria-hidden="true"></div>
      <div class="bg-layer bg-chemistrylight" aria-hidden="true"></div>
      <div class="bg-layer bg-chemistrydark" aria-hidden="true"></div>

      <div class="symbol-layer sym-glass" aria-hidden="true"></div>
      <div class="symbol-layer sym-brutal" aria-hidden="true"></div>
      <div class="symbol-layer sym-luxury" aria-hidden="true"></div>
      <div class="symbol-layer sym-hacker" aria-hidden="true"></div>
      <div class="symbol-layer sym-aurora" aria-hidden="true"></div>
      <div class="symbol-layer sym-mono" aria-hidden="true"></div>
      <div class="symbol-layer sym-soft" aria-hidden="true"></div>
      <div class="symbol-layer sym-material" aria-hidden="true"></div>
      <div class="symbol-layer sym-frosted" aria-hidden="true"></div>
      <div class="symbol-layer sym-editorial" aria-hidden="true"></div>
      <div class="symbol-layer sym-mathlight" aria-hidden="true"></div>
      <div class="symbol-layer sym-mathdark" aria-hidden="true"></div>
      <div class="symbol-layer sym-chemistrylight" aria-hidden="true"></div>
      <div class="symbol-layer sym-chemistrydark" aria-hidden="true"></div>

      <div class="scanline" aria-hidden="true"></div>
      <div class="grain" aria-hidden="true"></div>
    </div>

    <div
      id="pinnedAlertsBar"
      class="pinned-alerts-bar hidden"
      aria-live="polite"
    ></div>

    <!-- Modals -->
    <div
      id="modalOverlay"
      class="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm hidden items-center justify-center p-4"
    ></div>

    <!-- Layout -->
    <div
      id="appLayout"
      class="max-w-[1600px] mx-auto p-4 lg:p-8 grid grid-cols-12 gap-6"
    >
      <!-- Navbar -->
      <nav
        class="top-nav col-span-12 theme-card p-4 flex flex-wrap items-center justify-between gap-4 sticky top-4 z-40 bg-[var(--bg)]/75"
      >
        <div class="nav-brand">
          <div class="logo-badge select-none" aria-label="Academic Master">
            <svg
              class="logo-icon"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1.9"
                d="M3 9l9-5 9 5-9 5-9-5z"
              />
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1.9"
                d="M7 11.6V15c0 .6.3 1.2.9 1.5 1 .6 2.6 1.5 4.1 1.5 1.5 0 3.1-.9 4.1-1.5.6-.3.9-.9.9-1.5v-3.4"
              />
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1.9"
                d="M21 10v5"
              />
            </svg>
          </div>
          <div class="nav-title-block">
            <h1
              id="navTitle"
              class="nav-title-text text-xl font-black tracking-tight"
            ></h1>
            <p id="navSub" class="nav-sub-text text-xs opacity-70"></p>
          </div>
        </div>

        <div class="top-nav-controls flex items-center gap-2 lg:gap-3">
          <!-- Week Toggle -->
          <div
            class="week-toggle flex p-1 rounded-2xl border border-[var(--border)] bg-[var(--bg)]/35 backdrop-blur-md"
          >
            <button
              onclick="app.setWeek('odd')"
              id="btnOdd"
              class="px-4 py-2 rounded-xl text-sm font-black transition-all"
            ></button>
            <button
              onclick="app.setWeek('even')"
              id="btnEven"
              class="px-4 py-2 rounded-xl text-sm font-black transition-all"
            ></button>
          </div>

          <!-- Theme Picker -->
          <div
            id="themeSelectShell"
            class="premium-select premium-select--theme"
            data-theme="mathdark"
          >
            <span class="premium-select-icon" aria-hidden="true">
              <span class="premium-icon-stack">
                <span class="premium-icon-state premium-icon-state--theme">
                  <svg viewBox="0 0 24 24" aria-hidden="true">
                    <circle
                      class="pi-stroke pi-theme-orbit pi-anim"
                      cx="12"
                      cy="12"
                      r="8.05"
                      stroke-dasharray="1.9 2.5"
                    />
                    <path
                      class="pi-stroke"
                      d="M12.1 6.2c-3.3 0-6 2.3-6 5.2 0 2.2 1.6 3.9 3.9 3.9h1.1c.53 0 .96.43.96.96 0 .76.61 1.37 1.37 1.37 2.9 0 5-2.19 5-5 0-3.69-3.06-6.45-6.33-6.45Z"
                    />
                    <circle
                      class="pi-theme-core pi-anim"
                      cx="9.35"
                      cy="10.15"
                      r="0.76"
                    />
                    <circle
                      class="pi-theme-core pi-anim"
                      cx="12.75"
                      cy="9.1"
                      r="0.68"
                    />
                    <path
                      class="pi-stroke pi-theme-spark pi-anim"
                      d="M16.1 6.2h2.3M17.25 5.05v2.3"
                    />
                    <path
                      class="pi-stroke pi-theme-sheen pi-anim"
                      d="M8.4 12.7h2.4"
                    />
                  </svg>
                </span>
              </span>
            </span>
            <select
              id="themeSelect"
              onchange="app.setTheme(this.value)"
              class="control-surface premium-select-input bg-transparent border border-[var(--border)] text-[var(--text)] text-sm rounded-2xl p-2.5 focus:outline-none font-black cursor-pointer backdrop-blur-md min-w-[136px]"
              title="Theme"
            ></select>
          </div>

          <!-- Style Pack -->
          <div
            id="packSelectShell"
            class="premium-select premium-select--pack"
            data-pack="base"
          >
            <span class="premium-select-icon" aria-hidden="true">
              <span class="premium-icon-stack">
                <span class="premium-icon-state premium-icon-state--base">
                  <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path
                      class="pi-stroke"
                      d="M6 9.5 12 6l6 3.5-6 3.5-6-3.5Z"
                    />
                    <path
                      class="pi-stroke pi-pack-base-float pi-anim"
                      d="M7.8 12.6 12 15l4.2-2.4"
                    />
                    <path class="pi-stroke" d="M7.8 15.2 12 17.6l4.2-2.4" />
                  </svg>
                </span>
                <span class="premium-icon-state premium-icon-state--ultra">
                  <svg viewBox="0 0 24 24" aria-hidden="true">
                    <circle
                      class="pi-stroke pi-pack-ultra-ring pi-anim"
                      cx="12"
                      cy="12"
                      r="8.2"
                      stroke-dasharray="2.2 2.6"
                    />
                    <path
                      class="pi-stroke"
                      d="M6.5 10.4 9 7.2l3 2.7 3-2.7 2.5 3.2-5.5 6.6-5.5-6.6Z"
                    />
                    <path
                      class="pi-stroke pi-pack-ultra-glint pi-anim"
                      d="M8.2 9.8h7.6"
                    />
                  </svg>
                </span>
                <span class="premium-icon-state premium-icon-state--pro">
                  <svg viewBox="0 0 24 24" aria-hidden="true">
                    <circle
                      class="pi-stroke pi-pack-pro-orbit pi-anim"
                      cx="12"
                      cy="12"
                      r="8.1"
                      stroke-dasharray="1.8 2.4"
                    />
                    <rect
                      class="pi-stroke"
                      x="8.25"
                      y="8.25"
                      width="7.5"
                      height="7.5"
                      rx="1.55"
                    />
                    <path
                      class="pi-stroke pi-pack-pro-grid pi-anim"
                      d="M12 8.25v7.5M8.25 12h7.5"
                    />
                    <circle
                      class="pi-dot pi-pack-pro-core pi-anim"
                      cx="12"
                      cy="12"
                      r="1.08"
                    />
                  </svg>
                </span>
              </span>
            </span>
            <select
              id="packSelect"
              onchange="app.setStylePack(this.value)"
              class="control-surface premium-select-input bg-transparent border border-[var(--border)] text-[var(--text)] text-sm rounded-2xl p-2.5 focus:outline-none font-black cursor-pointer backdrop-blur-md min-w-[136px]"
              title="Style Pack"
            ></select>
          </div>

          <!-- Animation Intensity (Icon Only) -->
          <div
            id="animIntensityShell"
            class="intensity-icon-picker control-surface"
            data-intensity="high"
            data-anim-enabled="on"
            title="Animation Intensity"
            role="group"
            aria-label="Animation Intensity"
          >
            <button
              type="button"
              id="btnIntensityUltraLow"
              class="intensity-icon-btn"
              data-value="ultra-low"
              aria-pressed="false"
              onclick="app.setAnimIntensity('ultra-low')"
            >
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path
                  class="ii-bolt ii-anim ii-anim-ultra"
                  d="M10.2 4.8h4.2l-2.2 4h2.7l-5.5 8 .9-5h-2.8l2.7-7Z"
                />
              </svg>
            </button>
            <button
              type="button"
              id="btnIntensityLow"
              class="intensity-icon-btn"
              data-value="low"
              aria-pressed="false"
              onclick="app.setAnimIntensity('low')"
            >
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path
                  class="ii-bolt ii-anim ii-anim-low-a"
                  d="M5.2 6.1h3.8L7 9.5h2.3l-4.3 6.4.7-4H3.8l1.4-5.8Z"
                />
                <path
                  class="ii-bolt ii-anim ii-anim-low-b"
                  d="M13.6 5.2h4.2l-2.1 3.9h2.5l-4.8 7.2.8-4.5h-2.4l1.8-6.6Z"
                />
              </svg>
            </button>
            <button
              type="button"
              id="btnIntensityHigh"
              class="intensity-icon-btn"
              data-value="high"
              aria-pressed="false"
              onclick="app.setAnimIntensity('high')"
            >
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <circle
                  class="ii-stroke ii-anim ii-core-ring"
                  cx="12"
                  cy="12"
                  r="8.2"
                  stroke-dasharray="2.2 2.8"
                />
                <path
                  class="ii-bolt ii-anim ii-anim-high-a"
                  d="M4.4 6.8h3.5L6.2 9.8h2.1l-3.6 5.5.5-3.5H3.5l.9-5Z"
                />
                <path
                  class="ii-bolt ii-anim ii-anim-high-b"
                  d="M10.1 4.9h4.1L12 8.7h2.7l-5.3 8.3.9-5.1H7.8l2.3-7Z"
                />
                <path
                  class="ii-bolt ii-anim ii-anim-high-c"
                  d="M17 6.4h3.5l-1.9 3h2.2l-3.8 5.8.5-3.6h-1.9l1.4-5.2Z"
                />
                <circle
                  class="ii-dot ii-anim ii-core-dot"
                  cx="12"
                  cy="12"
                  r="1"
                />
              </svg>
            </button>
            <select
              id="animIntensitySelect"
              onchange="app.setAnimIntensity(this.value)"
              class="hidden"
              aria-hidden="true"
              tabindex="-1"
            ></select>
          </div>

          <button
            id="btnAnimStatus"
            onclick="app.toggleAnim()"
            class="anim-status-btn control-btn"
            title="Animation Status"
            type="button"
            aria-pressed="true"
          >
            <span class="anim-status-visual" aria-hidden="true">
              <span class="anim-status-ring"></span>
              <span class="anim-status-orbit">
                <span class="anim-status-dot anim-status-dot--a"></span>
                <span class="anim-status-dot anim-status-dot--b"></span>
              </span>
              <span class="anim-status-core"></span>
            </span>
            <span id="txtAnimStatusShort" class="anim-status-short">Anim</span>
          </button>

          <!-- UI Mode -->
          <div
            id="uiModeShell"
            class="ui-mode-icon-picker control-surface"
            data-ui-mode="auto"
            title="UI Mode"
            role="group"
            aria-label="UI Mode"
          >
            <button
              type="button"
              id="btnUiModeDesktop"
              class="ui-mode-icon-btn"
              data-mode="desktop"
              aria-pressed="false"
              onclick="app.setUiMode('desktop')"
            >
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <rect
                  class="umi-stroke"
                  x="4.1"
                  y="5.2"
                  width="15.8"
                  height="10.6"
                  rx="2.1"
                />
                <path class="umi-stroke" d="M2.9 18.3h18.2" />
                <path class="umi-stroke" d="M10 18.3h4" />
                <rect
                  class="umi-fill"
                  x="6.4"
                  y="7.2"
                  width="11.2"
                  height="6.2"
                  rx="1.2"
                />
                <path
                  class="umi-stroke umi-scan uii-anim pi-laptop-scan"
                  d="M7.1 10.3h4.4"
                />
              </svg>
            </button>
            <button
              type="button"
              id="btnUiModeMobile"
              class="ui-mode-icon-btn"
              data-mode="mobile"
              aria-pressed="false"
              onclick="app.setUiMode('mobile')"
            >
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <circle
                  class="umi-stroke umi-wave uii-anim pi-phone-pulse"
                  cx="12"
                  cy="10.8"
                  r="5.3"
                />
                <rect
                  class="umi-stroke"
                  x="8"
                  y="3.8"
                  width="8"
                  height="16.4"
                  rx="2.5"
                />
                <rect
                  class="umi-fill"
                  x="9.7"
                  y="6.4"
                  width="4.6"
                  height="7.2"
                  rx="0.95"
                />
                <path
                  class="umi-stroke umi-swipe uii-anim pi-phone-swipe"
                  d="M10.1 11.1h3.8"
                />
                <circle class="umi-dot" cx="12" cy="17.1" r="0.82" />
              </svg>
            </button>
            <button
              type="button"
              id="btnUiModeAuto"
              class="ui-mode-icon-btn"
              data-mode="auto"
              aria-pressed="false"
              onclick="app.setUiMode('auto')"
            >
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <circle
                  class="umi-stroke umi-orbit uii-anim pi-auto-orbit"
                  cx="12"
                  cy="12"
                  r="8"
                  stroke-dasharray="2.1 2.3"
                />
                <rect
                  class="umi-stroke"
                  x="9"
                  y="9"
                  width="6"
                  height="6"
                  rx="1.4"
                />
                <path
                  class="umi-stroke"
                  d="M12 5.7v1.5M12 16.8v1.5M5.7 12h1.5M16.8 12h1.5"
                />
                <circle
                  class="umi-dot umi-spark uii-anim pi-auto-spark"
                  cx="17.5"
                  cy="6.5"
                  r="1.15"
                />
              </svg>
            </button>
            <select
              id="uiModeSelect"
              onchange="app.setUiMode(this.value)"
              class="hidden"
              aria-hidden="true"
              tabindex="-1"
              title="UI Mode"
            ></select>
          </div>

          <!-- Cloud Sync -->
          <button
            id="btnCloudSync"
            onclick="cloudSync.openSettingsModal()"
            class="sync-auth-btn control-btn"
            title="Cloud Sync"
            type="button"
            data-state="offline"
          >
            <span class="sync-auth-visual" aria-hidden="true">
              <span class="sync-auth-orbit">
                <span class="sync-auth-dot"></span>
              </span>
              <span class="sync-auth-ring"></span>
              <span class="sync-auth-core"></span>
            </span>
            <span class="sync-auth-meta">
              <span id="txtCloudSyncLabel" class="sync-auth-label">Sync</span>
              <span
                id="txtCloudSyncState"
                class="sync-auth-state"
                data-state="offline"
                >Offline</span
              >
            </span>
          </button>

          <div
            id="dataIoShell"
            class="data-io-inline control-surface"
            role="group"
            aria-label="JSON Data Actions"
          >
            <button
              id="btnDataExportJson"
              type="button"
              class="data-io-action data-io-action--download control-btn"
              onclick="app.exportDataJson()"
              title="Export JSON"
              aria-label="Export JSON"
            >
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <rect
                  class="dio-action-soft"
                  x="6.4"
                  y="4.7"
                  width="11.2"
                  height="8.5"
                  rx="2.25"
                />
                <path class="dio-action-stroke" d="M4.6 18.1h14.8" />
                <path class="dio-action-stroke" d="M12 7.2v8.8" />
                <path
                  class="dio-action-stroke dio-anim-down"
                  d="m8.8 12.4 3.2 3.4 3.2-3.4"
                />
                <path class="dio-action-accent dio-flow-down" d="M8 9.1h8" />
                <circle class="dio-action-core" cx="18" cy="8" r="1.05" />
              </svg>
            </button>
            <button
              id="btnDataImportJson"
              type="button"
              class="data-io-action data-io-action--upload control-btn"
              onclick="app.triggerJsonImport()"
              title="Import JSON"
              aria-label="Import JSON"
            >
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <rect
                  class="dio-action-soft"
                  x="6.4"
                  y="10.8"
                  width="11.2"
                  height="8.5"
                  rx="2.25"
                />
                <path class="dio-action-stroke" d="M4.6 18.1h14.8" />
                <path class="dio-action-stroke" d="M12 15V6.2" />
                <path
                  class="dio-action-stroke dio-anim-up"
                  d="m8.8 9.4 3.2-3.4 3.2 3.4"
                />
                <path class="dio-action-accent dio-flow-up" d="M8 14.9h8" />
                <circle class="dio-action-core" cx="18" cy="15.2" r="1.05" />
              </svg>
            </button>
          </div>
        </div>
      </nav>
      <input
        type="file"
        id="jsonImportInput"
        accept=".json,application/json"
        class="hidden"
        onchange="app.handleJsonImportInput(this)"
      />

      <!-- Sidebar -->
      <aside id="sidePanel" class="col-span-12 lg:col-span-3 space-y-6">
        <!-- Profile Stats -->
        <div class="theme-card profile-card p-6">
          <div class="profile-head">
            <div class="profile-name-stack">
              <span class="profile-name-icon" aria-hidden="true">
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="1.9"
                    d="M12 12a5 5 0 100-10 5 5 0 000 10zM4.5 21a7.5 7.5 0 0115 0"
                  />
                </svg>
              </span>
              <div class="profile-name-meta">
                <div class="flex items-center gap-2">
                  <h3 id="txtProfile" class="font-black text-lg truncate"></h3>
                  <button
                    id="btnEditProfile"
                    onclick="ui.openProfileMetaModal()"
                    class="w-7 h-7 rounded-xl border border-[var(--border)] text-[var(--muted)] hover:text-[var(--text)] hover:border-[var(--accent)] transition-colors flex items-center justify-center"
                    title="Edit Profile Name"
                  >
                    <svg
                      class="w-3.5 h-3.5"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.586a2 2 0 112.828 2.828L12 14l-4 1 1-4 8.586-8.586z"
                      />
                    </svg>
                  </button>
                </div>
                <div id="txtProfileMajor" class="profile-major-pill"></div>
              </div>
            </div>
            <span id="txtProfileTerm" class="chip profile-term-chip"></span>
          </div>
          <div class="profile-start-row">
            <div class="profile-start-head">
              <span class="profile-start-icon" aria-hidden="true">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="1.8"
                    d="M8 7V4m8 3V4m-9 6h10M5 20h14a1 1 0 001-1V8a1 1 0 00-1-1H5a1 1 0 00-1 1v11a1 1 0 001 1z"
                  />
                </svg>
              </span>
              <div class="profile-start-text">
                <div id="txtClassStartLabel" class="profile-start-label"></div>
                <div id="txtClassStartDate" class="profile-start-value"></div>
              </div>
              <button
                type="button"
                class="profile-start-edit"
                onclick="ui.openProfileMetaModal()"
              >
                
              </button>
            </div>
            <div id="txtClassStartMeta" class="profile-start-meta"></div>
          </div>

          <div class="grid grid-cols-2 gap-3 text-center">
            <div
              class="stat-tile p-3 rounded-2xl bg-[var(--bg)]/25 border border-[var(--border)] backdrop-blur-md"
            >
              <div class="text-2xl font-black" id="statUnits">17</div>
              <div
                class="text-[10px] opacity-70 font-black"
                id="txtUnits"
              ></div>
            </div>
            <div
              class="stat-tile p-3 rounded-2xl bg-[var(--bg)]/25 border border-[var(--border)] backdrop-blur-md"
            >
              <div class="text-2xl font-black" id="statHours">16.5</div>
              <div
                class="text-[10px] opacity-70 font-black"
                id="txtHours"
              ></div>
            </div>
          </div>

          <div
            class="stat-tile mt-3 p-3 rounded-2xl bg-[var(--bg)]/25 border border-[var(--border)] text-center backdrop-blur-md"
          >
            <div class="text-2xl font-black" id="statClasses">11</div>
            <div
              class="text-[10px] opacity-70 font-black"
              id="txtClasses"
            ></div>
          </div>
        </div>

        <!-- Next Class -->
        <div
          class="theme-card side-widget next-class-card p-6 relative overflow-hidden border-r-4 border-r-[var(--accent)]"
        >
          <div class="next-title-wrap">
            <span
              class="widget-title-icon widget-title-icon--next"
              aria-hidden="true"
            >
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="1.9"
                  d="M12 8v4l3 2m6-2a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
            </span>
            <h4
              id="txtNextClass"
              class="text-xs font-black opacity-60 uppercase tracking-widest"
            ></h4>
          </div>
          <div id="nextClassContainer" class="relative z-10"></div>
        </div>

        <!-- Exam Widget -->
        <div class="theme-card side-widget exam-widget p-6 flex flex-col">
          <div class="exam-widget-head">
            <div class="widget-title-wrap">
              <span
                class="widget-title-icon widget-title-icon--exam"
                aria-hidden="true"
              >
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="1.9"
                    d="M8 2v3M16 2v3M4 9h16M7 13h3M7 17h6M6 5h12a2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V7a2 2 0 012-2z"
                  />
                </svg>
              </span>
              <h4 id="txtExams" class="font-black"></h4>
            </div>
            <button
              onclick="ui.openExamModal()"
              class="exam-widget-add-btn"
              aria-label=" "
              title=" "
            >
              +
            </button>
          </div>
          <div id="examList" class="exam-widget-scroll space-y-3"></div>
        </div>

        <!-- Notes Widget -->
        <div class="theme-card side-widget p-6 flex flex-col h-[340px]">
          <div class="flex justify-between items-center mb-4">
            <div class="widget-title-wrap">
              <span
                class="widget-title-icon widget-title-icon--note"
                aria-hidden="true"
              >
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="1.9"
                    d="M7 3h7l5 5v13a1 1 0 01-1 1H7a2 2 0 01-2-2V5a2 2 0 012-2z"
                  />
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="1.9"
                    d="M14 3v5h5M9 13h6M9 17h4"
                  />
                </svg>
              </span>
              <h4 id="txtNotesBoard" class="font-black"></h4>
            </div>
            <button
              onclick="ui.openNoteModal()"
              class="w-8 h-8 flex items-center justify-center rounded-full bg-[var(--accent)] text-[var(--bg)] hover:scale-110 transition-transform font-black shadow-lg"
            >
              +
            </button>
          </div>
          <div
            id="noteList"
            class="flex-1 overflow-y-auto space-y-3 pr-2"
          ></div>
        </div>

        <!-- Handouts Widget -->
        <div class="theme-card side-widget p-6 flex flex-col h-[340px]">
          <div class="flex justify-between items-center mb-4">
            <div class="flex items-center gap-2">
              <span
                class="inline-flex items-center justify-center w-7 h-7 rounded-xl border border-[var(--border)] bg-[var(--bg)]/30"
                aria-hidden="true"
              >
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="1.8"
                    d="M7 3h7l5 5v13a1 1 0 01-1 1H7a2 2 0 01-2-2V5a2 2 0 012-2z"
                  />
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="1.8"
                    d="M14 3v5h5M9 13h6M9 17h6"
                  />
                </svg>
              </span>
              <h4 id="txtHandouts" class="font-black"></h4>
            </div>
            <button
              onclick="ui.openHandoutModal()"
              class="w-8 h-8 flex items-center justify-center rounded-full bg-[var(--accent)] text-[var(--bg)] hover:scale-110 transition-transform font-black shadow-lg"
              title="Add Handout"
              type="button"
            >
              +
            </button>
          </div>
          <div
            id="handoutList"
            class="flex-1 overflow-y-auto space-y-3 pr-2"
          ></div>
        </div>

        <!-- Course Progress Widget -->
        <div class="theme-card side-widget p-6 flex flex-col h-[340px]">
          <div class="flex justify-between items-center mb-4">
            <h4 id="txtCourseProgress" class="font-black"></h4>
            <button
              onclick="ui.openCourseProgressModal()"
              class="w-8 h-8 flex items-center justify-center rounded-full bg-[var(--accent)] text-[var(--bg)] hover:scale-110 transition-transform font-black shadow-lg"
              title="Add Course Progress"
              type="button"
            >
              +
            </button>
          </div>
          <div id="courseProgressSummary"></div>
          <div
            id="courseProgressList"
            class="flex-1 overflow-y-auto space-y-3 pr-2"
          ></div>
        </div>

        <!-- Attendance Widget -->
        <div
          id="attendanceWidget"
          class="theme-card side-widget p-6 flex flex-col h-[420px]"
        >
          <div class="flex justify-between items-center mb-4">
            <div class="widget-title-wrap">
              <span
                class="widget-title-icon widget-title-icon--attendance"
                aria-hidden="true"
              >
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="1.9"
                    d="M9 3h6a2 2 0 012 2v1h1a2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V8a2 2 0 012-2h1V5a2 2 0 012-2z"
                  />
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="1.9"
                    d="M9 12l2.3 2.3L15 10.5"
                  />
                </svg>
              </span>
              <h4 id="txtAttendanceBoard" class="font-black"></h4>
            </div>
            <button
              onclick="ui.openAttendanceSettingsModal()"
              class="w-8 h-8 flex items-center justify-center rounded-full bg-[var(--accent)] text-[var(--bg)] hover:scale-110 transition-transform font-black shadow-lg"
              title="Attendance Settings"
              type="button"
            >
              
            </button>
          </div>
          <div id="attendanceSummary"></div>
          <div
            id="attendanceList"
            class="flex-1 overflow-y-auto space-y-3 pr-2"
          ></div>
        </div>

        <!-- Alert Widget -->
        <div
          id="alertsWidget"
          class="theme-card side-widget p-6 flex flex-col h-[380px]"
        >
          <div class="flex justify-between items-center mb-4">
            <div class="widget-title-wrap">
              <span
                class="widget-title-icon widget-title-icon--alert"
                aria-hidden="true"
              >
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="1.9"
                    d="M12 9v4m0 4h.01M10.29 3.86L1.82 18a2 2 0 001.72 3h16.92a2 2 0 001.72-3L13.71 3.86a2 2 0 00-3.42 0z"
                  />
                </svg>
              </span>
              <h4 id="txtAlerts" class="font-black"></h4>
            </div>
            <div class="flex items-center gap-2">
              <button
                id="btnNotifyPermission"
                onclick="app.openNotificationSettings()"
                class="notify-perm-btn"
                title="  "
                type="button"
              >
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"
                  />
                </svg>
              </button>
              <button
                onclick="ui.openNoteModal(null, true)"
                class="w-8 h-8 flex items-center justify-center rounded-full bg-red-500 text-white hover:scale-110 transition-transform font-black shadow-lg"
                title="Add Alert"
              >
                +
              </button>
            </div>
          </div>
          <button
            id="notifyStatusHint"
            onclick="app.openNotificationSettings()"
            class="notify-status-hint"
            type="button"
            title="  "
          >
            <span id="txtNotifyStatusTitle" class="notify-status-title"
              >...</span
            >
            <span id="txtNotifyStatusDetail" class="notify-status-detail"
              >...</span
            >
          </button>
          <div id="notifyConnectPanel" class="notify-connect-panel">
            <div class="notify-connect-head">
              <span
                id="txtNotifyConnectState"
                class="notify-connect-state"
                data-state="off"
              >
                <span class="notify-connect-dot" aria-hidden="true"></span>
                <span>...</span>
              </span>
              <span id="txtNotifyConnectMeta" class="notify-connect-meta"
                >...</span
              >
            </div>
            <div id="txtNotifySwExplain" class="notify-sw-explain">...</div>
            <div id="notifyChecklist" class="notify-checklist"></div>
            <div class="notify-connect-actions">
              <button
                id="btnNotifyQuickFix"
                onclick="app.runNotificationQuickFix(true)"
                class="notify-action-btn notify-action-btn--fix"
                type="button"
              >
                ...
              </button>
              <button
                id="btnNotifyTest"
                onclick="app.sendSystemNotificationTest()"
                class="notify-action-btn notify-action-btn--test"
                type="button"
              >
                ...
              </button>
              <button
                id="btnNotifyGuide"
                onclick="app.openNotificationGuide()"
                class="notify-action-btn notify-action-btn--guide"
                type="button"
              >
                ...
              </button>
            </div>
          </div>
          <div
            id="alertList"
            class="flex-1 overflow-y-auto space-y-3 pr-2"
          ></div>
        </div>
      </aside>

      <!-- Main Content -->
      <main id="mainPanel" class="col-span-12 lg:col-span-9 space-y-6">
        <!-- Tools -->
        <div
          class="theme-card tools-panel p-3 flex flex-wrap gap-3 items-center justify-between"
        >
          <div
            class="view-switch flex gap-2 bg-[var(--bg)]/25 p-1 rounded-2xl border border-[var(--border)] backdrop-blur-md"
          >
            <button
              onclick="app.setView('grid')"
              id="viewGrid"
              class="px-3 py-2 rounded-xl text-sm font-black flex items-center gap-2 transition-all"
            >
              <svg
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"
                />
              </svg>
              <span id="txtGrid"></span>
            </button>
            <button
              onclick="app.setView('list')"
              id="viewList"
              class="px-3 py-2 rounded-xl text-sm font-black flex items-center gap-2 transition-all opacity-50"
            >
              <svg
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 6h16M4 12h16M4 18h16"
                />
              </svg>
              <span id="txtList"></span>
            </button>
          </div>

          <div class="flex-1 max-w-md relative">
            <input
              type="text"
              id="searchInput"
              oninput="app.search(this.value)"
              class="inp search-input pr-4 pl-10 text-sm"
              placeholder="..."
            />
            <svg
              class="w-4 h-4 absolute left-3 top-3 opacity-60"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
              />
            </svg>
          </div>

          <button
            onclick="ui.openClassModal()"
            class="add-class-btn px-5 py-2.5 bg-[var(--accent)] text-[var(--bg)] rounded-2xl font-black text-sm hover:brightness-110 transition-all shadow-xl flex items-center gap-2"
          >
            <span>+</span> <span id="txtAddClass"></span>
          </button>
        </div>

        <!-- Schedule -->
        <div id="scheduleContainer" class="animate-fade-in"></div>
      </main>
    </div>

    <script>
      const STR = {
        title:
          "\u0628\u0631\u0646\u0627\u0645\u0647 \u06a9\u0644\u0627\u0633\u06cc \u062f\u0627\u0646\u0634\u06af\u0627\u0647\u06cc",
        uni: "\u062f\u0627\u0646\u0634\u06af\u0627\u0647 \u0641\u0631\u062f\u0648\u0633\u06cc \u0645\u0634\u0647\u062f",
        name: "\u0627\u0645\u06cc\u0631\u0645\u0647\u062f\u06cc",
        weekOdd: "\u0647\u0641\u062a\u0647 \u0641\u0631\u062f",
        weekEven: "\u0647\u0641\u062a\u0647 \u0632\u0648\u062c",
        units: "\u0648\u0627\u062d\u062f \u06a9\u0644",
        hours: "\u0633\u0627\u0639\u062a \u062f\u0631 \u0647\u0641\u062a\u0647",
        classesCount:
          "\u062a\u0639\u062f\u0627\u062f \u06a9\u0644\u0627\u0633\u200c\u0647\u0627",
        nextClass: "\u06a9\u0644\u0627\u0633 \u0628\u0639\u062f\u06cc",
        exams: "\u0622\u0632\u0645\u0648\u0646\u200c\u0647\u0627",
        notesBoard:
          "\u06cc\u0627\u062f\u062f\u0627\u0634\u062a\u200c\u0647\u0627",
        addNote:
          "\u06cc\u0627\u062f\u062f\u0627\u0634\u062a \u062c\u062f\u06cc\u062f",
        noteClass: "\u06a9\u0644\u0627\u0633 \u0645\u0631\u062a\u0628\u0637",
        noteText:
          "\u0645\u062a\u0646 \u06cc\u0627\u062f\u062f\u0627\u0634\u062a",
        alertBoard: "\u0647\u0634\u062f\u0627\u0631\u0647\u0627",
        pinAlert:
          "\u0646\u0645\u0627\u06cc\u0634 \u062f\u0631 \u0647\u0634\u062f\u0627\u0631\u0647\u0627",
        noAlerts:
          "\u0647\u0634\u062f\u0627\u0631 \u0641\u0639\u0627\u0644\u06cc \u0648\u062c\u0648\u062f \u0646\u062f\u0627\u0631\u062f",
        alertDate:
          "\u062a\u0627\u0631\u06cc\u062e \u0647\u0634\u062f\u0627\u0631",
        alertTime: "\u0633\u0627\u0639\u062a \u0647\u0634\u062f\u0627\u0631",
        alertDay: "\u0631\u0648\u0632 \u0647\u0634\u062f\u0627\u0631",
        notifyWhen: "\u0632\u0645\u0627\u0646 \u0627\u0639\u0644\u0627\u0646",
        notifyText: "\u0645\u062a\u0646 \u0627\u0639\u0644\u0627\u0646",
        notifyTextRequired:
          "\u0645\u062a\u0646 \u0627\u0639\u0644\u0627\u0646 \u0631\u0627 \u0648\u0627\u0631\u062f \u06a9\u0646\u06cc\u062f.",
        notifyEnabled:
          "\u0641\u0639\u0627\u0644\u200c\u0633\u0627\u0632\u06cc \u0646\u0648\u062a\u06cc\u0641\u06cc\u06a9\u06cc\u0634\u0646",
        notifyAtTime:
          "\u062f\u0642\u06cc\u0642\u0627 \u0647\u0645\u0627\u0646 \u0633\u0627\u0639\u062a",
        notifyBefore5:
          "\u06f5 \u062f\u0642\u06cc\u0642\u0647 \u0642\u0628\u0644",
        notifyBefore10:
          "\u06f1\u06f0 \u062f\u0642\u06cc\u0642\u0647 \u0642\u0628\u0644",
        notifyBefore15:
          "\u06f1\u06f5 \u062f\u0642\u06cc\u0642\u0647 \u0642\u0628\u0644",
        notifyBefore20:
          "\u06f2\u06f0 \u062f\u0642\u06cc\u0642\u0647 \u0642\u0628\u0644",
        notifyBefore30:
          "\u06f3\u06f0 \u062f\u0642\u06cc\u0642\u0647 \u0642\u0628\u0644",
        notifyBefore45:
          "\u06f4\u06f5 \u062f\u0642\u06cc\u0642\u0647 \u0642\u0628\u0644",
        notifyBefore60: "\u06f1 \u0633\u0627\u0639\u062a \u0642\u0628\u0644",
        notifyBefore90:
          "\u06f1 \u0633\u0627\u0639\u062a \u0648 \u06f3\u06f0 \u062f\u0642\u06cc\u0642\u0647 \u0642\u0628\u0644",
        notifyBefore120: "\u06f2 \u0633\u0627\u0639\u062a \u0642\u0628\u0644",
        notifyBefore180: "\u06f3 \u0633\u0627\u0639\u062a \u0642\u0628\u0644",
        notifyBefore360: "\u06f6 \u0633\u0627\u0639\u062a \u0642\u0628\u0644",
        notifyBefore720:
          "\u06f1\u06f2 \u0633\u0627\u0639\u062a \u0642\u0628\u0644",
        notifyBefore1440: "\u06f1 \u0631\u0648\u0632 \u0642\u0628\u0644",
        notifyBefore2880: "\u06f2 \u0631\u0648\u0632 \u0642\u0628\u0644",
        notifyBefore10080: "\u06f1 \u0647\u0641\u062a\u0647 \u0642\u0628\u0644",
        notifyPermission:
          "\u0641\u0639\u0627\u0644\u200c\u0633\u0627\u0632\u06cc \u0627\u0639\u0644\u0627\u0646 \u0645\u0631\u0648\u0631\u06af\u0631",
        notifyPermissionGranted:
          "\u062f\u0633\u062a\u0631\u0633\u06cc \u0646\u0648\u062a\u06cc\u0641\u06cc\u06a9\u06cc\u0634\u0646 \u0641\u0639\u0627\u0644 \u0634\u062f.",
        notifySystemOn:
          "\u0627\u0639\u0644\u0627\u0646 \u0633\u06cc\u0633\u062a\u0645\u06cc \u0631\u0648\u0634\u0646",
        notifySystemOff:
          "\u0627\u0639\u0644\u0627\u0646 \u0633\u06cc\u0633\u062a\u0645\u06cc \u062e\u0627\u0645\u0648\u0634",
        notifySystemPartial:
          "\u062f\u0631 \u062d\u0627\u0644\u062a \u0646\u06cc\u0645\u0647\u200c\u0641\u0639\u0627\u0644",
        notifySystemBlocked:
          "\u062f\u0633\u062a\u0631\u0633\u06cc \u0645\u0633\u062f\u0648\u062f",
        notifySystemUnsupported:
          "\u0627\u0639\u0644\u0627\u0646 \u0633\u06cc\u0633\u062a\u0645\u06cc \u067e\u0634\u062a\u06cc\u0628\u0627\u0646\u06cc \u0646\u0645\u06cc\u200c\u0634\u0648\u062f",
        notifySystemOpen:
          "\u0641\u0639\u0627\u0644\u200c\u0633\u0627\u0632\u06cc/\u0628\u0631\u0631\u0633\u06cc \u0627\u0639\u0644\u0627\u0646 \u0633\u06cc\u0633\u062a\u0645\u06cc",
        notifyOnShort: "\u0631\u0648\u0634\u0646",
        notifyOffShort: "\u062e\u0627\u0645\u0648\u0634",
        notifyPartialShort: "\u0646\u0627\u0642\u0635",
        notifyBlockedShort: "\u0645\u0633\u062f\u0648\u062f",
        notifyUnsupportedShort: "\u0646\u0627\u0645\u0648\u062c\u0648\u062f",
        notifyPermissionHint:
          "\u0628\u0631\u0627\u06cc \u062f\u0631\u06cc\u0627\u0641\u062a \u0627\u0639\u0644\u0627\u0646 \u062d\u062a\u0645\u0627 \u062f\u0633\u062a\u0631\u0633\u06cc \u0645\u0631\u0648\u0631\u06af\u0631 \u0631\u0627 \u0628\u062f\u0647\u06cc\u062f.",
        notifyPermissionDenied:
          "\u062f\u0633\u062a\u0631\u0633\u06cc \u0646\u0648\u062a\u06cc\u0641\u06cc\u06a9\u06cc\u0634\u0646 \u0631\u062f \u0634\u062f. \u0627\u0632 \u062a\u0646\u0638\u06cc\u0645\u0627\u062a \u0645\u0631\u0648\u0631\u06af\u0631 \u0641\u0639\u0627\u0644\u0634 \u06a9\u0646\u06cc\u062f.",
        notifyNotSupported:
          "\u0627\u06cc\u0646 \u0645\u0631\u0648\u0631\u06af\u0631 \u0627\u0632 \u0646\u0648\u062a\u06cc\u0641\u06cc\u06a9\u06cc\u0634\u0646 \u067e\u0634\u062a\u06cc\u0628\u0627\u0646\u06cc \u0646\u0645\u06cc\u200c\u06a9\u0646\u062f.",
        notifyContextFile:
          "\u0627\u06cc\u0646 \u0635\u0641\u062d\u0647 \u0628\u0627 \u0622\u062f\u0631\u0633 file:// \u0628\u0627\u0632 \u0634\u062f\u0647 \u0627\u0633\u062a. \u0628\u0631\u0627\u06cc \u0646\u0648\u062a\u06cc\u0641\u06cc\u06a9\u06cc\u0634\u0646\u060c \u0622\u0646 \u0631\u0627 \u0627\u0632 http://localhost \u06cc\u0627 https \u0627\u062c\u0631\u0627 \u06a9\u0646\u06cc\u062f.",
        notifyContextInsecure:
          "\u0627\u0639\u0644\u0627\u0646 \u0645\u0631\u0648\u0631\u06af\u0631 \u0641\u0642\u0637 \u0631\u0648\u06cc HTTPS \u06cc\u0627 localhost \u0641\u0639\u0627\u0644 \u0627\u0633\u062a.",
        notifySetupGuide:
          "\u0631\u0627\u0647\u0646\u0645\u0627:\\n1) \u062a\u0631\u0645\u06cc\u0646\u0627\u0644 \u0631\u0627 \u0628\u0627\u0632 \u06a9\u0646\u06cc\u062f \u0648 \u062f\u0631 \u067e\u0648\u0634\u0647 \u0641\u0627\u06cc\u0644 \u0627\u062c\u0631\u0627 \u06a9\u0646\u06cc\u062f: py -m http.server 8080\\n2) \u0627\u0632 \u0627\u06cc\u0646 \u0622\u062f\u0631\u0633 \u0628\u0627\u0632 \u06a9\u0646\u06cc\u062f: http://localhost:8080/UniversitySchedule.html\\n3) \u0646\u0634\u0627\u0646 \u0632\u0646\u06af \u0631\u0627 \u0628\u0632\u0646\u06cc\u062f \u0648 Allow \u0631\u0627 \u0627\u0646\u062a\u062e\u0627\u0628 \u06a9\u0646\u06cc\u062f.",
        notifyConnectOn: "     ",
        notifyConnectPartial:
          "   ",
        notifyConnectOff: "    ",
        notifyConnectBlocked: "    ",
        notifyConnectUnsupported:
          "       ",
        notifyLastCheckLabel: " ",
        notifyLastTestLabel: " ",
        notifyNoTestYet: "    ",
        notifyChecklistContext: "  ",
        notifyChecklistPermission: "  ",
        notifyChecklistSw: " ",
        notifyChecklistDelivery: "  ",
        notifySwExplainReady:
          "                 .",
        notifySwExplainPartial:
          "           /       .",
        notifySwExplainUnavailable:
          "             .",
        notifyActionFix: "/",
        notifyActionTest: " ",
        notifyActionGuide: " ",
        notifyActionConnecting: "  ...",
        notifyTestTitle: "   ",
        notifyTestBody:
          "           .",
        notifyTestSent: "     .",
        notifyGuideTitle:
          "    ",
        storageWriteFailed:
          "            .",
        storageUnavailable:
          " localStorage         .",
        storageBackupRecovered:
          "     .",
        alertDateRequired:
          "\u062a\u0627\u0631\u06cc\u062e \u0647\u0634\u062f\u0627\u0631 \u0631\u0627 \u0645\u0634\u062e\u0635 \u06a9\u0646\u06cc\u062f.",
        alertTimeRequired:
          "\u0633\u0627\u0639\u062a \u0647\u0634\u062f\u0627\u0631 \u0631\u0627 \u0645\u0634\u062e\u0635 \u06a9\u0646\u06cc\u062f.",
        examDateRequired:
          "\u062a\u0627\u0631\u06cc\u062e \u0622\u0632\u0645\u0648\u0646 \u0631\u0627 \u0645\u0634\u062e\u0635 \u06a9\u0646\u06cc\u062f.",
        examTimeRequired:
          "\u0633\u0627\u0639\u062a \u0622\u0632\u0645\u0648\u0646 \u0631\u0627 \u0645\u0634\u062e\u0635 \u06a9\u0646\u06cc\u062f.",
        examNotifyTextRequired:
          "\u0645\u062a\u0646 \u0627\u0639\u0644\u0627\u0646 \u0622\u0632\u0645\u0648\u0646 \u0631\u0627 \u0648\u0627\u0631\u062f \u06a9\u0646\u06cc\u062f.",
        examCourseRequired:
          "\u062f\u0631\u0633 \u0645\u0631\u062a\u0628\u0637 \u0622\u0632\u0645\u0648\u0646 \u0631\u0627 \u0627\u0646\u062a\u062e\u0627\u0628 \u06a9\u0646\u06cc\u062f.",
        examReminder:
          "\u06cc\u0627\u062f\u0622\u0648\u0631\u06cc \u0622\u0632\u0645\u0648\u0646",
        editProfile:
          "\u0648\u06cc\u0631\u0627\u06cc\u0634 \u067e\u0631\u0648\u0641\u0627\u06cc\u0644",
        profileNameLabel:
          "\u0646\u0627\u0645 \u062f\u0627\u0646\u0634\u062c\u0648",
        promptProfileName:
          "\u0646\u0627\u0645 \u067e\u0631\u0648\u0641\u0627\u06cc\u0644 \u0631\u0627 \u0648\u0627\u0631\u062f \u06a9\u0646\u06cc\u062f",
        profileNameRequired:
          "\u0646\u0627\u0645 \u067e\u0631\u0648\u0641\u0627\u06cc\u0644 \u0646\u0645\u06cc\u200c\u062a\u0648\u0627\u0646\u062f \u062e\u0627\u0644\u06cc \u0628\u0627\u0634\u062f.",
        profileTermLabel:
          "\u062a\u0631\u0645 \u062a\u062d\u0635\u06cc\u0644\u06cc",
        profileMajorLabel: "\u0631\u0634\u062a\u0647",
        profileClassStartLabel:
          "\u062a\u0627\u0631\u06cc\u062e \u0634\u0631\u0648\u0639 \u06a9\u0644\u0627\u0633\u200c\u0647\u0627",
        profileTermDefault: "\u062a\u0631\u0645 2",
        profileTermHelper:
          "\u062a\u0631\u0645 \u0631\u0627 \u0627\u0632 \u06f1 \u062a\u0627 \u06f1\u06f0 \u0627\u0646\u062a\u062e\u0627\u0628 \u06a9\u0646\u06cc\u062f. \u062f\u0627\u062f\u0647\u200c\u0647\u0627\u06cc \u0647\u0631 \u062a\u0631\u0645 \u06a9\u0627\u0645\u0644\u0627 \u062c\u062f\u0627 \u0630\u062e\u06cc\u0631\u0647 \u0645\u06cc\u200c\u0634\u0648\u0646\u062f.",
        profileTermCurrentHint:
          "\u0627\u06cc\u0646 \u0647\u0645\u0627\u0646 \u062a\u0631\u0645 \u0641\u0639\u0644\u06cc \u0634\u0645\u0627\u0633\u062a.",
        profileTermExistingHint:
          "\u0627\u06cc\u0646 \u062a\u0631\u0645 \u0627\u0632 \u0642\u0628\u0644 \u0633\u0627\u062e\u062a\u0647 \u0634\u062f\u0647 \u0648 \u0645\u06cc\u200c\u062a\u0648\u0627\u0646\u06cc\u062f \u0627\u0637\u0644\u0627\u0639\u0627\u062a \u0642\u0628\u0644\u06cc \u0622\u0646 \u0631\u0627 \u0628\u0628\u06cc\u0646\u06cc\u062f.",
        profileTermWarningCreate:
          "\u0627\u06cc\u0646 \u062a\u0631\u0645 \u0647\u0646\u0648\u0632 \u0633\u0627\u062e\u062a\u0647 \u0646\u0634\u062f\u0647 \u0627\u0633\u062a.",
        profileTermCreatedHint:
          "\u0628\u0627 \u062a\u0627\u06cc\u06cc\u062f \u0633\u0627\u062e\u062a \u062a\u0631\u0645 \u062c\u062f\u06cc\u062f\u060c \u062a\u0645\u0627\u0645 \u0627\u0645\u06a9\u0627\u0646\u0627\u062a \u0646\u06af\u0647 \u062f\u0627\u0634\u062a\u0647 \u0645\u06cc\u200c\u0634\u0648\u062f \u0627\u0645\u0627 \u0628\u0631\u0646\u0627\u0645\u0647 \u06a9\u0644\u0627\u0633\u06cc \u062e\u0627\u0644\u06cc \u0627\u0633\u062a.",
        profileTermCreateConfirm:
          "\u0622\u06cc\u0627 \u0627\u0632 \u0627\u06cc\u062c\u0627\u062f \u062a\u0631\u0645 \u062c\u062f\u06cc\u062f \u0627\u0637\u0645\u06cc\u0646\u0627\u0646 \u062f\u0627\u0631\u06cc\u062f\u061f",
        profileTermCreatedListLabel:
          "\u062a\u0631\u0645\u200c\u0647\u0627\u06cc \u0633\u0627\u062e\u062a\u0647\u200c\u0634\u062f\u0647",
        profileTermSwitchFailed:
          "\u0627\u0645\u06a9\u0627\u0646 \u062a\u0639\u0648\u06cc\u0636 \u0628\u0647 \u062a\u0631\u0645 \u0627\u0646\u062a\u062e\u0627\u0628\u06cc \u0648\u062c\u0648\u062f \u0646\u062f\u0627\u0631\u062f.",
        yes: "\u0628\u0644\u0647",
        no: "\u062e\u06cc\u0631",
        profileMajorDefault:
          "\u0631\u0634\u062a\u0647 \u062e\u0648\u062f \u0631\u0627 \u062b\u0628\u062a \u06a9\u0646\u06cc\u062f",
        profileMajorPlaceholder:
          "\u0645\u062b\u0627\u0644: \u0639\u0644\u0648\u0645 \u06a9\u0627\u0645\u067e\u06cc\u0648\u062a\u0631",
        profileClassStartUnset:
          "\u062a\u0646\u0638\u06cc\u0645 \u0646\u0634\u062f\u0647",
        profileClassStartSet: "\u062b\u0628\u062a \u0634\u062f\u0647",
        profileClassStartMetaUnset:
          "\u0628\u0631\u0627\u06cc \u0645\u062d\u0627\u0633\u0628\u0647 \u062c\u0644\u0633\u0647\u200c\u0647\u0627\u060c \u062a\u0627\u0631\u06cc\u062e \u0634\u0631\u0648\u0639 \u0631\u0627 \u062b\u0628\u062a \u06a9\u0646\u06cc\u062f",
        profileClassStartHelper:
          "\u0627\u06cc\u0646 \u062a\u0627\u0631\u06cc\u062e \u0645\u0628\u0646\u0627\u06cc \u0645\u062d\u0627\u0633\u0628\u0647 \u062e\u0648\u062f\u06a9\u0627\u0631 \u0634\u0645\u0627\u0631\u0647 \u062c\u0644\u0633\u0647\u200c\u0647\u0627 \u0627\u0633\u062a.",
        sessionCurrentLabel:
          "\u0634\u0645\u0627\u0631\u0647 \u062c\u0644\u0633\u0647 \u0641\u0639\u0644\u06cc",
        sessionAutoBaseLabel:
          "\u062c\u0644\u0633\u0647 \u062e\u0648\u062f\u06a9\u0627\u0631",
        sessionOffsetHint:
          "\u0627\u06cc\u0646 \u0645\u0642\u062f\u0627\u0631 \u0628\u0647\u200c\u0635\u0648\u0631\u062a offset \u0630\u062e\u06cc\u0631\u0647 \u0645\u06cc\u200c\u0634\u0648\u062f.",
        sessionStartDatePrompt:
          "\u0644\u0637\u0641\u0627\u064b \u062a\u0627\u0631\u06cc\u062e \u0634\u0631\u0648\u0639 \u06a9\u0644\u0627\u0633\u200c\u0647\u0627 \u0631\u0627 \u062f\u0631 \u067e\u0631\u0648\u0641\u0627\u06cc\u0644 \u062a\u0646\u0638\u06cc\u0645 \u06a9\u0646\u06cc\u062f",
        sessionStartDateMissingShort:
          "\u062a\u0627\u0631\u06cc\u062e \u0634\u0631\u0648\u0639 \u062a\u0646\u0638\u06cc\u0645 \u0646\u0634\u062f\u0647",
        sessionNotStarted:
          "\u06a9\u0644\u0627\u0633 \u0647\u0646\u0648\u0632 \u0634\u0631\u0648\u0639 \u0646\u0634\u062f\u0647",
        sessionMissingGlobalTitle:
          "\u062a\u0627\u0631\u06cc\u062e \u0634\u0631\u0648\u0639 \u06a9\u0644\u0627\u0633\u200c\u0647\u0627 \u062b\u0628\u062a \u0646\u0634\u062f\u0647 \u0627\u0633\u062a",
        sessionMissingGlobalHint:
          "\u0628\u0631\u0627\u06cc \u0646\u0645\u0627\u06cc\u0634 \u062e\u0648\u062f\u06a9\u0627\u0631 \u00ab\u062c\u0644\u0633\u0647 \u0686\u0646\u062f\u0645\u00bb\u060c \u062a\u0627\u0631\u06cc\u062e \u0634\u0631\u0648\u0639 \u0631\u0627 \u06cc\u06a9\u200c\u0628\u0627\u0631 \u062f\u0631 \u067e\u0631\u0648\u0641\u0627\u06cc\u0644 \u062a\u0646\u0638\u06cc\u0645 \u06a9\u0646\u06cc\u062f.",
        setStartDateAction:
          "\u062a\u0646\u0638\u06cc\u0645 \u062a\u0627\u0631\u06cc\u062e \u0634\u0631\u0648\u0639",
        stylePack: "\u067e\u06a9 \u0638\u0627\u0647\u0631\u06cc",
        packBase: "\u067e\u06a9 Base",
        packUltra: "\u067e\u06a9 Ultra",
        packPro: "\u067e\u06a9 pro",
        animMode:
          "\u062d\u0627\u0644\u062a \u0627\u0646\u06cc\u0645\u06cc\u0634\u0646",
        animEnabled:
          "\u0627\u0646\u06cc\u0645\u06cc\u0634\u0646 \u0631\u0648\u0634\u0646",
        animDisabled:
          "\u0627\u0646\u06cc\u0645\u06cc\u0634\u0646 \u062e\u0627\u0645\u0648\u0634",
        animIntensity:
          "\u0634\u062f\u062a \u0627\u0646\u06cc\u0645\u06cc\u0634\u0646",
        animIntensityUltraLow:
          "\u0641\u0648\u0642\u200c\u0627\u0644\u0639\u0627\u062f\u0647 \u0636\u0639\u06cc\u0641",
        animIntensityLow: "\u06a9\u0645",
        animIntensityHigh: "\u0632\u06cc\u0627\u062f",
        uiMode: "\u062d\u0627\u0644\u062a \u0646\u0645\u0627\u06cc\u0634",
        uiModeAuto: "\u062e\u0648\u062f\u06a9\u0627\u0631",
        uiModeDesktop:
          "\u062d\u0627\u0644\u062a \u062f\u0633\u06a9\u062a\u0627\u067e",
        uiModeMobile:
          "\u062d\u0627\u0644\u062a \u0645\u0648\u0628\u0627\u06cc\u0644",
        animToggleOnTitle:
          "\u0627\u0646\u06cc\u0645\u06cc\u0634\u0646 \u0631\u0648\u0634\u0646 \u0627\u0633\u062a (\u06a9\u0644\u06cc\u06a9 \u0628\u0631\u0627\u06cc \u062e\u0627\u0645\u0648\u0634)",
        animToggleOffTitle:
          "\u0627\u0646\u06cc\u0645\u06cc\u0634\u0646 \u062e\u0627\u0645\u0648\u0634 \u0627\u0633\u062a (\u06a9\u0644\u06cc\u06a9 \u0628\u0631\u0627\u06cc \u0631\u0648\u0634\u0646)",
        classDurationFixed:
          "\u0645\u062f\u062a \u0647\u0631 \u06a9\u0644\u0627\u0633: \u06f1 \u0633\u0627\u0639\u062a \u0648 \u06f3\u06f0 \u062f\u0642\u06cc\u0642\u0647",
        classStartRequired:
          "\u0632\u0645\u0627\u0646 \u0634\u0631\u0648\u0639 \u06a9\u0644\u0627\u0633 \u0631\u0627 \u0645\u0634\u062e\u0635 \u06a9\u0646\u06cc\u062f.",
        unpin: "\u0622\u0646\u067e\u06cc\u0646",
        noNotes:
          "\u0647\u06cc\u0686 \u06cc\u0627\u062f\u062f\u0627\u0634\u062a\u06cc \u062b\u0628\u062a \u0646\u0634\u062f\u0647 \u0627\u0633\u062a",
        unknownClass:
          "\u06a9\u0644\u0627\u0633 \u0646\u0627\u0645\u0634\u062e\u0635",
        viewGrid: "\u0646\u0645\u0627\u06cc \u062c\u062f\u0648\u0644",
        viewList: "\u0646\u0645\u0627\u06cc \u0644\u06cc\u0633\u062a",
        addClass: "\u06a9\u0644\u0627\u0633 \u062c\u062f\u06cc\u062f",
        search: "\u062c\u0633\u062a\u062c\u0648...",
        timeLabel: "\u0632\u0645\u0627\u0646",
        days: [
          "\u0634\u0646\u0628\u0647",
          "\u06cc\u06a9\u0634\u0646\u0628\u0647",
          "\u062f\u0648\u0634\u0646\u0628\u0647",
          "\u0633\u0647 \u0634\u0646\u0628\u0647",
          "\u0686\u0647\u0627\u0631\u0634\u0646\u0628\u0647",
          "\u067e\u0646\u062c\u0634\u0646\u0628\u0647",
        ],
        noClass:
          "\u06a9\u0644\u0627\u0633\u06cc \u06cc\u0627\u0641\u062a \u0646\u0634\u062f",
        alertReset:
          "\u0622\u06cc\u0627 \u0627\u0632 \u0628\u0627\u0632\u06af\u0631\u062f\u0627\u0646\u06cc \u0627\u0637\u0644\u0627\u0639\u0627\u062a \u0627\u0637\u0645\u06cc\u0646\u0627\u0646 \u062f\u0627\u0631\u06cc\u062f\u061f",
        modalEdit: "\u0648\u06cc\u0631\u0627\u06cc\u0634",
        modalAdd: "\u0627\u0641\u0632\u0648\u062f\u0646",
        save: "\u0630\u062e\u06cc\u0631\u0647",
        delete: "\u062d\u0630\u0641",
        cancel: "\u0644\u063a\u0648",
        typeNormal: "\u0639\u0627\u062f\u06cc",
        typeOdd: "\u0641\u0642\u0637 \u0641\u0631\u062f",
        typeEven: "\u0641\u0642\u0637 \u0632\u0648\u062c",
        course: "\u0646\u0627\u0645 \u062f\u0631\u0633",
        classNumber: "\u0634\u0645\u0627\u0631\u0647 \u06a9\u0644\u0627\u0633",
        prof: "\u0627\u0633\u062a\u0627\u062f",
        unit: "\u0648\u0627\u062d\u062f",
        notes: "\u062a\u0648\u0636\u06cc\u062d\u0627\u062a",
        handoutsBoard: "\u062c\u0632\u0648\u0627\u062a",
        handoutTitle: "\u0639\u0646\u0648\u0627\u0646 \u062c\u0632\u0648\u0647",
        handoutLink:
          "\u0644\u06cc\u0646\u06a9 \u0645\u0646\u0628\u0639/\u0641\u0627\u06cc\u0644",
        handoutAttachment:
          "\u0628\u0627\u0631\u06af\u0630\u0627\u0631\u06cc \u0641\u0627\u06cc\u0644 \u06cc\u0627 \u0639\u06a9\u0633",
        handoutAttachmentRemove:
          "\u062d\u0630\u0641 \u067e\u06cc\u0648\u0633\u062a \u0641\u0639\u0644\u06cc",
        handoutAttachmentCurrent:
          "\u067e\u06cc\u0648\u0633\u062a \u0641\u0639\u0644\u06cc",
        handoutOpenLink:
          "\u0628\u0627\u0632 \u06a9\u0631\u062f\u0646 \u0644\u06cc\u0646\u06a9",
        handoutOpenFile:
          "\u0628\u0627\u0632 \u06a9\u0631\u062f\u0646 \u0641\u0627\u06cc\u0644",
        handoutDownloadLink:
          "\u062f\u0627\u0646\u0644\u0648\u062f \u0644\u06cc\u0646\u06a9",
        handoutDownloadFile:
          "\u062f\u0627\u0646\u0644\u0648\u062f \u0641\u0627\u06cc\u0644",
        handoutDownloadImage:
          "\u062f\u0627\u0646\u0644\u0648\u062f \u0639\u06a9\u0633",
        handoutNoData:
          "\u0647\u0646\u0648\u0632 \u062c\u0632\u0648\u0647\u200c\u0627\u06cc \u062b\u0628\u062a \u0646\u0634\u062f\u0647 \u0627\u0633\u062a.",
        handoutCourseRequired:
          "\u062f\u0631\u0633 \u0645\u0631\u062a\u0628\u0637 \u0631\u0627 \u0627\u0646\u062a\u062e\u0627\u0628 \u06a9\u0646\u06cc\u062f.",
        handoutTitleRequired:
          "\u0639\u0646\u0648\u0627\u0646 \u062c\u0632\u0648\u0647 \u0627\u0644\u0632\u0627\u0645\u06cc \u0627\u0633\u062a.",
        handoutSourceRequired:
          "\u062d\u062f\u0627\u0642\u0644 \u06cc\u06a9 \u0644\u06cc\u0646\u06a9 \u06cc\u0627 \u06cc\u06a9 \u067e\u06cc\u0648\u0633\u062a \u0627\u0641\u0632\u0648\u062f\u0647 \u0634\u0648\u062f.",
        handoutFileTooLarge:
          "\u062d\u062c\u0645 \u0641\u0627\u06cc\u0644 \u0632\u06cc\u0627\u062f \u0627\u0633\u062a. \u062d\u062f\u0627\u06a9\u062b\u0631 \u06f2 \u0645\u06af\u0627\u0628\u0627\u06cc\u062a \u0627\u062c\u0627\u0632\u0647 \u062f\u0627\u0631\u062f.",
        handoutSaveFailed:
          "\u0630\u062e\u06cc\u0631\u0647 \u062c\u0632\u0648\u0647 \u0627\u0646\u062c\u0627\u0645 \u0646\u0634\u062f. \u0641\u0636\u0627\u06cc \u0630\u062e\u06cc\u0631\u0647 \u0645\u0631\u0648\u0631\u06af\u0631 \u0631\u0627 \u0628\u0631\u0631\u0633\u06cc \u06a9\u0646\u06cc\u062f \u06cc\u0627 \u062d\u062c\u0645 \u0641\u0627\u06cc\u0644 \u0631\u0627 \u06a9\u0645\u062a\u0631 \u06a9\u0646\u06cc\u062f.",
        courseProgressBoard:
          "\u0648\u0636\u0639\u06cc\u062a \u067e\u06cc\u0634\u0631\u0648\u06cc \u062f\u0631\u0633",
        progressTracked:
          "\u062f\u0631\u0633 \u062b\u0628\u062a\u200c\u0634\u062f\u0647",
        progressAverage:
          "\u0645\u06cc\u0627\u0646\u06af\u06cc\u0646 \u067e\u06cc\u0634\u0631\u0648\u06cc",
        progressUntracked: "\u0628\u062f\u0648\u0646 \u062b\u0628\u062a",
        progressUntil:
          "\u062a\u0627 \u0627\u06cc\u0646\u062c\u0627 \u062a\u062f\u0631\u06cc\u0633 \u0634\u062f\u0647",
        progressPercent:
          "\u062f\u0631\u0635\u062f \u067e\u06cc\u0634\u0631\u0648\u06cc",
        progressSession: "\u062c\u0644\u0633\u0647 \u0641\u0639\u0644\u06cc",
        progressNextTopic:
          "\u0645\u0648\u0636\u0648\u0639 \u062c\u0644\u0633\u0647 \u0628\u0639\u062f",
        progressUpdatedAt: "\u0622\u067e\u062f\u06cc\u062a \u0622\u062e\u0631",
        progressNoData:
          "\u0647\u0646\u0648\u0632 \u0628\u0631\u0627\u06cc \u062f\u0631\u0633\u200c\u0647\u0627 \u067e\u06cc\u0634\u0631\u0648\u06cc \u062b\u0628\u062a \u0646\u0634\u062f\u0647 \u0627\u0633\u062a.",
        progressClassRequired:
          "\u062f\u0631\u0633 \u0645\u0631\u062a\u0628\u0637 \u0631\u0627 \u0627\u0646\u062a\u062e\u0627\u0628 \u06a9\u0646\u06cc\u062f.",
        progressUntilRequired:
          "\u0628\u062e\u0634 \u00ab\u062a\u0627 \u0627\u06cc\u0646\u062c\u0627 \u062a\u062f\u0631\u06cc\u0633 \u0634\u062f\u0647\u00bb \u0631\u0627 \u062a\u06a9\u0645\u06cc\u0644 \u06a9\u0646\u06cc\u062f.",
        attendanceBoard: "  ",
        attendanceSettingsTitle: "   ",
        attendanceViewMode: " ",
        attendanceViewToday: "",
        attendanceViewAll: " ",
        attendanceSummaryCourses: " ",
        attendanceSummaryPresent: "",
        attendanceSummaryAbsent: "",
        attendanceSummaryPending: "",
        attendanceDateLabel: " ",
        attendanceStatusPresent: "",
        attendanceStatusAbsent: "",
        attendanceStatusPending: " ",
        attendanceStatusNoClassToday: "  ",
        attendancePresentCount: "",
        attendanceAbsentCount: "",
        attendanceRatioLabel: " ",
        attendanceActionPresent: "",
        attendanceActionAbsent: "",
        attendanceActionClear: " ",
        attendanceBulkPresentPending: " ",
        attendanceBulkAbsentPending: " ",
        attendanceBulkClearToday: " ",
        attendanceBulkCopyPrevWeek: "  ",
        attendanceUndo: "",
        attendanceUndoEmpty:
          "    .",
        attendanceNoChangesApplied:
          "    .",
        attendanceEditLocked:
          "        .            .",
        attendanceStatusFilterAll: "",
        attendanceStatusFilterPending: "",
        attendanceStatusFilterRisk: " ",
        attendanceSummaryRecorded: " ",
        attendanceSummaryAtRisk: " ",
        attendanceRemainingLabel: "  ",
        attendanceInsightPendingTitle: " ",
        attendanceInsightPendingBody:
          "            .",
        attendanceInsightRiskTitle: "  ",
        attendanceInsightRiskBody:
          "           .",
        attendanceInsightDoneTitle: "     ",
        attendanceInsightDoneBody:
          "    / .",
        attendanceInsightLockedTitle: " ",
        attendanceInsightLockedBody:
          "    .           .",
        attendanceReminderEnabled: "  ",
        attendanceReminderTime: " ",
        attendanceDefaultLimit: "   ",
        attendanceAllowPastEdit: "   ",
        attendanceActiveDate: "  ",
        attendanceCourseLimit: "   ",
        attendanceSaveSettings: " ",
        attendanceExport: " JSON",
        attendanceSettingsQuickTitle:
          "  ",
        attendanceSettingsApplyDefaultAll:
          "    ",
        attendanceSettingsClearCustomAll: "  ",
        attendanceSettingsLimitSearch: " ...",
        attendanceSettingsOnlyCustom: "   ",
        attendanceSettingsCourseCount: " ",
        attendanceSettingsCustomCount: " ",
        attendanceSettingsReminderOn: ": ",
        attendanceSettingsReminderOff: ": ",
        attendanceSettingsPastModeOn:
          "  : ",
        attendanceSettingsPastModeOff:
          "  : ",
        attendanceSettingsClearActiveDate: "  ",
        attendanceSettingsNoLimitMatch:
          "     .",
        attendanceSettingsLimitHint:
          "       .",
        attendanceSettingsSaved:
          "     .",
        dataMenu: " JSON",
        dataExportTitle: " JSON  ",
        dataImportTitle: " JSON   ",
        dataImportReadFailed: "  JSON  .",
        dataImportParseFailed: "  JSON  .",
        dataImportInvalid: "  JSON  .",
        dataImportDone: " JSON  .",
        dataImportModeMerge: " Merge",
        dataImportModeMirror: " Snapshot",
        attendanceNoCourses:
          "     .    .",
        attendanceNoItemsToday:
          "          .",
        attendanceReminderTitle: "   ",
        attendanceReminderBody:
          "         .",
        attendanceReminderRiskOnlyBody:
          "           .",
        attendanceReminderRiskLine: " ",
        attendanceReminderActionLine:
          "          .",
        attendanceLimitWarningNear:
          "       .",
        addHint:
          "\u0628\u0631\u0627\u06cc \u0627\u0641\u0632\u0648\u062f\u0646\u060c \u0631\u0648\u06cc \u062e\u0627\u0646\u0647 \u062e\u0627\u0644\u06cc \u06a9\u0644\u06cc\u06a9 \u06a9\u0646\u06cc\u062f",
        syncLabelShort: "Cloud",
        syncOpenPanel: " Cloud Sync",
        syncStateSyncing: "Syncing",
        syncStateSynced: "Synced",
        syncStateOffline: "Offline",
        syncStateError: "Offline",
        syncModalTitle: "Google Drive Sync",
        syncGuest: "  (Local)",
        syncSignIn: "  Google",
        syncSignOut: " ",
        syncNow: "  Sync",
        syncNowSignedIn: " ",
        syncNowGuest: "  ",
        syncClearCache: "  Cache",
        syncResetData: " ",
        syncLastSynced: " ",
        syncNever: "  ",
        syncUserId: "Google User ID",
        syncGuideTitle: "  Sync",
        syncGuideBadgeReady: " Sync",
        syncGuideBadgeNeedsSetup: "  ",
        syncGuideQuickTitle: " ",
        syncGuideSetupTitle: " Google Cloud",
        syncGuideTroubleshootTitle: " ",
        syncGuideChecksTitle: "  ",
        syncGuideDiagTitle: " ",
        syncGuideCopy: "  Sync",
        syncGuideCopied: "  ",
        syncGuideCopyFailed:
          "      .",
        syncClientIdLabel: "Google OAuth Client ID",
        syncClientIdPlaceholder: "xxxxxxxx.apps.googleusercontent.com",
        syncClientIdApply: " Client ID",
        syncClientIdReset: "  ",
        syncClientIdStatusCustom: "Client ID   .",
        syncClientIdStatusCode:
          "Client ID     .",
        syncClientIdSaved:
          "Client ID  .    Google  .",
        syncClientIdResetDone:
          "Client ID         .",
        syncClientIdInvalid:
          "Client ID  .   .apps.googleusercontent.com  .",
        syncClientIdEmpty: " Client ID   .",
        syncClientIdMissing:
          "Google Client ID   .  Client ID     window.__GOOGLE_CLIENT_ID__   .",
        syncCloudPrivate:
          "  appDataFolder  ( )  .",
        syncUltraTitle: "Ultra-Realtime Sync",
        syncUltraEnabled: "Ultra: ",
        syncUltraDisabled: "Ultra: ",
        syncUltraEnableAction: " Ultra",
        syncUltraDisableAction: " Ultra",
        syncUltraProfileBalanced: " : ",
        syncUltraProfileBattery: " : ",
        syncUltraProfileToggle: "  ",
        syncUltraHintDisabled:
          "Ultra  . Sync      .",
        syncUltraHintBalanced:
          ":      .",
        syncUltraHintBattery:
          ":    /    .",
        syncCacheConfirm:
          "Cache         ",
        syncSignOutConfirm: "  Google  ",
      };

      const THEMES = [
        { id: "glass", name: "Glassmorphism 2.0" },
        { id: "brutal", name: "Neo-Brutal Pro" },
        { id: "luxury", name: "Dark Luxury" },
        { id: "hacker", name: "Hacker Clean" },
        { id: "aurora", name: "Aurora Mesh" },
        { id: "mono", name: "Monochrome Minimal" },
        { id: "soft", name: "Soft Neumorphism" },
        { id: "material", name: "Material You" },
        { id: "frosted", name: "Frosted + Noise" },
        { id: "editorial", name: "Editorial" },
        { id: "mathlight", name: "Mathematics Light" },
        { id: "mathdark", name: "Mathematics Dark" },
        { id: "chemistrylight", name: "Chemistry Light" },
        { id: "chemistrydark", name: "Chemistry Dark" },
      ];
      const STATIC_SYMBOL_THEME_IDS = new Set([
        "mathlight",
        "mathdark",
        "chemistrylight",
        "chemistrydark",
      ]);
      const MOBILE_SYMBOL_RAIN_THEME_IDS = new Set([
        "chemistrylight",
        "chemistrydark",
      ]);

      const DEFAULT_CLASSES = [
        {
          id: 1,
          name: "\u0645\u062f\u0644\u0633\u0627\u0632\u06cc \u0645\u0642\u062f\u0645\u0627\u062a\u06cc \u0631\u06cc\u0627\u0636\u06cc",
          prof: "\u0627\u0633\u062a\u0627\u062f \u0632\u0627\u062c",
          unit: 3,
          day: 0,
          start: "08:00",
          end: "10:00",
          type: "normal",
          note: "",
        },

        {
          id: 2,
          name: "\u0631\u06cc\u0627\u0636\u06cc \u0639\u0645\u0648\u0645\u06cc 2",
          prof: "\u0627\u0633\u062a\u0627\u062f \u0637\u0627\u0644\u0628\u06cc",
          unit: 4,
          day: 1,
          start: "08:00",
          end: "10:00",
          type: "normal",
          note: "",
        },
        {
          id: 3,
          name: "\u0645\u0628\u0627\u0646\u06cc \u062a\u0631\u06a9\u06cc\u0628\u06cc\u0627\u062a",
          prof: "\u0627\u0633\u062a\u0627\u062f \u0645\u06cc\u0631\u0632\u0627 \u0648\u0632\u06cc\u0631\u06cc",
          unit: 4,
          day: 1,
          start: "10:00",
          end: "12:00",
          type: "normal",
          note: "",
        },

        {
          id: 4,
          name: "\u0645\u0628\u0627\u0646\u06cc \u0639\u0644\u0648\u0645 \u0631\u06cc\u0627\u0636\u06cc 2",
          prof: "\u0647\u0627\u0646\u06cc\u0647 \u0645\u06cc\u0631 \u0627\u0628\u0631\u0627\u0647\u06cc\u0645\u06cc",
          unit: 2,
          day: 2,
          start: "08:00",
          end: "10:00",
          type: "normal",
          note: "",
        },
        {
          id: 5,
          name: "\u0632\u0628\u0627\u0646 \u0627\u0646\u06af\u0644\u06cc\u0633\u06cc",
          prof: "\u0646\u0627\u0645\u0634\u062e\u0635",
          unit: 3,
          day: 2,
          start: "14:00",
          end: "16:00",
          type: "even",
          note: "",
        },

        {
          id: 6,
          name: "\u0645\u0628\u0627\u0646\u06cc \u062a\u0631\u06a9\u06cc\u0628\u06cc\u0627\u062a",
          prof: "\u0627\u0633\u062a\u0627\u062f \u0645\u06cc\u0631\u0632\u0627 \u0648\u0632\u06cc\u0631\u06cc",
          unit: 4,
          day: 3,
          start: "10:00",
          end: "12:00",
          type: "normal",
          note: "",
        },
        {
          id: 7,
          name: "\u0645\u062f\u0644\u0633\u0627\u0632\u06cc \u0645\u0642\u062f\u0645\u0627\u062a\u06cc \u0631\u06cc\u0627\u0636\u06cc",
          prof: "\u0627\u0633\u062a\u0627\u062f \u0632\u0627\u062c",
          unit: 3,
          day: 3,
          start: "14:00",
          end: "16:00",
          type: "odd",
          note: "",
        },
        {
          id: 8,
          name: "\u0631\u06cc\u0627\u0636\u06cc \u0639\u0645\u0648\u0645\u06cc 2",
          prof: "\u0627\u0633\u062a\u0627\u062f \u0637\u0627\u0644\u0628\u06cc",
          unit: 4,
          day: 3,
          start: "16:00",
          end: "18:00",
          type: "normal",
          note: "",
        },
        {
          id: 9,
          name: "\u0632\u0628\u0627\u0646 \u0627\u0646\u06af\u0644\u06cc\u0633\u06cc",
          prof: "\u0646\u0627\u0645\u0634\u062e\u0635",
          unit: 3,
          day: 4,
          start: "14:00",
          end: "16:00",
          type: "normal",
          note: "",
        },
        {
          id: 10,
          name: "\u0622\u0632\u0645\u0627\u06cc\u0634\u06af\u0627\u0647 \u0631\u06cc\u0627\u0636\u06cc 1",
          prof: "\u0627\u0633\u062a\u0627\u062f \u0641\u0631\u0634\u0686\u06cc\u0627\u0646",
          unit: 1,
          day: 4,
          start: "16:00",
          end: "18:00",
          type: "normal",
          note: "",
        },
      ].filter((item) => {
        const prof = String(item?.prof || "").trim();
        const name = String(item?.name || "").trim();
        const isParviziPracticeClass =
          prof.includes(
            "\u0627\u0633\u062a\u0627\u062f \u067e\u0631\u0648\u06cc\u0632\u06cc",
          ) && /\u062d\u0644\s*\u062a\u0645\u0631\u06cc\u0646/.test(name);
        return !isParviziPracticeClass;
      });

      const TIME_SLOTS = [
        ["08:00", "10:00"],
        ["10:00", "12:00"],
        ["12:00", "14:00"],
        ["14:00", "16:00"],
        ["16:00", "18:00"],
        ["18:00", "20:00"],
      ];
      const CLASS_DURATION_MINUTES = 90;
      const NOTIFY_BEFORE_OPTIONS = [
        0, 5, 10, 15, 20, 30, 45, 60, 90, 120, 180, 360, 720, 1440, 2880, 10080,
      ];
      const NOTIFY_LATE_GRACE_MS = 7 * 24 * 60 * 60 * 1000;
      const HANDOUT_MAX_FILE_BYTES = 2 * 1024 * 1024;
      const HANDOUT_MAX_DATAURL_LEN = 3000000;
      const WEEKLY_FOOD_REMINDER = {
        day: 3,
        hour: 15,
        minute: 0,
        text: "    !!!",
      };
      const MOBILE_ULTRA_SMOOTH_HEAVY_THEMES = new Set([
        "frosted",
        "hacker",
        "aurora",
        "chemistrydark",
      ]);
      const PERF_PROFILE = (() => {
        const nav = typeof navigator !== "undefined" ? navigator : {};
        const ua = String(nav.userAgent || "");
        const isAndroid = /Android/i.test(ua);
        const conn =
          nav.connection || nav.mozConnection || nav.webkitConnection || null;
        const media = (q) =>
          typeof window !== "undefined" &&
          typeof window.matchMedia === "function"
            ? window.matchMedia(q).matches
            : false;
        const coarsePointer = media("(pointer: coarse)");
        const reducedMotion = media("(prefers-reduced-motion: reduce)");
        const cpu = Number(nav.hardwareConcurrency || 0);
        const ram = Number(nav.deviceMemory || 0);
        const saveData = Boolean(conn && conn.saveData);
        const effectiveType = String(
          (conn && conn.effectiveType) || "",
        ).toLowerCase();
        const slowNetwork =
          effectiveType === "slow-2g" ||
          effectiveType === "2g" ||
          effectiveType === "3g";
        const veryLowHardware = (cpu > 0 && cpu <= 4) || (ram > 0 && ram <= 2);
        const lowHardware = (cpu > 0 && cpu <= 6) || (ram > 0 && ram <= 4);
        const isMobile = isAndroid || coarsePointer;
        const ultraLite =
          reducedMotion ||
          saveData ||
          (isMobile && (veryLowHardware || slowNetwork));
        const lite = ultraLite || (isMobile && lowHardware);
        const fxScale = ultraLite ? 0.08 : lite ? 0.16 : isMobile ? 0.3 : 1;
        const loopMs = ultraLite
          ? 70000
          : lite
            ? 52000
            : isMobile
              ? 36000
              : 15000;

        return {
          isAndroid,
          isMobile,
          saveData,
          slowNetwork,
          lowHardware,
          veryLowHardware,
          reducedMotion,
          ultraLite,
          lite,
          fxScale,
          loopMs,
        };
      })();

      function getAnimIntensityMode() {
        const raw = String(
          document.body?.getAttribute("data-anim-intensity") || "high",
        )
          .trim()
          .toLowerCase();
        return raw === "ultra-low" || raw === "low" ? raw : "high";
      }

      function isNarrowViewport() {
        return Boolean(
          typeof window !== "undefined" &&
          typeof window.matchMedia === "function" &&
          window.matchMedia("(max-width: 1024px)").matches,
        );
      }

      function syncDynamicViewportVars() {
        if (typeof window === "undefined" || typeof document === "undefined") {
          return;
        }
        const root = document.documentElement;
        if (!root) return;
        const vv = window.visualViewport || null;
        const rawH = vv ? vv.height : window.innerHeight;
        const rawW = vv ? vv.width : window.innerWidth;
        const vh = Math.max(320, Math.round(Number(rawH) || 0));
        const vw = Math.max(320, Math.round(Number(rawW) || 0));
        root.style.setProperty("--app-vh", `${vh}px`);
        root.style.setProperty("--app-vw", `${vw}px`);
      }

      function scaleEffectCount(base, min = 4) {
        const n = Number(base) || 0;
        const intensity = getAnimIntensityMode();
        const intensityScale =
          intensity === "ultra-low" ? 0.08 : intensity === "low" ? 0.58 : 1;
        const mergedScale = Math.min(1, PERF_PROFILE.fxScale * intensityScale);
        const minCount =
          intensity === "ultra-low" ? Math.max(1, Math.floor(min / 4)) : min;

        if (mergedScale >= 0.999) return Math.max(minCount, n);
        return Math.max(minCount, Math.round(n * mergedScale));
      }

      function resetDynamicFxLayers() {
        document.querySelectorAll(".bg-layer").forEach((layer) => {
          if (typeof layer.__fxCleanup === "function") {
            try {
              layer.__fxCleanup();
            } catch (_err) {}
          }
          layer.__fxCleanup = null;
          layer.dataset.fxReady = "0";
          const wraps = layer.querySelectorAll(".theme-fx");
          wraps.forEach((node) => node.remove());
          if (layer.classList.contains("bg-hacker")) {
            layer.dataset.ready = "0";
            layer.dataset.hackerMode = "";
            layer.querySelectorAll(".col").forEach((node) => node.remove());
          }
        });

        document.querySelectorAll(".symbol-layer").forEach((layer) => {
          layer.dataset.ready = "0";
          layer.classList.remove("active");
          layer
            .querySelectorAll(".symbol-node")
            .forEach((node) => node.remove());
        });
      }

      // Hacker binary rain builder (idempotent)
      function buildBinaryRain(options = {}) {
        const opts = options && typeof options === "object" ? options : {};
        const forceStatic = Boolean(opts.forceStatic);
        const intensity = getAnimIntensityMode();
        const mobileLike = PERF_PROFILE.isMobile || isNarrowViewport();
        const staticMode =
          forceStatic ||
          String(document.body?.getAttribute("data-anim-enabled") || "on") ===
            "off";
        if (!staticMode && intensity === "ultra-low" && mobileLike) return;
        const layer = document.querySelector(".bg-hacker");
        if (!layer) return;
        const modeKey = staticMode ? "static" : "dynamic";
        if (
          layer.dataset.ready === "1" &&
          String(layer.dataset.hackerMode || "") === modeKey
        )
          return;
        layer.querySelectorAll(".col").forEach((node) => node.remove());
        layer.dataset.ready = "1";
        layer.dataset.hackerMode = modeKey;

        const ultraLow = intensity === "ultra-low";
        const cols = staticMode
          ? Math.max(
              5,
              Math.round(
                (mobileLike ? 10 : 17) *
                  (PERF_PROFILE.ultraLite
                    ? 0.62
                    : PERF_PROFILE.lite
                      ? 0.82
                      : 1),
              ),
            )
          : scaleEffectCount(26, ultraLow ? 2 : 8);
        const heightChars = staticMode
          ? PERF_PROFILE.ultraLite
            ? mobileLike
              ? 10
              : 16
            : mobileLike
              ? 14
              : 24
          : ultraLow
            ? mobileLike
              ? 10
              : 16
            : PERF_PROFILE.lite
              ? 40
              : PERF_PROFILE.isMobile
                ? 56
                : 90;

        const staticGlyphs = ["0", "1"];

        for (let i = 0; i < cols; i++) {
          const col = document.createElement("div");
          col.className = "col";
          let s = "";
          for (let k = 0; k < heightChars; k++)
            s +=
              (staticMode
                ? staticGlyphs[Math.floor(Math.random() * staticGlyphs.length)]
                : Math.random() > 0.5
                  ? "1"
                  : "0") + "\n";
          col.textContent = s;

          const left = i * (100 / cols) + Math.random() * 1.2;
          const dur = staticMode
            ? 0
            : ultraLow
              ? 16 + Math.random() * 18
              : 6 + Math.random() * 9;
          const delay = staticMode ? 0 : -(Math.random() * dur);
          const size = staticMode
            ? mobileLike
              ? 10 + Math.random() * 2.5
              : 11.5 + Math.random() * 3
            : ultraLow
              ? 8 + Math.random() * 2
              : 10 + Math.random() * 4;
          const opacity = staticMode
            ? 0.18 + Math.random() * 0.2
            : ultraLow
              ? 0.06 + Math.random() * 0.08
              : 0.1 + Math.random() * 0.22;
          const staticTop = staticMode
            ? 2 + Math.random() * 82
            : Math.random() * 100;

          col.style.left = left + "%";
          col.style.fontSize = size + "px";
          col.style.opacity = opacity;
          col.style.setProperty("--static-top", `${staticTop.toFixed(2)}%`);
          col.style.setProperty("--static-alpha", opacity.toFixed(2));
          if (staticMode) {
            col.style.animation = "none";
          } else {
            col.style.setProperty("--dur", dur + "s");
            col.style.animationDuration = dur + "s";
            col.style.animationDelay = delay + "s";
          }

          layer.appendChild(col);
        }
      }

      function rand(min, max) {
        return min + Math.random() * (max - min);
      }

      function pickRandom(list) {
        const arr = Array.isArray(list) ? list : [];
        if (!arr.length) return "";
        return arr[Math.floor(Math.random() * arr.length)];
      }

      function createFxWrap(layer, className) {
        const wrap = document.createElement("div");
        wrap.className = `theme-fx ${className}`;
        layer.appendChild(wrap);
        return wrap;
      }

      function buildMaterialBouncingFx(layer, intensity = "high") {
        const isLow = intensity === "low";
        const wrap = createFxWrap(layer, "fx-material-bounce");
        const count = scaleEffectCount(isLow ? 10 : 14, 3);
        const balls = [];
        const tones = ["tone-0", "tone-1", "tone-2", "tone-3"];

        let width = 0;
        let height = 0;
        let rafId = 0;
        let frame = 0;
        let lastTs = performance.now();

        const syncBounds = () => {
          const rect = layer.getBoundingClientRect();
          width = Math.max(220, Math.floor(rect.width || 0));
          height = Math.max(180, Math.floor(rect.height || 0));
        };

        syncBounds();

        for (let i = 0; i < count; i++) {
          const radius = rand(isLow ? 9 : 10, isLow ? 15 : 20);
          const ball = document.createElement("span");
          ball.className = `fx-ball ${tones[i % tones.length]}`;
          ball.style.setProperty("--size", `${(radius * 2).toFixed(2)}px`);
          ball.style.setProperty(
            "--alpha",
            (0.72 + Math.random() * 0.2).toFixed(2),
          );
          wrap.appendChild(ball);

          const speed = rand(isLow ? 36 : 44, isLow ? 58 : 76);
          const angle = rand(0, Math.PI * 2);
          const x = rand(radius, Math.max(radius + 1, width - radius));
          const y = rand(radius, Math.max(radius + 1, height - radius));

          balls.push({
            node: ball,
            r: radius,
            x,
            y,
            vx: Math.cos(angle) * speed,
            vy: Math.sin(angle) * speed,
          });
        }

        const tick = (ts) => {
          const dt = Math.min(0.034, Math.max(0.008, (ts - lastTs) / 1000));
          lastTs = ts;

          frame += 1;
          if (frame % 16 === 0) syncBounds();

          for (let i = 0; i < balls.length; i++) {
            const b = balls[i];
            b.x += b.vx * dt;
            b.y += b.vy * dt;

            if (b.x <= b.r) {
              b.x = b.r;
              b.vx = Math.abs(b.vx);
            } else if (b.x >= width - b.r) {
              b.x = width - b.r;
              b.vx = -Math.abs(b.vx);
            }

            if (b.y <= b.r) {
              b.y = b.r;
              b.vy = Math.abs(b.vy);
            } else if (b.y >= height - b.r) {
              b.y = height - b.r;
              b.vy = -Math.abs(b.vy);
            }
          }

          for (let i = 0; i < balls.length; i++) {
            for (let j = i + 1; j < balls.length; j++) {
              const a = balls[i];
              const b = balls[j];
              const dx = b.x - a.x;
              const dy = b.y - a.y;
              const minDist = a.r + b.r;
              const distSq = dx * dx + dy * dy;
              if (distSq <= 0 || distSq > minDist * minDist) continue;

              const dist = Math.sqrt(distSq);
              const nx = dx / dist;
              const ny = dy / dist;
              const overlap = minDist - dist;

              a.x -= nx * overlap * 0.5;
              a.y -= ny * overlap * 0.5;
              b.x += nx * overlap * 0.5;
              b.y += ny * overlap * 0.5;

              const rel = (a.vx - b.vx) * nx + (a.vy - b.vy) * ny;
              if (rel > 0) {
                a.vx -= rel * nx;
                a.vy -= rel * ny;
                b.vx += rel * nx;
                b.vy += rel * ny;
              }
            }
          }

          for (let i = 0; i < balls.length; i++) {
            const b = balls[i];
            b.node.style.transform = `translate3d(${(b.x - b.r).toFixed(2)}px, ${(b.y - b.r).toFixed(2)}px, 0)`;
          }

          rafId = window.requestAnimationFrame(tick);
        };

        rafId = window.requestAnimationFrame(tick);
        layer.__fxCleanup = () => {
          if (rafId) window.cancelAnimationFrame(rafId);
          rafId = 0;
        };
      }

      function getSoftAnimalSvg(type) {
        if (type === "cow") {
          return `
            <svg viewBox="0 0 96 64" aria-hidden="true">
              <ellipse class="soft-outline" cx="44" cy="37" rx="25" ry="15" fill="#f8fafc"/>
              <ellipse class="soft-outline" cx="36" cy="33" rx="6" ry="4.2" fill="#cbd5e1"/>
              <ellipse class="soft-outline" cx="53" cy="40" rx="7.4" ry="4.8" fill="#bfdbfe"/>
              <circle class="soft-outline" cx="66" cy="27" r="9.6" fill="#e2e8f0"/>
              <circle class="soft-eye" cx="63.2" cy="27" r="1.5"/>
              <circle class="soft-eye" cx="69.2" cy="27" r="1.5"/>
              <ellipse class="soft-outline" cx="67" cy="32.5" rx="6.2" ry="4" fill="#fbcfe8"/>
              <path class="soft-outline" d="M58 21l-3.4-3.8M74 21l3.4-3.8" fill="none"/>
              <rect class="soft-outline soft-paw" x="28" y="48" width="4" height="8" rx="2"/>
              <rect class="soft-outline soft-paw" x="52" y="48" width="4" height="8" rx="2"/>
            </svg>
          `;
        }
        if (type === "cat") {
          return `
            <svg viewBox="0 0 96 64" aria-hidden="true">
              <g class="soft-cat">
                <ellipse class="soft-outline" cx="43" cy="39" rx="18" ry="11" fill="#fde68a"/>
                <circle class="soft-outline" cx="58" cy="30" r="8.6" fill="#fef3c7"/>
                <polygon class="soft-outline" points="53,24 56.6,18 59.8,24" fill="#f59e0b"/>
                <polygon class="soft-outline" points="60.2,24 63.2,18.4 66.6,24" fill="#f59e0b"/>
                <circle class="soft-eye" cx="56.2" cy="30" r="1.4"/>
                <circle class="soft-eye" cx="60.8" cy="30" r="1.4"/>
                <path class="soft-outline soft-cat-tail" d="M24 39c-7 2-8.4 7-3.6 10.6" fill="none"/>
                <rect class="soft-outline soft-paw" x="34" y="47" width="3.8" height="7" rx="1.9"/>
                <rect class="soft-outline soft-paw" x="46" y="47" width="3.8" height="7" rx="1.9"/>
              </g>
            </svg>
          `;
        }
        if (type === "mouse") {
          return `
            <svg viewBox="0 0 96 64" aria-hidden="true">
              <g class="soft-mouse">
                <ellipse class="soft-outline" cx="40" cy="40" rx="12" ry="7.8" fill="#dbeafe"/>
                <circle class="soft-outline" cx="50.8" cy="36.2" r="5.4" fill="#e0f2fe"/>
                <circle class="soft-outline" cx="46.8" cy="32.2" r="2.8" fill="#fbcfe8"/>
                <circle class="soft-outline" cx="54.6" cy="31.4" r="2.6" fill="#fbcfe8"/>
                <circle class="soft-eye" cx="52.2" cy="36.2" r="1.1"/>
                <path class="soft-outline soft-mouse-tail" d="M30 41c-7.8 2.2-11.2 7-12.2 12.2" fill="none"/>
              </g>
            </svg>
          `;
        }
        if (type === "dog-sheep") {
          return `
            <svg viewBox="0 0 96 64" aria-hidden="true">
              <g class="soft-sheep-a">
                <ellipse class="soft-outline" cx="24" cy="37" rx="11.6" ry="8.2" fill="#f8fafc"/>
                <circle class="soft-outline" cx="31.8" cy="34.4" r="4.8" fill="#e2e8f0"/>
                <circle class="soft-eye" cx="32.8" cy="34.2" r="1.1"/>
                <rect class="soft-outline soft-paw" x="19.8" y="43.6" width="2.8" height="5.8" rx="1.4"/>
                <rect class="soft-outline soft-paw" x="26.2" y="43.6" width="2.8" height="5.8" rx="1.4"/>
              </g>
              <g class="soft-sheep-b">
                <ellipse class="soft-outline" cx="40" cy="40" rx="10.8" ry="7.8" fill="#f1f5f9"/>
                <circle class="soft-outline" cx="47.2" cy="38" r="4.4" fill="#dbeafe"/>
                <circle class="soft-eye" cx="48" cy="38" r="1"/>
              </g>
              <g class="soft-dog">
                <ellipse class="soft-outline" cx="69" cy="39" rx="15.4" ry="9.8" fill="#fdba74"/>
                <circle class="soft-outline" cx="79.2" cy="33.4" r="7" fill="#fed7aa"/>
                <ellipse class="soft-outline" cx="74.2" cy="28.2" rx="3.1" ry="4.6" fill="#92400e"/>
                <ellipse class="soft-outline" cx="83.6" cy="28.2" rx="3.1" ry="4.6" fill="#92400e"/>
                <circle class="soft-eye" cx="77.4" cy="33.4" r="1.2"/>
                <circle class="soft-eye" cx="81.5" cy="33.4" r="1.2"/>
                <path class="soft-outline soft-dog-tail" d="M54 38c-5.4 1.4-7 5.2-4.2 8.6" fill="none"/>
                <rect class="soft-outline soft-paw" x="62.4" y="45.4" width="3.1" height="6.5" rx="1.55"/>
                <rect class="soft-outline soft-paw" x="73.6" y="45.4" width="3.1" height="6.5" rx="1.55"/>
              </g>
            </svg>
          `;
        }
        if (type === "chicken" || type === "chicken-family") {
          return `
            <svg viewBox="0 0 96 64" aria-hidden="true">
              <g class="soft-hen">
                <ellipse class="soft-outline" cx="56" cy="37" rx="17" ry="11.4" fill="#f8fafc"/>
                <g class="soft-hen-head">
                  <circle class="soft-outline" cx="68.8" cy="28.4" r="8" fill="#fff1f2"/>
                  <path class="soft-outline" d="M64 21c2.2-3.4 5.6-4.2 8.4-1.8" fill="none"/>
                </g>
                <polygon class="soft-outline" points="75.4,28.4 83.8,31.1 75.4,33.8" fill="#f59e0b"/>
                <circle class="soft-eye" cx="69.8" cy="28.3" r="1.4"/>
                <rect class="soft-outline soft-paw" x="48" y="46.2" width="3.1" height="6.8" rx="1.55"/>
                <rect class="soft-outline soft-paw" x="56.2" y="46.2" width="3.1" height="6.8" rx="1.55"/>
              </g>
              <g class="soft-chick-a">
                <ellipse class="soft-outline" cx="31.8" cy="44.6" rx="6.2" ry="4.9" fill="#fde68a"/>
                <circle class="soft-outline" cx="36.4" cy="41.8" r="3.2" fill="#fef3c7"/>
                <polygon class="soft-outline" points="39.4,41.8 43.6,43 39.4,44.1" fill="#f59e0b"/>
                <circle class="soft-eye" cx="37" cy="41.6" r="0.86"/>
              </g>
              <g class="soft-chick-b">
                <ellipse class="soft-outline" cx="21" cy="47.2" rx="5.4" ry="4.4" fill="#fde68a"/>
                <circle class="soft-outline" cx="25" cy="44.8" r="2.8" fill="#fef3c7"/>
                <polygon class="soft-outline" points="27.5,44.8 30.8,45.8 27.5,46.7" fill="#f59e0b"/>
                <circle class="soft-eye" cx="25.5" cy="44.7" r="0.8"/>
              </g>
            </svg>
          `;
        }
        if (type === "cat-chase") {
          return `
            <svg viewBox="0 0 96 64" aria-hidden="true">
              <g class="soft-cat">
                <ellipse class="soft-outline" cx="32" cy="40" rx="14.2" ry="9.4" fill="#fde68a"/>
                <circle class="soft-outline" cx="43.2" cy="33.2" r="7.2" fill="#fef3c7"/>
                <polygon class="soft-outline" points="38.2,28 40.8,23 43.4,28" fill="#f59e0b"/>
                <polygon class="soft-outline" points="44.3,28 47.1,23 49.6,28" fill="#f59e0b"/>
                <circle class="soft-eye" cx="41.4" cy="33.1" r="1.2"/>
                <circle class="soft-eye" cx="45.1" cy="33.1" r="1.2"/>
                <path class="soft-outline soft-cat-tail" d="M18 40c-6.4 2.2-7.8 6.4-3.8 9.4" fill="none"/>
              </g>
              <g class="soft-mouse">
                <ellipse class="soft-outline" cx="73" cy="43.2" rx="8.8" ry="5.8" fill="#dbeafe"/>
                <circle class="soft-outline" cx="79.6" cy="40.1" r="4.1" fill="#e0f2fe"/>
                <circle class="soft-outline" cx="76.6" cy="37.4" r="2.1" fill="#fbcfe8"/>
                <circle class="soft-outline" cx="82.4" cy="36.9" r="2" fill="#fbcfe8"/>
                <circle class="soft-eye" cx="80.4" cy="40" r="0.9"/>
                <path class="soft-outline soft-mouse-tail" d="M66.5 43.3c-5.6 1.4-8.4 4.6-9.3 8.8" fill="none"/>
              </g>
            </svg>
          `;
        }
        return `
          <svg viewBox="0 0 96 64" aria-hidden="true">
            <ellipse class="soft-outline" cx="42" cy="37" rx="22" ry="14" fill="#f8fafc"/>
            <circle class="soft-outline" cx="26" cy="34" r="8.8" fill="#ffffff"/>
            <circle class="soft-outline" cx="57.2" cy="33.8" r="8.8" fill="#ffffff"/>
            <circle class="soft-outline" cx="63.8" cy="34.6" r="7.8" fill="#dbeafe"/>
            <circle class="soft-eye" cx="65.4" cy="34.4" r="1.1"/>
            <rect class="soft-outline soft-paw" x="31" y="47" width="3.1" height="7" rx="1.55"/>
            <rect class="soft-outline soft-paw" x="45.8" y="47" width="3.1" height="7" rx="1.55"/>
          </svg>
        `;
      }

      function buildSoftAnimalsFx(layer, intensity = "high") {
        const isLow = intensity === "low";
        const wrap = createFxWrap(layer, "fx-soft-animals");
        const count = scaleEffectCount(isLow ? 6 : 9, 3);
        const featured = [
          "cat-chase",
          "dog-sheep",
          "chicken-family",
          "cow",
          "cat",
        ];
        const pool = [
          "sheep",
          "cow",
          "cat",
          "mouse",
          "dog-sheep",
          "chicken-family",
        ];

        for (let i = 0; i < count; i++) {
          const type = i < featured.length ? featured[i] : pickRandom(pool);
          const n = document.createElement("span");
          const isScene =
            type === "cat-chase" ||
            type === "dog-sheep" ||
            type === "chicken-family";
          const size =
            type === "mouse"
              ? rand(isLow ? 42 : 46, isLow ? 58 : 64)
              : isScene
                ? rand(isLow ? 64 : 70, isLow ? 84 : 94)
                : rand(isLow ? 50 : 56, isLow ? 72 : 80);
          const dx = rand(-30, 30);
          const dy = rand(-18, 14);
          n.className = "fx-node fx-animal";
          n.dataset.animal = type;
          n.style.setProperty("--x", `${rand(4, 92).toFixed(2)}%`);
          n.style.setProperty("--y", `${rand(8, 84).toFixed(2)}%`);
          n.style.setProperty("--size", `${size.toFixed(2)}px`);
          n.style.setProperty(
            "--alpha",
            rand(isLow ? 0.74 : 0.82, isLow ? 0.92 : 0.98).toFixed(2),
          );
          n.style.setProperty("--dx", `${dx.toFixed(1)}px`);
          n.style.setProperty("--dy", `${dy.toFixed(1)}px`);
          n.style.setProperty(
            "--drift-dur",
            `${rand(15, isLow ? 26 : 22).toFixed(2)}s`,
          );
          n.style.setProperty(
            "--bob-dur",
            `${rand(5.2, isLow ? 8.4 : 7.6).toFixed(2)}s`,
          );
          n.style.setProperty("--delay", `${(-rand(0, 12)).toFixed(2)}s`);
          n.innerHTML = getSoftAnimalSvg(type);
          wrap.appendChild(n);
        }
      }

      function buildAuroraCyberFx(layer, intensity = "high") {
        const isLow = intensity === "low";
        const wrap = createFxWrap(layer, "fx-aurora-cyber");
        const lineCount = scaleEffectCount(isLow ? 8 : 12, 3);
        const particleCount = scaleEffectCount(isLow ? 14 : 22, 5);
        const waveCount = scaleEffectCount(isLow ? 2 : 3, 1);

        for (let i = 0; i < lineCount; i++) {
          const line = document.createElement("span");
          line.className = "fx-node cyber-line";
          line.style.setProperty("--x", `${rand(-8, 92).toFixed(2)}%`);
          line.style.setProperty("--y", `${rand(4, 94).toFixed(2)}%`);
          line.style.setProperty(
            "--w",
            `${rand(90, isLow ? 180 : 240).toFixed(2)}px`,
          );
          line.style.setProperty("--alpha", rand(0.14, 0.34).toFixed(2));
          line.style.setProperty("--rot", `${rand(-14, 14).toFixed(2)}deg`);
          line.style.setProperty("--dx", `${rand(50, 140).toFixed(1)}px`);
          line.style.setProperty("--dy", `${rand(-16, 16).toFixed(1)}px`);
          line.style.setProperty("--dur", `${rand(6.8, 12.8).toFixed(2)}s`);
          line.style.setProperty("--delay", `${(-rand(0, 12)).toFixed(2)}s`);
          wrap.appendChild(line);
        }

        for (let i = 0; i < particleCount; i++) {
          const particle = document.createElement("span");
          particle.className = "fx-node cyber-particle";
          particle.style.setProperty("--x", `${rand(0, 100).toFixed(2)}%`);
          particle.style.setProperty("--y", `${rand(0, 100).toFixed(2)}%`);
          particle.style.setProperty(
            "--size",
            `${rand(2, isLow ? 4.2 : 5.8).toFixed(2)}px`,
          );
          particle.style.setProperty("--alpha", rand(0.12, 0.3).toFixed(2));
          particle.style.setProperty("--dx", `${rand(-24, 24).toFixed(1)}px`);
          particle.style.setProperty("--dy", `${rand(-20, 18).toFixed(1)}px`);
          particle.style.setProperty("--dur", `${rand(5.8, 11.4).toFixed(2)}s`);
          particle.style.setProperty(
            "--delay",
            `${(-rand(0, 10)).toFixed(2)}s`,
          );
          wrap.appendChild(particle);
        }

        for (let i = 0; i < waveCount; i++) {
          const wave = document.createElement("span");
          wave.className = "fx-node cyber-wave";
          wave.style.setProperty("--x", `${rand(6, 72).toFixed(2)}%`);
          wave.style.setProperty("--y", `${rand(10, 80).toFixed(2)}%`);
          wave.style.setProperty("--w", `${rand(160, 320).toFixed(2)}px`);
          wave.style.setProperty("--h", `${rand(84, 180).toFixed(2)}px`);
          wave.style.setProperty("--dx", `${rand(-24, 24).toFixed(1)}px`);
          wave.style.setProperty("--dy", `${rand(-12, 12).toFixed(1)}px`);
          wave.style.setProperty("--dur", `${rand(10, 16).toFixed(2)}s`);
          wave.style.setProperty("--delay", `${(-rand(0, 10)).toFixed(2)}s`);
          wrap.appendChild(wave);
        }

        const scan = document.createElement("span");
        scan.className = "fx-node cyber-scan";
        scan.style.setProperty("--dur", `${rand(9.8, 15.8).toFixed(2)}s`);
        scan.style.setProperty("--delay", `${(-rand(0, 10)).toFixed(2)}s`);
        wrap.appendChild(scan);
      }

      function buildLuxuryGoldFx(layer, intensity = "high") {
        const isLow = intensity === "low";
        const wrap = createFxWrap(layer, "fx-luxury-gold");
        const count = scaleEffectCount(isLow ? 13 : 20, 4);

        for (let i = 0; i < count; i++) {
          const r = Math.random();
          const kind = r < 0.56 ? "coin" : r < 0.84 ? "bar" : "chain";
          const node = document.createElement("span");
          node.className = `fx-node gold-drop kind-${kind}`;

          const size =
            kind === "bar"
              ? rand(isLow ? 10 : 12, isLow ? 17 : 22)
              : kind === "chain"
                ? rand(isLow ? 12 : 14, isLow ? 18 : 24)
                : rand(isLow ? 10 : 11, isLow ? 16 : 20);

          node.style.setProperty("--x", `${rand(2, 98).toFixed(2)}%`);
          node.style.setProperty("--size", `${size.toFixed(2)}px`);
          node.style.setProperty("--alpha", rand(0.18, 0.36).toFixed(2));
          node.style.setProperty(
            "--dur",
            `${rand(isLow ? 14 : 11, isLow ? 24 : 20).toFixed(2)}s`,
          );
          node.style.setProperty("--delay", `${(-rand(0, 20)).toFixed(2)}s`);
          node.style.setProperty("--drift", `${rand(-26, 28).toFixed(1)}px`);
          node.style.setProperty(
            "--rot-start",
            `${rand(-18, 18).toFixed(1)}deg`,
          );
          node.style.setProperty(
            "--rot-spin",
            `${rand(90, 170).toFixed(1)}deg`,
          );
          wrap.appendChild(node);
        }
      }

      function buildGlassShardsFx(layer, intensity = "high") {
        const isLow = intensity === "low";
        const wrap = createFxWrap(layer, "fx-glass-shards");
        const clips = [
          "polygon(8% 20%, 78% 4%, 96% 44%, 72% 96%, 6% 78%)",
          "polygon(14% 8%, 88% 18%, 80% 80%, 26% 94%, 4% 42%)",
          "polygon(6% 26%, 60% 6%, 94% 32%, 86% 86%, 20% 94%)",
          "polygon(12% 10%, 82% 8%, 98% 54%, 58% 96%, 2% 70%)",
        ];
        const count = scaleEffectCount(isLow ? 10 : 15, 3);

        for (let i = 0; i < count; i++) {
          const node = document.createElement("span");
          node.className = "fx-node glass-shard";
          node.style.setProperty("--x", `${rand(0, 100).toFixed(2)}%`);
          node.style.setProperty("--y", `${rand(4, 94).toFixed(2)}%`);
          node.style.setProperty(
            "--size",
            `${rand(isLow ? 24 : 28, isLow ? 52 : 72).toFixed(2)}px`,
          );
          node.style.setProperty("--alpha", rand(0.16, 0.34).toFixed(2));
          node.style.setProperty(
            "--dur",
            `${rand(isLow ? 12 : 10, isLow ? 22 : 18).toFixed(2)}s`,
          );
          node.style.setProperty("--delay", `${(-rand(0, 18)).toFixed(2)}s`);
          node.style.setProperty("--dx", `${rand(-26, 26).toFixed(1)}px`);
          node.style.setProperty("--dy", `${rand(-18, 14).toFixed(1)}px`);
          node.style.setProperty("--rot", `${rand(-26, 26).toFixed(1)}deg`);
          node.style.setProperty("--clip", pickRandom(clips));
          wrap.appendChild(node);
        }
      }

      const CUSTOM_THEME_FX_BUILDERS = {
        glass: buildGlassShardsFx,
        luxury: buildLuxuryGoldFx,
        aurora: buildAuroraCyberFx,
        soft: buildSoftAnimalsFx,
        material: buildMaterialBouncingFx,
      };

      function buildThemeFx(themeId = null) {
        const intensity = getAnimIntensityMode();
        const ultraLow = intensity === "ultra-low";
        if (ultraLow && (PERF_PROFILE.isMobile || isNarrowViewport())) return;
        const activeTheme =
          String(
            themeId ||
              document.body?.getAttribute("data-theme") ||
              DEFAULT_SETTINGS.theme,
          ).trim() || DEFAULT_SETTINGS.theme;
        const configs = [
          {
            selector: ".bg-glass",
            className: "fx-glass",
            count: 26,
            size: [4, 12],
            alpha: [0.1, 0.36],
            dur: [10, 21],
          },
          {
            selector: ".bg-brutal",
            className: "fx-brutal",
            count: 14,
            size: [8, 18],
            alpha: [0.08, 0.2],
            dur: [8, 16],
          },
          {
            selector: ".bg-luxury",
            className: "fx-luxury",
            count: 24,
            size: [3, 10],
            alpha: [0.08, 0.3],
            dur: [11, 24],
          },
          {
            selector: ".bg-hacker",
            className: "fx-hacker",
            count: 20,
            size: [22, 42],
            alpha: [0.16, 0.42],
            dur: [5, 11],
            fall: true,
          },
          {
            selector: ".bg-aurora",
            className: "fx-aurora",
            count: 18,
            size: [6, 14],
            alpha: [0.08, 0.32],
            dur: [9, 18],
          },
          {
            selector: ".bg-mono",
            className: "fx-mono",
            count: 30,
            size: [20, 52],
            alpha: [0.08, 0.24],
            dur: [8, 14],
          },
          {
            selector: ".bg-soft",
            className: "fx-soft",
            count: 20,
            size: [10, 24],
            alpha: [0.08, 0.22],
            dur: [12, 22],
          },
          {
            selector: ".bg-material",
            className: "fx-material",
            count: 16,
            size: [12, 30],
            alpha: [0.08, 0.22],
            dur: [10, 20],
          },
          {
            selector: ".bg-frosted",
            className: "fx-frosted",
            count: 26,
            size: [4, 11],
            alpha: [0.1, 0.3],
            dur: [7, 16],
            fall: true,
          },
          {
            selector: ".bg-editorial",
            className: "fx-editorial",
            count: 18,
            size: [6, 14],
            alpha: [0.08, 0.2],
            dur: [12, 24],
          },
          {
            selector: ".bg-mathlight",
            className: "fx-mathlight",
            count: 22,
            size: [8, 16],
            alpha: [0.1, 0.28],
            dur: [9, 16],
          },
          {
            selector: ".bg-mathdark",
            className: "fx-mathdark",
            count: 26,
            size: [7, 15],
            alpha: [0.12, 0.34],
            dur: [9, 18],
          },
        ];

        configs.forEach((cfg) => {
          const cfgTheme = cfg.selector.replace(/^\.(bg)-/, "");
          if (cfgTheme !== activeTheme) return;

          const layer = document.querySelector(cfg.selector);
          if (!layer) return;
          if (layer.dataset.fxReady === "1") return;
          layer.dataset.fxReady = "1";

          const customBuilder = CUSTOM_THEME_FX_BUILDERS[cfgTheme];
          if (typeof customBuilder === "function") {
            customBuilder(layer, intensity);
            return;
          }

          const wrap = document.createElement("div");
          wrap.className = `theme-fx ${cfg.className}`;
          const nodeCount = scaleEffectCount(cfg.count, 4);

          for (let i = 0; i < nodeCount; i++) {
            const n = document.createElement("span");
            n.className = "fx-node";

            const size = rand(cfg.size[0], cfg.size[1]);
            const alpha =
              rand(cfg.alpha[0], cfg.alpha[1]) * (ultraLow ? 0.56 : 1);
            const dur = rand(cfg.dur[0], cfg.dur[1]) * (ultraLow ? 1.75 : 1);
            const dx = cfg.fall
              ? rand(ultraLow ? -12 : -24, ultraLow ? 12 : 24)
              : rand(ultraLow ? -26 : -70, ultraLow ? 26 : 70);
            const dy = cfg.fall
              ? rand(0, ultraLow ? 10 : 24)
              : rand(ultraLow ? -22 : -60, ultraLow ? 22 : 60);
            const x = rand(0, 100);
            const y = cfg.fall ? rand(-110, 0) : rand(0, 100);

            n.style.setProperty("--x", `${x.toFixed(2)}%`);
            n.style.setProperty("--y", `${y.toFixed(2)}%`);
            n.style.setProperty("--size", `${size.toFixed(2)}px`);
            n.style.setProperty("--alpha", alpha.toFixed(2));
            n.style.setProperty("--dur", `${dur.toFixed(2)}s`);
            n.style.setProperty("--delay", `${(-rand(0, dur)).toFixed(2)}s`);
            n.style.setProperty("--dx", `${dx.toFixed(1)}px`);
            n.style.setProperty("--dy", `${dy.toFixed(1)}px`);
            n.style.setProperty("--rot", `${rand(-26, 26).toFixed(1)}deg`);
            n.style.setProperty(
              "--blur",
              `${rand(0, ultraLow ? 0.5 : 1.4).toFixed(2)}px`,
            );

            wrap.appendChild(n);
          }

          layer.appendChild(wrap);
        });
      }

      function buildSymbolRain(themeId = null, options = {}) {
        const opts = options && typeof options === "object" ? options : {};
        const forceStatic = Boolean(opts.forceStatic);
        if (!forceStatic && getAnimIntensityMode() === "ultra-low") return;
        const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];
        const activeTheme =
          String(
            themeId ||
              document.body?.getAttribute("data-theme") ||
              DEFAULT_SETTINGS.theme,
          ).trim() || DEFAULT_SETTINGS.theme;
        const mobileLike = PERF_PROFILE.isMobile || isNarrowViewport();
        if (
          forceStatic &&
          activeTheme === "hacker" &&
          (mobileLike || PERF_PROFILE.lite || PERF_PROFILE.ultraLite)
        ) {
          return;
        }
        if (
          !forceStatic &&
          (activeTheme === "glass" ||
            activeTheme === "luxury" ||
            activeTheme === "aurora" ||
            activeTheme === "soft" ||
            activeTheme === "material")
        ) {
          return;
        }

        const configs = [
          {
            selector: ".sym-glass",
            count: 34,
            chars: ["o", ".", "*"],
            size: [12, 22],
            alpha: [0.22, 0.52],
            dur: [6, 13],
            drift: [-42, 42],
          },
          {
            selector: ".sym-brutal",
            count: 30,
            chars: ["#", "+", "="],
            size: [11, 20],
            alpha: [0.2, 0.42],
            dur: [6, 12],
            drift: [-28, 28],
          },
          {
            selector: ".sym-luxury",
            count: 36,
            chars: ["*", ".", "+"],
            size: [10, 20],
            alpha: [0.2, 0.46],
            dur: [7, 15],
            drift: [-36, 36],
          },
          {
            selector: ".sym-hacker",
            count: 72,
            chars: ["0", "1"],
            size: [12, 18],
            alpha: [0.3, 0.7],
            dur: [2.8, 6.2],
            drift: [-18, 18],
          },
          {
            selector: ".sym-aurora",
            count: 32,
            chars: ["~", "+", "*"],
            size: [11, 20],
            alpha: [0.2, 0.48],
            dur: [6, 13],
            drift: [-40, 40],
          },
          {
            selector: ".sym-mono",
            count: 46,
            chars: ["|", ".", ":"],
            size: [10, 16],
            alpha: [0.18, 0.4],
            dur: [5, 10],
            drift: [-20, 20],
          },
          {
            selector: ".sym-soft",
            count: 34,
            chars: ["o", ".", "o"],
            size: [11, 20],
            alpha: [0.2, 0.42],
            dur: [7, 14],
            drift: [-38, 38],
          },
          {
            selector: ".sym-material",
            count: 34,
            chars: ["@", "o", "."],
            size: [11, 20],
            alpha: [0.2, 0.42],
            dur: [7, 14],
            drift: [-32, 32],
          },
          {
            selector: ".sym-frosted",
            count: 46,
            chars: ["*", ".", "*"],
            size: [9, 16],
            alpha: [0.24, 0.52],
            dur: [5, 10],
            drift: [-26, 26],
          },
          {
            selector: ".sym-editorial",
            count: 36,
            leaf: true,
            size: [11, 20],
            alpha: [0.22, 0.46],
            dur: [7, 14],
            drift: [-42, 42],
          },
          {
            selector: ".sym-mathlight",
            count: 42,
            chars: ["", "", "", "", "", "", "x", "y", "+", "="],
            size: [12, 20],
            alpha: [0.2, 0.44],
            dur: [6, 13],
            drift: [-34, 34],
          },
          {
            selector: ".sym-mathdark",
            count: 50,
            chars: [
              "",
              "",
              "",
              "",
              "",
              "",
              "",
              "x",
              "y",
              "z",
            ],
            size: [12, 22],
            alpha: [0.24, 0.56],
            dur: [5, 12],
            drift: [-40, 40],
          },
          {
            selector: ".sym-chemistrylight",
            count: 52,
            chars: [
              "H",
              "He",
              "Li",
              "C",
              "N",
              "O",
              "Na",
              "Cl",
              "K",
              "Ca",
              "Mg",
              "Fe",
              "Cu",
              "Zn",
              "Ag",
              "Au",
              "pH",
              "H2O",
              "CO2",
              "NH3",
              "CH4",
              "",
              "",
              "",
              "",
              "",
            ],
            size: [12, 22],
            alpha: [0.24, 0.56],
            dur: [5.5, 12.5],
            drift: [-34, 34],
          },
          {
            selector: ".sym-chemistrydark",
            count: 58,
            chars: [
              "H",
              "C",
              "N",
              "O",
              "F",
              "Na",
              "P",
              "S",
              "Cl",
              "K",
              "Ca",
              "Mn",
              "Fe",
              "Co",
              "Ni",
              "Cu",
              "Zn",
              "Br",
              "Ag",
              "Au",
              "Pt",
              "pH",
              "H2SO4",
              "NaOH",
              "HCl",
              "C6H6",
              "",
              "",
              "",
              "",
              "",
            ],
            size: [12, 23],
            alpha: [0.26, 0.62],
            dur: [5, 11.8],
            drift: [-38, 38],
          },
        ];

        configs.forEach((cfg) => {
          const cfgTheme = cfg.selector.replace(/^\.(sym)-/, "");
          if (cfgTheme !== activeTheme) return;

          const layer = document.querySelector(cfg.selector);
          if (!layer) return;
          if (layer.dataset.ready === "1") return;
          layer.dataset.ready = "1";
          const baseNodeCount = scaleEffectCount(cfg.count, 6);
          const staticScale =
            PERF_PROFILE.isMobile || isNarrowViewport() ? 0.42 : 0.58;
          const nodeCount = forceStatic
            ? Math.max(12, Math.round(baseNodeCount * staticScale))
            : baseNodeCount;
          const staticHackerChars = ["0", "1"];

          for (let i = 0; i < nodeCount; i++) {
            const node = document.createElement("span");
            node.className = cfg.leaf ? "symbol-node leaf" : "symbol-node";
            if (!cfg.leaf) {
              const charPool =
                forceStatic && cfgTheme === "hacker"
                  ? staticHackerChars
                  : cfg.chars;
              node.textContent = pick(charPool);
            }

            const size = rand(cfg.size[0], cfg.size[1]);
            const alpha = rand(cfg.alpha[0], cfg.alpha[1]);
            const dur = rand(cfg.dur[0], cfg.dur[1]);
            const y = rand(3, 92);
            const x = rand(0, 100);
            const drift = rand(cfg.drift[0], cfg.drift[1]);
            const rot = rand(-35, 35);

            node.style.setProperty("--y", `${y.toFixed(2)}%`);
            node.style.setProperty("--x", `${x.toFixed(2)}%`);
            node.style.setProperty("--size", `${size.toFixed(2)}px`);
            node.style.setProperty("--alpha", alpha.toFixed(2));
            node.style.setProperty("--dur", `${dur.toFixed(2)}s`);
            node.style.setProperty("--delay", `${(-rand(0, dur)).toFixed(2)}s`);
            node.style.setProperty("--drift", `${drift.toFixed(1)}px`);
            node.style.setProperty("--rot", `${rot.toFixed(1)}deg`);
            if (forceStatic) {
              node.style.top = `${y.toFixed(2)}%`;
              node.style.animation = "none";
              node.style.transform = `translate3d(0, 0, 0) rotate(${rot.toFixed(1)}deg)`;
            }

            layer.appendChild(node);
          }
        });
      }

      function getAcademicWeekStartMs(baseDate = new Date()) {
        const d = new Date(baseDate);
        d.setHours(0, 0, 0, 0);
        const dayOffset = (d.getDay() - 6 + 7) % 7; // week starts on Saturday
        d.setDate(d.getDate() - dayOffset);
        return d.getTime();
      }

      function sanitizeWeekType(week) {
        return week === "even" ? "even" : "odd";
      }
      const FIXED_WEEK_ANCHOR_TYPE = "even";
      const FIXED_WEEK_ANCHOR_MS = getAcademicWeekStartMs(
        new Date(2026, 1, 14, 0, 0, 0, 0),
      ); // Saturday, February 14, 2026 -> even week
      function getWeekTypeFromFixedAnchor(date = new Date()) {
        const ref = date instanceof Date ? date : new Date(date);
        if (Number.isNaN(ref.getTime())) return FIXED_WEEK_ANCHOR_TYPE;
        const refWeekMs = getAcademicWeekStartMs(ref);
        const diffWeeks = Math.floor(
          (refWeekMs - FIXED_WEEK_ANCHOR_MS) / 604800000,
        );
        const flipped = Math.abs(diffWeeks % 2) === 1;
        return flipped
          ? FIXED_WEEK_ANCHOR_TYPE === "odd"
            ? "even"
            : "odd"
          : FIXED_WEEK_ANCHOR_TYPE;
      }

      const TERM_MIN_NO = 1;
      const TERM_MAX_NO = 10;
      const DEFAULT_TERM_NO = 2;
      const TERM_STORE_SCHEMA_VERSION = 1;
      const STORAGE_BACKUP_MIN_GAP_MS = 18000;

      function normalizeLatinDigits(value) {
        return String(value || "")
          .replace(/[-]/g, (d) => String("".indexOf(d)))
          .replace(/[-]/g, (d) =>
            String("".indexOf(d)),
          );
      }

      function extractTermNumber(value) {
        const clean = normalizeLatinDigits(value).trim();
        if (!clean) return null;
        const match = clean.match(/(\d{1,2})/);
        if (!match) return null;
        const n = Number(match[1]);
        if (!Number.isFinite(n)) return null;
        if (n < TERM_MIN_NO || n > TERM_MAX_NO) return null;
        return n;
      }

      function normalizeTermNumber(value, fallback = DEFAULT_TERM_NO) {
        const n = extractTermNumber(value);
        if (n !== null) return n;
        const fb = Number(fallback);
        if (!Number.isFinite(fb)) return DEFAULT_TERM_NO;
        return Math.min(TERM_MAX_NO, Math.max(TERM_MIN_NO, Math.floor(fb)));
      }

      function getTermKey(termNo) {
        return `term-${normalizeTermNumber(termNo)}`;
      }

      function getTermLabel(termNo) {
        return ` ${normalizeTermNumber(termNo)}`;
      }

      const STORAGE_KEY = "uni_schedule_db";
      const STORAGE_BACKUP_KEY = "uni_schedule_db_backup";
      const GOOGLE_OAUTH_CLIENT_ID =
        String(window.__GOOGLE_CLIENT_ID__ || "").trim() ||
        "YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com";
      const CLOUD_SYNC_CLIENT_ID_KEY = "uni_schedule_cloud_client_id_v1";
      const CLOUD_SYNC_TOKEN_CACHE_KEY = "uni_schedule_cloud_token_cache_v1";
      const CLOUD_SYNC_META_KEY = "uni_schedule_cloud_sync_meta_v1";
      const CLOUD_SYNC_USER_KEY = "uni_schedule_cloud_sync_user_v1";
      const CLOUD_SYNC_DEVICE_KEY = "uni_schedule_cloud_sync_device_v1";
      const CLOUD_SYNC_PREFS_KEY = "uni_schedule_cloud_sync_prefs_v1";
      const CLOUD_SYNC_SIGNAL_KEY = "uni_schedule_cloud_sync_signal_v1";
      const CLOUD_SYNC_FILE_NAME = "uni_schedule_cloud_state_v1.json";
      const CLOUD_SYNC_SCHEMA_VERSION = 1;
      const CLOUD_SYNC_DEBOUNCE_MS = 420;
      const CLOUD_SYNC_UI_QUICK_DEBOUNCE_MS = 120;
      const CLOUD_SYNC_AUTO_INTERVAL_DESKTOP_MS = 4200;
      const CLOUD_SYNC_AUTO_INTERVAL_MOBILE_MS = 5600;
      const CLOUD_SYNC_AUTO_MIN_GAP_DESKTOP_MS = 900;
      const CLOUD_SYNC_AUTO_MIN_GAP_MOBILE_MS = 1200;
      const CLOUD_SYNC_AUTO_VISIBLE_BASE_INTERVAL_DESKTOP_MS = 1200;
      const CLOUD_SYNC_AUTO_VISIBLE_BASE_INTERVAL_MOBILE_MS = 1680;
      const CLOUD_SYNC_AUTO_VISIBLE_MIN_GAP_DESKTOP_MS = 420;
      const CLOUD_SYNC_AUTO_VISIBLE_MIN_GAP_MOBILE_MS = 620;
      const CLOUD_SYNC_FOREGROUND_MIN_GAP_MS = 900;
      const CLOUD_SYNC_DIRTY_GUARD_MS = 350;
      const CLOUD_SYNC_FAST_WINDOW_MS = 90000;
      const CLOUD_SYNC_FAST_INTERVAL_DESKTOP_MS = 1400;
      const CLOUD_SYNC_FAST_INTERVAL_MOBILE_MS = 1850;
      const CLOUD_SYNC_ERROR_BACKOFF_BASE_MS = 1400;
      const CLOUD_SYNC_ERROR_BACKOFF_MAX_MS = 18000;
      const CLOUD_SYNC_API_TIMEOUT_MS = 14000;
      const CLOUD_SYNC_API_TIMEOUT_SLOW_MS = 22000;
      const CLOUD_SYNC_API_RETRY_MAX = 2;
      const CLOUD_SYNC_API_RETRY_BASE_MS = 850;
      const CLOUD_SYNC_API_RETRY_JITTER_MS = 260;
      const CLOUD_SYNC_RECOVERY_MIN_MS = 1200;
      const CLOUD_SYNC_RECOVERY_MAX_MS = 20000;
      const CLOUD_SYNC_REMOTE_META_CACHE_MS = 280;
      const CLOUD_SYNC_ULTRA_WINDOW_MS = 32000;
      const CLOUD_SYNC_ULTRA_MAX_CONTINUOUS_MS = 150000;
      const CLOUD_SYNC_ULTRA_INTERVAL_DESKTOP_MS = 900;
      const CLOUD_SYNC_ULTRA_INTERVAL_MOBILE_MS = 1300;
      const CLOUD_SYNC_ULTRA_MIN_GAP_DESKTOP_MS = 320;
      const CLOUD_SYNC_ULTRA_MIN_GAP_MOBILE_MS = 520;
      const CLOUD_SYNC_ULTRA_IDLE_POLLS_LIMIT = 7;
      const CLOUD_SYNC_ULTRA_IDLE_COOLDOWN_MS = 45000;
      const CLOUD_SYNC_LOOP_RECALC_JITTER_MS = 120;
      const CLOUD_SYNC_REALTIME_BASE_INTERVAL_DESKTOP_MS = 760;
      const CLOUD_SYNC_REALTIME_BASE_INTERVAL_MOBILE_MS = 1040;
      const CLOUD_SYNC_HIDDEN_INTERVAL_DESKTOP_MS = 3600;
      const CLOUD_SYNC_HIDDEN_INTERVAL_MOBILE_MS = 5200;
      const CLOUD_SYNC_LOCAL_PUSH_DELAY_DESKTOP_MS = 45;
      const CLOUD_SYNC_LOCAL_PUSH_DELAY_MOBILE_MS = 70;
      const CLOUD_SYNC_UI_LOCAL_PUSH_DELAY_DESKTOP_MS = 24;
      const CLOUD_SYNC_UI_LOCAL_PUSH_DELAY_MOBILE_MS = 42;
      const CLOUD_SYNC_SIGNAL_BURST_MS = 22000;
      const CLOUD_SYNC_SIGNAL_BURST_INTERVAL_DESKTOP_MS = 620;
      const CLOUD_SYNC_SIGNAL_BURST_INTERVAL_MOBILE_MS = 860;
      const CLOUD_SYNC_SIGNAL_FOLLOWUP_FAST_MS = 70;
      const CLOUD_SYNC_SIGNAL_FOLLOWUP_MID_MS = 220;
      const CLOUD_SYNC_SIGNAL_FOLLOWUP_SLOW_MS = 540;
      const DEFAULT_SETTINGS = {
        week: getWeekTypeFromFixedAnchor(new Date()),
        weekAnchorType: FIXED_WEEK_ANCHOR_TYPE,
        weekAnchorMs: FIXED_WEEK_ANCHOR_MS,
        theme: "mathdark",
        stylePack: "base",
        anim: true,
        animIntensity: "high",
        uiMode: "auto",
        view: "grid",
        profileName: STR.name,
        profileTerm: getTermLabel(DEFAULT_TERM_NO),
        profileMajor: "",
        profileClassStartDate: "",
        attendanceReminderEnabled: true,
        attendanceReminderTime: "22:00",
        attendanceViewMode: "today",
        attendanceDefaultAbsenceLimit: 3,
        attendanceAllowPastEdit: false,
        attendanceActiveDate: "",
      };

      const app = {
        data: {
          classes: [],
          exams: [],
          notes: [],
          handouts: [],
          courseProgress: [],
          attendance: {},
          settings: { ...DEFAULT_SETTINGS },
          searchQuery: "",
          dismissedReminders: {},
          notifiedReminders: {},
          dismissedPinnedAlerts: {},
          attendanceReminderLog: {},
        },
        activeTermNo: DEFAULT_TERM_NO,
        termStore: {},
        notificationLoopId: null,
        notificationVisibilityBound: false,
        notificationCheckRunning: false,
        liveUiLoopId: null,
        liveUiVisibilityBound: false,
        responsiveRuntimeBound: false,
        viewportSyncRafId: 0,
        viewportResizeTimerId: 0,
        lastResponsiveMobileState: null,
        searchPersistTimerId: null,
        searchRenderRafId: null,
        refreshUiRafId: 0,
        deferredHeavyRenderTimerId: 0,
        deferredHeavyRenderIdleId: 0,
        deferredHeavyRenderPending: false,
        deferredHeavyRenderDueAt: 0,
        mobileScrollPerfBound: false,
        mobileScrollPerfTimerId: 0,
        mobileScrollPerfTickAt: 0,
        mobileUltraSmoothState: "off",
        mobilePendingRefresh: false,
        mobilePostScrollRafId: 0,
        mobileLiveTickAt: 0,
        swRegistration: null,
        swRegistrationChecked: false,
        swRegistrationLastAttemptMs: 0,
        swRegistrationError: "",
        notificationRuntimeBound: false,
        notifyLastCheckAt: 0,
        notifyLastTestAt: 0,
        notifyLastTestOk: false,
        manualWeekOverride: false,
        storageReady: null,
        storageIssue: "",
        storageProbeAt: 0,
        storageAlertAt: 0,
        persistWriteCount: 0,
        lastPersistPayload: "",
        lastPersistNoop: false,
        lastBackupPersistAt: 0,
        lastSerializedActiveTermNo: DEFAULT_TERM_NO,
        termPayloadCache: {},
        lastSessionRefreshKey: "",
        lastExamRefreshKey: "",

        escapeHtml(v) {
          return String(v ?? "").replace(/[&<>"']/g, (ch) => {
            const map = {
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            };
            return map[ch] || ch;
          });
        },

        normalizeTime(value, fallback) {
          const s = String(value || "");
          return /^([01]\d|2[0-3]):[0-5]\d$/.test(s) ? s : fallback;
        },

        normalizeDateKey(value) {
          const raw = String(value || "").trim();
          if (!raw) return "";
          const enDigits = raw
            .replace(/[-]/g, (d) =>
              String("".indexOf(d)),
            )
            .replace(/[-]/g, (d) =>
              String("".indexOf(d)),
            );
          const match = enDigits.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
          if (!match) return "";

          const y = Number(match[1]);
          const m = Number(match[2]);
          const d = Number(match[3]);
          if (!Number.isFinite(y) || !Number.isFinite(m) || !Number.isFinite(d))
            return "";
          if (m < 1 || m > 12 || d < 1 || d > 31) return "";

          const normalized = `${String(y).padStart(4, "0")}-${String(m).padStart(2, "0")}-${String(d).padStart(2, "0")}`;
          const dt = new Date(`${normalized}T00:00:00`);
          if (Number.isNaN(dt.getTime())) return "";
          if (
            dt.getFullYear() !== y ||
            dt.getMonth() + 1 !== m ||
            dt.getDate() !== d
          ) {
            return "";
          }
          return normalized;
        },

        toMinutes(hhmm) {
          const [h, m] = this.normalizeTime(hhmm, "00:00")
            .split(":")
            .map(Number);
          return h * 60 + m;
        },

        addMinutes(hhmm, minutes = CLASS_DURATION_MINUTES) {
          const base = this.toMinutes(this.normalizeTime(hhmm, "08:00"));
          const total = Math.min(base + minutes, 23 * 60 + 59);
          const hh = String(Math.floor(total / 60)).padStart(2, "0");
          const mm = String(total % 60).padStart(2, "0");
          return `${hh}:${mm}`;
        },

        getTermNo(value, fallback = DEFAULT_TERM_NO) {
          return normalizeTermNumber(value, fallback);
        },

        getActiveTermNo() {
          return this.getTermNo(this.activeTermNo, DEFAULT_TERM_NO);
        },

        getActiveTermLabel() {
          return getTermLabel(this.getActiveTermNo());
        },

        termExists(termNo) {
          const no = this.getTermNo(termNo, DEFAULT_TERM_NO);
          const store =
            this.termStore && typeof this.termStore === "object"
              ? this.termStore
              : {};
          return Boolean(store[getTermKey(no)]);
        },

        getExistingTermNumbers() {
          const store =
            this.termStore && typeof this.termStore === "object"
              ? this.termStore
              : {};
          const nums = Object.keys(store)
            .map((key) => extractTermNumber(key))
            .filter((n) => Number.isFinite(n))
            .map((n) => Number(n))
            .filter((n) => n >= TERM_MIN_NO && n <= TERM_MAX_NO);
          return Array.from(new Set(nums)).sort((a, b) => a - b);
        },

        normalizeTermDataForStore(rawData, termNo) {
          const targetNo = this.getTermNo(termNo, DEFAULT_TERM_NO);
          const normalized = this.normalizeData(rawData);
          if (!normalized.settings || typeof normalized.settings !== "object") {
            normalized.settings = { ...DEFAULT_SETTINGS };
          }
          normalized.settings.profileTerm = getTermLabel(targetNo);
          return normalized;
        },

        createNewTermData(termNo, sourceSettings = null) {
          const targetNo = this.getTermNo(termNo, DEFAULT_TERM_NO);
          const baseSettings =
            sourceSettings && typeof sourceSettings === "object"
              ? { ...sourceSettings }
              : { ...DEFAULT_SETTINGS };

          const payload = {
            classes: [],
            exams: [],
            notes: [],
            handouts: [],
            courseProgress: [],
            attendance: {},
            searchQuery: "",
            dismissedReminders: {},
            notifiedReminders: {},
            dismissedPinnedAlerts: {},
            attendanceReminderLog: {},
            settings: {
              ...baseSettings,
              profileTerm: getTermLabel(targetNo),
              profileClassStartDate: "",
            },
          };
          return this.normalizeTermDataForStore(payload, targetNo);
        },

        updateActiveTermStore() {
          const activeNo = this.getActiveTermNo();
          this.activeTermNo = activeNo;
          if (!this.termStore || typeof this.termStore !== "object") {
            this.termStore = {};
          }
          if (!this.data || typeof this.data !== "object") {
            this.data = this.createNewTermData(activeNo);
          }
          if (!this.data.settings || typeof this.data.settings !== "object") {
            this.data.settings = { ...DEFAULT_SETTINGS };
          }
          this.data.settings.profileTerm = getTermLabel(activeNo);
          this.termStore[getTermKey(activeNo)] = this.data;
        },

        buildTermStorePayload() {
          this.updateActiveTermStore();
          const out = {
            schemaVersion: TERM_STORE_SCHEMA_VERSION,
            activeTermNo: this.getActiveTermNo(),
            terms: {},
          };

          const store =
            this.termStore && typeof this.termStore === "object"
              ? this.termStore
              : {};
          Object.entries(store).forEach(([rawKey, value]) => {
            const termNo = extractTermNumber(rawKey);
            if (!Number.isFinite(termNo)) return;
            if (termNo < TERM_MIN_NO || termNo > TERM_MAX_NO) return;
            const termData =
              value && typeof value === "object"
                ? value
                : this.createNewTermData(termNo);
            if (!termData.settings || typeof termData.settings !== "object") {
              termData.settings = { ...DEFAULT_SETTINGS };
            }
            termData.settings.profileTerm = getTermLabel(termNo);
            out.terms[getTermKey(termNo)] = termData;
          });

          const defaultKey = getTermKey(DEFAULT_TERM_NO);
          if (!out.terms[defaultKey]) {
            out.terms[defaultKey] = this.normalizeTermDataForStore(
              null,
              DEFAULT_TERM_NO,
            );
          }

          const activeKey = getTermKey(out.activeTermNo);
          if (!out.terms[activeKey]) {
            out.activeTermNo = DEFAULT_TERM_NO;
          }
          return out;
        },

        buildTermStorePayloadJson() {
          this.updateActiveTermStore();
          if (
            !this.termPayloadCache ||
            typeof this.termPayloadCache !== "object"
          ) {
            this.termPayloadCache = {};
          }

          const store =
            this.termStore && typeof this.termStore === "object"
              ? this.termStore
              : {};
          const activeNo = this.getActiveTermNo();
          const termsByNo = new Map();

          Object.entries(store).forEach(([rawKey, value]) => {
            const termNo = extractTermNumber(rawKey);
            if (!Number.isFinite(termNo)) return;
            if (termNo < TERM_MIN_NO || termNo > TERM_MAX_NO) return;

            const key = getTermKey(termNo);
            const termData =
              value && typeof value === "object"
                ? value
                : this.createNewTermData(termNo);
            if (!termData.settings || typeof termData.settings !== "object") {
              termData.settings = { ...DEFAULT_SETTINGS };
            }
            termData.settings.profileTerm = getTermLabel(termNo);
            this.termStore[key] = termData;
            termsByNo.set(termNo, { key, data: termData });
          });

          if (!termsByNo.has(DEFAULT_TERM_NO)) {
            const key = getTermKey(DEFAULT_TERM_NO);
            const data = this.createNewTermData(DEFAULT_TERM_NO);
            this.termStore[key] = data;
            termsByNo.set(DEFAULT_TERM_NO, { key, data });
          }

          const sortedNos = Array.from(termsByNo.keys()).sort((a, b) => a - b);
          const validActiveNo = termsByNo.has(activeNo)
            ? activeNo
            : DEFAULT_TERM_NO;
          const previousActiveNo = this.getTermNo(
            this.lastSerializedActiveTermNo,
            validActiveNo,
          );
          const jsonParts = [];

          sortedNos.forEach((termNo) => {
            const entry = termsByNo.get(termNo);
            if (!entry) return;
            const key = entry.key;
            const data = entry.data;
            const cached = this.termPayloadCache[key];
            const mustReserialize =
              termNo === validActiveNo ||
              termNo === previousActiveNo ||
              !cached ||
              cached.ref !== data ||
              typeof cached.json !== "string" ||
              !cached.json;
            if (mustReserialize) {
              this.termPayloadCache[key] = {
                ref: data,
                json: JSON.stringify(data),
              };
            }
            jsonParts.push(
              `${JSON.stringify(key)}:${this.termPayloadCache[key].json}`,
            );
          });

          Object.keys(this.termPayloadCache).forEach((cacheKey) => {
            const cacheTermNo = extractTermNumber(cacheKey);
            if (!Number.isFinite(cacheTermNo) || !termsByNo.has(cacheTermNo)) {
              delete this.termPayloadCache[cacheKey];
            }
          });
          this.lastSerializedActiveTermNo = validActiveNo;

          return `{"schemaVersion":${TERM_STORE_SCHEMA_VERSION},"activeTermNo":${validActiveNo},"terms":{${jsonParts.join(",")}}}`;
        },

        normalizeTermStore(raw) {
          const payload = raw && typeof raw === "object" ? raw : {};
          const hasTermsWrapper =
            payload.terms &&
            typeof payload.terms === "object" &&
            !Array.isArray(payload.terms);

          const normalizedStore = {};
          if (hasTermsWrapper) {
            Object.entries(payload.terms).forEach(([rawKey, value]) => {
              const termNo = extractTermNumber(rawKey);
              if (!Number.isFinite(termNo)) return;
              if (termNo < TERM_MIN_NO || termNo > TERM_MAX_NO) return;
              normalizedStore[getTermKey(termNo)] =
                this.normalizeTermDataForStore(value, termNo);
            });
          } else {
            normalizedStore[getTermKey(DEFAULT_TERM_NO)] =
              this.normalizeTermDataForStore(payload, DEFAULT_TERM_NO);
          }

          const defaultKey = getTermKey(DEFAULT_TERM_NO);
          if (!normalizedStore[defaultKey]) {
            normalizedStore[defaultKey] = this.normalizeTermDataForStore(
              null,
              DEFAULT_TERM_NO,
            );
          }

          const activeHint = hasTermsWrapper
            ? (payload.activeTermNo ??
              payload.activeTerm ??
              payload.currentTerm)
            : payload?.settings?.profileTerm;
          let activeTermNo = this.getTermNo(activeHint, DEFAULT_TERM_NO);
          if (!normalizedStore[getTermKey(activeTermNo)]) {
            const existing = Object.keys(normalizedStore)
              .map((key) => extractTermNumber(key))
              .filter((n) => Number.isFinite(n));
            activeTermNo = existing.length
              ? Number(existing[0])
              : DEFAULT_TERM_NO;
          }

          return {
            schemaVersion: TERM_STORE_SCHEMA_VERSION,
            activeTermNo,
            terms: normalizedStore,
          };
        },

        loadTermStore(raw) {
          const normalized = this.normalizeTermStore(raw);
          this.termStore = normalized.terms;
          this.activeTermNo = this.getTermNo(
            normalized.activeTermNo,
            DEFAULT_TERM_NO,
          );
          const key = getTermKey(this.activeTermNo);
          if (!this.termStore[key]) {
            this.termStore[key] = this.createNewTermData(this.activeTermNo);
          }
          this.data = this.termStore[key];
          this.data.settings.profileTerm = getTermLabel(this.activeTermNo);
          this.lastSerializedActiveTermNo = this.activeTermNo;
          this.termPayloadCache = {};
        },

        switchTerm(termNo, opts = {}) {
          const options = opts && typeof opts === "object" ? opts : {};
          const targetNo = this.getTermNo(termNo, this.getActiveTermNo());
          const currentNo = this.getActiveTermNo();
          if (targetNo === currentNo) {
            return { ok: true, created: false, activeTermNo: currentNo };
          }

          this.updateActiveTermStore();
          const targetKey = getTermKey(targetNo);
          let created = false;
          if (!this.termStore[targetKey]) {
            if (!options.createIfMissing) {
              return { ok: false, created: false, reason: "missing-term" };
            }
            this.termStore[targetKey] = this.createNewTermData(
              targetNo,
              this.data?.settings || null,
            );
            created = true;
          }

          this.activeTermNo = targetNo;
          this.data = this.termStore[targetKey];
          this.data.settings.profileTerm = getTermLabel(targetNo);
          this.lastSessionRefreshKey = "";

          this.applyExternalData(this.data, { skipPersist: true });
          if (!options.silent) this.save();
          return { ok: true, created, activeTermNo: targetNo };
        },

        readFileAsDataUrl(file) {
          return new Promise((resolve, reject) => {
            if (!file) {
              resolve("");
              return;
            }
            const reader = new FileReader();
            reader.onload = () => {
              const out = String(reader.result || "");
              resolve(out);
            };
            reader.onerror = () => reject(new Error("file-read-failed"));
            reader.readAsDataURL(file);
          });
        },

        readFileAsText(file) {
          return new Promise((resolve, reject) => {
            if (!file) {
              resolve("");
              return;
            }
            const reader = new FileReader();
            reader.onload = () => resolve(String(reader.result || ""));
            reader.onerror = () => reject(new Error("file-read-failed"));
            reader.readAsText(file, "utf-8");
          });
        },

        normalizeUrl(url) {
          const raw = String(url || "").trim();
          if (!raw) return "";
          if (/^https?:\/\//i.test(raw) || /^data:/i.test(raw)) return raw;
          if (/^www\./i.test(raw)) return `https://${raw}`;
          if (/^[\w.-]+\.[a-z]{2,}(\/.*)?$/i.test(raw)) return `https://${raw}`;
          return raw;
        },

        normalizeCourseKey(name) {
          const raw = String(name || "")
            .replace(/[\u200c\u200d\u200e\u200f\ufeff]/g, " ")
            .replace(/[-]/g, (d) =>
              String("".indexOf(d)),
            )
            .replace(/[-]/g, (d) =>
              String("".indexOf(d)),
            )
            .replace(/[]/g, "")
            .replace(//g, "")
            .replace(/[]/g, "")
            .replace(/[\u064b-\u065f\u0670]/g, "");
          return raw.trim().replace(/\s+/g, " ").toLowerCase();
        },

        normalizeCourseSessionKey(name) {
          const base = this.normalizeCourseKey(name);
          if (!base) return "";
          return base.replace(/[^0-9a-z\u0600-\u06ff]+/gi, "");
        },

        sanitizeClassNoteByType(type, note) {
          const classType = String(type || "normal");
          if (classType === "odd" || classType === "even") return "";
          return String(note || "").trim();
        },

        normalizeSessionOffset(value) {
          return Math.max(0, Math.floor(Number(value) || 0));
        },

        findClassByCourseName(name, list = this.data.classes) {
          const key = this.normalizeCourseKey(name);
          if (!key) return null;
          const arr = Array.isArray(list) ? list : [];
          return (
            arr.find(
              (c) =>
                this.normalizeCourseKey(c?.name || c?.courseName || "") === key,
            ) || null
          );
        },

        getCourseNameByClassId(classId, list = this.data.classes) {
          const arr = Array.isArray(list) ? list : [];
          const id = Number(classId);
          const cls = arr.find((c) => Number(c.id) === id);
          return cls ? String(cls.name || cls.courseName || "").trim() : "";
        },

        getClassNameSuggestions(list = this.data.classes) {
          const arr = Array.isArray(list) ? list : [];
          const byKey = new Map();
          arr.forEach((c) => {
            const raw = String(c?.name || c?.courseName || "").trim();
            const key = this.normalizeCourseKey(raw);
            if (!raw || !key || byKey.has(key)) return;
            byKey.set(key, raw);
          });
          return Array.from(byKey.values()).sort((a, b) =>
            String(a).localeCompare(String(b), "fa"),
          );
        },

        getProfessorSuggestions(list = this.data.classes) {
          const arr = Array.isArray(list) ? list : [];
          const byKey = new Map();
          arr.forEach((c) => {
            const raw = String(c?.prof || "")
              .trim()
              .replace(/\s+/g, " ");
            if (!raw) return;
            const key = raw.toLowerCase();
            if (byKey.has(key)) return;
            byKey.set(key, raw);
          });
          return Array.from(byKey.values()).sort((a, b) =>
            String(a).localeCompare(String(b), "fa"),
          );
        },

        getUniqueCourses(list = this.data.classes) {
          const arr = Array.isArray(list) ? list : [];
          const byKey = new Map();
          arr.forEach((c) => {
            const name = String(c?.name || c?.courseName || "").trim();
            const key = this.normalizeCourseKey(name);
            if (!key) return;

            if (!byKey.has(key)) {
              byKey.set(key, {
                key,
                name,
                classId: Number(c.id),
                prof: String(c.prof || "").trim(),
              });
              return;
            }

            const prev = byKey.get(key);
            if (!prev.prof && c.prof) prev.prof = String(c.prof).trim();
          });

          return Array.from(byKey.values()).sort((a, b) =>
            a.name.localeCompare(b.name, "fa"),
          );
        },

        getDateKey(date = new Date()) {
          const ref = date instanceof Date ? date : new Date(date);
          if (Number.isNaN(ref.getTime())) return "";
          const y = String(ref.getFullYear()).padStart(4, "0");
          const m = String(ref.getMonth() + 1).padStart(2, "0");
          const d = String(ref.getDate()).padStart(2, "0");
          return `${y}-${m}-${d}`;
        },

        getDateFromKey(dateKey) {
          const clean = this.normalizeDateKey(dateKey);
          if (!clean) return null;
          const dt = new Date(`${clean}T00:00:00`);
          if (Number.isNaN(dt.getTime())) return null;
          return dt;
        },

        getDayIndexFromDate(date = new Date()) {
          const ref = date instanceof Date ? date : new Date(date);
          if (Number.isNaN(ref.getTime())) return 0;
          return (ref.getDay() + 1) % 7;
        },

        getAttendanceViewMode() {
          return this.data?.settings?.attendanceViewMode === "all"
            ? "all"
            : "today";
        },

        getAttendanceTargetDateKey() {
          const today = this.getDateKey(new Date());
          const allowPastEdit = Boolean(
            this.data?.settings?.attendanceAllowPastEdit,
          );
          if (!allowPastEdit) return today;
          const active = this.normalizeDateKey(
            this.data?.settings?.attendanceActiveDate,
          );
          return active || today;
        },

        canEditAttendanceDate(dateKey = this.getAttendanceTargetDateKey()) {
          const clean = this.normalizeDateKey(dateKey);
          if (!clean) return false;
          if (Boolean(this.data?.settings?.attendanceAllowPastEdit))
            return true;
          return clean === this.getDateKey(new Date());
        },

        getAttendanceRecord(courseKey, create = false, courseName = "") {
          const key = this.normalizeCourseKey(courseKey);
          if (!key) return null;
          if (
            !this.data.attendance ||
            typeof this.data.attendance !== "object"
          ) {
            this.data.attendance = {};
          }

          let record = this.data.attendance[key];
          if (record && typeof record === "object") {
            if (!record.logs || typeof record.logs !== "object")
              record.logs = {};
            if (!record.courseKey) record.courseKey = key;
            if (!("absenceLimit" in record)) record.absenceLimit = null;
          }

          if (!record && create) {
            record = {
              courseKey: key,
              courseName: String(courseName || "").trim(),
              absenceLimit: null,
              logs: {},
            };
            this.data.attendance[key] = record;
          }

          if (record && courseName && !String(record.courseName || "").trim()) {
            record.courseName = String(courseName || "").trim();
          }

          return record || null;
        },

        getAttendanceStatus(courseKey, dateKey) {
          const cleanDate = this.normalizeDateKey(dateKey);
          if (!cleanDate) return "";
          const record = this.getAttendanceRecord(courseKey, false);
          if (!record) return "";
          const status = String(record.logs?.[cleanDate] || "").trim();
          return status === "present" || status === "absent" ? status : "";
        },

        setAttendanceStatus(courseKey, dateKey, status, opts = {}) {
          const cleanDate = this.normalizeDateKey(
            dateKey || this.getAttendanceTargetDateKey(),
          );
          if (!cleanDate) return false;

          if (!this.canEditAttendanceDate(cleanDate) && !opts.force)
            return false;

          const normalizedStatus = String(status || "").trim();
          if (normalizedStatus !== "present" && normalizedStatus !== "absent") {
            return this.clearAttendanceStatus(courseKey, cleanDate, opts);
          }

          const record = this.getAttendanceRecord(
            courseKey,
            true,
            String(opts.courseName || "").trim(),
          );
          if (!record) return false;
          record.logs[cleanDate] = normalizedStatus;

          if (!opts.skipSave) this.save();
          return true;
        },

        clearAttendanceStatus(courseKey, dateKey, opts = {}) {
          const cleanDate = this.normalizeDateKey(
            dateKey || this.getAttendanceTargetDateKey(),
          );
          if (!cleanDate) return false;
          if (!this.canEditAttendanceDate(cleanDate) && !opts.force)
            return false;

          const key = this.normalizeCourseKey(courseKey);
          if (!key) return false;
          const record = this.getAttendanceRecord(key, false);
          if (!record) return false;

          delete record.logs[cleanDate];
          const hasLogs = Object.keys(record.logs || {}).length > 0;
          const hasLimit = Number(record.absenceLimit) > 0;
          if (!hasLogs && !hasLimit) {
            delete this.data.attendance[key];
          }

          if (!opts.skipSave) this.save();
          return true;
        },

        getCourseClassesOnDateByKey(courseKey, date = new Date()) {
          const key = this.normalizeCourseKey(courseKey);
          if (!key) return [];
          const refDate = date instanceof Date ? date : new Date(date);
          if (Number.isNaN(refDate.getTime())) return [];
          const dayIndex = this.getDayIndexFromDate(refDate);
          return this.getCourseClassesByKey(key).filter(
            (cls) =>
              Number(cls?.day) === dayIndex &&
              this.isClassActiveForDate(cls, refDate),
          );
        },

        getScheduledCoursesForDate(dateKey) {
          const cleanDate = this.normalizeDateKey(dateKey);
          const refDate = this.getDateFromKey(cleanDate);
          if (!cleanDate || !refDate) return [];

          return this.getUniqueCourses()
            .map((course) => {
              const dayClasses = this.getCourseClassesOnDateByKey(
                course.key,
                refDate,
              )
                .slice()
                .sort((a, b) =>
                  String(a.start || "").localeCompare(String(b.start || "")),
                );
              if (!dayClasses.length) return null;
              return {
                ...course,
                dayClasses,
                firstStart: String(dayClasses[0]?.start || ""),
              };
            })
            .filter(Boolean)
            .sort((a, b) => {
              const t = String(a.firstStart || "").localeCompare(
                String(b.firstStart || ""),
              );
              if (t !== 0) return t;
              return String(a.name || "").localeCompare(
                String(b.name || ""),
                "fa",
              );
            });
        },

        getAttendanceCountsByCourse(courseKey) {
          const record = this.getAttendanceRecord(courseKey, false);
          if (!record) return { present: 0, absent: 0, total: 0 };
          let present = 0;
          let absent = 0;
          Object.values(record.logs || {}).forEach((statusRaw) => {
            const status = String(statusRaw || "").trim();
            if (status === "present") present += 1;
            else if (status === "absent") absent += 1;
          });
          return {
            present,
            absent,
            total: present + absent,
          };
        },

        getAttendanceAbsenceLimit(courseKey) {
          const record = this.getAttendanceRecord(courseKey, false);
          const recordLimit = Number(record?.absenceLimit);
          if (Number.isFinite(recordLimit) && recordLimit > 0) {
            return Math.max(1, Math.min(30, Math.floor(recordLimit)));
          }

          const fallback = Number(
            this.data?.settings?.attendanceDefaultAbsenceLimit,
          );
          if (Number.isFinite(fallback) && fallback > 0) {
            return Math.max(1, Math.min(30, Math.floor(fallback)));
          }
          return DEFAULT_SETTINGS.attendanceDefaultAbsenceLimit;
        },

        setAttendanceAbsenceLimit(courseKey, limit, courseName = "") {
          const key = this.normalizeCourseKey(courseKey);
          if (!key) return;

          const parsed = Number(limit);
          const normalizedLimit =
            Number.isFinite(parsed) && parsed > 0
              ? Math.max(1, Math.min(30, Math.floor(parsed)))
              : null;

          const record = this.getAttendanceRecord(
            key,
            normalizedLimit !== null,
            courseName,
          );
          if (!record) return;

          if (normalizedLimit === null) {
            record.absenceLimit = null;
          } else {
            record.absenceLimit = normalizedLimit;
          }

          const hasLogs = Object.keys(record.logs || {}).length > 0;
          const hasLimit = Number(record.absenceLimit) > 0;
          if (!hasLogs && !hasLimit) delete this.data.attendance[key];
        },

        setAttendanceViewMode(mode, silent = false) {
          this.data.settings.attendanceViewMode =
            mode === "all" ? "all" : "today";
          if (!silent) this.save();
        },

        setAttendanceSettings(patch = {}, silent = false) {
          const settings = this.data.settings || (this.data.settings = {});
          if (
            Object.prototype.hasOwnProperty.call(patch, "attendanceViewMode")
          ) {
            settings.attendanceViewMode =
              patch.attendanceViewMode === "all" ? "all" : "today";
          }
          if (
            Object.prototype.hasOwnProperty.call(
              patch,
              "attendanceReminderEnabled",
            )
          ) {
            settings.attendanceReminderEnabled = Boolean(
              patch.attendanceReminderEnabled,
            );
          }
          if (
            Object.prototype.hasOwnProperty.call(
              patch,
              "attendanceReminderTime",
            )
          ) {
            settings.attendanceReminderTime = this.normalizeTime(
              patch.attendanceReminderTime,
              DEFAULT_SETTINGS.attendanceReminderTime,
            );
          }
          if (
            Object.prototype.hasOwnProperty.call(
              patch,
              "attendanceDefaultAbsenceLimit",
            )
          ) {
            const n = Number(patch.attendanceDefaultAbsenceLimit);
            settings.attendanceDefaultAbsenceLimit =
              Number.isFinite(n) && n > 0
                ? Math.max(1, Math.min(30, Math.floor(n)))
                : DEFAULT_SETTINGS.attendanceDefaultAbsenceLimit;
          }
          if (
            Object.prototype.hasOwnProperty.call(
              patch,
              "attendanceAllowPastEdit",
            )
          ) {
            settings.attendanceAllowPastEdit = Boolean(
              patch.attendanceAllowPastEdit,
            );
          }
          if (
            Object.prototype.hasOwnProperty.call(patch, "attendanceActiveDate")
          ) {
            settings.attendanceActiveDate = this.normalizeDateKey(
              patch.attendanceActiveDate,
            );
          }
          if (!settings.attendanceAllowPastEdit)
            settings.attendanceActiveDate = "";

          if (!silent) this.save();
        },

        getAttendanceMissingCourses(dateKey) {
          const cleanDate = this.normalizeDateKey(dateKey);
          if (!cleanDate) return [];
          return this.getScheduledCoursesForDate(cleanDate).filter((course) => {
            const status = this.getAttendanceStatus(course.key, cleanDate);
            return status !== "present" && status !== "absent";
          });
        },

        getAttendanceCourseCounts(courseKey) {
          const key = this.normalizeCourseKey(courseKey);
          if (!key) return { present: 0, absent: 0, total: 0 };
          const record = this.getAttendanceRecord(key, false);
          const logs =
            record?.logs && typeof record.logs === "object" ? record.logs : {};
          let present = 0;
          let absent = 0;
          Object.values(logs).forEach((rawStatus) => {
            const status = String(rawStatus || "").trim();
            if (status === "present") {
              present += 1;
              return;
            }
            if (status === "absent") absent += 1;
          });
          return { present, absent, total: present + absent };
        },

        isAttendanceCourseAtRisk(courseKey) {
          const key = this.normalizeCourseKey(courseKey);
          if (!key) return false;
          const { absent } = this.getAttendanceCourseCounts(key);
          const limit = this.getAttendanceAbsenceLimit(key);
          return Number(limit) > 1 && Number(absent) === Number(limit) - 1;
        },

        getAttendanceRiskCourses() {
          return this.getUniqueCourses().filter((course) => {
            const key = this.normalizeCourseKey(
              course?.key || course?.name || "",
            );
            if (!key) return false;
            return this.isAttendanceCourseAtRisk(key);
          });
        },

        getAttendanceKnownCourseMap() {
          const byKey = new Map();
          this.getUniqueCourses().forEach((course) => {
            const key = this.normalizeCourseKey(course?.key || course?.name);
            if (!key) return;
            byKey.set(key, String(course?.name || "").trim());
          });
          if (
            this.data.attendance &&
            typeof this.data.attendance === "object" &&
            !Array.isArray(this.data.attendance)
          ) {
            Object.entries(this.data.attendance).forEach(
              ([rawKey, rawValue]) => {
                const value =
                  rawValue && typeof rawValue === "object" ? rawValue : {};
                const key = this.normalizeCourseKey(
                  value.courseKey || value.courseName || rawKey,
                );
                if (!key) return;
                const name = String(
                  value.courseName || byKey.get(key) || "",
                ).trim();
                if (
                  !byKey.has(key) ||
                  (!String(byKey.get(key) || "").trim() && name)
                ) {
                  byKey.set(key, name);
                }
              },
            );
          }
          return byKey;
        },

        getAttendanceStatusSnapshot(dateKey, courseKeys = []) {
          const cleanDate = this.normalizeDateKey(
            dateKey || this.getAttendanceTargetDateKey(),
          );
          if (!cleanDate) return null;
          const knownMap = this.getAttendanceKnownCourseMap();
          const sourceKeys =
            Array.isArray(courseKeys) && courseKeys.length
              ? courseKeys
              : Array.from(knownMap.keys());
          const statuses = {};
          const courseNames = {};
          sourceKeys.forEach((rawKey) => {
            const key = this.normalizeCourseKey(rawKey);
            if (!key) return;
            const status = this.getAttendanceStatus(key, cleanDate);
            if (status === "present" || status === "absent") {
              statuses[key] = status;
            }
            const name = String(knownMap.get(key) || "").trim();
            if (name) courseNames[key] = name;
          });
          return {
            dateKey: cleanDate,
            statuses,
            courseNames,
          };
        },

        setAttendanceStatusesBulk(entries, dateKey, opts = {}) {
          const cleanDate = this.normalizeDateKey(
            dateKey || this.getAttendanceTargetDateKey(),
          );
          if (!cleanDate) return { changed: 0, applied: 0, denied: 0 };
          const list = Array.isArray(entries) ? entries : [];
          if (!list.length) return { changed: 0, applied: 0, denied: 0 };
          const force = Boolean(opts.force);
          const skipSave = Boolean(opts.skipSave);
          if (!this.canEditAttendanceDate(cleanDate) && !force) {
            return { changed: 0, applied: 0, denied: list.length };
          }

          let changed = 0;
          let applied = 0;
          list.forEach((item) => {
            if (!item || typeof item !== "object") return;
            const key = this.normalizeCourseKey(
              item.courseKey || item.key || item.courseName,
            );
            if (!key) return;
            const nextStatus = String(item.status || "").trim();
            const courseName = String(item.courseName || "").trim();
            const prevStatus = this.getAttendanceStatus(key, cleanDate);

            if (nextStatus === "present" || nextStatus === "absent") {
              if (prevStatus === nextStatus) {
                applied += 1;
                return;
              }
              const ok = this.setAttendanceStatus(key, cleanDate, nextStatus, {
                courseName,
                skipSave: true,
                force,
              });
              if (ok) {
                changed += 1;
                applied += 1;
              }
              return;
            }

            if (!prevStatus) {
              applied += 1;
              return;
            }
            const ok = this.clearAttendanceStatus(key, cleanDate, {
              skipSave: true,
              force,
            });
            if (ok) {
              changed += 1;
              applied += 1;
            }
          });

          if (changed > 0 && !skipSave) this.save();
          return { changed, applied, denied: 0 };
        },

        pruneAttendanceReminderLog(maxItems = 90) {
          if (
            !this.data.attendanceReminderLog ||
            typeof this.data.attendanceReminderLog !== "object"
          ) {
            this.data.attendanceReminderLog = {};
            return;
          }
          const keys = Object.keys(this.data.attendanceReminderLog)
            .map((x) => this.normalizeDateKey(x))
            .filter(Boolean)
            .sort()
            .slice(-Math.max(1, Number(maxItems) || 90));
          const compact = {};
          keys.forEach((key) => {
            const stamp = String(
              this.data.attendanceReminderLog[key] || "",
            ).trim();
            compact[key] = stamp || new Date().toISOString();
          });
          this.data.attendanceReminderLog = compact;
        },

        exportAttendanceBackup() {
          const payload = {
            exportedAt: new Date().toISOString(),
            version: 1,
            settings: {
              attendanceReminderEnabled: Boolean(
                this.data.settings?.attendanceReminderEnabled,
              ),
              attendanceReminderTime:
                this.normalizeTime(
                  this.data.settings?.attendanceReminderTime,
                  DEFAULT_SETTINGS.attendanceReminderTime,
                ) || DEFAULT_SETTINGS.attendanceReminderTime,
              attendanceViewMode: this.getAttendanceViewMode(),
              attendanceDefaultAbsenceLimit: this.getAttendanceAbsenceLimit(""),
              attendanceAllowPastEdit: Boolean(
                this.data.settings?.attendanceAllowPastEdit,
              ),
            },
            attendance: this.data.attendance || {},
          };
          const fileName = `attendance-backup-${this.getDateKey(new Date())}.json`;
          const blob = new Blob([JSON.stringify(payload, null, 2)], {
            type: "application/json;charset=utf-8",
          });
          const objectUrl = URL.createObjectURL(blob);
          const link = document.createElement("a");
          link.href = objectUrl;
          link.download = fileName;
          link.rel = "noopener";
          document.body.appendChild(link);
          link.click();
          window.setTimeout(() => {
            URL.revokeObjectURL(objectUrl);
            link.remove();
          }, 0);
        },

        downloadJsonPayloadFile(payload, fileName = "uni-schedule-data.json") {
          const jsonText = JSON.stringify(payload, null, 2);
          const blob = new Blob([jsonText], {
            type: "application/json;charset=utf-8",
          });
          const objectUrl = URL.createObjectURL(blob);
          const link = document.createElement("a");
          link.href = objectUrl;
          link.download = String(fileName || "uni-schedule-data.json").trim();
          link.rel = "noopener";
          document.body.appendChild(link);
          link.click();
          window.setTimeout(() => {
            URL.revokeObjectURL(objectUrl);
            link.remove();
          }, 0);
        },

        buildDataJsonPayload() {
          const termNo = this.getActiveTermNo();
          return {
            meta: {
              app: "uni-schedule",
              version: 2,
              mode: "full-snapshot",
              scope: "term",
              termNo,
              termLabel: getTermLabel(termNo),
              exportedAt: new Date().toISOString(),
            },
            data: this.data,
          };
        },

        exportDataJson() {
          const now = new Date();
          const hh = String(now.getHours()).padStart(2, "0");
          const mm = String(now.getMinutes()).padStart(2, "0");
          const termNo = this.getActiveTermNo();
          const fileName = `uni-schedule-term-${termNo}-${this.getDateKey(now)}-${hh}${mm}.json`;
          this.downloadJsonPayloadFile(this.buildDataJsonPayload(), fileName);
        },

        triggerJsonImport() {
          const input = document.getElementById("jsonImportInput");
          if (!input) return;
          input.value = "";
          input.click();
        },

        handleJsonImportInput(inputEl) {
          const file = inputEl?.files?.[0] || null;
          if (!file) return;
          this.importDataJsonFromFile(file).finally(() => {
            if (inputEl) inputEl.value = "";
          });
        },

        getEntityMergeId(item) {
          const id = Number(item?.id);
          return Number.isFinite(id) ? String(id) : "";
        },

        getEntityMergeSignature(entityName, rawItem) {
          const item =
            rawItem && typeof rawItem === "object"
              ? rawItem
              : Object.create(null);
          const normCourse = this.normalizeCourseKey(
            item.courseName || item.name || item.courseKey || "",
          );
          if (entityName === "classes") {
            return [
              normCourse,
              String(item.classNo || ""),
              String(item.prof || ""),
              Number(item.unit) || 0,
              Number(item.day) || 0,
              this.normalizeTime(item.start, "08:00"),
              this.normalizeTime(item.end, "09:30"),
              String(item.type || "normal"),
              String(item.note || ""),
              this.normalizeSessionOffset(item.sessionOffset),
              item.sessionOffsetManual ? "1" : "0",
            ].join("|");
          }
          if (entityName === "exams") {
            return [
              normCourse,
              String(item.title || "").trim(),
              this.normalizeDateKey(item.date),
              this.normalizeTime(item.time, "00:00"),
              String(item.location || "").trim(),
              this.normalizeDateKey(item.notifyDate),
              this.normalizeTime(item.notifyTime, ""),
              Number(item.notifyBeforeMin) || 0,
              String(item.notifyText || "").trim(),
              item.notifyEnabled ? "1" : "0",
            ].join("|");
          }
          if (entityName === "notes") {
            return [
              String(Number(item.classId) || 0),
              String(item.text || "").trim(),
              item.important ? "1" : "0",
              this.normalizeDateKey(item.alertDate),
              this.normalizeTime(item.alertTime, ""),
              Number(item.notifyBeforeMin) || 0,
              String(item.notifyText || "").trim(),
              item.notifyEnabled ? "1" : "0",
              String(item.createdAt || ""),
            ].join("|");
          }
          if (entityName === "handouts") {
            const attachmentData = String(item.attachmentData || "");
            return [
              normCourse,
              String(item.title || "").trim(),
              this.normalizeUrl(item.link),
              String(item.attachmentName || "").trim(),
              String(item.attachmentMime || "").trim(),
              String(item.attachmentType || "").trim(),
              attachmentData
                ? `${attachmentData.length}:${attachmentData.slice(0, 64)}`
                : "",
              String(item.note || "").trim(),
            ].join("|");
          }
          if (entityName === "courseProgress") {
            return [
              normCourse,
              String(item.taughtUntil || "").trim(),
              Number(item.coveragePercent) || 0,
              Number(item.sessionNo) || 0,
              String(item.nextTopic || "").trim(),
            ].join("|");
          }
          return JSON.stringify(item);
        },

        mergeEntityArray(entityName, currentList, incomingList, options = {}) {
          const opts = options && typeof options === "object" ? options : {};
          const mirrorMissing = Boolean(opts.mirrorMissing);
          const base = Array.isArray(currentList)
            ? currentList
                .filter((x) => x && typeof x === "object")
                .map((x) => ({ ...x }))
            : [];
          const incoming = Array.isArray(incomingList)
            ? incomingList
                .filter((x) => x && typeof x === "object")
                .map((x) => ({ ...x }))
            : [];

          const byId = new Map();
          const bySig = new Map();
          const usedNumericIds = new Set();
          base.forEach((item, idx) => {
            const id = this.getEntityMergeId(item);
            if (id) {
              byId.set(id, idx);
              const n = Number(id);
              if (Number.isFinite(n)) usedNumericIds.add(n);
            }
            const sig = this.getEntityMergeSignature(entityName, item);
            if (sig && !bySig.has(sig)) bySig.set(sig, idx);
          });

          const createId = () => {
            let seed = Date.now();
            while (usedNumericIds.has(seed)) seed += 1;
            usedNumericIds.add(seed);
            return seed;
          };

          const stats = { added: 0, updated: 0, skipped: 0, removed: 0 };
          incoming.forEach((raw) => {
            const item = { ...raw };
            const sig = this.getEntityMergeSignature(entityName, item);
            if (sig && bySig.has(sig)) {
              stats.skipped += 1;
              return;
            }

            const id = this.getEntityMergeId(item);
            if (id && byId.has(id)) {
              const idx = byId.get(id);
              const prev = base[idx] || {};
              const prevSig = this.getEntityMergeSignature(entityName, prev);
              if (prevSig === sig) {
                stats.skipped += 1;
                return;
              }
              base[idx] = item;
              if (prevSig) bySig.delete(prevSig);
              if (sig) bySig.set(sig, idx);
              stats.updated += 1;
              return;
            }

            if (!id || byId.has(id)) {
              item.id = createId();
            } else {
              const n = Number(id);
              if (Number.isFinite(n)) usedNumericIds.add(n);
            }
            const nextIdx = base.push(item) - 1;
            byId.set(this.getEntityMergeId(item), nextIdx);
            if (sig) bySig.set(sig, nextIdx);
            stats.added += 1;
          });

          if (mirrorMissing) {
            if (incoming.length === 0) {
              stats.removed += base.length;
              return { list: [], stats };
            }
            const incomingIds = new Set(
              incoming.map((x) => this.getEntityMergeId(x)).filter(Boolean),
            );
            const kept = [];
            base.forEach((item) => {
              const id = this.getEntityMergeId(item);
              if (id && incomingIds.has(id)) kept.push(item);
              else stats.removed += 1;
            });
            return { list: kept, stats };
          }

          return { list: base, stats };
        },

        mergeBooleanMap(currentMap, incomingMap, mirror = false) {
          if (mirror) {
            const result = {};
            Object.entries(
              incomingMap && typeof incomingMap === "object" ? incomingMap : {},
            ).forEach(([key, val]) => {
              if (Boolean(val)) result[String(key || "").trim()] = true;
            });
            return { map: result, changed: Object.keys(result).length };
          }
          const base =
            currentMap && typeof currentMap === "object"
              ? { ...currentMap }
              : {};
          let changed = 0;
          Object.entries(
            incomingMap && typeof incomingMap === "object" ? incomingMap : {},
          ).forEach(([key, val]) => {
            const clean = String(key || "").trim();
            if (!clean || !Boolean(val) || base[clean]) return;
            base[clean] = true;
            changed += 1;
          });
          return { map: base, changed };
        },

        mergeStringMap(currentMap, incomingMap, mirror = false) {
          if (mirror) {
            const result = {};
            Object.entries(
              incomingMap && typeof incomingMap === "object" ? incomingMap : {},
            ).forEach(([key, val]) => {
              const clean = String(key || "").trim();
              if (!clean) return;
              result[clean] = String(val || "").trim();
            });
            return { map: result, changed: Object.keys(result).length };
          }
          const base =
            currentMap && typeof currentMap === "object"
              ? { ...currentMap }
              : {};
          let changed = 0;
          Object.entries(
            incomingMap && typeof incomingMap === "object" ? incomingMap : {},
          ).forEach(([key, val]) => {
            const clean = String(key || "").trim();
            if (!clean) return;
            const nextVal = String(val || "").trim();
            if (!base[clean]) {
              base[clean] = nextVal;
              changed += 1;
              return;
            }
            if (!nextVal || base[clean] === nextVal) return;
            const prevMs = new Date(base[clean]).getTime();
            const nextMs = new Date(nextVal).getTime();
            if (
              Number.isFinite(nextMs) &&
              (!Number.isFinite(prevMs) || nextMs > prevMs)
            ) {
              base[clean] = nextVal;
              changed += 1;
            }
          });
          return { map: base, changed };
        },

        mergeAttendanceRecords(
          currentAttendance,
          incomingAttendance,
          mirror = false,
        ) {
          const cloneRecord = (record) => {
            const src = record && typeof record === "object" ? record : {};
            const logsSource =
              src.logs && typeof src.logs === "object" ? src.logs : {};
            const logs = {};
            Object.entries(logsSource).forEach(([dateKey, status]) => {
              const cleanDate = this.normalizeDateKey(dateKey);
              if (!cleanDate) return;
              if (status !== "present" && status !== "absent") return;
              logs[cleanDate] = status;
            });
            return {
              courseKey: String(src.courseKey || "").trim(),
              courseName: String(src.courseName || "").trim(),
              absenceLimit:
                src.absenceLimit === null
                  ? null
                  : Number.isFinite(Number(src.absenceLimit))
                    ? Math.max(
                        1,
                        Math.min(30, Math.floor(Number(src.absenceLimit))),
                      )
                    : null,
              logs,
            };
          };

          const srcMap =
            incomingAttendance && typeof incomingAttendance === "object"
              ? incomingAttendance
              : {};
          if (mirror) {
            const mirrored = {};
            Object.entries(srcMap).forEach(([key, record]) => {
              const courseKey = this.normalizeCourseKey(key);
              if (!courseKey) return;
              mirrored[courseKey] = cloneRecord(record);
              if (!mirrored[courseKey].courseKey)
                mirrored[courseKey].courseKey = courseKey;
            });
            return {
              map: mirrored,
              stats: {
                coursesAdded: Object.keys(mirrored).length,
                coursesUpdated: 0,
                logsAdded: 0,
                logsUpdated: 0,
              },
            };
          }

          const base =
            currentAttendance && typeof currentAttendance === "object"
              ? { ...currentAttendance }
              : {};
          const stats = {
            coursesAdded: 0,
            coursesUpdated: 0,
            logsAdded: 0,
            logsUpdated: 0,
          };

          Object.entries(srcMap).forEach(([rawKey, rawRecord]) => {
            const courseKey = this.normalizeCourseKey(rawKey);
            if (!courseKey) return;
            const nextRecord = cloneRecord(rawRecord);
            if (!nextRecord.courseKey) nextRecord.courseKey = courseKey;

            const prevRecord =
              base[courseKey] && typeof base[courseKey] === "object"
                ? cloneRecord(base[courseKey])
                : null;
            if (!prevRecord) {
              base[courseKey] = nextRecord;
              stats.coursesAdded += 1;
              stats.logsAdded += Object.keys(nextRecord.logs || {}).length;
              return;
            }

            let touched = false;
            if (
              nextRecord.courseName &&
              nextRecord.courseName !== prevRecord.courseName
            ) {
              prevRecord.courseName = nextRecord.courseName;
              touched = true;
            }
            if (
              nextRecord.absenceLimit !== null &&
              nextRecord.absenceLimit !== prevRecord.absenceLimit
            ) {
              prevRecord.absenceLimit = nextRecord.absenceLimit;
              touched = true;
            }

            Object.entries(nextRecord.logs || {}).forEach(
              ([dateKey, status]) => {
                if (!prevRecord.logs[dateKey]) {
                  prevRecord.logs[dateKey] = status;
                  stats.logsAdded += 1;
                  touched = true;
                  return;
                }
                if (prevRecord.logs[dateKey] !== status) {
                  prevRecord.logs[dateKey] = status;
                  stats.logsUpdated += 1;
                  touched = true;
                }
              },
            );

            if (touched) {
              base[courseKey] = prevRecord;
              stats.coursesUpdated += 1;
            }
          });

          return { map: base, stats };
        },

        mergeImportedData(rawIncomingData, options = {}) {
          const opts = options && typeof options === "object" ? options : {};
          const mirrorMissing = Boolean(opts.mirrorMissing);
          const current = this.normalizeData(this.data);
          const incoming = this.normalizeData(rawIncomingData);

          const mergedClasses = this.mergeEntityArray(
            "classes",
            current.classes,
            incoming.classes,
            { mirrorMissing },
          );
          const mergedExams = this.mergeEntityArray(
            "exams",
            current.exams,
            incoming.exams,
            { mirrorMissing },
          );
          const mergedNotes = this.mergeEntityArray(
            "notes",
            current.notes,
            incoming.notes,
            { mirrorMissing },
          );
          const mergedHandouts = this.mergeEntityArray(
            "handouts",
            current.handouts,
            incoming.handouts,
            { mirrorMissing },
          );
          const mergedProgress = this.mergeEntityArray(
            "courseProgress",
            current.courseProgress,
            incoming.courseProgress,
            { mirrorMissing },
          );
          const mergedAttendance = this.mergeAttendanceRecords(
            current.attendance,
            incoming.attendance,
            mirrorMissing,
          );
          const mergedDismissed = this.mergeBooleanMap(
            current.dismissedReminders,
            incoming.dismissedReminders,
            mirrorMissing,
          );
          const mergedNotified = this.mergeStringMap(
            current.notifiedReminders,
            incoming.notifiedReminders,
            mirrorMissing,
          );
          const mergedPinned = this.mergeStringMap(
            current.dismissedPinnedAlerts,
            incoming.dismissedPinnedAlerts,
            mirrorMissing,
          );
          const mergedAttendanceLog = this.mergeStringMap(
            current.attendanceReminderLog,
            incoming.attendanceReminderLog,
            mirrorMissing,
          );

          const provisional = {
            ...current,
            classes: mergedClasses.list,
            exams: mergedExams.list,
            notes: mergedNotes.list,
            handouts: mergedHandouts.list,
            courseProgress: mergedProgress.list,
            attendance: mergedAttendance.map,
            settings: mirrorMissing
              ? { ...incoming.settings }
              : { ...current.settings, ...incoming.settings },
            searchQuery: mirrorMissing
              ? String(incoming.searchQuery || "").toLowerCase()
              : String(
                  incoming.searchQuery || current.searchQuery || "",
                ).toLowerCase(),
            dismissedReminders: mergedDismissed.map,
            notifiedReminders: mergedNotified.map,
            dismissedPinnedAlerts: mergedPinned.map,
            attendanceReminderLog: mergedAttendanceLog.map,
          };
          const nextData = this.normalizeData(provisional);
          const stats = {
            classes: mergedClasses.stats,
            exams: mergedExams.stats,
            notes: mergedNotes.stats,
            handouts: mergedHandouts.stats,
            courseProgress: mergedProgress.stats,
            attendance: mergedAttendance.stats,
            reminders: mergedDismissed.changed,
            notified: mergedNotified.changed,
            pinned: mergedPinned.changed,
            attendanceLog: mergedAttendanceLog.changed,
          };
          return {
            data: nextData,
            stats,
            mode: mirrorMissing ? "mirror" : "merge",
          };
        },

        async importDataJsonFromFile(file) {
          let rawText = "";
          try {
            rawText = await this.readFileAsText(file);
          } catch {
            alert(STR.dataImportReadFailed);
            return false;
          }
          const cleanText = String(rawText || "").trim();
          if (!cleanText) {
            alert(STR.dataImportInvalid);
            return false;
          }

          let parsed = null;
          try {
            parsed = JSON.parse(cleanText);
          } catch {
            alert(STR.dataImportParseFailed);
            return false;
          }
          if (!parsed || typeof parsed !== "object") {
            alert(STR.dataImportInvalid);
            return false;
          }

          const hasDataWrapper =
            parsed.data &&
            typeof parsed.data === "object" &&
            !Array.isArray(parsed.data);
          const sourceRaw = hasDataWrapper ? parsed.data : parsed;
          if (!sourceRaw || typeof sourceRaw !== "object") {
            alert(STR.dataImportInvalid);
            return false;
          }
          const mirrorMissing =
            hasDataWrapper &&
            String(parsed?.meta?.app || "")
              .trim()
              .toLowerCase() === "uni-schedule" &&
            String(parsed?.meta?.mode || "")
              .trim()
              .toLowerCase() === "full-snapshot";

          const requestedTermNo = this.getTermNo(
            parsed?.meta?.termNo,
            this.getActiveTermNo(),
          );
          if (requestedTermNo !== this.getActiveTermNo()) {
            const switched = this.switchTerm(requestedTermNo, {
              createIfMissing: true,
              silent: true,
            });
            if (!switched.ok) {
              alert(STR.profileTermSwitchFailed);
              return false;
            }
          }

          const result = this.mergeImportedData(sourceRaw, { mirrorMissing });
          if (!result || !result.data) {
            alert(STR.dataImportInvalid);
            return false;
          }

          this.applyExternalData(result.data, { skipPersist: true });
          const ok = this.save();
          if (!ok) return false;

          const formatRow = (label, st) =>
            `${label}: +${st.added} | ${st.updated} | =${st.skipped}${st.removed ? ` | -${st.removed}` : ""}`;
          const lines = [
            `${STR.profileTermLabel}: ${this.getActiveTermLabel()}`,
            `${STR.dataImportDone} (${result.mode === "mirror" ? STR.dataImportModeMirror : STR.dataImportModeMerge})`,
            formatRow("Classes", result.stats.classes),
            formatRow("Exams", result.stats.exams),
            formatRow("Notes", result.stats.notes),
            formatRow("Handouts", result.stats.handouts),
            formatRow("Progress", result.stats.courseProgress),
            `Attendance: +${result.stats.attendance.coursesAdded}  | ${result.stats.attendance.coursesUpdated}  | +${result.stats.attendance.logsAdded}  | ${result.stats.attendance.logsUpdated} `,
          ];
          alert(lines.join("\n"));
          return true;
        },

        normalizeData(raw) {
          const normalized = {
            classes: [...DEFAULT_CLASSES],
            exams: [],
            notes: [],
            handouts: [],
            courseProgress: [],
            attendance: {},
            settings: { ...DEFAULT_SETTINGS },
            searchQuery: "",
            dismissedReminders: {},
            notifiedReminders: {},
            dismissedPinnedAlerts: {},
            attendanceReminderLog: {},
          };
          const source = raw && typeof raw === "object" ? raw : {};

          const validThemeIds = new Set(THEMES.map((t) => t.id));
          const validTypes = new Set(["normal", "odd", "even"]);

          const sourceClasses = Array.isArray(source.classes)
            ? source.classes
            : DEFAULT_CLASSES;
          normalized.classes = sourceClasses
            .filter((c) => c && typeof c === "object")
            .map((c, idx) => {
              const start = this.normalizeTime(c.start, "08:00");
              const end = this.addMinutes(start, CLASS_DURATION_MINUTES);
              const classType = validTypes.has(c.type) ? c.type : "normal";
              return {
                id: Number.isFinite(Number(c.id))
                  ? Number(c.id)
                  : Date.now() + idx,
                name: String(c.name || "").trim() || STR.course,
                classNo: String(c.classNo || c.classNumber || "").trim(),
                prof: String(c.prof || ""),
                unit: Number.isFinite(Number(c.unit)) ? Number(c.unit) : 0,
                day: Math.min(5, Math.max(0, Number(c.day) || 0)),
                start,
                end,
                type: classType,
                note: this.sanitizeClassNoteByType(classType, c.note),
                sessionOffset: this.normalizeSessionOffset(c.sessionOffset),
                sessionOffsetManual:
                  Boolean(c.sessionOffsetManual) &&
                  this.normalizeSessionOffset(c.sessionOffset) > 0,
              };
            });
          normalized.classes = normalized.classes.filter((c) => {
            const prof = String(c.prof || "").trim();
            const name = String(c.name || "").trim();
            const isLegacyParviziDefault =
              prof ===
                "\u0627\u0633\u062a\u0627\u062f \u067e\u0631\u0648\u06cc\u0632\u06cc" &&
              name ===
                "\u0645\u0628\u0627\u0646\u06cc \u0639\u0644\u0648\u0645 \u0631\u06cc\u0627\u0636\u06cc 2" &&
              Number(c.day) === 4 &&
              String(c.start) === "12:00" &&
              String(c.end) === "14:00";
            const isParviziPracticeClass =
              prof.includes(
                "\u0627\u0633\u062a\u0627\u062f \u067e\u0631\u0648\u06cc\u0632\u06cc",
              ) && /\u062d\u0644\s*\u062a\u0645\u0631\u06cc\u0646/.test(name);
            return !isLegacyParviziDefault && !isParviziPracticeClass;
          });

          if (Array.isArray(source.exams)) {
            normalized.exams = source.exams
              .filter((e) => e && typeof e === "object")
              .map((e, idx) => {
                const fallbackName = this.getCourseNameByClassId(
                  e.classId,
                  normalized.classes,
                );
                const rawCourseName = String(
                  e.courseName || fallbackName || "",
                ).trim();
                const matchedClass = this.findClassByCourseName(
                  rawCourseName,
                  normalized.classes,
                );
                return {
                  id: Number.isFinite(Number(e.id))
                    ? Number(e.id)
                    : Date.now() + idx,
                  classId: matchedClass
                    ? Number(matchedClass.id)
                    : Number.isFinite(Number(e.classId))
                      ? Number(e.classId)
                      : null,
                  courseName: matchedClass
                    ? String(matchedClass.name || rawCourseName).trim()
                    : rawCourseName,
                  title: String(e.title || "").trim(),
                  date:
                    typeof e.date === "string" &&
                    /^\d{4}-\d{2}-\d{2}$/.test(e.date)
                      ? e.date
                      : "",
                  time: this.normalizeTime(e.time, "09:00"),
                  location: String(e.location || ""),
                  notifyDate: this.normalizeDateKey(e.notifyDate),
                  notifyTime: this.normalizeTime(e.notifyTime, ""),
                  notifyBeforeMin: NOTIFY_BEFORE_OPTIONS.includes(
                    Number(e.notifyBeforeMin),
                  )
                    ? Number(e.notifyBeforeMin)
                    : 0,
                  notifyText: String(e.notifyText || "").trim(),
                  notifyEnabled:
                    typeof e.notifyEnabled === "boolean"
                      ? e.notifyEnabled
                      : true,
                  lastNotifiedSignature: String(e.lastNotifiedSignature || ""),
                  lastNotifiedAt: String(e.lastNotifiedAt || ""),
                };
              });
          }

          if (Array.isArray(source.notes)) {
            normalized.notes = source.notes
              .filter((n) => n && typeof n === "object")
              .map((n, idx) => {
                const important = Boolean(n.important);
                return {
                  id: Number.isFinite(Number(n.id))
                    ? Number(n.id)
                    : Date.now() + idx,
                  classId: Number.isFinite(Number(n.classId))
                    ? Number(n.classId)
                    : null,
                  text: String(n.text || "").trim(),
                  important,
                  createdAt: String(n.createdAt || new Date().toISOString()),
                  alertDate:
                    important &&
                    typeof n.alertDate === "string" &&
                    /^\d{4}-\d{2}-\d{2}$/.test(n.alertDate)
                      ? n.alertDate
                      : "",
                  alertTime: important
                    ? this.normalizeTime(n.alertTime, "")
                    : "",
                  notifyBeforeMin:
                    important &&
                    NOTIFY_BEFORE_OPTIONS.includes(Number(n.notifyBeforeMin))
                      ? Number(n.notifyBeforeMin)
                      : 0,
                  notifyText: important
                    ? String(n.notifyText || "").trim()
                    : "",
                  notifyEnabled: important
                    ? typeof n.notifyEnabled === "boolean"
                      ? n.notifyEnabled
                      : true
                    : false,
                  lastNotifiedSignature: String(n.lastNotifiedSignature || ""),
                  lastNotifiedAt: String(n.lastNotifiedAt || ""),
                };
              })
              .filter((n) => n.text);
          }

          if (Array.isArray(source.handouts)) {
            const nowIso = new Date().toISOString();
            normalized.handouts = source.handouts
              .filter((h) => h && typeof h === "object")
              .map((h, idx) => {
                const fallbackName = this.getCourseNameByClassId(
                  h.classId,
                  normalized.classes,
                );
                const rawCourseName = String(
                  h.courseName || fallbackName || "",
                ).trim();
                const matchedClass = this.findClassByCourseName(
                  rawCourseName,
                  normalized.classes,
                );
                const courseName = matchedClass
                  ? String(matchedClass.name || rawCourseName).trim()
                  : rawCourseName;
                const courseKey = this.normalizeCourseKey(courseName);
                const link = String(h.link || "").trim();
                const rawData = String(h.attachmentData || "").trim();
                const attachmentData =
                  rawData.startsWith("data:") &&
                  rawData.length <= HANDOUT_MAX_DATAURL_LEN
                    ? rawData
                    : "";
                const attachmentType =
                  h.attachmentType === "image"
                    ? "image"
                    : h.attachmentType === "file"
                      ? "file"
                      : "";

                return {
                  id: Number.isFinite(Number(h.id))
                    ? Number(h.id)
                    : Date.now() + idx,
                  classId: matchedClass ? Number(matchedClass.id) : null,
                  courseKey,
                  courseName,
                  title: String(h.title || "").trim(),
                  link,
                  attachmentType: attachmentData ? attachmentType : "",
                  attachmentName: String(h.attachmentName || "").trim(),
                  attachmentMime: String(h.attachmentMime || "").trim(),
                  attachmentData,
                  note: String(h.note || "").trim(),
                  createdAt: String(h.createdAt || nowIso),
                  updatedAt: String(h.updatedAt || nowIso),
                };
              })
              .filter(
                (h) =>
                  h.courseKey &&
                  h.title &&
                  (h.link || h.attachmentData || h.note),
              );
          }

          if (Array.isArray(source.courseProgress)) {
            const candidateProgress = source.courseProgress
              .filter((p) => p && typeof p === "object")
              .map((p, idx) => ({
                id: Number.isFinite(Number(p.id))
                  ? Number(p.id)
                  : Date.now() + idx,
                classId: Number.isFinite(Number(p.classId))
                  ? Number(p.classId)
                  : null,
                courseName: String(p.courseName || "").trim(),
                taughtUntil: String(p.taughtUntil || "").trim(),
                coveragePercent: Math.min(
                  100,
                  Math.max(0, Number(p.coveragePercent) || 0),
                ),
                sessionNo: Math.max(0, Math.floor(Number(p.sessionNo) || 0)),
                nextTopic: String(p.nextTopic || "").trim(),
                updatedAt: String(p.updatedAt || new Date().toISOString()),
              }));

            const byCourse = new Map();
            candidateProgress.forEach((p) => {
              const fallbackName = this.getCourseNameByClassId(
                p.classId,
                normalized.classes,
              );
              const courseName = String(
                p.courseName || fallbackName || "",
              ).trim();
              const key = this.normalizeCourseKey(courseName);
              if (!key) return;

              const matchedClass = this.findClassByCourseName(
                courseName,
                normalized.classes,
              );
              const next = {
                ...p,
                classId: matchedClass ? Number(matchedClass.id) : null,
                courseName: matchedClass
                  ? String(matchedClass.name || "").trim()
                  : courseName,
              };

              const prev = byCourse.get(key);
              if (!prev) {
                byCourse.set(key, next);
                return;
              }

              const prevTs = new Date(prev.updatedAt || "").getTime();
              const nextTs = new Date(next.updatedAt || "").getTime();
              if (
                Number.isFinite(nextTs) &&
                (!Number.isFinite(prevTs) || nextTs > prevTs)
              ) {
                byCourse.set(key, next);
              }
            });

            normalized.courseProgress = Array.from(byCourse.values());
          }

          if (source.attendance && typeof source.attendance === "object") {
            Object.entries(source.attendance).forEach(([rawKey, value]) => {
              if (!value || typeof value !== "object") return;
              const fallbackName = String(
                value.courseName || rawKey || "",
              ).trim();
              const key = this.normalizeCourseKey(fallbackName || rawKey);
              if (!key) return;

              const matchedClass = this.findClassByCourseName(
                fallbackName,
                normalized.classes,
              );
              const courseName = matchedClass
                ? String(matchedClass.name || fallbackName).trim()
                : fallbackName || String(rawKey || "").trim();

              const limitRaw = Number(value.absenceLimit);
              const absenceLimit =
                Number.isFinite(limitRaw) && limitRaw > 0
                  ? Math.max(1, Math.min(30, Math.floor(limitRaw)))
                  : null;

              const prev = normalized.attendance[key] || {
                courseKey: key,
                courseName,
                absenceLimit: null,
                logs: {},
              };

              const logsSource =
                value.logs && typeof value.logs === "object" ? value.logs : {};
              Object.entries(logsSource).forEach(([dateKey, statusRaw]) => {
                const cleanDate = this.normalizeDateKey(dateKey);
                if (!cleanDate) return;
                const status = String(statusRaw || "").trim();
                if (status !== "present" && status !== "absent") return;
                prev.logs[cleanDate] = status;
              });

              if (absenceLimit !== null) prev.absenceLimit = absenceLimit;
              if (!prev.courseName) prev.courseName = courseName;
              normalized.attendance[key] = prev;
            });
          }

          if (
            source.attendanceReminderLog &&
            typeof source.attendanceReminderLog === "object"
          ) {
            Object.entries(source.attendanceReminderLog).forEach(
              ([dateKey, stampRaw]) => {
                const cleanDate = this.normalizeDateKey(dateKey);
                if (!cleanDate) return;
                const stamp = String(stampRaw || "").trim();
                normalized.attendanceReminderLog[cleanDate] =
                  stamp || new Date().toISOString();
              },
            );
          }
          const attendanceReminderDates = Object.keys(
            normalized.attendanceReminderLog,
          )
            .sort()
            .slice(-90);
          const compactAttendanceReminderLog = {};
          attendanceReminderDates.forEach((dateKey) => {
            compactAttendanceReminderLog[dateKey] =
              normalized.attendanceReminderLog[dateKey];
          });
          normalized.attendanceReminderLog = compactAttendanceReminderLog;

          if (Array.isArray(source.dismissedReminders)) {
            source.dismissedReminders.forEach((key) => {
              const clean = String(key || "").trim();
              if (/^food-\d{4}-\d{2}-\d{2}$/.test(clean)) {
                normalized.dismissedReminders[clean] = true;
              }
            });
          } else if (
            source.dismissedReminders &&
            typeof source.dismissedReminders === "object"
          ) {
            Object.entries(source.dismissedReminders).forEach(([key, val]) => {
              const clean = String(key || "").trim();
              if (/^food-\d{4}-\d{2}-\d{2}$/.test(clean) && Boolean(val)) {
                normalized.dismissedReminders[clean] = true;
              }
            });
          }

          const reminderKeys = Object.keys(normalized.dismissedReminders)
            .sort()
            .slice(-32);
          normalized.dismissedReminders = {};
          reminderKeys.forEach((key) => {
            normalized.dismissedReminders[key] = true;
          });

          if (Array.isArray(source.notifiedReminders)) {
            source.notifiedReminders.forEach((key) => {
              const clean = String(key || "").trim();
              if (/^food-\d{4}-\d{2}-\d{2}$/.test(clean)) {
                normalized.notifiedReminders[clean] = new Date().toISOString();
              }
            });
          } else if (
            source.notifiedReminders &&
            typeof source.notifiedReminders === "object"
          ) {
            Object.entries(source.notifiedReminders).forEach(([key, val]) => {
              const clean = String(key || "").trim();
              if (!/^food-\d{4}-\d{2}-\d{2}$/.test(clean)) return;
              const stamp = String(val || "").trim();
              normalized.notifiedReminders[clean] =
                stamp || new Date().toISOString();
            });
          }

          const notifiedKeys = Object.keys(normalized.notifiedReminders)
            .sort()
            .slice(-32);
          const compactNotified = {};
          notifiedKeys.forEach((key) => {
            compactNotified[key] = normalized.notifiedReminders[key];
          });
          normalized.notifiedReminders = compactNotified;

          if (
            source.dismissedPinnedAlerts &&
            typeof source.dismissedPinnedAlerts === "object"
          ) {
            const noteIdSet = new Set(
              normalized.notes
                .filter((n) => Number.isFinite(Number(n?.id)))
                .map((n) => String(Number(n.id))),
            );
            Object.entries(source.dismissedPinnedAlerts).forEach(
              ([key, val]) => {
                const noteId = String(key || "").trim();
                const sig = String(val || "").trim();
                if (!/^\d+$/.test(noteId) || !sig) return;
                if (!noteIdSet.has(noteId)) return;
                normalized.dismissedPinnedAlerts[noteId] = sig;
              },
            );
          }
          const pinnedKeys = Object.keys(normalized.dismissedPinnedAlerts)
            .sort((a, b) => Number(b) - Number(a))
            .slice(0, 300);
          const compactPinned = {};
          pinnedKeys.forEach((key) => {
            compactPinned[key] = normalized.dismissedPinnedAlerts[key];
          });
          normalized.dismissedPinnedAlerts = compactPinned;

          if (source.settings && typeof source.settings === "object") {
            const storedWeek = sanitizeWeekType(source.settings.week);
            normalized.settings = {
              week: storedWeek,
              weekAnchorType: FIXED_WEEK_ANCHOR_TYPE,
              weekAnchorMs: FIXED_WEEK_ANCHOR_MS,
              theme: validThemeIds.has(source.settings.theme)
                ? source.settings.theme
                : DEFAULT_SETTINGS.theme,
              stylePack:
                source.settings.stylePack === "ultra" ||
                source.settings.stylePack === "pro"
                  ? source.settings.stylePack
                  : "base",
              anim:
                typeof source.settings.anim === "boolean"
                  ? source.settings.anim
                  : DEFAULT_SETTINGS.anim,
              animIntensity:
                source.settings.animIntensity === "ultra-low" ||
                source.settings.animIntensity === "low"
                  ? source.settings.animIntensity
                  : "high",
              uiMode:
                source.settings.uiMode === "desktop" ||
                source.settings.uiMode === "mobile"
                  ? source.settings.uiMode
                  : DEFAULT_SETTINGS.uiMode,
              view: source.settings.view === "list" ? "list" : "grid",
              profileName:
                typeof source.settings.profileName === "string" &&
                source.settings.profileName.trim()
                  ? source.settings.profileName.trim()
                  : DEFAULT_SETTINGS.profileName,
              profileTerm:
                typeof source.settings.profileTerm === "string" &&
                source.settings.profileTerm.trim()
                  ? source.settings.profileTerm.trim()
                  : DEFAULT_SETTINGS.profileTerm,
              profileMajor:
                typeof source.settings.profileMajor === "string"
                  ? source.settings.profileMajor.trim()
                  : DEFAULT_SETTINGS.profileMajor,
              profileClassStartDate: this.normalizeDateKey(
                source.settings.profileClassStartDate,
              ),
              attendanceReminderEnabled:
                typeof source.settings.attendanceReminderEnabled === "boolean"
                  ? source.settings.attendanceReminderEnabled
                  : DEFAULT_SETTINGS.attendanceReminderEnabled,
              attendanceReminderTime: this.normalizeTime(
                source.settings.attendanceReminderTime,
                DEFAULT_SETTINGS.attendanceReminderTime,
              ),
              attendanceViewMode:
                source.settings.attendanceViewMode === "all"
                  ? "all"
                  : DEFAULT_SETTINGS.attendanceViewMode,
              attendanceDefaultAbsenceLimit: Number.isFinite(
                Number(source.settings.attendanceDefaultAbsenceLimit),
              )
                ? Math.max(
                    1,
                    Math.min(
                      30,
                      Math.floor(
                        Number(source.settings.attendanceDefaultAbsenceLimit),
                      ),
                    ),
                  )
                : DEFAULT_SETTINGS.attendanceDefaultAbsenceLimit,
              attendanceAllowPastEdit: Boolean(
                source.settings.attendanceAllowPastEdit,
              ),
              attendanceActiveDate: this.normalizeDateKey(
                source.settings.attendanceActiveDate,
              ),
            };
          }

          if (typeof source.searchQuery === "string") {
            normalized.searchQuery = source.searchQuery.toLowerCase();
          }

          return normalized;
        },

        canUseStorage(forceProbe = false) {
          const now = Date.now();
          if (
            !forceProbe &&
            Number(this.storageProbeAt) > 0 &&
            now - this.storageProbeAt < 45000
          ) {
            return this.storageReady !== false;
          }
          this.storageProbeAt = now;

          if (typeof localStorage === "undefined") {
            this.storageReady = false;
            this.storageIssue = "localStorage API   .";
            return false;
          }

          const probeKey = "__uni_schedule_storage_probe__";
          try {
            localStorage.setItem(probeKey, "1");
            const ok = localStorage.getItem(probeKey) === "1";
            localStorage.removeItem(probeKey);
            this.storageReady = ok;
            this.storageIssue = ok
              ? ""
              : "  localStorage  .";
            return ok;
          } catch (err) {
            this.storageReady = false;
            this.storageIssue = String(
              err && err.message ? err.message : err || "",
            ).trim();
            return false;
          }
        },

        reportStorageIssue(message = STR.storageWriteFailed) {
          const now = Date.now();
          if (now - Number(this.storageAlertAt || 0) < 18000) return;
          this.storageAlertAt = now;
          const detail = this.storageIssue
            ? `\n\n :\n${this.storageIssue}`
            : "";
          alert(`${message}${detail}`);
        },

        persist() {
          const payload = this.buildTermStorePayloadJson();
          if (payload === this.lastPersistPayload) {
            this.lastPersistNoop = true;
            return true;
          }
          this.lastPersistNoop = false;
          if (!this.canUseStorage()) {
            console.error("Storage unavailable:", this.storageIssue);
            this.reportStorageIssue(STR.storageUnavailable);
            return false;
          }

          const now = Date.now();
          const backupMinGapMs = this.isMobilePerfContext()
            ? Math.max(STORAGE_BACKUP_MIN_GAP_MS, 26000)
            : STORAGE_BACKUP_MIN_GAP_MS;
          const shouldWriteBackup =
            now - Number(this.lastBackupPersistAt || 0) >= backupMinGapMs;
          let mainOk = false;
          let backupOk = !shouldWriteBackup;

          try {
            localStorage.setItem(STORAGE_KEY, payload);
            mainOk = true;
          } catch (err) {
            console.error("Storage write failed:", err);
            this.storageIssue = String(
              err && err.message ? err.message : err || "",
            ).trim();
          }

          if (shouldWriteBackup) {
            try {
              localStorage.setItem(STORAGE_BACKUP_KEY, payload);
              backupOk = true;
              this.lastBackupPersistAt = now;
            } catch (backupErr) {
              console.warn("Storage backup write failed:", backupErr);
              if (!this.storageIssue) {
                this.storageIssue = String(
                  backupErr && backupErr.message
                    ? backupErr.message
                    : backupErr || "",
                ).trim();
              }
            }
          }

          if (!mainOk) {
            try {
              localStorage.setItem(STORAGE_BACKUP_KEY, payload);
              backupOk = true;
              this.lastBackupPersistAt = now;
            } catch {}
          }
          if (!mainOk && backupOk) {
            try {
              localStorage.setItem(STORAGE_KEY, payload);
              mainOk = true;
            } catch {}
          }

          if (!mainOk && !backupOk) {
            if (!this.storageIssue) {
              this.storageIssue =
                "        localStorage  .";
            }
            this.storageReady = false;
            this.reportStorageIssue(STR.storageWriteFailed);
            return false;
          }

          this.storageReady = true;
          this.storageIssue = "";
          this.persistWriteCount = Number(this.persistWriteCount || 0) + 1;
          this.lastPersistPayload = payload;
          this.lastPersistNoop = false;
          if (mainOk) {
            if (!shouldWriteBackup || backupOk) {
              this.storageAlertAt = 0;
            }
          }
          return true;
        },

        init() {
          let parsed = null;
          let recoveredFromBackup = false;
          try {
            if (this.canUseStorage(true)) {
              const storedMain = localStorage.getItem(STORAGE_KEY);
              const storedBackup = localStorage.getItem(STORAGE_BACKUP_KEY);

              if (storedMain) {
                try {
                  parsed = JSON.parse(storedMain);
                } catch {
                  parsed = null;
                }
              }

              if (!parsed && storedBackup) {
                try {
                  parsed = JSON.parse(storedBackup);
                  localStorage.setItem(STORAGE_KEY, storedBackup);
                  recoveredFromBackup = true;
                } catch {
                  parsed = null;
                }
              }
            } else {
              console.warn("Storage unavailable at init:", this.storageIssue);
            }
          } catch {
            parsed = null;
          }

          if (recoveredFromBackup) {
            try {
              alert(STR.storageBackupRecovered);
            } catch {}
          }

          this.loadTermStore(parsed);
          this.manualWeekOverride = false;
          this.applyPerformanceProfile();

          this.renderStatic();
          this.setTheme(this.data.settings.theme, true);
          this.setStylePack(this.data.settings.stylePack, true);
          this.syncAutoWeek();
          this.setWeek(this.data.settings.week, true, false);
          this.setAnimEnabled(this.data.settings.anim, true);
          this.setAnimIntensity(this.data.settings.animIntensity, true);
          this.setUiMode(this.data.settings.uiMode, true);
          this.syncMobileUltraSmoothMode();
          this.bindResponsiveRuntimeEvents();
          this.bindMobileScrollPerfGuards();
          this.setView(this.data.settings.view, true);

          const searchInput = document.getElementById("searchInput");
          if (searchInput) searchInput.value = this.data.searchQuery;

          this.bindNotificationRuntimeEvents();
          this.registerNotificationServiceWorker(false);
          this.notifyLastCheckAt = Date.now();
          this.updateNotificationPermissionUI();
          this.startNotificationLoop();
          this.startLiveUiLoop();
          this.refreshUI();
          this.persist();
        },

        save(opts = {}) {
          const ok = this.persist();
          const noopPersist = Boolean(this.lastPersistNoop);
          const syncReason = String(opts.syncReason || "save")
            .trim()
            .toLowerCase();
          if (!ok && !this.storageIssue) {
            this.storageIssue =
              "    .     .";
          }
          if (!ok) this.reportStorageIssue(STR.storageWriteFailed);
          if (!noopPersist || opts.forceRefresh === true) {
            this.refreshUI();
          }
          if (
            ok &&
            !noopPersist &&
            !opts.skipCloudSync &&
            typeof cloudSync !== "undefined"
          ) {
            cloudSync.onLocalStateChanged(syncReason || "save");
          }
          return ok;
        },

        applyExternalData(rawData, opts = {}) {
          const activeNo = this.getActiveTermNo();
          this.data = this.normalizeTermDataForStore(rawData, activeNo);
          this.updateActiveTermStore();
          this.manualWeekOverride = false;
          this.applyPerformanceProfile();

          this.renderStatic();
          this.setTheme(this.data.settings.theme, true);
          this.setStylePack(this.data.settings.stylePack, true);
          this.syncAutoWeek();
          this.setWeek(this.data.settings.week, true, false);
          this.setAnimEnabled(this.data.settings.anim, true);
          this.setAnimIntensity(this.data.settings.animIntensity, true);
          this.setUiMode(this.data.settings.uiMode, true);
          this.syncMobileUltraSmoothMode();
          this.bindResponsiveRuntimeEvents();
          this.bindMobileScrollPerfGuards();
          this.setView(this.data.settings.view, true);

          const searchInput = document.getElementById("searchInput");
          if (searchInput) searchInput.value = this.data.searchQuery || "";

          this.updateNotificationPermissionUI();
          this.refreshUI();
          if (!opts.skipPersist) this.persist();
        },

        getWeekStartMs(date = new Date()) {
          return getAcademicWeekStartMs(date);
        },

        getWeekLabel(week = this.data.settings.week) {
          return week === "even" ? STR.weekEven : STR.weekOdd;
        },

        getUltraMood(baseDate = new Date()) {
          const dt = baseDate instanceof Date ? baseDate : new Date(baseDate);
          const hour = Number.isNaN(dt.getTime())
            ? new Date().getHours()
            : dt.getHours();
          if (hour >= 5 && hour < 10) return "sunrise";
          if (hour >= 10 && hour < 17) return "day";
          if (hour >= 17 && hour < 20) return "sunset";
          return "night";
        },

        applyUltraMood(force = false) {
          const body = document.body;
          const isUltra =
            this.data?.settings?.stylePack === "ultra" ||
            this.data?.settings?.stylePack === "pro";

          if (!isUltra) {
            body.removeAttribute("data-ultra-mood");
            return;
          }

          const mood = this.getUltraMood(new Date());
          if (force || body.getAttribute("data-ultra-mood") !== mood) {
            body.setAttribute("data-ultra-mood", mood);
          }
        },

        syncAutoWeek() {
          const settings = this.data.settings || (this.data.settings = {});
          settings.weekAnchorType = FIXED_WEEK_ANCHOR_TYPE;
          settings.weekAnchorMs = FIXED_WEEK_ANCHOR_MS;
          if (this.manualWeekOverride) {
            return false;
          }
          const computedWeek = getWeekTypeFromFixedAnchor(new Date());

          if (settings.week !== computedWeek) {
            this.setWeek(computedWeek, true, false);
            this.persist();
            if (typeof cloudSync !== "undefined") {
              cloudSync.onLocalStateChanged("auto-week");
            }
            return true;
          }
          return false;
        },

        setWeek(w, silent = false, syncAnchor = false, opts = {}) {
          const week = sanitizeWeekType(w);
          this.data.settings.week = week;
          if (silent) {
            this.manualWeekOverride = false;
          } else {
            this.manualWeekOverride = !Boolean(opts && opts.persist === true);
          }
          if (syncAnchor) {
            this.data.settings.weekAnchorType = week;
            this.data.settings.weekAnchorMs = this.getWeekStartMs(new Date());
          }

          const odd = document.getElementById("btnOdd");
          const even = document.getElementById("btnEven");
          odd.textContent = STR.weekOdd;
          even.textContent = STR.weekEven;

          odd.className =
            week === "odd"
              ? "px-4 py-2 rounded-xl text-sm font-black bg-[var(--accent)] text-[var(--bg)] shadow-xl transition-all"
              : "px-4 py-2 rounded-xl text-sm font-black opacity-50 hover:opacity-100 transition-all";

          even.className =
            week === "even"
              ? "px-4 py-2 rounded-xl text-sm font-black bg-[var(--accent)] text-[var(--bg)] shadow-xl transition-all"
              : "px-4 py-2 rounded-xl text-sm font-black opacity-50 hover:opacity-100 transition-all";

          if (!silent) {
            if (opts && opts.persist === true) {
              this.save();
            } else {
              this.refreshUI();
            }
          }
        },

        getProfileName() {
          const name = String(this.data.settings.profileName || "").trim();
          return name || STR.name;
        },

        getProfileTermNo() {
          return this.getActiveTermNo();
        },

        getProfileTerm() {
          return getTermLabel(this.getActiveTermNo());
        },

        getProfileMajor(raw = false) {
          const major = String(this.data.settings.profileMajor || "").trim();
          if (raw) return major;
          return major || STR.profileMajorDefault;
        },

        getProfileClassStartDateValue() {
          return this.normalizeDateKey(
            this.data.settings.profileClassStartDate,
          );
        },

        getProfileClassStartDateDisplay() {
          const dateKey = this.getProfileClassStartDateValue();
          if (!dateKey) return STR.profileClassStartUnset;
          const dt = new Date(`${dateKey}T00:00:00`);
          if (Number.isNaN(dt.getTime())) return STR.profileClassStartUnset;
          return dt.toLocaleDateString("fa-IR", {
            year: "numeric",
            month: "long",
            day: "numeric",
          });
        },

        getWeekTypeForDate(date = new Date()) {
          const ref = date instanceof Date ? date : new Date(date);
          if (Number.isNaN(ref.getTime())) return this.data.settings.week;
          return getWeekTypeFromFixedAnchor(ref);
        },

        isClassActiveForDate(cls, date = new Date()) {
          const type = String(cls?.type || "normal");
          if (type === "normal") return true;
          return type === this.getWeekTypeForDate(date);
        },

        getSessionStartBaseline(
          refDate = new Date(),
          explicitStartDateKey = "",
        ) {
          const startDateKey = explicitStartDateKey
            ? this.normalizeDateKey(explicitStartDateKey)
            : this.getProfileClassStartDateValue();
          if (!startDateKey) return 0;
          const now = refDate instanceof Date ? refDate : new Date(refDate);
          if (Number.isNaN(now.getTime())) return 0;
          const nowDateKey = this.getDateKey(now);
          if (!nowDateKey) return 0;
          return nowDateKey >= startDateKey ? 1 : 0;
        },

        formatSessionLabel(sessionNo) {
          const n = Math.max(0, Math.floor(Number(sessionNo) || 0));
          if (n <= 0) {
            return this.getProfileClassStartDateValue()
              ? " "
              : STR.sessionNotStarted;
          }
          const ordMap = {
            1: "",
            2: "",
            3: "",
            4: "",
            5: "",
            6: "",
            7: "",
            8: "",
            9: "",
            10: "",
          };
          if (ordMap[n]) return ` ${ordMap[n]}`;
          return ` ${n.toLocaleString("fa-IR")}`;
        },

        getCourseClassesByKey(courseKey, list = this.data.classes) {
          const key = this.normalizeCourseKey(courseKey);
          if (!key) return [];
          const arr = Array.isArray(list) ? list : [];
          return arr.filter(
            (c) =>
              this.normalizeCourseKey(c?.name || c?.courseName || "") === key,
          );
        },

        getCourseClassesBySessionKey(courseKey, list = this.data.classes) {
          const key = this.normalizeCourseSessionKey(courseKey);
          if (!key) return [];
          const arr = Array.isArray(list) ? list : [];
          return arr.filter(
            (c) =>
              this.normalizeCourseSessionKey(c?.name || c?.courseName || "") ===
              key,
          );
        },

        getCourseSessionOffsetByKey(courseKey, list = this.data.classes) {
          const matches = this.getCourseClassesBySessionKey(courseKey, list);
          if (!matches.length) return 0;
          const sorted = matches
            .slice()
            .sort((a, b) => Number(a.id) - Number(b.id));
          const manualEntry = sorted.find(
            (item) =>
              Boolean(item?.sessionOffsetManual) &&
              this.normalizeSessionOffset(item?.sessionOffset) > 0,
          );
          if (!manualEntry) return 0;
          return this.normalizeSessionOffset(manualEntry.sessionOffset);
        },

        resolveCourseClassesForSession(courseKey, opts = {}) {
          const replaceClassId = Number.isFinite(Number(opts.replaceClassId))
            ? Number(opts.replaceClassId)
            : null;
          const draftClass =
            opts.draftClass && typeof opts.draftClass === "object"
              ? opts.draftClass
              : null;

          let courseClasses = this.getCourseClassesBySessionKey(courseKey);

          if (draftClass) {
            const draftNameKey = this.normalizeCourseSessionKey(
              draftClass.name || draftClass.courseName || "",
            );
            if (
              draftNameKey &&
              draftNameKey === this.normalizeCourseSessionKey(courseKey)
            ) {
              if (replaceClassId !== null) {
                courseClasses = courseClasses.map((item) =>
                  Number(item.id) === replaceClassId
                    ? { ...item, ...draftClass }
                    : item,
                );
                if (
                  !courseClasses.some(
                    (item) => Number(item.id) === replaceClassId,
                  )
                ) {
                  courseClasses.push({ ...draftClass, id: replaceClassId });
                }
              } else {
                courseClasses = [...courseClasses, draftClass];
              }
            }
          }

          if (!courseClasses.length && draftClass) {
            if (String(draftClass.start || "").trim()) {
              courseClasses = [draftClass];
            }
          }

          return courseClasses;
        },

        getClassFirstOccurrenceAt(termStart, cls) {
          if (
            !(termStart instanceof Date) ||
            Number.isNaN(termStart.getTime())
          ) {
            return null;
          }
          if (!cls || !String(cls.start || "").trim()) return null;

          const [hh, mm] = this.normalizeTime(cls.start, "08:00")
            .split(":")
            .map(Number);
          const classDay = Math.max(0, Math.min(6, Number(cls.day) || 0));
          const termDay = (termStart.getDay() + 1) % 7;
          const dayOffset = (classDay - termDay + 7) % 7;

          const firstClassAt = new Date(termStart);
          firstClassAt.setDate(firstClassAt.getDate() + dayOffset);
          firstClassAt.setHours(hh, mm, 0, 0);
          return firstClassAt;
        },

        getClassFirstActiveOccurrenceAtOrAfter(termStart, cls) {
          const first = this.getClassFirstOccurrenceAt(termStart, cls);
          if (!first) return null;
          const cursor = new Date(first);
          let guard = 0;
          while (!this.isClassActiveForDate(cls, cursor) && guard < 4) {
            cursor.setDate(cursor.getDate() + 7);
            guard += 1;
          }
          if (!this.isClassActiveForDate(cls, cursor)) return null;
          return cursor;
        },

        countClassOccurrencesUntilDate(
          cls,
          termStart,
          refDate,
          includeRef = true,
        ) {
          if (!cls || !String(cls.start || "").trim()) return 0;
          if (
            !(termStart instanceof Date) ||
            Number.isNaN(termStart.getTime())
          ) {
            return 0;
          }
          const limitDate =
            refDate instanceof Date ? refDate : new Date(refDate);
          if (Number.isNaN(limitDate.getTime())) return 0;

          const limitMs = includeRef
            ? limitDate.getTime()
            : limitDate.getTime() - 1;
          if (limitMs < termStart.getTime()) return 0;

          const first = this.getClassFirstActiveOccurrenceAtOrAfter(
            termStart,
            cls,
          );
          if (!first) return 0;
          if (first.getTime() > limitMs) return 0;

          const classType = String(cls?.type || "normal");
          const cadenceDays = classType === "normal" ? 7 : 14;
          const approx = Math.max(
            0,
            Math.floor((limitMs - first.getTime()) / (cadenceDays * 86400000)),
          );

          const cursor = new Date(first);
          if (approx > 0)
            cursor.setDate(cursor.getDate() + approx * cadenceDays);
          let steps = approx;

          while (cursor.getTime() > limitMs && steps > 0) {
            cursor.setDate(cursor.getDate() - cadenceDays);
            steps -= 1;
          }
          while (true) {
            const next = new Date(cursor);
            next.setDate(next.getDate() + cadenceDays);
            if (next.getTime() <= limitMs) {
              cursor.setDate(cursor.getDate() + cadenceDays);
              steps += 1;
              continue;
            }
            break;
          }

          return steps + 1;
        },

        getCourseOccurrenceCountByKey(
          courseKey,
          refDate = new Date(),
          opts = {},
        ) {
          const startDateKey = this.getProfileClassStartDateValue();
          if (!startDateKey) return null;

          const termStart = new Date(`${startDateKey}T00:00:00`);
          if (Number.isNaN(termStart.getTime())) return null;

          const targetDate =
            refDate instanceof Date ? refDate : new Date(refDate);
          if (Number.isNaN(targetDate.getTime())) return 0;

          const courseClasses = this.resolveCourseClassesForSession(
            courseKey,
            opts,
          );
          if (!courseClasses.length) return 0;

          const includeRef = opts.includeRef !== false;
          let total = 0;
          courseClasses.forEach((cls) => {
            total += this.countClassOccurrencesUntilDate(
              cls,
              termStart,
              targetDate,
              includeRef,
            );
          });
          return Math.max(0, total);
        },

        getClassOccurrenceAtForReferenceWeek(cls, refDate = new Date()) {
          if (!cls || !String(cls.start || "").trim()) return null;
          const base = refDate instanceof Date ? refDate : new Date(refDate);
          if (Number.isNaN(base.getTime())) return null;

          const [hh, mm] = this.normalizeTime(cls.start, "08:00")
            .split(":")
            .map(Number);
          const classDay = Math.max(0, Math.min(6, Number(cls.day) || 0));
          const weekStartMs = getAcademicWeekStartMs(base);
          const out = new Date(weekStartMs);
          out.setDate(out.getDate() + classDay);
          out.setHours(hh, mm, 0, 0);
          let guard = 0;
          while (!this.isClassActiveForDate(cls, out) && guard < 4) {
            out.setDate(out.getDate() + 7);
            guard += 1;
          }
          return out;
        },

        getClassNextOccurrenceAt(cls, refDate = new Date()) {
          if (!cls || !String(cls.start || "").trim()) return null;
          const base = refDate instanceof Date ? refDate : new Date(refDate);
          if (Number.isNaN(base.getTime())) return null;

          const [hh, mm] = this.normalizeTime(cls.start, "08:00")
            .split(":")
            .map(Number);
          const classDay = Math.max(0, Math.min(6, Number(cls.day) || 0));
          const nowDay = (base.getDay() + 1) % 7;
          const nowMinutes = base.getHours() * 60 + base.getMinutes();
          const classMinutes = hh * 60 + mm;

          let dayDiff = classDay - nowDay;
          if (dayDiff < 0) dayDiff += 7;
          if (dayDiff === 0 && classMinutes < nowMinutes) dayDiff = 7;

          const out = new Date(base);
          out.setDate(out.getDate() + dayDiff);
          out.setHours(hh, mm, 0, 0);

          let guard = 0;
          while (!this.isClassActiveForDate(cls, out) && guard < 8) {
            out.setDate(out.getDate() + 7);
            guard += 1;
          }
          return out;
        },

        getSingleClassAutoSessionCount(cls, refDate = new Date()) {
          const startDateKey = this.getProfileClassStartDateValue();
          if (!startDateKey) return null;
          if (!cls || !String(cls.start || "").trim()) return 0;

          const termStart = new Date(`${startDateKey}T00:00:00`);
          if (Number.isNaN(termStart.getTime())) return null;
          const baseline = this.getSessionStartBaseline(refDate, startDateKey);
          const total = this.countClassOccurrencesUntilDate(
            cls,
            termStart,
            refDate,
            true,
          );
          return Math.max(baseline, total);
        },

        getCourseAutoSessionCountByKey(
          courseKey,
          refDate = new Date(),
          opts = {},
        ) {
          const startDateKey = this.getProfileClassStartDateValue();
          if (!startDateKey) return null;
          const baseline = this.getSessionStartBaseline(refDate, startDateKey);
          const total = this.getCourseOccurrenceCountByKey(courseKey, refDate, {
            ...opts,
            includeRef: true,
          });
          if (total === null) return null;
          return Math.max(baseline, total);
        },

        getClassAutoSessionCount(cls, refDate = new Date()) {
          const startDateKey = this.getProfileClassStartDateValue();
          if (!startDateKey) return null;
          if (!cls || !String(cls.start || "").trim()) return 0;

          const courseKey = this.normalizeCourseKey(
            cls.name || cls.courseName || "",
          );
          if (!courseKey)
            return this.getSingleClassAutoSessionCount(cls, refDate);

          return this.getCourseAutoSessionCountByKey(courseKey, refDate, {
            draftClass: cls,
            replaceClassId: Number.isFinite(Number(cls.id))
              ? Number(cls.id)
              : null,
          });
        },

        getClassSessionMeta(cls, refDate = new Date(), opts = {}) {
          const courseKey = this.normalizeCourseKey(
            cls?.name || cls?.courseName || "",
          );
          const sharedOffset = courseKey
            ? this.getCourseSessionOffsetByKey(courseKey)
            : cls?.sessionOffsetManual
              ? this.normalizeSessionOffset(cls?.sessionOffset)
              : 0;
          const offset = sharedOffset;
          const startDateKey = this.getProfileClassStartDateValue();
          if (!startDateKey) {
            return {
              ready: false,
              tone: "missing",
              autoSession: 0,
              sessionNo: 0,
              offset: sharedOffset,
              label: STR.sessionStartDateMissingShort,
              message: STR.sessionStartDatePrompt,
            };
          }

          const termStart = new Date(`${startDateKey}T00:00:00`);
          const rawOccurrenceAt = opts?.occurrenceAt;
          const occurrenceAt =
            rawOccurrenceAt instanceof Date
              ? rawOccurrenceAt
              : rawOccurrenceAt
                ? new Date(rawOccurrenceAt)
                : null;
          const hasOccurrenceAt =
            occurrenceAt instanceof Date &&
            !Number.isNaN(occurrenceAt.getTime());

          if (hasOccurrenceAt && !Number.isNaN(termStart.getTime())) {
            const beforeTerm = occurrenceAt.getTime() < termStart.getTime();
            if (beforeTerm) {
              const sessionNo = Math.max(1, 1 + offset);
              return {
                ready: true,
                tone: "pending",
                autoSession: 0,
                sessionNo,
                offset,
                label: this.formatSessionLabel(sessionNo),
                message: "",
              };
            }

            const replaceClassId = Number.isFinite(Number(cls?.id))
              ? Number(cls.id)
              : null;
            const countBefore = courseKey
              ? this.getCourseOccurrenceCountByKey(courseKey, occurrenceAt, {
                  includeRef: false,
                  draftClass: cls,
                  replaceClassId,
                })
              : this.countClassOccurrencesUntilDate(
                  cls,
                  termStart,
                  occurrenceAt,
                  false,
                );
            const countBeforeSafe = Math.max(0, Number(countBefore) || 0);
            const autoSessionSafe = countBeforeSafe + 1;
            const sessionNo = Math.max(1, autoSessionSafe + offset);
            return {
              ready: true,
              tone: "ok",
              autoSession: autoSessionSafe,
              sessionNo,
              offset,
              label: this.formatSessionLabel(sessionNo),
              message: "",
            };
          }

          const autoSession = this.getClassAutoSessionCount(cls, refDate);
          const autoSessionSafe = Math.max(0, Number(autoSession) || 0);
          const sessionNo = Math.max(1, autoSessionSafe + offset);

          const now = refDate instanceof Date ? refDate : new Date(refDate);
          const nowKey = this.getDateKey(now);
          const termNotReached = Boolean(nowKey && nowKey < startDateKey);
          if (termNotReached) {
            return {
              ready: true,
              tone: "pending",
              autoSession: autoSessionSafe,
              sessionNo,
              offset,
              label: this.formatSessionLabel(sessionNo),
              message: "",
            };
          }

          return {
            ready: true,
            tone: "ok",
            autoSession: autoSessionSafe,
            sessionNo,
            offset,
            label: this.formatSessionLabel(sessionNo),
            message: "",
          };
        },

        refreshSessionVisualsIfNeeded(refDate = new Date()) {
          if (!this.getProfileClassStartDateValue()) return;
          const now = refDate instanceof Date ? refDate : new Date(refDate);
          if (Number.isNaN(now.getTime())) return;
          const key = [
            now.getFullYear(),
            now.getMonth() + 1,
            now.getDate(),
            now.getHours(),
            now.getMinutes(),
          ].join("-");
          if (this.lastSessionRefreshKey === key) return;
          this.lastSessionRefreshKey = key;
          ui.renderSchedule();
        },

        refreshExamVisualsIfNeeded(refDate = new Date()) {
          const now = refDate instanceof Date ? refDate : new Date(refDate);
          if (Number.isNaN(now.getTime())) return;
          const key = [
            now.getFullYear(),
            now.getMonth() + 1,
            now.getDate(),
            now.getHours(),
            now.getMinutes(),
          ].join("-");
          if (this.lastExamRefreshKey === key) return;
          this.lastExamRefreshKey = key;
          ui.renderExams();
        },

        getAnimIntensityMode() {
          const raw = String(this.data.settings.animIntensity || "high")
            .trim()
            .toLowerCase();
          return raw === "ultra-low" || raw === "low" ? raw : "high";
        },

        fitThemeSelectWidth() {
          const shell = document.getElementById("themeSelectShell");
          const select = document.getElementById("themeSelect");
          if (
            !(shell instanceof HTMLElement) ||
            !(select instanceof HTMLSelectElement)
          ) {
            return;
          }
          const option = select.options?.[select.selectedIndex] || null;
          const text = String(option?.text || select.value || "").trim();
          if (!text) return;

          const cs = window.getComputedStyle(select);
          const font =
            cs.font && cs.font !== "normal"
              ? cs.font
              : `${cs.fontWeight || "900"} ${cs.fontSize || "13px"} ${cs.fontFamily || "sans-serif"}`;
          const canvas =
            this.__themeMeasureCanvas ||
            (this.__themeMeasureCanvas = document.createElement("canvas"));
          const ctx = canvas.getContext("2d");
          if (!ctx) return;
          ctx.font = font;

          const textWidth = Math.ceil(ctx.measureText(text).width);
          const padStart =
            parseFloat(cs.paddingInlineStart || cs.paddingLeft || "0") || 0;
          const padEnd =
            parseFloat(cs.paddingInlineEnd || cs.paddingRight || "0") || 0;
          const chromeWidth = padStart + padEnd + 18;

          const mobileLike = this.isMobilePerfContext();
          const minWidth = mobileLike ? 118 : 132;
          const maxWidth = mobileLike ? 172 : 196;
          const targetWidth = Math.max(
            minWidth,
            Math.min(maxWidth, textWidth + chromeWidth),
          );

          select.style.setProperty("width", `${targetWidth}px`, "important");
          select.style.setProperty(
            "min-width",
            `${targetWidth}px`,
            "important",
          );
          shell.style.setProperty("width", `${targetWidth}px`, "important");
          shell.style.setProperty("min-width", `${targetWidth}px`, "important");
        },

        syncTopNavSelectIcons() {
          const settings = this.data?.settings || {};
          const uiMode =
            settings.uiMode === "desktop" || settings.uiMode === "mobile"
              ? settings.uiMode
              : "auto";
          const pack =
            settings.stylePack === "ultra" || settings.stylePack === "pro"
              ? settings.stylePack
              : "base";
          const intensity = this.getAnimIntensityMode();
          const animEnabled = settings.anim ? "on" : "off";
          const validThemeIds = new Set(THEMES.map((x) => x.id));
          const theme = validThemeIds.has(settings.theme)
            ? settings.theme
            : DEFAULT_SETTINGS.theme;

          const uiShell = document.getElementById("uiModeShell");
          if (uiShell) {
            uiShell.setAttribute("data-ui-mode", uiMode);
            const modeButtons = uiShell.querySelectorAll(".ui-mode-icon-btn");
            modeButtons.forEach((btn) => {
              const value = String(btn?.dataset?.mode || "").trim();
              const active = value === uiMode;
              btn.classList.toggle("is-active", active);
              btn.setAttribute("aria-pressed", active ? "true" : "false");
            });
          }

          const packShell = document.getElementById("packSelectShell");
          if (packShell) packShell.setAttribute("data-pack", pack);

          const themeShell = document.getElementById("themeSelectShell");
          if (themeShell) themeShell.setAttribute("data-theme", theme);
          this.fitThemeSelectWidth();

          const intensityShell = document.getElementById("animIntensityShell");
          if (intensityShell) {
            intensityShell.setAttribute("data-intensity", intensity);
            intensityShell.setAttribute("data-anim-enabled", animEnabled);
            const buttons = intensityShell.querySelectorAll(
              ".intensity-icon-btn",
            );
            buttons.forEach((btn) => {
              const value = String(btn?.dataset?.value || "").trim();
              const active = value === intensity;
              btn.classList.toggle("is-active", active);
              btn.setAttribute("aria-pressed", active ? "true" : "false");
              btn.disabled = !settings.anim;
            });
          }
        },

        setProfileMeta(meta = {}, silent = false) {
          const current = this.data.settings || (this.data.settings = {});
          const nextName = String(
            meta.name !== undefined ? meta.name : current.profileName,
          ).trim();
          const nextMajor = String(
            meta.major !== undefined ? meta.major : current.profileMajor,
          ).trim();
          const nextClassStartDate = this.normalizeDateKey(
            meta.classStartDate !== undefined
              ? meta.classStartDate
              : current.profileClassStartDate,
          );

          current.profileName = nextName || STR.name;
          current.profileTerm = getTermLabel(this.getActiveTermNo());
          current.profileMajor = nextMajor;
          current.profileClassStartDate = nextClassStartDate;
          this.lastSessionRefreshKey = "";

          const profileEl = document.getElementById("txtProfile");
          if (profileEl) profileEl.innerText = this.getProfileName();
          const termEl = document.getElementById("txtProfileTerm");
          if (termEl) termEl.innerText = this.getProfileTerm();
          const majorEl = document.getElementById("txtProfileMajor");
          if (majorEl) majorEl.innerText = this.getProfileMajor();
          const startLabelEl = document.getElementById("txtClassStartLabel");
          if (startLabelEl) startLabelEl.innerText = STR.profileClassStartLabel;
          const hasDate = Boolean(this.getProfileClassStartDateValue());
          const startEl = document.getElementById("txtClassStartDate");
          if (startEl) {
            startEl.innerText = this.getProfileClassStartDateDisplay();
            startEl.classList.toggle("is-empty", !hasDate);
          }
          const startMetaEl = document.getElementById("txtClassStartMeta");
          if (startMetaEl) {
            startMetaEl.innerText = hasDate
              ? STR.profileClassStartSet
              : STR.profileClassStartMetaUnset;
            startMetaEl.classList.toggle("is-empty", !hasDate);
          }
          if (!silent) this.save();
        },

        setProfileName(name, silent = false) {
          this.setProfileMeta({ name }, silent);
        },

        editProfileName() {
          if (
            typeof ui !== "undefined" &&
            typeof ui.openProfileMetaModal === "function"
          ) {
            ui.openProfileMetaModal();
            return;
          }
          const next = prompt(STR.promptProfileName, this.getProfileName());
          if (next === null) return;
          const clean = String(next).trim();
          if (!clean) {
            alert(STR.profileNameRequired);
            return;
          }
          this.setProfileName(clean);
        },

        applyPerformanceProfile() {
          const mode = PERF_PROFILE.lite ? "lite" : "normal";
          const tier = PERF_PROFILE.ultraLite
            ? "ultra"
            : PERF_PROFILE.lite
              ? "lite"
              : "normal";
          document.body.setAttribute("data-perf-mode", mode);
          document.body.setAttribute("data-perf-tier", tier);

          if (PERF_PROFILE.ultraLite) {
            this.data.settings.anim = false;
            this.data.settings.animIntensity = "ultra-low";
            this.data.settings.stylePack = "base";
          } else if (PERF_PROFILE.lite) {
            this.data.settings.anim = false;
            this.data.settings.animIntensity = "low";
            this.data.settings.stylePack = "base";
          } else if (
            PERF_PROFILE.isMobile &&
            this.data.settings.anim &&
            this.data.settings.animIntensity === "high"
          ) {
            this.data.settings.animIntensity = "low";
          }
        },

        setTheme(t, silent = false) {
          const validThemeIds = new Set(THEMES.map((x) => x.id));
          const theme = validThemeIds.has(t) ? t : DEFAULT_SETTINGS.theme;
          const mobileLike = PERF_PROFILE.isMobile || isNarrowViewport();
          const autoMobilePerf = this.isAutoMobilePerfContext();
          const canRainOnMobile = MOBILE_SYMBOL_RAIN_THEME_IDS.has(theme);
          const intensityMode = this.getAnimIntensityMode();
          const ultraLowMobile = intensityMode === "ultra-low" && mobileLike;

          this.data.settings.theme = theme;
          document.body.setAttribute("data-theme", theme);

          const themeSelect = document.getElementById("themeSelect");
          if (themeSelect) themeSelect.value = theme;
          this.syncTopNavSelectIcons();
          this.applyUltraMood(true);
          if (autoMobilePerf) {
            resetDynamicFxLayers();
          }

          const shouldBuildFx =
            this.data.settings.anim && !PERF_PROFILE.lite && !autoMobilePerf;
          if (shouldBuildFx) {
            resetDynamicFxLayers();
            if (!ultraLowMobile) {
              if (theme === "hacker") buildBinaryRain();
              buildThemeFx(theme);
              if (
                (canRainOnMobile || !mobileLike) &&
                intensityMode !== "ultra-low"
              )
                buildSymbolRain(theme);
            }
          }
          if (!this.data.settings.anim) {
            resetDynamicFxLayers();
            if (autoMobilePerf) {
              // Keep auto-mobile background static-only for smoother scrolling.
            } else if (theme === "hacker") {
              buildBinaryRain({ forceStatic: true });
              if (
                !mobileLike &&
                !PERF_PROFILE.lite &&
                !PERF_PROFILE.ultraLite
              ) {
                buildSymbolRain(theme, { forceStatic: true });
              }
            } else if (STATIC_SYMBOL_THEME_IDS.has(theme)) {
              buildSymbolRain(theme, { forceStatic: true });
            }
          }
          this.syncMobileUltraSmoothMode();

          if (!silent) this.save();
        },

        setStylePack(p, silent = false) {
          const pack = p === "ultra" || p === "pro" ? p : "base";
          this.data.settings.stylePack = pack;
          document.body.setAttribute("data-style-pack", pack);
          const packSelect = document.getElementById("packSelect");
          if (packSelect) packSelect.value = pack;
          this.syncTopNavSelectIcons();
          this.applyUltraMood(true);
          this.syncMobileUltraSmoothMode();
          if (!silent) this.save();
        },

        setAnimEnabled(enabled, silent = false) {
          const state = Boolean(enabled);
          this.data.settings.anim = state;
          const mobileLike = PERF_PROFILE.isMobile || isNarrowViewport();
          const autoMobilePerf = this.isAutoMobilePerfContext();
          const intensityMode = this.getAnimIntensityMode();
          const ultraLowMobile = intensityMode === "ultra-low" && mobileLike;

          document.body.setAttribute("data-anim-enabled", state ? "on" : "off");

          const animEl = document.getElementById("bgAnim");
          if (animEl) {
            if (state) animEl.classList.remove("anim-off");
            else animEl.classList.add("anim-off");
          }
          document.body.setAttribute("data-anim-intensity", intensityMode);

          if (state) {
            const theme = this.data.settings.theme || DEFAULT_SETTINGS.theme;
            const canRainOnMobile = MOBILE_SYMBOL_RAIN_THEME_IDS.has(theme);
            if (!PERF_PROFILE.lite) {
              if (ultraLowMobile || autoMobilePerf) {
                resetDynamicFxLayers();
              } else {
                if (theme === "hacker") buildBinaryRain();
                buildThemeFx(theme);
                if (
                  (canRainOnMobile || !mobileLike) &&
                  intensityMode !== "ultra-low"
                )
                  buildSymbolRain(theme);
              }
            }
          } else {
            const theme = this.data.settings.theme || DEFAULT_SETTINGS.theme;
            resetDynamicFxLayers();
            if (autoMobilePerf) {
              // Keep auto-mobile background static-only for smoother scrolling.
            } else if (theme === "hacker") {
              buildBinaryRain({ forceStatic: true });
              if (
                !mobileLike &&
                !PERF_PROFILE.lite &&
                !PERF_PROFILE.ultraLite
              ) {
                buildSymbolRain(theme, { forceStatic: true });
              }
            } else if (STATIC_SYMBOL_THEME_IDS.has(theme)) {
              buildSymbolRain(theme, { forceStatic: true });
            }
          }

          const modeSel = document.getElementById("animModeSelect");
          if (modeSel) modeSel.value = state ? "on" : "off";

          const intensitySel = document.getElementById("animIntensitySelect");
          if (intensitySel) {
            intensitySel.disabled = !state;
            intensitySel.classList.toggle("opacity-50", !state);
          }
          this.syncTopNavSelectIcons();

          const animBtn = document.getElementById("btnAnimStatus");
          if (animBtn) {
            animBtn.dataset.state = state ? "on" : "off";
            animBtn.title = state
              ? STR.animToggleOnTitle
              : STR.animToggleOffTitle;
            animBtn.setAttribute("aria-pressed", state ? "true" : "false");
            animBtn.setAttribute(
              "aria-label",
              state ? STR.animEnabled : STR.animDisabled,
            );
          }
          const animShortEl = document.getElementById("txtAnimStatusShort");
          if (animShortEl) {
            animShortEl.innerText = state
              ? STR.notifyOnShort || "On"
              : STR.notifyOffShort || "Off";
          }
          this.syncMobileUltraSmoothMode();

          if (!silent) this.save();
        },

        setAnimIntensity(level, silent = false) {
          const intensity =
            level === "ultra-low" || level === "low" ? level : "high";
          const mobileLike = PERF_PROFILE.isMobile || isNarrowViewport();
          const autoMobilePerf = this.isAutoMobilePerfContext();
          const ultraLowMobile = intensity === "ultra-low" && mobileLike;
          const prevIntensity =
            this.data.settings.animIntensity === "ultra-low" ||
            this.data.settings.animIntensity === "low"
              ? this.data.settings.animIntensity
              : "high";
          this.data.settings.animIntensity = intensity;
          document.body.setAttribute("data-anim-intensity", intensity);
          if (this.data.settings.anim && autoMobilePerf) {
            resetDynamicFxLayers();
          }

          const intensitySel = document.getElementById("animIntensitySelect");
          if (intensitySel) intensitySel.value = intensity;
          this.syncTopNavSelectIcons();

          if (
            this.data.settings.anim &&
            !PERF_PROFILE.lite &&
            !autoMobilePerf &&
            prevIntensity !== intensity
          ) {
            const theme = this.data.settings.theme || DEFAULT_SETTINGS.theme;
            const canRainOnMobile = MOBILE_SYMBOL_RAIN_THEME_IDS.has(theme);
            resetDynamicFxLayers();
            if (!ultraLowMobile) {
              if (theme === "hacker") buildBinaryRain();
              buildThemeFx(theme);
              if ((canRainOnMobile || !mobileLike) && intensity !== "ultra-low")
                buildSymbolRain(theme);
            }
          }
          this.syncMobileUltraSmoothMode();

          if (!silent) this.save();
        },

        setUiMode(mode, silent = false) {
          const uiMode =
            mode === "desktop" || mode === "mobile" ? mode : "auto";
          const prevMode = String(this.data.settings.uiMode || "auto");
          const modeChanged = prevMode !== uiMode;
          this.data.settings.uiMode = uiMode;
          document.body.setAttribute("data-ui-mode", uiMode);

          const uiModeSel = document.getElementById("uiModeSelect");
          if (uiModeSel) uiModeSel.value = uiMode;
          this.syncTopNavSelectIcons();
          this.lastResponsiveMobileState = this.isMobileLayout();
          this.scheduleViewportSync();
          this.syncMobileUltraSmoothMode();
          const mobilePerfContext = this.isMobilePerfContext();
          if (!mobilePerfContext && typeof document !== "undefined") {
            document.body?.classList.remove("mobile-scrolling");
            document.body?.classList.remove("mobile-scrolling-ultra");
          }
          if (!mobilePerfContext) {
            this.mobilePendingRefresh = false;
            this.mobileLiveTickAt = 0;
          }
          if (this.isAutoMobilePerfContext()) {
            resetDynamicFxLayers();
          }

          if (
            modeChanged &&
            !silent &&
            this.data.settings.anim &&
            !PERF_PROFILE.lite
          ) {
            const mobileLike =
              uiMode === "mobile" ||
              (uiMode === "auto" && isNarrowViewport()) ||
              PERF_PROFILE.isMobile;
            const autoMobilePerf =
              uiMode === "auto" &&
              (isNarrowViewport() || PERF_PROFILE.isMobile);
            const intensityMode = this.getAnimIntensityMode();
            const ultraLowMobile = intensityMode === "ultra-low" && mobileLike;
            const theme = this.data.settings.theme || DEFAULT_SETTINGS.theme;
            const canRainOnMobile = MOBILE_SYMBOL_RAIN_THEME_IDS.has(theme);

            resetDynamicFxLayers();
            if (!ultraLowMobile && !autoMobilePerf) {
              if (theme === "hacker") buildBinaryRain();
              buildThemeFx(theme);
              if (
                (canRainOnMobile || !mobileLike) &&
                intensityMode !== "ultra-low"
              )
                buildSymbolRain(theme);
            }
          }

          if (!silent && modeChanged) {
            this.save({ syncReason: "ui-mode-switch" });
          }
        },

        isMobileLayout() {
          const mode = this.data?.settings?.uiMode || "auto";
          if (mode === "mobile") return true;
          if (mode === "desktop") return false;
          if (window.matchMedia)
            return window.matchMedia("(max-width: 1023.98px)").matches;
          return window.innerWidth < 1024;
        },

        getAlertDateTime(note) {
          if (!note || !note.alertDate || !note.alertTime) return null;
          const dt = new Date(`${note.alertDate}T${note.alertTime}:00`);
          return Number.isNaN(dt.getTime()) ? null : dt;
        },

        getExamDateTime(exam) {
          const meta = this.getDateTimeMeta(exam?.date, exam?.time);
          return meta.valid ? meta.date : null;
        },

        getDateTimeMeta(dateKey, timeValue) {
          const cleanDate = this.normalizeDateKey(dateKey);
          const cleanTime = this.normalizeTime(timeValue, "");
          if (!cleanDate || !cleanTime) {
            return {
              valid: false,
              date: null,
              dateKey: cleanDate || "",
              time: cleanTime || "",
              dayLabel: "-",
              dateLabel: "-",
              timeLabel: "-",
              fullLabel: "-",
            };
          }

          const dt = new Date(`${cleanDate}T${cleanTime}:00`);
          if (Number.isNaN(dt.getTime())) {
            return {
              valid: false,
              date: null,
              dateKey: cleanDate,
              time: cleanTime,
              dayLabel: "-",
              dateLabel: cleanDate,
              timeLabel: cleanTime,
              fullLabel: `${cleanDate} | ${cleanTime}`,
            };
          }

          const dayLabel = dt.toLocaleDateString("fa-IR", {
            weekday: "long",
          });
          const dateLabel = dt.toLocaleDateString("fa-IR", {
            year: "numeric",
            month: "long",
            day: "numeric",
          });
          const timeLabel = dt.toLocaleTimeString("en-GB", {
            hour: "2-digit",
            minute: "2-digit",
            hour12: false,
          });
          return {
            valid: true,
            date: dt,
            dateKey: cleanDate,
            time: cleanTime,
            dayLabel,
            dateLabel,
            timeLabel,
            fullLabel: `${dayLabel} | ${dateLabel} | ${timeLabel}`,
          };
        },

        getExamNotificationDateTime(exam) {
          if (!exam) return null;

          const manualMeta = this.getDateTimeMeta(
            exam.notifyDate,
            exam.notifyTime,
          );
          if (manualMeta.valid) return manualMeta.date;

          const examAt = this.getExamDateTime(exam);
          if (!examAt) return null;
          const beforeMin = NOTIFY_BEFORE_OPTIONS.includes(
            Number(exam.notifyBeforeMin),
          )
            ? Number(exam.notifyBeforeMin)
            : 0;
          const fireAt = new Date(examAt.getTime() - beforeMin * 60000);
          return Number.isNaN(fireAt.getTime()) ? null : fireAt;
        },

        getExamNotificationMeta(exam) {
          const notifyAt = this.getExamNotificationDateTime(exam);
          if (!notifyAt) {
            return {
              hasTarget: false,
              isManual: false,
              date: null,
              dateKey: "",
              dayLabel: "-",
              dateLabel: "-",
              timeLabel: "-",
              fullLabel: "-",
              sourceLabel: "-",
            };
          }
          const dateKey = this.getDateKey(notifyAt);
          const dayLabel = notifyAt.toLocaleDateString("fa-IR", {
            weekday: "long",
          });
          const dateLabel = notifyAt.toLocaleDateString("fa-IR", {
            year: "numeric",
            month: "long",
            day: "numeric",
          });
          const timeLabel = notifyAt.toLocaleTimeString("en-GB", {
            hour: "2-digit",
            minute: "2-digit",
            hour12: false,
          });
          const hasManualInput = Boolean(
            this.normalizeDateKey(exam?.notifyDate) &&
            this.normalizeTime(exam?.notifyTime, ""),
          );
          const sourceLabel = hasManualInput
            ? " "
            : this.getNotifyBeforeLabel(exam?.notifyBeforeMin);

          return {
            hasTarget: true,
            isManual: hasManualInput,
            date: notifyAt,
            dateKey,
            dayLabel,
            dateLabel,
            timeLabel,
            fullLabel: `${dayLabel} | ${dateLabel} | ${timeLabel}`,
            sourceLabel,
          };
        },

        getCountdownMeta(targetDate, now = new Date()) {
          const ref = now instanceof Date ? now : new Date(now);
          const fallback = {
            hasTarget: false,
            isUpcoming: false,
            orderBucket: 2,
            orderValue: Number.MAX_SAFE_INTEGER,
            daysOnly: null,
            daysText: " ",
            detailText: " ",
          };
          if (Number.isNaN(ref.getTime())) return fallback;

          const target =
            targetDate instanceof Date ? targetDate : new Date(targetDate);
          if (Number.isNaN(target.getTime())) return fallback;

          const diffMs = target.getTime() - ref.getTime();
          const absMs = Math.abs(diffMs);
          const totalMin = Math.max(0, Math.floor(absMs / 60000));
          const d = Math.floor(totalMin / 1440);
          const h = Math.floor((totalMin % 1440) / 60);
          const m = totalMin % 60;
          const isUpcoming = diffMs >= 0;
          const daysOnly = Math.floor(absMs / 86400000);
          const parts = [];

          if (d > 0) parts.push(`${d.toLocaleString("fa-IR")} `);
          if (h > 0) parts.push(`${h.toLocaleString("fa-IR")} `);
          if (d === 0 && m > 0)
            parts.push(`${m.toLocaleString("fa-IR")} `);
          if (parts.length === 0) parts.push("   ");

          const compact = parts.slice(0, 2).join("  ");

          return {
            hasTarget: true,
            isUpcoming,
            orderBucket: isUpcoming ? 0 : 1,
            orderValue: isUpcoming ? target.getTime() : absMs,
            daysOnly,
            daysText: isUpcoming
              ? `${daysOnly.toLocaleString("fa-IR")}  `
              : `${daysOnly.toLocaleString("fa-IR")}  `,
            detailText: isUpcoming
              ? `${compact} `
              : `${compact} `,
          };
        },

        getAlertDayLabel(dateStr) {
          if (!dateStr) return "-";
          const dt = new Date(`${dateStr}T00:00:00`);
          if (Number.isNaN(dt.getTime())) return "-";
          return dt.toLocaleDateString("fa-IR", { weekday: "long" });
        },

        getNotifyBeforeLabel(minutes) {
          const m = Number(minutes);
          const labelMap = {
            0: STR.notifyAtTime,
            5: STR.notifyBefore5,
            10: STR.notifyBefore10,
            15: STR.notifyBefore15,
            20: STR.notifyBefore20,
            30: STR.notifyBefore30,
            45: STR.notifyBefore45,
            60: STR.notifyBefore60,
            90: STR.notifyBefore90,
            120: STR.notifyBefore120,
            180: STR.notifyBefore180,
            360: STR.notifyBefore360,
            720: STR.notifyBefore720,
            1440: STR.notifyBefore1440,
            2880: STR.notifyBefore2880,
            10080: STR.notifyBefore10080,
          };
          return labelMap[m] || STR.notifyAtTime;
        },

        toLocalDateKey(value) {
          const dt = value instanceof Date ? value : new Date(value);
          if (Number.isNaN(dt.getTime())) return "";
          const y = String(dt.getFullYear()).padStart(4, "0");
          const m = String(dt.getMonth() + 1).padStart(2, "0");
          const d = String(dt.getDate()).padStart(2, "0");
          return `${y}-${m}-${d}`;
        },

        getWeeklyFoodReminderStart(now = new Date()) {
          const ref = now instanceof Date ? now : new Date(now);
          if (Number.isNaN(ref.getTime())) return null;

          const start = new Date(ref);
          const dayDiff = (ref.getDay() - WEEKLY_FOOD_REMINDER.day + 7) % 7;
          start.setDate(ref.getDate() - dayDiff);
          start.setHours(
            WEEKLY_FOOD_REMINDER.hour,
            WEEKLY_FOOD_REMINDER.minute,
            0,
            0,
          );

          if (start.getTime() > ref.getTime()) {
            start.setDate(start.getDate() - 7);
          }
          return start;
        },

        getWeeklyFoodReminderInfo(now = new Date()) {
          const start = this.getWeeklyFoodReminderStart(now);
          if (!start) return null;

          const key = `food-${this.toLocalDateKey(start)}`;
          if (
            !key ||
            (this.data.dismissedReminders &&
              this.data.dismissedReminders[key] === true)
          ) {
            return null;
          }

          const hh = String(WEEKLY_FOOD_REMINDER.hour).padStart(2, "0");
          const mm = String(WEEKLY_FOOD_REMINDER.minute).padStart(2, "0");
          const sinceLabel = start.toLocaleDateString("fa-IR", {
            weekday: "long",
            month: "long",
            day: "numeric",
          });

          return {
            key,
            title: WEEKLY_FOOD_REMINDER.text,
            subtitle: `${sinceLabel} | ${hh}:${mm}`,
          };
        },

        dismissWeeklyFoodReminder(key) {
          const clean = String(key || "").trim();
          if (!/^food-\d{4}-\d{2}-\d{2}$/.test(clean)) return;

          if (
            !this.data.dismissedReminders ||
            typeof this.data.dismissedReminders !== "object"
          ) {
            this.data.dismissedReminders = {};
          }
          this.data.dismissedReminders[clean] = true;

          const reminderKeys = Object.keys(this.data.dismissedReminders)
            .sort()
            .slice(-32);
          const compact = {};
          reminderKeys.forEach((k) => {
            compact[k] = true;
          });
          this.data.dismissedReminders = compact;
          this.save();
        },

        isPinnedNoteDismissed(note) {
          if (!note || !Number.isFinite(Number(note.id))) return false;
          const key = String(Number(note.id));
          const signature = this.getNoteNotificationSignature(note);
          return Boolean(
            this.data.dismissedPinnedAlerts &&
            typeof this.data.dismissedPinnedAlerts === "object" &&
            this.data.dismissedPinnedAlerts[key] === signature,
          );
        },

        dismissPinnedNoteAlert(id) {
          const noteId = Number(id);
          if (!Number.isFinite(noteId)) return;
          const note = this.data.notes.find((n) => Number(n.id) === noteId);
          if (!note) return;

          if (
            !this.data.dismissedPinnedAlerts ||
            typeof this.data.dismissedPinnedAlerts !== "object"
          ) {
            this.data.dismissedPinnedAlerts = {};
          }
          this.data.dismissedPinnedAlerts[String(noteId)] =
            this.getNoteNotificationSignature(note);

          const keys = Object.keys(this.data.dismissedPinnedAlerts)
            .sort((a, b) => Number(b) - Number(a))
            .slice(0, 300);
          const compact = {};
          keys.forEach((k) => {
            compact[k] = this.data.dismissedPinnedAlerts[k];
          });
          this.data.dismissedPinnedAlerts = compact;
          this.save();
        },

        clearPinnedNoteDismissal(id) {
          const noteId = Number(id);
          if (!Number.isFinite(noteId)) return;
          if (
            !this.data.dismissedPinnedAlerts ||
            typeof this.data.dismissedPinnedAlerts !== "object"
          ) {
            return;
          }
          delete this.data.dismissedPinnedAlerts[String(noteId)];
        },

        prunePinnedAlertDismissals() {
          if (
            !this.data.dismissedPinnedAlerts ||
            typeof this.data.dismissedPinnedAlerts !== "object"
          ) {
            this.data.dismissedPinnedAlerts = {};
            return;
          }
          const validIds = new Set(
            this.data.notes
              .filter((n) => Number.isFinite(Number(n?.id)))
              .map((n) => String(Number(n.id))),
          );
          const compact = {};
          Object.entries(this.data.dismissedPinnedAlerts).forEach(
            ([noteId, signature]) => {
              const key = String(noteId || "").trim();
              const sig = String(signature || "").trim();
              if (!validIds.has(key) || !sig) return;
              compact[key] = sig;
            },
          );
          const keys = Object.keys(compact)
            .sort((a, b) => Number(b) - Number(a))
            .slice(0, 300);
          this.data.dismissedPinnedAlerts = {};
          keys.forEach((k) => {
            this.data.dismissedPinnedAlerts[k] = compact[k];
          });
        },

        hasFoodReminderNotified(key) {
          const clean = String(key || "").trim();
          if (!/^food-\d{4}-\d{2}-\d{2}$/.test(clean)) return false;
          return Boolean(
            this.data.notifiedReminders &&
            typeof this.data.notifiedReminders === "object" &&
            this.data.notifiedReminders[clean],
          );
        },

        markFoodReminderNotified(key) {
          const clean = String(key || "").trim();
          if (!/^food-\d{4}-\d{2}-\d{2}$/.test(clean)) return;

          if (
            !this.data.notifiedReminders ||
            typeof this.data.notifiedReminders !== "object"
          ) {
            this.data.notifiedReminders = {};
          }
          this.data.notifiedReminders[clean] = new Date().toISOString();

          const keys = Object.keys(this.data.notifiedReminders)
            .sort()
            .slice(-32);
          const compact = {};
          keys.forEach((k) => {
            compact[k] = this.data.notifiedReminders[k];
          });
          this.data.notifiedReminders = compact;
        },

        triggerFoodReminderNotification(reminder, fireAt) {
          if (!("Notification" in window)) return false;
          if (Notification.permission !== "granted") return false;
          if (!reminder || !reminder.key) return false;
          return this.showSystemNotification(reminder.title, {
            body: ` ${reminder.subtitle}`,
            tag: `uni-food-${reminder.key}`,
            timestamp: fireAt ? fireAt.getTime() : Date.now(),
            data: { type: "food", key: reminder.key },
          });
        },

        getNoteNotificationSignature(note) {
          return [
            note.id,
            note.alertDate || "",
            note.alertTime || "",
            Number(note.notifyBeforeMin || 0),
            note.notifyEnabled ? 1 : 0,
            note.notifyText || "",
            note.text || "",
          ].join("|");
        },

        getExamNotificationSignature(exam) {
          return [
            exam.id,
            Number(exam.classId || 0),
            exam.courseName || "",
            exam.date || "",
            exam.time || "",
            this.normalizeDateKey(exam.notifyDate),
            this.normalizeTime(exam.notifyTime, ""),
            Number(exam.notifyBeforeMin || 0),
            exam.notifyEnabled ? 1 : 0,
            exam.notifyText || "",
            exam.title || "",
          ].join("|");
        },

        isNoteSchedulable(note) {
          return Boolean(
            note &&
            note.important &&
            note.notifyEnabled &&
            note.alertDate &&
            note.alertTime,
          );
        },

        isExamSchedulable(exam) {
          return Boolean(
            exam &&
            exam.notifyEnabled &&
            exam.date &&
            exam.time &&
            this.getExamNotificationDateTime(exam),
          );
        },

        supportsServiceWorkerNotifications() {
          return Boolean(
            typeof navigator !== "undefined" &&
            "serviceWorker" in navigator &&
            typeof window !== "undefined" &&
            window.isSecureContext,
          );
        },

        hasActiveServiceWorker(reg = this.swRegistration) {
          return Boolean(reg && (reg.active || reg.waiting || reg.installing));
        },

        resolveServiceWorkerRegistrationTargets() {
          const targets = [];
          const seen = new Set();

          const pushTarget = (scriptLike, scopeLike = "./") => {
            const scriptURL = String(scriptLike || "").trim();
            if (!scriptURL || seen.has(scriptURL)) return;
            seen.add(scriptURL);
            targets.push({
              scriptURL,
              scope: String(scopeLike || "./"),
            });
          };

          try {
            const pageUrl = new URL(window.location.href);
            const localScript = new URL("./sw.js", pageUrl);
            const localScope = new URL("./", localScript);
            pushTarget(localScript.href, localScope.pathname || "./");

            const rootScript = new URL("/sw.js", pageUrl.origin);
            const rootScope = new URL("./", rootScript);
            pushTarget(rootScript.href, rootScope.pathname || "/");
          } catch {
            pushTarget("./sw.js", "./");
          }

          if (targets.length === 0) {
            targets.push({ scriptURL: "./sw.js", scope: "./" });
          }
          return targets;
        },

        registerNotificationServiceWorker(force = false) {
          if (!this.supportsServiceWorkerNotifications()) {
            return Promise.resolve(null);
          }

          const nowMs = Date.now();
          const retryCooldownMs = 12000;
          const hasHealthyRegistration = this.hasActiveServiceWorker();

          if (!force && hasHealthyRegistration) {
            return Promise.resolve(this.swRegistration);
          }
          if (
            !force &&
            this.swRegistrationChecked &&
            nowMs - this.swRegistrationLastAttemptMs < retryCooldownMs
          ) {
            return Promise.resolve(this.swRegistration);
          }

          this.swRegistrationChecked = true;
          this.swRegistrationLastAttemptMs = nowMs;
          this.swRegistrationError = "";

          const targets = this.resolveServiceWorkerRegistrationTargets();
          const attemptTrail = [];
          let lastError = null;

          const tryRegister = (index = 0) => {
            if (index >= targets.length) {
              return Promise.reject(
                lastError || new Error("Service Worker register path failed."),
              );
            }
            const target = targets[index];
            attemptTrail.push(`${target.scriptURL} [scope: ${target.scope}]`);
            return navigator.serviceWorker
              .register(target.scriptURL, {
                scope: target.scope,
                updateViaCache: "none",
              })
              .catch((err) => {
                lastError = err;
                return tryRegister(index + 1);
              });
          };

          return tryRegister()
            .then((reg) => {
              this.swRegistration = reg || null;
              if (reg && typeof reg.update === "function") {
                reg.update().catch(() => {});
              }
              return Promise.race([
                navigator.serviceWorker.ready
                  .then((readyReg) => readyReg || reg || null)
                  .catch(() => reg || null),
                new Promise((resolve) =>
                  window.setTimeout(() => resolve(reg || null), 3600),
                ),
              ]);
            })
            .then((reg) => {
              this.swRegistration = reg || this.swRegistration || null;
              this.swRegistrationError = "";
              this.bindNotificationRuntimeEvents();
              this.updateNotificationPermissionUI();
              return this.swRegistration;
            })
            .catch((err) => {
              this.swRegistration = null;
              const rawError = String(
                err && err.message ? err.message : err || "",
              ).trim();
              const attemptsNote =
                attemptTrail.length > 0
                  ? ` | attempted: ${attemptTrail.join(" -> ")}`
                  : "";
              this.swRegistrationError = `${rawError}${attemptsNote}`;
              console.warn("Service Worker registration failed:", err);
              this.updateNotificationPermissionUI();
              return null;
            });
        },

        bindNotificationRuntimeEvents() {
          if (this.notificationRuntimeBound) return;
          this.notificationRuntimeBound = true;

          if (
            typeof navigator !== "undefined" &&
            navigator.serviceWorker &&
            typeof navigator.serviceWorker.addEventListener === "function"
          ) {
            navigator.serviceWorker.addEventListener("controllerchange", () => {
              this.swRegistrationChecked = false;
              this.registerNotificationServiceWorker(true).finally(() => {
                this.updateNotificationPermissionUI();
                this.checkDueNotifications();
              });
            });
          }

          if (typeof window !== "undefined") {
            window.addEventListener("online", () => {
              if (!("Notification" in window)) return;
              if (Notification.permission !== "granted") return;
              this.swRegistrationChecked = false;
              this.registerNotificationServiceWorker(true).finally(() => {
                this.updateNotificationPermissionUI();
                this.checkDueNotifications();
              });
            });
          }
        },

        scheduleViewportSync() {
          if (typeof window === "undefined") return;
          if (this.viewportSyncRafId) return;
          this.viewportSyncRafId = window.requestAnimationFrame(() => {
            this.viewportSyncRafId = 0;
            syncDynamicViewportVars();
          });
        },

        syncResponsiveLayoutIfNeeded(force = false) {
          const currentMobile = this.isMobileLayout();
          const previousMobile = this.lastResponsiveMobileState;
          this.lastResponsiveMobileState = currentMobile;

          if (!force && previousMobile === currentMobile) return;
          if ((this.data?.settings?.uiMode || "auto") !== "auto") return;
          const autoMobilePerf = this.isAutoMobilePerfContext();

          if (this.data.settings.anim && !PERF_PROFILE.lite) {
            const theme = this.data.settings.theme || DEFAULT_SETTINGS.theme;
            const intensityMode = this.getAnimIntensityMode();
            const mobileLike = currentMobile || PERF_PROFILE.isMobile;
            const ultraLowMobile = intensityMode === "ultra-low" && mobileLike;

            resetDynamicFxLayers();
            if (!ultraLowMobile && !autoMobilePerf) {
              if (theme === "hacker") buildBinaryRain();
              buildThemeFx(theme);
              if (!mobileLike && intensityMode !== "ultra-low") {
                buildSymbolRain(theme);
              }
            }
          }
          this.syncMobileUltraSmoothMode();

          this.refreshUI();
        },

        bindResponsiveRuntimeEvents() {
          if (this.responsiveRuntimeBound) return;
          this.responsiveRuntimeBound = true;

          const handleViewportChange = () => {
            this.scheduleViewportSync();
            this.syncMobileUltraSmoothMode();
            if (this.viewportResizeTimerId) {
              window.clearTimeout(this.viewportResizeTimerId);
            }
            this.viewportResizeTimerId = window.setTimeout(() => {
              this.viewportResizeTimerId = 0;
              this.syncResponsiveLayoutIfNeeded(false);
            }, 130);
          };

          const handleViewportScroll = () => {
            if (this.isMobilePerfContext()) {
              const now = Date.now();
              if (now - Number(this.viewportScrollSyncAt || 0) < 220) return;
              this.viewportScrollSyncAt = now;
            }
            this.scheduleViewportSync();
          };

          this.lastResponsiveMobileState = this.isMobileLayout();
          this.scheduleViewportSync();

          window.addEventListener("resize", handleViewportChange, {
            passive: true,
          });
          window.addEventListener("orientationchange", handleViewportChange, {
            passive: true,
          });

          if (
            window.visualViewport &&
            typeof window.visualViewport.addEventListener === "function"
          ) {
            window.visualViewport.addEventListener(
              "resize",
              handleViewportChange,
              {
                passive: true,
              },
            );
            window.visualViewport.addEventListener(
              "scroll",
              handleViewportScroll,
              {
                passive: true,
              },
            );
          }
        },

        isMobilePerfContext() {
          const mode = this.data?.settings?.uiMode || "auto";
          if (mode === "mobile") return true;
          if (mode === "desktop") return false;
          return Boolean(PERF_PROFILE.isMobile || isNarrowViewport());
        },

        isAutoMobilePerfContext() {
          const mode = this.data?.settings?.uiMode || "auto";
          return mode === "auto" && this.isMobilePerfContext();
        },

        isMobileUltraSmoothEnabled() {
          if (!this.isMobilePerfContext()) return false;
          const settings = this.data?.settings || {};
          const forceAutoMobileSmooth = this.isAutoMobilePerfContext();
          const stylePack =
            settings.stylePack === "ultra" || settings.stylePack === "pro"
              ? settings.stylePack
              : "base";
          const intensity =
            settings.animIntensity === "ultra-low" ||
            settings.animIntensity === "low"
              ? settings.animIntensity
              : "high";
          const theme = String(settings.theme || DEFAULT_SETTINGS.theme);
          const heavyTheme = MOBILE_ULTRA_SMOOTH_HEAVY_THEMES.has(theme);
          const animated = Boolean(settings.anim);

          return (
            forceAutoMobileSmooth ||
            PERF_PROFILE.lite ||
            PERF_PROFILE.ultraLite ||
            heavyTheme ||
            stylePack !== "base" ||
            animated ||
            intensity === "high"
          );
        },

        syncMobileUltraSmoothMode() {
          if (typeof document === "undefined" || !document.body) return false;
          const enabled = this.isMobileUltraSmoothEnabled();
          const state = enabled ? "on" : "off";
          if (this.mobileUltraSmoothState !== state) {
            document.body.setAttribute("data-mobile-ultra-smooth", state);
            document.body.classList.toggle("mobile-ultra-smooth", enabled);
            this.mobileUltraSmoothState = state;
          }
          if (!enabled) {
            document.body.classList.remove("mobile-scrolling-ultra");
          }
          return enabled;
        },

        isMobileScrollingNow() {
          return (
            typeof document !== "undefined" &&
            Boolean(document.body?.classList.contains("mobile-scrolling"))
          );
        },

        requestPostScrollUiRefresh() {
          if (!this.mobilePendingRefresh && !this.deferredHeavyRenderPending)
            return;

          if (typeof window === "undefined") {
            this.mobilePendingRefresh = false;
            return;
          }

          if (this.mobilePostScrollRafId) return;
          this.mobilePostScrollRafId = window.requestAnimationFrame(() => {
            this.mobilePostScrollRafId = 0;
            this.mobilePendingRefresh = false;
            this.refreshUI();
          });
        },

        bindMobileScrollPerfGuards() {
          if (this.mobileScrollPerfBound) return;
          if (typeof document === "undefined" || typeof window === "undefined")
            return;
          this.mobileScrollPerfBound = true;

          const bodyEl = document.body;
          if (!bodyEl) return;
          let rafQueued = 0;
          let lastUltraModeSyncAt = 0;
          const nowMs = () =>
            typeof performance !== "undefined" &&
            typeof performance.now === "function"
              ? performance.now()
              : Date.now();
          const releaseClass = (delay = 130) => {
            if (this.mobileScrollPerfTimerId) {
              window.clearTimeout(this.mobileScrollPerfTimerId);
            }
            this.mobileScrollPerfTimerId = window.setTimeout(() => {
              this.mobileScrollPerfTimerId = 0;
              bodyEl.classList.remove("mobile-scrolling");
              bodyEl.classList.remove("mobile-scrolling-ultra");
              this.requestPostScrollUiRefresh();
            }, delay);
          };
          const maybeSyncUltraMode = (stamp = nowMs()) => {
            if (stamp - lastUltraModeSyncAt < 1400) return;
            lastUltraModeSyncAt = stamp;
            this.syncMobileUltraSmoothMode();
          };
          const getUltraMode = () =>
            this.mobileUltraSmoothState === "on" ||
            bodyEl.getAttribute("data-mobile-ultra-smooth") === "on";

          const markScrolling = () => {
            const stamp = nowMs();
            const mobileContext = this.isMobilePerfContext();
            if (!mobileContext) {
              if (
                !bodyEl.classList.contains("mobile-scrolling") &&
                !bodyEl.classList.contains("mobile-scrolling-ultra")
              ) {
                return;
              }
              bodyEl.classList.remove("mobile-scrolling");
              bodyEl.classList.remove("mobile-scrolling-ultra");
              this.requestPostScrollUiRefresh();
              return;
            }
            maybeSyncUltraMode(stamp);
            const ultraMode = getUltraMode();
            const autoMode =
              String(this.data?.settings?.uiMode || "auto") === "auto";
            const tickGap = ultraMode
              ? autoMode
                ? 96
                : 72
              : autoMode
                ? 60
                : 44;
            const releaseDelay = ultraMode
              ? autoMode
                ? 230
                : 190
              : autoMode
                ? 170
                : 140;
            if (stamp - Number(this.mobileScrollPerfTickAt || 0) < tickGap) {
              releaseClass(releaseDelay);
              return;
            }
            this.mobileScrollPerfTickAt = stamp;

            if (rafQueued) {
              releaseClass(releaseDelay);
              return;
            }
            rafQueued = window.requestAnimationFrame(() => {
              rafQueued = 0;
              const liveUltraMode = getUltraMode();
              const liveAutoMode =
                String(this.data?.settings?.uiMode || "auto") === "auto";
              const liveReleaseDelay = liveUltraMode
                ? liveAutoMode
                  ? 230
                  : 190
                : liveAutoMode
                  ? 170
                  : 140;
              if (!bodyEl.classList.contains("mobile-scrolling")) {
                bodyEl.classList.add("mobile-scrolling");
              }
              bodyEl.classList.toggle("mobile-scrolling-ultra", liveUltraMode);
              releaseClass(liveReleaseDelay);
            });
          };

          document.addEventListener("scroll", markScrolling, {
            capture: true,
            passive: true,
          });
          document.addEventListener("touchstart", markScrolling, {
            passive: true,
          });
          document.addEventListener(
            "touchend",
            () => {
              const autoMode =
                String(this.data?.settings?.uiMode || "auto") === "auto";
              releaseClass(autoMode ? 110 : 70);
            },
            { passive: true },
          );
          document.addEventListener(
            "touchcancel",
            () => {
              const autoMode =
                String(this.data?.settings?.uiMode || "auto") === "auto";
              releaseClass(autoMode ? 110 : 70);
            },
            { passive: true },
          );
          window.addEventListener(
            "blur",
            () => {
              bodyEl.classList.remove("mobile-scrolling");
              bodyEl.classList.remove("mobile-scrolling-ultra");
              this.requestPostScrollUiRefresh();
            },
            { passive: true },
          );

          this.syncMobileUltraSmoothMode();
        },

        getNotificationDiagnostics() {
          const issue = this.getNotificationContextIssue();
          const reasons = [];
          const steps = [];

          if (issue === "file") {
            reasons.push(STR.notifyContextFile);
            steps.push(
              "   localhost  HTTPS       .",
            );
            return {
              issue,
              permission: "unsupported",
              stateHint: "unsupported",
              reasons,
              steps,
            };
          }

          if (issue === "insecure") {
            reasons.push(STR.notifyContextInsecure);
            steps.push(
              "    HTTPS  localhost  .",
            );
            return {
              issue,
              permission: "unsupported",
              stateHint: "unsupported",
              reasons,
              steps,
            };
          }

          if (!("Notification" in window)) {
            reasons.push(STR.notifyNotSupported);
            return {
              issue: "",
              permission: "unsupported",
              stateHint: "unsupported",
              reasons,
              steps,
            };
          }

          const permission = Notification.permission;
          if (permission === "denied") {
            reasons.push(STR.notifyPermissionDenied);
            steps.push(
              "         .",
            );
            return {
              issue: "",
              permission,
              stateHint: "blocked",
              reasons,
              steps,
            };
          }

          if (permission !== "granted") {
            reasons.push(STR.notifyPermissionHint);
            steps.push(
              "         .",
            );
            return {
              issue: "",
              permission,
              stateHint: "off",
              reasons,
              steps,
            };
          }

          if (!this.supportsServiceWorkerNotifications()) {
            reasons.push(
              "        .",
            );
            steps.push(
              "Chrome      HTTPS/localhost  .",
            );
            return {
              issue: "",
              permission,
              stateHint: "partial",
              reasons,
              steps,
            };
          }

          const reg = this.swRegistration;
          const hasReg = Boolean(reg);
          const hasActive = this.hasActiveServiceWorker(reg);
          const hasController = Boolean(navigator?.serviceWorker?.controller);

          if (!hasReg || !hasActive) {
            reasons.push(
              "     .",
            );
            if (this.swRegistrationError) {
              reasons.push(
                `  : ${this.swRegistrationError}`,
              );
            }
            steps.push("    .");
            steps.push(
              " PWA         .",
            );
            return {
              issue: "",
              permission,
              stateHint: "partial",
              reasons,
              steps,
            };
          }

          if (!hasController) {
            steps.push(
              "          .",
            );
          }

          return {
            issue: "",
            permission,
            stateHint: "on",
            reasons,
            steps,
          };
        },

        getNotificationIssueMessage(sys = this.getSystemNotificationState()) {
          const diag = this.getNotificationDiagnostics();
          const reasonLines = (diag.reasons || []).map(
            (r, i) => `${i + 1}) ${r}`,
          );
          const stepLines = (diag.steps || []).map((s, i) => `${i + 1}) ${s}`);
          const head = `${sys.label}\n\n : ${sys.shortLabel}`;
          const detail = sys.detail ? `\n\n: ${sys.detail}` : "";
          const reasons =
            reasonLines.length > 0
              ? `\n\n:\n${reasonLines.join("\n")}`
              : "";
          const steps =
            stepLines.length > 0
              ? `\n\n :\n${stepLines.join("\n")}`
              : "";
          return `${head}${detail}${reasons}${steps}`;
        },

        formatNotificationClock(ts) {
          const num = Number(ts);
          if (!Number.isFinite(num) || num <= 0) return "-";
          const dt = new Date(num);
          if (Number.isNaN(dt.getTime())) return "-";
          return dt.toLocaleTimeString("fa-IR", {
            hour: "2-digit",
            minute: "2-digit",
          });
        },

        getNotificationChecklist(
          sys = this.getSystemNotificationState(),
          diag = this.getNotificationDiagnostics(),
        ) {
          const issue = String(diag.issue || "");
          const contextOk = !issue;
          const permission =
            "Notification" in window
              ? String(Notification.permission || "default")
              : "unsupported";
          const swSupported = this.supportsServiceWorkerNotifications();
          const swReady = this.hasActiveServiceWorker();
          const hasAnyTest = Number(this.notifyLastTestAt) > 0;
          const lastTestOk = hasAnyTest && Boolean(this.notifyLastTestOk);
          const lastTestText = hasAnyTest
            ? `${STR.notifyLastTestLabel}: ${this.formatNotificationClock(this.notifyLastTestAt)}`
            : STR.notifyNoTestYet;

          const contextDesc = contextOk
            ? "    (HTTPS/localhost)   ."
            : issue === "file"
              ? STR.notifyContextFile
              : STR.notifyContextInsecure;

          const permDesc =
            permission === "granted"
              ? "     ."
              : permission === "denied"
                ? STR.notifyPermissionDenied
                : permission === "unsupported"
                  ? STR.notifyNotSupported
                  : "     .";

          const swDesc = !swSupported
            ? "      ."
            : swReady
              ? "      ."
              : "    .";

          const deliveryDesc =
            sys.state === "on"
              ? lastTestOk
                ? `    . ${lastTestText}`
                : `  .      .`
              : sys.state === "partial"
                ? "       ."
                : sys.state === "blocked"
                  ? "      ."
                  : sys.state === "unsupported"
                    ? "      ."
                    : "    .";

          return [
            {
              key: "ctx",
              title: STR.notifyChecklistContext,
              status: contextOk ? "ok" : "bad",
              desc: contextDesc,
            },
            {
              key: "perm",
              title: STR.notifyChecklistPermission,
              status:
                permission === "granted"
                  ? "ok"
                  : permission === "denied" || permission === "unsupported"
                    ? "bad"
                    : "warn",
              desc: permDesc,
            },
            {
              key: "sw",
              title: STR.notifyChecklistSw,
              status: swReady ? "ok" : swSupported ? "warn" : "bad",
              desc: swDesc,
            },
            {
              key: "delivery",
              title: STR.notifyChecklistDelivery,
              status:
                sys.state === "on"
                  ? lastTestOk
                    ? "ok"
                    : "warn"
                  : sys.state === "blocked" || sys.state === "unsupported"
                    ? "bad"
                    : "warn",
              desc: deliveryDesc,
            },
          ];
        },

        getServiceWorkerExplanation(
          sys = this.getSystemNotificationState(),
          diag = this.getNotificationDiagnostics(),
        ) {
          const issue = String(diag.issue || "");
          if (issue || sys.state === "unsupported") {
            return [
              "           .",
              "             .",
              "     HTTPS  localhost      /  .",
            ].join("\n");
          }
          if (sys.state === "partial" || sys.state === "off") {
            const tail = this.swRegistrationError
              ? `  : ${this.swRegistrationError}`
              : "           /  .";
            return [
              "          .",
              "               .",
              tail,
            ].join("\n");
          }
          return [
            "    .",
            "            .",
            "       .",
          ].join("\n");
        },

        renderNotificationConnectPanel(
          sys = this.getSystemNotificationState(),
          diag = this.getNotificationDiagnostics(),
        ) {
          const panelEl = document.getElementById("notifyConnectPanel");
          const stateWrap = document.getElementById("txtNotifyConnectState");
          const stateText = stateWrap
            ? stateWrap.querySelector("span:last-child")
            : null;
          const metaEl = document.getElementById("txtNotifyConnectMeta");
          const swExplainEl = document.getElementById("txtNotifySwExplain");
          const checklistEl = document.getElementById("notifyChecklist");
          const quickFixBtn = document.getElementById("btnNotifyQuickFix");
          const testBtn = document.getElementById("btnNotifyTest");
          const guideBtn = document.getElementById("btnNotifyGuide");

          const stateMap = {
            on: STR.notifyConnectOn,
            partial: STR.notifyConnectPartial,
            off: STR.notifyConnectOff,
            blocked: STR.notifyConnectBlocked,
            unsupported: STR.notifyConnectUnsupported,
          };

          if (stateWrap) {
            stateWrap.dataset.state = sys.state;
            stateWrap.title = `${sys.label}\n${sys.detail}`;
          }
          if (stateText)
            stateText.textContent = stateMap[sys.state] || sys.label;

          const metaParts = [];
          if (Number(this.notifyLastCheckAt) > 0) {
            metaParts.push(
              `${STR.notifyLastCheckLabel}: ${this.formatNotificationClock(this.notifyLastCheckAt)}`,
            );
          }
          if (Number(this.notifyLastTestAt) > 0) {
            const status = this.notifyLastTestOk ? "" : "";
            metaParts.push(
              `${STR.notifyLastTestLabel}: ${this.formatNotificationClock(this.notifyLastTestAt)} ${status}`,
            );
          }
          if (metaEl) metaEl.textContent = metaParts.join(" | ") || "-";
          if (swExplainEl) {
            swExplainEl.textContent = this.getServiceWorkerExplanation(
              sys,
              diag,
            );
          }

          if (checklistEl) {
            const checks = this.getNotificationChecklist(sys, diag);
            checklistEl.innerHTML = checks
              .map((item) => {
                const stateClass =
                  item.status === "ok"
                    ? "is-ok"
                    : item.status === "bad"
                      ? "is-bad"
                      : "is-warn";
                const icon =
                  item.status === "ok"
                    ? ""
                    : item.status === "bad"
                      ? ""
                      : "!";
                return `
                  <div class="notify-check-item ${stateClass}">
                    <span class="notify-check-item__icon" aria-hidden="true">${icon}</span>
                    <span class="notify-check-item__text">
                      <span class="notify-check-item__title">${this.escapeHtml(item.title)}</span>
                      <span class="notify-check-item__desc">${this.escapeHtml(item.desc)}</span>
                    </span>
                  </div>
                `;
              })
              .join("");
          }

          if (quickFixBtn) {
            quickFixBtn.textContent = STR.notifyActionFix;
            quickFixBtn.title =
              "       ";
          }
          if (testBtn) {
            testBtn.textContent = STR.notifyActionTest;
            testBtn.disabled =
              sys.state === "unsupported" || sys.state === "blocked";
            testBtn.title =
              "      ";
          }
          if (guideBtn) {
            guideBtn.textContent = STR.notifyActionGuide;
            guideBtn.title =
              "     ";
          }

          // Hide the step-by-step educational panel when notification is fully active.
          const hideGuidePanel = sys.state === "on";
          if (panelEl) {
            panelEl.classList.toggle(
              "notify-connect-panel--hidden",
              hideGuidePanel,
            );
            panelEl.setAttribute(
              "aria-hidden",
              hideGuidePanel ? "true" : "false",
            );
          }
          this.refreshNotificationGuideState(sys);
        },

        runNotificationQuickFix(showFeedback = true) {
          const quickFixBtn = document.getElementById("btnNotifyQuickFix");
          const prevTxt = quickFixBtn ? quickFixBtn.textContent : "";
          if (quickFixBtn) {
            quickFixBtn.disabled = true;
            quickFixBtn.textContent = STR.notifyActionConnecting;
          }

          const finalize = () => {
            this.notifyLastCheckAt = Date.now();
            this.updateNotificationPermissionUI();
            const sys = this.getSystemNotificationState();

            if (quickFixBtn) {
              quickFixBtn.disabled = false;
              quickFixBtn.textContent = prevTxt || STR.notifyActionFix;
            }
            if (showFeedback) {
              if (sys.state === "on") alert(STR.notifyConnectOn);
              else alert(this.getNotificationIssueMessage(sys));
            }
            return sys.state;
          };

          const issue = this.getNotificationContextIssue();
          if (issue || !("Notification" in window)) {
            return Promise.resolve(finalize());
          }

          if (Notification.permission !== "granted") {
            return this.requestNotificationPermission(false)
              .then((perm) => {
                if (perm === "granted") {
                  return this.registerNotificationServiceWorker(true).then(
                    finalize,
                  );
                }
                return finalize();
              })
              .catch(() => finalize());
          }

          return this.registerNotificationServiceWorker(true)
            .then(() => finalize())
            .catch(() => finalize());
        },

        sendSystemNotificationTest() {
          const now = Date.now();
          const finish = (ok) => {
            this.notifyLastCheckAt = now;
            this.notifyLastTestAt = now;
            this.notifyLastTestOk = Boolean(ok);
            this.updateNotificationPermissionUI();
            return ok;
          };

          const sys = this.getSystemNotificationState();
          if (sys.state !== "on") {
            return this.runNotificationQuickFix(false).then((state) => {
              if (state !== "on") return finish(false);
              const sent = this.showSystemNotification(STR.notifyTestTitle, {
                body: STR.notifyTestBody,
                tag: "uni-notify-manual-test",
                timestamp: now,
                data: { type: "manual-test" },
              });
              if (sent) alert(STR.notifyTestSent);
              return finish(sent);
            });
          }

          const sent = this.showSystemNotification(STR.notifyTestTitle, {
            body: STR.notifyTestBody,
            tag: "uni-notify-manual-test",
            timestamp: now,
            data: { type: "manual-test" },
          });
          if (sent) alert(STR.notifyTestSent);
          else
            alert(
              this.getNotificationIssueMessage(
                this.getSystemNotificationState(),
              ),
            );
          return Promise.resolve(finish(sent));
        },

        refreshNotificationGuideState(sys = this.getSystemNotificationState()) {
          const stateEl = document.getElementById("notifyGuideState");
          const issueEl = document.getElementById("notifyGuideIssueText");
          const setupEl = document.getElementById("notifyGuideSetupText");
          const fixBtn = document.getElementById("btnNotifyGuideFix");
          const testBtn = document.getElementById("btnNotifyGuideTest");

          if (!stateEl && !issueEl && !setupEl && !fixBtn && !testBtn) return;

          if (stateEl) stateEl.textContent = String(sys.shortLabel || "");
          if (issueEl)
            issueEl.textContent = this.getNotificationIssueMessage(sys);
          if (setupEl) setupEl.textContent = this.getNotificationSetupMessage();

          if (fixBtn && fixBtn.dataset.busy !== "1") {
            fixBtn.disabled = false;
            fixBtn.textContent = STR.notifyActionFix;
            fixBtn.title =
              "       ";
          }

          if (testBtn && testBtn.dataset.busy !== "1") {
            const disabled =
              sys.state === "unsupported" || sys.state === "blocked";
            testBtn.disabled = disabled;
            testBtn.textContent = STR.notifyActionTest;
            testBtn.title = disabled
              ? "  /    ."
              : "      ";
          }
        },

        runNotificationGuideQuickFix() {
          const fixBtn = document.getElementById("btnNotifyGuideFix");
          const testBtn = document.getElementById("btnNotifyGuideTest");

          if (fixBtn) {
            fixBtn.dataset.busy = "1";
            fixBtn.disabled = true;
            fixBtn.textContent = STR.notifyActionConnecting;
          }
          if (testBtn) {
            testBtn.dataset.busy = "1";
            testBtn.disabled = true;
          }

          return this.runNotificationQuickFix(true).finally(() => {
            if (fixBtn) fixBtn.dataset.busy = "0";
            if (testBtn) testBtn.dataset.busy = "0";
            this.refreshNotificationGuideState();
          });
        },

        runNotificationGuideTest() {
          const fixBtn = document.getElementById("btnNotifyGuideFix");
          const testBtn = document.getElementById("btnNotifyGuideTest");
          const initialState = this.getSystemNotificationState().state;

          if (testBtn) {
            testBtn.dataset.busy = "1";
            testBtn.disabled = true;
            testBtn.textContent = STR.notifyActionConnecting;
          }
          if (fixBtn) {
            fixBtn.dataset.busy = "1";
            fixBtn.disabled = true;
          }

          return this.sendSystemNotificationTest()
            .then((ok) => {
              if (!ok && initialState !== "on") {
                alert(
                  this.getNotificationIssueMessage(
                    this.getSystemNotificationState(),
                  ),
                );
              }
              return ok;
            })
            .finally(() => {
              if (testBtn) testBtn.dataset.busy = "0";
              if (fixBtn) fixBtn.dataset.busy = "0";
              this.refreshNotificationGuideState();
            });
        },

        openNotificationGuide() {
          const sys = this.getSystemNotificationState();
          const issueText = this.getNotificationIssueMessage(sys);
          const setupText = this.getNotificationSetupMessage();
          const testDisabled =
            sys.state === "unsupported" || sys.state === "blocked";
          const html = `
            <div class="theme-card notify-guide-modal p-5 shadow-2xl animate-fade-in" onclick="ui.stopEvent(event)">
              <div class="notify-guide-head">
                <h3 class="text-lg font-black">${STR.notifyGuideTitle}</h3>
                <span id="notifyGuideState" class="notify-guide-state">${this.escapeHtml(sys.shortLabel)}</span>
              </div>
              <div class="notify-guide-scroll">
                <section class="notify-guide-block">
                  <h4>   </h4>
                  <pre id="notifyGuideIssueText" class="notify-guide-pre">${this.escapeHtml(issueText)}</pre>
                </section>
                <section class="notify-guide-block">
                  <h4>  </h4>
                  <pre id="notifyGuideSetupText" class="notify-guide-pre">${this.escapeHtml(setupText)}</pre>
                </section>
              </div>
              <div class="notify-guide-actions">
                <div class="notify-guide-actions-group">
                  <button id="btnNotifyGuideFix" type="button" onclick="app.runNotificationGuideQuickFix()" class="notify-action-btn notify-action-btn--fix">${STR.notifyActionFix}</button>
                  <button id="btnNotifyGuideTest" type="button" onclick="app.runNotificationGuideTest()" class="notify-action-btn notify-action-btn--test" ${testDisabled ? "disabled" : ""}>${STR.notifyActionTest}</button>
                </div>
                <button type="button" onclick="ui.closeModal()" class="notify-action-btn">${STR.cancel}</button>
              </div>
            </div>
          `;
          const overlay = document.getElementById("modalOverlay");
          if (!overlay) return;
          overlay.innerHTML = html;
          overlay.classList.remove("hidden");
          overlay.classList.add("flex");
          this.refreshNotificationGuideState(sys);
        },

        showSystemNotification(title, options = {}) {
          if (!("Notification" in window)) return false;
          if (Notification.permission !== "granted") return false;

          const tsRaw = options.timestamp;
          const tsDate = tsRaw instanceof Date ? tsRaw : new Date(tsRaw || 0);
          const safeTimestamp = Number.isNaN(tsDate.getTime())
            ? Date.now()
            : tsDate.getTime();

          const payload = {
            body: String(options.body || ""),
            tag: String(options.tag || ""),
            renotify: true,
            requireInteraction: true,
            timestamp: safeTimestamp,
            icon: "./notify-icon.svg",
            badge: "./notify-badge.svg",
            vibrate: [240, 110, 260],
            data: {
              url: window.location.href,
              source: "uni-schedule",
              ...(options.data && typeof options.data === "object"
                ? options.data
                : {}),
            },
          };

          const reg = this.swRegistration;
          if (!reg && this.supportsServiceWorkerNotifications()) {
            this.registerNotificationServiceWorker(false);
          }
          if (
            this.hasActiveServiceWorker(reg) &&
            typeof reg.showNotification === "function"
          ) {
            reg
              .showNotification(String(title || STR.alertBoard), payload)
              .catch((err) => {
                console.warn("SW showNotification failed:", err);
                this.notifyLastTestAt = Date.now();
                this.notifyLastTestOk = false;
                this.updateNotificationPermissionUI();
              });
            this.notifyLastTestAt = Date.now();
            this.notifyLastTestOk = true;
            return true;
          }

          try {
            const notify = new Notification(
              String(title || STR.alertBoard),
              payload,
            );
            notify.onclick = () => {
              window.focus();
              notify.close();
            };
            this.notifyLastTestAt = Date.now();
            this.notifyLastTestOk = true;
            return true;
          } catch (err) {
            console.warn("Notification failed:", err);
            this.notifyLastTestAt = Date.now();
            this.notifyLastTestOk = false;
            return false;
          }
        },

        getNotificationContextIssue() {
          if (
            typeof window !== "undefined" &&
            window.location &&
            window.location.protocol === "file:"
          ) {
            return "file";
          }
          if (typeof window !== "undefined" && !window.isSecureContext) {
            return "insecure";
          }
          return "";
        },

        getNotificationSetupMessage() {
          const issue = this.getNotificationContextIssue();
          const diag = this.getNotificationDiagnostics();
          const permission =
            "Notification" in window
              ? String(Notification.permission || "default")
              : "unsupported";
          const permLabel =
            permission === "granted"
              ? "  "
              : permission === "denied"
                ? " "
                : permission === "default"
                  ? "  "
                  : " ";
          const swSupported = this.supportsServiceWorkerNotifications();
          const swReady = this.hasActiveServiceWorker();
          const hasController = Boolean(navigator?.serviceWorker?.controller);
          const secureContext = Boolean(window.isSecureContext);
          const protocol = String(window.location?.protocol || "-");
          const displayModeStandalone = Boolean(
            window.matchMedia &&
            window.matchMedia("(display-mode: standalone)").matches,
          );
          const displayLabel = displayModeStandalone
            ? " (Standalone/PWA)"
            : " ";
          const swScope = this.swRegistration?.scope
            ? String(this.swRegistration.scope)
            : "-";
          const topReason =
            Array.isArray(diag.reasons) && diag.reasons.length > 0
              ? String(diag.reasons[0] || "").trim()
              : "";
          const base =
            issue === "file"
              ? STR.notifyContextFile
              : issue === "insecure"
                ? STR.notifyContextInsecure
                : STR.notifyPermissionHint;
          const origin = window.location?.origin || window.location?.href || "";
          const originLine = origin
            ? `\n\n  : ${origin}`
            : "";
          const pageName = (
            window.location?.pathname?.split("/").pop() || "index.html"
          ).trim();
          const localUrl = `http://localhost:8080/${pageName || "index.html"}`;
          const immediateAction =
            issue === "file"
              ? "   localhost/https    file://    ."
              : issue === "insecure"
                ? "   HTTPS  localhost       ."
                : permission === "denied"
                  ? "    Chrome     Block  Allow  ."
                  : permission !== "granted"
                    ? "  /        ."
                    : !swReady
                      ? " /            ."
                      : "    .     .";
          const statusSnapshot = [
            "   :",
            `-  : ${protocol}`,
            `-   (Secure Context): ${secureContext ? "" : ""}`,
            `-   : ${permLabel} (${permission})`,
            `-  : ${swSupported ? "" : ""}`,
            `-  : ${swReady ? "" : ""}`,
            `-     : ${hasController ? "" : ""}`,
            `-  : ${displayLabel}`,
            `- scope : ${swScope}`,
            Number(this.notifyLastCheckAt) > 0
              ? `-   : ${this.formatNotificationClock(this.notifyLastCheckAt)}`
              : "-   : -",
            topReason
              ? `-   : ${topReason}`
              : "-   :    ",
            `-   : ${immediateAction}`,
          ].join("\n");
          const mobileGuide = [
            "  (/):",
            "1)    HTTPS  localhost   ( file://).",
            "2)           .",
            "3)  Chrome: Settings > Site settings > Notifications     Allowed .",
            "4)  Android: Settings > Apps > Chrome > Notifications   .",
            "5)  Battery Saver/Background restriction  Chrome  PWA   .",
            "6)      /        .",
            "7)                 .",
            "8)  :  Do Not Disturb     Chrome     .",
          ].join("\n");
          const localGuide = [
            "   :",
            `1)     : py -m http.server 8080`,
            `2)     : ${localUrl}`,
            "3)      /        .",
            "4)      .",
            "5)    : Site settings > Notifications   Allow .",
          ].join("\n");
          const verifyGuide = [
            "  :",
            "1)         .",
            "2)          .",
            "3)     /       .",
            "4)              .",
          ].join("\n");
          const swGuide = [
            "  ",
            "1)              .",
            "2)              .",
            "3)               .",
            "4)   :   + HTTPS/localhost +      .",
          ].join("\n");
          const limitText =
            " :             Push    .               Push  .";
          return `${base}${originLine}\n\n${statusSnapshot}\n\n${localGuide}\n\n${mobileGuide}\n\n${verifyGuide}\n\n${swGuide}\n\n${limitText}`;
        },

        getSystemNotificationState() {
          const diag = this.getNotificationDiagnostics();
          const detail =
            Array.isArray(diag.reasons) && diag.reasons.length > 0
              ? String(diag.reasons[0] || "")
              : "";

          if (diag.stateHint === "unsupported") {
            return {
              state: "unsupported",
              enabled: false,
              label: STR.notifySystemUnsupported,
              shortLabel: STR.notifyUnsupportedShort,
              detail: detail || STR.notifyNotSupported,
            };
          }

          if (diag.stateHint === "blocked") {
            return {
              state: "blocked",
              enabled: false,
              label: STR.notifySystemBlocked,
              shortLabel: STR.notifyBlockedShort,
              detail: detail || STR.notifyPermissionDenied,
            };
          }

          if (diag.stateHint === "off") {
            return {
              state: "off",
              enabled: false,
              label: STR.notifySystemOff,
              shortLabel: STR.notifyOffShort,
              detail: detail || STR.notifyPermissionHint,
            };
          }

          if (diag.stateHint === "on") {
            const detailOn =
              detail ||
              (Array.isArray(diag.steps) && diag.steps.length > 0
                ? String(diag.steps[0] || "")
                : STR.notifyPermissionGranted);
            return {
              state: "on",
              enabled: true,
              label: STR.notifySystemOn,
              shortLabel: STR.notifyOnShort,
              detail: detailOn,
            };
          }

          return {
            state: "partial",
            enabled: false,
            label: STR.notifySystemPartial,
            shortLabel: STR.notifyPartialShort,
            detail: detail || "   .",
          };
        },

        openNotificationSettings() {
          const widget = document.getElementById("alertsWidget");
          if (widget) {
            widget.scrollIntoView({
              behavior: this.isMobilePerfContext() ? "auto" : "smooth",
              block: "center",
            });
            widget.classList.remove("notify-widget-focus");
            void widget.offsetWidth;
            widget.classList.add("notify-widget-focus");
            window.setTimeout(
              () => widget.classList.remove("notify-widget-focus"),
              1350,
            );
          }
          const sys = this.getSystemNotificationState();
          this.notifyLastCheckAt = Date.now();

          if (sys.state === "on") {
            this.showSystemNotification(
              "    ",
              {
                body: "      .",
                tag: "uni-notify-state-ok",
                timestamp: Date.now(),
              },
            );
            this.notifyLastTestAt = Date.now();
            this.notifyLastTestOk = true;
            this.updateNotificationPermissionUI();
            this.checkDueNotifications();
            return Promise.resolve("granted");
          }

          if (sys.state === "partial") {
            return this.registerNotificationServiceWorker(true)
              .then(() => {
                const repaired = this.getSystemNotificationState();
                this.updateNotificationPermissionUI();

                if (repaired.state === "on") {
                  const sent = this.showSystemNotification(
                    "   ",
                    {
                      body: "       .",
                      tag: "uni-notify-repaired",
                      timestamp: Date.now(),
                    },
                  );
                  this.notifyLastTestAt = Date.now();
                  this.notifyLastTestOk = Boolean(sent);
                  this.checkDueNotifications();
                  return "granted";
                }

                alert(this.getNotificationIssueMessage(repaired));
                return "partial";
              })
              .catch(() => {
                this.updateNotificationPermissionUI();
                alert(this.getNotificationIssueMessage(sys));
                return "partial";
              });
          }

          if (sys.state === "blocked" || sys.state === "unsupported") {
            alert(this.getNotificationIssueMessage(sys));
            this.updateNotificationPermissionUI();
            return Promise.resolve(sys.state);
          }

          return this.requestNotificationPermission(true).then((perm) => {
            if (perm !== "granted") return perm;
            return this.registerNotificationServiceWorker(true).then(() => {
              this.updateNotificationPermissionUI();
              this.checkDueNotifications();
              const finalState = this.getSystemNotificationState();
              if (finalState.state !== "on") {
                alert(this.getNotificationIssueMessage(finalState));
              }
              return perm;
            });
          });
        },

        updateNotificationPermissionUI() {
          const btn = document.getElementById("btnNotifyPermission");
          const bellBtn = document.getElementById("btnNotifyBell");
          const bellTxt = document.getElementById("txtNotifyBellState");
          const statusHint = document.getElementById("notifyStatusHint");
          const statusTitle = document.getElementById("txtNotifyStatusTitle");
          const statusDetail = document.getElementById("txtNotifyStatusDetail");

          const sys = this.getSystemNotificationState();
          const detailText = String(sys.detail || "").trim();

          if (btn) {
            const permState =
              sys.state === "on"
                ? "granted"
                : sys.state === "partial"
                  ? "partial"
                  : sys.state === "blocked"
                    ? "denied"
                    : sys.state === "unsupported"
                      ? "unsupported"
                      : "default";
            btn.dataset.state = permState;
            btn.disabled = false;
            btn.title = `${sys.label}\n${detailText}`;
          }

          if (bellBtn) {
            bellBtn.dataset.state = sys.state;
            bellBtn.title = `${sys.label}\n${detailText}\n\n      .`;
            bellBtn.setAttribute("aria-label", sys.label);
            bellBtn.setAttribute(
              "aria-pressed",
              sys.enabled ? "true" : "false",
            );
          }
          if (bellTxt) bellTxt.textContent = sys.shortLabel;

          if (statusHint) {
            statusHint.dataset.state = sys.state;
            statusHint.title = `${sys.label}\n${detailText}\n\n    .`;
          }
          if (statusTitle) statusTitle.textContent = sys.label;
          if (statusDetail) {
            statusDetail.textContent = detailText || STR.notifySystemOpen;
          }
          this.renderNotificationConnectPanel(
            sys,
            this.getNotificationDiagnostics(),
          );
        },

        requestNotificationPermission(showFeedback = false) {
          const issue = this.getNotificationContextIssue();
          if (issue) {
            this.updateNotificationPermissionUI();
            if (showFeedback) alert(this.getNotificationSetupMessage());
            return Promise.resolve("unsupported");
          }

          if (!("Notification" in window)) {
            this.updateNotificationPermissionUI();
            if (showFeedback) alert(STR.notifyNotSupported);
            return Promise.resolve("unsupported");
          }

          if (Notification.permission === "granted") {
            return this.registerNotificationServiceWorker(true).then(() => {
              this.updateNotificationPermissionUI();
              if (showFeedback) {
                const sent = this.showSystemNotification(
                  "   ",
                  {
                    body: "     .",
                    tag: "uni-notify-test",
                    timestamp: Date.now(),
                  },
                );
                this.notifyLastTestAt = Date.now();
                this.notifyLastTestOk = Boolean(sent);
                alert(STR.notifyPermissionGranted);
              }
              this.notifyLastCheckAt = Date.now();
              this.checkDueNotifications();
              return "granted";
            });
          }

          if (Notification.permission === "denied") {
            this.updateNotificationPermissionUI();
            if (showFeedback)
              alert(
                `${STR.notifyPermissionDenied}\n\n${this.getNotificationSetupMessage()}`,
              );
            return Promise.resolve("denied");
          }

          return Notification.requestPermission()
            .then((perm) => {
              if (perm !== "granted") {
                this.updateNotificationPermissionUI();
                if (showFeedback) {
                  if (perm === "denied")
                    alert(
                      `${STR.notifyPermissionDenied}\n\n${this.getNotificationSetupMessage()}`,
                    );
                  else alert(this.getNotificationSetupMessage());
                }
                return perm;
              }

              return this.registerNotificationServiceWorker(true).then(() => {
                this.updateNotificationPermissionUI();
                if (showFeedback) {
                  const sent = this.showSystemNotification(
                    "   ",
                    {
                      body: "   /  .",
                      tag: "uni-notify-test",
                      timestamp: Date.now(),
                    },
                  );
                  this.notifyLastTestAt = Date.now();
                  this.notifyLastTestOk = Boolean(sent);
                  alert(STR.notifyPermissionGranted);
                }
                this.notifyLastCheckAt = Date.now();
                this.checkDueNotifications();
                return perm;
              });
            })
            .catch(() => {
              this.updateNotificationPermissionUI();
              return "default";
            });
        },

        startNotificationLoop() {
          if (this.notificationLoopId) return;

          const run = () => {
            if (
              typeof window !== "undefined" &&
              "Notification" in window &&
              Notification.permission === "granted" &&
              !this.hasActiveServiceWorker()
            ) {
              this.registerNotificationServiceWorker(false);
            }
            this.checkDueNotifications();
          };
          this.notificationLoopId = window.setInterval(
            run,
            PERF_PROFILE.loopMs,
          );
          run();

          if (!this.notificationVisibilityBound) {
            document.addEventListener("visibilitychange", () => {
              if (document.visibilityState === "visible")
                this.checkDueNotifications();
            });
            window.addEventListener("focus", () =>
              this.checkDueNotifications(),
            );
            this.notificationVisibilityBound = true;
          }
        },

        startLiveUiLoop() {
          if (this.liveUiLoopId) return;

          const run = () => {
            if (
              typeof document !== "undefined" &&
              document.visibilityState === "hidden"
            ) {
              return;
            }
            if (this.isMobilePerfContext() && this.isMobileScrollingNow()) {
              const nowMs = Date.now();
              const ultraScrolling =
                typeof document !== "undefined" &&
                document.body?.classList.contains("mobile-scrolling-ultra");
              const minTickGapMs = ultraScrolling ? 360 : 220;
              if (nowMs - Number(this.mobileLiveTickAt || 0) < minTickGapMs) {
                return;
              }
              this.mobileLiveTickAt = nowMs;
              return;
            }
            this.mobileLiveTickAt = 0;
            const now = new Date();
            this.applyUltraMood();
            if (this.syncAutoWeek()) {
              this.refreshUI();
              return;
            }
            ui.renderNextClass();
            this.refreshSessionVisualsIfNeeded(now);
            this.refreshExamVisualsIfNeeded(now);
            ui.renderPinnedAlerts();
          };

          this.liveUiLoopId = window.setInterval(run, PERF_PROFILE.loopMs);
          run();

          if (!this.liveUiVisibilityBound) {
            document.addEventListener("visibilitychange", () => {
              if (document.visibilityState === "visible") run();
            });
            window.addEventListener("focus", run);
            this.liveUiVisibilityBound = true;
          }
        },

        triggerNotification(note, fireAt) {
          if (!("Notification" in window)) return false;
          if (Notification.permission !== "granted") return false;

          const cls = this.data.classes.find((c) => c.id === note.classId);
          const className = cls ? cls.name : STR.unknownClass;
          const bodyParts = [
            className,
            `${STR.alertDay}: ${this.getAlertDayLabel(note.alertDate)}`,
            `${STR.alertTime}: ${note.alertTime || "-"}`,
            note.text || "",
          ].filter(Boolean);
          const title = note.notifyText || note.text || STR.alertBoard;
          return this.showSystemNotification(title, {
            body: bodyParts.join("\n"),
            tag: `uni-note-${note.id}`,
            timestamp: fireAt ? fireAt.getTime() : Date.now(),
            data: { type: "note", noteId: Number(note.id) || 0 },
          });
        },

        triggerExamNotification(exam, fireAt) {
          if (!("Notification" in window)) return false;
          if (Notification.permission !== "granted") return false;

          const className = String(
            exam.courseName || this.getCourseNameByClassId(exam.classId),
          ).trim();
          const examAt = this.getExamDateTime(exam);
          const remainMeta = this.getCountdownMeta(
            examAt,
            fireAt || new Date(),
          );
          const bodyParts = [
            className ? `${STR.noteClass}: ${className}` : "",
            `${STR.alertDay}: ${this.getAlertDayLabel(exam.date)}`,
            `${STR.alertTime}: ${exam.time || "-"}`,
            remainMeta.hasTarget ? ` ${remainMeta.detailText}` : "",
            exam.location || "",
          ].filter(Boolean);
          const title = exam.notifyText || exam.title || STR.examReminder;
          return this.showSystemNotification(title, {
            body: bodyParts.join("\n"),
            tag: `uni-exam-${exam.id}`,
            timestamp: fireAt ? fireAt.getTime() : Date.now(),
            data: { type: "exam", examId: Number(exam.id) || 0 },
          });
        },

        checkDueNotifications() {
          if (this.notificationCheckRunning) return;
          this.notificationCheckRunning = true;
          this.updateNotificationPermissionUI();

          try {
            if (!("Notification" in window)) return;
            if (Notification.permission !== "granted") return;
            if (!this.hasActiveServiceWorker()) {
              this.registerNotificationServiceWorker(false);
            }

            const nowMs = Date.now();
            let changed = false;

            this.data.notes = this.data.notes.map((note) => {
              if (!this.isNoteSchedulable(note)) return note;

              const alertAt = this.getAlertDateTime(note);
              if (!alertAt) return note;

              const fireAtMs =
                alertAt.getTime() - Number(note.notifyBeforeMin || 0) * 60000;
              const signature = this.getNoteNotificationSignature(note);
              const alreadyNotified =
                note.lastNotifiedSignature === signature &&
                typeof note.lastNotifiedAt === "string" &&
                note.lastNotifiedAt.length > 0;

              if (alreadyNotified) return note;
              if (nowMs < fireAtMs) return note;
              if (nowMs - fireAtMs > NOTIFY_LATE_GRACE_MS) return note;

              const sent = this.triggerNotification(note, new Date(fireAtMs));
              if (!sent) return note;

              changed = true;
              return {
                ...note,
                lastNotifiedSignature: signature,
                lastNotifiedAt: new Date().toISOString(),
              };
            });

            this.data.exams = this.data.exams.map((exam) => {
              if (!this.isExamSchedulable(exam)) return exam;

              const fireAt = this.getExamNotificationDateTime(exam);
              if (!(fireAt instanceof Date) || Number.isNaN(fireAt.getTime()))
                return exam;
              const fireAtMs = fireAt.getTime();
              const signature = this.getExamNotificationSignature(exam);
              const alreadyNotified =
                exam.lastNotifiedSignature === signature &&
                typeof exam.lastNotifiedAt === "string" &&
                exam.lastNotifiedAt.length > 0;

              if (alreadyNotified) return exam;
              if (nowMs < fireAtMs) return exam;
              if (nowMs - fireAtMs > NOTIFY_LATE_GRACE_MS) return exam;

              const sent = this.triggerExamNotification(exam, fireAt);
              if (!sent) return exam;

              changed = true;
              return {
                ...exam,
                lastNotifiedSignature: signature,
                lastNotifiedAt: new Date().toISOString(),
              };
            });

            const weeklyReminder = this.getWeeklyFoodReminderInfo(
              new Date(nowMs),
            );
            if (
              weeklyReminder &&
              !this.hasFoodReminderNotified(weeklyReminder.key)
            ) {
              const startAt = this.getWeeklyFoodReminderStart(new Date(nowMs));
              if (startAt && nowMs >= startAt.getTime()) {
                const sent = this.triggerFoodReminderNotification(
                  weeklyReminder,
                  startAt,
                );
                if (sent) {
                  this.markFoodReminderNotified(weeklyReminder.key);
                  changed = true;
                }
              }
            }

            const attendanceReminderEnabled =
              this.data?.settings?.attendanceReminderEnabled !== false;
            if (attendanceReminderEnabled) {
              const todayKey = this.getDateKey(new Date(nowMs));
              const reminderTime = this.normalizeTime(
                this.data?.settings?.attendanceReminderTime,
                DEFAULT_SETTINGS.attendanceReminderTime,
              );
              const reminderAt = new Date(`${todayKey}T${reminderTime}:00`);
              const alreadyReminded = Boolean(
                this.data.attendanceReminderLog?.[todayKey],
              );

              if (
                !alreadyReminded &&
                !Number.isNaN(reminderAt.getTime()) &&
                nowMs >= reminderAt.getTime()
              ) {
                const missingCourses =
                  this.getAttendanceMissingCourses(todayKey);
                const riskCourses = this.getAttendanceRiskCourses();
                if (missingCourses.length > 0 || riskCourses.length > 0) {
                  const missingPreview = missingCourses
                    .slice(0, 3)
                    .map((course) => String(course?.name || "").trim())
                    .filter(Boolean);
                  const riskPreview = riskCourses
                    .slice(0, 2)
                    .map((course) => String(course?.name || "").trim())
                    .filter(Boolean);
                  const missingRemain = Math.max(
                    0,
                    missingCourses.length - missingPreview.length,
                  );
                  const riskRemain = Math.max(
                    0,
                    riskCourses.length - riskPreview.length,
                  );

                  const bodyParts = [
                    missingCourses.length > 0
                      ? STR.attendanceReminderBody
                      : STR.attendanceReminderRiskOnlyBody,
                  ];
                  if (missingCourses.length > 0) {
                    bodyParts.push(
                      `${STR.attendanceSummaryPending}: ${missingCourses.length.toLocaleString("fa-IR")}`,
                    );
                    if (missingPreview.length > 0) {
                      let missingLine = missingPreview.join(" ");
                      if (missingRemain > 0) {
                        missingLine += ` +${missingRemain.toLocaleString("fa-IR")}  `;
                      }
                      bodyParts.push(missingLine);
                    }
                  }
                  if (riskCourses.length > 0) {
                    let riskLine = `${STR.attendanceReminderRiskLine}: ${riskCourses.length.toLocaleString("fa-IR")}`;
                    if (riskPreview.length > 0) {
                      riskLine += ` (${riskPreview.join(" ")}`;
                      if (riskRemain > 0) {
                        riskLine += ` +${riskRemain.toLocaleString("fa-IR")}  `;
                      }
                      riskLine += ")";
                    }
                    bodyParts.push(riskLine);
                  }
                  bodyParts.push(STR.attendanceReminderActionLine);

                  const sent = this.showSystemNotification(
                    STR.attendanceReminderTitle,
                    {
                      body: bodyParts.join("\n"),
                      tag: `uni-attendance-reminder-${todayKey}`,
                      timestamp: reminderAt.getTime(),
                      data: {
                        type: "attendance",
                        dateKey: todayKey,
                        missingCourses: missingCourses.length,
                        riskCourses: riskCourses.length,
                      },
                    },
                  );
                  if (sent) {
                    if (
                      !this.data.attendanceReminderLog ||
                      typeof this.data.attendanceReminderLog !== "object"
                    ) {
                      this.data.attendanceReminderLog = {};
                    }
                    this.data.attendanceReminderLog[todayKey] =
                      new Date().toISOString();
                    changed = true;
                  } else if (
                    typeof document !== "undefined" &&
                    !document.hidden
                  ) {
                    const previewText = bodyParts.length
                      ? `\n${bodyParts.join("\n")}`
                      : "";
                    window.alert(
                      `${STR.attendanceReminderTitle}${previewText}`,
                    );
                    if (
                      !this.data.attendanceReminderLog ||
                      typeof this.data.attendanceReminderLog !== "object"
                    ) {
                      this.data.attendanceReminderLog = {};
                    }
                    this.data.attendanceReminderLog[todayKey] =
                      new Date().toISOString();
                    changed = true;
                  }
                }
              }
            }

            const reminderLogSize = Object.keys(
              this.data.attendanceReminderLog || {},
            ).length;
            this.pruneAttendanceReminderLog(90);
            if (
              Object.keys(this.data.attendanceReminderLog || {}).length !==
              reminderLogSize
            ) {
              changed = true;
            }

            if (changed) this.persist();
          } finally {
            this.notificationCheckRunning = false;
          }
        },

        setView(v, silent = false) {
          const view = v === "list" ? "list" : "grid";
          const viewChanged =
            String(this.data.settings.view || "grid") !== view;
          this.data.settings.view = view;

          const viewGridBtn = document.getElementById("viewGrid");
          const viewListBtn = document.getElementById("viewList");
          if (viewGridBtn) {
            viewGridBtn.className =
              view === "grid"
                ? "px-3 py-2 rounded-xl text-sm font-black flex items-center gap-2 bg-[var(--accent)] text-[var(--bg)] shadow-lg"
                : "px-3 py-2 rounded-xl text-sm font-black flex items-center gap-2 opacity-50";
          }
          if (viewListBtn) {
            viewListBtn.className =
              view === "list"
                ? "px-3 py-2 rounded-xl text-sm font-black flex items-center gap-2 bg-[var(--accent)] text-[var(--bg)] shadow-lg"
                : "px-3 py-2 rounded-xl text-sm font-black flex items-center gap-2 opacity-50";
          }

          if (!silent && viewChanged) {
            this.save({ syncReason: "view-mode-switch" });
          }
        },

        toggleAnim(forceState, silent = false) {
          const newState =
            typeof forceState === "boolean"
              ? forceState
              : !this.data.settings.anim;
          this.setAnimEnabled(newState, silent);
        },

        search(q) {
          this.data.searchQuery = (q || "").toLowerCase();

          if (this.searchRenderRafId) {
            window.cancelAnimationFrame(this.searchRenderRafId);
          }
          this.searchRenderRafId = window.requestAnimationFrame(() => {
            this.searchRenderRafId = null;
            this.syncAutoWeek();
            ui.renderSchedule();
            ui.renderNextClass();
          });

          if (this.searchPersistTimerId) {
            window.clearTimeout(this.searchPersistTimerId);
          }
          const persistDelay = PERF_PROFILE.lite ? 700 : 300;
          this.searchPersistTimerId = window.setTimeout(() => {
            this.searchPersistTimerId = null;
            this.persist();
            if (typeof cloudSync !== "undefined") {
              cloudSync.onLocalStateChanged("search");
            }
          }, persistDelay);
        },

        resetData() {
          if (confirm(STR.alertReset)) {
            const activeTermNo = this.getActiveTermNo();
            const defaultClassesForTerm =
              activeTermNo === DEFAULT_TERM_NO ? DEFAULT_CLASSES : [];
            this.data.classes = this.normalizeData({
              classes: defaultClassesForTerm,
            }).classes;
            this.data.exams = [];
            this.data.notes = [];
            this.data.handouts = [];
            this.data.courseProgress = [];
            this.data.attendance = {};
            this.data.searchQuery = "";
            this.data.dismissedReminders = {};
            this.data.notifiedReminders = {};
            this.data.dismissedPinnedAlerts = {};
            this.data.attendanceReminderLog = {};
            this.data.settings.attendanceActiveDate = "";

            const searchInput = document.getElementById("searchInput");
            if (searchInput) searchInput.value = "";

            this.save();
          }
        },

        addClass(c) {
          const requestedType = String(c?.type || "normal");
          const classType = ["normal", "odd", "even"].includes(requestedType)
            ? requestedType
            : "normal";
          const normalizedOffset = this.normalizeSessionOffset(
            c?.sessionOffset,
          );
          const normalizedOffsetManual =
            Boolean(c?.sessionOffsetManual) && normalizedOffset > 0;
          const normalized = {
            ...c,
            type: classType,
            note: this.sanitizeClassNoteByType(classType, c?.note),
            sessionOffset: normalizedOffset,
            sessionOffsetManual: normalizedOffsetManual,
          };
          if (c.id)
            this.data.classes = this.data.classes.map((x) =>
              x.id === c.id ? normalized : x,
            );
          else {
            let newId = Date.now();
            while (this.data.classes.some((x) => Number(x.id) === newId)) {
              newId += 1;
            }
            normalized.id = newId;
            this.data.classes.push(normalized);
          }
          const normalizedCourseKey = this.normalizeCourseSessionKey(
            normalized.name,
          );
          if (normalizedCourseKey) {
            const sharedOffset = normalizedOffset;
            const sharedOffsetManual = normalizedOffsetManual;
            this.data.classes = this.data.classes.map((item) =>
              this.normalizeCourseSessionKey(
                item?.name || item?.courseName || "",
              ) === normalizedCourseKey
                ? {
                    ...item,
                    sessionOffset: sharedOffset,
                    sessionOffsetManual: sharedOffsetManual,
                  }
                : item,
            );
          }
          ui.closeModal();
          this.save();
        },

        deleteClass(id) {
          const removed = this.data.classes.find((x) => x.id === id) || null;
          const removedName = String(removed?.name || "").trim();

          this.data.classes = this.data.classes.filter((x) => x.id !== id);
          this.data.notes = this.data.notes.filter((x) => x.classId !== id);
          this.data.exams = this.data.exams
            .map((x) => {
              const removedFallback =
                Number(x.classId) === Number(id) ? removedName : "";
              const baseName = String(
                x.courseName ||
                  this.getCourseNameByClassId(x.classId) ||
                  removedFallback,
              ).trim();
              const matched = this.findClassByCourseName(baseName);
              if (!matched && !baseName) return null;
              return {
                ...x,
                classId: matched ? Number(matched.id) : null,
                courseName: matched
                  ? String(matched.name || baseName).trim()
                  : baseName,
              };
            })
            .filter((x) => x && this.normalizeCourseKey(x.courseName));
          this.prunePinnedAlertDismissals();
          this.data.courseProgress = this.data.courseProgress
            .map((x) => {
              const baseName = String(
                x.courseName ||
                  this.getCourseNameByClassId(x.classId) ||
                  removedName,
              ).trim();
              const matched = this.findClassByCourseName(baseName);
              if (!matched) return null;
              return {
                ...x,
                classId: Number(matched.id),
                courseName: String(matched.name || baseName).trim(),
              };
            })
            .filter((x) => x && this.normalizeCourseKey(x.courseName));
          ui.closeModal();
          this.save();
        },

        addExam(e) {
          const selectedClassId = Number.isFinite(Number(e.classId))
            ? Number(e.classId)
            : null;
          const selectedClass = selectedClassId
            ? this.data.classes.find((c) => Number(c.id) === selectedClassId)
            : null;
          const rawCourseName = String(
            selectedClass?.name || e.courseName || "",
          ).trim();
          const matchedClass = this.findClassByCourseName(rawCourseName);

          const normalized = {
            ...e,
            classId: matchedClass ? Number(matchedClass.id) : selectedClassId,
            courseName: matchedClass
              ? String(matchedClass.name || rawCourseName).trim()
              : rawCourseName,
            title: String(e.title || "").trim(),
            date:
              typeof e.date === "string" && /^\d{4}-\d{2}-\d{2}$/.test(e.date)
                ? e.date
                : "",
            time: this.normalizeTime(e.time, "09:00"),
            location: String(e.location || "").trim(),
            notifyDate: this.normalizeDateKey(e.notifyDate),
            notifyTime: this.normalizeTime(e.notifyTime, ""),
            notifyBeforeMin: NOTIFY_BEFORE_OPTIONS.includes(
              Number(e.notifyBeforeMin),
            )
              ? Number(e.notifyBeforeMin)
              : 0,
            notifyText: String(e.notifyText || "").trim(),
            notifyEnabled:
              typeof e.notifyEnabled === "boolean" ? e.notifyEnabled : true,
            lastNotifiedSignature: "",
            lastNotifiedAt: "",
          };
          if (!normalized.notifyEnabled) {
            normalized.notifyDate = "";
            normalized.notifyTime = "";
          }

          if (!this.normalizeCourseKey(normalized.courseName)) return;
          if (!normalized.title) return;
          if (!normalized.date || !normalized.time) return;

          if (e.id)
            this.data.exams = this.data.exams.map((x) =>
              x.id === e.id ? normalized : x,
            );
          else {
            normalized.id = Date.now();
            this.data.exams.push(normalized);
          }
          ui.closeModal();
          this.save();
          this.checkDueNotifications();
        },

        deleteExam(id) {
          this.data.exams = this.data.exams.filter((x) => x.id !== id);
          ui.closeModal();
          this.save();
        },

        addNote(n) {
          const important = Boolean(n.important);
          const normalized = {
            ...n,
            text: String(n.text || "").trim(),
            important,
            alertDate:
              important &&
              typeof n.alertDate === "string" &&
              /^\d{4}-\d{2}-\d{2}$/.test(n.alertDate)
                ? n.alertDate
                : "",
            alertTime: important ? this.normalizeTime(n.alertTime, "") : "",
            notifyBeforeMin:
              important &&
              NOTIFY_BEFORE_OPTIONS.includes(Number(n.notifyBeforeMin))
                ? Number(n.notifyBeforeMin)
                : 0,
            notifyText: important ? String(n.notifyText || "").trim() : "",
            notifyEnabled: important
              ? typeof n.notifyEnabled === "boolean"
                ? n.notifyEnabled
                : true
              : false,
            lastNotifiedSignature: "",
            lastNotifiedAt: "",
          };

          if (n.id)
            this.data.notes = this.data.notes.map((x) =>
              x.id === n.id ? normalized : x,
            );
          else {
            normalized.id = Date.now();
            this.data.notes.push(normalized);
          }
          this.clearPinnedNoteDismissal(normalized.id || n.id);
          this.prunePinnedAlertDismissals();
          ui.closeModal();
          this.save();
          this.checkDueNotifications();
        },

        deleteNote(id) {
          this.data.notes = this.data.notes.filter((x) => x.id !== id);
          this.clearPinnedNoteDismissal(id);
          this.prunePinnedAlertDismissals();
          ui.closeModal();
          this.save();
        },

        addHandout(item) {
          const courses = this.getUniqueCourses();
          const requestedCourseKey = this.normalizeCourseKey(item.courseKey);
          const selectedCourse =
            courses.find((c) => c.key === requestedCourseKey) || null;
          const rawCourseName = String(
            selectedCourse?.name || item.courseName || "",
          ).trim();
          const courseKey = this.normalizeCourseKey(rawCourseName);
          const link = this.normalizeUrl(item.link);
          const rawAttachmentData = String(item.attachmentData || "").trim();
          const attachmentData =
            rawAttachmentData.startsWith("data:") &&
            rawAttachmentData.length <= HANDOUT_MAX_DATAURL_LEN
              ? rawAttachmentData
              : "";
          const attachmentType = attachmentData
            ? item.attachmentType === "image"
              ? "image"
              : "file"
            : "";
          const note = String(item.note || "").trim();
          const title = String(item.title || "").trim();

          if (!courseKey || !title) return false;
          if (!link && !attachmentData) return false;

          const nowIso = new Date().toISOString();
          const normalized = {
            id: Number(item.id) || Date.now(),
            classId: selectedCourse ? Number(selectedCourse.classId) : null,
            courseKey,
            courseName: selectedCourse
              ? String(selectedCourse.name || rawCourseName).trim()
              : rawCourseName,
            title,
            link,
            attachmentType,
            attachmentName: attachmentData
              ? String(item.attachmentName || "").trim()
              : "",
            attachmentMime: attachmentData
              ? String(item.attachmentMime || "").trim()
              : "",
            attachmentData,
            note,
            createdAt: String(item.createdAt || nowIso),
            updatedAt: nowIso,
          };

          if (item.id) {
            this.data.handouts = this.data.handouts.map((x) =>
              Number(x.id) === Number(item.id)
                ? {
                    ...normalized,
                    createdAt: x.createdAt || normalized.createdAt,
                  }
                : x,
            );
          } else {
            normalized.id = Date.now();
            this.data.handouts.push(normalized);
          }

          ui.closeModal();
          const ok = this.save();
          if (!ok) alert(STR.handoutSaveFailed);
          return true;
        },

        deleteHandout(id) {
          const targetId = Number(id);
          if (!Number.isFinite(targetId)) return;
          this.data.handouts = this.data.handouts.filter(
            (x) => Number(x.id) !== targetId,
          );
          ui.closeModal();
          this.save();
        },

        addCourseProgress(p) {
          const requestedClassId = Number.isFinite(Number(p.classId))
            ? Number(p.classId)
            : null;
          const selectedClass = requestedClassId
            ? this.data.classes.find((c) => Number(c.id) === requestedClassId)
            : null;
          const rawCourseName = String(
            selectedClass?.name || p.courseName || "",
          ).trim();
          const courseKey = this.normalizeCourseKey(rawCourseName);
          const matchedClass = this.findClassByCourseName(rawCourseName);

          const normalized = {
            ...p,
            classId: matchedClass ? Number(matchedClass.id) : requestedClassId,
            courseName: matchedClass
              ? String(matchedClass.name || rawCourseName).trim()
              : rawCourseName,
            taughtUntil: String(p.taughtUntil || "").trim(),
            coveragePercent: Math.min(
              100,
              Math.max(0, Number(p.coveragePercent) || 0),
            ),
            sessionNo: Math.max(0, Math.floor(Number(p.sessionNo) || 0)),
            nextTopic: String(p.nextTopic || "").trim(),
            updatedAt: new Date().toISOString(),
          };

          if (!courseKey) return;
          if (!normalized.taughtUntil) return;

          const currentId = Number.isFinite(Number(p.id)) ? Number(p.id) : null;
          const existingSameCourse = this.data.courseProgress.find(
            (x) =>
              this.normalizeCourseKey(
                x.courseName || this.getCourseNameByClassId(x.classId),
              ) === courseKey && x.id !== currentId,
          );

          if (p.id) {
            normalized.id = Number(p.id);
            this.data.courseProgress = this.data.courseProgress.map((x) =>
              x.id === normalized.id ? normalized : x,
            );
            if (existingSameCourse) {
              this.data.courseProgress = this.data.courseProgress.filter(
                (x) => x.id !== existingSameCourse.id,
              );
            }
          } else if (existingSameCourse) {
            normalized.id = existingSameCourse.id;
            this.data.courseProgress = this.data.courseProgress.map((x) =>
              x.id === existingSameCourse.id ? normalized : x,
            );
          } else {
            normalized.id = Date.now();
            this.data.courseProgress.push(normalized);
          }

          ui.closeModal();
          this.save();
        },

        deleteCourseProgress(id) {
          this.data.courseProgress = this.data.courseProgress.filter(
            (x) => x.id !== id,
          );
          ui.closeModal();
          this.save();
        },

        toggleNoteImportant(id, important) {
          this.data.notes = this.data.notes.map((n) =>
            n.id === id
              ? {
                  ...n,
                  important:
                    typeof important === "boolean" ? important : !n.important,
                  notifyEnabled:
                    typeof important === "boolean"
                      ? important
                      : !n.important || n.notifyEnabled,
                  lastNotifiedSignature: "",
                  lastNotifiedAt: "",
                }
              : n,
          );
          const target = this.data.notes.find(
            (n) => Number(n.id) === Number(id),
          );
          if (!target || !target.important) {
            this.clearPinnedNoteDismissal(id);
          }
          this.prunePinnedAlertDismissals();
          this.save();
          this.checkDueNotifications();
        },

        checkConflict(c1, c2) {
          if (c1.day !== c2.day) return false;
          if (c1.id === c2.id) return false;
          return c1.start < c2.end && c1.end > c2.start;
        },

        getWeekClasses() {
          const week = this.data.settings.week;
          return this.data.classes.filter(
            (c) => c.type === "normal" || c.type === week,
          );
        },

        getVisibleClasses() {
          const q = this.data.searchQuery;
          return this.getWeekClasses().filter((c) => {
            const hay = (
              c.name +
              " " +
              (c.classNo || "") +
              " " +
              (c.prof || "") +
              " " +
              (c.note || "")
            ).toLowerCase();
            return !q || hay.includes(q);
          });
        },

        clearDeferredHeavyUiRenders() {
          if (typeof window === "undefined") {
            this.deferredHeavyRenderTimerId = 0;
            this.deferredHeavyRenderIdleId = 0;
            this.deferredHeavyRenderPending = false;
            this.deferredHeavyRenderDueAt = 0;
            return;
          }
          if (this.deferredHeavyRenderTimerId) {
            window.clearTimeout(this.deferredHeavyRenderTimerId);
            this.deferredHeavyRenderTimerId = 0;
          }
          if (
            this.deferredHeavyRenderIdleId &&
            typeof window.cancelIdleCallback === "function"
          ) {
            window.cancelIdleCallback(this.deferredHeavyRenderIdleId);
          }
          this.deferredHeavyRenderIdleId = 0;
          this.deferredHeavyRenderPending = false;
          this.deferredHeavyRenderDueAt = 0;
        },

        runHeavyUiRenders() {
          if (this.isMobilePerfContext() && this.isMobileScrollingNow()) {
            this.mobilePendingRefresh = true;
            this.scheduleDeferredHeavyUiRenders();
            return;
          }
          this.clearDeferredHeavyUiRenders();
          if (this.isAutoMobilePerfContext() && typeof window !== "undefined") {
            if (this.autoHeavyFollowupTimerId) {
              window.clearTimeout(this.autoHeavyFollowupTimerId);
              this.autoHeavyFollowupTimerId = 0;
            }
            if (
              this.autoHeavyFollowupIdleId &&
              typeof window.cancelIdleCallback === "function"
            ) {
              window.cancelIdleCallback(this.autoHeavyFollowupIdleId);
              this.autoHeavyFollowupIdleId = 0;
            }

            // Keep high-priority widgets fast, defer heaviest blocks to idle.
            ui.renderExams();
            ui.renderNotes();
            ui.renderHandouts();
            ui.renderAlerts();

            const runHeavyTail = () => {
              this.autoHeavyFollowupTimerId = 0;
              this.autoHeavyFollowupIdleId = 0;
              if (this.isMobilePerfContext() && this.isMobileScrollingNow()) {
                this.mobilePendingRefresh = true;
                this.scheduleDeferredHeavyUiRenders();
                return;
              }
              ui.renderCourseProgress();
              ui.renderAttendance();
            };
            if (typeof window.requestIdleCallback === "function") {
              this.autoHeavyFollowupIdleId = window.requestIdleCallback(
                () => {
                  runHeavyTail();
                },
                { timeout: 1200 },
              );
            } else {
              this.autoHeavyFollowupTimerId = window.setTimeout(
                runHeavyTail,
                140,
              );
            }
            return;
          }
          if (typeof window !== "undefined") {
            if (this.autoHeavyFollowupTimerId) {
              window.clearTimeout(this.autoHeavyFollowupTimerId);
              this.autoHeavyFollowupTimerId = 0;
            }
            if (
              this.autoHeavyFollowupIdleId &&
              typeof window.cancelIdleCallback === "function"
            ) {
              window.cancelIdleCallback(this.autoHeavyFollowupIdleId);
              this.autoHeavyFollowupIdleId = 0;
            }
          }
          ui.renderExams();
          ui.renderNotes();
          ui.renderHandouts();
          ui.renderCourseProgress();
          ui.renderAttendance();
          ui.renderAlerts();
        },

        scheduleDeferredHeavyUiRenders() {
          if (typeof window === "undefined") {
            this.runHeavyUiRenders();
            return;
          }

          let deferMs = PERF_PROFILE.ultraLite
            ? 320
            : PERF_PROFILE.lite
              ? 220
              : 130;
          let idleTimeout = PERF_PROFILE.ultraLite
            ? 1400
            : PERF_PROFILE.lite
              ? 900
              : 520;
          const mobilePerf = this.isMobilePerfContext();
          const ultraSmooth =
            typeof document !== "undefined" &&
            document.body?.getAttribute("data-mobile-ultra-smooth") === "on";
          const isMobileScrolling = mobilePerf && this.isMobileScrollingNow();
          if (ultraSmooth && mobilePerf) {
            deferMs = Math.max(deferMs, 320);
            idleTimeout = Math.max(idleTimeout, 1300);
          }
          if (isMobileScrolling) {
            deferMs = Math.max(deferMs, ultraSmooth ? 520 : 360);
            idleTimeout = Math.max(idleTimeout, ultraSmooth ? 1800 : 1400);
          }

          const nowMs = Date.now();
          if (
            isMobileScrolling &&
            this.deferredHeavyRenderPending &&
            this.deferredHeavyRenderTimerId &&
            Number(this.deferredHeavyRenderDueAt || 0) - nowMs > 90
          ) {
            return;
          }

          if (this.deferredHeavyRenderTimerId) {
            window.clearTimeout(this.deferredHeavyRenderTimerId);
            this.deferredHeavyRenderTimerId = 0;
          }
          if (
            this.deferredHeavyRenderIdleId &&
            typeof window.cancelIdleCallback === "function"
          ) {
            window.cancelIdleCallback(this.deferredHeavyRenderIdleId);
            this.deferredHeavyRenderIdleId = 0;
          }
          this.deferredHeavyRenderPending = true;

          const runNow = () => {
            this.deferredHeavyRenderPending = false;
            this.deferredHeavyRenderDueAt = 0;
            this.runHeavyUiRenders();
          };

          this.deferredHeavyRenderDueAt = nowMs + deferMs;
          this.deferredHeavyRenderTimerId = window.setTimeout(() => {
            this.deferredHeavyRenderTimerId = 0;
            if (typeof window.requestIdleCallback === "function") {
              this.deferredHeavyRenderIdleId = window.requestIdleCallback(
                () => {
                  this.deferredHeavyRenderIdleId = 0;
                  runNow();
                },
                { timeout: idleTimeout },
              );
              return;
            }
            runNow();
          }, deferMs);
        },

        refreshUI(force = false) {
          if (!force && typeof window !== "undefined") {
            if (this.refreshUiRafId) return;
            this.refreshUiRafId = window.requestAnimationFrame(() => {
              this.refreshUiRafId = 0;
              this.refreshUI(true);
            });
            return;
          }
          const mobilePerf = this.isMobilePerfContext();
          const isMobileScrolling = mobilePerf && this.isMobileScrollingNow();

          if (isMobileScrolling) {
            this.syncMobileUltraSmoothMode();
            this.mobilePendingRefresh = true;
            this.scheduleDeferredHeavyUiRenders();
            return;
          }

          this.syncAutoWeek();
          this.syncMobileUltraSmoothMode();

          ui.renderSchedule();
          ui.renderNextClass();
          ui.renderPinnedAlerts();
          ui.renderStats();
          this.mobilePendingRefresh = false;

          if (force || !mobilePerf) {
            this.runHeavyUiRenders();
            return;
          }

          this.scheduleDeferredHeavyUiRenders();
        },

        renderStatic() {
          document.getElementById("navTitle").innerText = STR.title;
          document.getElementById("navSub").innerText = STR.uni;
          document.getElementById("txtProfile").innerText =
            this.getProfileName();
          const profileMajorEl = document.getElementById("txtProfileMajor");
          if (profileMajorEl) profileMajorEl.innerText = this.getProfileMajor();
          const profileTermEl = document.getElementById("txtProfileTerm");
          if (profileTermEl) profileTermEl.innerText = this.getProfileTerm();
          const classStartLabelEl =
            document.getElementById("txtClassStartLabel");
          if (classStartLabelEl)
            classStartLabelEl.innerText = STR.profileClassStartLabel;
          const hasDate = Boolean(this.getProfileClassStartDateValue());
          const classStartEl = document.getElementById("txtClassStartDate");
          if (classStartEl) {
            classStartEl.innerText = this.getProfileClassStartDateDisplay();
            classStartEl.classList.toggle("is-empty", !hasDate);
          }
          const classStartMetaEl = document.getElementById("txtClassStartMeta");
          if (classStartMetaEl) {
            classStartMetaEl.innerText = hasDate
              ? STR.profileClassStartSet
              : STR.profileClassStartMetaUnset;
            classStartMetaEl.classList.toggle("is-empty", !hasDate);
          }
          document.getElementById("btnEditProfile").title = STR.editProfile;
          document.getElementById("txtUnits").innerText = STR.units;
          document.getElementById("txtHours").innerText = STR.hours;
          document.getElementById("txtClasses").innerText = STR.classesCount;
          document.getElementById("txtNextClass").innerText = STR.nextClass;
          document.getElementById("txtExams").innerText = STR.exams;
          document.getElementById("txtNotesBoard").innerText = STR.notesBoard;
          document.getElementById("txtHandouts").innerText = STR.handoutsBoard;
          document.getElementById("txtCourseProgress").innerText =
            STR.courseProgressBoard;
          const attendanceTitleEl =
            document.getElementById("txtAttendanceBoard");
          if (attendanceTitleEl) {
            attendanceTitleEl.innerText = STR.attendanceBoard;
          }
          document.getElementById("txtAlerts").innerText = STR.alertBoard;
          document.getElementById("txtGrid").innerText = STR.viewGrid;
          document.getElementById("txtList").innerText = STR.viewList;
          document.getElementById("txtAddClass").innerText = STR.addClass;
          const bellTxt = document.getElementById("txtNotifyBellState");
          if (bellTxt) bellTxt.innerText = STR.notifyOffShort;
          const bellBtn = document.getElementById("btnNotifyBell");
          if (bellBtn) bellBtn.title = STR.notifySystemOpen;
          const quickFixBtn = document.getElementById("btnNotifyQuickFix");
          if (quickFixBtn) quickFixBtn.innerText = STR.notifyActionFix;
          const testBtn = document.getElementById("btnNotifyTest");
          if (testBtn) testBtn.innerText = STR.notifyActionTest;
          const guideBtn = document.getElementById("btnNotifyGuide");
          if (guideBtn) guideBtn.innerText = STR.notifyActionGuide;
          const animShortEl = document.getElementById("txtAnimStatusShort");
          if (animShortEl) {
            animShortEl.innerText = this.data.settings.anim
              ? STR.notifyOnShort || "On"
              : STR.notifyOffShort || "Off";
          }
          const cloudBtn = document.getElementById("btnCloudSync");
          if (cloudBtn) cloudBtn.title = STR.syncOpenPanel;
          const cloudLabelEl = document.getElementById("txtCloudSyncLabel");
          if (cloudLabelEl) cloudLabelEl.innerText = STR.syncLabelShort;
          const cloudStateEl = document.getElementById("txtCloudSyncState");
          if (cloudStateEl && !cloudStateEl.innerText.trim()) {
            cloudStateEl.innerText = STR.syncStateOffline;
          }
          const dataIoShell = document.getElementById("dataIoShell");
          if (dataIoShell) {
            dataIoShell.title = STR.dataMenu;
            dataIoShell.setAttribute("aria-label", STR.dataMenu);
          }
          const dataExportBtn = document.getElementById("btnDataExportJson");
          const activeTermDataLabel = this.getActiveTermLabel();
          if (dataExportBtn) {
            const title = `${STR.dataExportTitle} (${activeTermDataLabel})`;
            dataExportBtn.title = title;
            dataExportBtn.setAttribute("aria-label", title);
          }
          const dataImportBtn = document.getElementById("btnDataImportJson");
          if (dataImportBtn) {
            const title = `${STR.dataImportTitle} (${activeTermDataLabel})`;
            dataImportBtn.title = title;
            dataImportBtn.setAttribute("aria-label", title);
          }

          const searchInput = document.getElementById("searchInput");
          searchInput.placeholder = STR.search;
          searchInput.value = this.data.searchQuery || "";

          const sel = document.getElementById("themeSelect");
          if (sel) sel.title = STR.theme;
          sel.innerHTML = THEMES.map(
            (t) => `<option value="${t.id}">${t.name}</option>`,
          ).join("");

          const packSel = document.getElementById("packSelect");
          if (packSel) {
            packSel.title = STR.stylePack;
            packSel.innerHTML = `
              <option value="base">${STR.packBase}</option>
              <option value="ultra">${STR.packUltra}</option>
              <option value="pro">${STR.packPro}</option>
            `;
            packSel.value = this.data.settings.stylePack || "base";
          }

          const animModeSel = document.getElementById("animModeSelect");
          if (animModeSel) {
            animModeSel.title = STR.animMode;
            animModeSel.innerHTML = `
              <option value="on">${STR.animEnabled}</option>
              <option value="off">${STR.animDisabled}</option>
            `;
            animModeSel.value = this.data.settings.anim ? "on" : "off";
          }

          const animIntensitySel = document.getElementById(
            "animIntensitySelect",
          );
          if (animIntensitySel) {
            animIntensitySel.title = STR.animIntensity;
            animIntensitySel.innerHTML = `
              <option value="ultra-low">${STR.animIntensityUltraLow}</option>
              <option value="low">${STR.animIntensityLow}</option>
              <option value="high">${STR.animIntensityHigh}</option>
            `;
            animIntensitySel.value =
              this.data.settings.animIntensity === "ultra-low" ||
              this.data.settings.animIntensity === "low"
                ? this.data.settings.animIntensity
                : "high";
          }
          const animIntensityShell =
            document.getElementById("animIntensityShell");
          if (animIntensityShell) animIntensityShell.title = STR.animIntensity;
          const btnIntensityUltra = document.getElementById(
            "btnIntensityUltraLow",
          );
          if (btnIntensityUltra) {
            const txt = `${STR.animIntensity}: ${STR.animIntensityUltraLow}`;
            btnIntensityUltra.title = txt;
            btnIntensityUltra.setAttribute("aria-label", txt);
          }
          const btnIntensityLow = document.getElementById("btnIntensityLow");
          if (btnIntensityLow) {
            const txt = `${STR.animIntensity}: ${STR.animIntensityLow}`;
            btnIntensityLow.title = txt;
            btnIntensityLow.setAttribute("aria-label", txt);
          }
          const btnIntensityHigh = document.getElementById("btnIntensityHigh");
          if (btnIntensityHigh) {
            const txt = `${STR.animIntensity}: ${STR.animIntensityHigh}`;
            btnIntensityHigh.title = txt;
            btnIntensityHigh.setAttribute("aria-label", txt);
          }

          const uiModeSel = document.getElementById("uiModeSelect");
          if (uiModeSel) {
            uiModeSel.title = STR.uiMode;
            uiModeSel.innerHTML = `
              <option value="auto">${STR.uiModeAuto}</option>
              <option value="desktop">${STR.uiModeDesktop}</option>
              <option value="mobile">${STR.uiModeMobile}</option>
            `;
            uiModeSel.value = this.data.settings.uiMode || "auto";
          }
          const uiModeShell = document.getElementById("uiModeShell");
          if (uiModeShell) uiModeShell.title = STR.uiMode;
          const btnUiModeDesktop = document.getElementById("btnUiModeDesktop");
          if (btnUiModeDesktop) {
            const txt = `${STR.uiMode}: ${STR.uiModeDesktop}`;
            btnUiModeDesktop.title = txt;
            btnUiModeDesktop.setAttribute("aria-label", txt);
          }
          const btnUiModeMobile = document.getElementById("btnUiModeMobile");
          if (btnUiModeMobile) {
            const txt = `${STR.uiMode}: ${STR.uiModeMobile}`;
            btnUiModeMobile.title = txt;
            btnUiModeMobile.setAttribute("aria-label", txt);
          }
          const btnUiModeAuto = document.getElementById("btnUiModeAuto");
          if (btnUiModeAuto) {
            const txt = `${STR.uiMode}: ${STR.uiModeAuto}`;
            btnUiModeAuto.title = txt;
            btnUiModeAuto.setAttribute("aria-label", txt);
          }

          this.setStylePack(this.data.settings.stylePack || "base", true);
          this.setAnimEnabled(this.data.settings.anim, true);
          this.setAnimIntensity(
            this.data.settings.animIntensity === "ultra-low" ||
              this.data.settings.animIntensity === "low"
              ? this.data.settings.animIntensity
              : "high",
            true,
          );
          this.setUiMode(this.data.settings.uiMode || "auto", true);
          this.syncTopNavSelectIcons();
          this.updateNotificationPermissionUI();
          if (typeof cloudSync !== "undefined") {
            cloudSync.renderSyncBadge();
            cloudSync.refreshSyncModalUi();
          }
        },
      };

      const ui = {
        escapeHtml(v) {
          return String(v ?? "").replace(/[&<>"']/g, (ch) => {
            const map = {
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            };
            return map[ch] || ch;
          });
        },

        setInnerHtmlIfChanged(element, html) {
          if (!element) return false;
          const nextHtml = String(html ?? "");
          if (element.__lastRenderHtml === nextHtml) return false;
          element.__lastRenderHtml = nextHtml;
          element.innerHTML = nextHtml;
          return true;
        },

        attendanceStatusFilter: "all",
        attendanceUndoStack: [],
        attendanceUndoMax: 20,

        sanitizeAttendanceStatusFilter(raw) {
          const v = String(raw || "")
            .trim()
            .toLowerCase();
          if (v === "pending" || v === "risk") return v;
          return "all";
        },

        getAttendanceStatusFilter() {
          this.attendanceStatusFilter = this.sanitizeAttendanceStatusFilter(
            this.attendanceStatusFilter,
          );
          return this.attendanceStatusFilter;
        },

        setAttendanceStatusFilter(filter) {
          this.attendanceStatusFilter =
            this.sanitizeAttendanceStatusFilter(filter);
          this.renderAttendance();
        },

        getAttendanceSnapshotSignature(snapshot) {
          if (!snapshot || typeof snapshot !== "object") return "";
          const entries = Object.entries(snapshot.statuses || {})
            .map(([k, v]) => `${String(k || "")}:${String(v || "")}`)
            .sort();
          return entries.join("|");
        },

        pushAttendanceUndoSnapshot(dateKey, label = "") {
          const snapshot = app.getAttendanceStatusSnapshot(dateKey);
          if (!snapshot) return false;
          snapshot.label = String(label || "").trim();
          snapshot.at = new Date().toISOString();
          snapshot.signature = this.getAttendanceSnapshotSignature(snapshot);

          const last =
            this.attendanceUndoStack[this.attendanceUndoStack.length - 1] ||
            null;
          if (
            last &&
            last.dateKey === snapshot.dateKey &&
            last.signature === snapshot.signature
          ) {
            return false;
          }

          this.attendanceUndoStack.push(snapshot);
          if (this.attendanceUndoStack.length > this.attendanceUndoMax) {
            this.attendanceUndoStack.splice(
              0,
              this.attendanceUndoStack.length - this.attendanceUndoMax,
            );
          }
          return true;
        },

        undoAttendanceLastChange() {
          if (
            !Array.isArray(this.attendanceUndoStack) ||
            !this.attendanceUndoStack.length
          ) {
            alert(
              STR.attendanceUndoEmpty ||
                "    .",
            );
            return;
          }
          const snapshot = this.attendanceUndoStack.pop();
          if (!snapshot || !snapshot.dateKey) return;

          const knownMap = app.getAttendanceKnownCourseMap();
          const keys = new Set([
            ...Array.from(knownMap.keys()),
            ...Object.keys(snapshot.courseNames || {}),
            ...Object.keys(snapshot.statuses || {}),
          ]);
          const entries = [];
          keys.forEach((rawKey) => {
            const key = app.normalizeCourseKey(rawKey);
            if (!key) return;
            entries.push({
              courseKey: key,
              courseName: String(
                snapshot.courseNames?.[key] || knownMap.get(key) || "",
              ).trim(),
              status: String(snapshot.statuses?.[key] || "").trim(),
            });
          });
          app.setAttendanceStatusesBulk(entries, snapshot.dateKey, {
            force: true,
          });
        },

        applyAttendanceBulk(action) {
          const normalizedAction = String(action || "")
            .trim()
            .toLowerCase();
          const dateKey = app.getAttendanceTargetDateKey();
          if (!app.canEditAttendanceDate(dateKey)) {
            alert(STR.attendanceEditLocked);
            return;
          }

          const scheduled = app.getScheduledCoursesForDate(dateKey);
          if (!scheduled.length) {
            alert(STR.attendanceNoItemsToday);
            return;
          }

          let entries = [];
          if (normalizedAction === "present-pending") {
            entries = scheduled
              .filter((course) => !app.getAttendanceStatus(course.key, dateKey))
              .map((course) => ({
                courseKey: course.key,
                courseName: course.name,
                status: "present",
              }));
          } else if (normalizedAction === "absent-pending") {
            entries = scheduled
              .filter((course) => !app.getAttendanceStatus(course.key, dateKey))
              .map((course) => ({
                courseKey: course.key,
                courseName: course.name,
                status: "absent",
              }));
          } else if (normalizedAction === "clear-day") {
            entries = scheduled
              .filter((course) =>
                Boolean(app.getAttendanceStatus(course.key, dateKey)),
              )
              .map((course) => ({
                courseKey: course.key,
                courseName: course.name,
                status: "",
              }));
          } else if (normalizedAction === "copy-prev-week") {
            const refDate = app.getDateFromKey(dateKey);
            if (!refDate) {
              alert(STR.attendanceNoChangesApplied);
              return;
            }
            const sourceDate = new Date(
              refDate.getTime() - 7 * 24 * 60 * 60 * 1000,
            );
            const sourceDateKey = app.getDateKey(sourceDate);
            entries = scheduled
              .filter((course) => !app.getAttendanceStatus(course.key, dateKey))
              .map((course) => ({
                courseKey: course.key,
                courseName: course.name,
                status: app.getAttendanceStatus(course.key, sourceDateKey),
              }))
              .filter(
                (item) => item.status === "present" || item.status === "absent",
              );
          }

          if (!entries.length) {
            alert(STR.attendanceNoChangesApplied);
            return;
          }

          this.pushAttendanceUndoSnapshot(dateKey, normalizedAction);
          const result = app.setAttendanceStatusesBulk(entries, dateKey, {
            force: true,
          });
          if (!result.changed) {
            this.attendanceUndoStack.pop();
            alert(STR.attendanceNoChangesApplied);
          }
        },

        renderSchedule() {
          const container = document.getElementById("scheduleContainer");
          const classes = app.getVisibleClasses();
          const hasClassStartDate = Boolean(
            app.getProfileClassStartDateValue(),
          );
          const scheduleRefNow = new Date();
          const sessionSetupAlertHtml = hasClassStartDate
            ? ""
            : `
              <div class="theme-card schedule-hint schedule-hint--session-start p-3 mb-3">
                <div class="schedule-hint-copy">
                  <div class="schedule-hint-title">${this.escapeHtml(STR.sessionMissingGlobalTitle)}</div>
                  <div class="schedule-hint-note">${this.escapeHtml(STR.sessionMissingGlobalHint)}</div>
                </div>
                <button type="button" class="schedule-hint-action" onclick="ui.openProfileMetaModal()">${this.escapeHtml(STR.setStartDateAction)}</button>
              </div>
            `;
          const renderSessionPill = (tone, label) => `
            <span class="session-pill session-pill--${tone}">
              <span class="session-pill-gem" aria-hidden="true"></span>
              <span>${label}</span>
            </span>
          `;

          if (app.data.settings.view === "grid") {
            if (app.isMobileLayout()) {
              const addStart = TIME_SLOTS[0][0];
              const addEnd = app.addMinutes(addStart, CLASS_DURATION_MINUTES);
              const now = new Date();
              const todayIdx = (now.getDay() + 1) % 7;
              const nowMinutes = now.getHours() * 60 + now.getMinutes();
              let html = `
              <div class="theme-card schedule-hint p-3 mb-3 text-xs font-black" style="color: var(--muted);">
                ${STR.addHint}
              </div>
              ${sessionSetupAlertHtml}
              <div class="mobile-schedule-board">
              `;

              STR.days.forEach((dayName, dayIndex) => {
                const dayClasses = classes
                  .filter((c) => c.day === dayIndex)
                  .sort((a, b) => a.start.localeCompare(b.start));
                const isToday = dayIndex === todayIdx;

                html += `
                <section class="mobile-day-card theme-card ${isToday ? "mobile-day-card--today" : ""}">
                  <div class="mobile-day-head">
                    <div class="mobile-day-title-wrap">
                      <div class="mobile-day-title">${dayName}</div>
                      ${isToday ? `<span class="mobile-today-pill"></span>` : ""}
                    </div>
                    <div class="mobile-day-head-right">
                      <button
                        class="mobile-add-btn"
                        onclick="ui.openClassModalPrefill(event, ${dayIndex}, '${addStart}', '${addEnd}')"
                        type="button"
                      >
                        + ${STR.addClass}
                      </button>
                    </div>
                  </div>
                  <div class="mobile-day-meta">
                    <span class="chip">${isToday ? " " : " "} | ${dayClasses.length} </span>
                  </div>
                  <div class="mobile-day-classes">
                `;

                if (dayClasses.length === 0) {
                  html += `
                    <button
                      class="mobile-empty-slot"
                      onclick="ui.openClassModalPrefill(event, ${dayIndex}, '${addStart}', '${addEnd}')"
                      type="button"
                    >
                      + ${STR.addClass}
                    </button>
                  `;
                } else {
                  dayClasses.forEach((c) => {
                    const isConflict = classes.some((other) =>
                      app.checkConflict(c, other),
                    );
                    const badgeClass =
                      c.type === "odd"
                        ? "badge-odd"
                        : c.type === "even"
                          ? "badge-even"
                          : "badge-normal";
                    const badgeText =
                      c.type === "odd"
                        ? STR.typeOdd
                        : c.type === "even"
                          ? STR.typeEven
                          : STR.typeNormal;
                    const startMinutes = app.toMinutes(c.start);
                    const endMinutes = app.toMinutes(c.end);
                    const statusClass =
                      dayIndex !== todayIdx
                        ? ""
                        : nowMinutes >= startMinutes && nowMinutes < endMinutes
                          ? "is-now"
                          : nowMinutes < startMinutes
                            ? "is-upcoming"
                            : "is-past";
                    const statusChipClass =
                      statusClass === "is-now"
                        ? "state-now"
                        : statusClass === "is-upcoming"
                          ? "state-upcoming"
                          : statusClass === "is-past"
                            ? "state-past"
                            : "";
                    const statusText =
                      statusClass === "is-now"
                        ? "  "
                        : statusClass === "is-upcoming"
                          ? " "
                          : statusClass === "is-past"
                            ? " "
                            : "";
                    const unitText =
                      Number.isFinite(Number(c.unit)) && Number(c.unit) > 0
                        ? `${Number(c.unit)} `
                        : "";
                    const classNo = this.escapeHtml(
                      String(c.classNo || "").trim(),
                    );
                    const safeName = this.escapeHtml(c.name || STR.course);
                    const safeProf = this.escapeHtml(c.prof || "-");
                    const safeNote = this.escapeHtml(c.note || "");
                    const safeStart = this.escapeHtml(c.start || "-");
                    const safeEnd = this.escapeHtml(c.end || "-");
                    const occurrenceAt = app.getClassNextOccurrenceAt(c, now);
                    const sessionMeta = hasClassStartDate
                      ? app.getClassSessionMeta(c, now, { occurrenceAt })
                      : null;
                    const sessionTone = this.escapeHtml(
                      sessionMeta?.tone || "ok",
                    );
                    const sessionLabel = this.escapeHtml(
                      sessionMeta?.label || " ",
                    );

                    html += `
                      <div class="mobile-class-card ${statusClass}" onclick="ui.openClassModalFromCard(event, ${c.id})">
                        <div class="mobile-class-top">
                          <span class="mobile-class-time">${safeStart}-${safeEnd}</span>
                          <span class="badge ${badgeClass}">${badgeText}</span>
                        </div>
                        <div class="mobile-class-title">${safeName}</div>
                        ${classNo ? `<div class="class-number-line"><span class="class-number-chip"><span class="class-number-chip__label">${this.escapeHtml(STR.classNumber)}</span><span class="class-number-chip__value">${classNo}</span></span></div>` : ""}
                        <div class="mobile-class-prof">${safeProf}</div>
                        ${safeNote ? `<div class="mobile-class-note">${safeNote}</div>` : ""}
                        <div class="mobile-class-foot">
                          <span class="mobile-state-chip ${statusChipClass}">${statusText}</span>
                          <span class="mobile-class-unit">${unitText}</span>
                        </div>
                        ${hasClassStartDate ? `<div class="mobile-session-line">${renderSessionPill(sessionTone, sessionLabel)}</div>` : ""}
                        ${isConflict ? `<div class="mobile-class-conflict">  </div>` : ""}
                      </div>
                    `;
                  });
                }

                html += `
                  </div>
                </section>
                `;
              });

              html += `</div>`;
              this.setInnerHtmlIfChanged(container, html);
              return;
            }

            let html = `
            <div class="theme-card schedule-hint p-3 mb-3 text-xs font-black" style="color: var(--muted);">
              ${STR.addHint}
            </div>
            ${sessionSetupAlertHtml}

            <div class="schedule-frame">
              <div class="schedule-shell">
                <div class="schedule-grid theme-card" id="scheduleGrid">
          `;

            // Header row
            html += `<div class="grid-header sticky-top time-col">${STR.timeLabel}</div>`;
            STR.days.forEach(
              (d, col) =>
                (html += `<div class="grid-header sticky-top" data-col="${col}">${d}</div>`),
            );

            // Rows
            TIME_SLOTS.forEach((slot, row) => {
              const [start, end] = slot;

              html += `
              <div class="grid-cell time-slot time-col" data-row="${row}">
                <div>${start}</div>
                <div class="opacity-60">-</div>
                <div>${end}</div>
              </div>
            `;

              STR.days.forEach((_, dayIndex) => {
                const slotClasses = classes.filter(
                  (c) =>
                    c.day === dayIndex && c.start >= start && c.start < end,
                );

                html += `
                <div class="grid-cell" data-row="${row}" data-col="${dayIndex}"
                  onclick="ui.openClassModalPrefill(event, ${dayIndex}, '${start}', '${end}')">
                  <span class="mobile-day-header">${STR.days[dayIndex]} ${start}-${end}</span>
                  <span class="add-ghost">+ ${STR.addClass}</span>
              `;

                slotClasses.forEach((c) => {
                  const isConflict = classes.some((other) =>
                    app.checkConflict(c, other),
                  );
                  const badgeClass =
                    c.type === "odd"
                      ? "badge-odd"
                      : c.type === "even"
                        ? "badge-even"
                        : "badge-normal";
                  const badgeText =
                    c.type === "odd"
                      ? STR.typeOdd
                      : c.type === "even"
                        ? STR.typeEven
                        : STR.typeNormal;
                  const classNo = this.escapeHtml(
                    String(c.classNo || "").trim(),
                  );
                  const safeName = this.escapeHtml(c.name || STR.course);
                  const safeProf = this.escapeHtml(c.prof || "-");
                  const safeNote = this.escapeHtml(c.note || "");
                  const safeStart = this.escapeHtml(c.start || "-");
                  const safeEnd = this.escapeHtml(c.end || "-");
                  const occurrenceAt = app.getClassNextOccurrenceAt(
                    c,
                    scheduleRefNow,
                  );
                  const sessionMeta = hasClassStartDate
                    ? app.getClassSessionMeta(c, scheduleRefNow, {
                        occurrenceAt,
                      })
                    : null;
                  const sessionTone = this.escapeHtml(
                    sessionMeta?.tone || "ok",
                  );
                  const sessionLabel = this.escapeHtml(
                    sessionMeta?.label || " ",
                  );

                  html += `
                  <div class="class-card class-card-${c.type}" data-type="${c.type}" onclick="ui.openClassModalFromCard(event, ${c.id})">
                    ${isConflict ? `<div class="absolute top-2 left-2 w-2 h-2 bg-red-500 rounded-full animate-ping"></div>` : ""}
                    <div class="class-title">${safeName}</div>
                    ${classNo ? `<div class="class-number-line"><span class="class-number-chip"><span class="class-number-chip__label">${this.escapeHtml(STR.classNumber)}</span><span class="class-number-chip__value">${classNo}</span></span></div>` : ""}
                    ${hasClassStartDate ? `<div class="class-session-line">${renderSessionPill(sessionTone, sessionLabel)}</div>` : ""}
                    <div class="class-meta truncate">${safeProf}</div>
                    ${safeNote ? `<div class="class-meta mt-1">${safeNote}</div>` : ""}
                    <div class="class-foot">
                      <span class="badge ${badgeClass}">${badgeText}</span>
                      <span class="text-[10px] font-black opacity-75" style="font-family: var(--font-en);">${safeStart}-${safeEnd}</span>
                    </div>
                  </div>
                `;
                });

                html += `</div>`;
              });
            });

            html += `</div></div></div>`;
            const didUpdate = this.setInnerHtmlIfChanged(container, html);
            if (!didUpdate) return;

            // Hover highlight row/col
            const grid = document.getElementById("scheduleGrid");
            const canHover =
              window.matchMedia && window.matchMedia("(hover: hover)").matches;
            if (grid && canHover) {
              grid.addEventListener("mousemove", (e) => {
                const cell = e.target.closest(".grid-cell");
                if (!cell || !grid.contains(cell)) return;
                const r = cell.dataset.row;
                const c = cell.dataset.col;
                grid
                  .querySelectorAll(".grid-cell.hl, .grid-header.hl")
                  .forEach((x) => x.classList.remove("hl"));
                if (r !== undefined)
                  grid
                    .querySelectorAll(`[data-row="${r}"]`)
                    .forEach((x) => x.classList.add("hl"));
                if (c !== undefined)
                  grid
                    .querySelectorAll(`[data-col="${c}"]`)
                    .forEach((x) => x.classList.add("hl"));
              });
              grid.addEventListener("mouseleave", () => {
                grid
                  .querySelectorAll(".grid-cell.hl, .grid-header.hl")
                  .forEach((x) => x.classList.remove("hl"));
              });
            }
          } else {
            // LIST VIEW (premium cards)
            if (classes.length === 0) {
              const emptyHtml = `${sessionSetupAlertHtml}<div class="text-center py-12 opacity-50">${STR.noClass}</div>`;
              this.setInnerHtmlIfChanged(container, emptyHtml);
              return;
            }
            let html = `${sessionSetupAlertHtml}<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">`;

            classes.sort(
              (a, b) =>
                a.day * 10000 +
                a.start.replace(":", "") -
                (b.day * 10000 + b.start.replace(":", "")),
            );

            classes.forEach((c) => {
              const badgeClass =
                c.type === "odd"
                  ? "badge-odd"
                  : c.type === "even"
                    ? "badge-even"
                    : "badge-normal";
              const badgeText =
                c.type === "odd"
                  ? STR.typeOdd
                  : c.type === "even"
                    ? STR.typeEven
                    : STR.typeNormal;
              const classNo = this.escapeHtml(String(c.classNo || "").trim());
              const safeName = this.escapeHtml(c.name || STR.course);
              const safeProf = this.escapeHtml(c.prof || "-");
              const safeNote = this.escapeHtml(c.note || "");
              const safeStart = this.escapeHtml(c.start || "-");
              const safeEnd = this.escapeHtml(c.end || "-");
              const occurrenceAt = app.getClassNextOccurrenceAt(
                c,
                scheduleRefNow,
              );
              const sessionMeta = hasClassStartDate
                ? app.getClassSessionMeta(c, scheduleRefNow, { occurrenceAt })
                : null;
              const sessionTone = this.escapeHtml(sessionMeta?.tone || "ok");
              const sessionLabel = this.escapeHtml(
                sessionMeta?.label || " ",
              );

              html += `
              <div onclick="ui.openClassModal(${c.id})" class="theme-card list-class-card list-class-${c.type} p-4 cursor-pointer hover:brightness-105 transition-all" style="border: 1px solid var(--border);" data-type="${c.type}">
                <div class="flex items-center justify-between gap-2">
                  <div class="font-black text-sm truncate">${safeName}</div>
                  <span class="badge ${badgeClass}">${badgeText}</span>
                </div>
                ${classNo ? `<div class="mt-1"><span class="class-number-chip"><span class="class-number-chip__label">${this.escapeHtml(STR.classNumber)}</span><span class="class-number-chip__value">${classNo}</span></span></div>` : ""}
                ${hasClassStartDate ? `<div class="class-session-line">${renderSessionPill(sessionTone, sessionLabel)}</div>` : ""}
                <div class="text-xs mt-1" style="color: var(--muted);">${safeProf}</div>
                ${safeNote ? `<div class="text-xs mt-1" style="color: var(--muted);">${safeNote}</div>` : ""}
                <div class="mt-3 flex justify-between text-xs font-black">
                  <span class="chip">${STR.days[c.day]}</span>
                  <span class="chip" style="font-family: var(--font-en);">${safeStart}-${safeEnd}</span>
                </div>
              </div>
            `;
            });

            html += `</div>`;
            this.setInnerHtmlIfChanged(container, html);
          }
        },

        renderNextClass() {
          const now = new Date();
          const nowDateLabel = now.toLocaleDateString("fa-IR", {
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric",
          });
          const nowTimeLabel = now.toLocaleTimeString("en-GB", {
            hour: "2-digit",
            minute: "2-digit",
            hour12: false,
          });
          const weekLabel = this.escapeHtml(app.getWeekLabel());

          const candidates = app
            .getVisibleClasses()
            .map((c) => {
              const startAt = app.getClassNextOccurrenceAt(c, now);
              if (!(startAt instanceof Date) || Number.isNaN(startAt.getTime()))
                return null;
              const score = Math.max(
                0,
                Math.floor((startAt.getTime() - now.getTime()) / 60000),
              );
              return {
                ...c,
                score,
                startAt,
              };
            })
            .filter(Boolean);

          candidates.sort((a, b) => a.score - b.score);
          const next = candidates[0];

          const container = document.getElementById("nextClassContainer");
          if (!container) return;

          const buildRemainingMeta = (ms) => {
            const totalMin = Math.max(0, Math.floor(ms / 60000));
            const safeMin = Math.max(0, totalMin);
            const days = Math.floor(safeMin / (24 * 60));
            const hours = Math.floor((safeMin % (24 * 60)) / 60);
            const minutes = safeMin % 60;
            const parts = [];
            if (days > 0) parts.push(`${days.toLocaleString("fa-IR")} `);
            if (hours > 0)
              parts.push(`${hours.toLocaleString("fa-IR")} `);
            parts.push(`${minutes.toLocaleString("fa-IR")} `);
            const minuteEn = String(safeMin);
            return {
              totalMin: safeMin,
              text: parts.join("  "),
              digits: minuteEn.split("").map((ch) => ({ num: ch })),
              compact: minuteEn.length >= 5,
            };
          };

          if (!next) {
            const emptyHtml = `
              <div class="next-premium-shell animate-fade-in">
                <div class="next-live-meta">
                  <span class="next-now-chip">${weekLabel}</span>
                  <span>${this.escapeHtml(nowDateLabel)}</span>
                  <span class="next-time-clock">${this.escapeHtml(nowTimeLabel)}</span>
                </div>
                <div class="next-empty-state">${STR.noClass}</div>
              </div>
            `;
            this.setInnerHtmlIfChanged(container, emptyHtml);
            return;
          }

          const badgeClass =
            next.type === "odd"
              ? "badge-odd"
              : next.type === "even"
                ? "badge-even"
                : "badge-normal";
          const badgeText =
            next.type === "odd"
              ? STR.typeOdd
              : next.type === "even"
                ? STR.typeEven
                : STR.typeNormal;
          const safeName = this.escapeHtml(next.name || STR.course);
          const safeClassNo = this.escapeHtml(
            String(next.classNo || "").trim(),
          );
          const safeProf = this.escapeHtml(next.prof || "-");
          const safeNote = this.escapeHtml(next.note || "");
          const safeStart = this.escapeHtml(next.start || "-");
          const safeEnd = this.escapeHtml(next.end || "-");
          const nextDateLabel = next.startAt.toLocaleDateString("fa-IR", {
            weekday: "long",
            month: "long",
            day: "numeric",
          });
          const nextTimeLabel = next.startAt.toLocaleTimeString("en-GB", {
            hour: "2-digit",
            minute: "2-digit",
            hour12: false,
          });
          const remainingMs = next.startAt.getTime() - now.getTime();
          const remainingMeta = buildRemainingMeta(remainingMs);
          const remainingText = remainingMeta.text;
          const remainingMin = remainingMeta.totalMin;
          const remainingDigitalHtml = (remainingMeta.digits || [])
            .map(
              (part) => `
                <span class="next-flip-digit">
                  <span class="next-flip-digit__num">${this.escapeHtml(part.num)}</span>
                </span>`,
            )
            .join("");
          const URGENCY_WINDOW_MINUTES = 36 * 60;
          const normalizedUrgency =
            1 -
            Math.min(
              Math.max(0, Number(remainingMin) || 0),
              URGENCY_WINDOW_MINUTES,
            ) /
              URGENCY_WINDOW_MINUTES;
          const urgencyPercent = Math.max(
            0,
            Math.min(
              100,
              Math.round(Math.pow(Math.max(0, normalizedUrgency), 0.88) * 100),
            ),
          );
          const sessionMeta = app.getClassSessionMeta(next, now, {
            occurrenceAt: next.startAt,
          });
          const sessionTone = this.escapeHtml(sessionMeta.tone || "ok");
          const sessionLabel = this.escapeHtml(
            sessionMeta.label || " ",
          );
          const urgencyHint =
            remainingMin <= 45
              ? "        ."
              : remainingMin <= 360
                ? "       ."
                : "        .";

          const nextClassHtml = `
          <div class="next-premium-shell animate-fade-in">
            <div class="next-live-meta">
              <span class="next-now-chip">${weekLabel}</span>
              <span>${this.escapeHtml(nowDateLabel)}</span>
              <span class="next-time-clock">${this.escapeHtml(nowTimeLabel)}</span>
            </div>
            <div class="next-course-row">
              <h3 class="text-xl font-black mb-1 leading-tight">${safeName}</h3>
              <span class="next-status-pill next-status-pill--session next-status-pill--session-${sessionTone}">
                <span class="session-pill-gem" aria-hidden="true"></span>
                <span>${sessionLabel}</span>
              </span>
            </div>
            <p class="next-prof-line">${safeProf}</p>
            ${safeNote ? `<p class="next-note-line">${safeNote}</p>` : ``}
            <div class="next-chip-row">
              <span class="chip">${STR.days[next.day]} <span style="font-family: var(--font-time);">${safeStart}-${safeEnd}</span></span>
              <span class="badge ${badgeClass}">${badgeText}</span>
            </div>
            ${safeClassNo ? `<div class="next-class-no-wrap"><span class="next-class-no-label">${this.escapeHtml(STR.classNumber)}</span><span class="next-class-no-badge">${safeClassNo}</span></div>` : ""}
            <div class="next-time-panel">
              <span class="next-time-date">${this.escapeHtml(nextDateLabel)}</span>
              <span class="next-time-clock">${this.escapeHtml(nextTimeLabel)}</span>
            </div>
            <div class="next-minute-left">
              <span class="next-minute-caption">   </span>
              <span class="next-minute-digital${remainingMeta.compact ? " is-compact" : ""}" dir="ltr" data-len="${remainingMeta.digits.length}">
                <span class="next-flip-track">${remainingDigitalHtml}</span>
                <span class="next-minute-unit">MIN</span>
              </span>
            </div>
            <div class="next-urgency-track" role="progressbar" aria-label="   " aria-valuemin="0" aria-valuemax="100" aria-valuenow="${urgencyPercent}">
              <span class="next-urgency-fill" style="width:${urgencyPercent}%;"></span>
            </div>
            <div class="next-urgency-note">${this.escapeHtml(urgencyHint)}</div>
            <div class="next-next-at">   </div>
            <div class="next-countdown">    ${this.escapeHtml(remainingText)} </div>
          </div>
        `;
          this.setInnerHtmlIfChanged(container, nextClassHtml);
        },

        renderExams() {
          const list = document.getElementById("examList");
          const now = new Date();
          const exams = app.data.exams
            .slice()
            .map((e) => ({
              ...e,
              _countdown: app.getCountdownMeta(app.getExamDateTime(e), now),
            }))
            .sort((a, b) => {
              if (a._countdown.orderBucket !== b._countdown.orderBucket) {
                return a._countdown.orderBucket - b._countdown.orderBucket;
              }
              if (a._countdown.orderBucket === 2) {
                return String(a.title || "").localeCompare(
                  String(b.title || ""),
                  "fa",
                );
              }
              if (a._countdown.orderValue !== b._countdown.orderValue) {
                return a._countdown.orderValue - b._countdown.orderValue;
              }
              return String(a.title || "").localeCompare(
                String(b.title || ""),
                "fa",
              );
            });

          if (exams.length === 0) {
            this.setInnerHtmlIfChanged(
              list,
              `<div class="text-center opacity-40 text-xs mt-10">${STR.noClass}</div>`,
            );
            return;
          }

          const examHtml = exams
            .map((e) => {
              const examMeta = app.getDateTimeMeta(e.date, e.time);
              const examAt = examMeta.valid ? examMeta.date : null;
              const countdown = e._countdown || app.getCountdownMeta(null, now);
              const examRemainTone = countdown.hasTarget
                ? countdown.isUpcoming
                  ? "is-upcoming"
                  : "is-past"
                : "is-neutral";
              const examRemainText = countdown.hasTarget
                ? countdown.isUpcoming
                  ? ` : ${countdown.detailText}`
                  : ` : ${countdown.detailText}`
                : "   ";
              const notifyMeta = app.getExamNotificationMeta(e);
              const notifyCountdown = app.getCountdownMeta(
                notifyMeta.date,
                now,
              );
              const notifyEnabled = Boolean(e.notifyEnabled);
              const systemNotifyReady =
                typeof Notification !== "undefined" &&
                Notification.permission === "granted";
              const notifyStateLabel = notifyEnabled
                ? ""
                : "";
              const notifyConnectionLabel = notifyEnabled
                ? systemNotifyReady
                  ? "   "
                  : "    "
                : "";
              const notifyScheduleLabel = notifyEnabled
                ? notifyMeta.hasTarget
                  ? notifyMeta.fullLabel
                  : "   "
                : "   ";
              const notifyRemainText = notifyEnabled
                ? notifyCountdown.hasTarget
                  ? notifyCountdown.isUpcoming
                    ? ` : ${notifyCountdown.detailText}`
                    : ` : ${notifyCountdown.detailText}`
                  : "   "
                : "      ";
              const notifyText = this.escapeHtml(
                String(e.notifyText || e.title || ""),
              );
              const courseName = String(
                e.courseName || app.getCourseNameByClassId(e.classId),
              ).trim();
              const safeCourse = this.escapeHtml(
                courseName || STR.unknownClass,
              );
              const safeTitle = this.escapeHtml(e.title || "-");
              const safeLocation = this.escapeHtml(
                String(e.location || "").trim() || " ",
              );
              const safeExamSchedule = this.escapeHtml(
                examMeta.valid
                  ? `${examMeta.dayLabel} | ${examMeta.dateLabel} | ${examMeta.timeLabel}`
                  : `${e.date || "-"} | ${e.time || "-"}`,
              );
              const safeNotifySchedule = this.escapeHtml(notifyScheduleLabel);
              const safeNotifySource = this.escapeHtml(
                notifyMeta.hasTarget ? notifyMeta.sourceLabel : "-",
              );
              const safeExamRemain = this.escapeHtml(examRemainText);
              const safeNotifyRemain = this.escapeHtml(notifyRemainText);
              const safeExamDateIso = this.escapeHtml(
                examAt ? app.getDateKey(examAt) : e.date || "-",
              );

              return `
          <div onclick="ui.openExamModal(${e.id})" class="exam-card p-3 rounded-2xl border border-[var(--border)] cursor-pointer hover:brightness-105 transition-all"
               style="background: color-mix(in srgb, var(--card-bg) 80%, transparent); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px);">
            <div class="exam-card-head">
              <span class="exam-card-title">${safeTitle}</span>
              <span class="exam-course-chip"> ${safeCourse}</span>
            </div>
            <div class="exam-meta-row">
              <span class="exam-meta-key">:</span>
              <span>${safeExamSchedule}</span>
            </div>
            <div class="exam-meta-row">
              <span class="exam-meta-key"> :</span>
              <span style="font-family: var(--font-en);">${safeExamDateIso}</span>
            </div>
            <div class="exam-meta-row">
              <span class="exam-meta-key">/:</span>
              <span>${safeLocation}</span>
            </div>
            <div class="exam-notify-box ${notifyEnabled ? "is-on" : "is-off"}">
              <div class="exam-meta-row" style="margin-top:0;">
                <span class="exam-meta-key"> :</span>
                <span>${this.escapeHtml(notifyStateLabel)}</span>
              </div>
              <div class="exam-meta-row">
                <span class="exam-meta-key"> :</span>
                <span>${safeNotifySchedule}</span>
              </div>
              <div class="exam-meta-row">
                <span class="exam-meta-key"> :</span>
                <span>${safeNotifySource}</span>
              </div>
              <div class="exam-meta-row">
                <span class="exam-meta-key"> :</span>
                <span>${this.escapeHtml(notifyConnectionLabel)}</span>
              </div>
              ${notifyEnabled ? `<div class="exam-meta-row"><span class="exam-meta-key">${this.escapeHtml(STR.notifyText)}:</span> <span>${notifyText}</span></div>` : ""}
            </div>
            <div class="exam-remain-row ${examRemainTone}"> ${safeExamRemain}</div>
            <div class="exam-meta-row">${safeNotifyRemain}</div>
          </div>
        `;
            })
            .join("");
          this.setInnerHtmlIfChanged(list, examHtml);
        },

        deleteNoteFromCard(ev, id) {
          if (ev) ev.stopPropagation();
          app.deleteNote(id);
        },

        dismissWeeklyFoodReminder(ev, key) {
          if (ev) ev.stopPropagation();
          app.dismissWeeklyFoodReminder(key);
        },

        dismissPinnedNoteAlert(ev, id) {
          if (ev) ev.stopPropagation();
          app.dismissPinnedNoteAlert(id);
        },

        unpinNoteFromCard(ev, id) {
          if (ev) ev.stopPropagation();
          app.toggleNoteImportant(id, false);
        },

        deleteCourseProgressFromCard(ev, id) {
          if (ev) ev.stopPropagation();
          app.deleteCourseProgress(id);
        },

        deleteHandoutFromCard(ev, id) {
          if (ev) ev.stopPropagation();
          app.deleteHandout(id);
        },

        openHandoutAsset(ev, rawUrl) {
          if (ev) ev.stopPropagation();
          const url = String(rawUrl || "").trim();
          if (!url) return;
          const target = app.normalizeUrl(url);
          if (!target) return;
          window.open(target, "_blank", "noopener,noreferrer");
        },

        sanitizeDownloadName(name, fallback = "handout") {
          const clean = String(name || "")
            .replace(/[\\/:*?"<>|]+/g, "-")
            .replace(/\s+/g, " ")
            .trim();
          const base = clean || fallback;
          return base.slice(0, 96);
        },

        getDataUrlExtension(rawDataUrl) {
          const dataUrl = String(rawDataUrl || "").trim();
          const mimeMatch = /^data:([^;,]+)/i.exec(dataUrl);
          const mime = String(mimeMatch?.[1] || "").toLowerCase();
          const map = {
            "image/jpeg": "jpg",
            "image/png": "png",
            "image/webp": "webp",
            "image/gif": "gif",
            "image/svg+xml": "svg",
            "application/pdf": "pdf",
            "text/plain": "txt",
            "application/zip": "zip",
            "application/json": "json",
          };
          if (map[mime]) return map[mime];
          if (mime.includes("/")) {
            const ext = mime
              .split("/")[1]
              .split("+")[0]
              .replace(/[^a-z0-9]/gi, "")
              .toLowerCase();
            if (ext) return ext;
          }
          return "bin";
        },

        downloadDataUrlFile(ev, rawDataUrl, rawName = "", rawTitle = "") {
          if (ev) ev.stopPropagation();
          const dataUrl = String(rawDataUrl || "").trim();
          if (!/^data:/i.test(dataUrl)) return;

          const givenName = this.sanitizeDownloadName(rawName, "");
          const titleName = this.sanitizeDownloadName(rawTitle, "handout");
          const ext = this.getDataUrlExtension(dataUrl);
          let filename = givenName || titleName;
          if (!/\.[a-z0-9]{1,8}$/i.test(filename)) {
            filename = `${filename}.${ext}`;
          }

          const anchor = document.createElement("a");
          anchor.href = dataUrl;
          anchor.download = filename;
          anchor.rel = "noopener";
          document.body.appendChild(anchor);
          anchor.click();
          anchor.remove();
        },

        downloadHandoutLink(ev, rawUrl, rawTitle = "") {
          if (ev) ev.stopPropagation();
          const target = app.normalizeUrl(rawUrl);
          if (!target) return;

          const base = this.sanitizeDownloadName(rawTitle, "handout-link");
          const content = `[InternetShortcut]\r\nURL=${target}\r\n`;
          const blob = new Blob([content], {
            type: "text/plain;charset=utf-8",
          });
          const objectUrl = URL.createObjectURL(blob);
          const anchor = document.createElement("a");
          anchor.href = objectUrl;
          anchor.download = `${base}.url`;
          anchor.rel = "noopener";
          document.body.appendChild(anchor);
          anchor.click();
          window.setTimeout(() => {
            URL.revokeObjectURL(objectUrl);
            anchor.remove();
          }, 0);
        },

        renderNotes() {
          const list = document.getElementById("noteList");
          if (!list) return;

          const now = new Date();
          const notes = app.data.notes
            .slice()
            .map((n) => {
              const alertAt =
                n.alertDate && n.alertTime ? app.getAlertDateTime(n) : null;
              const createdAtTs = new Date(n.createdAt || "").getTime();
              return {
                ...n,
                _countdown: app.getCountdownMeta(alertAt, now),
                _createdAtTs: Number.isFinite(createdAtTs) ? createdAtTs : 0,
              };
            })
            .sort((a, b) => {
              if (a._countdown.orderBucket !== b._countdown.orderBucket) {
                return a._countdown.orderBucket - b._countdown.orderBucket;
              }
              if (a._countdown.orderBucket === 2) {
                return b._createdAtTs - a._createdAtTs;
              }
              if (a._countdown.orderValue !== b._countdown.orderValue) {
                return a._countdown.orderValue - b._countdown.orderValue;
              }
              return b._createdAtTs - a._createdAtTs;
            });

          if (notes.length === 0) {
            this.setInnerHtmlIfChanged(
              list,
              `<div class="text-center opacity-40 text-xs mt-10">${STR.noNotes}</div>`,
            );
            return;
          }

          const noteHtml = notes
            .map((n) => {
              const countdown = n._countdown || app.getCountdownMeta(null, now);
              const cls = app.data.classes.find((c) => c.id === n.classId);
              const classTitle = cls
                ? this.escapeHtml(cls.name)
                : this.escapeHtml(STR.unknownClass);
              const classMeta = cls
                ? `${STR.days[cls.day]} | <span style="font-family: var(--font-en);">${cls.start}-${cls.end}</span>`
                : this.escapeHtml(STR.unknownClass);

              const d = new Date(n.createdAt);
              const dateText = Number.isNaN(d.getTime())
                ? "-"
                : d.toLocaleDateString("fa-IR");
              const alertDay = app.getAlertDayLabel(n.alertDate);
              const alertMeta =
                n.alertDate && n.alertTime
                  ? `${alertDay} | <span style="font-family: var(--font-en);">${n.alertDate} ${n.alertTime}</span>`
                  : "-";
              const notifyMeta =
                n.important && n.notifyEnabled
                  ? `${app.getNotifyBeforeLabel(n.notifyBeforeMin)}`
                  : "-";
              const remainStyle = countdown.hasTarget
                ? countdown.isUpcoming
                  ? "color:#16a34a;"
                  : "color:#e11d48;"
                : "color:var(--muted);";
              const importantBadge = n.important
                ? `<span class="badge badge-alert"> ${STR.alertBoard}</span>`
                : "";

              return `
          <div onclick="ui.openNoteModal(${n.id})" class="p-3 rounded-2xl border border-[var(--border)] cursor-pointer hover:brightness-105 transition-all"
               style="background: color-mix(in srgb, var(--card-bg) 80%, transparent); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px);">
            <div class="flex justify-between items-start gap-2 mb-1">
              <span class="font-black text-xs leading-5">${classTitle}</span>
              <button onclick="ui.deleteNoteFromCard(event, ${n.id})"
                      class="w-6 h-6 rounded-full text-red-500 hover:bg-red-500/10 text-sm font-black leading-none"></button>
            </div>
            <div class="text-[11px] mb-2 opacity-80 flex items-center justify-between gap-2">${classMeta}${importantBadge}</div>
            <div class="text-[10px] mb-1 opacity-70">${STR.alertDay}: ${alertMeta}</div>
            <div class="text-[10px] mb-1 font-black" style="${remainStyle}">
               ${this.escapeHtml(countdown.daysText)} | ${this.escapeHtml(countdown.detailText)}
            </div>
            <div class="text-[10px] mb-2 opacity-70">${STR.notifyWhen}: ${this.escapeHtml(notifyMeta)}</div>
            <div class="text-[11px] leading-5">${this.escapeHtml(n.text)}</div>
            <div class="text-[10px] mt-2 opacity-60" style="font-family: var(--font-en);">${dateText}</div>
          </div>
        `;
            })
            .join("");
          this.setInnerHtmlIfChanged(list, noteHtml);
        },

        renderHandouts() {
          const list = document.getElementById("handoutList");
          if (!list) return;

          const courses = app.getUniqueCourses();
          const courseOrder = new Map(courses.map((c, idx) => [c.key, idx]));
          const items = app.data.handouts.slice().sort((a, b) => {
            const ak = app.normalizeCourseKey(a.courseName || a.courseKey);
            const bk = app.normalizeCourseKey(b.courseName || b.courseKey);
            const ai = courseOrder.has(ak)
              ? courseOrder.get(ak)
              : Number.MAX_SAFE_INTEGER;
            const bi = courseOrder.has(bk)
              ? courseOrder.get(bk)
              : Number.MAX_SAFE_INTEGER;
            if (ai !== bi) return ai - bi;
            const at = new Date(a.updatedAt || a.createdAt || 0).getTime();
            const bt = new Date(b.updatedAt || b.createdAt || 0).getTime();
            if (Number.isFinite(at) && Number.isFinite(bt) && at !== bt) {
              return bt - at;
            }
            return String(a.title || "").localeCompare(
              String(b.title || ""),
              "fa",
            );
          });

          if (items.length === 0) {
            this.setInnerHtmlIfChanged(
              list,
              `<div class="text-center opacity-40 text-xs mt-10">${STR.handoutNoData}</div>`,
            );
            return;
          }

          const handoutHtml = items
            .map((h) => {
              const safeId = Number(h.id) || 0;
              const safeCourse = this.escapeHtml(
                h.courseName || STR.unknownClass,
              );
              const safeTitle = this.escapeHtml(h.title || "-");
              const safeNote = this.escapeHtml(h.note || "");
              const safeLink = this.escapeHtml(h.link || "");
              const safeAttachmentName = this.escapeHtml(
                h.attachmentName || STR.handoutAttachment,
              );
              const safeAttachmentData = this.escapeHtml(
                h.attachmentData || "",
              );

              const updatedTs = new Date(
                h.updatedAt || h.createdAt || "",
              ).getTime();
              const updatedLabel = Number.isFinite(updatedTs)
                ? new Date(updatedTs).toLocaleDateString("fa-IR", {
                    month: "long",
                    day: "numeric",
                  })
                : "-";

              const linkBtn = h.link
                ? `<button type="button" class="handout-action" onclick="ui.openHandoutAsset(event, '${safeLink}')">${this.escapeHtml(STR.handoutOpenLink)}</button>`
                : "";
              const linkDownloadBtn = h.link
                ? `<button type="button" class="handout-action" onclick="ui.downloadHandoutLink(event, '${safeLink}', '${safeTitle}')">${this.escapeHtml(STR.handoutDownloadLink)}</button>`
                : "";
              const fileBtn =
                h.attachmentData && h.attachmentType === "file"
                  ? `<button type="button" class="handout-action" onclick="ui.openHandoutAsset(event, '${safeAttachmentData}')">${this.escapeHtml(STR.handoutOpenFile)}</button>`
                  : "";
              const attachmentDownloadBtn = h.attachmentData
                ? `<button type="button" class="handout-action" onclick="ui.downloadDataUrlFile(event, '${safeAttachmentData}', '${safeAttachmentName}', '${safeTitle}')">${this.escapeHtml(h.attachmentType === "image" ? STR.handoutDownloadImage : STR.handoutDownloadFile)}</button>`
                : "";
              const imagePreview =
                h.attachmentData && h.attachmentType === "image"
                  ? `<img class="handout-thumb" src="${safeAttachmentData}" alt="${safeTitle}" loading="lazy" onclick="ui.openHandoutAsset(event, '${safeAttachmentData}')" />`
                  : "";
              const fileMeta =
                h.attachmentData && h.attachmentType === "file"
                  ? `<div class="handout-meta mt-2"> ${safeAttachmentName}</div>`
                  : "";

              return `
                <div onclick="ui.openHandoutModal(${safeId})" class="p-3 rounded-2xl border border-[var(--border)] cursor-pointer hover:brightness-105 transition-all"
                     style="background: color-mix(in srgb, var(--card-bg) 82%, transparent); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px);">
                  <div class="flex justify-between items-start gap-2 mb-1">
                    <span class="font-black text-xs leading-5">${safeTitle}</span>
                    <button onclick="ui.deleteHandoutFromCard(event, ${safeId})"
                            class="w-6 h-6 rounded-full text-red-500 hover:bg-red-500/10 text-sm font-black leading-none"></button>
                  </div>
                  <div class="flex items-center justify-between gap-2 mb-2">
                    <span class="handout-course"> ${safeCourse}</span>
                    <span class="handout-meta">${this.escapeHtml(updatedLabel)}</span>
                  </div>
                  ${safeNote ? `<div class="handout-note mb-2">${safeNote}</div>` : ""}
                  ${imagePreview}
                  ${fileMeta}
                  <div class="mt-2 flex items-center gap-2 flex-wrap">
                    ${linkBtn}
                    ${linkDownloadBtn}
                    ${fileBtn}
                    ${attachmentDownloadBtn}
                  </div>
                </div>
              `;
            })
            .join("");
          this.setInnerHtmlIfChanged(list, handoutHtml);
        },

        renderCourseProgress() {
          const list = document.getElementById("courseProgressList");
          const summary = document.getElementById("courseProgressSummary");
          if (!list || !summary) return;

          const courses = app.getUniqueCourses();
          const courseIndex = new Map(courses.map((c, idx) => [c.key, idx]));

          const items = app.data.courseProgress.slice().sort((a, b) => {
            const ak = app.normalizeCourseKey(
              a.courseName || app.getCourseNameByClassId(a.classId),
            );
            const bk = app.normalizeCourseKey(
              b.courseName || app.getCourseNameByClassId(b.classId),
            );
            const ai = courseIndex.has(ak)
              ? courseIndex.get(ak)
              : Number.MAX_SAFE_INTEGER;
            const bi = courseIndex.has(bk)
              ? courseIndex.get(bk)
              : Number.MAX_SAFE_INTEGER;
            if (ai !== bi) return ai - bi;
            return new Date(b.updatedAt) - new Date(a.updatedAt);
          });

          const trackedCount = items.length;
          const totalCourses = courses.length;
          const untrackedCount = Math.max(0, totalCourses - trackedCount);
          const avgProgress = trackedCount
            ? Math.round(
                items.reduce(
                  (sum, p) => sum + Math.max(0, Number(p.coveragePercent) || 0),
                  0,
                ) / trackedCount,
              )
            : 0;

          const toFa = (n) => Number(n || 0).toLocaleString("fa-IR");
          const summaryHtml = `
            <div class="course-progress-stats">
              <div class="course-progress-stat">
                <div class="value">${toFa(trackedCount)}</div>
                <div class="label">${STR.progressTracked}</div>
              </div>
              <div class="course-progress-stat">
                <div class="value">${toFa(avgProgress)}%</div>
                <div class="label">${STR.progressAverage}</div>
              </div>
              <div class="course-progress-stat">
                <div class="value">${toFa(untrackedCount)}</div>
                <div class="label">${STR.progressUntracked}</div>
              </div>
            </div>
          `;
          this.setInnerHtmlIfChanged(summary, summaryHtml);

          if (items.length === 0) {
            this.setInnerHtmlIfChanged(
              list,
              `<div class="text-center opacity-45 text-xs mt-10">${STR.progressNoData}</div>`,
            );
            return;
          }

          const progressHtml = items
            .map((p) => {
              const courseName = String(
                p.courseName || app.getCourseNameByClassId(p.classId),
              ).trim();
              const courseKey = app.normalizeCourseKey(courseName);
              const courseInfo =
                courses.find((c) => c.key === courseKey) || null;

              const classTitle = this.escapeHtml(
                courseInfo?.name || courseName || STR.unknownClass,
              );
              const classMeta = courseInfo?.prof
                ? `: ${this.escapeHtml(courseInfo.prof)}`
                : "";
              const percent = Math.min(
                100,
                Math.max(0, Math.round(Number(p.coveragePercent) || 0)),
              );
              const percentFa = toFa(percent);
              const taughtUntil = this.escapeHtml(p.taughtUntil || "-");
              const nextTopic = this.escapeHtml(p.nextTopic || "");
              const sessionNo = Math.max(
                0,
                Math.floor(Number(p.sessionNo) || 0),
              );
              const sessionChip =
                sessionNo > 0
                  ? `<span class="chip py-1 px-2"> ${toFa(sessionNo)}</span>`
                  : "";

              const updated = new Date(p.updatedAt || "");
              const updatedLabel = Number.isNaN(updated.getTime())
                ? "-"
                : updated.toLocaleDateString("fa-IR", {
                    month: "long",
                    day: "numeric",
                  });

              return `
                <div onclick="ui.openCourseProgressModal(${p.id})" class="p-3 rounded-2xl border border-[var(--border)] cursor-pointer hover:brightness-105 transition-all"
                     style="background: color-mix(in srgb, var(--card-bg) 80%, transparent); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px);">
                  <div class="flex justify-between items-start gap-2 mb-1">
                    <span class="font-black text-xs leading-5">${classTitle}</span>
                    <button onclick="ui.deleteCourseProgressFromCard(event, ${p.id})"
                            class="w-6 h-6 rounded-full text-red-500 hover:bg-red-500/10 text-sm font-black leading-none"></button>
                  </div>
                  ${classMeta ? `<div class="text-[10px] mb-2 opacity-75">${classMeta}</div>` : `<div class="mb-2"></div>`}
                  <div class="flex items-center justify-between gap-2 mb-1">
                    <span class="chip py-1 px-2">${percentFa}%</span>
                    ${sessionChip}
                  </div>
                  <div class="course-progress-line mb-2" style="--progress: ${percent}%;" role="progressbar" aria-label="  " aria-valuemin="0" aria-valuemax="100" aria-valuenow="${percent}">
                    <span></span>
                  </div>
                  <div class="text-[11px] leading-5 mb-1">
                    <span class="opacity-70">${STR.progressUntil}:</span>
                    <span>${taughtUntil}</span>
                  </div>
                  ${nextTopic ? `<div class="text-[10px] opacity-75">${STR.progressNextTopic}: ${nextTopic}</div>` : ""}
                  <div class="text-[10px] mt-2 opacity-60">${STR.progressUpdatedAt}: ${this.escapeHtml(updatedLabel)}</div>
                </div>
              `;
            })
            .join("");
          this.setInnerHtmlIfChanged(list, progressHtml);
        },

        renderAttendance() {
          const summary = document.getElementById("attendanceSummary");
          const list = document.getElementById("attendanceList");
          if (!summary || !list) return;

          const allCourses = app.getUniqueCourses();
          if (!allCourses.length) {
            this.setInnerHtmlIfChanged(summary, "");
            this.setInnerHtmlIfChanged(
              list,
              `<div class="attendance-empty">${this.escapeHtml(STR.attendanceNoCourses)}</div>`,
            );
            return;
          }

          const toFa = (value) => Number(value || 0).toLocaleString("en-US");
          const mode = app.getAttendanceViewMode();
          const statusFilter = this.getAttendanceStatusFilter();
          const targetDateKey = app.getAttendanceTargetDateKey();
          const targetDate = app.getDateFromKey(targetDateKey) || new Date();
          const canEdit = app.canEditAttendanceDate(targetDateKey);

          const scheduledCourses =
            app.getScheduledCoursesForDate(targetDateKey);
          const scheduledMap = new Map(scheduledCourses.map((c) => [c.key, c]));
          const attendanceStore =
            app.data?.attendance && typeof app.data.attendance === "object"
              ? app.data.attendance
              : {};
          const statusByCourse = new Map();
          const countsByCourse = new Map();
          const limitsByCourse = new Map();

          Object.entries(attendanceStore).forEach(([rawKey, rawRecord]) => {
            const record =
              rawRecord && typeof rawRecord === "object" ? rawRecord : {};
            const courseKey = app.normalizeCourseKey(
              record.courseKey || rawKey,
            );
            if (!courseKey) return;

            const logs =
              record.logs && typeof record.logs === "object" ? record.logs : {};
            let present = 0;
            let absent = 0;
            Object.entries(logs).forEach(([rawDate, rawStatus]) => {
              const dateKey = app.normalizeDateKey(rawDate);
              const status = String(rawStatus || "").trim();
              if (status === "present") {
                present += 1;
                if (dateKey === targetDateKey)
                  statusByCourse.set(courseKey, "present");
                return;
              }
              if (status === "absent") {
                absent += 1;
                if (dateKey === targetDateKey)
                  statusByCourse.set(courseKey, "absent");
              }
            });

            countsByCourse.set(courseKey, {
              present,
              absent,
              total: present + absent,
            });

            const recordLimit = Number(record.absenceLimit);
            if (Number.isFinite(recordLimit) && recordLimit > 0) {
              limitsByCourse.set(
                courseKey,
                Math.max(1, Math.min(30, Math.floor(recordLimit))),
              );
            }
          });

          const defaultAbsenceLimit = app.getAttendanceAbsenceLimit("");
          const getCourseStatus = (courseKey) => {
            const key = app.normalizeCourseKey(courseKey);
            if (!key) return "";
            const status = String(statusByCourse.get(key) || "").trim();
            return status === "present" || status === "absent" ? status : "";
          };
          const getCourseCounts = (courseKey) => {
            const key = app.normalizeCourseKey(courseKey);
            if (!key) return { present: 0, absent: 0, total: 0 };
            return (
              countsByCourse.get(key) || {
                present: 0,
                absent: 0,
                total: 0,
              }
            );
          };
          const getCourseLimit = (courseKey) => {
            const key = app.normalizeCourseKey(courseKey);
            if (!key) return defaultAbsenceLimit;
            return limitsByCourse.get(key) || defaultAbsenceLimit;
          };
          const isCourseAtRisk = (absentCount, limit) =>
            Number(limit) > 1 && Number(absentCount) === Number(limit) - 1;

          let visibleCourses =
            mode === "today"
              ? scheduledCourses
              : allCourses.map((course) => {
                  const scheduled = scheduledMap.get(course.key);
                  if (scheduled) return scheduled;
                  return {
                    ...course,
                    dayClasses: [],
                    firstStart: "",
                  };
                });

          if (mode === "all") {
            visibleCourses = visibleCourses.slice().sort((a, b) => {
              const aHas =
                Array.isArray(a.dayClasses) && a.dayClasses.length > 0;
              const bHas =
                Array.isArray(b.dayClasses) && b.dayClasses.length > 0;
              if (aHas !== bHas) return aHas ? -1 : 1;
              const byTime = String(a.firstStart || "").localeCompare(
                String(b.firstStart || ""),
              );
              if (byTime !== 0) return byTime;
              return String(a.name || "").localeCompare(
                String(b.name || ""),
                "fa",
              );
            });
          }

          const allRiskMeta = allCourses.map((course) => {
            const counts = getCourseCounts(course.key);
            const limit = getCourseLimit(course.key);
            return {
              key: course.key,
              name: String(course.name || "").trim(),
              atRisk: isCourseAtRisk(counts.absent, limit),
            };
          });

          const visibleMeta = visibleCourses.map((course) => {
            const dayClasses = Array.isArray(course.dayClasses)
              ? course.dayClasses
              : [];
            const hasClassToday = dayClasses.length > 0;
            const status = getCourseStatus(course.key);
            const counts = getCourseCounts(course.key);
            const limit = getCourseLimit(course.key);
            const atRisk = isCourseAtRisk(counts.absent, limit);
            return {
              course,
              dayClasses,
              hasClassToday,
              status,
              counts,
              limit,
              atRisk,
            };
          });

          const filterMatch = (meta) => {
            if (!meta) return false;
            if (statusFilter === "pending")
              return meta.hasClassToday && !meta.status;
            if (statusFilter === "risk") return meta.atRisk;
            return true;
          };

          const filteredMeta = visibleMeta.filter(filterMatch);
          const pendingFilterCount = visibleMeta.filter(
            (meta) => meta.hasClassToday && !meta.status,
          ).length;
          const riskFilterCount = visibleMeta.filter(
            (meta) => meta.atRisk,
          ).length;
          const allFilterCount = visibleMeta.length;

          const todayPresent = scheduledCourses.filter(
            (course) => getCourseStatus(course.key) === "present",
          ).length;
          const todayAbsent = scheduledCourses.filter(
            (course) => getCourseStatus(course.key) === "absent",
          ).length;
          const todayPending = Math.max(
            0,
            scheduledCourses.length - todayPresent - todayAbsent,
          );
          const todayRecorded = todayPresent + todayAbsent;
          const todayCoverage =
            scheduledCourses.length > 0
              ? Math.round((todayRecorded / scheduledCourses.length) * 100)
              : 0;
          const totalAtRiskCourses = allRiskMeta.filter((x) => x.atRisk).length;
          const canUndo = Array.isArray(this.attendanceUndoStack)
            ? this.attendanceUndoStack.length > 0
            : false;

          const pendingPreview = scheduledCourses
            .filter((course) => !getCourseStatus(course.key))
            .map((course) => String(course.name || "").trim())
            .filter(Boolean)
            .slice(0, 2);
          const riskPreview = allRiskMeta
            .filter((item) => item.atRisk)
            .map((item) => item.name)
            .filter(Boolean)
            .slice(0, 2);

          const insightItems = [];
          if (!canEdit) {
            insightItems.push({
              tone: "info",
              title: STR.attendanceInsightLockedTitle,
              note: STR.attendanceInsightLockedBody,
            });
          }
          if (todayPending > 0) {
            const remain = Math.max(0, todayPending - pendingPreview.length);
            let pendingNote = STR.attendanceInsightPendingBody;
            if (pendingPreview.length > 0) {
              pendingNote += ` (${pendingPreview.join(" ")}`;
              if (remain > 0) {
                pendingNote += ` +${toFa(remain)}  `;
              }
              pendingNote += ")";
            }
            insightItems.push({
              tone: "warn",
              title: STR.attendanceInsightPendingTitle,
              badge: toFa(todayPending),
              note: pendingNote,
            });
          } else if (scheduledCourses.length > 0) {
            insightItems.push({
              tone: "ok",
              title: STR.attendanceInsightDoneTitle,
              note: STR.attendanceInsightDoneBody,
            });
          }
          if (totalAtRiskCourses > 0) {
            const remain = Math.max(0, totalAtRiskCourses - riskPreview.length);
            let riskNote = STR.attendanceInsightRiskBody;
            if (riskPreview.length > 0) {
              riskNote += ` (${riskPreview.join(" ")}`;
              if (remain > 0) {
                riskNote += ` +${toFa(remain)}  `;
              }
              riskNote += ")";
            }
            insightItems.push({
              tone: "risk",
              title: STR.attendanceInsightRiskTitle,
              badge: toFa(totalAtRiskCourses),
              note: riskNote,
            });
          }

          const insightPanelHtml = insightItems.length
            ? `
              <div class="attendance-alert-rack">
                ${insightItems
                  .map(
                    (item) => `
                      <div class="attendance-alert-card tone-${this.escapeHtml(item.tone)}">
                        <div class="attendance-alert-title">${this.escapeHtml(item.title)}${item.badge ? `: <span class="attendance-num">${this.escapeHtml(item.badge)}</span>` : ""}</div>
                        <div class="attendance-alert-note">${this.escapeHtml(item.note)}</div>
                      </div>
                    `,
                  )
                  .join("")}
              </div>
            `
            : "";

          const summaryHtml = `
            <div class="attendance-summary">
              <div class="attendance-summary-item">
                <div class="value">${toFa(scheduledCourses.length)}</div>
                <div class="label">${this.escapeHtml(STR.attendanceSummaryCourses)}</div>
              </div>
              <div class="attendance-summary-item">
                <div class="value">${toFa(todayPresent)}</div>
                <div class="label">${this.escapeHtml(STR.attendanceSummaryPresent)}</div>
              </div>
              <div class="attendance-summary-item">
                <div class="value">${toFa(todayAbsent)}</div>
                <div class="label">${this.escapeHtml(STR.attendanceSummaryAbsent)}</div>
              </div>
              <div class="attendance-summary-item">
                <div class="value">${toFa(todayPending)}</div>
                <div class="label">${this.escapeHtml(STR.attendanceSummaryPending)}</div>
              </div>
            </div>
            <div class="attendance-count-row">
              <span class="attendance-count-badge is-present">
                ${this.escapeHtml(STR.attendanceSummaryRecorded)}:
                <span class="num">${toFa(todayRecorded)}</span> / <span class="num">${toFa(scheduledCourses.length)}</span>
                (<span class="attendance-num">${toFa(todayCoverage)}</span>%)
              </span>
            </div>
          `;
          this.setInnerHtmlIfChanged(summary, summaryHtml);

          const dateLabel = targetDate.toLocaleDateString("fa-IR-u-nu-latn", {
            weekday: "long",
            month: "long",
            day: "numeric",
          });
          const viewBadge =
            mode === "today" ? STR.attendanceViewToday : STR.attendanceViewAll;
          const lockText = canEdit ? " " : " ";
          const filterBarHtml = `
            <div class="attendance-panel-head">
              <div class="attendance-panel-top">
                <div class="attendance-filter-stack">
                  <div class="attendance-segment">
                    <button type="button" class="attendance-segment-btn ${mode === "today" ? "is-active" : ""}" onclick="ui.setAttendanceViewMode('today')">${this.escapeHtml(STR.attendanceViewToday)}</button>
                    <button type="button" class="attendance-segment-btn ${mode === "all" ? "is-active" : ""}" onclick="ui.setAttendanceViewMode('all')">${this.escapeHtml(STR.attendanceViewAll)}</button>
                  </div>
                  <div class="attendance-segment">
                    <button type="button" class="attendance-segment-btn ${statusFilter === "all" ? "is-active" : ""}" onclick="ui.setAttendanceStatusFilter('all')">${this.escapeHtml(STR.attendanceStatusFilterAll)}<span class="count">${toFa(allFilterCount)}</span></button>
                    <button type="button" class="attendance-segment-btn ${statusFilter === "pending" ? "is-active" : ""}" onclick="ui.setAttendanceStatusFilter('pending')">${this.escapeHtml(STR.attendanceStatusFilterPending)}<span class="count">${toFa(pendingFilterCount)}</span></button>
                    <button type="button" class="attendance-segment-btn ${statusFilter === "risk" ? "is-active" : ""}" onclick="ui.setAttendanceStatusFilter('risk')">${this.escapeHtml(STR.attendanceStatusFilterRisk)}<span class="count">${toFa(riskFilterCount)}</span></button>
                  </div>
                </div>
                <div class="attendance-tools">
                  <button type="button" class="attendance-tool-btn" onclick="ui.openAttendanceSettingsModal()"></button>
                  <button type="button" class="attendance-tool-btn" onclick="app.exportAttendanceBackup()">${this.escapeHtml(STR.attendanceExport)}</button>
                </div>
              </div>
              <div class="attendance-date-chip">
                <span>${this.escapeHtml(STR.attendanceDateLabel)}:</span>
                <span>${this.escapeHtml(dateLabel)}</span>
                <span></span>
                <span>${this.escapeHtml(viewBadge)}</span>
                <span></span>
                <span>${this.escapeHtml(lockText)}</span>
              </div>
            </div>
          `;
          const bulkActionsHtml =
            canEdit && scheduledCourses.length
              ? `
                <div class="attendance-tools attendance-bulk-actions">
                  <button type="button" class="attendance-tool-btn" onclick="ui.applyAttendanceBulk('present-pending')">${this.escapeHtml(STR.attendanceBulkPresentPending)}</button>
                  <button type="button" class="attendance-tool-btn" onclick="ui.applyAttendanceBulk('absent-pending')">${this.escapeHtml(STR.attendanceBulkAbsentPending)}</button>
                  <button type="button" class="attendance-tool-btn" onclick="ui.applyAttendanceBulk('copy-prev-week')">${this.escapeHtml(STR.attendanceBulkCopyPrevWeek)}</button>
                  <button type="button" class="attendance-tool-btn" onclick="ui.applyAttendanceBulk('clear-day')">${this.escapeHtml(STR.attendanceBulkClearToday)}</button>
                  <button type="button" class="attendance-tool-btn" onclick="ui.undoAttendanceLastChange()" ${canUndo ? "" : "disabled"}>${this.escapeHtml(STR.attendanceUndo)}</button>
                </div>
              `
              : "";

          if (!filteredMeta.length) {
            const emptyHtml = `
              ${filterBarHtml}
              ${insightPanelHtml}
              ${bulkActionsHtml}
              <div class="attendance-empty">${this.escapeHtml(STR.attendanceNoItemsToday)}</div>
            `;
            this.setInnerHtmlIfChanged(list, emptyHtml);
            return;
          }

          const cardsHtml = filteredMeta
            .map((meta) => {
              const course = meta.course;
              const dayClasses = meta.dayClasses;
              const hasClassToday = meta.hasClassToday;
              const status = meta.status;
              const counts = meta.counts;
              const ratioPercent =
                counts.total > 0
                  ? Math.max(
                      0,
                      Math.min(
                        100,
                        Math.round(
                          (counts.present / Math.max(1, counts.total)) * 100,
                        ),
                      ),
                    )
                  : 0;
              const limit = meta.limit;
              const nearLimitWarning = meta.atRisk;
              const remaining = Math.max(
                0,
                Number(limit) - Number(counts.absent),
              );

              let statusClass = "pending";
              let statusLabel = STR.attendanceStatusPending;
              if (!hasClassToday) {
                statusClass = "no-class";
                statusLabel = STR.attendanceStatusNoClassToday;
              } else if (status === "present") {
                statusClass = "present";
                statusLabel = STR.attendanceStatusPresent;
              } else if (status === "absent") {
                statusClass = "absent";
                statusLabel = STR.attendanceStatusAbsent;
              }

              const encodedKey = encodeURIComponent(String(course.key || ""));
              const encodedName = encodeURIComponent(String(course.name || ""));
              const profText = String(course.prof || "").trim();
              const courseMetaParts = [];
              if (profText)
                courseMetaParts.push(
                  `: ${this.escapeHtml(profText)}`,
                );
              if (hasClassToday) {
                const timeRanges = dayClasses
                  .map(
                    (cls) =>
                      `${this.escapeHtml(String(cls.start || "-"))}-${this.escapeHtml(String(cls.end || "-"))}`,
                  )
                  .join(" | ");
                if (timeRanges) courseMetaParts.push(timeRanges);
              }
              if (!hasClassToday && mode === "all") {
                courseMetaParts.push(
                  this.escapeHtml(STR.attendanceStatusNoClassToday),
                );
              }
              if (!courseMetaParts.length) courseMetaParts.push("-");

              const canAct = canEdit && hasClassToday;
              const clearDisabled = !canAct || !status;
              const remainingLabel = STR.attendanceRemainingLabel;
              const remainingStyle = remaining === 0 ? "color:#fcd34d;" : "";
              const warningHtml = nearLimitWarning
                ? `<div class="attendance-warning">${this.escapeHtml(STR.attendanceLimitWarningNear)}</div>`
                : "";

              return `
                <div class="attendance-list-item ${meta.atRisk ? "is-risk" : ""}">
                  <div class="attendance-head">
                    <div class="attendance-course">
                      <div class="attendance-course-title">${this.escapeHtml(String(course.name || STR.unknownClass))}</div>
                      <div class="attendance-course-meta">${courseMetaParts.join("  ")}</div>
                    </div>
                    <span class="attendance-status-pill status-${statusClass}">
                      ${this.escapeHtml(statusLabel)}
                    </span>
                  </div>

                  <div class="attendance-count-row">
                    <span class="attendance-count-badge is-present">
                      ${this.escapeHtml(STR.attendancePresentCount)}:
                      <span class="num">${toFa(counts.present)}</span>
                    </span>
                    <span class="attendance-count-badge is-absent">
                      ${this.escapeHtml(STR.attendanceAbsentCount)}:
                      <span class="num">${toFa(counts.absent)}</span>
                    </span>
                    <span class="attendance-ratio-text">
                      ${this.escapeHtml(STR.attendanceRatioLabel)}:
                      <span class="attendance-num">${toFa(ratioPercent)}%</span>
                    </span>
                  </div>
                  <div class="attendance-ratio-line" style="--attendance-ratio:${ratioPercent}%;" role="progressbar" aria-label="  " aria-valuemin="0" aria-valuemax="100" aria-valuenow="${ratioPercent}">
                    <span></span>
                  </div>

                  <div class="attendance-actions">
                    <button
                      type="button"
                      class="attendance-action-btn action-present ${status === "present" ? "is-active" : ""}"
                      onclick="ui.markAttendanceByKey('${encodedKey}', 'present', '${encodedName}')"
                      ${canAct ? "" : "disabled"}
                    >
                      ${this.escapeHtml(STR.attendanceActionPresent)}
                    </button>
                    <button
                      type="button"
                      class="attendance-action-btn action-absent ${status === "absent" ? "is-active" : ""}"
                      onclick="ui.markAttendanceByKey('${encodedKey}', 'absent', '${encodedName}')"
                      ${canAct ? "" : "disabled"}
                    >
                      ${this.escapeHtml(STR.attendanceActionAbsent)}
                    </button>
                    <button
                      type="button"
                      class="attendance-action-btn action-clear"
                      onclick="ui.clearAttendanceByKey('${encodedKey}')"
                      ${clearDisabled ? "disabled" : ""}
                    >
                      ${this.escapeHtml(STR.attendanceActionClear)}
                    </button>
                  </div>
                  <div class="attendance-meta-badges">
                    <span class="attendance-ratio-text">  : <span class="attendance-num">${toFa(limit)}</span></span>
                    <span class="attendance-ratio-text" style="${remainingStyle}">${this.escapeHtml(remainingLabel)}: <span class="attendance-num">${toFa(remaining)}</span></span>
                  </div>
                  ${warningHtml}
                </div>
              `;
            })
            .join("");

          const listHtml = `
            ${filterBarHtml}
            ${insightPanelHtml}
            ${bulkActionsHtml}
            ${cardsHtml}
          `;
          this.setInnerHtmlIfChanged(list, listHtml);
        },

        setAttendanceViewMode(mode) {
          app.setAttendanceViewMode(mode);
        },

        decodeAttendanceValue(raw) {
          const value = String(raw || "");
          try {
            return decodeURIComponent(value);
          } catch {
            return value;
          }
        },

        markAttendanceByKey(encodedCourseKey, status, encodedCourseName = "") {
          const courseKey = this.decodeAttendanceValue(encodedCourseKey);
          const courseName = this.decodeAttendanceValue(encodedCourseName);
          const dateKey = app.getAttendanceTargetDateKey();
          if (!app.canEditAttendanceDate(dateKey)) {
            alert(STR.attendanceEditLocked);
            return;
          }
          const prevStatus = app.getAttendanceStatus(courseKey, dateKey);
          if (prevStatus === status) return;
          this.pushAttendanceUndoSnapshot(dateKey, "single-change");
          const ok = app.setAttendanceStatus(courseKey, dateKey, status, {
            courseName,
          });
          if (!ok) {
            this.attendanceUndoStack.pop();
            alert(STR.attendanceNoChangesApplied);
          }
        },

        clearAttendanceByKey(encodedCourseKey) {
          const courseKey = this.decodeAttendanceValue(encodedCourseKey);
          const dateKey = app.getAttendanceTargetDateKey();
          if (!app.canEditAttendanceDate(dateKey)) {
            alert(STR.attendanceEditLocked);
            return;
          }
          const prevStatus = app.getAttendanceStatus(courseKey, dateKey);
          if (!prevStatus) return;
          this.pushAttendanceUndoSnapshot(dateKey, "single-clear");
          const ok = app.clearAttendanceStatus(courseKey, dateKey);
          if (!ok) {
            this.attendanceUndoStack.pop();
            alert(STR.attendanceNoChangesApplied);
          }
        },

        openAttendanceSettingsModal() {
          const settings = app.data.settings || {};
          const courses = app.getUniqueCourses();
          const mode = app.getAttendanceViewMode();
          const reminderEnabled = settings.attendanceReminderEnabled !== false;
          const reminderTime = app.normalizeTime(
            settings.attendanceReminderTime,
            DEFAULT_SETTINGS.attendanceReminderTime,
          );
          const defaultLimit = Math.max(
            1,
            Math.min(
              30,
              Math.floor(
                Number(settings.attendanceDefaultAbsenceLimit) ||
                  DEFAULT_SETTINGS.attendanceDefaultAbsenceLimit,
              ),
            ),
          );
          const allowPastEdit = Boolean(settings.attendanceAllowPastEdit);
          const activeDate = app.getAttendanceTargetDateKey();
          const toFa = (value) => Number(value || 0).toLocaleString("en-US");
          const customLimitCount = courses.reduce((count, course) => {
            const record = app.getAttendanceRecord(course.key, false);
            const customLimit = Number(record?.absenceLimit);
            return (
              count + (Number.isFinite(customLimit) && customLimit > 0 ? 1 : 0)
            );
          }, 0);

          const courseLimitRows = courses.length
            ? courses
                .map((course) => {
                  const record = app.getAttendanceRecord(course.key, false);
                  const customLimit = Number(record?.absenceLimit);
                  const courseName = String(course.name || STR.unknownClass);
                  const counts = app.getAttendanceCourseCounts(course.key);
                  const limitValue =
                    Number.isFinite(customLimit) && customLimit > 0
                      ? String(Math.floor(customLimit))
                      : "";
                  const effectiveLimit =
                    Number.isFinite(customLimit) && customLimit > 0
                      ? Math.max(1, Math.min(30, Math.floor(customLimit)))
                      : defaultLimit;
                  const remaining = Math.max(
                    0,
                    Number(effectiveLimit) - Number(counts.absent || 0),
                  );
                  const isRisk =
                    Number(effectiveLimit) > 1 &&
                    Number(counts.absent || 0) === Number(effectiveLimit) - 1;
                  const encodedKey = encodeURIComponent(
                    String(course.key || ""),
                  );
                  const encodedName = encodeURIComponent(courseName);
                  return `
                    <div class="att-course-limit-row flex items-center gap-2 rounded-xl border border-[var(--border)] px-2 py-2" data-custom="${limitValue ? "1" : "0"}">
                      <div class="min-w-0 flex-1">
                        <div class="att-course-name text-[11px] font-black opacity-90 truncate">${this.escapeHtml(courseName)}</div>
                        <div class="text-[10px] opacity-72 mt-1">
                          ${STR.attendanceAbsentCount}: <span class="attendance-num">${toFa(counts.absent)}</span> | ${STR.attendanceRemainingLabel}: <span class="attendance-num">${toFa(remaining)}</span>
                          ${isRisk ? ` | <span style="color:#f59e0b">${this.escapeHtml(STR.attendanceStatusFilterRisk)}</span>` : ""}
                        </div>
                      </div>
                      <input
                        type="number"
                        min="1"
                        max="30"
                        step="1"
                        value="${this.escapeHtml(limitValue)}"
                        data-course-key="${encodedKey}"
                        data-course-name="${encodedName}"
                        class="inp att-course-limit !w-[92px] !min-w-[92px]"
                        placeholder="${defaultLimit}"
                      />
                    </div>
                  `;
                })
                .join("")
            : `<div class="attendance-empty">${this.escapeHtml(STR.attendanceNoCourses)}</div>`;

          const html = `
            <div class="theme-card attendance-settings-modal p-4 shadow-2xl animate-fade-in" onclick="ui.stopEvent(event)"
                 style="background: color-mix(in srgb, var(--card-bg) 90%, transparent);">
              <div class="attendance-settings-head">
                <h3 class="text-xl font-black leading-tight">${this.escapeHtml(STR.attendanceSettingsTitle)}</h3>
              </div>
              <div class="attendance-settings-stats">
                <div class="attendance-settings-chip">${this.escapeHtml(STR.attendanceSettingsCourseCount)}: <span class="attendance-num">${toFa(courses.length)}</span></div>
                <div id="att_stat_custom" class="attendance-settings-chip">${this.escapeHtml(STR.attendanceSettingsCustomCount)}: <span class="attendance-num">${toFa(customLimitCount)}</span></div>
                <div id="att_stat_reminder" class="attendance-settings-chip">${this.escapeHtml(reminderEnabled ? STR.attendanceSettingsReminderOn : STR.attendanceSettingsReminderOff)}</div>
                <div id="att_stat_past" class="attendance-settings-chip">${this.escapeHtml(allowPastEdit ? STR.attendanceSettingsPastModeOn : STR.attendanceSettingsPastModeOff)}</div>
              </div>

              <form id="attendanceSettingsForm" class="attendance-settings-form">
                <div class="attendance-settings-scroll space-y-3">
                  <div class="attendance-settings-two-col">
                    <div>
                      <div class="text-[11px] opacity-70 font-black mb-1">${this.escapeHtml(STR.attendanceViewMode || STR.attendanceViewToday)}</div>
                      <select class="inp" id="att_view_mode">
                        <option value="today" ${mode === "today" ? "selected" : ""}>${this.escapeHtml(STR.attendanceViewToday)}</option>
                        <option value="all" ${mode === "all" ? "selected" : ""}>${this.escapeHtml(STR.attendanceViewAll)}</option>
                      </select>
                    </div>
                    <div>
                      <div class="text-[11px] opacity-70 font-black mb-1">${this.escapeHtml(STR.attendanceDefaultLimit)}</div>
                      <input class="inp" type="number" id="att_default_limit" min="1" max="30" step="1" value="${defaultLimit}">
                    </div>
                  </div>

                  <div class="attendance-settings-two-col">
                    <label class="flex items-center gap-2 text-[11px] font-black opacity-85 cursor-pointer rounded-xl border border-[var(--border)] px-3 py-2">
                      <input type="checkbox" id="att_reminder_enabled" class="accent-green-500" ${reminderEnabled ? "checked" : ""}>
                      <span> ${this.escapeHtml(STR.attendanceReminderEnabled)}</span>
                    </label>
                    <label class="flex items-center gap-2 text-[11px] font-black opacity-85 cursor-pointer rounded-xl border border-[var(--border)] px-3 py-2">
                      <input type="checkbox" id="att_allow_past" class="accent-cyan-500" ${allowPastEdit ? "checked" : ""}>
                      <span>${this.escapeHtml(STR.attendanceAllowPastEdit)}</span>
                    </label>
                  </div>

                  <div class="attendance-settings-two-col">
                    <div>
                      <div class="text-[11px] opacity-70 font-black mb-1">${this.escapeHtml(STR.attendanceReminderTime)}</div>
                      <input class="inp" type="time" id="att_reminder_time" value="${this.escapeHtml(reminderTime)}">
                    </div>
                    <div>
                      <div class="text-[11px] opacity-70 font-black mb-1">${this.escapeHtml(STR.attendanceActiveDate)}</div>
                      <div class="attendance-settings-inline">
                        <input class="inp" type="date" id="att_active_date" value="${this.escapeHtml(activeDate)}">
                        <button type="button" id="att_clear_active_date" class="px-2 py-2 rounded-xl text-[10px] font-black border border-[var(--border)] hover:brightness-110 whitespace-nowrap">${this.escapeHtml(STR.attendanceSettingsClearActiveDate)}</button>
                      </div>
                    </div>
                  </div>

                  <details class="attendance-settings-advanced"${courses.length ? "" : " open"}>
                    <summary>
                      <span>${this.escapeHtml(STR.attendanceCourseLimit)}</span>
                      <span id="att_limit_summary_count" class="attendance-settings-adv-meta"><span class="attendance-num">${toFa(customLimitCount)}</span> / <span class="attendance-num">${toFa(courses.length)}</span></span>
                    </summary>
                    <div class="attendance-settings-advanced-body">
                      ${
                        courses.length
                          ? `
                        <div class="text-[10px] opacity-72">${this.escapeHtml(STR.attendanceSettingsLimitHint)}</div>
                        <div class="attendance-settings-tools">
                          <div class="grid grid-cols-1 gap-2">
                            <input type="text" id="att_limit_search" class="inp" placeholder="${this.escapeHtml(STR.attendanceSettingsLimitSearch)}">
                            <label class="inline-flex items-center gap-2 text-[11px] font-black opacity-85 cursor-pointer">
                              <input type="checkbox" id="att_only_custom_limits" class="accent-sky-500">
                              <span>${this.escapeHtml(STR.attendanceSettingsOnlyCustom)}</span>
                            </label>
                          </div>
                          <div class="attendance-settings-quick">
                            <button type="button" id="att_apply_default_all" class="rounded-xl text-[10px] font-black border border-[var(--border)] hover:brightness-110 px-2">${this.escapeHtml(STR.attendanceSettingsApplyDefaultAll)}</button>
                            <button type="button" id="att_clear_custom_all" class="rounded-xl text-[10px] font-black border border-[var(--border)] hover:brightness-110 px-2">${this.escapeHtml(STR.attendanceSettingsClearCustomAll)}</button>
                          </div>
                        </div>
                      `
                          : ""
                      }
                      <div id="att_limit_list" class="attendance-settings-limit-list space-y-2">
                        ${courseLimitRows}
                      </div>
                      ${courses.length ? `<div id="att_limit_empty" class="attendance-empty hidden">${this.escapeHtml(STR.attendanceSettingsNoLimitMatch)}</div>` : ""}
                    </div>
                  </details>
                </div>

                <div class="attendance-settings-footer">
                  <button type="submit" class="py-2.5 bg-[var(--accent)] text-[var(--bg)] font-black rounded-2xl hover:brightness-110 shadow-xl">${this.escapeHtml(STR.attendanceSaveSettings)}</button>
                  <button type="button" onclick="app.exportAttendanceBackup()" class="px-3 py-2.5 rounded-2xl font-black hover:brightness-110 border border-[var(--border)] whitespace-nowrap">${this.escapeHtml(STR.attendanceExport)}</button>
                  <button type="button" onclick="ui.closeModal()" class="px-3 py-2.5 opacity-70 hover:opacity-100 rounded-2xl font-black whitespace-nowrap">${STR.cancel}</button>
                </div>
              </form>
            </div>
          `;

          const overlay = document.getElementById("modalOverlay");
          overlay.innerHTML = html;
          overlay.classList.remove("hidden");
          overlay.classList.add("flex");

          const reminderEnabledEl = document.getElementById(
            "att_reminder_enabled",
          );
          const reminderTimeEl = document.getElementById("att_reminder_time");
          const allowPastEl = document.getElementById("att_allow_past");
          const activeDateEl = document.getElementById("att_active_date");
          const clearActiveDateBtn = document.getElementById(
            "att_clear_active_date",
          );
          const defaultLimitEl = document.getElementById("att_default_limit");
          const searchInputEl = document.getElementById("att_limit_search");
          const onlyCustomEl = document.getElementById(
            "att_only_custom_limits",
          );
          const applyDefaultAllBtn = document.getElementById(
            "att_apply_default_all",
          );
          const clearCustomAllBtn = document.getElementById(
            "att_clear_custom_all",
          );

          const parseLimitValue = (raw, fallback, allowEmpty = false) => {
            const txt = String(raw ?? "").trim();
            if (allowEmpty && !txt) return "";
            const n = Number(txt);
            if (!Number.isFinite(n) || n <= 0) return String(fallback);
            return String(Math.max(1, Math.min(30, Math.floor(n))));
          };
          const getDefaultLimitValue = () =>
            parseLimitValue(
              defaultLimitEl ? defaultLimitEl.value : "",
              DEFAULT_SETTINGS.attendanceDefaultAbsenceLimit,
              false,
            );

          const getLimitInputs = () =>
            Array.from(document.querySelectorAll(".att-course-limit"));
          const getLimitRows = () =>
            Array.from(document.querySelectorAll(".att-course-limit-row"));

          const syncCustomCounter = () => {
            const customCount = getLimitInputs().reduce((count, inputEl) => {
              return count + (String(inputEl.value || "").trim() ? 1 : 0);
            }, 0);
            const customStatEl = document.getElementById("att_stat_custom");
            if (customStatEl) {
              customStatEl.innerHTML = `${this.escapeHtml(STR.attendanceSettingsCustomCount)}: <span class="attendance-num">${toFa(customCount)}</span>`;
            }
            const summaryCountEl = document.getElementById(
              "att_limit_summary_count",
            );
            if (summaryCountEl) {
              summaryCountEl.innerHTML = `<span class="attendance-num">${toFa(customCount)}</span> / <span class="attendance-num">${toFa(courses.length)}</span>`;
            }
          };

          const syncLimitInputPlaceholders = () => {
            const currentDefault = getDefaultLimitValue();
            if (defaultLimitEl) defaultLimitEl.value = currentDefault;
            getLimitInputs().forEach((inputEl) => {
              inputEl.placeholder = currentDefault;
            });
          };

          const applyCourseLimitFilter = () => {
            const query = String(searchInputEl?.value || "")
              .trim()
              .toLowerCase();
            const onlyCustom = Boolean(onlyCustomEl?.checked);
            let visibleCount = 0;
            getLimitRows().forEach((rowEl) => {
              const nameTxt = String(
                rowEl.querySelector(".att-course-name")?.textContent || "",
              )
                .trim()
                .toLowerCase();
              const inputEl = rowEl.querySelector(".att-course-limit");
              const hasCustom = Boolean(String(inputEl?.value || "").trim());
              const showBySearch = !query || nameTxt.includes(query);
              const showByCustom = !onlyCustom || hasCustom;
              const show = showBySearch && showByCustom;
              rowEl.classList.toggle("hidden", !show);
              if (show) visibleCount += 1;
            });
            const emptyEl = document.getElementById("att_limit_empty");
            if (emptyEl) emptyEl.classList.toggle("hidden", visibleCount !== 0);
          };

          const syncFormState = () => {
            if (reminderTimeEl && reminderEnabledEl) {
              reminderTimeEl.disabled = !reminderEnabledEl.checked;
            }
            if (activeDateEl && allowPastEl) {
              activeDateEl.disabled = !allowPastEl.checked;
            }
            if (clearActiveDateBtn && allowPastEl) {
              clearActiveDateBtn.disabled = !allowPastEl.checked;
            }
            const reminderStatEl = document.getElementById("att_stat_reminder");
            if (reminderStatEl && reminderEnabledEl) {
              reminderStatEl.textContent = reminderEnabledEl.checked
                ? STR.attendanceSettingsReminderOn
                : STR.attendanceSettingsReminderOff;
            }
            const pastStatEl = document.getElementById("att_stat_past");
            if (pastStatEl && allowPastEl) {
              pastStatEl.textContent = allowPastEl.checked
                ? STR.attendanceSettingsPastModeOn
                : STR.attendanceSettingsPastModeOff;
            }
          };

          if (defaultLimitEl) {
            defaultLimitEl.addEventListener("blur", () => {
              defaultLimitEl.value = getDefaultLimitValue();
              syncLimitInputPlaceholders();
            });
          }
          getLimitInputs().forEach((inputEl) => {
            inputEl.addEventListener("blur", () => {
              inputEl.value = parseLimitValue(
                inputEl.value,
                getDefaultLimitValue(),
                true,
              );
              syncCustomCounter();
              applyCourseLimitFilter();
            });
            inputEl.addEventListener("input", () => {
              syncCustomCounter();
              applyCourseLimitFilter();
            });
          });
          if (searchInputEl) {
            searchInputEl.addEventListener("input", applyCourseLimitFilter);
          }
          if (onlyCustomEl) {
            onlyCustomEl.addEventListener("change", applyCourseLimitFilter);
          }
          if (applyDefaultAllBtn) {
            applyDefaultAllBtn.addEventListener("click", () => {
              const currentDefault = getDefaultLimitValue();
              getLimitInputs().forEach((inputEl) => {
                inputEl.value = currentDefault;
              });
              syncCustomCounter();
              applyCourseLimitFilter();
            });
          }
          if (clearCustomAllBtn) {
            clearCustomAllBtn.addEventListener("click", () => {
              getLimitInputs().forEach((inputEl) => {
                inputEl.value = "";
              });
              syncCustomCounter();
              applyCourseLimitFilter();
            });
          }
          if (clearActiveDateBtn) {
            clearActiveDateBtn.addEventListener("click", () => {
              if (activeDateEl) activeDateEl.value = "";
            });
          }

          if (reminderEnabledEl) {
            reminderEnabledEl.addEventListener("change", syncFormState);
          }
          if (allowPastEl)
            allowPastEl.addEventListener("change", syncFormState);
          syncLimitInputPlaceholders();
          syncCustomCounter();
          applyCourseLimitFilter();
          syncFormState();

          document.getElementById("attendanceSettingsForm").onsubmit = (ev) => {
            ev.preventDefault();
            if (defaultLimitEl) {
              defaultLimitEl.value = getDefaultLimitValue();
            }
            getLimitInputs().forEach((inputEl) => {
              inputEl.value = parseLimitValue(
                inputEl.value,
                getDefaultLimitValue(),
                true,
              );
            });
            const viewMode =
              document.getElementById("att_view_mode").value === "all"
                ? "all"
                : "today";
            const reminderEnabled = Boolean(
              document.getElementById("att_reminder_enabled").checked,
            );
            const reminderTime = app.normalizeTime(
              document.getElementById("att_reminder_time").value,
              DEFAULT_SETTINGS.attendanceReminderTime,
            );
            const defaultLimit = Math.max(
              1,
              Math.min(
                30,
                Math.floor(
                  Number(getDefaultLimitValue()) ||
                    DEFAULT_SETTINGS.attendanceDefaultAbsenceLimit,
                ),
              ),
            );
            const allowPastEdit = Boolean(
              document.getElementById("att_allow_past").checked,
            );
            const activeDate = allowPastEdit
              ? app.normalizeDateKey(
                  document.getElementById("att_active_date").value,
                )
              : "";

            app.setAttendanceSettings(
              {
                attendanceViewMode: viewMode,
                attendanceReminderEnabled: reminderEnabled,
                attendanceReminderTime: reminderTime,
                attendanceDefaultAbsenceLimit: defaultLimit,
                attendanceAllowPastEdit: allowPastEdit,
                attendanceActiveDate: activeDate,
              },
              true,
            );

            document
              .querySelectorAll(".att-course-limit")
              .forEach((inputEl) => {
                const key = this.decodeAttendanceValue(
                  inputEl.getAttribute("data-course-key"),
                );
                const courseName = this.decodeAttendanceValue(
                  inputEl.getAttribute("data-course-name"),
                );
                app.setAttendanceAbsenceLimit(key, inputEl.value, courseName);
              });

            app.save();
            app.checkDueNotifications();
            ui.closeModal();
          };
        },

        renderAlerts() {
          const list = document.getElementById("alertList");
          if (!list) return;

          const now = new Date();
          const alerts = app.data.notes
            .filter((n) => n.important)
            .slice()
            .map((n) => {
              const alertAt =
                n.alertDate && n.alertTime ? app.getAlertDateTime(n) : null;
              const createdAtTs = new Date(n.createdAt || "").getTime();
              return {
                ...n,
                _countdown: app.getCountdownMeta(alertAt, now),
                _createdAtTs: Number.isFinite(createdAtTs) ? createdAtTs : 0,
              };
            })
            .sort((a, b) => {
              if (a._countdown.orderBucket !== b._countdown.orderBucket) {
                return a._countdown.orderBucket - b._countdown.orderBucket;
              }
              if (a._countdown.orderBucket === 2) {
                return b._createdAtTs - a._createdAtTs;
              }
              if (a._countdown.orderValue !== b._countdown.orderValue) {
                return a._countdown.orderValue - b._countdown.orderValue;
              }
              return b._createdAtTs - a._createdAtTs;
            });

          if (alerts.length === 0) {
            this.setInnerHtmlIfChanged(
              list,
              `<div class="text-center opacity-40 text-xs mt-10">${STR.noAlerts}</div>`,
            );
            return;
          }

          const alertHtml = alerts
            .map((n) => {
              const countdown = n._countdown || app.getCountdownMeta(null, now);
              const cls = app.data.classes.find((c) => c.id === n.classId);
              const classTitle = cls
                ? this.escapeHtml(cls.name)
                : this.escapeHtml(STR.unknownClass);
              const classMeta = cls
                ? `${STR.days[cls.day]} | <span style="font-family: var(--font-en);">${cls.start}-${cls.end}</span>`
                : this.escapeHtml(STR.unknownClass);
              const alertDay = app.getAlertDayLabel(n.alertDate);
              const alertMeta =
                n.alertDate && n.alertTime
                  ? `${alertDay} | <span style="font-family: var(--font-en);">${n.alertDate} ${n.alertTime}</span>`
                  : "-";
              const notifyText = this.escapeHtml(
                String(n.notifyText || n.text || ""),
              );
              const notifyMeta = this.escapeHtml(
                app.getNotifyBeforeLabel(n.notifyBeforeMin),
              );
              const remainStyle = countdown.hasTarget
                ? countdown.isUpcoming
                  ? "color:#16a34a;"
                  : "color:#e11d48;"
                : "color:var(--muted);";

              return `
          <div onclick="ui.openNoteModal(${n.id})" class="alert-card p-3 rounded-2xl border border-red-500/30 cursor-pointer hover:brightness-105 transition-all"
               style="background: color-mix(in srgb, var(--card-bg) 82%, transparent); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px);">
            <div class="flex justify-between items-start gap-2 mb-1">
              <span class="alert-card-title">${classTitle}</span>
              <div class="flex items-center gap-1">
                <button onclick="ui.dismissPinnedNoteAlert(event, ${n.id})"
                        class="px-2 py-1 rounded-xl text-[10px] font-black text-sky-600 hover:bg-sky-500/10"></button>
                <button onclick="ui.unpinNoteFromCard(event, ${n.id})"
                        class="px-2 py-1 rounded-xl text-[10px] font-black text-amber-600 hover:bg-amber-500/10">${STR.unpin}</button>
                <button onclick="ui.deleteNoteFromCard(event, ${n.id})"
                        class="w-6 h-6 rounded-full text-red-500 hover:bg-red-500/10 text-sm font-black leading-none"></button>
              </div>
            </div>
            <div class="alert-card-meta mb-2">${classMeta}</div>
            <div class="alert-card-meta mb-1">${STR.alertDay}: ${alertMeta}</div>
            <div class="alert-card-meta mb-1 font-black" style="${remainStyle}">
               ${this.escapeHtml(countdown.daysText)} | ${this.escapeHtml(countdown.detailText)}
            </div>
            <div class="alert-card-meta mb-1">${STR.notifyWhen}: ${notifyMeta}</div>
            ${notifyText ? `<div class="alert-card-highlight mb-2">${STR.notifyText}: ${notifyText}</div>` : ""}
            <div class="alert-card-highlight">${this.escapeHtml(n.text)}</div>
          </div>
        `;
            })
            .join("");
          this.setInnerHtmlIfChanged(list, alertHtml);
        },

        renderPinnedAlerts() {
          const bar = document.getElementById("pinnedAlertsBar");
          if (!bar) return;

          const alerts = app.data.notes
            .filter((n) => n.important && !app.isPinnedNoteDismissed(n))
            .slice()
            .sort((a, b) => {
              const aHasDate = a.alertDate && a.alertTime;
              const bHasDate = b.alertDate && b.alertTime;
              if (aHasDate && bHasDate) {
                const at = new Date(
                  `${a.alertDate}T${a.alertTime}:00`,
                ).getTime();
                const bt = new Date(
                  `${b.alertDate}T${b.alertTime}:00`,
                ).getTime();
                if (Number.isFinite(at) && Number.isFinite(bt)) return at - bt;
              }
              if (aHasDate !== bHasDate) return aHasDate ? -1 : 1;
              return new Date(b.createdAt) - new Date(a.createdAt);
            });
          const weeklyFoodReminder = app.getWeeklyFoodReminderInfo();
          const pinnedItems = [];

          if (weeklyFoodReminder) {
            pinnedItems.push({
              type: "food",
              payload: weeklyFoodReminder,
            });
          }

          const noteCap = weeklyFoodReminder ? 2 : 3;
          alerts.slice(0, noteCap).forEach((n) => {
            pinnedItems.push({
              type: "note",
              payload: n,
            });
          });

          if (pinnedItems.length === 0) {
            this.setInnerHtmlIfChanged(bar, "");
            bar.classList.add("hidden");
            document.body.classList.remove("has-pinned-alerts");
            return;
          }

          const pinnedHtml = pinnedItems
            .map((item) => {
              if (item.type === "food") {
                const reminder = item.payload;
                const reminderKey = this.escapeHtml(reminder.key);
                return `
                  <div class="pinned-alert-item pinned-alert-item--food">
                    <span class="pinned-alert-main">
                      <span class="pinned-alert-title">${this.escapeHtml(reminder.title)}</span>
                      <span class="pinned-alert-sub">${this.escapeHtml(reminder.subtitle)}</span>
                    </span>
                    <span class="pinned-alert-actions">
                      <span class="pinned-alert-icon pinned-alert-icon--food"></span>
                      <button type="button" class="pinned-alert-close" onclick="ui.dismissWeeklyFoodReminder(event, '${reminderKey}')" aria-label=" "></button>
                    </span>
                  </div>
                `;
              }

              const n = item.payload;
              const cls = app.data.classes.find((c) => c.id === n.classId);
              const classTitle = cls
                ? this.escapeHtml(cls.name)
                : this.escapeHtml(STR.unknownClass);
              const due =
                n.alertDate && n.alertTime
                  ? `${this.escapeHtml(app.getAlertDayLabel(n.alertDate))} | <span style="font-family: var(--font-en);">${this.escapeHtml(n.alertDate)} ${this.escapeHtml(n.alertTime)}</span>`
                  : "  ";
              const shortText = this.escapeHtml(
                String(n.notifyText || n.text || ""),
              );

              return `
                  <div class="pinned-alert-item pinned-alert-item--note">
                    <button type="button" class="pinned-alert-main-btn" onclick="ui.openNoteModal(${n.id})">
                      <span class="pinned-alert-main">
                        <span class="pinned-alert-title"> ${classTitle}</span>
                        <span class="pinned-alert-sub">${due}</span>
                        ${shortText ? `<span class="pinned-alert-sub">${shortText}</span>` : ""}
                      </span>
                    </button>
                    <span class="pinned-alert-actions">
                      <span class="pinned-alert-icon">!</span>
                      <button type="button" class="pinned-alert-close" onclick="ui.dismissPinnedNoteAlert(event, ${n.id})" aria-label=" "></button>
                    </span>
                  </div>
                `;
            })
            .join("");
          this.setInnerHtmlIfChanged(bar, pinnedHtml);

          bar.classList.remove("hidden");
          document.body.classList.add("has-pinned-alerts");
        },

        renderStats() {
          const weekClasses = app.getWeekClasses();

          // Units: sum of unique courses (max unit per course), ignore unit 0
          const map = new Map();
          for (const c of weekClasses) {
            const key = (c.name || "").trim();
            if (!key) continue;
            const u = Number(c.unit || 0);
            const prev = map.get(key) || 0;
            map.set(key, Math.max(prev, u));
          }
          const units = Array.from(map.values()).reduce(
            (a, b) => a + (b || 0),
            0,
          );

          const totalMinutes = weekClasses.reduce((sum, c) => {
            const diff = app.toMinutes(c.end) - app.toMinutes(c.start);
            return sum + Math.max(0, diff);
          }, 0);
          const hours = (totalMinutes / 60).toFixed(1);
          const classCount = weekClasses.length;

          document.getElementById("statUnits").innerText = String(units);
          document.getElementById("statHours").innerText = hours;
          document.getElementById("statClasses").innerText = String(classCount);
        },

        openHandoutModal(id = null) {
          const item = id ? app.data.handouts.find((x) => x.id === id) : null;
          const title = item ? STR.modalEdit : STR.modalAdd;
          const courses = app.getUniqueCourses();

          if (courses.length === 0) {
            const html = `
              <div class="theme-card p-6 w-full max-w-md shadow-2xl animate-fade-in" onclick="ui.stopEvent(event)"
                   style="background: color-mix(in srgb, var(--card-bg) 90%, transparent);">
                <h3 class="text-xl font-black mb-4">${STR.handoutsBoard}</h3>
                <p class="text-sm opacity-80 mb-4">         .</p>
                <button type="button" onclick="ui.closeModal()" class="w-full py-2.5 bg-[var(--accent)] text-[var(--bg)] font-black rounded-2xl hover:brightness-110 shadow-xl">${STR.cancel}</button>
              </div>
            `;
            const overlay = document.getElementById("modalOverlay");
            overlay.innerHTML = html;
            overlay.classList.remove("hidden");
            overlay.classList.add("flex");
            return;
          }

          const currentCourseKey = app.normalizeCourseKey(
            item?.courseName || item?.courseKey,
          );
          const defaultCourse =
            courses.find((c) => c.key === currentCourseKey) || courses[0];
          const defaultLink = this.escapeHtml(String(item?.link || ""));
          const defaultTitle = this.escapeHtml(String(item?.title || ""));
          const defaultNote = this.escapeHtml(String(item?.note || ""));
          const hasAttachment = Boolean(item?.attachmentData);
          const safeAttachmentName = this.escapeHtml(
            String(item?.attachmentName || STR.handoutAttachment),
          );
          const safeAttachmentData = this.escapeHtml(
            String(item?.attachmentData || ""),
          );
          const existingAttachmentPreview =
            hasAttachment && item?.attachmentType === "image"
              ? `<img src="${safeAttachmentData}" alt="${defaultTitle || "handout"}" class="handout-thumb" loading="lazy">`
              : hasAttachment
                ? `<div class="text-[11px] opacity-80 mt-2"> ${safeAttachmentName}</div>`
                : "";

          const html = `
            <div class="theme-card p-6 w-full max-w-md shadow-2xl animate-fade-in" onclick="ui.stopEvent(event)"
                 style="background: color-mix(in srgb, var(--card-bg) 90%, transparent);">
              <h3 class="text-xl font-black mb-4">${title} ${STR.handoutsBoard}</h3>

              <form id="handoutForm" class="space-y-3">
                <input type="hidden" id="h_id" value="${item ? item.id : ""}">

                <div class="text-[11px] opacity-70 font-black">${STR.noteClass}</div>
                <select class="inp" id="h_course" required>
                  ${courses
                    .map(
                      (c) =>
                        `<option value="${c.key}" ${c.key === defaultCourse.key ? "selected" : ""}>${this.escapeHtml(c.name)}${c.prof ? ` - ${this.escapeHtml(c.prof)}` : ""}</option>`,
                    )
                    .join("")}
                </select>

                <div class="text-[11px] opacity-70 font-black">${STR.handoutTitle}</div>
                <input class="inp" type="text" id="h_title" placeholder="${STR.handoutTitle}" value="${defaultTitle}" required>

                <div class="text-[11px] opacity-70 font-black">${STR.handoutLink}</div>
                <input class="inp" type="text" id="h_link" placeholder="https://..." value="${defaultLink}">

                <div class="text-[11px] opacity-70 font-black">${STR.handoutAttachment}</div>
                <input class="inp" type="file" id="h_file" accept="image/*,.pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.txt,.zip,.rar">

                ${hasAttachment ? `<div class="text-[11px] opacity-75">${STR.handoutAttachmentCurrent}: ${safeAttachmentName}</div>` : ""}
                ${existingAttachmentPreview}
                ${hasAttachment ? `<label class="flex items-center gap-2 text-xs font-black opacity-85 cursor-pointer"><input type="checkbox" id="h_remove_attachment" class="accent-red-500"><span>${STR.handoutAttachmentRemove}</span></label>` : ""}

                <div class="text-[11px] opacity-70 font-black">${STR.notes}</div>
                <textarea class="inp min-h-[90px]" id="h_note" placeholder="${STR.notes}">${defaultNote}</textarea>

                <div class="flex gap-2 mt-4 pt-2" style="border-top: 1px solid var(--border);">
                  <button type="submit" class="flex-1 py-2.5 bg-[var(--accent)] text-[var(--bg)] font-black rounded-2xl hover:brightness-110 shadow-xl">${STR.save}</button>
                  ${item ? `<button type="button" onclick="app.deleteHandout(${item.id})" class="px-3 py-2.5 text-red-500 hover:bg-red-500/10 rounded-2xl font-black">${STR.delete}</button>` : ""}
                  <button type="button" onclick="ui.closeModal()" class="px-3 py-2.5 opacity-70 hover:opacity-100 rounded-2xl font-black">${STR.cancel}</button>
                </div>
              </form>
            </div>
          `;

          const overlay = document.getElementById("modalOverlay");
          overlay.innerHTML = html;
          overlay.classList.remove("hidden");
          overlay.classList.add("flex");

          document.getElementById("handoutForm").onsubmit = async (ev) => {
            ev.preventDefault();

            const courseKey = app.normalizeCourseKey(
              document.getElementById("h_course").value,
            );
            const selectedCourse =
              courses.find((c) => c.key === courseKey) || null;
            const titleValue = document.getElementById("h_title").value.trim();
            const linkValue = app.normalizeUrl(
              document.getElementById("h_link").value.trim(),
            );
            const noteValue = document.getElementById("h_note").value.trim();
            const fileInput = document.getElementById("h_file");
            const selectedFile = fileInput?.files?.[0] || null;
            const removeOld = Boolean(
              document.getElementById("h_remove_attachment")?.checked,
            );

            let attachmentData =
              item && !removeOld ? String(item.attachmentData || "") : "";
            let attachmentType =
              item && !removeOld ? String(item.attachmentType || "") : "";
            let attachmentName =
              item && !removeOld ? String(item.attachmentName || "") : "";
            let attachmentMime =
              item && !removeOld ? String(item.attachmentMime || "") : "";

            if (selectedFile) {
              if (selectedFile.size > HANDOUT_MAX_FILE_BYTES) {
                alert(STR.handoutFileTooLarge);
                return;
              }
              const dataUrl = await app.readFileAsDataUrl(selectedFile);
              if (!dataUrl || dataUrl.length > HANDOUT_MAX_DATAURL_LEN) {
                alert(STR.handoutFileTooLarge);
                return;
              }
              attachmentData = dataUrl;
              attachmentType = String(selectedFile.type || "").startsWith(
                "image/",
              )
                ? "image"
                : "file";
              attachmentName = String(selectedFile.name || "").trim();
              attachmentMime = String(selectedFile.type || "").trim();
            } else if (removeOld) {
              attachmentData = "";
              attachmentType = "";
              attachmentName = "";
              attachmentMime = "";
            }

            if (!selectedCourse) {
              alert(STR.handoutCourseRequired);
              return;
            }
            if (!titleValue) {
              alert(STR.handoutTitleRequired);
              return;
            }
            if (!linkValue && !attachmentData) {
              alert(STR.handoutSourceRequired);
              return;
            }

            const ok = app.addHandout({
              id: document.getElementById("h_id").value
                ? Number(document.getElementById("h_id").value)
                : null,
              classId: Number(selectedCourse.classId),
              courseKey: selectedCourse.key,
              courseName: selectedCourse.name,
              title: titleValue,
              link: linkValue,
              attachmentType,
              attachmentName,
              attachmentMime,
              attachmentData,
              note: noteValue,
              createdAt: item?.createdAt || new Date().toISOString(),
            });

            if (!ok) alert(STR.handoutSourceRequired);
          };
        },

        openCourseProgressModal(id = null) {
          const item = id
            ? app.data.courseProgress.find((x) => x.id === id)
            : null;
          const title = item ? STR.modalEdit : STR.modalAdd;
          const courses = app.getUniqueCourses();

          if (courses.length === 0) {
            const html = `
              <div class="theme-card p-6 w-full max-w-md shadow-2xl animate-fade-in" onclick="ui.stopEvent(event)"
                   style="background: color-mix(in srgb, var(--card-bg) 90%, transparent);">
                <h3 class="text-xl font-black mb-4">${STR.courseProgressBoard}</h3>
                <p class="text-sm opacity-80 mb-4">           .</p>
                <button type="button" onclick="ui.closeModal()" class="w-full py-2.5 bg-[var(--accent)] text-[var(--bg)] font-black rounded-2xl hover:brightness-110 shadow-xl">${STR.cancel}</button>
              </div>
            `;
            const overlay = document.getElementById("modalOverlay");
            overlay.innerHTML = html;
            overlay.classList.remove("hidden");
            overlay.classList.add("flex");
            return;
          }

          const itemCourseKey = app.normalizeCourseKey(
            item?.courseName || app.getCourseNameByClassId(item?.classId),
          );
          const defaultCourse =
            courses.find((c) => c.key === itemCourseKey) || courses[0];
          const defaultClassId = Number(defaultCourse.classId);
          const defaultPercent = Math.min(
            100,
            Math.max(0, Number(item?.coveragePercent) || 0),
          );
          const defaultSession = Math.max(
            0,
            Math.floor(Number(item?.sessionNo) || 0),
          );
          const defaultUntil = this.escapeHtml(String(item?.taughtUntil || ""));
          const defaultNextTopic = this.escapeHtml(
            String(item?.nextTopic || ""),
          );

          const html = `
            <div class="theme-card p-6 w-full max-w-md shadow-2xl animate-fade-in" onclick="ui.stopEvent(event)"
                 style="background: color-mix(in srgb, var(--card-bg) 90%, transparent);">
              <h3 class="text-xl font-black mb-4">${title} ${STR.courseProgressBoard}</h3>

              <form id="courseProgressForm" class="space-y-3">
                <input type="hidden" id="cp_id" value="${item ? item.id : ""}">

                <div class="text-[11px] opacity-70 font-black">${STR.noteClass}</div>
                <select class="inp" id="cp_class" required>
                  ${courses
                    .map(
                      (c) =>
                        `<option value="${c.classId}" ${Number(c.classId) === defaultClassId ? "selected" : ""}>${this.escapeHtml(c.name)}${c.prof ? ` - ${this.escapeHtml(c.prof)}` : ""}</option>`,
                    )
                    .join("")}
                </select>

                <div class="text-[11px] opacity-70 font-black">${STR.progressUntil}</div>
                <textarea class="inp min-h-[100px]" id="cp_until" placeholder="${STR.progressUntil}" required>${defaultUntil}</textarea>

                <div class="grid grid-cols-2 gap-2">
                  <div>
                    <div class="text-[11px] opacity-70 font-black mb-1">${STR.progressPercent}</div>
                    <input
                      type="range"
                      id="cp_percent_range"
                      min="0"
                      max="100"
                      step="1"
                      value="${defaultPercent}"
                      class="w-full accent-[var(--accent)]"
                    />
                  </div>
                  <div>
                    <div class="text-[11px] opacity-70 font-black mb-1">${STR.progressPercent}</div>
                    <input class="inp" type="number" id="cp_percent" min="0" max="100" step="1" value="${defaultPercent}">
                  </div>
                </div>

                <div class="grid grid-cols-2 gap-2">
                  <div>
                    <div class="text-[11px] opacity-70 font-black mb-1">${STR.progressSession}</div>
                    <input class="inp" type="number" id="cp_session" min="0" step="1" value="${defaultSession}">
                  </div>
                  <div>
                    <div class="text-[11px] opacity-70 font-black mb-1">${STR.progressNextTopic}</div>
                    <input class="inp" type="text" id="cp_next" placeholder="${STR.progressNextTopic}" value="${defaultNextTopic}">
                  </div>
                </div>

                <div class="flex gap-2 mt-4 pt-2" style="border-top: 1px solid var(--border);">
                  <button type="submit" class="flex-1 py-2.5 bg-[var(--accent)] text-[var(--bg)] font-black rounded-2xl hover:brightness-110 shadow-xl">${STR.save}</button>
                  ${item ? `<button type="button" onclick="app.deleteCourseProgress(${item.id})" class="px-3 py-2.5 text-red-500 hover:bg-red-500/10 rounded-2xl font-black">${STR.delete}</button>` : ""}
                  <button type="button" onclick="ui.closeModal()" class="px-3 py-2.5 opacity-70 hover:opacity-100 rounded-2xl font-black">${STR.cancel}</button>
                </div>
              </form>
            </div>
          `;

          const overlay = document.getElementById("modalOverlay");
          overlay.innerHTML = html;
          overlay.classList.remove("hidden");
          overlay.classList.add("flex");

          const percentRangeEl = document.getElementById("cp_percent_range");
          const percentInputEl = document.getElementById("cp_percent");

          const syncPercent = (raw) => {
            const value = Math.min(
              100,
              Math.max(0, Math.round(Number(raw) || 0)),
            );
            if (percentRangeEl) percentRangeEl.value = String(value);
            if (percentInputEl) percentInputEl.value = String(value);
          };

          if (percentRangeEl) {
            percentRangeEl.addEventListener("input", () =>
              syncPercent(percentRangeEl.value),
            );
          }
          if (percentInputEl) {
            percentInputEl.addEventListener("input", () =>
              syncPercent(percentInputEl.value),
            );
          }
          syncPercent(defaultPercent);

          document.getElementById("courseProgressForm").onsubmit = (ev) => {
            ev.preventDefault();

            const classId = Number(document.getElementById("cp_class").value);
            const selectedCourse =
              courses.find((c) => Number(c.classId) === classId) || null;
            const taughtUntil = document
              .getElementById("cp_until")
              .value.trim();
            const coveragePercent = Number(
              document.getElementById("cp_percent").value || 0,
            );
            const sessionNo = Number(
              document.getElementById("cp_session").value || 0,
            );
            const nextTopic = document.getElementById("cp_next").value.trim();

            if (!Number.isFinite(classId)) {
              alert(STR.progressClassRequired);
              return;
            }
            if (!taughtUntil) {
              alert(STR.progressUntilRequired);
              return;
            }

            app.addCourseProgress({
              id: document.getElementById("cp_id").value
                ? Number(document.getElementById("cp_id").value)
                : null,
              classId,
              courseName: selectedCourse ? selectedCourse.name : "",
              taughtUntil,
              coveragePercent,
              sessionNo,
              nextTopic,
            });
          };
        },

        openClassModalPrefill(ev, day, start, end) {
          if (ev?.target?.closest?.(".class-card")) return;
          this.openClassModal(null);
          setTimeout(() => {
            const d = document.getElementById("f_day");
            const s = document.getElementById("f_start");
            const e = document.getElementById("f_end");
            if (d) {
              d.value = String(day);
              d.dispatchEvent(new Event("change", { bubbles: true }));
            }
            if (s) {
              s.value = start;
              s.dispatchEvent(new Event("input", { bubbles: true }));
            }
            if (e) e.value = app.addMinutes(start, CLASS_DURATION_MINUTES);
          }, 0);
        },

        openClassModalFromCard(ev, id) {
          if (ev) ev.stopPropagation();
          this.openClassModal(id);
        },

        stopEvent(ev) {
          if (ev) ev.stopPropagation();
        },

        openProfileMetaModal() {
          const currentName = app.getProfileName();
          const currentTermNo = app.getProfileTermNo();
          const currentMajor = app.getProfileMajor(true);
          const currentClassStartDate = app.getProfileClassStartDateValue();
          const existingTerms = app.getExistingTermNumbers();
          const existingTermSet = new Set(existingTerms);
          const termOptions = Array.from(
            { length: TERM_MAX_NO - TERM_MIN_NO + 1 },
            (_, idx) => {
              const termNo = TERM_MIN_NO + idx;
              const selected = termNo === currentTermNo ? "selected" : "";
              const hasData = existingTermSet.has(termNo);
              const status =
                termNo === currentTermNo
                  ? " ()"
                  : hasData
                    ? " ()"
                    : " ()";
              return `<option value="${termNo}" ${selected}>${this.escapeHtml(getTermLabel(termNo))}${status}</option>`;
            },
          ).join("");
          const termPills = Array.from(
            { length: TERM_MAX_NO - TERM_MIN_NO + 1 },
            (_, idx) => {
              const termNo = TERM_MIN_NO + idx;
              const label = getTermLabel(termNo);
              const state =
                termNo === currentTermNo
                  ? "current"
                  : existingTermSet.has(termNo)
                    ? "saved"
                    : "new";
              const meta =
                state === "current"
                  ? " "
                  : state === "saved"
                    ? ""
                    : " ";
              const shortState =
                state === "current"
                  ? ""
                  : state === "saved"
                    ? ""
                    : "";
              return `
                <button
                  type="button"
                  class="profile-term-pill"
                  data-term-no="${termNo}"
                  data-state="${state}"
                  aria-pressed="${termNo === currentTermNo ? "true" : "false"}"
                  aria-label="${this.escapeHtml(`${label} - ${meta}`)}"
                >
                  <span class="profile-term-pill__name">${this.escapeHtml(label)}</span>
                  <span class="profile-term-pill__meta">${this.escapeHtml(meta)}</span>
                  <span class="profile-term-pill__state">${this.escapeHtml(shortState)}</span>
                </button>
              `;
            },
          ).join("");
          const existingTermsText = existingTerms.length
            ? existingTerms.map((n) => getTermLabel(n)).join(" ")
            : getTermLabel(currentTermNo);
          const createdTermsCount = existingTerms.length;
          const archivedTermsCount = Math.max(
            0,
            existingTerms.filter((n) => n !== currentTermNo).length,
          );
          const newTermsCount = Math.max(0, TERM_MAX_NO - createdTermsCount);

          const html = `
          <div class="theme-card profile-meta-modal shadow-2xl animate-fade-in" onclick="ui.stopEvent(event)">
            <div class="profile-meta-head">
              <div class="profile-meta-title-wrap">
                <h3 class="profile-meta-title">${STR.editProfile}</h3>
                <div class="profile-meta-sub">           .</div>
              </div>
              <div class="profile-meta-badge">${this.escapeHtml(getTermLabel(currentTermNo))}</div>
            </div>

            <form id="profileMetaForm" class="profile-meta-form">
              <div class="profile-meta-scroll overflow-y-auto">
                <div class="profile-meta-grid">
                  <div class="profile-field">
                    <div class="profile-field-label">${STR.profileNameLabel}</div>
                    <label class="profile-input-shell" for="p_name">
                      <span class="profile-input-icon" aria-hidden="true">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M15.8 8.2a3.8 3.8 0 1 1-7.6 0 3.8 3.8 0 0 1 7.6 0Zm-9 10.2a5.2 5.2 0 0 1 10.4 0" />
                        </svg>
                      </span>
                      <input class="inp profile-text-input" type="text" id="p_name" placeholder="${STR.profileNameLabel}" value="${this.escapeHtml(currentName)}" required>
                    </label>
                  </div>

                  <div class="profile-field">
                    <div class="profile-field-label">${STR.profileMajorLabel}</div>
                    <label class="profile-input-shell" for="p_major">
                      <span class="profile-input-icon" aria-hidden="true">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M4 7.2 12 4l8 3.2-8 3.2L4 7.2Zm2.2 3.9v4.2c0 .7.4 1.3 1 1.6 1.2.7 2.9 1.5 4.8 1.5s3.6-.8 4.8-1.5c.6-.3 1-.9 1-1.6v-4.2" />
                        </svg>
                      </span>
                      <input class="inp profile-text-input" type="text" id="p_major" placeholder="${STR.profileMajorPlaceholder}" value="${this.escapeHtml(currentMajor)}">
                    </label>
                  </div>
                </div>

                <div class="profile-term-field">
                  <div class="profile-term-head">
                    <div class="profile-field-label">${STR.profileTermLabel}</div>
                    <div class="profile-term-stats">
                      <span class="profile-term-stat profile-term-stat--current">: ${this.escapeHtml(getTermLabel(currentTermNo))}</span>
                      <span class="profile-term-stat profile-term-stat--saved">: ${this.escapeHtml(String(archivedTermsCount))}</span>
                      <span class="profile-term-stat profile-term-stat--new">: ${this.escapeHtml(String(newTermsCount))}</span>
                    </div>
                  </div>
                  <label class="profile-term-shell" for="p_term">
                    <span class="profile-term-icon" aria-hidden="true">
                      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="1.9"
                          d="M4 7.5 12 4l8 3.5L12 11 4 7.5Zm2.2 3.8L12 14l5.8-2.7M6.2 15.3 12 18l5.8-2.7"
                        />
                      </svg>
                    </span>
                    <select class="inp profile-term-select" id="p_term">${termOptions}</select>
                  </label>
                  <div class="profile-term-grid-wrap">
                    <div id="p_term_grid" class="profile-term-grid" role="listbox" aria-label="${STR.profileTermLabel}">${termPills}</div>
                  </div>
                  <div id="p_term_helper" class="profile-term-helper">${STR.profileTermHelper}</div>
                  <div id="p_term_created" class="profile-term-existing">${STR.profileTermCreatedListLabel}: ${this.escapeHtml(existingTermsText)}</div>
                  <div id="p_term_warning" class="profile-term-warning hidden"></div>
                  <div id="p_term_confirm" class="profile-term-confirm hidden">
                    <div class="profile-term-confirm-title">${STR.profileTermCreateConfirm}</div>
                    <div class="profile-term-confirm-actions">
                      <button type="button" id="btnTermConfirmYes" class="profile-term-confirm-btn profile-term-confirm-btn--yes">${STR.yes}</button>
                      <button type="button" id="btnTermConfirmNo" class="profile-term-confirm-btn profile-term-confirm-btn--no">${STR.no}</button>
                    </div>
                  </div>
                </div>

                <div class="profile-date-field">
                  <div class="profile-field-label">${STR.profileClassStartLabel}</div>
                  <label class="profile-date-shell" for="p_class_start">
                    <span class="profile-date-icon" aria-hidden="true">
                      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="1.8"
                          d="M8 7V4m8 3V4m-9 6h10M5 20h14a1 1 0 001-1V8a1 1 0 00-1-1H5a1 1 0 00-1 1v11a1 1 0 001 1z"
                        />
                      </svg>
                    </span>
                    <input class="inp profile-date-input" type="date" id="p_class_start" value="${this.escapeHtml(currentClassStartDate)}">
                  </label>
                  <div class="profile-date-helper">${STR.profileClassStartHelper}</div>
                </div>
              </div>

              <div class="profile-meta-actions">
                <button type="button" onclick="ui.closeModal()" class="profile-meta-cancel">${STR.cancel}</button>
                <button type="submit" class="profile-meta-save">${STR.save}</button>
              </div>
            </form>
          </div>
        `;

          const overlay = document.getElementById("modalOverlay");
          if (!overlay) return;
          if (typeof overlay.__activeModalCleanup === "function") {
            try {
              overlay.__activeModalCleanup();
            } catch {}
          }
          overlay.__activeModalCleanup = null;
          overlay.innerHTML = html;
          overlay.classList.remove("hidden");
          overlay.classList.add("flex");

          const profileModalEl = overlay.querySelector(".profile-meta-modal");
          const profileFormEl = document.getElementById("profileMetaForm");
          const profileScrollEl = overlay.querySelector(".profile-meta-scroll");
          const termSelectEl = document.getElementById("p_term");
          const termGridEl = document.getElementById("p_term_grid");
          const termHelperEl = document.getElementById("p_term_helper");
          const termWarningEl = document.getElementById("p_term_warning");
          const termConfirmEl = document.getElementById("p_term_confirm");
          const termYesEl = document.getElementById("btnTermConfirmYes");
          const termNoEl = document.getElementById("btnTermConfirmNo");
          const termPillEls = termGridEl
            ? Array.from(termGridEl.querySelectorAll(".profile-term-pill"))
            : [];
          const isMobileLikeModal = () => {
            if (typeof window === "undefined") return false;
            const mode = String(app.data?.settings?.uiMode || "auto");
            if (mode === "mobile") return true;
            if (mode === "desktop") return false;
            return window.matchMedia("(max-width: 1024px)").matches;
          };
          const syncProfileModalViewport = () => {
            if (!profileModalEl || typeof window === "undefined") return;
            const vv = window.visualViewport || null;
            const viewportH = Math.max(
              320,
              Math.round(Number(vv ? vv.height : window.innerHeight) || 0),
            );
            profileModalEl.style.setProperty(
              "--profile-modal-vh",
              `${viewportH}px`,
            );
            const compact = isMobileLikeModal() && viewportH < 700;
            profileModalEl.classList.toggle("is-compact", compact);
          };
          let profileModalViewportRafId = 0;
          const scheduleProfileModalViewportSync = () => {
            if (typeof window === "undefined") return;
            if (profileModalViewportRafId) return;
            profileModalViewportRafId = window.requestAnimationFrame(() => {
              profileModalViewportRafId = 0;
              syncProfileModalViewport();
            });
          };
          const scrollProfileFieldIntoView = (targetEl) => {
            if (!targetEl || typeof window === "undefined") return;
            window.setTimeout(() => {
              targetEl.scrollIntoView({
                block: "center",
                inline: "nearest",
                behavior: "smooth",
              });
            }, 120);
          };
          const handleProfileFormFocusIn = (ev) => {
            if (!isMobileLikeModal()) return;
            const rawTarget = ev?.target;
            if (!(rawTarget instanceof HTMLElement)) return;
            if (!rawTarget.matches("input, select, textarea")) return;
            scheduleProfileModalViewportSync();
            const section =
              rawTarget.closest(".profile-field") ||
              rawTarget.closest(".profile-term-field") ||
              rawTarget.closest(".profile-date-field") ||
              rawTarget;
            scrollProfileFieldIntoView(section);
          };
          const handleProfileFormFocusOut = () => {
            if (!isMobileLikeModal()) return;
            scheduleProfileModalViewportSync();
          };
          const vv =
            typeof window !== "undefined" ? window.visualViewport : null;
          window.addEventListener("resize", scheduleProfileModalViewportSync, {
            passive: true,
          });
          window.addEventListener(
            "orientationchange",
            scheduleProfileModalViewportSync,
            {
              passive: true,
            },
          );
          if (vv && typeof vv.addEventListener === "function") {
            vv.addEventListener("resize", scheduleProfileModalViewportSync, {
              passive: true,
            });
            vv.addEventListener("scroll", scheduleProfileModalViewportSync, {
              passive: true,
            });
          }
          if (profileFormEl) {
            profileFormEl.addEventListener("focusin", handleProfileFormFocusIn);
            profileFormEl.addEventListener(
              "focusout",
              handleProfileFormFocusOut,
            );
          }
          scheduleProfileModalViewportSync();
          overlay.__activeModalCleanup = () => {
            if (profileModalViewportRafId && typeof window !== "undefined") {
              window.cancelAnimationFrame(profileModalViewportRafId);
              profileModalViewportRafId = 0;
            }
            window.removeEventListener(
              "resize",
              scheduleProfileModalViewportSync,
            );
            window.removeEventListener(
              "orientationchange",
              scheduleProfileModalViewportSync,
            );
            if (vv && typeof vv.removeEventListener === "function") {
              vv.removeEventListener(
                "resize",
                scheduleProfileModalViewportSync,
              );
              vv.removeEventListener(
                "scroll",
                scheduleProfileModalViewportSync,
              );
            }
            if (profileFormEl) {
              profileFormEl.removeEventListener(
                "focusin",
                handleProfileFormFocusIn,
              );
              profileFormEl.removeEventListener(
                "focusout",
                handleProfileFormFocusOut,
              );
            }
            if (profileModalEl) {
              profileModalEl.classList.remove("is-compact");
              profileModalEl.style.removeProperty("--profile-modal-vh");
            }
            if (profileScrollEl) {
              profileScrollEl.scrollTop = 0;
            }
          };

          let createApprovedFor = null;
          const getSelectedTermNo = () =>
            app.getTermNo(termSelectEl?.value, currentTermNo);
          const isCreateCandidate = (termNo) =>
            termNo !== currentTermNo && !app.termExists(termNo);
          const syncTermPills = (
            selectedNo = getSelectedTermNo(),
            opts = {},
          ) => {
            const shouldCenter = Boolean(opts.center);
            let selectedPill = null;
            termPillEls.forEach((pill) => {
              const no = app.getTermNo(pill?.dataset?.termNo, currentTermNo);
              const state =
                no === currentTermNo
                  ? "current"
                  : app.termExists(no)
                    ? "saved"
                    : "new";
              pill.dataset.state = state;
              pill.classList.toggle("is-selected", no === selectedNo);
              pill.setAttribute(
                "aria-pressed",
                no === selectedNo ? "true" : "false",
              );
              if (no === selectedNo) selectedPill = pill;
            });
            if (
              shouldCenter &&
              selectedPill &&
              termGridEl &&
              termGridEl.scrollWidth > termGridEl.clientWidth + 8
            ) {
              selectedPill.scrollIntoView({
                block: "nearest",
                inline: "center",
                behavior: "smooth",
              });
            }
          };

          const refreshTermNotice = (opts = {}) => {
            if (
              !termSelectEl ||
              !termHelperEl ||
              !termWarningEl ||
              !termConfirmEl
            ) {
              return;
            }
            const selectedNo = getSelectedTermNo();
            syncTermPills(selectedNo, opts);
            if (selectedNo === currentTermNo) {
              termHelperEl.innerText = STR.profileTermCurrentHint;
              termWarningEl.classList.add("hidden");
              termConfirmEl.classList.add("hidden");
              return;
            }
            if (!isCreateCandidate(selectedNo)) {
              termHelperEl.innerText = STR.profileTermExistingHint;
              termWarningEl.classList.add("hidden");
              termConfirmEl.classList.add("hidden");
              return;
            }

            termHelperEl.innerText = STR.profileTermCreatedHint;
            termWarningEl.innerText = `${STR.profileTermWarningCreate} (${getTermLabel(selectedNo)})`;
            termWarningEl.classList.remove("hidden");
            if (createApprovedFor === selectedNo) {
              termConfirmEl.classList.add("hidden");
            } else {
              termConfirmEl.classList.remove("hidden");
            }
            revealTermCreateHint();
          };
          const revealTermCreateHint = () => {
            if (typeof window === "undefined") return;
            const target =
              termConfirmEl && !termConfirmEl.classList.contains("hidden")
                ? termConfirmEl
                : termWarningEl && !termWarningEl.classList.contains("hidden")
                  ? termWarningEl
                  : null;
            if (!target) return;
            window.requestAnimationFrame(() => {
              target.scrollIntoView({
                block: "nearest",
                inline: "nearest",
                behavior: "smooth",
              });
            });
          };

          if (termSelectEl) {
            termSelectEl.addEventListener("change", () => {
              createApprovedFor = null;
              refreshTermNotice({ center: true });
            });
          }
          termPillEls.forEach((pill) => {
            pill.addEventListener("click", () => {
              if (!termSelectEl) return;
              const no = app.getTermNo(pill?.dataset?.termNo, currentTermNo);
              termSelectEl.value = String(no);
              termSelectEl.dispatchEvent(
                new Event("change", { bubbles: true }),
              );
              pill.scrollIntoView({
                block: "nearest",
                inline: "center",
                behavior: "smooth",
              });
            });
          });

          if (termYesEl) {
            termYesEl.addEventListener("click", () => {
              createApprovedFor = getSelectedTermNo();
              if (termConfirmEl) termConfirmEl.classList.add("hidden");
              refreshTermNotice({ center: true });
            });
          }
          if (termNoEl) {
            termNoEl.addEventListener("click", () => {
              if (termSelectEl) {
                termSelectEl.value = String(currentTermNo);
              }
              createApprovedFor = null;
              if (termConfirmEl) termConfirmEl.classList.add("hidden");
              refreshTermNotice({ center: true });
            });
          }
          refreshTermNotice({ center: true });

          if (profileFormEl) {
            profileFormEl.onsubmit = (ev) => {
              ev.preventDefault();
              const name = document.getElementById("p_name").value.trim();
              const termNo = getSelectedTermNo();
              const major = document.getElementById("p_major").value.trim();
              const classStartDate = document
                .getElementById("p_class_start")
                .value.trim();

              if (!name) {
                alert(STR.profileNameRequired);
                return;
              }

              const needCreateConfirm = isCreateCandidate(termNo);
              if (needCreateConfirm && createApprovedFor !== termNo) {
                if (termWarningEl) {
                  termWarningEl.innerText = STR.profileTermWarningCreate;
                  termWarningEl.classList.remove("hidden");
                }
                if (termConfirmEl) termConfirmEl.classList.remove("hidden");
                revealTermCreateHint();
                return;
              }

              if (termNo !== app.getActiveTermNo()) {
                const switched = app.switchTerm(termNo, {
                  createIfMissing: needCreateConfirm,
                });
                if (!switched.ok) {
                  alert(STR.profileTermSwitchFailed);
                  return;
                }
              }

              app.setProfileMeta({ name, major, classStartDate });
              ui.closeModal();
            };
          }
        },

        openClassModal(id = null) {
          const c = id ? app.data.classes.find((x) => x.id === id) : null;
          const title = c ? STR.modalEdit : STR.modalAdd;
          const initialStart = c ? c.start : "08:00";
          const initialEnd = c
            ? c.end
            : app.addMinutes(initialStart, CLASS_DURATION_MINUTES);
          const baseSessionMeta = c ? app.getClassSessionMeta(c) : null;
          const classDetailsOpenAttr = c ? " open" : "";
          const defaultSessionValue = c
            ? Math.max(0, Number(baseSessionMeta?.sessionNo || 0))
            : 0;

          const html = `
          <div class="theme-card class-modal-shell shadow-2xl animate-fade-in" onclick="ui.stopEvent(event)">
            <h3 class="class-modal-title">${title} ${STR.course}</h3>

            <section class="class-details-shell class-details-shell--always" aria-live="polite">
              <details class="class-details-accordion"${classDetailsOpenAttr}>
                <summary class="class-details-toggle">
                  <div class="class-details-heading">
                    <span class="class-details-icon" aria-hidden="true">
                      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8"
                          d="M5 5h14a1 1 0 011 1v12a1 1 0 01-1 1H5a1 1 0 01-1-1V6a1 1 0 011-1zm3 4h8m-8 4h5" />
                      </svg>
                    </span>
                    <div class="class-details-title-copy">
                      <div class="class-details-toggle-title"> </div>
                      <div class="class-details-toggle-sub">    /   </div>
                    </div>
                  </div>
                  <div id="f_class_details_meta" class="class-details-meta"></div>
                  <span class="class-details-chevron" aria-hidden="true"></span>
                </summary>
                <div class="class-details-body-wrap">
                  <div id="f_class_details_panel" class="class-details-grid"></div>
                </div>
              </details>
            </section>

            <form id="classForm" class="class-form-layout">
              <input type="hidden" id="f_id" value="${c ? c.id : ""}">
              <div class="class-form-scroll">

              <div class="class-suggest-group">
                <div class="class-field-head class-field-head--course">
                  <span class="class-field-icon" aria-hidden="true">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.85" d="M4.5 6.5 12 3l7.5 3.5L12 10 4.5 6.5Z" />
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.85" d="M6.8 9.8v5.2c0 .7.4 1.3 1 1.6 1.1.6 2.8 1.4 4.2 1.4 1.5 0 3.2-.8 4.3-1.4.6-.3 1-.9 1-1.6V9.8" />
                    </svg>
                  </span>
                  <span>${STR.course}</span>
                </div>
                <div class="class-suggest-row">
                  <input class="inp" type="text" id="f_name" placeholder="${STR.course}" value="${this.escapeHtml(c ? c.name || "" : "")}" required>
                  <button type="button" class="class-suggest-btn" id="f_name_suggest_btn" aria-expanded="false"></button>
                </div>
                <div id="f_name_suggest_panel" class="class-suggest-panel" hidden></div>
              </div>

              <div class="class-field-head class-field-head--classno">
                <span class="class-field-icon" aria-hidden="true">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.9" d="M6 9h12M6 15h12M9 5l-2 14M17 5l-2 14" />
                  </svg>
                </span>
                <span class="class-number-label">${STR.classNumber}</span>
              </div>
              <input class="inp inp-class-number" type="text" id="f_class_no" placeholder="${STR.classNumber}" value="${this.escapeHtml(c ? c.classNo || "" : "")}">

              <div class="class-suggest-group">
                <div class="class-field-head class-field-head--prof">
                  <span class="class-field-icon" aria-hidden="true">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.85" d="M12 4.2 4 8.2l8 4 8-4-8-4Z" />
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.85" d="M7.5 10.2v3.5c0 1.6 2 3.1 4.5 3.1s4.5-1.5 4.5-3.1v-3.5" />
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.85" d="M19.5 9.3v4.2" />
                    </svg>
                  </span>
                  <span>${STR.prof}</span>
                </div>
                <div class="class-suggest-row">
                  <input class="inp" type="text" id="f_prof" placeholder="${STR.prof}" value="${this.escapeHtml(c ? c.prof || "" : "")}">
                  <button type="button" class="class-suggest-btn" id="f_prof_suggest_btn" aria-expanded="false"></button>
                </div>
                <div id="f_prof_suggest_panel" class="class-suggest-panel" hidden></div>
              </div>

              <div class="flex gap-2">
                <input class="inp w-1/3" type="number" id="f_unit" placeholder="${STR.unit}" value="${c ? c.unit : 3}">
                <select class="inp w-2/3" id="f_day">
                  ${STR.days.map((d, i) => `<option value="${i}" ${c && c.day == i ? "selected" : ""}>${d}</option>`).join("")}
                </select>
              </div>

              <div class="flex gap-2">
                <input class="inp w-1/2" type="time" id="f_start" value="${initialStart}" step="1800">
                <input class="inp w-1/2 opacity-80" type="time" id="f_end" value="${initialEnd}" readonly tabindex="-1">
              </div>
              <div class="text-[11px] opacity-70 font-black">${STR.classDurationFixed}</div>

              <select class="inp" id="f_type">
                <option value="normal" ${c && c.type == "normal" ? "selected" : ""}>${STR.typeNormal}</option>
                <option value="odd" ${c && c.type == "odd" ? "selected" : ""}>${STR.typeOdd}</option>
                <option value="even" ${c && c.type == "even" ? "selected" : ""}>${STR.typeEven}</option>
              </select>

              <div class="text-[11px] opacity-70 font-black">${STR.sessionCurrentLabel}</div>
              <input class="inp" type="number" id="f_session_current" min="0" step="1" value="${this.escapeHtml(String(defaultSessionValue))}">
              <div id="f_session_hint" class="text-[10px] opacity-75 leading-6"></div>

              <input class="inp" type="text" id="f_note" placeholder="${STR.notes}" value="${this.escapeHtml(c ? app.sanitizeClassNoteByType(c.type, c.note || "") : "")}">

              </div>
              <div class="class-form-actions flex gap-2">
                <button type="submit" class="flex-1 py-2.5 bg-[var(--accent)] text-[var(--bg)] font-black rounded-2xl hover:brightness-110 shadow-xl">${STR.save}</button>
                ${c ? `<button type="button" onclick="app.deleteClass(${c.id})" class="px-3 py-2.5 text-red-500 hover:bg-red-500/10 rounded-2xl font-black">${STR.delete}</button>` : ""}
                <button type="button" onclick="ui.closeModal()" class="px-3 py-2.5 opacity-70 hover:opacity-100 rounded-2xl font-black">${STR.cancel}</button>
              </div>
            </form>
          </div>
        `;

          const overlay = document.getElementById("modalOverlay");
          overlay.innerHTML = html;
          overlay.classList.remove("hidden");
          overlay.classList.add("flex");

          const nameInput = document.getElementById("f_name");
          const profInput = document.getElementById("f_prof");
          const startInput = document.getElementById("f_start");
          const endInput = document.getElementById("f_end");
          const dayInput = document.getElementById("f_day");
          const typeInput = document.getElementById("f_type");
          const noteInput = document.getElementById("f_note");
          const sessionInput = document.getElementById("f_session_current");
          const sessionHintEl = document.getElementById("f_session_hint");
          const nameSuggestBtn = document.getElementById("f_name_suggest_btn");
          const profSuggestBtn = document.getElementById("f_prof_suggest_btn");
          const nameSuggestPanel = document.getElementById(
            "f_name_suggest_panel",
          );
          const profSuggestPanel = document.getElementById(
            "f_prof_suggest_panel",
          );
          const classDetailsMetaEl = document.getElementById(
            "f_class_details_meta",
          );
          const classDetailsPanelEl = document.getElementById(
            "f_class_details_panel",
          );
          const nameSuggestions = app.getClassNameSuggestions();
          const profSuggestions = app.getProfessorSuggestions();
          const noSuggestionText =
            "     .";
          const detailsEmptyLabel = " ";
          const detailsNowRef = new Date();
          const toEn = (value) => {
            const num = Number(value || 0);
            if (!Number.isFinite(num)) return "0";
            return num.toLocaleString("en-US");
          };
          const toEnDigitsText = (value) =>
            String(value ?? "")
              .replace(/[-]/g, (d) => "".indexOf(d))
              .replace(/[-]/g, (d) => "".indexOf(d));
          const buildDetailsContext = () => {
            const baseName = String(nameInput?.value || c?.name || "").trim();
            const sessionKey = app.normalizeCourseSessionKey(baseName);
            const matchedClasses = sessionKey
              ? app.data.classes.filter(
                  (item) =>
                    app.normalizeCourseSessionKey(
                      item?.name || item?.courseName || "",
                    ) === sessionKey,
                )
              : [];
            const classIds = new Set(
              matchedClasses
                .map((item) => Number(item?.id))
                .filter((idVal) => Number.isFinite(idVal)),
            );
            const currentId = Number(c?.id);
            if (Number.isFinite(currentId)) classIds.add(currentId);
            return {
              baseName,
              sessionKey,
              classIds,
              matchedClasses,
            };
          };
          const renderDetailsList = (items, renderer) => {
            if (!Array.isArray(items) || !items.length) {
              return `<div class="class-details-empty">${detailsEmptyLabel}</div>`;
            }
            return `<ul class="class-details-list">${items
              .map(
                (item) =>
                  `<li class="class-details-item">${renderer(item)}</li>`,
              )
              .join("")}</ul>`;
          };
          const renderDetailsCard = (title, count, bodyHtml) => `
            <article class="class-details-card">
              <div class="class-details-card-head">
                <div class="class-details-card-title">${title}</div>
                <span class="class-details-count">${toEn(count)}</span>
              </div>
              ${bodyHtml}
            </article>
          `;
          const findAttendanceRecordBySessionKey = (sessionKey) => {
            if (!sessionKey) return null;
            const store =
              app.data?.attendance && typeof app.data.attendance === "object"
                ? app.data.attendance
                : {};
            const entries = Object.entries(store);
            for (let i = 0; i < entries.length; i += 1) {
              const [rawKey, rawRecord] = entries[i];
              const record =
                rawRecord && typeof rawRecord === "object" ? rawRecord : null;
              if (!record) continue;
              const keyByRecordName = app.normalizeCourseSessionKey(
                record.courseName || "",
              );
              const keyByStoreKey = app.normalizeCourseSessionKey(rawKey || "");
              if (
                keyByRecordName === sessionKey ||
                keyByStoreKey === sessionKey
              ) {
                return record;
              }
            }
            return null;
          };
          const syncClassDetails = () => {
            if (!classDetailsPanelEl || !classDetailsMetaEl) return;

            const ctx = buildDetailsContext();
            const { baseName, sessionKey, classIds, matchedClasses } = ctx;
            const metaText = baseName
              ? `: ${baseName}`
              : "  ";
            classDetailsMetaEl.innerText = toEnDigitsText(metaText);

            const hasCourseRef = Boolean(sessionKey);
            const bySessionName = (rawName) =>
              hasCourseRef &&
              app.normalizeCourseSessionKey(rawName || "") === sessionKey;

            const handouts = app.data.handouts
              .filter((item) => {
                const classId = Number(item?.classId);
                if (Number.isFinite(classId) && classIds.has(classId))
                  return true;
                return bySessionName(item?.courseName || item?.courseKey || "");
              })
              .sort((a, b) => {
                const at = new Date(
                  a?.updatedAt || a?.createdAt || 0,
                ).getTime();
                const bt = new Date(
                  b?.updatedAt || b?.createdAt || 0,
                ).getTime();
                if (Number.isFinite(at) && Number.isFinite(bt) && at !== bt)
                  return bt - at;
                return String(a?.title || "").localeCompare(
                  String(b?.title || ""),
                  "fa",
                );
              });

            const exams = app.data.exams
              .filter((item) => {
                const classId = Number(item?.classId);
                if (Number.isFinite(classId) && classIds.has(classId))
                  return true;
                const examName = String(
                  item?.courseName || app.getCourseNameByClassId(item?.classId),
                ).trim();
                return bySessionName(examName);
              })
              .sort((a, b) => {
                const aDt = app.getExamDateTime(a);
                const bDt = app.getExamDateTime(b);
                const aMs = aDt ? aDt.getTime() : Number.MAX_SAFE_INTEGER;
                const bMs = bDt ? bDt.getTime() : Number.MAX_SAFE_INTEGER;
                if (aMs !== bMs) return aMs - bMs;
                return String(a?.title || "").localeCompare(
                  String(b?.title || ""),
                  "fa",
                );
              });

            const notes = app.data.notes
              .filter((item) => {
                const classId = Number(item?.classId);
                if (Number.isFinite(classId) && classIds.has(classId))
                  return true;
                const noteName = app.getCourseNameByClassId(item?.classId);
                return bySessionName(noteName);
              })
              .sort((a, b) => {
                const at = new Date(a?.createdAt || 0).getTime();
                const bt = new Date(b?.createdAt || 0).getTime();
                if (Number.isFinite(at) && Number.isFinite(bt) && at !== bt)
                  return bt - at;
                return (
                  Number(Boolean(b?.important)) - Number(Boolean(a?.important))
                );
              });

            const progressItems = app.data.courseProgress
              .filter((item) => {
                const classId = Number(item?.classId);
                if (Number.isFinite(classId) && classIds.has(classId))
                  return true;
                const progressName = String(
                  item?.courseName || app.getCourseNameByClassId(item?.classId),
                ).trim();
                return bySessionName(progressName);
              })
              .sort(
                (a, b) =>
                  new Date(b?.updatedAt || 0).getTime() -
                  new Date(a?.updatedAt || 0).getTime(),
              );

            const fallbackCourseName =
              baseName || String(matchedClasses[0]?.name || "").trim();
            const attendanceRecord =
              (fallbackCourseName
                ? app.getAttendanceRecord(fallbackCourseName, false)
                : null) || findAttendanceRecordBySessionKey(sessionKey);
            const attendanceStatuses = attendanceRecord
              ? Object.values(attendanceRecord.logs || {})
              : [];
            const attendancePresent = attendanceStatuses.reduce(
              (sum, raw) =>
                sum + (String(raw || "").trim() === "present" ? 1 : 0),
              0,
            );
            const attendanceAbsent = attendanceStatuses.reduce(
              (sum, raw) =>
                sum + (String(raw || "").trim() === "absent" ? 1 : 0),
              0,
            );
            const attendanceTotal = attendancePresent + attendanceAbsent;
            const attendanceLimit = attendanceRecord
              ? app.getAttendanceAbsenceLimit(
                  attendanceRecord.courseKey || fallbackCourseName,
                )
              : 0;
            const attendanceRemaining = attendanceRecord
              ? Math.max(0, attendanceLimit - attendanceAbsent)
              : 0;

            const handoutBody = renderDetailsList(handouts, (item) => {
              const sourceParts = [];
              if (String(item?.link || "").trim()) sourceParts.push("");
              if (String(item?.attachmentData || "").trim()) {
                sourceParts.push(
                  item?.attachmentType === "image" ? "" : "",
                );
              }
              const updatedAt = new Date(
                item?.updatedAt || item?.createdAt || "",
              );
              const updatedLabel = Number.isNaN(updatedAt.getTime())
                ? "-"
                : updatedAt.toLocaleDateString("fa-IR", {
                    month: "long",
                    day: "numeric",
                  });
              const safeTitle = this.escapeHtml(item?.title || "-");
              const safeMeta = this.escapeHtml(
                toEnDigitsText(
                  sourceParts.length
                    ? `: ${sourceParts.join(" + ")} | : ${updatedLabel}`
                    : `: ${updatedLabel}`,
                ),
              );
              const safeSub = this.escapeHtml(String(item?.note || "").trim());
              return `
                <div class="class-details-item-title">${safeTitle}</div>
                <div class="class-details-item-meta">${safeMeta}</div>
                ${safeSub ? `<div class="class-details-item-sub">${safeSub}</div>` : ""}
              `;
            });

            const examBody = renderDetailsList(exams, (item) => {
              const examMeta = app.getDateTimeMeta(item?.date, item?.time);
              const examAt = examMeta.valid ? examMeta.date : null;
              const remainMeta = app.getCountdownMeta(examAt, detailsNowRef);
              const remainText = remainMeta.hasTarget
                ? remainMeta.isUpcoming
                  ? ` : ${remainMeta.detailText}`
                  : ` : ${remainMeta.detailText}`
                : detailsEmptyLabel;
              const locationText = String(item?.location || "").trim();
              const safeTitle = this.escapeHtml(item?.title || "-");
              const safeMeta = this.escapeHtml(
                toEnDigitsText(
                  examMeta.valid
                    ? locationText
                      ? `${examMeta.fullLabel} | ${locationText}`
                      : examMeta.fullLabel
                    : locationText || "  ",
                ),
              );
              const safeSub = this.escapeHtml(toEnDigitsText(remainText));
              return `
                <div class="class-details-item-title">${safeTitle}</div>
                <div class="class-details-item-meta">${safeMeta}</div>
                <div class="class-details-item-sub">${safeSub}</div>
              `;
            });

            const noteBody = renderDetailsList(notes, (item) => {
              const safeText = this.escapeHtml(item?.text || "-");
              const alertText =
                item?.important && item?.alertDate && item?.alertTime
                  ? `${app.getAlertDayLabel(item.alertDate)} | ${item.alertDate} ${item.alertTime}`
                  : detailsEmptyLabel;
              const safeMeta = this.escapeHtml(
                toEnDigitsText(
                  item?.important
                    ? `  | ${alertText}`
                    : " ",
                ),
              );
              return `
                <div class="class-details-item-title">${safeText}</div>
                <div class="class-details-item-meta">${safeMeta}</div>
              `;
            });

            const progressBody = renderDetailsList(progressItems, (item) => {
              const percent = Math.min(
                100,
                Math.max(0, Math.round(Number(item?.coveragePercent) || 0)),
              );
              const sessionNo = Math.max(
                0,
                Math.floor(Number(item?.sessionNo) || 0),
              );
              const safeUntil = this.escapeHtml(
                toEnDigitsText(item?.taughtUntil || detailsEmptyLabel),
              );
              const safeNext = this.escapeHtml(
                toEnDigitsText(
                  String(item?.nextTopic || "").trim() || detailsEmptyLabel,
                ),
              );
              const percentText = this.escapeHtml(toEn(percent));
              const sessionText = this.escapeHtml(toEn(sessionNo));
              return `
                <div class="class-details-item-title"> : ${safeUntil}</div>
                <div class="class-details-item-meta">
                  :
                  <span class="class-details-num">${percentText}%</span>
                  |
                  :
                  <span class="class-details-num">${sessionText}</span>
                </div>
                <div class="class-details-item-sub">: ${safeNext}</div>
              `;
            });

            const attendanceBody = attendanceRecord
              ? `
                <div class="class-details-attendance">
                  <div class="class-details-kpi">
                    <div class="class-details-kpi-label"></div>
                    <div class="class-details-kpi-value">${toEn(attendancePresent)}</div>
                  </div>
                  <div class="class-details-kpi">
                    <div class="class-details-kpi-label"></div>
                    <div class="class-details-kpi-value">${toEn(attendanceAbsent)}</div>
                  </div>
                  <div class="class-details-kpi">
                    <div class="class-details-kpi-label"> </div>
                    <div class="class-details-kpi-value">${toEn(attendanceTotal)}</div>
                  </div>
                  <div class="class-details-kpi">
                    <div class="class-details-kpi-label">  </div>
                    <div class="class-details-kpi-value">${toEn(attendanceRemaining)}</div>
                  </div>
                </div>
              `
              : `<div class="class-details-empty">${detailsEmptyLabel}</div>`;

            classDetailsPanelEl.innerHTML = `
              ${renderDetailsCard(" ", handouts.length, handoutBody)}
              ${renderDetailsCard(" ", notes.length, noteBody)}
              ${renderDetailsCard(" ", exams.length, examBody)}
              ${renderDetailsCard("  ", progressItems.length, progressBody)}
              ${renderDetailsCard("   ", attendanceRecord ? attendanceTotal : 0, attendanceBody)}
            `;
          };
          const normalizeSuggestionQuery = (value) =>
            String(value || "")
              .trim()
              .toLowerCase();
          const filterSuggestions = (list, queryRaw) => {
            const source = Array.isArray(list) ? list : [];
            const q = normalizeSuggestionQuery(queryRaw);
            if (!q) return source.slice(0, 24);
            return source
              .filter((item) =>
                String(item || "")
                  .toLowerCase()
                  .includes(q),
              )
              .slice(0, 24);
          };
          const setSuggestionPanelState = (btnEl, panelEl, isOpen) => {
            if (panelEl) panelEl.hidden = !isOpen;
            if (btnEl)
              btnEl.setAttribute("aria-expanded", isOpen ? "true" : "false");
          };
          const closeAllSuggestionPanels = () => {
            setSuggestionPanelState(nameSuggestBtn, nameSuggestPanel, false);
            setSuggestionPanelState(profSuggestBtn, profSuggestPanel, false);
          };
          const applySuggestionValue = (inputEl, value) => {
            if (!inputEl) return;
            inputEl.value = String(value || "");
            inputEl.dispatchEvent(new Event("input", { bubbles: true }));
            inputEl.focus();
          };
          const renderSuggestionPanel = (panelEl, list, onSelect) => {
            if (!panelEl) return;
            panelEl.innerHTML = "";
            if (!Array.isArray(list) || !list.length) {
              const emptyEl = document.createElement("div");
              emptyEl.className = "class-suggest-empty";
              emptyEl.textContent = noSuggestionText;
              panelEl.appendChild(emptyEl);
              return;
            }
            const frag = document.createDocumentFragment();
            list.forEach((value) => {
              const val = String(value || "").trim();
              if (!val) return;
              const btn = document.createElement("button");
              btn.type = "button";
              btn.className = "class-suggest-chip";
              btn.textContent = val;
              btn.title = val;
              btn.addEventListener("click", () => onSelect(val));
              frag.appendChild(btn);
            });
            panelEl.appendChild(frag);
          };
          const toggleSuggestionPanel = ({
            btnEl,
            panelEl,
            inputEl,
            sourceList,
            onSelect,
          }) => {
            if (!btnEl || !panelEl || !inputEl) return;
            const willOpen = panelEl.hidden;
            closeAllSuggestionPanels();
            if (!willOpen) return;
            const filtered = filterSuggestions(sourceList, inputEl.value);
            renderSuggestionPanel(panelEl, filtered, (value) => {
              applySuggestionValue(inputEl, value);
              if (typeof onSelect === "function") onSelect(value);
              setSuggestionPanelState(btnEl, panelEl, false);
            });
            setSuggestionPanelState(btnEl, panelEl, true);
          };
          if (nameSuggestBtn) {
            nameSuggestBtn.addEventListener("click", () =>
              toggleSuggestionPanel({
                btnEl: nameSuggestBtn,
                panelEl: nameSuggestPanel,
                inputEl: nameInput,
                sourceList: nameSuggestions,
              }),
            );
          }
          if (profSuggestBtn) {
            profSuggestBtn.addEventListener("click", () =>
              toggleSuggestionPanel({
                btnEl: profSuggestBtn,
                panelEl: profSuggestPanel,
                inputEl: profInput,
                sourceList: profSuggestions,
              }),
            );
          }
          const classFormEl = document.getElementById("classForm");
          if (classFormEl) {
            classFormEl.addEventListener("click", (ev) => {
              if (ev.target.closest(".class-suggest-group")) return;
              closeAllSuggestionPanels();
            });
          }
          const syncDuration = () => {
            if (!startInput || !endInput) return;
            endInput.value = app.addMinutes(
              startInput.value || "08:00",
              CLASS_DURATION_MINUTES,
            );
          };
          if (startInput) startInput.addEventListener("input", syncDuration);
          syncDuration();

          const buildDraftClassForSession = () => ({
            id: c ? Number(c.id) : null,
            name: nameInput?.value || c?.name || "",
            day: Number(dayInput?.value || 0),
            start: startInput?.value || "08:00",
            type: String(typeInput?.value || "normal"),
            sessionOffset: c ? app.normalizeSessionOffset(c.sessionOffset) : 0,
            sessionOffsetManual: Boolean(c?.sessionOffsetManual),
          });

          const syncSessionEditorHint = (forceValue = false) => {
            if (!sessionInput || !sessionHintEl) return;
            const draft = buildDraftClassForSession();
            const autoSession = app.getClassAutoSessionCount(draft, new Date());
            const draftCourseKey = app.normalizeCourseKey(draft.name);
            const existingOffset = draftCourseKey
              ? app.getCourseSessionOffsetByKey(draftCourseKey)
              : c
                ? c.sessionOffsetManual
                  ? app.normalizeSessionOffset(c.sessionOffset)
                  : 0
                : 0;
            const suggested =
              autoSession === null
                ? Math.max(0, existingOffset)
                : Math.max(1, Number(autoSession) + existingOffset);

            const manualTouched = sessionInput.dataset.manualTouched === "1";
            if (forceValue || !manualTouched) {
              sessionInput.value = String(suggested);
            }

            if (autoSession === null) {
              sessionHintEl.innerText = STR.sessionStartDatePrompt;
              return;
            }
            const autoLabel = app.formatSessionLabel(
              Math.max(1, Number(autoSession)),
            );
            sessionHintEl.innerText = `${STR.sessionAutoBaseLabel}: ${autoLabel} | ${STR.sessionOffsetHint}`;
          };

          if (sessionInput) {
            sessionInput.addEventListener("input", () => {
              sessionInput.dataset.manualTouched = "1";
            });
          }
          if (startInput)
            startInput.addEventListener("input", () => syncSessionEditorHint());
          if (dayInput)
            dayInput.addEventListener("change", () => syncSessionEditorHint());
          if (typeInput)
            typeInput.addEventListener("change", () => {
              syncSessionEditorHint();
              syncNoteEditorByType();
            });
          if (nameInput)
            nameInput.addEventListener("input", () => {
              syncSessionEditorHint();
              syncClassDetails();
              if (nameSuggestPanel && !nameSuggestPanel.hidden) {
                const filtered = filterSuggestions(
                  nameSuggestions,
                  nameInput.value,
                );
                renderSuggestionPanel(nameSuggestPanel, filtered, (value) => {
                  applySuggestionValue(nameInput, value);
                  setSuggestionPanelState(
                    nameSuggestBtn,
                    nameSuggestPanel,
                    false,
                  );
                });
              }
            });
          if (profInput)
            profInput.addEventListener("input", () => {
              if (profSuggestPanel && !profSuggestPanel.hidden) {
                const filtered = filterSuggestions(
                  profSuggestions,
                  profInput.value,
                );
                renderSuggestionPanel(profSuggestPanel, filtered, (value) => {
                  applySuggestionValue(profInput, value);
                  setSuggestionPanelState(
                    profSuggestBtn,
                    profSuggestPanel,
                    false,
                  );
                });
              }
            });
          const syncNoteEditorByType = () => {
            if (!typeInput || !noteInput) return;
            const classType = String(typeInput.value || "normal");
            const lockNote = classType === "odd" || classType === "even";
            if (lockNote) noteInput.value = "";
            noteInput.readOnly = lockNote;
            noteInput.placeholder = lockNote ? "" : STR.notes;
            noteInput.classList.toggle("opacity-70", lockNote);
          };
          syncSessionEditorHint(true);
          syncNoteEditorByType();
          syncClassDetails();

          document.getElementById("classForm").onsubmit = (e) => {
            e.preventDefault();
            closeAllSuggestionPanels();
            const name = document.getElementById("f_name").value.trim();
            const start = document.getElementById("f_start").value;
            const end = app.addMinutes(start, CLASS_DURATION_MINUTES);

            if (!name) {
              alert("   .");
              return;
            }
            if (!start) {
              alert(STR.classStartRequired);
              return;
            }

            const classType = document.getElementById("f_type").value;
            const draftClass = {
              id: document.getElementById("f_id").value
                ? Number(document.getElementById("f_id").value)
                : null,
              name,
              day: Number(document.getElementById("f_day").value),
              start,
              type: classType,
            };
            const desiredSession = Math.max(
              0,
              Math.floor(
                Number(
                  document.getElementById("f_session_current")?.value || 0,
                ),
              ),
            );
            const sessionInputEl = document.getElementById("f_session_current");
            const manualTouched =
              sessionInputEl?.dataset?.manualTouched === "1";
            const autoSession = app.getClassAutoSessionCount(
              draftClass,
              new Date(),
            );
            const autoSessionBase =
              autoSession === null
                ? null
                : Math.max(1, Number(autoSession) || 0);
            const sessionOffset =
              autoSessionBase === null
                ? desiredSession
                : desiredSession - autoSessionBase;
            const normalizedSessionOffset =
              app.normalizeSessionOffset(sessionOffset);
            const sessionOffsetManual =
              normalizedSessionOffset > 0 &&
              (manualTouched || Boolean(c?.sessionOffsetManual));

            app.addClass({
              id: document.getElementById("f_id").value
                ? Number(document.getElementById("f_id").value)
                : null,
              name,
              classNo: document.getElementById("f_class_no").value.trim(),
              prof: document.getElementById("f_prof").value.trim(),
              unit: Math.max(
                0,
                Number(document.getElementById("f_unit").value || 0),
              ),
              day: Number(document.getElementById("f_day").value),
              start,
              end,
              type: classType,
              note: app.sanitizeClassNoteByType(
                classType,
                document.getElementById("f_note").value,
              ),
              sessionOffset: normalizedSessionOffset,
              sessionOffsetManual,
            });
          };
        },

        openExamModal(id = null) {
          const ex = id ? app.data.exams.find((x) => x.id === id) : null;
          const title = ex ? STR.modalEdit : STR.modalAdd;
          const courses = app.getUniqueCourses();

          if (courses.length === 0) {
            const html = `
          <div class="theme-card p-6 w-full max-w-md shadow-2xl animate-fade-in" onclick="ui.stopEvent(event)"
               style="background: color-mix(in srgb, var(--card-bg) 90%, transparent);">
            <h3 class="text-xl font-black mb-4">${STR.exams}</h3>
            <p class="text-sm opacity-80 mb-4">         .</p>
            <button type="button" onclick="ui.closeModal()" class="w-full py-2.5 bg-[var(--accent)] text-[var(--bg)] font-black rounded-2xl hover:brightness-110 shadow-xl">${STR.cancel}</button>
          </div>
        `;
            const overlay = document.getElementById("modalOverlay");
            overlay.innerHTML = html;
            overlay.classList.remove("hidden");
            overlay.classList.add("flex");
            return;
          }

          const examCourseKey = app.normalizeCourseKey(
            ex?.courseName || app.getCourseNameByClassId(ex?.classId),
          );
          const defaultCourse =
            courses.find((c) => c.key === examCourseKey) || courses[0];
          const examDateDefault =
            app.normalizeDateKey(ex?.date) ||
            new Date().toISOString().slice(0, 10);
          const examTimeDefault = app.normalizeTime(ex?.time, "09:00");
          const fallbackNotifyAt = app.getExamNotificationDateTime(
            ex || {
              date: examDateDefault,
              time: examTimeDefault,
              notifyBeforeMin: 0,
            },
          );
          const fallbackNotifyDate = fallbackNotifyAt
            ? app.getDateKey(fallbackNotifyAt)
            : examDateDefault;
          const fallbackNotifyTime = fallbackNotifyAt
            ? fallbackNotifyAt.toLocaleTimeString("en-GB", {
                hour: "2-digit",
                minute: "2-digit",
                hour12: false,
              })
            : examTimeDefault;
          const notifyDateDefault =
            app.normalizeDateKey(ex?.notifyDate) || fallbackNotifyDate;
          const notifyTimeDefault =
            app.normalizeTime(ex?.notifyTime, "") || fallbackNotifyTime;
          const notifyEnabledDefault =
            typeof ex?.notifyEnabled === "boolean" ? ex.notifyEnabled : true;
          const notifyTextDefault = String(ex?.notifyText || ex?.title || "");

          const html = `
          <div class="theme-card exam-modal-card p-5 shadow-2xl animate-fade-in" onclick="ui.stopEvent(event)"
               style="background: color-mix(in srgb, var(--card-bg) 90%, transparent);">
            <h3 class="exam-modal-title">${title} ${STR.exams}</h3>

            <form id="examForm" class="exam-form-layout">
              <input type="hidden" id="e_id" value="${ex ? ex.id : ""}">
              <div class="exam-form-scroll">

              <div class="space-y-2">
                <div class="text-[11px] opacity-80 font-black"> </div>
                <select class="inp" id="e_course" required>
                  ${courses
                    .map(
                      (c) =>
                        `<option value="${c.key}" ${c.key === defaultCourse.key ? "selected" : ""}>${this.escapeHtml(c.name)}${c.prof ? ` - ${this.escapeHtml(c.prof)}` : ""}</option>`,
                    )
                    .join("")}
                </select>
              </div>

              <div class="space-y-2">
                <div class="text-[11px] opacity-80 font-black"> </div>
                <input class="inp" type="text" id="e_title" placeholder=":  " value="${this.escapeHtml(ex ? ex.title : "")}" required>
              </div>

              <div class="exam-modal-grid">
                <div>
                  <div class="text-[11px] opacity-80 font-black mb-1"> </div>
                  <input class="inp" type="date" id="e_date" value="${this.escapeHtml(examDateDefault)}" required>
                </div>
                <div>
                  <div class="text-[11px] opacity-80 font-black mb-1"> </div>
                  <input class="inp" type="time" id="e_time" value="${this.escapeHtml(examTimeDefault)}" required>
                </div>
              </div>

              <div class="exam-modal-note"><span class="font-black">${STR.alertDay}:</span> <span id="e_day">-</span></div>

              <div class="space-y-2">
                <div class="text-[11px] opacity-80 font-black">   </div>
                <input class="inp" type="text" id="e_loc" placeholder=":  " value="${this.escapeHtml(ex ? ex.location || "" : "")}">
              </div>

              <div id="e_notify_block" class="space-y-3 p-3 rounded-2xl" style="border: 1px dashed color-mix(in srgb, var(--border) 76%, transparent); background: color-mix(in srgb, var(--card-bg) 88%, transparent);">
                <label class="flex items-center gap-2 text-xs font-black opacity-90 cursor-pointer">
                  <input type="checkbox" id="e_notify_enabled" class="accent-green-500" ${notifyEnabledDefault ? "checked" : ""}>
                  <span> ${STR.notifyEnabled}</span>
                </label>
                <div class="exam-modal-grid">
                  <div>
                    <div class="text-[11px] opacity-80 font-black mb-1"> </div>
                    <input class="inp" type="date" id="e_notify_date" value="${this.escapeHtml(notifyDateDefault)}">
                  </div>
                  <div>
                    <div class="text-[11px] opacity-80 font-black mb-1"> </div>
                    <input class="inp" type="time" id="e_notify_time" value="${this.escapeHtml(notifyTimeDefault)}">
                  </div>
                </div>
                <div class="exam-modal-note"><span class="font-black">${STR.alertDay} :</span> <span id="e_notify_day">-</span></div>
                <div>
                  <div class="text-[11px] opacity-80 font-black mb-1">${STR.notifyText}</div>
                  <input class="inp" type="text" id="e_notify_text" placeholder="${STR.notifyText}" value="${this.escapeHtml(notifyTextDefault)}">
                </div>
                <div id="e_notify_preview" class="exam-modal-note"></div>
              </div>

              </div>
              <div class="exam-form-actions flex gap-2">
                <button type="submit" class="flex-1 py-2.5 bg-[var(--accent)] text-[var(--bg)] font-black rounded-2xl hover:brightness-110 shadow-xl">${STR.save}</button>
                ${ex ? `<button type="button" onclick="app.deleteExam(${ex.id})" class="px-3 py-2.5 text-red-500 hover:bg-red-500/10 rounded-2xl font-black">${STR.delete}</button>` : ""}
                <button type="button" onclick="ui.closeModal()" class="px-3 py-2.5 opacity-70 hover:opacity-100 rounded-2xl font-black">${STR.cancel}</button>
              </div>
            </form>
          </div>
        `;

          const overlay = document.getElementById("modalOverlay");
          overlay.innerHTML = html;
          overlay.classList.remove("hidden");
          overlay.classList.add("flex");

          const examDateEl = document.getElementById("e_date");
          const examTimeEl = document.getElementById("e_time");
          const examDayEl = document.getElementById("e_day");
          const notifyEnabledEl = document.getElementById("e_notify_enabled");
          const notifyDateEl = document.getElementById("e_notify_date");
          const notifyTimeEl = document.getElementById("e_notify_time");
          const notifyDayEl = document.getElementById("e_notify_day");
          const notifyTextEl = document.getElementById("e_notify_text");
          const notifyPreviewEl = document.getElementById("e_notify_preview");
          const notifyBlockEl = document.getElementById("e_notify_block");
          const syncExamDay = () => {
            if (!examDateEl || !examDayEl) return;
            examDayEl.textContent = app.getAlertDayLabel(examDateEl.value);
          };
          const syncNotifyDay = () => {
            if (!notifyDateEl || !notifyDayEl) return;
            notifyDayEl.textContent = app.getAlertDayLabel(notifyDateEl.value);
          };
          const syncNotifyState = () => {
            const enabled = Boolean(notifyEnabledEl?.checked);
            [notifyDateEl, notifyTimeEl, notifyTextEl].forEach((el) => {
              if (el) el.disabled = !enabled;
            });
            if (notifyBlockEl)
              notifyBlockEl.classList.toggle("opacity-60", !enabled);
          };
          const syncNotifyPreview = () => {
            if (!notifyPreviewEl) return;
            const draft = {
              date: examDateEl?.value || "",
              time: examTimeEl?.value || "",
              notifyDate: notifyDateEl?.value || "",
              notifyTime: notifyTimeEl?.value || "",
              notifyBeforeMin: 0,
              notifyEnabled: Boolean(notifyEnabledEl?.checked),
            };
            const examCountdown = app.getCountdownMeta(
              app.getExamDateTime(draft),
              new Date(),
            );
            const notifyMeta = app.getExamNotificationMeta(draft);
            const notifyCountdown = app.getCountdownMeta(
              notifyMeta.date,
              new Date(),
            );
            const parts = [];
            if (examCountdown.hasTarget) {
              parts.push(` : ${examCountdown.detailText}`);
            } else {
              parts.push(
                "     .",
              );
            }
            if (draft.notifyEnabled) {
              if (notifyMeta.hasTarget) {
                parts.push(` : ${notifyCountdown.detailText}`);
              } else {
                parts.push(
                  "/     .",
                );
              }
            } else {
              parts.push("   .");
            }
            notifyPreviewEl.innerText = parts.join(" | ");
          };
          if (examDateEl) examDateEl.addEventListener("input", syncExamDay);
          if (examDateEl)
            examDateEl.addEventListener("input", syncNotifyPreview);
          if (examTimeEl)
            examTimeEl.addEventListener("input", syncNotifyPreview);
          if (notifyDateEl)
            notifyDateEl.addEventListener("input", syncNotifyDay);
          if (notifyDateEl)
            notifyDateEl.addEventListener("input", syncNotifyPreview);
          if (notifyTimeEl)
            notifyTimeEl.addEventListener("input", syncNotifyPreview);
          if (notifyEnabledEl)
            notifyEnabledEl.addEventListener("change", () => {
              syncNotifyState();
              syncNotifyPreview();
            });
          syncExamDay();
          syncNotifyDay();
          syncNotifyState();
          syncNotifyPreview();

          document.getElementById("examForm").onsubmit = (ev) => {
            ev.preventDefault();
            const courseKey = document.getElementById("e_course").value;
            const selectedCourse =
              courses.find((c) => c.key === courseKey) || null;
            const examTitle = document.getElementById("e_title").value.trim();
            const date = document.getElementById("e_date").value;
            const time = document.getElementById("e_time").value;
            const notifyDate = document
              .getElementById("e_notify_date")
              .value.trim();
            const notifyTime = document
              .getElementById("e_notify_time")
              .value.trim();
            const notifyText = document
              .getElementById("e_notify_text")
              .value.trim();
            const notifyEnabled =
              document.getElementById("e_notify_enabled").checked;

            if (!examTitle) {
              alert("   .");
              return;
            }
            if (!selectedCourse) {
              alert(STR.examCourseRequired);
              return;
            }
            if (!date) {
              alert(STR.examDateRequired);
              return;
            }
            if (!time) {
              alert(STR.examTimeRequired);
              return;
            }
            if (notifyEnabled && !notifyDate) {
              alert(STR.alertDateRequired);
              return;
            }
            if (notifyEnabled && !notifyTime) {
              alert(STR.alertTimeRequired);
              return;
            }
            if (notifyEnabled && !notifyText) {
              alert(STR.examNotifyTextRequired);
              return;
            }

            if (notifyEnabled) app.requestNotificationPermission(false);

            app.addExam({
              id: document.getElementById("e_id").value
                ? Number(document.getElementById("e_id").value)
                : null,
              classId: Number(selectedCourse.classId),
              courseName: selectedCourse.name,
              title: examTitle,
              date,
              time,
              location: document.getElementById("e_loc").value.trim(),
              notifyDate: notifyEnabled ? notifyDate : "",
              notifyTime: notifyEnabled ? notifyTime : "",
              notifyBeforeMin: 0,
              notifyText,
              notifyEnabled,
            });
          };
        },

        openNoteModal(id = null, forceImportant = false) {
          const note = id ? app.data.notes.find((x) => x.id === id) : null;
          const title = note ? STR.modalEdit : STR.modalAdd;
          const classes = app.data.classes
            .slice()
            .sort(
              (a, b) =>
                a.day * 10000 +
                a.start.replace(":", "") -
                (b.day * 10000 + b.start.replace(":", "")),
            );

          if (classes.length === 0) {
            const html = `
          <div class="theme-card p-6 w-full max-w-md shadow-2xl animate-fade-in" onclick="ui.stopEvent(event)"
               style="background: color-mix(in srgb, var(--card-bg) 90%, transparent);">
            <h3 class="text-xl font-black mb-4">${STR.notesBoard}</h3>
            <p class="text-sm opacity-80 mb-4">         .</p>
            <button type="button" onclick="ui.closeModal()" class="w-full py-2.5 bg-[var(--accent)] text-[var(--bg)] font-black rounded-2xl hover:brightness-110 shadow-xl">${STR.cancel}</button>
          </div>
        `;
            const overlay = document.getElementById("modalOverlay");
            overlay.innerHTML = html;
            overlay.classList.remove("hidden");
            overlay.classList.add("flex");
            return;
          }

          const importantDefault = Boolean(note?.important || forceImportant);
          const alertDateDefault =
            note?.alertDate || new Date().toISOString().slice(0, 10);
          const alertTimeDefault = note?.alertTime || "09:00";
          const notifyBeforeDefault = NOTIFY_BEFORE_OPTIONS.includes(
            Number(note?.notifyBeforeMin),
          )
            ? Number(note.notifyBeforeMin)
            : 0;
          const notifyEnabledDefault =
            typeof note?.notifyEnabled === "boolean"
              ? note.notifyEnabled
              : importantDefault;
          const notifyTextDefault = String(
            note?.notifyText || note?.text || "",
          );

          const html = `
          <div class="theme-card p-6 w-full max-w-md shadow-2xl animate-fade-in" onclick="ui.stopEvent(event)"
               style="background: color-mix(in srgb, var(--card-bg) 90%, transparent);">
            <h3 class="text-xl font-black mb-4">${title} ${STR.notesBoard}</h3>

            <form id="noteForm" class="space-y-3">
              <input type="hidden" id="n_id" value="${note ? note.id : ""}">

              <div class="text-[11px] opacity-70 font-black">${STR.noteClass}</div>
              <select class="inp" id="n_class" required>
                ${classes
                  .map(
                    (c) =>
                      `<option value="${c.id}" ${note && note.classId === c.id ? "selected" : ""}>${this.escapeHtml(c.name)} - ${STR.days[c.day]} (${c.start}-${c.end})</option>`,
                  )
                  .join("")}
              </select>

              <div class="text-[11px] opacity-70 font-black">${STR.noteText}</div>
              <textarea class="inp min-h-[120px]" id="n_text" placeholder="${STR.noteText}" required>${note ? this.escapeHtml(note.text) : ""}</textarea>

              <label class="flex items-center gap-2 text-xs font-black opacity-85 cursor-pointer">
                <input type="checkbox" id="n_important" class="accent-red-500" ${importantDefault ? "checked" : ""}>
                <span> ${STR.pinAlert}</span>
              </label>

              <div id="n_alert_block" class="space-y-3 ${importantDefault ? "" : "hidden"}">
                <div class="grid grid-cols-2 gap-2">
                  <div>
                    <div class="text-[11px] opacity-70 font-black mb-1">${STR.alertDate}</div>
                    <input class="inp" type="date" id="n_alert_date" value="${alertDateDefault}">
                  </div>
                  <div>
                    <div class="text-[11px] opacity-70 font-black mb-1">${STR.alertTime}</div>
                    <input class="inp" type="time" id="n_alert_time" value="${alertTimeDefault}">
                  </div>
                </div>

                <div class="text-[11px] opacity-80 font-black">${STR.alertDay}: <span id="n_alert_day">-</span></div>

                <div>
                  <div class="text-[11px] opacity-70 font-black mb-1">${STR.notifyWhen}</div>
                  <select class="inp" id="n_notify_before">
                    <option value="0" ${notifyBeforeDefault === 0 ? "selected" : ""}>${STR.notifyAtTime}</option>
                    <option value="5" ${notifyBeforeDefault === 5 ? "selected" : ""}>${STR.notifyBefore5}</option>
                    <option value="10" ${notifyBeforeDefault === 10 ? "selected" : ""}>${STR.notifyBefore10}</option>
                    <option value="15" ${notifyBeforeDefault === 15 ? "selected" : ""}>${STR.notifyBefore15}</option>
                    <option value="20" ${notifyBeforeDefault === 20 ? "selected" : ""}>${STR.notifyBefore20}</option>
                    <option value="30" ${notifyBeforeDefault === 30 ? "selected" : ""}>${STR.notifyBefore30}</option>
                    <option value="45" ${notifyBeforeDefault === 45 ? "selected" : ""}>${STR.notifyBefore45}</option>
                    <option value="60" ${notifyBeforeDefault === 60 ? "selected" : ""}>${STR.notifyBefore60}</option>
                    <option value="90" ${notifyBeforeDefault === 90 ? "selected" : ""}>${STR.notifyBefore90}</option>
                    <option value="120" ${notifyBeforeDefault === 120 ? "selected" : ""}>${STR.notifyBefore120}</option>
                    <option value="180" ${notifyBeforeDefault === 180 ? "selected" : ""}>${STR.notifyBefore180}</option>
                    <option value="360" ${notifyBeforeDefault === 360 ? "selected" : ""}>${STR.notifyBefore360}</option>
                    <option value="720" ${notifyBeforeDefault === 720 ? "selected" : ""}>${STR.notifyBefore720}</option>
                    <option value="1440" ${notifyBeforeDefault === 1440 ? "selected" : ""}>${STR.notifyBefore1440}</option>
                    <option value="2880" ${notifyBeforeDefault === 2880 ? "selected" : ""}>${STR.notifyBefore2880}</option>
                    <option value="10080" ${notifyBeforeDefault === 10080 ? "selected" : ""}>${STR.notifyBefore10080}</option>
                  </select>
                </div>

                <div>
                  <div class="text-[11px] opacity-70 font-black mb-1">${STR.notifyText}</div>
                  <input class="inp" type="text" id="n_notify_text" placeholder="${STR.notifyText}" value="${this.escapeHtml(notifyTextDefault)}">
                </div>

                <label class="flex items-center gap-2 text-xs font-black opacity-85 cursor-pointer">
                  <input type="checkbox" id="n_notify_enabled" class="accent-green-500" ${notifyEnabledDefault ? "checked" : ""}>
                  <span> ${STR.notifyEnabled}</span>
                </label>
              </div>

              <div class="flex gap-2 mt-4 pt-2" style="border-top: 1px solid var(--border);">
                <button type="submit" class="flex-1 py-2.5 bg-[var(--accent)] text-[var(--bg)] font-black rounded-2xl hover:brightness-110 shadow-xl">${STR.save}</button>
                ${note ? `<button type="button" onclick="app.deleteNote(${note.id})" class="px-3 py-2.5 text-red-500 hover:bg-red-500/10 rounded-2xl font-black">${STR.delete}</button>` : ""}
                <button type="button" onclick="ui.closeModal()" class="px-3 py-2.5 opacity-70 hover:opacity-100 rounded-2xl font-black">${STR.cancel}</button>
              </div>
            </form>
          </div>
        `;

          const overlay = document.getElementById("modalOverlay");
          overlay.innerHTML = html;
          overlay.classList.remove("hidden");
          overlay.classList.add("flex");

          const importantEl = document.getElementById("n_important");
          const alertBlockEl = document.getElementById("n_alert_block");
          const alertDateEl = document.getElementById("n_alert_date");
          const alertDayEl = document.getElementById("n_alert_day");
          const notifyEnabledEl = document.getElementById("n_notify_enabled");

          const syncAlertBlock = () => {
            if (!importantEl || !alertBlockEl) return;
            const isOn = importantEl.checked;
            alertBlockEl.classList.toggle("hidden", !isOn);
            if (!isOn && notifyEnabledEl) notifyEnabledEl.checked = false;
          };

          const syncAlertDay = () => {
            if (!alertDayEl || !alertDateEl) return;
            alertDayEl.textContent = app.getAlertDayLabel(alertDateEl.value);
          };

          if (importantEl)
            importantEl.addEventListener("change", syncAlertBlock);
          if (alertDateEl) alertDateEl.addEventListener("input", syncAlertDay);
          syncAlertBlock();
          syncAlertDay();

          document.getElementById("noteForm").onsubmit = (ev) => {
            ev.preventDefault();

            const classId = Number(document.getElementById("n_class").value);
            const text = document.getElementById("n_text").value.trim();
            const important = document.getElementById("n_important").checked;
            const alertDate = important
              ? document.getElementById("n_alert_date").value
              : "";
            const alertTime = important
              ? document.getElementById("n_alert_time").value
              : "";
            const notifyBeforeMin = important
              ? Number(document.getElementById("n_notify_before").value || 0)
              : 0;
            const notifyText = important
              ? document.getElementById("n_notify_text").value.trim()
              : "";
            const notifyEnabled = important
              ? document.getElementById("n_notify_enabled").checked
              : false;

            if (!Number.isFinite(classId)) {
              alert("    .");
              return;
            }
            if (!text) {
              alert("   .");
              return;
            }
            if (important && !alertDate) {
              alert(STR.alertDateRequired);
              return;
            }
            if (important && !alertTime) {
              alert(STR.alertTimeRequired);
              return;
            }
            if (important && notifyEnabled && !notifyText) {
              alert(STR.notifyTextRequired);
              return;
            }

            if (important && notifyEnabled) {
              app.requestNotificationPermission(false);
            }

            app.addNote({
              id: document.getElementById("n_id").value
                ? Number(document.getElementById("n_id").value)
                : null,
              classId,
              text,
              important,
              alertDate,
              alertTime,
              notifyBeforeMin,
              notifyText,
              notifyEnabled,
              createdAt: note?.createdAt || new Date().toISOString(),
            });
          };
        },

        closeModal() {
          const overlay = document.getElementById("modalOverlay");
          if (!overlay) return;
          if (overlay && typeof overlay.__activeModalCleanup === "function") {
            try {
              overlay.__activeModalCleanup();
            } catch {}
          }
          overlay.__activeModalCleanup = null;
          overlay.classList.add("hidden");
          overlay.classList.remove("flex");
          document.body.classList.remove("modal-open");
        },
      };

      const cloudSync = {
        state: "offline",
        stateDetail: "",
        debounceTimerId: 0,
        debounceDueAt: 0,
        tokenClient: null,
        tokenPromise: null,
        tokenResolve: null,
        tokenReject: null,
        googleClientReady: false,
        runtimeBound: false,
        syncSignalChannel: null,
        lastExternalSignalAt: 0,
        lastLocalSignalAt: 0,
        accessToken: "",
        accessTokenExpireAt: 0,
        fileId: "",
        syncingNow: false,
        pendingSyncAfterCurrent: false,
        suppressLocalChange: false,
        user: null,
        recentSyncEvents: [],
        meta: {
          lastUpdatedAt: "",
          lastSyncedAt: "",
          googleUserId: "",
          fileId: "",
        },
        deviceId: "",
        clientId: String(GOOGLE_OAUTH_CLIENT_ID || "").trim(),
        clientIdCustom: false,
        ultraEnabled: true,
        ultraMobileProfile: "balanced",
        localPushTimerId: 0,
        signalBurstUntil: 0,
        signalFollowupFastTimerId: 0,
        signalFollowupMidTimerId: 0,
        signalFollowupSlowTimerId: 0,
        lastSignalChaseAt: 0,
        autoSyncTimerId: 0,
        autoSyncWarmupTimerId: 0,
        autoSyncImmediateTimerId: 0,
        autoSyncInFlight: null,
        loopRecalcTimerId: 0,
        autoSyncIntervalMs: 0,
        lastAutoSyncAt: 0,
        lastForegroundSyncAt: 0,
        lastRemoteModifiedAt: 0,
        remoteMetaCacheAt: 0,
        remoteMetaCache: null,
        fastSyncUntil: 0,
        ultraSyncUntil: 0,
        ultraSyncStartedAt: 0,
        ultraCooldownUntil: 0,
        ultraIdlePollStreak: 0,
        syncErrorStreak: 0,
        syncBackoffUntil: 0,
        recoveryTimerId: 0,
        lastSyncSucceededAt: 0,

        init() {
          this.restoreMeta();
          this.lastRemoteModifiedAt = this.parseTime(this.meta.lastSyncedAt);
          this.restoreUserCache();
          this.restoreClientIdConfig();
          this.restoreSyncPrefs();
          this.restoreTokenCache();
          this.deviceId = this.getOrCreateDeviceId();
          this.bindRuntimeEvents();
          this.initGoogleClient();
          if (this.user?.googleUserId && this.canUseCloud()) {
            this.fastSyncUntil =
              Date.now() + Math.round(CLOUD_SYNC_FAST_WINDOW_MS * 0.65);
            this.startAutoSyncLoop(true);
          }
          this.renderSyncBadge();
          this.refreshSyncModalUi();
        },

        async onAppReady() {
          this.renderSyncBadge();
          if (this.user?.googleUserId && this.canUseCloud()) {
            this.enterFastSyncWindow(CLOUD_SYNC_FAST_WINDOW_MS);
            this.enterUltraRealtimeWindow(
              "boot-session",
              Math.round(CLOUD_SYNC_ULTRA_WINDOW_MS * 0.72),
            );
          }
          if (!this.canUseCloud()) return;
          if (!navigator.onLine) {
            this.setState("offline", "offline");
            return;
          }

          try {
            const token = await this.ensureAccessToken(false);
            if (!token) return;

            if (!this.user || !this.user.googleUserId) {
              const profile = await this.fetchGoogleProfile(false);
              const normalized = this.normalizeUser(profile);
              if (normalized.googleUserId) {
                this.user = normalized;
                this.meta.googleUserId = normalized.googleUserId;
                this.persistUserCache();
                this.persistMeta();
              }
            }
            await this.reconcileRemoteAndLocal("boot", false);
            this.enterFastSyncWindow(CLOUD_SYNC_FAST_WINDOW_MS);
            this.enterUltraRealtimeWindow(
              "boot-sync",
              Math.round(CLOUD_SYNC_ULTRA_WINDOW_MS * 0.86),
            );
            this.triggerForegroundSync("boot-visible");
          } catch (err) {
            console.warn("cloud sync boot skipped:", err);
            this.setState("offline", String(err?.message || err || "").trim());
          }
        },

        getClientId() {
          return String(this.clientId || GOOGLE_OAUTH_CLIENT_ID || "").trim();
        },

        isValidClientId(value) {
          const id = String(value || "").trim();
          if (!id) return false;
          if (/YOUR_GOOGLE_CLIENT_ID/i.test(id)) return false;
          if (!id.endsWith(".apps.googleusercontent.com")) return false;
          return true;
        },

        restoreClientIdConfig() {
          const fallback = String(GOOGLE_OAUTH_CLIENT_ID || "").trim();
          let stored = "";
          try {
            stored = String(
              localStorage.getItem(CLOUD_SYNC_CLIENT_ID_KEY) || "",
            ).trim();
          } catch {}
          if (this.isValidClientId(stored)) {
            this.clientId = stored;
            this.clientIdCustom = true;
            return;
          }
          if (stored) {
            try {
              localStorage.removeItem(CLOUD_SYNC_CLIENT_ID_KEY);
            } catch {}
          }
          this.clientId = fallback;
          this.clientIdCustom = false;
        },

        persistClientIdConfig(customValue = "") {
          const clean = String(customValue || "").trim();
          try {
            if (clean) {
              localStorage.setItem(CLOUD_SYNC_CLIENT_ID_KEY, clean);
            } else {
              localStorage.removeItem(CLOUD_SYNC_CLIENT_ID_KEY);
            }
          } catch {}
        },

        sanitizeUltraMobileProfile(value) {
          const normalized = String(value || "")
            .trim()
            .toLowerCase();
          return normalized === "battery" ? "battery" : "balanced";
        },

        restoreSyncPrefs() {
          try {
            const raw = String(
              localStorage.getItem(CLOUD_SYNC_PREFS_KEY) || "",
            ).trim();
            if (!raw) return;
            const parsed = JSON.parse(raw);
            if (parsed && typeof parsed === "object") {
              if (
                Object.prototype.hasOwnProperty.call(parsed, "ultraEnabled")
              ) {
                this.ultraEnabled = Boolean(parsed.ultraEnabled);
              }
              this.ultraMobileProfile = this.sanitizeUltraMobileProfile(
                parsed.ultraMobileProfile,
              );
            }
          } catch {}
        },

        persistSyncPrefs() {
          try {
            const payload = JSON.stringify({
              ultraEnabled: Boolean(this.ultraEnabled),
              ultraMobileProfile: this.sanitizeUltraMobileProfile(
                this.ultraMobileProfile,
              ),
            });
            localStorage.setItem(CLOUD_SYNC_PREFS_KEY, payload);
          } catch {}
        },

        setUltraEnabled(nextEnabled, opts = {}) {
          const options = opts && typeof opts === "object" ? opts : {};
          const next = Boolean(nextEnabled);
          if (next === Boolean(this.ultraEnabled)) return false;
          this.ultraEnabled = next;
          this.persistSyncPrefs();
          if (!next) {
            this.clearUltraRealtimeWindow("manual-off");
          } else {
            this.ultraCooldownUntil = 0;
            this.enterUltraRealtimeWindow("manual-on", this.getUltraWindowMs());
          }
          if (this.user?.googleUserId && this.canUseCloud()) {
            this.startAutoSyncLoop(true);
          }
          if (!options.skipUi) {
            this.refreshSyncModalUi();
          }
          return true;
        },

        toggleUltraRealtime() {
          return this.setUltraEnabled(!this.ultraEnabled);
        },

        setUltraMobileProfile(nextProfile, opts = {}) {
          const options = opts && typeof opts === "object" ? opts : {};
          const normalized = this.sanitizeUltraMobileProfile(nextProfile);
          if (normalized === this.ultraMobileProfile) return false;
          this.ultraMobileProfile = normalized;
          if (normalized === "balanced") {
            this.ultraCooldownUntil = 0;
          }
          this.persistSyncPrefs();
          if (normalized === "battery" && this.isUltraRealtimeActive()) {
            const maxUntil =
              Date.now() + Math.round(this.getUltraWindowMs() * 0.72);
            if (Number(this.ultraSyncUntil || 0) > maxUntil) {
              this.ultraSyncUntil = maxUntil;
            }
          }
          if (this.user?.googleUserId && this.canUseCloud()) {
            this.startAutoSyncLoop(true);
          }
          if (!options.skipUi) {
            this.refreshSyncModalUi();
          }
          return true;
        },

        toggleUltraMobileProfile() {
          const next =
            this.ultraMobileProfile === "battery" ? "balanced" : "battery";
          return this.setUltraMobileProfile(next);
        },

        restoreTokenCache() {
          const now = Date.now();
          const minValidUntil = now + 15000;
          let raw = "";
          try {
            raw = String(
              sessionStorage.getItem(CLOUD_SYNC_TOKEN_CACHE_KEY) || "",
            );
          } catch {}
          if (!raw) {
            try {
              raw = String(
                localStorage.getItem(CLOUD_SYNC_TOKEN_CACHE_KEY) || "",
              );
            } catch {}
          }
          raw = String(raw || "").trim();
          if (!raw) return;

          try {
            const parsed = JSON.parse(raw);
            const token = String(parsed?.accessToken || "").trim();
            const expireAt = Number(parsed?.expireAt || 0);
            const tokenClientId = String(parsed?.clientId || "").trim();
            if (
              !token ||
              !Number.isFinite(expireAt) ||
              expireAt <= minValidUntil ||
              tokenClientId !== this.getClientId()
            ) {
              this.clearTokenCache();
              return;
            }
            this.accessToken = token;
            this.accessTokenExpireAt = expireAt;
          } catch {
            this.clearTokenCache();
          }
        },

        persistTokenCache() {
          const token = String(this.accessToken || "").trim();
          const expireAt = Number(this.accessTokenExpireAt || 0);
          if (!token || !Number.isFinite(expireAt) || expireAt <= Date.now()) {
            this.clearTokenCache();
            return;
          }
          const payload = JSON.stringify({
            accessToken: token,
            expireAt,
            clientId: this.getClientId(),
            savedAt: new Date().toISOString(),
          });
          try {
            sessionStorage.setItem(CLOUD_SYNC_TOKEN_CACHE_KEY, payload);
          } catch {}
          try {
            localStorage.setItem(CLOUD_SYNC_TOKEN_CACHE_KEY, payload);
          } catch {}
        },

        clearTokenCache() {
          try {
            sessionStorage.removeItem(CLOUD_SYNC_TOKEN_CACHE_KEY);
          } catch {}
          try {
            localStorage.removeItem(CLOUD_SYNC_TOKEN_CACHE_KEY);
          } catch {}
        },

        resetAuthRuntime() {
          this.accessToken = "";
          this.accessTokenExpireAt = 0;
          this.tokenClient = null;
          this.googleClientReady = false;
          this.clearTokenCache();
          this.clearPendingTokenPromise();
          this.clearRecoverySyncTimer();
          this.clearLoopRecalcTimer();
          this.clearSignalFollowupTimers();
          this.signalBurstUntil = 0;
          this.lastSignalChaseAt = 0;
          this.resetUltraRealtimeState();
          if (this.debounceTimerId) {
            window.clearTimeout(this.debounceTimerId);
            this.debounceTimerId = 0;
          }
          this.debounceDueAt = 0;
          this.clearLocalPushTimer();
        },

        setClientId(nextClientId = "", options = {}) {
          const opts = options && typeof options === "object" ? options : {};
          const fallback = String(GOOGLE_OAUTH_CLIENT_ID || "").trim();
          const requested = String(nextClientId || "").trim();
          const useFallback = Boolean(opts.useFallback) || !requested;
          if (!useFallback && !this.isValidClientId(requested)) {
            return false;
          }
          const resolved = useFallback ? fallback : requested;
          const previous = this.getClientId();
          this.clientId = resolved;
          this.clientIdCustom = !useFallback;
          this.persistClientIdConfig(this.clientIdCustom ? resolved : "");

          if (previous !== resolved) {
            this.resetAuthRuntime();
            this.stopAutoSyncLoop();
            this.user = null;
            this.fileId = "";
            this.meta.googleUserId = "";
            this.meta.fileId = "";
            this.meta.lastSyncedAt = "";
            this.lastSyncSucceededAt = 0;
            this.clearRemoteMetaCache();
            this.clearRecoverySyncTimer();
            this.resetUltraRealtimeState();
            this.persistMeta();
            this.persistUserCache();
            this.setState("offline", "client-id-updated");
          } else {
            this.renderSyncBadge();
            this.refreshSyncModalUi();
          }
          return true;
        },

        applyClientIdFromInput() {
          const input = document.getElementById("inputSyncClientId");
          if (!input) return false;
          const raw = String(input.value || "").trim();
          if (!raw) {
            alert(STR.syncClientIdEmpty);
            return false;
          }
          const ok = this.setClientId(raw, { useFallback: false });
          if (!ok) {
            alert(STR.syncClientIdInvalid);
            return false;
          }
          alert(STR.syncClientIdSaved);
          return true;
        },

        resetClientIdConfig() {
          const hadCustom = this.clientIdCustom;
          const ok = this.setClientId("", { useFallback: true });
          if (ok && hadCustom) {
            alert(STR.syncClientIdResetDone);
          }
          return ok;
        },

        canUseCloud() {
          return this.isValidClientId(this.getClientId());
        },

        initGoogleClient() {
          if (!this.canUseCloud()) return false;
          if (this.googleClientReady) return true;
          if (
            !window.google ||
            !google.accounts ||
            !google.accounts.oauth2 ||
            typeof google.accounts.oauth2.initTokenClient !== "function"
          ) {
            return false;
          }

          const hint = String(this.user?.email || "").trim();
          this.tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: this.getClientId(),
            scope:
              "https://www.googleapis.com/auth/drive.appdata openid email profile",
            ...(hint ? { hint } : {}),
            callback: (resp) => this.handleTokenResponse(resp),
            error_callback: (err) => this.handleTokenError(err),
          });
          this.googleClientReady = true;
          return true;
        },

        async waitForGoogleClient(timeoutMs = 9000) {
          const start = Date.now();
          while (Date.now() - start < timeoutMs) {
            if (this.initGoogleClient()) return true;
            await new Promise((resolve) => setTimeout(resolve, 220));
          }
          return this.googleClientReady;
        },

        handleTokenResponse(resp) {
          const out = resp && typeof resp === "object" ? resp : {};
          if (out.error || !out.access_token) {
            const errMsg = String(out.error || "oauth-token-failed").trim();
            if (typeof this.tokenReject === "function") {
              this.tokenReject(new Error(errMsg));
            }
            this.clearPendingTokenPromise();
            return;
          }

          this.accessToken = String(out.access_token || "");
          const expiresInSec = Math.max(60, Number(out.expires_in) || 3600);
          this.accessTokenExpireAt = Date.now() + (expiresInSec - 25) * 1000;
          this.persistTokenCache();

          if (typeof this.tokenResolve === "function") {
            this.tokenResolve(this.accessToken);
          }
          this.clearPendingTokenPromise();
        },

        handleTokenError(err) {
          const msg = String(err?.type || err?.message || err || "oauth-error")
            .trim()
            .toLowerCase();
          if (typeof this.tokenReject === "function") {
            this.tokenReject(new Error(msg || "oauth-error"));
          }
          this.clearPendingTokenPromise();
        },

        clearPendingTokenPromise() {
          this.tokenPromise = null;
          this.tokenResolve = null;
          this.tokenReject = null;
        },

        async requestAccessToken(options = {}) {
          const opts = options && typeof options === "object" ? options : {};
          const interactive = Boolean(opts.interactive);
          const prompt =
            typeof opts.prompt === "string"
              ? String(opts.prompt)
              : interactive
                ? "select_account"
                : "";
          const hint = String(opts.hint || this.user?.email || "").trim();
          if (this.tokenPromise) return this.tokenPromise;
          if (!(await this.waitForGoogleClient())) {
            throw new Error("google-client-not-ready");
          }

          this.tokenPromise = new Promise((resolve, reject) => {
            this.tokenResolve = resolve;
            this.tokenReject = reject;
            try {
              const req = { prompt };
              if (hint) req.hint = hint;
              this.tokenClient.requestAccessToken(req);
            } catch (err) {
              this.clearPendingTokenPromise();
              reject(err);
            }
          });
          return this.tokenPromise;
        },

        async ensureAccessToken(interactive = false) {
          if (!this.canUseCloud()) return "";
          if (!navigator.onLine) return "";
          if (
            this.accessToken &&
            Date.now() < Number(this.accessTokenExpireAt || 0)
          ) {
            return this.accessToken;
          }
          this.clearTokenCache();

          try {
            const silentToken = await this.requestAccessToken({
              interactive: false,
              prompt: "",
            });
            if (silentToken) return silentToken;
          } catch (silentErr) {
            if (!interactive) return "";
          }
          if (!interactive) return "";

          try {
            return await this.requestAccessToken({
              interactive: true,
              prompt: "select_account",
            });
          } catch (firstErr) {
            const msg = String(firstErr?.message || firstErr || "")
              .trim()
              .toLowerCase();
            const needsConsent =
              msg.includes("consent") ||
              msg.includes("access_denied") ||
              msg.includes("scope");
            if (!needsConsent) throw firstErr;
            return await this.requestAccessToken({
              interactive: true,
              prompt: "consent",
            });
          }
        },

        async fetchGoogleProfile(interactive = false) {
          const resp = await this.apiFetch(
            "https://www.googleapis.com/oauth2/v3/userinfo",
            { method: "GET" },
            interactive,
          );
          return await resp.json();
        },

        normalizeUser(profile = {}) {
          const source = profile && typeof profile === "object" ? profile : {};
          return {
            googleUserId: String(source.sub || "").trim(),
            email: String(source.email || "").trim(),
            name: String(source.name || "").trim(),
          };
        },

        async signIn(interactive = true) {
          if (!this.canUseCloud()) {
            alert(STR.syncClientIdMissing);
            return false;
          }
          if (!navigator.onLine) {
            this.setState("offline", "offline");
            return false;
          }

          try {
            this.setState("syncing", "auth");
            const token = await this.ensureAccessToken(interactive);
            if (!token) {
              this.setState("offline", "no-token");
              return false;
            }

            const profile = await this.fetchGoogleProfile(interactive);
            const nextUser = this.normalizeUser(profile);
            if (!nextUser.googleUserId) {
              throw new Error("google-user-id-missing");
            }

            if (
              this.meta.googleUserId &&
              this.meta.googleUserId !== nextUser.googleUserId
            ) {
              this.meta.fileId = "";
              this.meta.lastUpdatedAt = "";
            }

            this.user = nextUser;
            this.meta.googleUserId = nextUser.googleUserId;
            this.fileId = this.meta.fileId || "";
            this.persistUserCache();
            this.persistMeta();

            await this.reconcileRemoteAndLocal("signin", false);
            this.startAutoSyncLoop(true);
            return true;
          } catch (err) {
            console.error("Google sign-in failed:", err);
            this.setState("error", String(err?.message || err || "").trim());
            return false;
          } finally {
            this.renderSyncBadge();
            this.refreshSyncModalUi();
          }
        },

        signOut() {
          if (!confirm(STR.syncSignOutConfirm)) return;
          try {
            if (
              this.accessToken &&
              window.google &&
              google.accounts &&
              google.accounts.oauth2 &&
              typeof google.accounts.oauth2.revoke === "function"
            ) {
              google.accounts.oauth2.revoke(this.accessToken, () => {});
            }
          } catch (err) {
            console.warn("Google revoke warning:", err);
          }

          this.stopAutoSyncLoop();
          this.resetAuthRuntime();
          this.fastSyncUntil = 0;
          this.syncErrorStreak = 0;
          this.syncBackoffUntil = 0;
          this.autoSyncInFlight = null;
          this.lastSyncSucceededAt = 0;
          this.resetUltraRealtimeState();
          this.clearRemoteMetaCache();
          this.fileId = "";
          this.user = null;
          this.meta.googleUserId = "";
          this.meta.fileId = "";
          this.meta.lastSyncedAt = "";
          this.persistMeta();
          this.persistUserCache();

          this.setState("offline", "signout");
          this.renderSyncBadge();
          this.refreshSyncModalUi();
        },

        getStateText(state = this.state) {
          if (state === "syncing") return STR.syncStateSyncing;
          if (state === "synced") return STR.syncStateSynced;
          if (state === "error") return STR.syncStateError;
          return STR.syncStateOffline;
        },

        setState(next, detail = "") {
          this.state = next || "offline";
          this.stateDetail = String(detail || "").trim();
          try {
            const event = {
              at: new Date().toISOString(),
              state: this.state,
              detail: this.stateDetail,
            };
            if (!Array.isArray(this.recentSyncEvents))
              this.recentSyncEvents = [];
            this.recentSyncEvents.unshift(event);
            if (this.recentSyncEvents.length > 12) {
              this.recentSyncEvents.length = 12;
            }
          } catch {}
          this.renderSyncBadge();
          this.refreshSyncModalUi();
        },

        renderSyncBadge() {
          const btn = document.getElementById("btnCloudSync");
          const stateEl = document.getElementById("txtCloudSyncState");
          const labelEl = document.getElementById("txtCloudSyncLabel");
          if (!btn || !stateEl || !labelEl) return;

          labelEl.innerText = STR.syncLabelShort;
          stateEl.innerText = this.getStateText(this.state);
          stateEl.dataset.state = this.state;
          btn.dataset.state = this.state;
          btn.title = STR.syncOpenPanel;
        },

        restoreMeta() {
          try {
            const raw = localStorage.getItem(CLOUD_SYNC_META_KEY);
            const parsed = raw ? JSON.parse(raw) : {};
            this.meta = {
              lastUpdatedAt: String(parsed?.lastUpdatedAt || "").trim(),
              lastSyncedAt: String(parsed?.lastSyncedAt || "").trim(),
              googleUserId: String(parsed?.googleUserId || "").trim(),
              fileId: String(parsed?.fileId || "").trim(),
            };
            this.fileId = this.meta.fileId || "";
          } catch {
            this.meta = {
              lastUpdatedAt: "",
              lastSyncedAt: "",
              googleUserId: "",
              fileId: "",
            };
            this.fileId = "";
          }
        },

        persistMeta() {
          try {
            localStorage.setItem(
              CLOUD_SYNC_META_KEY,
              JSON.stringify(this.meta),
            );
          } catch {}
        },

        restoreUserCache() {
          try {
            const raw = localStorage.getItem(CLOUD_SYNC_USER_KEY);
            const parsed = raw ? JSON.parse(raw) : {};
            if (parsed && typeof parsed === "object") {
              const next = {
                googleUserId: String(parsed.googleUserId || "").trim(),
                email: String(parsed.email || "").trim(),
                name: String(parsed.name || "").trim(),
              };
              this.user = next.googleUserId ? next : null;
            }
          } catch {
            this.user = null;
          }
        },

        persistUserCache() {
          try {
            if (this.user && this.user.googleUserId) {
              localStorage.setItem(
                CLOUD_SYNC_USER_KEY,
                JSON.stringify(this.user),
              );
            } else {
              localStorage.removeItem(CLOUD_SYNC_USER_KEY);
            }
          } catch {}
        },

        getOrCreateDeviceId() {
          try {
            const existing = String(
              localStorage.getItem(CLOUD_SYNC_DEVICE_KEY) || "",
            ).trim();
            if (existing) return existing;
            const next =
              typeof crypto !== "undefined" && crypto.randomUUID
                ? crypto.randomUUID()
                : `dev-${Date.now()}-${Math.random().toString(36).slice(2, 10)}`;
            localStorage.setItem(CLOUD_SYNC_DEVICE_KEY, next);
            return next;
          } catch {
            return `dev-${Date.now()}-${Math.random().toString(36).slice(2, 10)}`;
          }
        },

        emitSyncSignal(reason = "change") {
          const now = Date.now();
          if (now - Number(this.lastLocalSignalAt || 0) < 120) return;
          this.lastLocalSignalAt = now;
          const payload = {
            at: now,
            reason: String(reason || "change").slice(0, 48),
            deviceId: String(this.deviceId || ""),
          };
          try {
            if (
              !this.syncSignalChannel &&
              typeof window !== "undefined" &&
              "BroadcastChannel" in window
            ) {
              this.syncSignalChannel = new BroadcastChannel(
                "uni-schedule-sync-signal-v1",
              );
            }
            if (
              this.syncSignalChannel &&
              typeof this.syncSignalChannel.postMessage === "function"
            ) {
              this.syncSignalChannel.postMessage(payload);
            }
          } catch {}
          try {
            localStorage.setItem(
              CLOUD_SYNC_SIGNAL_KEY,
              JSON.stringify(payload),
            );
            localStorage.removeItem(CLOUD_SYNC_SIGNAL_KEY);
          } catch {}
        },

        handleExternalSyncSignal(payload = null, source = "external") {
          if (!payload || typeof payload !== "object") return;
          const stamp = Number(payload.at || 0);
          if (!Number.isFinite(stamp) || stamp <= 0) return;
          if (Date.now() - stamp > 15000) return;
          if (
            String(payload.deviceId || "").trim() ===
            String(this.deviceId || "").trim()
          ) {
            return;
          }
          if (stamp <= Number(this.lastExternalSignalAt || 0)) return;
          this.lastExternalSignalAt = stamp;
          if (!this.user?.googleUserId || !this.canUseCloud()) return;
          if (!navigator.onLine) return;
          this.enterSignalBurst("peer-signal");
          this.enterUltraRealtimeWindow(
            "peer-signal",
            Math.round(CLOUD_SYNC_ULTRA_WINDOW_MS * 0.62),
          );
          this.startAutoSyncLoop(true);
          const reason = String(payload.reason || source || "signal")
            .trim()
            .slice(0, 42);
          this.scheduleSignalFollowupSync(reason);
          this.autoSyncTick(`signal-${reason}`, true).catch(() => {});
        },

        isMobileSyncContext() {
          const mode = String(app?.data?.settings?.uiMode || "").toLowerCase();
          if (mode === "mobile") return true;
          if (mode === "desktop") return false;
          try {
            if (window.matchMedia("(max-width: 1023.98px)").matches)
              return true;
          } catch {}
          return false;
        },

        getNetworkSyncProfile() {
          let netType = "";
          let saveData = false;
          let downlink = 0;
          let rtt = 0;
          try {
            const conn =
              navigator.connection ||
              navigator.mozConnection ||
              navigator.webkitConnection ||
              null;
            netType = String(conn?.effectiveType || "")
              .trim()
              .toLowerCase();
            saveData = Boolean(conn?.saveData);
            downlink = Number(conn?.downlink || 0);
            rtt = Number(conn?.rtt || 0);
          } catch {}
          const verySlow =
            saveData || netType === "slow-2g" || netType === "2g";
          const constrained =
            verySlow ||
            netType === "3g" ||
            (downlink > 0 && downlink < 1.1) ||
            (rtt > 0 && rtt > 850);
          const good =
            !saveData &&
            !constrained &&
            (netType === "" ||
              netType === "4g" ||
              netType === "5g" ||
              (downlink >= 1.8 && (rtt === 0 || rtt <= 380)));
          return {
            netType,
            saveData,
            downlink,
            rtt,
            verySlow,
            constrained,
            good,
          };
        },

        isFastSyncActive() {
          return Date.now() < Number(this.fastSyncUntil || 0);
        },

        isUltraRealtimeActive() {
          return Date.now() < Number(this.ultraSyncUntil || 0);
        },

        isSignalBurstActive() {
          return Date.now() < Number(this.signalBurstUntil || 0);
        },

        clearSignalFollowupTimers() {
          if (this.signalFollowupFastTimerId) {
            window.clearTimeout(this.signalFollowupFastTimerId);
            this.signalFollowupFastTimerId = 0;
          }
          if (this.signalFollowupMidTimerId) {
            window.clearTimeout(this.signalFollowupMidTimerId);
            this.signalFollowupMidTimerId = 0;
          }
          if (this.signalFollowupSlowTimerId) {
            window.clearTimeout(this.signalFollowupSlowTimerId);
            this.signalFollowupSlowTimerId = 0;
          }
        },

        enterSignalBurst(
          reason = "signal",
          durationMs = CLOUD_SYNC_SIGNAL_BURST_MS,
        ) {
          if (!this.user?.googleUserId || !this.canUseCloud()) return false;
          if (!navigator.onLine) return false;
          const now = Date.now();
          const ttl = Math.max(
            8000,
            Number(durationMs || CLOUD_SYNC_SIGNAL_BURST_MS),
          );
          const nextUntil = now + ttl;
          if (nextUntil > Number(this.signalBurstUntil || 0)) {
            this.signalBurstUntil = nextUntil;
          }
          this.enterFastSyncWindow(
            Math.round(CLOUD_SYNC_FAST_WINDOW_MS * 0.68),
          );
          this.scheduleLoopRecalc();
          this.startAutoSyncLoop(true);
          return true;
        },

        scheduleSignalFollowupSync(reason = "signal") {
          if (!this.user?.googleUserId || !this.canUseCloud()) return;
          if (!navigator.onLine) return;
          const reasonText = String(reason || "signal")
            .trim()
            .slice(0, 42);
          this.clearSignalFollowupTimers();
          this.signalFollowupFastTimerId = window.setTimeout(() => {
            this.signalFollowupFastTimerId = 0;
            if (!this.shouldAutoSyncRun()) return;
            this.autoSyncTick(`signal-fast-${reasonText}`, true).catch(
              () => {},
            );
          }, CLOUD_SYNC_SIGNAL_FOLLOWUP_FAST_MS);
          this.signalFollowupMidTimerId = window.setTimeout(() => {
            this.signalFollowupMidTimerId = 0;
            if (!this.shouldAutoSyncRun()) return;
            this.autoSyncTick(`signal-mid-${reasonText}`, true).catch(() => {});
          }, CLOUD_SYNC_SIGNAL_FOLLOWUP_MID_MS);
          this.signalFollowupSlowTimerId = window.setTimeout(() => {
            this.signalFollowupSlowTimerId = 0;
            if (!this.shouldAutoSyncRun()) return;
            this.autoSyncTick(`signal-slow-${reasonText}`, true).catch(
              () => {},
            );
          }, CLOUD_SYNC_SIGNAL_FOLLOWUP_SLOW_MS);
        },

        getUltraWindowMs(baseMs = CLOUD_SYNC_ULTRA_WINDOW_MS) {
          const mobile = this.isMobileSyncContext();
          const profile = this.getNetworkSyncProfile();
          let windowMs = Math.max(
            7000,
            Number(baseMs || CLOUD_SYNC_ULTRA_WINDOW_MS),
          );
          if (mobile && this.ultraMobileProfile === "battery") {
            windowMs = Math.round(windowMs * 0.72);
          } else if (mobile) {
            windowMs = Math.round(windowMs * 0.92);
          }
          if (profile.constrained) {
            windowMs = Math.round(windowMs * 0.84);
          }
          return Math.max(7000, windowMs);
        },

        getUltraIntervalMs() {
          const mobile = this.isMobileSyncContext();
          let interval = mobile
            ? CLOUD_SYNC_ULTRA_INTERVAL_MOBILE_MS
            : CLOUD_SYNC_ULTRA_INTERVAL_DESKTOP_MS;
          if (mobile && this.ultraMobileProfile === "battery") {
            interval = Math.round(interval * 1.38);
          }
          return Math.max(mobile ? 980 : 760, interval);
        },

        getUltraMinGapMs() {
          const mobile = this.isMobileSyncContext();
          let minGap = mobile
            ? CLOUD_SYNC_ULTRA_MIN_GAP_MOBILE_MS
            : CLOUD_SYNC_ULTRA_MIN_GAP_DESKTOP_MS;
          if (mobile && this.ultraMobileProfile === "battery") {
            minGap = Math.round(minGap * 1.28);
          }
          return Math.max(mobile ? 520 : 320, minGap);
        },

        canUseUltraRealtime() {
          if (!this.ultraEnabled) return false;
          if (!this.user?.googleUserId || !this.canUseCloud()) return false;
          if (!navigator.onLine || document.hidden) return false;
          if (Date.now() < Number(this.ultraCooldownUntil || 0)) return false;
          const mobile = this.isMobileSyncContext();
          const profile = this.getNetworkSyncProfile();
          if (profile.saveData || profile.verySlow) return false;
          if (mobile && this.ultraMobileProfile === "battery") {
            const weakBatteryLink =
              (profile.downlink > 0 && profile.downlink < 2.4) ||
              (profile.rtt > 0 && profile.rtt > 320);
            if (!profile.good || weakBatteryLink) return false;
          } else if (mobile && profile.constrained) {
            return false;
          }
          return true;
        },

        clearLoopRecalcTimer() {
          if (this.loopRecalcTimerId) {
            window.clearTimeout(this.loopRecalcTimerId);
            this.loopRecalcTimerId = 0;
          }
        },

        scheduleLoopRecalc() {
          this.clearLoopRecalcTimer();
          if (!this.user?.googleUserId || !this.canUseCloud()) return;
          const now = Date.now();
          const candidates = [
            Number(this.fastSyncUntil || 0),
            Number(this.ultraSyncUntil || 0),
            Number(this.signalBurstUntil || 0),
          ].filter((stamp) => stamp > now);
          if (!candidates.length) return;
          const nextAt = Math.min.apply(null, candidates);
          const waitMs = Math.max(
            220,
            Math.min(
              60000,
              nextAt -
                now +
                64 +
                Math.floor(Math.random() * CLOUD_SYNC_LOOP_RECALC_JITTER_MS),
            ),
          );
          this.loopRecalcTimerId = window.setTimeout(() => {
            this.loopRecalcTimerId = 0;
            if (!this.user?.googleUserId || !this.canUseCloud()) return;
            if (!navigator.onLine) return;
            this.startAutoSyncLoop(true);
          }, waitMs);
        },

        resetUltraRealtimeState() {
          this.ultraSyncUntil = 0;
          this.ultraSyncStartedAt = 0;
          this.ultraCooldownUntil = 0;
          this.ultraIdlePollStreak = 0;
        },

        enterUltraRealtimeWindow(
          reason = "activity",
          durationMs = CLOUD_SYNC_ULTRA_WINDOW_MS,
        ) {
          if (!this.canUseUltraRealtime()) return false;
          const now = Date.now();
          const ttl = this.getUltraWindowMs(durationMs);
          const wasActive = this.isUltraRealtimeActive();
          if (!wasActive || !this.ultraSyncStartedAt) {
            this.ultraSyncStartedAt = now;
          }
          const capAt =
            Number(this.ultraSyncStartedAt || now) +
            CLOUD_SYNC_ULTRA_MAX_CONTINUOUS_MS;
          const requestedUntil = now + ttl;
          const nextUntil = Math.min(capAt, requestedUntil);
          if (nextUntil <= now + 500) return false;
          if (nextUntil > Number(this.ultraSyncUntil || 0)) {
            this.ultraSyncUntil = nextUntil;
          }
          this.ultraIdlePollStreak = 0;
          this.scheduleLoopRecalc();
          if (
            !wasActive ||
            this.autoSyncIntervalMs > this.getAutoSyncIntervalMs()
          ) {
            this.startAutoSyncLoop(true);
          }
          return true;
        },

        clearUltraRealtimeWindow(reason = "reset") {
          const wasActive = this.isUltraRealtimeActive();
          this.ultraSyncUntil = 0;
          this.ultraSyncStartedAt = 0;
          this.ultraIdlePollStreak = 0;
          const reasonText = String(reason || "")
            .trim()
            .toLowerCase();
          if (reasonText.includes("idle") || reasonText.includes("error")) {
            this.ultraCooldownUntil =
              Date.now() + CLOUD_SYNC_ULTRA_IDLE_COOLDOWN_MS;
          } else if (Date.now() >= Number(this.ultraCooldownUntil || 0)) {
            this.ultraCooldownUntil = 0;
          }
          this.scheduleLoopRecalc();
          if (
            wasActive &&
            this.user?.googleUserId &&
            this.canUseCloud() &&
            !document.hidden
          ) {
            this.startAutoSyncLoop(true);
          }
        },

        noteUltraPollResult(changed = false) {
          if (changed) {
            this.ultraIdlePollStreak = 0;
            return;
          }
          if (!this.isUltraRealtimeActive()) return;
          this.ultraIdlePollStreak = Math.min(
            99,
            Number(this.ultraIdlePollStreak || 0) + 1,
          );
          if (this.ultraIdlePollStreak >= CLOUD_SYNC_ULTRA_IDLE_POLLS_LIMIT) {
            this.clearUltraRealtimeWindow("idle-cap");
          }
        },

        enterFastSyncWindow(durationMs = CLOUD_SYNC_FAST_WINDOW_MS) {
          if (!this.user?.googleUserId || !this.canUseCloud()) return;
          const now = Date.now();
          const ttl = Math.max(8000, Number(durationMs || 0));
          const nextUntil = now + ttl;
          if (nextUntil > Number(this.fastSyncUntil || 0)) {
            this.fastSyncUntil = nextUntil;
          }
          this.scheduleLoopRecalc();
          this.startAutoSyncLoop();
        },

        getApiTimeoutMs() {
          let timeout = CLOUD_SYNC_API_TIMEOUT_MS;
          try {
            const conn =
              navigator.connection ||
              navigator.mozConnection ||
              navigator.webkitConnection ||
              null;
            const netType = String(conn?.effectiveType || "")
              .trim()
              .toLowerCase();
            const saveData = Boolean(conn?.saveData);
            if (saveData || netType === "slow-2g" || netType === "2g") {
              timeout = CLOUD_SYNC_API_TIMEOUT_SLOW_MS;
            } else if (netType === "3g") {
              timeout = Math.max(
                CLOUD_SYNC_API_TIMEOUT_MS,
                Math.round(CLOUD_SYNC_API_TIMEOUT_MS * 1.35),
              );
            }
          } catch {}
          return Math.max(7000, timeout);
        },

        isRetryableHttpStatus(status) {
          const code = Number(status || 0);
          return (
            code === 408 ||
            code === 425 ||
            code === 429 ||
            code === 500 ||
            code === 502 ||
            code === 503 ||
            code === 504
          );
        },

        getRetryAfterMs(headers) {
          if (!headers || typeof headers.get !== "function") return 0;
          const raw = String(headers.get("Retry-After") || "").trim();
          if (!raw) return 0;
          const asNumber = Number(raw);
          if (Number.isFinite(asNumber) && asNumber > 0) {
            return Math.round(asNumber * 1000);
          }
          const asDateMs = this.parseTime(raw);
          if (asDateMs > 0) {
            return Math.max(0, asDateMs - Date.now());
          }
          return 0;
        },

        getRetryDelayMs(attempt = 1, retryAfterMs = 0) {
          const safeAttempt = Math.max(1, Number(attempt || 1));
          const exp = Math.min(5, safeAttempt - 1);
          const base = Math.round(
            CLOUD_SYNC_API_RETRY_BASE_MS * Math.pow(2, exp),
          );
          const jitter = Math.floor(
            Math.random() * CLOUD_SYNC_API_RETRY_JITTER_MS,
          );
          const candidate = base + jitter;
          if (retryAfterMs > 0) {
            return Math.max(
              candidate,
              Math.min(30000, Math.round(retryAfterMs)),
            );
          }
          return candidate;
        },

        isRetryableFetchError(err) {
          const name = String(err?.name || "")
            .trim()
            .toLowerCase();
          const msg = String(err?.message || err || "")
            .trim()
            .toLowerCase();
          if (name === "aborterror") return true;
          if (!msg) return true;
          return (
            msg.includes("network") ||
            msg.includes("fetch") ||
            msg.includes("failed to fetch") ||
            msg.includes("load failed") ||
            msg.includes("timeout") ||
            msg.includes("connection")
          );
        },

        clearRecoverySyncTimer() {
          if (this.recoveryTimerId) {
            window.clearTimeout(this.recoveryTimerId);
            this.recoveryTimerId = 0;
          }
        },

        scheduleRecoverySync(reason = "recover") {
          if (!this.user?.googleUserId || !this.canUseCloud()) return false;
          this.clearRecoverySyncTimer();
          const now = Date.now();
          const backoffLeft = Math.max(
            0,
            Number(this.syncBackoffUntil || 0) - now,
          );
          const baseDelay = backoffLeft || CLOUD_SYNC_RECOVERY_MIN_MS;
          const delay = Math.max(
            CLOUD_SYNC_RECOVERY_MIN_MS,
            Math.min(CLOUD_SYNC_RECOVERY_MAX_MS, baseDelay),
          );
          const jitter = Math.floor(Math.random() * 240);
          this.recoveryTimerId = window.setTimeout(() => {
            this.recoveryTimerId = 0;
            if (!this.user?.googleUserId || !this.canUseCloud()) return;
            if (!navigator.onLine || document.hidden) return;
            this.startAutoSyncLoop(true);
            this.autoSyncTick(`recover-${reason}`, true).catch(() => {});
          }, delay + jitter);
          return true;
        },

        clearRemoteMetaCache() {
          this.remoteMetaCacheAt = 0;
          this.remoteMetaCache = null;
        },

        setRemoteMetaCache(meta = null) {
          const src = meta && typeof meta === "object" ? meta : {};
          const fileId = String(src.fileId || "").trim();
          const modifiedMs = Number(src.modifiedMs || 0);
          this.remoteMetaCache = { fileId, modifiedMs: modifiedMs || 0 };
          this.remoteMetaCacheAt = Date.now();
          if (fileId && fileId !== this.fileId) {
            this.fileId = fileId;
            this.meta.fileId = fileId;
            this.persistMeta();
          }
          if (modifiedMs > 0) {
            this.lastRemoteModifiedAt = Math.max(
              Number(this.lastRemoteModifiedAt || 0),
              modifiedMs,
            );
          }
        },

        getRemoteMetaCache() {
          if (!this.remoteMetaCache) return null;
          const age = Date.now() - Number(this.remoteMetaCacheAt || 0);
          if (age > CLOUD_SYNC_REMOTE_META_CACHE_MS) {
            this.clearRemoteMetaCache();
            return null;
          }
          return this.remoteMetaCache;
        },

        markSyncSuccess() {
          this.syncErrorStreak = 0;
          this.syncBackoffUntil = 0;
          this.lastSyncSucceededAt = Date.now();
          this.clearRecoverySyncTimer();
        },

        getAutoSyncIntervalMs() {
          const mobile = this.isMobileSyncContext();
          const isHidden = Boolean(document.hidden);
          let interval = mobile
            ? CLOUD_SYNC_AUTO_INTERVAL_MOBILE_MS
            : CLOUD_SYNC_AUTO_INTERVAL_DESKTOP_MS;
          const profile = this.getNetworkSyncProfile();
          let networkScale = 1;
          if (profile.saveData) networkScale = Math.max(networkScale, 1.45);
          else if (profile.netType === "slow-2g" || profile.netType === "2g") {
            networkScale = Math.max(networkScale, 1.7);
          } else if (profile.netType === "3g") {
            networkScale = Math.max(networkScale, 1.28);
          } else if (!profile.good && profile.constrained) {
            networkScale = Math.max(networkScale, 1.16);
          }
          interval = Math.round(interval * networkScale);
          if (!isHidden) {
            let visibleBase = mobile
              ? CLOUD_SYNC_AUTO_VISIBLE_BASE_INTERVAL_MOBILE_MS
              : CLOUD_SYNC_AUTO_VISIBLE_BASE_INTERVAL_DESKTOP_MS;
            if (mobile && this.ultraMobileProfile === "battery") {
              visibleBase = Math.round(visibleBase * 1.16);
            }
            const visibleInterval = Math.round(
              visibleBase * Math.max(1, networkScale * 0.94),
            );
            interval = Math.min(interval, visibleInterval);
          }
          if (this.ultraEnabled && !isHidden) {
            let realtimeBase = mobile
              ? CLOUD_SYNC_REALTIME_BASE_INTERVAL_MOBILE_MS
              : CLOUD_SYNC_REALTIME_BASE_INTERVAL_DESKTOP_MS;
            if (mobile && this.ultraMobileProfile === "battery") {
              realtimeBase = Math.round(realtimeBase * 1.2);
            }
            const realtimeInterval = Math.round(
              realtimeBase * Math.max(1, networkScale * 0.92),
            );
            interval = Math.min(interval, realtimeInterval);
          }
          if (
            this.ultraEnabled &&
            this.isUltraRealtimeActive() &&
            !document.hidden
          ) {
            const ultraInterval = this.getUltraIntervalMs();
            interval = Math.min(
              interval,
              Math.round(ultraInterval * Math.max(1, networkScale * 0.95)),
            );
          }
          if (this.isFastSyncActive() && !document.hidden) {
            const fastInterval = mobile
              ? CLOUD_SYNC_FAST_INTERVAL_MOBILE_MS
              : CLOUD_SYNC_FAST_INTERVAL_DESKTOP_MS;
            interval = Math.min(
              interval,
              Math.round(fastInterval * networkScale),
            );
          }
          if (this.isSignalBurstActive() && !isHidden) {
            let burstInterval = mobile
              ? CLOUD_SYNC_SIGNAL_BURST_INTERVAL_MOBILE_MS
              : CLOUD_SYNC_SIGNAL_BURST_INTERVAL_DESKTOP_MS;
            if (mobile && this.ultraMobileProfile === "battery") {
              burstInterval = Math.round(burstInterval * 1.18);
            }
            interval = Math.min(
              interval,
              Math.round(burstInterval * Math.max(1, networkScale * 0.9)),
            );
          }
          if (isHidden) {
            interval = Math.max(
              interval,
              mobile
                ? CLOUD_SYNC_HIDDEN_INTERVAL_MOBILE_MS
                : CLOUD_SYNC_HIDDEN_INTERVAL_DESKTOP_MS,
            );
          }
          return Math.max(
            mobile ? (isHidden ? 1100 : 760) : isHidden ? 950 : 620,
            interval,
          );
        },

        getAutoSyncMinGapMs() {
          const mobile = this.isMobileSyncContext();
          const isHidden = Boolean(document.hidden);
          const isUltra = this.isUltraRealtimeActive() && !document.hidden;
          const floor = mobile
            ? CLOUD_SYNC_AUTO_MIN_GAP_MOBILE_MS
            : CLOUD_SYNC_AUTO_MIN_GAP_DESKTOP_MS;
          const intervalMs = this.getAutoSyncIntervalMs();
          if (isUltra) {
            const ultraFloor = this.getUltraMinGapMs();
            const ultraScaled = Math.floor(intervalMs * (mobile ? 0.48 : 0.44));
            return Math.max(ultraFloor, ultraScaled);
          }
          const isFast = this.isFastSyncActive() && !document.hidden;
          const scaled = Math.floor(
            intervalMs * (isFast ? 0.42 : mobile ? 0.28 : 0.24),
          );
          const floorAdjusted = isFast
            ? Math.max(480, Math.floor(floor * 0.7))
            : floor;
          let minGap = Math.max(floorAdjusted, scaled);
          if (!isHidden) {
            const visibleFloor = mobile
              ? this.ultraMobileProfile === "battery"
                ? Math.max(700, CLOUD_SYNC_AUTO_VISIBLE_MIN_GAP_MOBILE_MS)
                : CLOUD_SYNC_AUTO_VISIBLE_MIN_GAP_MOBILE_MS
              : CLOUD_SYNC_AUTO_VISIBLE_MIN_GAP_DESKTOP_MS;
            const visibleScaled = Math.floor(
              intervalMs * (mobile ? 0.36 : 0.3),
            );
            minGap = Math.min(minGap, Math.max(visibleFloor, visibleScaled));
          }
          if (this.ultraEnabled && !isHidden) {
            const realtimeFloor = mobile
              ? this.ultraMobileProfile === "battery"
                ? 680
                : 520
              : 380;
            const realtimeScaled = Math.floor(
              intervalMs *
                (mobile
                  ? this.ultraMobileProfile === "battery"
                    ? 0.52
                    : 0.4
                  : 0.34),
            );
            minGap = Math.min(minGap, Math.max(realtimeFloor, realtimeScaled));
          }
          if (this.isSignalBurstActive() && !isHidden) {
            const burstFloor = mobile
              ? this.ultraMobileProfile === "battery"
                ? 620
                : 500
              : 340;
            const burstScaled = Math.floor(intervalMs * (mobile ? 0.4 : 0.32));
            minGap = Math.min(minGap, Math.max(burstFloor, burstScaled));
          }
          if (isHidden) {
            const hiddenFloor = mobile ? 2800 : 2200;
            const hiddenScaled = Math.floor(intervalMs * 0.68);
            minGap = Math.max(minGap, Math.max(hiddenFloor, hiddenScaled));
          }
          return minGap;
        },

        shouldAutoSyncRun() {
          if (!this.canUseCloud()) return false;
          if (!this.user?.googleUserId) return false;
          if (!navigator.onLine) return false;
          if (this.syncingNow) return false;
          return true;
        },

        async autoSyncTick(reason = "auto-loop", force = false) {
          if (this.autoSyncInFlight) return false;
          if (!this.shouldAutoSyncRun()) return false;
          const now = Date.now();
          if (!force && now < Number(this.syncBackoffUntil || 0)) return false;
          const minGap = this.getAutoSyncMinGapMs();
          if (!force && now - Number(this.lastAutoSyncAt || 0) < minGap)
            return false;
          const task = (async () => {
            const token = await this.ensureAccessToken(false);
            if (!token) return false;
            this.lastAutoSyncAt = Date.now();
            try {
              if (this.hasPendingLocalChanges()) {
                const pushed = await this.reconcileRemoteAndLocal(
                  reason,
                  false,
                  {
                    quiet: true,
                  },
                );
                if (pushed) {
                  if (this.debounceTimerId) {
                    window.clearTimeout(this.debounceTimerId);
                    this.debounceTimerId = 0;
                  }
                  this.debounceDueAt = 0;
                  this.enterSignalBurst(
                    "auto-local-change",
                    Math.round(CLOUD_SYNC_SIGNAL_BURST_MS * 0.8),
                  );
                  this.enterFastSyncWindow(
                    Math.round(CLOUD_SYNC_FAST_WINDOW_MS * 0.95),
                  );
                  this.ultraCooldownUntil = 0;
                  this.enterUltraRealtimeWindow(
                    "auto-local-change",
                    Math.round(CLOUD_SYNC_ULTRA_WINDOW_MS * 1.05),
                  );
                  this.noteUltraPollResult(true);
                } else {
                  this.noteUltraPollResult(false);
                }
                this.markSyncSuccess();
                return pushed;
              }

              const hadFileId = Boolean(this.fileId || this.meta.fileId);
              const remoteMeta = await this.fetchRemoteModifiedStamp(false);
              const remoteMs = Number(remoteMeta?.modifiedMs || 0);
              if (!String(remoteMeta?.fileId || "").trim()) {
                if (hadFileId || this.parseTime(this.meta.lastUpdatedAt) > 0) {
                  const reconciled = await this.reconcileRemoteAndLocal(
                    reason,
                    false,
                    { quiet: true },
                  );
                  if (reconciled) {
                    this.ultraCooldownUntil = 0;
                    this.enterUltraRealtimeWindow(
                      "auto-reconcile-missing-remote",
                      CLOUD_SYNC_ULTRA_WINDOW_MS,
                    );
                    this.noteUltraPollResult(true);
                  } else {
                    this.noteUltraPollResult(false);
                  }
                  this.markSyncSuccess();
                  return reconciled;
                }
                this.noteUltraPollResult(false);
                this.markSyncSuccess();
                return false;
              }
              const syncedMs = this.parseTime(this.meta.lastSyncedAt);
              const knownRemoteMs = Number(this.lastRemoteModifiedAt || 0);
              const compareMs = Math.max(syncedMs, knownRemoteMs);
              if (
                !remoteMs ||
                remoteMs <= compareMs + CLOUD_SYNC_DIRTY_GUARD_MS
              ) {
                const reasonText = String(reason || "")
                  .trim()
                  .toLowerCase();
                if (
                  this.isSignalBurstActive() &&
                  !document.hidden &&
                  (reasonText.includes("signal") ||
                    reasonText.includes("auto-loop"))
                ) {
                  const nowMs = Date.now();
                  if (nowMs - Number(this.lastSignalChaseAt || 0) > 1200) {
                    this.lastSignalChaseAt = nowMs;
                    this.scheduleSignalFollowupSync("chase");
                  }
                }
                this.noteUltraPollResult(false);
                this.markSyncSuccess();
                return false;
              }

              const pulled = await this.reconcileRemoteAndLocal(reason, false, {
                quiet: true,
              });
              if (pulled) {
                this.enterSignalBurst("auto-remote-change");
                this.enterFastSyncWindow(
                  Math.round(CLOUD_SYNC_FAST_WINDOW_MS * 0.85),
                );
                this.ultraCooldownUntil = 0;
                this.enterUltraRealtimeWindow(
                  "auto-remote-change",
                  Math.round(CLOUD_SYNC_ULTRA_WINDOW_MS * 1.1),
                );
                this.noteUltraPollResult(true);
              } else {
                this.noteUltraPollResult(false);
              }
              this.markSyncSuccess();
              return pulled;
            } catch (err) {
              const msg = String(err?.message || err || "").trim();
              if (msg) {
                this.setState("error", msg);
              }
              this.syncErrorStreak = Math.min(
                6,
                Number(this.syncErrorStreak || 0) + 1,
              );
              const backoffMs = Math.min(
                CLOUD_SYNC_ERROR_BACKOFF_MAX_MS,
                Math.round(
                  CLOUD_SYNC_ERROR_BACKOFF_BASE_MS *
                    Math.pow(2, this.syncErrorStreak - 1),
                ),
              );
              this.syncBackoffUntil = Date.now() + backoffMs;
              this.clearUltraRealtimeWindow("error-backoff");
              this.scheduleRecoverySync("auto-tick");
              return false;
            }
          })();
          this.autoSyncInFlight = task;
          try {
            return await task;
          } finally {
            if (this.autoSyncInFlight === task) {
              this.autoSyncInFlight = null;
            }
          }
        },

        startAutoSyncLoop(force = false) {
          if (!this.canUseCloud() || !this.user?.googleUserId) return;
          const intervalMs = this.getAutoSyncIntervalMs();
          const hasPendingLocal = this.hasPendingLocalChanges();
          const neverSynced = this.parseTime(this.meta.lastSyncedAt) <= 0;
          if (
            !force &&
            this.autoSyncTimerId &&
            this.autoSyncIntervalMs === intervalMs
          ) {
            this.scheduleLoopRecalc();
            return;
          }
          this.stopAutoSyncLoop();
          this.autoSyncIntervalMs = intervalMs;
          this.autoSyncTimerId = window.setInterval(() => {
            this.autoSyncTick("auto-loop");
          }, intervalMs);
          const burstActive = this.isSignalBurstActive();
          const immediateDelay =
            force || hasPendingLocal || neverSynced
              ? burstActive
                ? 70
                : 140
              : Math.min(1200, Math.max(300, Math.floor(intervalMs * 0.24)));
          this.autoSyncImmediateTimerId = window.setTimeout(() => {
            this.autoSyncImmediateTimerId = 0;
            this.autoSyncTick("auto-immediate", true).catch(() => {});
          }, immediateDelay);
          this.autoSyncWarmupTimerId = window.setTimeout(
            () => {
              this.autoSyncWarmupTimerId = 0;
              this.autoSyncTick("auto-start");
            },
            burstActive
              ? Math.min(1500, Math.max(460, Math.floor(intervalMs * 0.2)))
              : Math.min(2800, Math.max(900, Math.floor(intervalMs * 0.32))),
          );
          this.scheduleLoopRecalc();
        },

        stopAutoSyncLoop() {
          this.clearLocalPushTimer();
          this.clearSignalFollowupTimers();
          if (this.autoSyncImmediateTimerId) {
            window.clearTimeout(this.autoSyncImmediateTimerId);
            this.autoSyncImmediateTimerId = 0;
          }
          if (this.autoSyncWarmupTimerId) {
            window.clearTimeout(this.autoSyncWarmupTimerId);
            this.autoSyncWarmupTimerId = 0;
          }
          if (this.autoSyncTimerId) {
            window.clearInterval(this.autoSyncTimerId);
            this.autoSyncTimerId = 0;
          }
          this.clearLoopRecalcTimer();
          this.clearRecoverySyncTimer();
          this.autoSyncIntervalMs = 0;
        },

        triggerForegroundSync(reason = "focus-sync") {
          if (
            !this.canUseCloud() ||
            !this.user?.googleUserId ||
            !navigator.onLine
          )
            return;
          if (document.hidden) return;
          this.enterFastSyncWindow(
            Math.round(CLOUD_SYNC_FAST_WINDOW_MS * 0.82),
          );
          this.ultraCooldownUntil = 0;
          this.enterUltraRealtimeWindow(
            `fg-${reason}`,
            Math.round(CLOUD_SYNC_ULTRA_WINDOW_MS * 0.74),
          );
          const now = Date.now();
          if (
            now - Number(this.lastForegroundSyncAt || 0) <
            CLOUD_SYNC_FOREGROUND_MIN_GAP_MS
          )
            return;
          this.lastForegroundSyncAt = now;
          this.autoSyncTick(reason, true).catch(() => {});
        },

        hasPendingLocalChanges() {
          const localMs = this.parseTime(this.meta.lastUpdatedAt);
          const syncedMs = this.parseTime(this.meta.lastSyncedAt);
          return localMs > syncedMs + CLOUD_SYNC_DIRTY_GUARD_MS;
        },

        getDebounceDelayMs(reason = "auto") {
          const reasonText = String(reason || "")
            .trim()
            .toLowerCase();
          const isUiQuickReason =
            reasonText.includes("ui-mode") ||
            reasonText.includes("view-mode") ||
            reasonText.includes("layout-mode");
          let delay = CLOUD_SYNC_DEBOUNCE_MS;
          if (!reasonText) {
            return this.isFastSyncActive()
              ? Math.max(260, Math.floor(delay * 0.68))
              : delay;
          }
          if (reasonText.includes("search")) {
            delay = Math.max(1200, Math.round(CLOUD_SYNC_DEBOUNCE_MS * 1.9));
          } else if (isUiQuickReason) {
            delay = CLOUD_SYNC_UI_QUICK_DEBOUNCE_MS;
          } else if (reasonText.includes("auto-week")) {
            delay = Math.max(900, Math.round(CLOUD_SYNC_DEBOUNCE_MS * 1.45));
          } else if (
            reasonText.includes("manual") ||
            reasonText.includes("pending") ||
            reasonText.includes("quick")
          ) {
            delay = Math.max(260, Math.floor(CLOUD_SYNC_DEBOUNCE_MS * 0.58));
          }
          if (this.isFastSyncActive() && !reasonText.includes("search")) {
            if (isUiQuickReason) {
              delay = Math.max(95, Math.floor(delay * 0.8));
            } else {
              delay = Math.max(240, Math.floor(delay * 0.72));
            }
          }
          if (
            this.ultraEnabled &&
            this.isUltraRealtimeActive() &&
            !reasonText.includes("search")
          ) {
            if (isUiQuickReason) {
              if (
                this.isMobileSyncContext() &&
                this.ultraMobileProfile === "battery"
              ) {
                delay = Math.max(90, Math.floor(delay * 0.92));
              } else if (this.isMobileSyncContext()) {
                delay = Math.max(80, Math.floor(delay * 0.86));
              } else {
                delay = Math.max(70, Math.floor(delay * 0.78));
              }
            } else {
              if (
                this.isMobileSyncContext() &&
                this.ultraMobileProfile === "battery"
              ) {
                delay = Math.max(240, Math.floor(delay * 0.76));
              } else {
                delay = Math.max(170, Math.floor(delay * 0.56));
              }
            }
          }
          return delay;
        },

        flushPendingSync(reason = "flush") {
          if (!this.debounceTimerId) return false;
          window.clearTimeout(this.debounceTimerId);
          this.debounceTimerId = 0;
          this.debounceDueAt = 0;
          this.reconcileRemoteAndLocal(reason, false, {
            quiet: true,
          }).catch(() => {});
          return true;
        },

        clearLocalPushTimer() {
          if (!this.localPushTimerId) return;
          window.clearTimeout(this.localPushTimerId);
          this.localPushTimerId = 0;
        },

        scheduleImmediateLocalPush(reason = "change") {
          if (!this.user?.googleUserId || !this.canUseCloud()) return;
          if (!navigator.onLine) return;
          const reasonText = String(reason || "")
            .trim()
            .toLowerCase();
          if (!reasonText || reasonText.includes("search")) return;
          this.clearLocalPushTimer();
          const uiQuickReason =
            reasonText.includes("ui-mode") ||
            reasonText.includes("view-mode") ||
            reasonText.includes("layout-mode");
          let delay = this.isMobileSyncContext()
            ? CLOUD_SYNC_LOCAL_PUSH_DELAY_MOBILE_MS
            : CLOUD_SYNC_LOCAL_PUSH_DELAY_DESKTOP_MS;
          if (uiQuickReason) {
            delay = this.isMobileSyncContext()
              ? CLOUD_SYNC_UI_LOCAL_PUSH_DELAY_MOBILE_MS
              : CLOUD_SYNC_UI_LOCAL_PUSH_DELAY_DESKTOP_MS;
          }
          if (
            this.isMobileSyncContext() &&
            this.ultraMobileProfile === "battery"
          ) {
            delay = Math.round(delay * (uiQuickReason ? 1.18 : 1.45));
          }
          if (reasonText.includes("auto-week")) {
            delay = Math.max(delay, 180);
          }
          this.localPushTimerId = window.setTimeout(() => {
            this.localPushTimerId = 0;
            if (!this.hasPendingLocalChanges()) return;
            this.autoSyncTick(`local-push-${reasonText}`, true).catch(() => {});
          }, delay);
        },

        parseTime(value) {
          const stamp = new Date(String(value || "")).getTime();
          return Number.isFinite(stamp) ? stamp : 0;
        },

        formatTime(value) {
          const stamp = this.parseTime(value);
          if (!stamp) return STR.syncNever;
          return new Date(stamp).toLocaleString("fa-IR", {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
          });
        },

        maskClientId(value) {
          const id = String(value || "").trim();
          if (!id) return "-";
          if (id.length <= 20) return id;
          return `${id.slice(0, 10)}...${id.slice(-16)}`;
        },

        isSecureOrigin() {
          const protocol = String(location.protocol || "").toLowerCase();
          const host = String(location.hostname || "").toLowerCase();
          return (
            protocol === "https:" ||
            host === "localhost" ||
            host === "127.0.0.1"
          );
        },

        buildSyncGuideModel() {
          const signedIn = Boolean(this.user?.googleUserId);
          const hasClient = this.canUseCloud();
          const activeClientId = this.getClientId();
          const activeClientIdMasked = this.maskClientId(activeClientId);
          const activeClientSource = this.clientIdCustom
            ? "local-storage"
            : "window/default";
          const online = navigator.onLine;
          const secure = this.isSecureOrigin();
          const hasFile = Boolean(this.meta.fileId);
          const stateDetail = String(this.stateDetail || "").trim();
          const detailLower = stateDetail.toLowerCase();
          const connection =
            navigator.connection ||
            navigator.mozConnection ||
            navigator.webkitConnection ||
            null;
          const networkType = String(connection?.effectiveType || "-").trim();
          const networkRtt = Number(connection?.rtt || 0);
          const networkDownlink = Number(connection?.downlink || 0);
          const saveData = Boolean(connection?.saveData);
          const syncStamp = this.parseTime(this.meta.lastSyncedAt);
          const nowStamp = Date.now();
          const syncAgeMin =
            syncStamp > 0 && nowStamp > syncStamp
              ? Math.floor((nowStamp - syncStamp) / 60000)
              : 0;
          const httpCodeMatch = detailLower.match(/http-(\d{3})/);
          const httpCode = httpCodeMatch ? Number(httpCodeMatch[1]) : 0;
          const origin = String(
            location.origin || `${location.protocol}//${location.host}`,
          ).trim();
          const cacheBytes = (() => {
            try {
              const cached = localStorage.getItem(STORAGE_KEY) || "";
              return new Blob([cached]).size;
            } catch {
              return 0;
            }
          })();
          const cacheKb = Math.max(1, Math.round(cacheBytes / 1024));
          const setupSteps = [
            " Google Cloud Console       Billing   /    API .",
            "  APIs & Services > Enabled APIs and services  Google Drive API  Enable .",
            "  APIs & Services > OAuth consent screen  External     App name / Support email / Developer email   .",
            " OAuth consent    Testing         Test users  .",
            "  Data Access Scope openid  email  profile  drive.appdata    (drive.appdata  appDataFolder  ).",
            "  Branding/Audience  Publishing         Publish .",
            "  APIs & Services > Credentials  OAuth Client   Web application .",
            ` Authorized JavaScript origins  Origin     ( ${origin || "https://<username>.github.io"}).`,
            " GitHub Pages         Origin    .",
            "   Token Popup Redirect URI     Origin  .",
            "   Cloud Sync  Client ID    Google OAuth Client ID      Client ID .",
            "       window.__GOOGLE_CLIENT_ID__       ().",
            signedIn
              ? "       appDataFolder / ."
              : "        Drive   .",
          ];
          const troubleshoot = [];
          const seenTroubles = new Set();
          const addTrouble = (level, title, action, signal = "") => {
            const lv = ["ok", "warn", "error"].includes(level) ? level : "warn";
            const normalizedTitle = String(title || "").trim();
            const normalizedAction = String(action || "").trim();
            if (!normalizedTitle || !normalizedAction) return;
            const key = `${lv}|${normalizedTitle}|${normalizedAction}`;
            if (seenTroubles.has(key)) return;
            seenTroubles.add(key);
            troubleshoot.push({
              level: lv,
              title: normalizedTitle,
              action: normalizedAction,
              signal: String(signal || "").trim(),
            });
          };

          if (!online) {
            addTrouble(
              "error",
              "   .",
              "            .",
              "navigator.onLine = false",
            );
          }
          if (!secure) {
            addTrouble(
              "error",
              "      .",
              " Google Sign-In  URL  HTTPS  localhost .",
              `origin=${origin || "-"}`,
            );
          }
          if (!hasClient) {
            addTrouble(
              "error",
              "Google Client ID     .",
              "Client ID    Cloud Sync        .apps.googleusercontent.com  .",
            );
          }
          if (saveData) {
            addTrouble(
              "warn",
              "    (Data Saver)  .",
              "   time-out  Sync Data Saver    .",
              "network.saveData = true",
            );
          }
          if (/slow-2g|2g/.test(networkType)) {
            addTrouble(
              "warn",
              "     .",
              "   Sync        .",
              `effectiveType=${networkType}`,
            );
          }
          if (!signedIn && hasClient && online && secure) {
            addTrouble(
              "warn",
              "  Google  .",
              "   Google         Sync   .",
            );
          }
          if (detailLower.includes("google-client-not-ready")) {
            addTrouble(
              "error",
              "SDK     .",
              " Hard Refresh      `https://accounts.google.com/gsi/client`   .",
              stateDetail,
            );
          }
          if (
            detailLower.includes("popup_closed") ||
            detailLower.includes("popup_closed_by_user")
          ) {
            addTrouble(
              "warn",
              "  Google  .",
              "      Popup     .",
              stateDetail,
            );
          }
          if (
            detailLower.includes("popup_failed_to_open") ||
            detailLower.includes("popup_blocked")
          ) {
            addTrouble(
              "error",
              " Popup     .",
              "Popup blocker         Login .",
              stateDetail,
            );
          }
          if (detailLower.includes("auth-required")) {
            addTrouble(
              "warn",
              "     .",
              "         Sync   .",
              stateDetail,
            );
          }
          if (
            detailLower.includes("access_denied") ||
            detailLower.includes("consent")
          ) {
            addTrouble(
              "warn",
              "      .",
              "    permission   Allow .",
              stateDetail,
            );
          }
          if (
            detailLower.includes("origin_mismatch") ||
            detailLower.includes("invalid_origin")
          ) {
            addTrouble(
              "error",
              "Origin   OAuth  .",
              " Origin    Authorized JavaScript origins  .",
              `origin=${origin || "-"}`,
            );
          }
          if (detailLower.includes("invalid_client")) {
            addTrouble(
              "error",
              "OAuth Client  .",
              " Client ID  Web application         Cloud Sync  .",
              stateDetail,
            );
          }
          if (detailLower.includes("idpiframe_initialization_failed")) {
            addTrouble(
              "error",
              "    Identity Provider   .",
              " Private/Incognito   Third-party cookies   .",
              stateDetail,
            );
          }
          if (httpCode === 401) {
            addTrouble(
              "error",
              " 401  Google API  .",
              "   /     Sync   .",
              stateDetail,
            );
          }
          if (httpCode === 403) {
            addTrouble(
              "error",
              " 403   ( ).",
              "OAuth consent Scope  Authorized origins    .",
              stateDetail,
            );
          }
          if (httpCode === 404) {
            addTrouble(
              "warn",
              " Sync   appDataFolder  .",
              "        .",
              stateDetail,
            );
          }
          if (httpCode === 429) {
            addTrouble(
              "warn",
              "     (Rate Limit).",
              "        Sync .",
              stateDetail,
            );
          }
          if (httpCode >= 500 && httpCode < 600) {
            addTrouble(
              "warn",
              "    Google   .",
              "         .",
              stateDetail,
            );
          }
          if (this.state === "syncing" && detailLower.includes("queued")) {
            addTrouble(
              "warn",
              "Sync    .",
              `  debounce ${CLOUD_SYNC_DEBOUNCE_MS}ms       Sync  .`,
            );
          }
          if (signedIn && online && secure && hasClient && !hasFile) {
            addTrouble(
              "warn",
              "   Sync  Drive  .",
              " Sync   JSON   appDataFolder .",
            );
          }
          if (this.state === "synced" && signedIn && hasFile) {
            addTrouble(
              "ok",
              " Cloud  .",
              "          Sync .",
            );
          }
          if (!troubleshoot.length) {
            addTrouble(
              "ok",
              "  Sync  .",
              "          Sync   .",
            );
          }

          const checks = [
            {
              level: online ? "ok" : "error",
              text: `: ${online ? "" : ""}`,
            },
            {
              level: secure ? "ok" : "warn",
              text: ` : ${secure ? " (HTTPS/Localhost)" : " (HTTPS  )"}`,
            },
            {
              level: hasClient ? "ok" : "warn",
              text: `Google Client ID: ${hasClient ? " " : " "}`,
            },
            {
              level: signedIn ? "ok" : "warn",
              text: ` Google: ${
                signedIn
                  ? this.user?.email || this.user?.googleUserId || ""
                  : " "
              }`,
            },
            {
              level: hasFile ? "ok" : "warn",
              text: ` appDataFolder: ${
                hasFile
                  ? " "
                  : "   Sync  "
              }`,
            },
            {
              level: this.autoSyncTimerId ? "ok" : "warn",
              text: `Auto Sync: ${
                this.autoSyncTimerId
                  ? ` ( ${Math.round((this.autoSyncIntervalMs || this.getAutoSyncIntervalMs()) / 1000)} )`
                  : ""
              }`,
            },
            {
              level: cacheKb <= 850 ? "ok" : "warn",
              text: `  : ${cacheKb}KB`,
            },
            {
              level:
                /slow-2g|2g/.test(networkType) || networkRtt >= 700
                  ? "warn"
                  : "ok",
              text: ` : ${networkType}${networkRtt ? ` | RTT ${networkRtt}ms` : ""}${networkDownlink ? ` | DL ${networkDownlink}Mb/s` : ""}`,
            },
            {
              level: this.parseTime(this.meta.lastSyncedAt) ? "ok" : "warn",
              text: ` : ${this.formatTime(this.meta.lastSyncedAt)}${syncAgeMin ? ` | ${syncAgeMin}  ` : ""}`,
            },
            {
              level:
                this.state === "synced"
                  ? "ok"
                  : this.state === "error"
                    ? "error"
                    : "warn",
              text: ` : ${this.getStateText(this.state)}`,
            },
          ];
          const scoreMap = {
            ok: 1,
            warn: 0.5,
            error: 0,
          };
          const healthScore = Math.round(
            (checks.reduce((sum, item) => {
              const lv = String(item?.level || "warn");
              return sum + (scoreMap[lv] ?? 0.5);
            }, 0) /
              Math.max(1, checks.length)) *
              100,
          );
          const recentEvents = Array.isArray(this.recentSyncEvents)
            ? this.recentSyncEvents.slice(0, 5)
            : [];
          const recentEventsText = recentEvents.length
            ? recentEvents
                .map(
                  (ev) =>
                    `${String(ev?.at || "-")} | ${String(ev?.state || "-")} | ${String(ev?.detail || "-")}`,
                )
                .join(" || ")
            : "-";
          const readyForSync = secure && online && hasClient && signedIn;
          const diagLines = [
            `State: ${this.state}`,
            `StateText: ${this.getStateText(this.state)}`,
            `StateDetail: ${stateDetail || "-"}`,
            `Online: ${online ? "yes" : "no"}`,
            `SecureOrigin: ${secure ? "yes" : "no"}`,
            `Origin: ${origin || "-"}`,
            `HasClientId: ${hasClient ? "yes" : "no"}`,
            `ClientIdSource: ${activeClientSource}`,
            `ClientIdMasked: ${hasClient ? activeClientIdMasked : "-"}`,
            `SignedIn: ${signedIn ? "yes" : "no"}`,
            `GoogleUserId: ${this.user?.googleUserId || "-"}`,
            `GoogleEmail: ${this.user?.email || "-"}`,
            `TokenCached: ${this.accessToken && Date.now() < Number(this.accessTokenExpireAt || 0) ? "yes" : "no"}`,
            `TokenExpireAt: ${this.accessTokenExpireAt || "-"}`,
            `FileId: ${this.meta.fileId || "-"}`,
            `LastUpdatedAt(local): ${this.meta.lastUpdatedAt || "-"}`,
            `LastSyncedAt(meta): ${this.meta.lastSyncedAt || "-"}`,
            `SyncAgeMinutes: ${syncAgeMin || 0}`,
            `HealthScore: ${healthScore}/100`,
            `NetworkType: ${networkType || "-"}`,
            `NetworkRTT: ${networkRtt || "-"}`,
            `NetworkDownlinkMb: ${networkDownlink || "-"}`,
            `SaveData: ${saveData ? "on" : "off"}`,
            `LocalCacheKB: ${cacheKb}`,
            `DebounceMs: ${CLOUD_SYNC_DEBOUNCE_MS}`,
            `AutoSyncIntervalMs: ${this.autoSyncIntervalMs || this.getAutoSyncIntervalMs()}`,
            `AutoSyncMinGapMs: ${this.getAutoSyncMinGapMs()}`,
            `AutoSyncLoop: ${this.autoSyncTimerId ? "running" : "stopped"}`,
            `FastSyncActive: ${this.isFastSyncActive() ? "yes" : "no"}`,
            `FastSyncUntil: ${this.fastSyncUntil || 0}`,
            `UltraEnabled: ${this.ultraEnabled ? "yes" : "no"}`,
            `UltraMobileProfile: ${this.ultraMobileProfile || "balanced"}`,
            `UltraSyncActive: ${this.isUltraRealtimeActive() ? "yes" : "no"}`,
            `UltraSyncUntil: ${this.ultraSyncUntil || 0}`,
            `UltraCooldownMsLeft: ${Math.max(0, Number(this.ultraCooldownUntil || 0) - Date.now())}`,
            `UltraIdlePollStreak: ${this.ultraIdlePollStreak || 0}`,
            `SyncErrorStreak: ${this.syncErrorStreak || 0}`,
            `SyncBackoffMsLeft: ${Math.max(0, Number(this.syncBackoffUntil || 0) - Date.now())}`,
            `RecoveryTimer: ${this.recoveryTimerId ? "scheduled" : "idle"}`,
            `RemoteMetaCache: ${this.remoteMetaCache ? "warm" : "cold"}`,
            `LastSyncSucceededAt: ${this.lastSyncSucceededAt || 0}`,
            `LocalDirty: ${this.hasPendingLocalChanges() ? "yes" : "no"}`,
            `LastWriteWins: enabled`,
            `RecentEvents: ${recentEventsText}`,
          ];

          return {
            setupSteps,
            troubleshoot,
            checks,
            diagLines,
            readyForSync,
            healthScore,
          };
        },

        buildSyncDiagnosticText(model = null) {
          const m = model || this.buildSyncGuideModel();
          const checkLines = (m.checks || []).map(
            (item) =>
              `- [${String(item?.level || "warn").toUpperCase()}] ${String(
                item?.text || "",
              )}`,
          );
          const troubleshootLines = (m.troubleshoot || []).map((item, idx) => {
            if (item && typeof item === "object") {
              const level = String(item.level || "warn").toUpperCase();
              const title = String(item.title || "");
              const action = String(item.action || "");
              const signal = String(item.signal || "");
              return `${idx + 1}. [${level}] ${title} -> ${action}${signal ? ` | signal: ${signal}` : ""}`;
            }
            return `${idx + 1}. ${String(item || "")}`;
          });
          return [
            "[Cloud Sync Diagnostic]",
            ...(Array.isArray(m.diagLines) ? m.diagLines : []),
            "",
            "[Checks]",
            ...checkLines,
            "",
            "[Troubleshoot]",
            ...troubleshootLines,
          ].join("\n");
        },

        async copySyncDiagnostic() {
          const btn = document.getElementById("btnSyncCopyDiag");
          const setLabel = (v) => {
            if (btn) btn.innerText = v;
          };
          const model = this.buildSyncGuideModel();
          const text = this.buildSyncDiagnosticText(model);
          try {
            if (
              navigator.clipboard &&
              typeof navigator.clipboard.writeText === "function"
            ) {
              await navigator.clipboard.writeText(text);
              setLabel(STR.syncGuideCopied);
            } else {
              throw new Error("clipboard-unavailable");
            }
          } catch {
            try {
              window.prompt("Cloud Sync Diagnostic", text);
            } catch {}
            setLabel(STR.syncGuideCopyFailed);
          } finally {
            window.setTimeout(() => setLabel(STR.syncGuideCopy), 1800);
          }
        },

        buildSnapshot(reason = "auto") {
          return {
            schemaVersion: CLOUD_SYNC_SCHEMA_VERSION,
            fileVersion: 1,
            source: {
              reason: String(reason || "auto"),
              deviceId: this.deviceId,
              googleUserId: String(this.user?.googleUserId || ""),
            },
            lastUpdatedAt: new Date().toISOString(),
            data: app.buildTermStorePayload(),
          };
        },

        async apiFetch(url, options = {}, interactive = false, retry = true) {
          const opts = options && typeof options === "object" ? options : {};
          const method = String(opts.method || "GET")
            .trim()
            .toUpperCase();
          const allowRetry =
            Boolean(retry) && method !== "POST" && method !== "DELETE";
          const maxRetries = allowRetry ? CLOUD_SYNC_API_RETRY_MAX : 0;
          let attempt = 0;

          while (true) {
            const token = await this.ensureAccessToken(
              interactive && attempt === 0,
            );
            if (!token) throw new Error("auth-required");

            const headers = new Headers(opts.headers || {});
            headers.set("Authorization", `Bearer ${token}`);
            if (opts.body && !headers.has("Content-Type")) {
              headers.set("Content-Type", "application/json; charset=UTF-8");
            }

            const timeoutMs = this.getApiTimeoutMs();
            const canAbort = typeof AbortController === "function";
            const controller = canAbort ? new AbortController() : null;
            let timeoutId = 0;
            if (controller) {
              timeoutId = window.setTimeout(() => {
                try {
                  controller.abort();
                } catch {}
              }, timeoutMs);
            }

            try {
              const resp = await fetch(url, {
                ...opts,
                headers,
                ...(controller ? { signal: controller.signal } : {}),
              });
              if (timeoutId) {
                window.clearTimeout(timeoutId);
                timeoutId = 0;
              }

              if (resp.status === 401 && attempt < Math.max(1, maxRetries)) {
                this.accessToken = "";
                this.accessTokenExpireAt = 0;
                this.clearTokenCache();
                attempt += 1;
                await new Promise((resolve) =>
                  window.setTimeout(resolve, this.getRetryDelayMs(attempt)),
                );
                continue;
              }

              if (!resp.ok) {
                const status = Number(resp.status || 0);
                const retryAfterMs = this.getRetryAfterMs(resp.headers);
                if (
                  allowRetry &&
                  attempt < maxRetries &&
                  this.isRetryableHttpStatus(status)
                ) {
                  attempt += 1;
                  await new Promise((resolve) =>
                    window.setTimeout(
                      resolve,
                      this.getRetryDelayMs(attempt, retryAfterMs),
                    ),
                  );
                  continue;
                }
                const errBody = await resp.text();
                throw new Error(
                  `http-${resp.status}: ${String(errBody || "").slice(0, 200)}`,
                );
              }
              return resp;
            } catch (err) {
              if (timeoutId) {
                window.clearTimeout(timeoutId);
                timeoutId = 0;
              }
              const isAbort =
                String(err?.name || "")
                  .trim()
                  .toLowerCase() === "aborterror";
              if (
                allowRetry &&
                attempt < maxRetries &&
                (isAbort || this.isRetryableFetchError(err))
              ) {
                attempt += 1;
                await new Promise((resolve) =>
                  window.setTimeout(resolve, this.getRetryDelayMs(attempt)),
                );
                continue;
              }
              if (isAbort) {
                throw new Error(`timeout-${timeoutMs}`);
              }
              throw err instanceof Error
                ? err
                : new Error(String(err || "network-error"));
            }
          }
        },

        async listDriveFile(interactive = false) {
          const query = encodeURIComponent(
            `name='${CLOUD_SYNC_FILE_NAME}' and 'appDataFolder' in parents and trashed=false`,
          );
          const url =
            "https://www.googleapis.com/drive/v3/files" +
            `?spaces=appDataFolder&pageSize=1&fields=files(id,name,modifiedTime)&q=${query}`;
          const resp = await this.apiFetch(url, { method: "GET" }, interactive);
          const data = await resp.json();
          const files = Array.isArray(data?.files) ? data.files : [];
          return files[0] || null;
        },

        async fetchRemoteModifiedStamp(interactive = false) {
          if (!interactive) {
            const cached = this.getRemoteMetaCache();
            if (cached) return cached;
          }
          let activeFileId = String(
            this.fileId || this.meta.fileId || "",
          ).trim();
          if (!activeFileId) {
            const listed = await this.listDriveFile(interactive);
            if (!listed?.id) {
              this.lastRemoteModifiedAt = 0;
              this.setRemoteMetaCache({ fileId: "", modifiedMs: 0 });
              return { fileId: "", modifiedMs: 0 };
            }
            activeFileId = String(listed.id || "").trim();
            if (!activeFileId) {
              this.lastRemoteModifiedAt = 0;
              this.setRemoteMetaCache({ fileId: "", modifiedMs: 0 });
              return { fileId: "", modifiedMs: 0 };
            }
            this.fileId = activeFileId;
            this.meta.fileId = activeFileId;
            this.persistMeta();
            const listedMs = this.parseTime(listed.modifiedTime);
            this.lastRemoteModifiedAt = listedMs || 0;
            const meta = { fileId: activeFileId, modifiedMs: listedMs };
            this.setRemoteMetaCache(meta);
            return meta;
          }

          const url = `https://www.googleapis.com/drive/v3/files/${encodeURIComponent(
            activeFileId,
          )}?fields=id,modifiedTime`;
          try {
            const resp = await this.apiFetch(
              url,
              { method: "GET" },
              interactive,
            );
            const payload = await resp.json();
            const resolvedFileId = String(
              payload?.id || activeFileId || "",
            ).trim();
            const modifiedMs = this.parseTime(payload?.modifiedTime);
            if (resolvedFileId && resolvedFileId !== this.fileId) {
              this.fileId = resolvedFileId;
              this.meta.fileId = resolvedFileId;
              this.persistMeta();
            }
            this.lastRemoteModifiedAt =
              modifiedMs || this.lastRemoteModifiedAt || 0;
            const meta = {
              fileId: resolvedFileId || activeFileId,
              modifiedMs: modifiedMs || 0,
            };
            this.setRemoteMetaCache(meta);
            return meta;
          } catch (err) {
            const msg = String(err?.message || "").toLowerCase();
            if (msg.includes("http-404")) {
              this.fileId = "";
              this.meta.fileId = "";
              this.persistMeta();
              this.lastRemoteModifiedAt = 0;
              this.clearRemoteMetaCache();
              return { fileId: "", modifiedMs: 0 };
            }
            throw err;
          }
        },

        async readDriveFile(fileId, interactive = false) {
          const url = `https://www.googleapis.com/drive/v3/files/${encodeURIComponent(
            fileId,
          )}?alt=media`;
          const resp = await this.apiFetch(url, { method: "GET" }, interactive);
          return await resp.json();
        },

        async fetchRemoteSnapshot(interactive = false) {
          let activeFileId = this.fileId || this.meta.fileId || "";
          if (activeFileId) {
            try {
              const payload = await this.readDriveFile(
                activeFileId,
                interactive,
              );
              return { fileId: activeFileId, payload };
            } catch (err) {
              if (!String(err?.message || "").includes("http-404")) {
                throw err;
              }
              activeFileId = "";
              this.fileId = "";
              this.meta.fileId = "";
              this.persistMeta();
              this.clearRemoteMetaCache();
            }
          }

          const listed = await this.listDriveFile(interactive);
          if (!listed?.id) return { fileId: "", payload: null };
          const payload = await this.readDriveFile(listed.id, interactive);
          this.fileId = String(listed.id || "");
          this.meta.fileId = this.fileId;
          this.persistMeta();
          return { fileId: this.fileId, payload };
        },

        createMultipartBody(metadata, jsonText, boundary) {
          return (
            `--${boundary}\r\n` +
            "Content-Type: application/json; charset=UTF-8\r\n\r\n" +
            `${JSON.stringify(metadata)}\r\n` +
            `--${boundary}\r\n` +
            "Content-Type: application/json; charset=UTF-8\r\n\r\n" +
            `${jsonText}\r\n` +
            `--${boundary}--`
          );
        },

        async writeSnapshot(reason = "auto", interactive = false) {
          const snapshot = this.buildSnapshot(reason);
          const payload = JSON.stringify(snapshot);
          let fileId = this.fileId || this.meta.fileId || "";
          if (!fileId) {
            const existing = await this.listDriveFile(interactive);
            fileId = String(existing?.id || "");
          }

          let responseData = null;
          if (fileId) {
            const patchUrl = `https://www.googleapis.com/upload/drive/v3/files/${encodeURIComponent(
              fileId,
            )}?uploadType=media&fields=id,modifiedTime`;
            const resp = await this.apiFetch(
              patchUrl,
              {
                method: "PATCH",
                body: payload,
                headers: {
                  "Content-Type": "application/json; charset=UTF-8",
                },
              },
              interactive,
            );
            responseData = await resp.json();
          } else {
            const boundary = `uni-sync-${Date.now().toString(16)}`;
            const meta = {
              name: CLOUD_SYNC_FILE_NAME,
              parents: ["appDataFolder"],
            };
            const createUrl =
              "https://www.googleapis.com/upload/drive/v3/files" +
              "?uploadType=multipart&fields=id,modifiedTime";
            const resp = await this.apiFetch(
              createUrl,
              {
                method: "POST",
                headers: {
                  "Content-Type": `multipart/related; boundary=${boundary}`,
                },
                body: this.createMultipartBody(meta, payload, boundary),
              },
              interactive,
            );
            responseData = await resp.json();
          }

          const nextFileId = String(responseData?.id || fileId || "").trim();
          this.fileId = nextFileId;
          this.meta.fileId = nextFileId;
          this.meta.googleUserId = String(this.user?.googleUserId || "").trim();
          this.meta.lastUpdatedAt = snapshot.lastUpdatedAt;
          this.meta.lastSyncedAt =
            String(
              responseData?.modifiedTime || snapshot.lastUpdatedAt,
            ).trim() || snapshot.lastUpdatedAt;
          this.persistMeta();
          this.lastRemoteModifiedAt = this.parseTime(this.meta.lastSyncedAt);
          this.setRemoteMetaCache({
            fileId: this.fileId || this.meta.fileId || "",
            modifiedMs: this.lastRemoteModifiedAt || 0,
          });
        },

        async applyRemoteSnapshot(snapshot) {
          const src = snapshot && typeof snapshot === "object" ? snapshot : {};
          if (!src.data || typeof src.data !== "object") return;

          this.suppressLocalChange = true;
          try {
            const incoming = src.data;
            const hasTermStore =
              incoming.terms &&
              typeof incoming.terms === "object" &&
              !Array.isArray(incoming.terms);
            if (hasTermStore) {
              app.loadTermStore(incoming);
              app.applyExternalData(app.data, { skipPersist: false });
            } else {
              app.applyExternalData(incoming, { skipPersist: false });
            }
          } finally {
            this.suppressLocalChange = false;
          }

          const stamp = String(src.lastUpdatedAt || "").trim();
          if (stamp) this.meta.lastUpdatedAt = stamp;
          this.meta.lastSyncedAt = stamp || new Date().toISOString();
          this.persistMeta();
          this.lastRemoteModifiedAt = this.parseTime(this.meta.lastSyncedAt);
          this.setRemoteMetaCache({
            fileId: this.fileId || this.meta.fileId || "",
            modifiedMs: this.lastRemoteModifiedAt || 0,
          });
        },

        async reconcileRemoteAndLocal(
          reason = "auto",
          interactive = false,
          opts = {},
        ) {
          const quiet = Boolean(opts && opts.quiet);
          if (this.syncingNow) {
            this.pendingSyncAfterCurrent = true;
            return false;
          }
          if (!navigator.onLine) {
            this.setState("offline", "offline");
            return false;
          }
          if (!this.user?.googleUserId) {
            this.setState("offline", "guest");
            this.stopAutoSyncLoop();
            return false;
          }

          this.syncingNow = true;
          if (!quiet) {
            this.setState("syncing", reason);
          }
          try {
            const localMs = this.parseTime(this.meta.lastUpdatedAt);
            const syncedMs = this.parseTime(this.meta.lastSyncedAt);
            const localDirty = localMs > syncedMs + CLOUD_SYNC_DIRTY_GUARD_MS;
            if (localDirty) {
              const remoteMeta =
                await this.fetchRemoteModifiedStamp(interactive);
              const remoteFileId = String(remoteMeta?.fileId || "").trim();
              const remoteMs = Number(remoteMeta?.modifiedMs || 0);
              if (!remoteFileId) {
                await this.writeSnapshot(`create-${reason}`, interactive);
                this.markSyncSuccess();
                this.enterFastSyncWindow(CLOUD_SYNC_FAST_WINDOW_MS);
                this.setState("synced", "created");
                return true;
              }
              if (
                !remoteMs ||
                remoteMs <= syncedMs + CLOUD_SYNC_DIRTY_GUARD_MS
              ) {
                await this.writeSnapshot(`push-${reason}`, interactive);
                this.markSyncSuccess();
                this.enterFastSyncWindow(
                  Math.round(CLOUD_SYNC_FAST_WINDOW_MS * 0.92),
                );
                this.setState("synced", "pushed");
                return true;
              }
            }

            const remote = await this.fetchRemoteSnapshot(interactive);
            const remotePayload = remote?.payload || null;

            if (!remotePayload) {
              await this.writeSnapshot(`create-${reason}`, interactive);
              this.markSyncSuccess();
              this.enterFastSyncWindow(CLOUD_SYNC_FAST_WINDOW_MS);
              this.setState("synced", "created");
              return true;
            }

            const remoteMs = this.parseTime(remotePayload.lastUpdatedAt);

            if ((!remoteMs && !localMs) || remoteMs > localMs) {
              await this.applyRemoteSnapshot(remotePayload);
              this.meta.fileId = String(
                remote.fileId || this.meta.fileId || "",
              );
              this.fileId = this.meta.fileId;
              this.persistMeta();
              this.markSyncSuccess();
              this.enterFastSyncWindow(
                Math.round(CLOUD_SYNC_FAST_WINDOW_MS * 0.8),
              );
              this.setState("synced", "pulled");
              return true;
            }

            if (localMs > remoteMs) {
              await this.writeSnapshot(`push-${reason}`, interactive);
              this.markSyncSuccess();
              this.enterFastSyncWindow(
                Math.round(CLOUD_SYNC_FAST_WINDOW_MS * 0.92),
              );
              this.setState("synced", "pushed");
              return true;
            }

            this.meta.fileId = String(remote.fileId || this.meta.fileId || "");
            this.fileId = this.meta.fileId;
            const matchedStamp =
              String(remotePayload.lastUpdatedAt || "").trim() ||
              new Date().toISOString();
            this.meta.lastSyncedAt = matchedStamp;
            this.lastRemoteModifiedAt = Math.max(
              Number(this.lastRemoteModifiedAt || 0),
              this.parseTime(matchedStamp),
            );
            this.persistMeta();
            this.markSyncSuccess();
            this.setState("synced", "matched");
            return true;
          } catch (err) {
            console.error("cloud reconcile failed:", err);
            const msg = String(err?.message || err || "").trim();
            this.syncErrorStreak = Math.min(
              6,
              Number(this.syncErrorStreak || 0) + 1,
            );
            const backoffMs = Math.min(
              CLOUD_SYNC_ERROR_BACKOFF_MAX_MS,
              Math.round(
                CLOUD_SYNC_ERROR_BACKOFF_BASE_MS *
                  Math.pow(2, this.syncErrorStreak - 1),
              ),
            );
            this.syncBackoffUntil = Date.now() + backoffMs;
            this.clearUltraRealtimeWindow("error-reconcile");
            this.scheduleRecoverySync(`reconcile-${reason}`);
            this.setState("error", msg);
            return false;
          } finally {
            this.syncingNow = false;
            if (this.pendingSyncAfterCurrent) {
              this.pendingSyncAfterCurrent = false;
              this.scheduleSync("pending");
            }
          }
        },

        onLocalStateChanged(reason = "change") {
          if (this.suppressLocalChange) return;
          const reasonText = String(reason || "")
            .trim()
            .toLowerCase();
          const uiModeReason =
            reasonText.includes("ui-mode") ||
            reasonText.includes("view-mode") ||
            reasonText.includes("layout-mode");
          this.meta.lastUpdatedAt = new Date().toISOString();
          this.persistMeta();
          this.refreshSyncModalUi();

          if (!this.user?.googleUserId) {
            this.setState("offline", "guest");
            return;
          }
          this.clearRecoverySyncTimer();
          this.enterFastSyncWindow(CLOUD_SYNC_FAST_WINDOW_MS);
          this.ultraCooldownUntil = 0;
          this.enterUltraRealtimeWindow(
            `local-${reason}`,
            Math.round(CLOUD_SYNC_ULTRA_WINDOW_MS * 1.12),
          );
          this.enterSignalBurst(
            `local-${reason}`,
            Math.round(CLOUD_SYNC_SIGNAL_BURST_MS * 0.7),
          );
          this.lastAutoSyncAt = 0;
          this.scheduleSync(reasonText || reason);
          if (!reasonText.includes("search")) {
            this.scheduleImmediateLocalPush(reasonText || reason);
            this.emitSyncSignal(reasonText || reason);
          }
          if (uiModeReason) {
            this.autoSyncTick(`quick-${reasonText || "ui-mode"}`, true).catch(
              () => {},
            );
          }
        },

        scheduleSync(reason = "auto") {
          if (!navigator.onLine) {
            this.setState("offline", "offline");
            return;
          }
          const reasonText = String(reason || "")
            .trim()
            .toLowerCase();
          const requestedDelay = this.getDebounceDelayMs(reasonText || reason);
          const now = Date.now();
          let debounceMs = requestedDelay;
          const hadTimer = Boolean(this.debounceTimerId);
          if (hadTimer) {
            const dueAt = Number(this.debounceDueAt || 0);
            const remainMs = dueAt > now ? dueAt - now : 0;
            if (remainMs > 0 && remainMs <= requestedDelay) {
              return;
            }
            window.clearTimeout(this.debounceTimerId);
            this.debounceTimerId = 0;
            const maxExtendMs = reasonText.includes("search")
              ? 420
              : reasonText.includes("ui-mode") ||
                  reasonText.includes("view-mode")
                ? 90
                : 220;
            if (remainMs > 0) {
              debounceMs = Math.min(requestedDelay, remainMs + maxExtendMs);
            }
          }
          const showQueuedState =
            debounceMs > Math.max(160, CLOUD_SYNC_UI_QUICK_DEBOUNCE_MS);
          if (
            showQueuedState &&
            (this.state !== "syncing" || this.stateDetail !== "queued")
          ) {
            this.setState("syncing", "queued");
          }
          this.debounceDueAt = now + debounceMs;
          this.debounceTimerId = window.setTimeout(() => {
            this.debounceTimerId = 0;
            this.debounceDueAt = 0;
            this.reconcileRemoteAndLocal(reason, false, { quiet: false });
          }, debounceMs);
        },

        async manualSync() {
          if (!this.canUseCloud()) {
            alert(STR.syncClientIdMissing);
            return;
          }
          if (!this.user?.googleUserId) {
            await this.signIn(true);
            return;
          }
          this.clearRecoverySyncTimer();
          this.enterFastSyncWindow(CLOUD_SYNC_FAST_WINDOW_MS);
          this.ultraCooldownUntil = 0;
          this.enterUltraRealtimeWindow(
            "manual-sync",
            Math.round(CLOUD_SYNC_ULTRA_WINDOW_MS * 1.16),
          );
          await this.reconcileRemoteAndLocal("manual", true);
          this.triggerForegroundSync("manual-post");
        },

        clearLocalCache() {
          if (!confirm(STR.syncCacheConfirm)) return;
          try {
            localStorage.removeItem(STORAGE_KEY);
            localStorage.removeItem(STORAGE_BACKUP_KEY);
            localStorage.removeItem(CLOUD_SYNC_CLIENT_ID_KEY);
            localStorage.removeItem(CLOUD_SYNC_TOKEN_CACHE_KEY);
            localStorage.removeItem(CLOUD_SYNC_META_KEY);
            localStorage.removeItem(CLOUD_SYNC_USER_KEY);
            localStorage.removeItem(CLOUD_SYNC_DEVICE_KEY);
            sessionStorage.removeItem(CLOUD_SYNC_TOKEN_CACHE_KEY);
          } catch {}
          location.reload();
        },

        resetLocalData() {
          app.resetData();
          this.refreshSyncModalUi();
        },

        escapeHtml(v) {
          return String(v ?? "").replace(/[&<>"']/g, (ch) => {
            const map = {
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            };
            return map[ch] || ch;
          });
        },

        renderSyncGuide() {
          const setupEl = document.getElementById("syncGuideSetupSteps");
          const troubleshootEl = document.getElementById(
            "syncGuideTroubleshoot",
          );
          const checksEl = document.getElementById("syncGuideChecks");
          const diagEl = document.getElementById("syncGuideDiag");
          const badgeEl = document.getElementById("syncGuideBadge");
          if (!setupEl || !troubleshootEl || !checksEl || !diagEl) return;

          const model = this.buildSyncGuideModel();
          setupEl.innerHTML = model.setupSteps
            .map((step) => `<li>${this.escapeHtml(step)}</li>`)
            .join("");
          troubleshootEl.innerHTML = model.troubleshoot
            .map((entry) => {
              if (entry && typeof entry === "object") {
                const level = this.escapeHtml(entry.level || "warn");
                const title = this.escapeHtml(entry.title || "");
                const action = this.escapeHtml(entry.action || "");
                const signal = this.escapeHtml(entry.signal || "");
                return `<li data-level="${level}"><div class="sync-trouble-title">${title}</div><div class="sync-trouble-action">${action}</div>${signal ? `<div class="sync-trouble-signal">${signal}</div>` : ""}</li>`;
              }
              const text = this.escapeHtml(String(entry || ""));
              return `<li data-level="warn"><div class="sync-trouble-title">${text}</div></li>`;
            })
            .join("");
          checksEl.innerHTML = model.checks
            .map((item) => {
              const level = this.escapeHtml(item?.level || "warn");
              const text = this.escapeHtml(item?.text || "");
              return `<li data-level="${level}">${text}</li>`;
            })
            .join("");
          diagEl.textContent = (model.diagLines || []).join("\n");
          if (badgeEl) {
            badgeEl.dataset.level = model.readyForSync ? "ok" : "warn";
            badgeEl.innerText = model.readyForSync
              ? STR.syncGuideBadgeReady
              : STR.syncGuideBadgeNeedsSetup;
          }
        },

        openSettingsModal() {
          const overlay = document.getElementById("modalOverlay");
          if (!overlay) return;

          const html = `
            <div id="syncModalRoot" class="theme-card sync-modal-shell shadow-2xl animate-fade-in" onclick="ui.stopEvent(event)"
              style="background: color-mix(in srgb, var(--card-bg) 90%, transparent);">
              <div class="sync-modal-head">
                <h3 class="sync-modal-title">${this.escapeHtml(STR.syncModalTitle)}</h3>
                <span id="txtSyncModalStateWrap" class="sync-modal-state" data-state="${this.escapeHtml(this.state)}">
                  <span class="sync-modal-state-dot" aria-hidden="true"></span>
                  <span id="txtSyncModalState">${this.escapeHtml(this.getStateText(this.state))}</span>
                </span>
              </div>

              <div class="sync-modal-scroll">
                <div class="sync-modal-user">
                  <div id="txtSyncModalUserEmail" class="sync-modal-user-email">...</div>
                  <div id="txtSyncModalUserId" class="sync-modal-user-meta">...</div>
                  <div id="txtSyncModalLastSynced" class="sync-modal-user-meta">...</div>
                </div>

                <div class="sync-client-config">
                  <div class="sync-client-label">${this.escapeHtml(STR.syncClientIdLabel)}</div>
                  <div class="sync-client-row">
                    <input type="text" id="inputSyncClientId" class="sync-client-input" dir="ltr" autocomplete="off" spellcheck="false" placeholder="${this.escapeHtml(STR.syncClientIdPlaceholder)}" />
                    <button type="button" id="btnSyncClientApply" class="sync-guide-btn sync-guide-btn--apply" onclick="cloudSync.applyClientIdFromInput()">
                      ${this.escapeHtml(STR.syncClientIdApply)}
                    </button>
                  </div>
                  <div class="sync-client-meta">
                    <button type="button" id="btnSyncClientReset" class="sync-guide-btn sync-guide-btn--ghost" onclick="cloudSync.resetClientIdConfig()">
                      ${this.escapeHtml(STR.syncClientIdReset)}
                    </button>
                    <span id="txtSyncClientStatus" class="sync-client-status" data-state="warn">${this.escapeHtml(STR.syncClientIdMissing)}</span>
                  </div>
                </div>

                <div class="sync-ultra-config">
                  <div class="sync-client-label">${this.escapeHtml(STR.syncUltraTitle)}</div>
                  <div class="sync-ultra-row">
                    <button type="button" id="btnSyncUltraToggle" class="sync-ultra-btn" onclick="cloudSync.toggleUltraRealtime()">
                      ${this.escapeHtml(STR.syncUltraEnableAction)}
                    </button>
                    <button type="button" id="btnSyncUltraProfile" class="sync-ultra-btn" onclick="cloudSync.toggleUltraMobileProfile()">
                      ${this.escapeHtml(STR.syncUltraProfileToggle)}
                    </button>
                  </div>
                  <div id="txtSyncUltraHint" class="sync-ultra-hint">${this.escapeHtml(STR.syncUltraHintBalanced)}</div>
                </div>

                <div class="sync-modal-actions">
                  <button type="button" id="btnSyncNow" class="sync-modal-btn sync-modal-btn--sync" onclick="cloudSync.manualSync()">
                    ${this.escapeHtml(STR.syncNowGuest)}
                  </button>
                  <button type="button" id="btnSyncSignIn" class="sync-modal-btn sync-modal-btn--google" onclick="cloudSync.signIn(true)">
                    ${this.escapeHtml(STR.syncSignIn)}
                  </button>
                  <button type="button" id="btnSyncSignOut" class="sync-modal-btn sync-modal-btn--logout" onclick="cloudSync.signOut()">
                    ${this.escapeHtml(STR.syncSignOut)}
                  </button>
                  <button type="button" id="btnSyncClearCache" class="sync-modal-btn sync-modal-btn--clear" onclick="cloudSync.clearLocalCache()">
                    ${this.escapeHtml(STR.syncClearCache)}
                  </button>
                  <button type="button" id="btnSyncResetData" class="sync-modal-btn" style="grid-column: 1 / -1;" onclick="cloudSync.resetLocalData()">
                    ${this.escapeHtml(STR.syncResetData)}
                  </button>
                </div>

                <div id="txtSyncModalFootnote" class="sync-modal-footnote"></div>
                <div id="syncGuidePanel" class="sync-guide-panel">
                  <div class="sync-guide-headline">
                    <h4 class="sync-guide-title">${this.escapeHtml(STR.syncGuideTitle)}</h4>
                    <span id="syncGuideBadge" class="sync-guide-badge" data-level="warn">${this.escapeHtml(STR.syncGuideBadgeNeedsSetup)}</span>
                  </div>
                  <section class="sync-guide-section">
                    <h5 class="sync-guide-section-title">${this.escapeHtml(STR.syncGuideSetupTitle)}</h5>
                    <ol id="syncGuideSetupSteps" class="sync-guide-list"></ol>
                  </section>
                  <section class="sync-guide-section">
                    <h5 class="sync-guide-section-title">${this.escapeHtml(STR.syncGuideTroubleshootTitle)}</h5>
                    <ul id="syncGuideTroubleshoot" class="sync-guide-list sync-guide-list--plain"></ul>
                  </section>
                  <div class="sync-guide-checks-title">${this.escapeHtml(STR.syncGuideChecksTitle)}</div>
                  <ul id="syncGuideChecks" class="sync-guide-checks"></ul>
                  <div class="sync-guide-section-title">${this.escapeHtml(STR.syncGuideDiagTitle)}</div>
                  <pre id="syncGuideDiag" class="sync-guide-diag"></pre>
                  <div class="sync-guide-actions">
                    <button type="button" id="btnSyncCopyDiag" class="sync-guide-btn sync-guide-btn--copy" onclick="cloudSync.copySyncDiagnostic()">
                      ${this.escapeHtml(STR.syncGuideCopy)}
                    </button>
                  </div>
                </div>
              </div>

              <div class="sync-modal-foot">
                <button type="button" onclick="ui.closeModal()" class="sync-modal-close-btn">
                  ${this.escapeHtml(STR.cancel)}
                </button>
              </div>
            </div>
          `;

          overlay.innerHTML = html;
          overlay.classList.remove("hidden");
          overlay.classList.add("flex");
          const clientInput = document.getElementById("inputSyncClientId");
          if (clientInput) {
            clientInput.addEventListener("keydown", (ev) => {
              if (ev.key === "Enter") {
                ev.preventDefault();
                this.applyClientIdFromInput();
              }
            });
          }
          this.refreshSyncModalUi();
        },

        refreshSyncModalUi() {
          const overlay = document.getElementById("modalOverlay");
          const stateWrap = document.getElementById("txtSyncModalStateWrap");
          const isSyncModalVisible = Boolean(
            overlay &&
            !overlay.classList.contains("hidden") &&
            stateWrap &&
            overlay.contains(stateWrap),
          );
          if (!isSyncModalVisible) return;
          const stateText = document.getElementById("txtSyncModalState");
          const userEmail = document.getElementById("txtSyncModalUserEmail");
          const userId = document.getElementById("txtSyncModalUserId");
          const lastSynced = document.getElementById("txtSyncModalLastSynced");
          const footnote = document.getElementById("txtSyncModalFootnote");
          const inputClientId = document.getElementById("inputSyncClientId");
          const btnClientReset = document.getElementById("btnSyncClientReset");
          const txtClientStatus = document.getElementById(
            "txtSyncClientStatus",
          );
          const btnUltraToggle = document.getElementById("btnSyncUltraToggle");
          const btnUltraProfile = document.getElementById(
            "btnSyncUltraProfile",
          );
          const txtUltraHint = document.getElementById("txtSyncUltraHint");
          const btnSignIn = document.getElementById("btnSyncSignIn");
          const btnSyncNow = document.getElementById("btnSyncNow");
          const btnSignOut = document.getElementById("btnSyncSignOut");
          const guidePanel = document.getElementById("syncGuidePanel");
          const canCloud = this.canUseCloud();
          const online = navigator.onLine;
          const secure = this.isSecureOrigin();
          const activeClientId = this.getClientId();
          const activeClientValid = this.isValidClientId(activeClientId);
          const ultraEnabled = Boolean(this.ultraEnabled);
          const ultraMobileProfile = this.sanitizeUltraMobileProfile(
            this.ultraMobileProfile,
          );
          const mobileLike = this.isMobileSyncContext();

          if (stateWrap) stateWrap.dataset.state = this.state;
          if (stateText) stateText.innerText = this.getStateText(this.state);
          if (userEmail) {
            userEmail.innerText =
              this.user?.email || this.user?.name || STR.syncGuest;
          }
          if (userId) {
            userId.innerText = `${STR.syncUserId}: ${this.user?.googleUserId || "-"}`;
          }
          if (lastSynced) {
            lastSynced.innerText = `${STR.syncLastSynced}: ${this.formatTime(this.meta.lastSyncedAt)}`;
          }
          if (inputClientId && document.activeElement !== inputClientId) {
            inputClientId.value = activeClientValid ? activeClientId : "";
          }
          if (btnClientReset) {
            btnClientReset.disabled = !this.clientIdCustom;
          }
          if (txtClientStatus) {
            txtClientStatus.dataset.state = canCloud ? "ok" : "warn";
            txtClientStatus.innerText = canCloud
              ? this.clientIdCustom
                ? STR.syncClientIdStatusCustom
                : STR.syncClientIdStatusCode
              : STR.syncClientIdMissing;
          }
          if (btnUltraToggle) {
            btnUltraToggle.disabled = !canCloud;
            btnUltraToggle.classList.toggle("is-on", ultraEnabled);
            btnUltraToggle.innerText = ultraEnabled
              ? STR.syncUltraDisableAction
              : STR.syncUltraEnableAction;
          }
          if (btnUltraProfile) {
            const batteryMode = ultraMobileProfile === "battery";
            btnUltraProfile.disabled = !canCloud || !ultraEnabled;
            btnUltraProfile.classList.toggle("is-battery", batteryMode);
            btnUltraProfile.innerText = batteryMode
              ? STR.syncUltraProfileBattery
              : STR.syncUltraProfileBalanced;
          }
          if (txtUltraHint) {
            let ultraHintText = STR.syncUltraHintDisabled;
            if (ultraEnabled) {
              ultraHintText =
                mobileLike && ultraMobileProfile === "battery"
                  ? STR.syncUltraHintBattery
                  : STR.syncUltraHintBalanced;
              const cooldownMsLeft = Math.max(
                0,
                Number(this.ultraCooldownUntil || 0) - Date.now(),
              );
              if (cooldownMsLeft > 1200) {
                ultraHintText += ` | cooldown ${Math.ceil(cooldownMsLeft / 1000)}s`;
              }
            }
            txtUltraHint.innerText = ultraHintText;
          }
          if (footnote) {
            const notes = [
              canCloud ? STR.syncCloudPrivate : STR.syncClientIdMissing,
            ];
            if (ultraEnabled) {
              notes.push(
                mobileLike && ultraMobileProfile === "battery"
                  ? STR.syncUltraProfileBattery
                  : STR.syncUltraProfileBalanced,
              );
            } else {
              notes.push(STR.syncUltraDisabled);
            }
            if (!this.isSecureOrigin()) {
              notes.push(
                "    HTTPS  localhost  .",
              );
            }
            if (!online) {
              notes.push("  .");
            }
            footnote.innerText = notes.join(" ");
          }

          const signedIn = Boolean(this.user?.googleUserId);
          const hasSyncedOnce = this.parseTime(this.meta.lastSyncedAt) > 0;
          const shouldHideGuide =
            signedIn && hasSyncedOnce && this.state === "synced";

          if (btnSignIn) {
            btnSignIn.disabled = !canCloud || !online || !secure || signedIn;
            btnSignIn.style.display = signedIn ? "none" : "";
          }
          if (btnSyncNow) {
            btnSyncNow.disabled = !canCloud || !online || !secure;
            btnSyncNow.innerText = signedIn
              ? STR.syncNowSignedIn
              : STR.syncNowGuest;
          }
          if (btnSignOut) {
            btnSignOut.disabled = !signedIn;
            btnSignOut.style.display = signedIn ? "" : "none";
          }
          if (guidePanel) {
            guidePanel.style.display = shouldHideGuide ? "none" : "grid";
          }
          if (!shouldHideGuide) {
            this.renderSyncGuide();
          }
        },

        bindRuntimeEvents() {
          if (this.runtimeBound) return;
          this.runtimeBound = true;
          window.addEventListener("online", () => {
            if (this.user?.googleUserId) {
              this.syncErrorStreak = 0;
              this.syncBackoffUntil = 0;
              this.clearRecoverySyncTimer();
              this.enterSignalBurst(
                "online",
                Math.round(CLOUD_SYNC_SIGNAL_BURST_MS * 0.8),
              );
              this.enterFastSyncWindow(CLOUD_SYNC_FAST_WINDOW_MS);
              this.enterUltraRealtimeWindow(
                "online",
                Math.round(CLOUD_SYNC_ULTRA_WINDOW_MS * 0.92),
              );
              this.scheduleSignalFollowupSync("online");
              this.triggerForegroundSync("online");
            } else {
              this.setState("offline", "guest");
            }
          });
          window.addEventListener("offline", () => {
            this.setState("offline", "offline");
            this.stopAutoSyncLoop();
            this.fastSyncUntil = 0;
            this.signalBurstUntil = 0;
            this.lastSignalChaseAt = 0;
            this.clearSignalFollowupTimers();
            this.syncBackoffUntil = 0;
            this.resetUltraRealtimeState();
            this.clearRemoteMetaCache();
          });
          window.addEventListener("focus", () => {
            this.startAutoSyncLoop(true);
            this.triggerForegroundSync("focus");
          });
          window.addEventListener("pageshow", () => {
            this.startAutoSyncLoop(true);
            this.triggerForegroundSync("pageshow");
          });
          document.addEventListener("visibilitychange", () => {
            if (document.hidden) {
              this.clearUltraRealtimeWindow("visibility-hidden");
              this.flushPendingSync("visibility-hidden");
              return;
            }
            this.startAutoSyncLoop(true);
            this.enterUltraRealtimeWindow(
              "visible",
              Math.round(CLOUD_SYNC_ULTRA_WINDOW_MS * 0.76),
            );
            this.triggerForegroundSync("visible");
          });
          window.addEventListener(
            "pagehide",
            () => {
              this.flushPendingSync("pagehide");
            },
            { passive: true },
          );
          window.addEventListener("resize", () => {
            if (!this.user?.googleUserId) return;
            this.startAutoSyncLoop(true);
          });
          const conn =
            navigator.connection ||
            navigator.mozConnection ||
            navigator.webkitConnection ||
            null;
          if (conn && typeof conn.addEventListener === "function") {
            conn.addEventListener("change", () => {
              if (!this.user?.googleUserId) return;
              this.startAutoSyncLoop(true);
              this.triggerForegroundSync("network-change");
            });
          }
          window.addEventListener("storage", (ev) => {
            if (!ev || !ev.key) return;
            if (ev.key === CLOUD_SYNC_SIGNAL_KEY) {
              if (!ev.newValue) return;
              try {
                const parsed = JSON.parse(String(ev.newValue || "{}"));
                this.handleExternalSyncSignal(parsed, "storage");
              } catch {}
              return;
            }
            if (ev.key === CLOUD_SYNC_META_KEY || ev.key === STORAGE_KEY) {
              if (
                !this.user?.googleUserId ||
                !this.canUseCloud() ||
                !navigator.onLine
              ) {
                return;
              }
              this.handleExternalSyncSignal(
                {
                  at: Date.now(),
                  reason: ev.key === CLOUD_SYNC_META_KEY ? "meta" : "state",
                  deviceId: "storage-external",
                },
                "storage-key",
              );
            }
          });
          try {
            if (typeof window !== "undefined" && "BroadcastChannel" in window) {
              if (!this.syncSignalChannel) {
                this.syncSignalChannel = new BroadcastChannel(
                  "uni-schedule-sync-signal-v1",
                );
              }
              if (
                this.syncSignalChannel &&
                typeof this.syncSignalChannel.addEventListener === "function"
              ) {
                this.syncSignalChannel.addEventListener("message", (ev) => {
                  this.handleExternalSyncSignal(ev?.data || null, "broadcast");
                });
              }
            }
          } catch {}
        },
      };
      window.cloudSync = cloudSync;

      function bindMobileScrollTouchFix() {
        if (typeof window === "undefined" || typeof document === "undefined")
          return;
        if (window.__mobileScrollTouchFixBound) return;
        window.__mobileScrollTouchFixBound = true;

        const selectors = [
          "#mainPanel",
          "#sidePanel",
          "#scheduleContainer",
          ".mobile-schedule-board",
          ".mobile-day-classes",
          ".schedule-frame",
          ".schedule-grid",
          "#mainPanel [class~='overflow-y-auto']",
          "#sidePanel [class~='overflow-y-auto']",
          "#modalOverlay [class~='overflow-y-auto']",
          "#examList",
          "#noteList",
          "#alertList",
          "#handoutList",
          "#courseProgressList",
          "#attendanceList",
          ".notify-connect-panel",
          ".notify-guide-scroll",
          ".sync-modal-scroll",
          ".sync-guide-panel",
          ".attendance-settings-scroll",
          ".attendance-settings-limit-list",
          ".class-form-scroll",
          ".class-details-body-wrap",
          ".class-details-list",
          ".exam-form-scroll",
          ".exam-widget-scroll",
          ".top-nav .top-nav-controls",
          ".tools-panel",
          ".side-widget",
          "#modalOverlay",
          "#modalOverlay .theme-card",
        ];

        const isMobileLike = () => {
          const mode = String(document.body?.dataset?.uiMode || "auto");
          if (mode === "mobile") return true;
          if (mode === "desktop") return false;
          return window.matchMedia("(max-width: 1024px)").matches;
        };

        const bindEdgeFix = (el) => {
          if (!(el instanceof HTMLElement) || el.__scrollEdgeFixBound) return;
          el.__scrollEdgeFixBound = true;
          const nudgeEdges = () => {
            if (!isMobileLike()) return;
            const canScrollY = el.scrollHeight > el.clientHeight + 1;
            if (canScrollY) {
              if (el.scrollTop <= 0) {
                el.scrollTop = 1;
                return;
              }
              const maxTop = el.scrollHeight - el.clientHeight;
              if (el.scrollTop >= maxTop) {
                el.scrollTop = Math.max(0, maxTop - 1);
              }
            }
          };

          el.addEventListener("touchstart", nudgeEdges, { passive: true });
          if (typeof window !== "undefined" && "PointerEvent" in window) {
            el.addEventListener(
              "pointerdown",
              (ev) => {
                if (ev.pointerType !== "touch") return;
                nudgeEdges();
              },
              { passive: true },
            );
          }
        };

        const apply = () => {
          if (!isMobileLike()) return;
          selectors.forEach((selector) => {
            document.querySelectorAll(selector).forEach((el) => {
              if (!(el instanceof HTMLElement)) return;
              const hasHorizontalTrack = el.scrollWidth > el.clientWidth + 1;
              const desiredTouchAction = hasHorizontalTrack
                ? "pan-x pan-y"
                : "pan-y";
              if (!el.__scrollPerfPatched) {
                el.style.setProperty(
                  "-webkit-overflow-scrolling",
                  "touch",
                  "important",
                );
                el.style.setProperty(
                  "overscroll-behavior-y",
                  "auto",
                  "important",
                );
                if (hasHorizontalTrack) {
                  el.style.setProperty("overscroll-behavior-x", "contain");
                }
                el.__scrollPerfPatched = true;
              } else if (hasHorizontalTrack) {
                const currentX = el.style.getPropertyValue(
                  "overscroll-behavior-x",
                );
                if (!currentX || currentX === "auto") {
                  el.style.setProperty("overscroll-behavior-x", "contain");
                }
              }
              if (
                el.style.getPropertyValue("touch-action") !== desiredTouchAction
              ) {
                el.style.setProperty("touch-action", desiredTouchAction);
              }
              bindEdgeFix(el);
            });
          });
        };

        let rafId = 0;
        let lastApplyAt = 0;
        const scheduleApply = () => {
          if (rafId) return;
          rafId = window.requestAnimationFrame(() => {
            rafId = 0;
            const now =
              typeof performance !== "undefined" &&
              typeof performance.now === "function"
                ? performance.now()
                : Date.now();
            if (now - lastApplyAt < 90) return;
            lastApplyAt = now;
            apply();
          });
        };

        const overlay = document.getElementById("modalOverlay");
        if (overlay && typeof MutationObserver === "function") {
          const overlayObserver = new MutationObserver(scheduleApply);
          overlayObserver.observe(overlay, {
            attributes: true,
            attributeFilter: ["class"],
            childList: true,
          });
        }

        if (document.body && typeof MutationObserver === "function") {
          const bodyObserver = new MutationObserver(scheduleApply);
          bodyObserver.observe(document.body, {
            attributes: true,
            attributeFilter: ["data-ui-mode"],
          });
        }

        window.addEventListener("resize", scheduleApply, { passive: true });
        window.addEventListener("orientationchange", scheduleApply, {
          passive: true,
        });

        scheduleApply();
      }

      function bindMobileTapScrollGuard() {
        if (typeof window === "undefined" || typeof document === "undefined")
          return;
        if (window.__mobileTapScrollGuardBound) return;
        window.__mobileTapScrollGuardBound = true;

        const TAP_SCROLL_TARGET_SELECTOR = [
          ".mobile-class-card",
          ".class-card",
          ".list-class-card",
          "#examList > div",
          "#noteList > div",
          "#alertList > div",
          "#handoutList > div",
          "#courseProgressList > div",
          ".attendance-list-item",
          ".pinned-alert-item",
        ].join(", ");
        const TAP_DRAG_THRESHOLD_PX = 10;

        const isMobileLike = () => {
          const mode = String(document.body?.dataset?.uiMode || "auto");
          if (mode === "mobile") return true;
          if (mode === "desktop") return false;
          return window.matchMedia("(max-width: 1024px)").matches;
        };

        const closestTapTarget = (node) => {
          if (!(node instanceof Element)) return null;
          return node.closest(TAP_SCROLL_TARGET_SELECTOR);
        };

        let activePointerId = null;
        let activeTarget = null;
        let startX = 0;
        let startY = 0;
        let moved = false;

        const resetActive = () => {
          if (activeTarget) activeTarget.classList.remove("is-touch-dragging");
          activePointerId = null;
          activeTarget = null;
          startX = 0;
          startY = 0;
          moved = false;
        };

        const markDragIfNeeded = (x, y) => {
          if (!activeTarget) return;
          const dx = Math.abs(Number(x) - startX);
          const dy = Math.abs(Number(y) - startY);
          if (dx < TAP_DRAG_THRESHOLD_PX && dy < TAP_DRAG_THRESHOLD_PX) return;
          moved = true;
          activeTarget.__cancelNextTapClick = true;
          activeTarget.classList.add("is-touch-dragging");
        };

        if ("PointerEvent" in window) {
          document.addEventListener(
            "pointerdown",
            (ev) => {
              if (ev.pointerType !== "touch" || !isMobileLike()) return;
              const target = closestTapTarget(ev.target);
              if (!target) return;
              activePointerId = ev.pointerId;
              activeTarget = target;
              startX = ev.clientX;
              startY = ev.clientY;
              moved = false;
            },
            { capture: true, passive: true },
          );

          document.addEventListener(
            "pointermove",
            (ev) => {
              if (
                ev.pointerType !== "touch" ||
                activePointerId === null ||
                ev.pointerId !== activePointerId
              ) {
                return;
              }
              markDragIfNeeded(ev.clientX, ev.clientY);
            },
            { capture: true, passive: true },
          );

          const finishPointer = () => {
            const target = activeTarget;
            const shouldCancel = Boolean(target && moved);
            window.setTimeout(() => {
              if (target && shouldCancel) {
                target.__cancelNextTapClick = false;
                target.classList.remove("is-touch-dragging");
              }
            }, 120);
            resetActive();
          };

          document.addEventListener("pointerup", finishPointer, {
            capture: true,
            passive: true,
          });
          document.addEventListener("pointercancel", finishPointer, {
            capture: true,
            passive: true,
          });
        } else {
          document.addEventListener(
            "touchstart",
            (ev) => {
              if (!isMobileLike()) return;
              const touch = ev.changedTouches && ev.changedTouches[0];
              if (!touch) return;
              const target = closestTapTarget(ev.target);
              if (!target) return;
              activePointerId = Number(touch.identifier);
              activeTarget = target;
              startX = touch.clientX;
              startY = touch.clientY;
              moved = false;
            },
            { capture: true, passive: true },
          );

          document.addEventListener(
            "touchmove",
            (ev) => {
              if (activePointerId === null) return;
              const list = ev.changedTouches || [];
              for (let i = 0; i < list.length; i += 1) {
                const touch = list[i];
                if (Number(touch.identifier) !== activePointerId) continue;
                markDragIfNeeded(touch.clientX, touch.clientY);
                break;
              }
            },
            { capture: true, passive: true },
          );

          const finishTouch = () => {
            const target = activeTarget;
            const shouldCancel = Boolean(target && moved);
            window.setTimeout(() => {
              if (target && shouldCancel) {
                target.__cancelNextTapClick = false;
                target.classList.remove("is-touch-dragging");
              }
            }, 120);
            resetActive();
          };

          document.addEventListener("touchend", finishTouch, {
            capture: true,
            passive: true,
          });
          document.addEventListener("touchcancel", finishTouch, {
            capture: true,
            passive: true,
          });
        }

        document.addEventListener(
          "click",
          (ev) => {
            if (!isMobileLike()) return;
            const target = closestTapTarget(ev.target);
            if (!target || !target.__cancelNextTapClick) return;
            target.__cancelNextTapClick = false;
            target.classList.remove("is-touch-dragging");
            ev.preventDefault();
            ev.stopPropagation();
            if (typeof ev.stopImmediatePropagation === "function") {
              ev.stopImmediatePropagation();
            }
          },
          { capture: true },
        );
      }

      function bindModalScrollStateSync() {
        const overlay = document.getElementById("modalOverlay");
        if (!overlay || overlay.__modalSyncBound) return;
        overlay.__modalSyncBound = true;

        const syncModalState = () => {
          const isOpen = !overlay.classList.contains("hidden");
          document.body.classList.toggle("modal-open", isOpen);
          bindMobileScrollTouchFix();
        };

        if (typeof MutationObserver !== "function") {
          syncModalState();
          return;
        }

        const observer = new MutationObserver(syncModalState);
        observer.observe(overlay, {
          attributes: true,
          attributeFilter: ["class"],
        });
        syncModalState();
      }

      async function bootApp() {
        syncDynamicViewportVars();
        bindModalScrollStateSync();
        bindMobileScrollTouchFix();
        bindMobileTapScrollGuard();
        cloudSync.init();
        app.init();
        await cloudSync.onAppReady();
      }

      const modalOverlayEl = document.getElementById("modalOverlay");
      if (modalOverlayEl) {
        modalOverlayEl.onclick = ui.closeModal;
      }
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", bootApp, { once: true });
      } else {
        bootApp();
      }
    </script>
  </body>
</html>
