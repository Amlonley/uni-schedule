<!doctype html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>University Dashboard Pro | Code_Master</title>

    <!-- Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@500;700&family=Vazirmatn:wght@300;400;500;700;900&display=swap"
      rel="stylesheet"
    />

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              vazir: ["Vazirmatn", "Tahoma", "Segoe UI", "sans-serif"],
              inter: ["Inter", "Segoe UI", "Roboto", "Arial", "sans-serif"],
            },
            animation: {
              "pulse-slow": "pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite",
              float: "float 7s ease-in-out infinite",
              "fade-in": "fadeIn 0.55s ease-out",
              glow: "glow 2.8s ease-in-out infinite",
            },
            keyframes: {
              float: {
                "0%,100%": { transform: "translateY(0)" },
                "50%": { transform: "translateY(-10px)" },
              },
              fadeIn: {
                "0%": { opacity: "0", transform: "translateY(10px)" },
                "100%": { opacity: "1", transform: "translateY(0)" },
              },
              glow: {
                "0%,100%": { filter: "brightness(1) saturate(1)" },
                "50%": { filter: "brightness(1.12) saturate(1.15)" },
              },
            },
          },
        },
      };
    </script>

    <style>
      :root {
        --transition-speed: 260ms;
        --font-fa: "Vazirmatn", "Tahoma", "Segoe UI", sans-serif;
        --font-en: "Inter", "Segoe UI", "Roboto", "Arial", sans-serif;
        --font-time: "JetBrains Mono", "Inter", "Segoe UI", monospace;
      }

      html {
        -webkit-text-size-adjust: 100%;
        text-size-adjust: 100%;
        font-kerning: normal;
        text-rendering: optimizeLegibility;
      }

      :lang(fa),
      [dir="rtl"] {
        font-feature-settings:
          "kern" 1,
          "liga" 1,
          "calt" 1,
          "ss01" 1;
      }

      body {
        transition:
          background-color var(--transition-speed),
          color var(--transition-speed);
        font-family: var(--font-fa);
        text-rendering: optimizeLegibility;
        font-kerning: normal;
        font-optical-sizing: auto;
        font-synthesis: none;
        letter-spacing: 0;
        word-spacing: 0;
        line-height: 1.6;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      input,
      select,
      textarea,
      button {
        font: inherit;
      }
      [dir="rtl"] input,
      [dir="rtl"] textarea {
        text-align: right;
        direction: rtl;
      }
      [dir="rtl"] input[type="time"],
      [dir="rtl"] input[type="date"] {
        text-align: left;
        direction: ltr;
        font-family: var(--font-en);
      }

      ::placeholder {
        opacity: 0.75;
      }

      /* Scrollbar */
      ::-webkit-scrollbar {
        width: 7px;
        height: 7px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: rgba(128, 128, 128, 0.35);
        border-radius: 999px;
      }

      /* ------------------------------
      THEME ENGINE (12 THEMES)
    ------------------------------ */

      /* 1) Glassmorphism 2.0 */
      body[data-theme="glass"] {
        --bg: #0b1226;
        --text: #f8fafc;
        --accent: #7c3aed;
        --accent2: #22d3ee;
        --card-bg: rgba(255, 255, 255, 0.06);
        --border: rgba(255, 255, 255, 0.12);
        --muted: rgba(248, 250, 252, 0.68);
      }
      body[data-theme="glass"] .theme-card {
        backdrop-filter: blur(18px);
        -webkit-backdrop-filter: blur(18px);
        border: 1px solid var(--border);
        border-radius: 22px;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.08),
          rgba(255, 255, 255, 0.04)
        );
        box-shadow:
          0 20px 60px rgba(0, 0, 0, 0.35),
          inset 0 1px 0 rgba(255, 255, 255, 0.08);
      }

      /* 2) Neo-Brutal Pro */
      body[data-theme="brutal"] {
        --bg: #f5f5f5;
        --text: #0b0b0b;
        --accent: #111;
        --accent2: #ff4d00;
        --card-bg: #ffffff;
        --border: #0b0b0b;
        --muted: rgba(0, 0, 0, 0.65);
        font-weight: 700;
      }
      body[data-theme="brutal"] .theme-card {
        border: 3px solid var(--border);
        box-shadow: 10px 10px 0 var(--border);
        border-radius: 16px;
        background: var(--card-bg);
      }

      /* 3) Dark Luxury */
      body[data-theme="luxury"] {
        --bg: #060606;
        --text: #f7e7b4;
        --accent: #d4af37;
        --accent2: #ff7a18;
        --card-bg: rgba(255, 255, 255, 0.05);
        --border: rgba(212, 175, 55, 0.28);
        --muted: rgba(247, 231, 180, 0.7);
      }
      body[data-theme="luxury"] .theme-card {
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-top: 1px solid rgba(212, 175, 55, 0.35);
        border-radius: 18px;
        background:
          radial-gradient(
            1200px 260px at 20% -10%,
            rgba(212, 175, 55, 0.1),
            transparent 60%
          ),
          linear-gradient(
            180deg,
            rgba(255, 255, 255, 0.06),
            rgba(255, 255, 255, 0.03)
          );
        box-shadow: 0 22px 70px rgba(0, 0, 0, 0.55);
      }

      /* 4) Hacker Clean */
      body[data-theme="hacker"] {
        --bg: #020617;
        --text: #00ff7a;
        --accent: #00ff41;
        --accent2: #22d3ee;
        --card-bg: rgba(0, 0, 0, 0.55);
        --border: rgba(0, 255, 65, 0.22);
        --muted: rgba(0, 255, 122, 0.62);
      }
      body[data-theme="hacker"] .theme-card {
        border: 1px solid var(--border);
        border-radius: 14px;
        background: linear-gradient(
          180deg,
          rgba(0, 0, 0, 0.55),
          rgba(0, 0, 0, 0.35)
        );
        box-shadow:
          0 0 0 1px rgba(0, 255, 65, 0.1) inset,
          0 18px 50px rgba(0, 0, 0, 0.55);
      }

      /* 5) Aurora / Gradient Mesh */
      body[data-theme="aurora"] {
        --bg: #0a0922;
        --text: #ffffff;
        --accent: #ff2da0;
        --accent2: #22d3ee;
        --card-bg: rgba(255, 255, 255, 0.08);
        --border: rgba(255, 255, 255, 0.16);
        --muted: rgba(255, 255, 255, 0.7);
      }
      body[data-theme="aurora"] .theme-card {
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid var(--border);
        border-radius: 26px;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.11),
          rgba(255, 255, 255, 0.05)
        );
        box-shadow: 0 26px 80px rgba(0, 0, 0, 0.45);
      }

      /* 6) Monochrome Minimal */
      body[data-theme="mono"] {
        --bg: #ffffff;
        --text: #0b0b0b;
        --accent: #111111;
        --accent2: #16a34a;
        --card-bg: rgba(255, 255, 255, 0.92);
        --border: rgba(0, 0, 0, 0.1);
        --muted: rgba(0, 0, 0, 0.62);
      }
      body[data-theme="mono"] .theme-card {
        border: 1px solid var(--border);
        border-radius: 18px;
        background: var(--card-bg);
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.06);
      }

      /* 7) Soft Neumorphism (Modern) */
      body[data-theme="soft"] {
        --bg: #e7ebf2;
        --text: #1f2937;
        --accent: #5865f2;
        --accent2: #06b6d4;
        --card-bg: #e7ebf2;
        --border: transparent;
        --muted: rgba(31, 41, 55, 0.62);
      }
      body[data-theme="soft"] .theme-card {
        border-radius: 22px;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.55),
          rgba(255, 255, 255, 0.25)
        );
        box-shadow:
          14px 14px 30px rgba(159, 170, 190, 0.5),
          -14px -14px 30px rgba(255, 255, 255, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.55);
      }

      /* 8) Material You */
      body[data-theme="material"] {
        --bg: #fef7ff;
        --text: #1d1b20;
        --accent: #6750a4;
        --accent2: #00b4d8;
        --card-bg: rgba(255, 255, 255, 0.8);
        --border: rgba(0, 0, 0, 0.08);
        --muted: rgba(29, 27, 32, 0.62);
      }
      body[data-theme="material"] .theme-card {
        border-radius: 30px;
        background: linear-gradient(to top, #a18cd1 0%, #fbc2eb 100%);
        border: 1px solid rgba(0, 0, 0, 0.06);
        box-shadow: 0 16px 40px rgba(0, 0, 0, 0.08);
      }

      /* 9) Frosted + Noise */
      body[data-theme="frosted"] {
        --bg: #151311;
        --text: #f3f4f6;
        --accent: #2dd4bf;
        --accent2: #a78bfa;
        --card-bg: rgba(255, 255, 255, 0.04);
        --border: rgba(255, 255, 255, 0.1);
        --muted: rgba(243, 244, 246, 0.7);
      }
      body[data-theme="frosted"] .theme-card {
        backdrop-filter: blur(42px);
        -webkit-backdrop-filter: blur(42px);
        border-radius: 18px;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.06),
          rgba(255, 255, 255, 0.02)
        );
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 26px 80px rgba(0, 0, 0, 0.55);
        position: relative;
        overflow: hidden;
      }

      /* 10) Editorial */
      body[data-theme="editorial"] {
        --bg: #fffbf0;
        --text: #141414;
        --accent: #d93025;
        --accent2: #111;
        --card-bg: rgba(255, 255, 255, 0.7);
        --border: rgba(0, 0, 0, 0.12);
        --muted: rgba(20, 20, 20, 0.62);
      }
      body[data-theme="editorial"] .theme-card {
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.7);
        border: 1px solid rgba(0, 0, 0, 0.12);
        box-shadow: 0 12px 26px rgba(0, 0, 0, 0.08);
      }

      /* 11) Mathematics Light */
      body[data-theme="mathlight"] {
        --bg: #fff9ea;
        --text: #4a2a34;
        --accent: #ff9a9e;
        --accent2: #fad0c4;
        --card-bg: rgba(255, 250, 236, 0.9);
        --border: rgba(255, 154, 158, 0.32);
        --muted: rgba(88, 52, 66, 0.66);
      }
      body[data-theme="mathlight"] .theme-card {
        border-radius: 20px;
        background:
          radial-gradient(
            1200px 240px at 10% -10%,
            rgba(255, 154, 158, 0.22),
            transparent 60%
          ),
          radial-gradient(
            1200px 260px at 90% 110%,
            rgba(250, 208, 196, 0.28),
            transparent 62%
          ),
          linear-gradient(45deg, #ff9a9e 0%, #fad0c4 99%, #fad0c4 100%);
        border: 1px solid color-mix(in srgb, var(--accent) 24%, var(--border));
        box-shadow:
          0 18px 44px rgba(74, 35, 52, 0.16),
          inset 0 1px 0 rgba(255, 255, 255, 0.72);
      }
      body[data-theme="mathlight"] .control-surface,
      body[data-theme="mathlight"] .control-btn:not(.danger-btn),
      body[data-theme="mathlight"] .week-toggle,
      body[data-theme="mathlight"] .tools-panel,
      body[data-theme="mathlight"] .top-nav,
      body[data-theme="mathlight"] .search-input,
      body[data-theme="mathlight"] .inp,
      body[data-theme="mathlight"] .chip,
      body[data-theme="mathlight"] .schedule-hint {
        background: linear-gradient(
          45deg,
          #ff9a9e 0%,
          #fad0c4 99%,
          #fad0c4 100%
        );
        color: #3f2135;
        border-color: rgba(83, 49, 66, 0.24) !important;
      }
      body[data-theme="mathlight"] .control-btn:not(.danger-btn):hover {
        filter: brightness(1.04);
      }
      body[data-theme="mathlight"] select option {
        background: #fad0c4;
        color: #3f2135;
      }

      /* 12) Mathematics Dark */
      body[data-theme="mathdark"] {
        --bg: #0f2027;
        --text: #deedf4;
        --accent: #2c5364;
        --accent2: #203a43;
        --card-bg: rgba(12, 27, 34, 0.78);
        --border: rgba(44, 83, 100, 0.34);
        --muted: rgba(177, 204, 216, 0.74);
      }
      body[data-theme="mathdark"] .theme-card {
        border-radius: 20px;
        border: 1px solid color-mix(in srgb, var(--accent) 30%, var(--border));
        background:
          linear-gradient(
            120deg,
            rgba(15, 32, 39, 0.28) 0%,
            rgba(32, 58, 67, 0.24) 52%,
            rgba(44, 83, 100, 0.22) 100%
          ),
          radial-gradient(
            1200px 260px at 90% -10%,
            rgba(44, 83, 100, 0.22),
            transparent 62%
          ),
          radial-gradient(
            1200px 320px at 0% 100%,
            rgba(32, 58, 67, 0.2),
            transparent 62%
          ),
          linear-gradient(180deg, rgba(9, 21, 27, 0.9), rgba(11, 24, 31, 0.82));
        box-shadow:
          0 24px 70px rgba(5, 12, 16, 0.65),
          inset 0 1px 0 rgba(157, 188, 201, 0.18);
      }

      /* ------------------------------
      BACKGROUND ENGINE (ALL THEMES)
      - each theme gets its own animated layer
    ------------------------------ */
      .bg-anim-layer {
        position: fixed;
        inset: 0;
        z-index: -10;
        overflow: hidden;
        pointer-events: none;
      }
      .bg-layer {
        position: absolute;
        inset: -2px;
        opacity: 0;
        transition: opacity 450ms ease;
      }
      .symbol-layer {
        position: absolute;
        inset: 0;
        opacity: 0;
        transition: opacity 450ms ease;
        overflow: hidden;
      }
      .scanline {
        position: absolute;
        inset: 0;
        opacity: 0;
        transition: opacity 450ms ease;
      }

      .orb {
        position: absolute;
        border-radius: 999px;
        filter: blur(110px);
        opacity: 0.22;
        mix-blend-mode: screen;
      }
      .orb-a {
        width: 640px;
        height: 640px;
        top: -220px;
        left: -220px;
        background: color-mix(in srgb, var(--accent) 78%, transparent);
      }
      .orb-b {
        width: 620px;
        height: 620px;
        bottom: -240px;
        right: -220px;
        background: color-mix(in srgb, var(--accent2) 70%, transparent);
      }
      .orb-c {
        width: 460px;
        height: 460px;
        top: 20%;
        right: -180px;
        background: rgba(59, 130, 246, 0.55);
        opacity: 0.14;
      }

      .grain {
        position: absolute;
        inset: 0;
        opacity: 0;
        transition: opacity 450ms ease;
      }

      body[data-theme="glass"] .bg-glass {
        opacity: 1;
      }
      body[data-theme="brutal"] .bg-brutal {
        opacity: 1;
      }
      body[data-theme="luxury"] .bg-luxury {
        opacity: 1;
      }
      body[data-theme="hacker"] .bg-hacker {
        opacity: 1;
      }
      body[data-theme="aurora"] .bg-aurora {
        opacity: 1;
      }
      body[data-theme="mono"] .bg-mono {
        opacity: 1;
      }
      body[data-theme="soft"] .bg-soft {
        opacity: 1;
      }
      body[data-theme="material"] .bg-material {
        opacity: 1;
      }
      body[data-theme="frosted"] .bg-frosted {
        opacity: 1;
      }
      body[data-theme="editorial"] .bg-editorial {
        opacity: 1;
      }
      body[data-theme="mathlight"] .bg-mathlight {
        opacity: 1;
      }
      body[data-theme="mathdark"] .bg-mathdark {
        opacity: 1;
      }
      body[data-theme="glass"] .sym-glass {
        opacity: 0.48;
      }
      body[data-theme="brutal"] .sym-brutal {
        opacity: 0.42;
      }
      body[data-theme="luxury"] .sym-luxury {
        opacity: 0.5;
      }
      body[data-theme="hacker"] .sym-hacker {
        opacity: 0.82;
      }
      body[data-theme="aurora"] .sym-aurora {
        opacity: 0.46;
      }
      body[data-theme="mono"] .sym-mono {
        opacity: 0.38;
      }
      body[data-theme="soft"] .sym-soft {
        opacity: 0.42;
      }
      body[data-theme="material"] .sym-material {
        opacity: 0.44;
      }
      body[data-theme="frosted"] .sym-frosted {
        opacity: 0.52;
      }
      body[data-theme="editorial"] .sym-editorial {
        opacity: 0.5;
      }
      body[data-theme="mathlight"] .sym-mathlight {
        opacity: 0.5;
      }
      body[data-theme="mathdark"] .sym-mathdark {
        opacity: 0.62;
      }

      body[data-theme="glass"] .grain,
      body[data-theme="frosted"] .grain,
      body[data-theme="editorial"] .grain {
        opacity: 0.16;
      }

      body[data-theme="hacker"] .scanline {
        opacity: 0.22;
      }
      .scanline {
        background: repeating-linear-gradient(
          to bottom,
          rgba(0, 255, 65, 0.06) 0px,
          rgba(0, 255, 65, 0.06) 1px,
          rgba(0, 0, 0, 0) 3px,
          rgba(0, 0, 0, 0) 8px
        );
        mix-blend-mode: screen;
      }

      .anim-off .bg-layer,
      .anim-off .symbol-layer,
      .anim-off .orb,
      .anim-off .scanline,
      .anim-off .grain {
        display: none !important;
      }

      /* Motion controls (performance mode + intensity) */
      body[data-anim-enabled="off"] #bgAnim {
        display: none !important;
      }
      body[data-anim-enabled="off"][data-theme="mathlight"] #bgAnim,
      body[data-anim-enabled="off"][data-theme="mathdark"] #bgAnim {
        display: block !important;
      }
      body[data-anim-enabled="off"][data-theme="mathlight"] #bgAnim .bg-layer,
      body[data-anim-enabled="off"][data-theme="mathlight"]
        #bgAnim
        .symbol-layer,
      body[data-anim-enabled="off"][data-theme="mathlight"] #bgAnim .orb,
      body[data-anim-enabled="off"][data-theme="mathlight"] #bgAnim .scanline,
      body[data-anim-enabled="off"][data-theme="mathlight"] #bgAnim .grain,
      body[data-anim-enabled="off"][data-theme="mathlight"] #bgAnim .theme-fx,
      body[data-anim-enabled="off"][data-theme="mathdark"] #bgAnim .bg-layer,
      body[data-anim-enabled="off"][data-theme="mathdark"]
        #bgAnim
        .symbol-layer,
      body[data-anim-enabled="off"][data-theme="mathdark"] #bgAnim .orb,
      body[data-anim-enabled="off"][data-theme="mathdark"] #bgAnim .scanline,
      body[data-anim-enabled="off"][data-theme="mathdark"] #bgAnim .grain,
      body[data-anim-enabled="off"][data-theme="mathdark"] #bgAnim .theme-fx {
        display: none !important;
      }
      body[data-anim-enabled="off"][data-theme="mathlight"]
        #bgAnim
        .bg-mathlight,
      body[data-anim-enabled="off"][data-theme="mathlight"]
        #bgAnim
        .sym-mathlight,
      body[data-anim-enabled="off"][data-theme="mathdark"] #bgAnim .bg-mathdark,
      body[data-anim-enabled="off"][data-theme="mathdark"]
        #bgAnim
        .sym-mathdark {
        display: block !important;
      }
      body[data-anim-enabled="off"] *,
      body[data-anim-enabled="off"] *::before,
      body[data-anim-enabled="off"] *::after {
        animation: none !important;
        transition: none !important;
      }

      body[data-anim-intensity="low"] .orb {
        opacity: 0.12;
        filter: blur(90px);
      }
      body[data-anim-intensity="low"] .bg-layer,
      body[data-anim-intensity="low"] .bg-layer::before,
      body[data-anim-intensity="low"] .bg-layer::after {
        animation-duration: 22s !important;
      }
      body[data-anim-intensity="low"] .theme-fx .fx-node {
        animation-duration: calc(var(--dur, 12s) * 1.65) !important;
        opacity: calc(var(--alpha, 0.2) * 0.62);
      }
      body[data-anim-intensity="low"] .symbol-layer .symbol-node {
        animation-duration: calc(var(--dur, 9s) * 1.6) !important;
        opacity: calc(var(--alpha, 0.46) * 0.56);
      }
      body[data-anim-intensity="low"] .theme-fx .fx-node:nth-child(2n),
      body[data-anim-intensity="low"] .symbol-layer .symbol-node:nth-child(2n),
      body[data-anim-intensity="low"] .bg-hacker .col:nth-child(2n) {
        display: none !important;
      }
      body[data-anim-intensity="low"] .bg-hacker .col {
        animation-duration: calc(var(--dur, 8s) * 1.75) !important;
      }
      body[data-anim-intensity="low"] .grain {
        opacity: 0.08 !important;
      }
      body[data-anim-intensity="low"] .scanline {
        opacity: 0.1 !important;
      }

      body[data-anim-intensity="high"] .theme-fx .fx-node {
        animation-duration: calc(var(--dur, 12s) * 0.92);
      }
      body[data-anim-intensity="high"] .symbol-layer .symbol-node {
        animation-duration: calc(var(--dur, 9s) * 0.92);
      }
      body[data-anim-enabled="off"][data-theme="mathlight"]
        .sym-mathlight
        .symbol-node,
      body[data-anim-enabled="off"][data-theme="mathdark"]
        .sym-mathdark
        .symbol-node {
        top: var(--y, 50%);
        animation: none !important;
        transform: translate3d(0, 0, 0) rotate(var(--rot, 0deg));
        opacity: calc(var(--alpha, 0.46) * 0.9);
        font-weight: 800;
      }

      /* Symbol Rain Layer (visible but subtle per-theme) */
      .symbol-layer .symbol-node {
        position: absolute;
        top: -22%;
        left: var(--x, 50%);
        font-size: var(--size, 18px);
        line-height: 1;
        opacity: var(--alpha, 0.46);
        transform: translate3d(0, 0, 0) rotate(var(--rot, 0deg));
        animation: fallSymbols var(--dur, 9s) linear infinite;
        animation-delay: var(--delay, 0s);
        user-select: none;
        pointer-events: none;
        will-change: transform, opacity;
      }
      .sym-glass .symbol-node {
        color: rgba(255, 255, 255, 0.7);
        text-shadow: 0 0 10px rgba(124, 58, 237, 0.4);
      }
      .sym-brutal .symbol-node {
        color: rgba(0, 0, 0, 0.42);
        font-weight: 900;
      }
      .sym-luxury .symbol-node {
        color: rgba(247, 231, 180, 0.82);
        text-shadow: 0 0 12px rgba(212, 175, 55, 0.35);
      }
      .sym-hacker .symbol-node {
        color: rgba(0, 255, 65, 0.95);
        font-family: var(--font-en);
        font-weight: 900;
        text-shadow:
          0 0 8px rgba(0, 255, 65, 0.9),
          0 0 20px rgba(0, 255, 65, 0.75);
      }
      .sym-aurora .symbol-node {
        color: rgba(255, 255, 255, 0.7);
        text-shadow:
          0 0 10px rgba(255, 45, 154, 0.45),
          0 0 16px rgba(34, 211, 238, 0.35);
      }
      .sym-mono .symbol-node {
        color: rgba(0, 0, 0, 0.35);
        font-family: var(--font-en);
      }
      .sym-soft .symbol-node {
        color: rgba(88, 101, 242, 0.42);
        text-shadow: 0 0 8px rgba(6, 182, 212, 0.3);
      }
      .sym-material .symbol-node {
        color: rgba(103, 80, 164, 0.44);
      }
      .sym-frosted .symbol-node {
        color: rgba(255, 255, 255, 0.72);
        text-shadow: 0 0 8px rgba(255, 255, 255, 0.4);
      }
      .sym-editorial .symbol-node {
        animation-name: fallLeaf;
      }
      .sym-editorial .symbol-node.leaf {
        width: var(--size, 12px);
        height: calc(var(--size, 12px) * 0.72);
        font-size: 0;
        border-radius: 0 100% 0 100%;
        background: linear-gradient(
          135deg,
          rgba(217, 48, 37, 0.8),
          rgba(190, 120, 30, 0.9)
        );
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      }
      .sym-editorial .symbol-node.leaf::before {
        content: "";
        position: absolute;
        right: 42%;
        top: 15%;
        width: 1px;
        height: 70%;
        background: rgba(70, 48, 22, 0.6);
        transform: rotate(26deg);
      }
      .sym-mathlight .symbol-node {
        color: rgba(131, 34, 77, 0.84);
        text-shadow:
          0 0 8px rgba(255, 154, 158, 0.34),
          0 0 12px rgba(250, 208, 196, 0.32);
      }
      .sym-mathdark .symbol-node {
        color: rgba(169, 205, 220, 0.92);
        text-shadow:
          0 0 9px rgba(44, 83, 100, 0.58),
          0 0 16px rgba(32, 58, 67, 0.42);
      }

      @keyframes fallSymbols {
        0% {
          transform: translate3d(0, -15vh, 0) rotate(var(--rot, 0deg));
          opacity: 0;
        }
        12% {
          opacity: var(--alpha, 0.28);
        }
        100% {
          transform: translate3d(var(--drift, 0px), 120vh, 0)
            rotate(calc(var(--rot, 0deg) + 180deg));
          opacity: 0;
        }
      }
      @keyframes fallLeaf {
        0% {
          transform: translate3d(0, -16vh, 0) rotate(var(--rot, 0deg));
          opacity: 0;
        }
        12% {
          opacity: var(--alpha, 0.28);
        }
        50% {
          transform: translate3d(var(--drift, 28px), 52vh, 0)
            rotate(calc(var(--rot, 0deg) + 90deg));
        }
        100% {
          transform: translate3d(calc(var(--drift, 28px) * -1), 120vh, 0)
            rotate(calc(var(--rot, 0deg) + 220deg));
          opacity: 0;
        }
      }

      /* Glass: floating sparkles + subtle conic light */
      .bg-glass {
        background:
          radial-gradient(
            900px 420px at 18% 20%,
            rgba(124, 58, 237, 0.25),
            transparent 60%
          ),
          radial-gradient(
            900px 420px at 80% 28%,
            rgba(34, 211, 238, 0.18),
            transparent 62%
          ),
          radial-gradient(
            900px 420px at 50% 90%,
            rgba(59, 130, 246, 0.14),
            transparent 62%
          ),
          conic-gradient(
            from 210deg at 60% 20%,
            rgba(255, 255, 255, 0.06),
            rgba(255, 255, 255, 0) 45%,
            rgba(255, 255, 255, 0.04) 70%,
            rgba(255, 255, 255, 0) 100%
          );
        background-size: 160% 160%;
        animation: meshMove 14s ease-in-out infinite;
        filter: saturate(1.05);
      }
      .bg-glass::before {
        content: "";
        position: absolute;
        inset: -30%;
        background-image: radial-gradient(
          rgba(255, 255, 255, 0.18) 1px,
          transparent 1px
        );
        background-size: 44px 44px;
        opacity: 0.08;
        animation: drift 22s linear infinite;
        transform: rotate(8deg);
      }

      /* Brutal: animated halftone + bold diagonal stripes */
      .bg-brutal {
        background:
          repeating-linear-gradient(
            135deg,
            rgba(0, 0, 0, 0.04) 0 10px,
            rgba(0, 0, 0, 0) 10px 20px
          ),
          radial-gradient(
            1200px 420px at 10% 10%,
            rgba(255, 77, 0, 0.1),
            transparent 60%
          ),
          radial-gradient(
            1200px 420px at 90% 35%,
            rgba(0, 0, 0, 0.06),
            transparent 60%
          );
        animation: brutalShift 12s ease-in-out infinite;
      }
      .bg-brutal::before {
        content: "";
        position: absolute;
        inset: -40px;
        background-image: radial-gradient(
          rgba(0, 0, 0, 0.2) 1px,
          transparent 1px
        );
        background-size: 26px 26px;
        opacity: 0.08;
        animation: drift 16s linear infinite;
      }
      @keyframes brutalShift {
        0% {
          transform: translate3d(0, 0, 0) rotate(0deg);
        }
        50% {
          transform: translate3d(-10px, 8px, 0) rotate(-0.25deg);
        }
        100% {
          transform: translate3d(0, 0, 0) rotate(0deg);
        }
      }

      /* Luxury: gold dust + slow drift */
      .bg-luxury {
        background:
          radial-gradient(
            900px 260px at 18% 12%,
            rgba(212, 175, 55, 0.18),
            transparent 65%
          ),
          radial-gradient(
            900px 320px at 80% 22%,
            rgba(255, 122, 24, 0.1),
            transparent 62%
          ),
          radial-gradient(
            900px 320px at 50% 100%,
            rgba(212, 175, 55, 0.08),
            transparent 62%
          );
        background-size: 150% 150%;
        animation: luxuryShift 18s ease-in-out infinite;
      }
      .bg-luxury::before {
        content: "";
        position: absolute;
        inset: -60px;
        background-image: radial-gradient(
          rgba(212, 175, 55, 0.26) 1px,
          transparent 1px
        );
        background-size: 32px 32px;
        opacity: 0.1;
        animation: drift 18s linear infinite;
      }

      /* Hacker: binary rain (JS) */
      .bg-hacker {
        font-family: var(--font-en);
        color: rgba(0, 255, 65, 0.22);
        filter: drop-shadow(0 0 6px rgba(0, 255, 65, 0.1));
        background:
          radial-gradient(
            900px 440px at 50% 0%,
            rgba(0, 255, 65, 0.08),
            transparent 66%
          ),
          linear-gradient(180deg, rgba(0, 10, 0, 0.22), rgba(0, 0, 0, 0.22));
        animation: hackerPulse 9s ease-in-out infinite;
      }
      .bg-hacker .col {
        position: absolute;
        top: -120vh;
        width: 22px;
        white-space: pre;
        line-height: 1.05;
        animation: rain linear infinite;
      }
      @keyframes rain {
        0% {
          transform: translateY(-10vh);
          opacity: 0.18;
        }
        10% {
          opacity: 0.55;
        }
        100% {
          transform: translateY(220vh);
          opacity: 0.06;
        }
      }

      /* Aurora mesh */
      .bg-aurora {
        background:
          radial-gradient(
            1100px 520px at 10% 20%,
            rgba(255, 45, 154, 0.26),
            transparent 60%
          ),
          radial-gradient(
            1100px 520px at 90% 30%,
            rgba(34, 211, 238, 0.2),
            transparent 62%
          ),
          radial-gradient(
            1100px 520px at 50% 90%,
            rgba(167, 139, 250, 0.22),
            transparent 62%
          ),
          linear-gradient(
            120deg,
            rgba(255, 255, 255, 0.05),
            rgba(255, 255, 255, 0)
          );
        background-size: 170% 170%;
        animation: meshMove 14s ease-in-out infinite;
      }

      /* Mono: subtle moving grid */
      .bg-mono {
        background:
          linear-gradient(to right, rgba(0, 0, 0, 0.05) 1px, transparent 1px),
          linear-gradient(to bottom, rgba(0, 0, 0, 0.05) 1px, transparent 1px);
        background-size: 44px 44px;
        opacity: 0.55;
        animation: gridShift 18s linear infinite;
      }
      @keyframes gridShift {
        0% {
          background-position: 0 0;
        }
        100% {
          background-position: 88px 88px;
        }
      }

      /* Soft: light sweep */
      .bg-soft {
        background:
          radial-gradient(
            1000px 560px at 30% 20%,
            rgba(88, 101, 242, 0.18),
            transparent 60%
          ),
          radial-gradient(
            1000px 560px at 70% 70%,
            rgba(6, 182, 212, 0.14),
            transparent 60%
          );
        background-size: 160% 160%;
        animation: softDrift 16s ease-in-out infinite;
      }
      .bg-soft::before {
        content: "";
        position: absolute;
        inset: -20%;
        background: linear-gradient(
          120deg,
          transparent 30%,
          rgba(255, 255, 255, 0.35) 50%,
          transparent 70%
        );
        transform: rotate(12deg);
        opacity: 0.1;
        animation: sweep 10s ease-in-out infinite;
      }
      @keyframes sweep {
        0% {
          transform: translateX(-12%) rotate(12deg);
        }
        50% {
          transform: translateX(12%) rotate(12deg);
        }
        100% {
          transform: translateX(-12%) rotate(12deg);
        }
      }

      /* Material: pulsing blobs */
      .bg-material {
        background:
          radial-gradient(
            760px 520px at 20% 30%,
            rgba(161, 140, 209, 0.24),
            transparent 62%
          ),
          radial-gradient(
            760px 520px at 75% 70%,
            rgba(251, 194, 235, 0.22),
            transparent 62%
          ),
          radial-gradient(
            760px 520px at 50% 95%,
            rgba(255, 255, 255, 0.18),
            transparent 60%
          ),
          linear-gradient(to top, #a18cd1 0%, #fbc2eb 100%);
        animation: matPulse 12s ease-in-out infinite;
      }
      @keyframes matPulse {
        0% {
          filter: saturate(1);
        }
        50% {
          filter: saturate(1.18);
        }
        100% {
          filter: saturate(1);
        }
      }

      /* Frosted: moving noise */
      .bg-frosted {
        background: radial-gradient(
          1100px 620px at 30% 30%,
          rgba(45, 212, 191, 0.12),
          transparent 60%
        );
        background-size: 170% 170%;
        animation: frostedDrift 15s ease-in-out infinite;
      }
      .bg-frosted::before {
        content: "";
        position: absolute;
        inset: -60px;
        opacity: 0.18;
        background-image: url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIj48ZmlsdGVyIGlkPSJmIj48ZmVUdXJidWxlbmNlIHR5cGU9ImZyYWN0YWxOb2lzZSIgYmFzZUZyZXF1ZW5jeT0iMC42NSIgbnVtT2N0YXZlcz0iMyIgc3RpdGNoVGlsZXM9InN0aXRjaCIvPjwvZmlsdGVyPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbHRlcj0idXJsKCNmKSIgb3BhY2l0eT0iMC4yMCIvPjwvc3ZnPg==");
        animation: noiseMove 6s linear infinite;
      }
      @keyframes noiseMove {
        0% {
          transform: translate3d(0, 0, 0);
        }
        100% {
          transform: translate3d(70px, -70px, 0);
        }
      }

      /* Editorial: paper vignette */
      .bg-editorial {
        background:
          radial-gradient(
            1000px 520px at 50% 12%,
            rgba(0, 0, 0, 0.08),
            transparent 60%
          ),
          radial-gradient(
            900px 460px at 50% 100%,
            rgba(0, 0, 0, 0.06),
            transparent 60%
          ),
          linear-gradient(
            0deg,
            rgba(255, 255, 255, 0.25),
            rgba(255, 255, 255, 0)
          );
        background-size: 160% 160%;
        animation: editorialDrift 19s ease-in-out infinite;
      }
      .bg-editorial::before {
        content: "";
        position: absolute;
        inset: -14%;
        opacity: 0.17;
        background:
          repeating-linear-gradient(
            0deg,
            rgba(0, 0, 0, 0.05) 0 2px,
            transparent 2px 18px
          ),
          radial-gradient(
            1000px 280px at 20% 20%,
            rgba(217, 48, 37, 0.1),
            transparent 65%
          );
        animation: editorialTexture 21s linear infinite;
      }

      /* Mathematics Light: paper grid + formula glow */
      .bg-mathlight {
        background:
          linear-gradient(
            to right,
            rgba(255, 154, 158, 0.14) 1px,
            transparent 1px
          ),
          linear-gradient(
            to bottom,
            rgba(250, 208, 196, 0.16) 1px,
            transparent 1px
          ),
          radial-gradient(
            860px 420px at 14% 18%,
            rgba(255, 154, 158, 0.24),
            transparent 62%
          ),
          radial-gradient(
            860px 420px at 88% 76%,
            rgba(250, 208, 196, 0.3),
            transparent 62%
          ),
          linear-gradient(45deg, #ff9a9e 0%, #fad0c4 99%, #fad0c4 100%);
        background-size:
          34px 34px,
          34px 34px,
          160% 160%,
          160% 160%,
          100% 100%;
        animation: mathGridShift 14s linear infinite;
      }
      .bg-mathlight::before {
        content: "";
        position: absolute;
        inset: -18%;
        opacity: 0.28;
        background:
          radial-gradient(
            640px 220px at 20% 20%,
            rgba(255, 255, 255, 0.82),
            transparent 66%
          ),
          radial-gradient(
            520px 180px at 78% 70%,
            rgba(250, 208, 196, 0.34),
            transparent 68%
          );
        animation: mathFieldShift 18s ease-in-out infinite;
      }
      .bg-mathlight::after {
        content: "";
        position: absolute;
        inset: 0;
        opacity: 0.44;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 360 210'%3E%3Cpath d='M0 105H360M180 0V210' stroke='%23c7687f' stroke-opacity='0.22' stroke-width='1.2'/%3E%3Cpath d='M0 136 C45 68,90 68,135 136 S225 204,270 136 S315 68,360 136' fill='none' stroke='%23ff9a9e' stroke-opacity='0.55' stroke-width='2.4'/%3E%3Cpath d='M24 174 Q180 24 336 174' fill='none' stroke='%23fad0c4' stroke-opacity='0.44' stroke-width='1.9'/%3E%3C/svg%3E");
        background-size: 430px 250px;
        background-repeat: repeat;
        mix-blend-mode: multiply;
        animation: mathFuncDriftLight 24s linear infinite;
      }

      /* Mathematics Dark: neon graph field */
      .bg-mathdark {
        background:
          linear-gradient(
            to right,
            rgba(169, 205, 220, 0.13) 1px,
            transparent 1px
          ),
          linear-gradient(
            to bottom,
            rgba(119, 159, 176, 0.11) 1px,
            transparent 1px
          ),
          radial-gradient(
            920px 520px at 18% 12%,
            rgba(32, 58, 67, 0.28),
            transparent 64%
          ),
          radial-gradient(
            920px 520px at 82% 84%,
            rgba(44, 83, 100, 0.22),
            transparent 66%
          ),
          linear-gradient(180deg, rgba(8, 17, 22, 0.74), rgba(6, 14, 18, 0.92)),
          linear-gradient(120deg, #0f2027 0%, #203a43 52%, #2c5364 100%);
        background-size:
          36px 36px,
          36px 36px,
          170% 170%,
          170% 170%,
          100% 100%;
        animation: mathGridShift 16s linear infinite;
      }
      .bg-mathdark::before {
        content: "";
        position: absolute;
        inset: -16%;
        opacity: 0.28;
        background:
          radial-gradient(
            720px 260px at 24% 16%,
            rgba(44, 83, 100, 0.3),
            transparent 66%
          ),
          radial-gradient(
            620px 240px at 80% 76%,
            rgba(32, 58, 67, 0.24),
            transparent 68%
          );
        animation: mathFieldShift 20s ease-in-out infinite;
      }
      .bg-mathdark::after {
        content: "";
        position: absolute;
        inset: 0;
        opacity: 0.5;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 360 210'%3E%3Cpath d='M0 105H360M180 0V210' stroke='%23203a43' stroke-opacity='0.28' stroke-width='1.2'/%3E%3Cpath d='M0 136 C45 58,90 58,135 136 S225 214,270 136 S315 58,360 136' fill='none' stroke='%232c5364' stroke-opacity='0.68' stroke-width='2.3'/%3E%3Cpath d='M18 182 Q180 18 342 182' fill='none' stroke='%230f2027' stroke-opacity='0.52' stroke-width='1.9'/%3E%3C/svg%3E");
        background-size: 430px 250px;
        background-repeat: repeat;
        mix-blend-mode: screen;
        animation: mathFuncDriftDark 22s linear infinite;
      }

      /* Grain overlay (for premium tactile feel) */
      .grain {
        background-image: url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIj48ZmlsdGVyIGlkPSJnoiPjxmZVR1cmJ1bGVuY2UgdHlwZT0iZnJhY3RhbE5vaXNlIiBiYXNlRnJlcXVlbmN5PSIwLjY1IiBudW1PY3RhdmVzPSIzIi8+PC9maWx0ZXI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsdGVyPSJ1cmwoI2cpIiBvcGFjaXR5PSIwLjI1Ii8+PC9zdmc+");
        opacity: 0.14;
        mix-blend-mode: overlay;
        animation: noiseMove 7s linear infinite;
      }

      @keyframes meshMove {
        0% {
          background-position: 0% 20%;
        }
        50% {
          background-position: 90% 80%;
        }
        100% {
          background-position: 0% 20%;
        }
      }
      @keyframes drift {
        0% {
          transform: translate3d(0, 0, 0);
        }
        100% {
          transform: translate3d(70px, -70px, 0);
        }
      }
      @keyframes luxuryShift {
        0% {
          background-position: 15% 20%;
        }
        50% {
          background-position: 78% 75%;
        }
        100% {
          background-position: 15% 20%;
        }
      }
      @keyframes hackerPulse {
        0% {
          filter: drop-shadow(0 0 5px rgba(0, 255, 65, 0.08));
        }
        50% {
          filter: drop-shadow(0 0 11px rgba(0, 255, 65, 0.22));
        }
        100% {
          filter: drop-shadow(0 0 5px rgba(0, 255, 65, 0.08));
        }
      }
      @keyframes softDrift {
        0% {
          background-position: 10% 20%;
        }
        50% {
          background-position: 80% 82%;
        }
        100% {
          background-position: 10% 20%;
        }
      }
      @keyframes frostedDrift {
        0% {
          background-position: 20% 25%;
        }
        50% {
          background-position: 85% 70%;
        }
        100% {
          background-position: 20% 25%;
        }
      }
      @keyframes editorialDrift {
        0% {
          background-position: 0% 25%;
        }
        50% {
          background-position: 100% 78%;
        }
        100% {
          background-position: 0% 25%;
        }
      }
      @keyframes editorialTexture {
        0% {
          transform: translate3d(0, 0, 0);
        }
        100% {
          transform: translate3d(-120px, 80px, 0);
        }
      }
      @keyframes mathGridShift {
        0% {
          background-position:
            0 0,
            0 0,
            12% 18%,
            88% 82%,
            0 0;
        }
        50% {
          background-position:
            34px 34px,
            -34px 34px,
            82% 74%,
            18% 22%,
            0 0;
        }
        100% {
          background-position:
            68px 68px,
            -68px 68px,
            12% 18%,
            88% 82%,
            0 0;
        }
      }
      @keyframes mathFieldShift {
        0% {
          transform: translate3d(0, 0, 0);
        }
        50% {
          transform: translate3d(26px, -16px, 0);
        }
        100% {
          transform: translate3d(0, 0, 0);
        }
      }
      @keyframes mathFuncDriftLight {
        0% {
          background-position: 0 0;
        }
        100% {
          background-position: 430px -40px;
        }
      }
      @keyframes mathFuncDriftDark {
        0% {
          background-position: 0 0;
        }
        100% {
          background-position: -430px 36px;
        }
      }

      /* Theme FX Layer (per-theme animated particles) */
      .theme-fx {
        position: absolute;
        inset: 0;
        overflow: hidden;
        pointer-events: none;
      }
      .theme-fx .fx-node {
        position: absolute;
        left: var(--x, 50%);
        top: var(--y, 50%);
        width: var(--size, 8px);
        height: var(--size, 8px);
        opacity: var(--alpha, 0.2);
        will-change: transform, opacity;
        animation-duration: var(--dur, 12s);
        animation-delay: var(--delay, 0s);
        animation-iteration-count: infinite;
        animation-timing-function: ease-in-out;
      }
      .fx-glass .fx-node {
        border-radius: 999px;
        background: radial-gradient(
          circle,
          rgba(255, 255, 255, 0.9),
          rgba(124, 58, 237, 0.2) 62%,
          transparent 100%
        );
        filter: blur(var(--blur, 0.5px));
        mix-blend-mode: screen;
        animation-name: fxFloat;
      }
      .fx-brutal .fx-node {
        border-radius: 2px;
        border: 2px solid rgba(11, 11, 11, 0.22);
        background: rgba(255, 77, 0, 0.2);
        animation-name: fxBrutal;
      }
      .fx-luxury .fx-node {
        border-radius: 999px;
        background: radial-gradient(
          circle,
          rgba(255, 246, 208, 0.95),
          rgba(212, 175, 55, 0.2) 66%,
          transparent 100%
        );
        box-shadow: 0 0 16px rgba(212, 175, 55, 0.3);
        animation-name: fxPulse;
      }
      .fx-hacker .fx-node {
        width: 2px;
        height: var(--size, 24px);
        border-radius: 999px;
        background: linear-gradient(
          180deg,
          rgba(0, 255, 65, 0),
          rgba(0, 255, 65, 0.8),
          rgba(0, 255, 65, 0)
        );
        mix-blend-mode: screen;
        animation-name: fxFall;
      }
      .fx-aurora .fx-node {
        width: calc(var(--size, 10px) * 3.6);
        height: calc(var(--size, 10px) * 0.42);
        border-radius: 999px;
        background: linear-gradient(
          90deg,
          rgba(255, 45, 154, 0),
          rgba(255, 45, 154, 0.42),
          rgba(34, 211, 238, 0.48),
          rgba(34, 211, 238, 0)
        );
        filter: blur(0.4px);
        animation-name: fxSweep;
      }
      .fx-mono .fx-node {
        width: 1px;
        height: var(--size, 30px);
        background: linear-gradient(
          180deg,
          rgba(0, 0, 0, 0),
          rgba(0, 0, 0, 0.18),
          rgba(0, 0, 0, 0)
        );
        animation-name: fxSweep;
      }
      .fx-soft .fx-node {
        border-radius: 999px;
        background: radial-gradient(
          circle,
          rgba(255, 255, 255, 0.8),
          rgba(88, 101, 242, 0.22) 66%,
          transparent 100%
        );
        filter: blur(var(--blur, 0.4px));
        animation-name: fxFloat;
      }
      .fx-material .fx-node {
        border-radius: 34% 66% 58% 42% / 44% 38% 62% 56%;
        background: radial-gradient(
          circle at 30% 30%,
          rgba(255, 255, 255, 0.72),
          rgba(103, 80, 164, 0.24) 64%,
          transparent 100%
        );
        animation-name: fxPulse;
      }
      .fx-frosted .fx-node {
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.36);
        background: rgba(255, 255, 255, 0.1);
        animation-name: fxFall;
      }
      .fx-editorial .fx-node {
        width: calc(var(--size, 8px) * 1.5);
        height: var(--size, 8px);
        border-radius: 2px;
        background: rgba(20, 20, 20, 0.16);
        animation-name: fxPaper;
      }
      .fx-mathlight .fx-node {
        border-radius: 8px;
        border: 1px solid rgba(255, 154, 158, 0.46);
        background: rgba(255, 255, 255, 0.52);
        box-shadow: 0 0 10px rgba(250, 208, 196, 0.34);
        animation-name: fxSweep;
      }
      .fx-mathdark .fx-node {
        border-radius: 999px;
        background: radial-gradient(
          circle,
          rgba(169, 205, 220, 0.84),
          rgba(44, 83, 100, 0.3) 64%,
          transparent 100%
        );
        box-shadow: 0 0 16px rgba(44, 83, 100, 0.4);
        animation-name: fxPulse;
      }
      @keyframes fxFloat {
        0% {
          transform: translate3d(0, 0, 0) scale(0.84);
          opacity: 0;
        }
        20% {
          opacity: var(--alpha, 0.22);
        }
        50% {
          transform: translate3d(var(--dx, 26px), var(--dy, -30px), 0)
            scale(1.08);
        }
        80% {
          opacity: var(--alpha, 0.22);
        }
        100% {
          transform: translate3d(0, 0, 0) scale(0.84);
          opacity: 0;
        }
      }
      @keyframes fxPulse {
        0%,
        100% {
          transform: translate3d(0, 0, 0) scale(0.92);
          opacity: var(--alpha, 0.2);
        }
        50% {
          transform: translate3d(var(--dx, 12px), var(--dy, -10px), 0)
            scale(1.25);
          opacity: calc(var(--alpha, 0.2) + 0.15);
        }
      }
      @keyframes fxBrutal {
        0% {
          transform: translate3d(0, 0, 0) rotate(0deg);
        }
        25% {
          transform: translate3d(var(--dx, 26px), 0, 0) rotate(var(--rot, 8deg));
        }
        50% {
          transform: translate3d(var(--dx, 26px), var(--dy, 22px), 0)
            rotate(calc(var(--rot, 8deg) * -1));
        }
        75% {
          transform: translate3d(0, var(--dy, 22px), 0) rotate(var(--rot, 8deg));
        }
        100% {
          transform: translate3d(0, 0, 0) rotate(0deg);
        }
      }
      @keyframes fxSweep {
        0% {
          transform: translate3d(-24px, 0, 0);
          opacity: 0;
        }
        20% {
          opacity: var(--alpha, 0.2);
        }
        50% {
          transform: translate3d(var(--dx, 72px), var(--dy, 12px), 0);
        }
        100% {
          transform: translate3d(24px, 0, 0);
          opacity: 0;
        }
      }
      @keyframes fxFall {
        0% {
          transform: translate3d(0, -120%, 0) rotate(0deg);
          opacity: 0;
        }
        15% {
          opacity: var(--alpha, 0.2);
        }
        100% {
          transform: translate3d(var(--dx, 16px), 120vh, 0) rotate(170deg);
          opacity: 0;
        }
      }
      @keyframes fxPaper {
        0% {
          transform: translate3d(0, 0, 0) rotate(0deg);
          opacity: var(--alpha, 0.16);
        }
        50% {
          transform: translate3d(var(--dx, 36px), var(--dy, 30px), 0)
            rotate(var(--rot, 12deg));
          opacity: calc(var(--alpha, 0.16) + 0.14);
        }
        100% {
          transform: translate3d(0, 0, 0) rotate(0deg);
          opacity: var(--alpha, 0.16);
        }
      }

      @media (prefers-reduced-motion: reduce) {
        *,
        *::before,
        *::after {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
        }
        .theme-fx {
          display: none !important;
        }
      }

      /* ------------------------------
      Premium UI atoms
    ------------------------------ */
      .theme-card {
        position: relative;
        isolation: isolate;
        transition:
          transform 0.2s ease,
          box-shadow 0.22s ease,
          border-color 0.22s ease;
      }
      .theme-card::before {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        border-radius: inherit;
        background: radial-gradient(
          900px 200px at 10% 0%,
          rgba(255, 255, 255, 0.08),
          transparent 65%
        );
        opacity: 0.55;
        z-index: 0;
      }
      .theme-card > * {
        position: relative;
        z-index: 1;
      }

      .chip {
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 900;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.06);
        color: var(--text);
        backdrop-filter: blur(14px);
        -webkit-backdrop-filter: blur(14px);
      }
      body[data-theme="mono"] .chip,
      body[data-theme="editorial"] .chip,
      body[data-theme="material"] .chip {
        background: rgba(255, 255, 255, 0.8);
        border: 1px solid rgba(0, 0, 0, 0.1);
      }
      .class-number-chip {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 999px;
        padding: 2px 8px;
        font-size: 10px;
        font-weight: 950;
        border: 1px solid rgba(251, 146, 60, 0.72);
        color: #fff7ed;
        background: linear-gradient(
          120deg,
          rgba(251, 146, 60, 0.95),
          rgba(239, 68, 68, 0.92)
        );
        box-shadow:
          0 6px 14px rgba(239, 68, 68, 0.28),
          inset 0 1px 0 rgba(255, 255, 255, 0.28);
        white-space: nowrap;
      }
      .class-number-chip--lg {
        padding: 4px 10px;
        font-size: 11px;
      }
      .class-number-line {
        margin-top: 6px;
      }

      .badge {
        padding: 3px 10px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 900;
        white-space: nowrap;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .badge-odd {
        background: rgba(254, 240, 138, 0.95);
        color: #854d0e;
        border-color: rgba(133, 77, 14, 0.25);
      }
      .badge-even {
        background: rgba(219, 234, 254, 0.95);
        color: #1e40af;
        border-color: rgba(30, 64, 175, 0.25);
      }
      .badge-normal {
        background: rgba(128, 128, 128, 0.16);
        color: var(--text);
        border-color: rgba(255, 255, 255, 0.1);
      }
      .badge-alert {
        background: rgba(254, 226, 226, 0.96);
        color: #b91c1c;
        border-color: rgba(185, 28, 28, 0.25);
      }
      .notify-perm-btn {
        width: 32px;
        height: 32px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: color-mix(in srgb, var(--card-bg) 78%, transparent);
        color: var(--text);
        transition:
          transform 0.15s ease,
          filter 0.2s ease,
          border-color 0.2s ease;
      }
      .notify-perm-btn:hover {
        filter: brightness(1.08);
        transform: translateY(-1px);
      }
      .notify-perm-btn[data-state="granted"] {
        border-color: rgba(16, 185, 129, 0.65);
        box-shadow:
          0 0 0 1px rgba(16, 185, 129, 0.2) inset,
          0 6px 16px rgba(16, 185, 129, 0.2);
      }
      .notify-perm-btn[data-state="denied"] {
        border-color: rgba(239, 68, 68, 0.62);
        color: #ef4444;
      }
      .notify-perm-btn[data-state="unsupported"] {
        opacity: 0.55;
        cursor: not-allowed;
      }

      .logo-badge {
        position: relative;
        width: 52px;
        height: 52px;
        border-radius: 18px;
        display: grid;
        place-items: center;
        background: linear-gradient(
          145deg,
          color-mix(in srgb, var(--accent) 88%, #ffffff 12%),
          color-mix(in srgb, var(--accent2) 75%, #ffffff 25%)
        );
        box-shadow:
          0 10px 24px rgba(0, 0, 0, 0.26),
          inset 0 1px 0 rgba(255, 255, 255, 0.38);
        overflow: hidden;
      }
      .logo-badge::before {
        content: "";
        position: absolute;
        inset: 2px;
        border-radius: 14px;
        background: radial-gradient(
          120px 60px at 18% 0%,
          rgba(255, 255, 255, 0.5),
          rgba(255, 255, 255, 0) 65%
        );
      }
      .logo-badge::after {
        content: "";
        position: absolute;
        width: 120%;
        height: 120%;
        background: conic-gradient(
          from 0deg,
          rgba(255, 255, 255, 0.35),
          rgba(255, 255, 255, 0) 40%,
          rgba(255, 255, 255, 0.3) 70%,
          rgba(255, 255, 255, 0)
        );
        animation: logoSpin 6s linear infinite;
      }
      .logo-icon {
        width: 24px;
        height: 24px;
        color: color-mix(in srgb, var(--bg) 86%, #000000 14%);
        z-index: 2;
        filter: drop-shadow(0 1px 0 rgba(255, 255, 255, 0.2));
      }
      @keyframes logoSpin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      /* ------------------------------
      PREMIUM SCHEDULE GRID (SUPER)
    ------------------------------ */
      .schedule-shell {
        border-radius: 24px;
        overflow: hidden;
        padding: 1px;
        background: linear-gradient(
          140deg,
          color-mix(in srgb, var(--accent) 38%, transparent),
          transparent 28%,
          color-mix(in srgb, var(--accent2) 36%, transparent)
        );
      }
      .schedule-grid {
        display: grid;
        grid-template-columns: 106px repeat(6, minmax(190px, 1fr));
        gap: 1px;
        overflow: auto;
        background: color-mix(in srgb, var(--border) 55%, transparent);
        border-radius: 24px;
        position: relative;
        border: 1px solid color-mix(in srgb, var(--border) 75%, transparent);
        box-shadow:
          inset 0 1px 0 rgba(255, 255, 255, 0.07),
          inset 0 -1px 0 rgba(0, 0, 0, 0.15);
      }

      /* stronger "premium" frame */
      .schedule-frame {
        position: relative;
        border-radius: 24px;
        overflow: hidden;
      }
      .schedule-frame::before {
        content: "";
        position: absolute;
        inset: -1px;
        background: linear-gradient(
          135deg,
          color-mix(in srgb, var(--accent) 60%, transparent),
          transparent 35%,
          color-mix(in srgb, var(--accent2) 55%, transparent)
        );
        opacity: 0.22;
        filter: blur(0px);
        pointer-events: none;
      }
      .schedule-frame::after {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: 24px;
        box-shadow:
          0 26px 90px rgba(0, 0, 0, 0.35),
          inset 0 1px 0 rgba(255, 255, 255, 0.1);
        pointer-events: none;
      }

      .grid-header,
      .grid-cell {
        background: var(--card-bg);
        padding: 12px;
        min-height: 132px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        position: relative;
      }

      .grid-header {
        min-height: 60px;
        align-items: center;
        justify-content: center;
        font-weight: 900;
        text-shadow: 0 1px 0 rgba(0, 0, 0, 0.16);
        background:
          radial-gradient(
            900px 70px at 50% 0%,
            rgba(255, 255, 255, 0.1),
            transparent 70%
          ),
          linear-gradient(180deg, rgba(0, 0, 0, 0.2), rgba(0, 0, 0, 0.06));
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        z-index: 6;
      }
      .grid-header::after {
        content: "";
        position: absolute;
        right: 10px;
        left: 10px;
        bottom: 0;
        height: 1px;
        background: linear-gradient(
          90deg,
          transparent,
          color-mix(in srgb, var(--accent2) 45%, transparent),
          transparent
        );
        opacity: 0.7;
      }
      body[data-theme="mono"] .grid-header,
      body[data-theme="editorial"] .grid-header,
      body[data-theme="material"] .grid-header {
        background: rgba(255, 255, 255, 0.9);
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      }

      .sticky-top {
        position: sticky;
        top: 0;
        z-index: 8;
      }
      .time-col {
        position: sticky;
        right: 0;
        z-index: 9;
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
      }

      .time-slot {
        min-height: 132px;
        align-items: center;
        justify-content: center;
        font-family: var(--font-en);
        font-variant-numeric: tabular-nums;
        font-weight: 900;
        font-size: 12px;
        letter-spacing: 0.02em;
        border-left: 1px solid rgba(255, 255, 255, 0.06);
        background:
          radial-gradient(
            700px 120px at 50% 10%,
            rgba(255, 255, 255, 0.1),
            transparent 70%
          ),
          linear-gradient(
            180deg,
            rgba(255, 255, 255, 0.06),
            rgba(255, 255, 255, 0.02)
          );
      }
      body[data-theme="mono"] .time-slot,
      body[data-theme="editorial"] .time-slot,
      body[data-theme="material"] .time-slot {
        border-left: 1px solid rgba(0, 0, 0, 0.08);
        background: rgba(255, 255, 255, 0.9);
      }

      .grid-cell {
        cursor: pointer;
        isolation: isolate;
        transition:
          transform 0.12s ease,
          filter 0.18s ease,
          background-color 0.2s ease;
        background:
          radial-gradient(
            700px 220px at 40% 0%,
            rgba(255, 255, 255, 0.08),
            transparent 70%
          ),
          linear-gradient(
            180deg,
            rgba(255, 255, 255, 0.04),
            rgba(255, 255, 255, 0.02)
          );
      }
      body[data-theme="mono"] .grid-cell,
      body[data-theme="editorial"] .grid-cell,
      body[data-theme="material"] .grid-cell {
        background: rgba(255, 255, 255, 0.88);
      }

      /* row/col highlight */
      .grid-cell::after {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.22s ease;
        background: radial-gradient(
          700px 260px at 50% 15%,
          color-mix(in srgb, var(--accent) 20%, transparent),
          transparent 70%
        );
      }
      .grid-cell.hl::after {
        opacity: 1;
      }
      .grid-cell:hover {
        transform: translateY(-1px);
        filter: brightness(1.06);
      }

      /* "+ add" hint on empty cell hover */
      .grid-cell .add-ghost {
        position: absolute;
        left: 10px;
        bottom: 10px;
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 900;
        opacity: 0;
        transform: translateY(4px);
        transition:
          opacity 0.18s ease,
          transform 0.18s ease;
        border: 1px dashed color-mix(in srgb, var(--accent) 55%, transparent);
        background: color-mix(in srgb, var(--card-bg) 80%, transparent);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }
      .grid-cell:hover .add-ghost {
        opacity: 0.85;
        transform: translateY(0);
      }

      /* class card (premium) */
      .class-card {
        position: relative;
        border-radius: 18px;
        padding: 12px 12px 10px;
        overflow: hidden;
        border: 1px solid color-mix(in srgb, var(--border) 65%, transparent);
        background:
          radial-gradient(
            700px 220px at 20% 0%,
            rgba(255, 255, 255, 0.12),
            transparent 60%
          ),
          linear-gradient(180deg, rgba(0, 0, 0, 0.22), rgba(0, 0, 0, 0.1));
        backdrop-filter: blur(14px);
        -webkit-backdrop-filter: blur(14px);
        box-shadow:
          0 8px 20px rgba(0, 0, 0, 0.2),
          inset 0 1px 0 rgba(255, 255, 255, 0.12);
        transition:
          transform 0.12s ease,
          filter 0.18s ease,
          border-color 0.18s ease;
      }
      body[data-theme="mono"] .class-card,
      body[data-theme="editorial"] .class-card,
      body[data-theme="material"] .class-card {
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(0, 0, 0, 0.1);
      }

      .class-card::before {
        content: "";
        position: absolute;
        inset: -1px;
        background: linear-gradient(
          135deg,
          color-mix(in srgb, var(--accent) 30%, transparent),
          transparent 35%,
          color-mix(in srgb, var(--accent2) 26%, transparent)
        );
        opacity: 0.35;
        pointer-events: none;
      }
      .class-card::after {
        content: "";
        position: absolute;
        inset: 0;
        background: radial-gradient(
          800px 200px at 20% 0%,
          rgba(255, 255, 255, 0.12),
          transparent 60%
        );
        opacity: 0.7;
        pointer-events: none;
      }
      .class-card:hover {
        transform: translateY(-1px) scale(1.012);
        border-color: color-mix(in srgb, var(--accent) 35%, var(--border));
        filter: brightness(1.05);
      }
      .class-title {
        font-weight: 950;
        font-size: 12.5px;
        line-height: 1.5;
        position: relative;
        z-index: 1;
      }
      .class-meta {
        font-size: 10.5px;
        opacity: 0.82;
        position: relative;
        z-index: 1;
      }
      .class-foot {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-top: 10px;
        position: relative;
        z-index: 1;
      }

      /* Mobile schedule cards */
      .mobile-schedule-board {
        display: grid;
        gap: 14px;
      }
      .mobile-schedule-board .schedule-hint {
        margin-bottom: 2px;
      }
      .mobile-day-card {
        position: relative;
        padding: 14px;
        border-radius: 22px;
        border: 1px solid color-mix(in srgb, var(--border) 78%, transparent);
        background:
          linear-gradient(
            165deg,
            color-mix(in srgb, var(--accent) 12%, transparent),
            transparent 42%,
            color-mix(in srgb, var(--accent2) 10%, transparent)
          ),
          color-mix(in srgb, var(--card-bg) 88%, transparent);
        overflow: hidden;
      }
      .mobile-day-card::before {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        border-radius: inherit;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.12),
          rgba(255, 255, 255, 0) 36%
        );
        opacity: 0.72;
      }
      .mobile-day-card--today {
        border-color: color-mix(in srgb, var(--accent) 52%, var(--border));
        box-shadow:
          0 16px 36px rgba(0, 0, 0, 0.24),
          inset 0 0 0 1px color-mix(in srgb, var(--accent2) 24%, transparent);
      }
      .mobile-day-head {
        position: relative;
        z-index: 1;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 10px;
      }
      .mobile-day-title-wrap {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .mobile-day-title {
        font-size: 1rem;
        font-weight: 950;
        letter-spacing: 0.01em;
      }
      .mobile-today-pill {
        border-radius: 999px;
        padding: 2px 8px;
        font-size: 10px;
        font-weight: 900;
        border: 1px solid color-mix(in srgb, var(--accent2) 46%, transparent);
        background: color-mix(in srgb, var(--accent) 18%, transparent);
      }
      .mobile-day-head-right {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .mobile-add-btn {
        border: 1px solid color-mix(in srgb, var(--accent) 42%, var(--border));
        background: color-mix(in srgb, var(--card-bg) 78%, transparent);
        color: var(--text);
        border-radius: 999px;
        font-size: 11px;
        font-weight: 900;
        padding: 6px 11px;
        transition:
          transform 0.14s ease,
          filter 0.18s ease;
      }
      .mobile-add-btn:active {
        transform: scale(0.98);
      }
      .mobile-day-meta {
        position: relative;
        z-index: 1;
        margin-bottom: 8px;
      }
      .mobile-day-classes {
        position: relative;
        z-index: 1;
        display: grid;
        gap: 10px;
      }
      .mobile-day-classes::before {
        content: "";
        position: absolute;
        top: 4px;
        bottom: 4px;
        right: 4px;
        width: 2px;
        border-radius: 999px;
        background: linear-gradient(
          180deg,
          color-mix(in srgb, var(--accent2) 36%, transparent),
          transparent 88%
        );
        opacity: 0.7;
        pointer-events: none;
      }
      .mobile-empty-slot {
        width: 100%;
        border: 1px dashed color-mix(in srgb, var(--accent2) 48%, var(--border));
        background: color-mix(in srgb, var(--card-bg) 70%, transparent);
        color: var(--text);
        border-radius: 14px;
        font-size: 12px;
        font-weight: 900;
        padding: 10px 12px;
        text-align: center;
        opacity: 0.9;
      }
      .mobile-class-card {
        position: relative;
        border: 1px solid color-mix(in srgb, var(--border) 76%, transparent);
        background:
          radial-gradient(
            700px 180px at 20% 0%,
            rgba(255, 255, 255, 0.1),
            transparent 65%
          ),
          color-mix(in srgb, var(--card-bg) 84%, transparent);
        border-radius: 16px;
        padding: 11px 11px 11px 14px;
        transition:
          transform 0.12s ease,
          filter 0.18s ease;
        overflow: hidden;
      }
      .mobile-class-card::before {
        content: "";
        position: absolute;
        top: 10px;
        bottom: 10px;
        right: 0;
        width: 3px;
        border-radius: 999px;
        background: color-mix(in srgb, var(--accent2) 76%, transparent);
        opacity: 0.8;
      }
      .mobile-class-card::after {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.18),
          rgba(255, 255, 255, 0) 34%
        );
        opacity: 0.55;
      }
      .mobile-class-card.is-now {
        border-color: color-mix(in srgb, var(--accent) 64%, var(--border));
        box-shadow:
          0 14px 26px rgba(0, 0, 0, 0.24),
          0 0 0 1px color-mix(in srgb, var(--accent2) 28%, transparent) inset;
      }
      .mobile-class-card.is-upcoming {
        border-color: color-mix(in srgb, var(--accent2) 48%, var(--border));
      }
      .mobile-class-card.is-past {
        opacity: 0.8;
      }
      .mobile-class-card:active {
        transform: scale(0.992);
      }
      .mobile-class-top {
        position: relative;
        z-index: 1;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        margin-bottom: 6px;
      }
      .mobile-class-time {
        font-family: var(--font-en);
        font-size: 11px;
        font-weight: 900;
        opacity: 0.92;
        border: 1px solid color-mix(in srgb, var(--border) 68%, transparent);
        border-radius: 999px;
        padding: 2px 7px;
      }
      .mobile-class-title {
        position: relative;
        z-index: 1;
        font-size: 12.5px;
        font-weight: 950;
        line-height: 1.45;
      }
      .mobile-class-prof {
        position: relative;
        z-index: 1;
        font-size: 10.5px;
        opacity: 0.76;
        margin-top: 2px;
      }
      .mobile-class-note {
        position: relative;
        z-index: 1;
        font-size: 10px;
        opacity: 0.78;
        margin-top: 4px;
      }
      .mobile-class-foot {
        position: relative;
        z-index: 1;
        margin-top: 8px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }
      .mobile-state-chip {
        border-radius: 999px;
        padding: 2px 9px;
        font-size: 10px;
        font-weight: 900;
        border: 1px solid color-mix(in srgb, var(--border) 70%, transparent);
        background: color-mix(in srgb, var(--card-bg) 80%, transparent);
      }
      .mobile-state-chip.state-now {
        border-color: color-mix(in srgb, var(--accent) 62%, transparent);
        background: color-mix(in srgb, var(--accent) 18%, transparent);
      }
      .mobile-state-chip.state-upcoming {
        border-color: color-mix(in srgb, var(--accent2) 52%, transparent);
        background: color-mix(in srgb, var(--accent2) 16%, transparent);
      }
      .mobile-state-chip.state-past {
        opacity: 0.75;
      }
      .mobile-class-unit {
        font-size: 10px;
        font-weight: 900;
        opacity: 0.76;
      }
      .mobile-class-conflict {
        position: relative;
        z-index: 1;
        margin-top: 6px;
        color: #ef4444;
        font-size: 10px;
        font-weight: 900;
      }

      /* mobile */
      @media (max-width: 1024px) {
        .schedule-grid {
          display: flex;
          flex-direction: column;
          gap: 14px;
          background: transparent;
          border-radius: 0;
        }
        .grid-header {
          display: none;
        }
        .grid-cell {
          border-radius: 18px;
          min-height: auto;
        }
        .time-col {
          position: static;
        }
        .time-slot {
          border-radius: 18px;
          border-left: none;
        }
        .mobile-day-header {
          display: block;
          font-size: 1.05rem;
          font-weight: 950;
          margin-bottom: 0.5rem;
        }
        .grid-cell .add-ghost {
          display: none;
        }
        .schedule-frame::before,
        .schedule-frame::after {
          display: none;
        }
      }
      @media (min-width: 1024px) {
        .mobile-day-header {
          display: none;
        }
      }

      /* ------------------------------
      UI Mode Switch (Auto/Desktop/Mobile)
    ------------------------------ */
      body[data-ui-mode="mobile"] #appLayout {
        max-width: 820px;
        gap: 14px;
        padding: 10px;
      }
      body[data-ui-mode="mobile"] .top-nav,
      body[data-ui-mode="mobile"] #sidePanel,
      body[data-ui-mode="mobile"] #mainPanel {
        grid-column: 1 / -1 !important;
      }
      body[data-ui-mode="mobile"] .top-nav {
        top: 8px;
        padding: 0.75rem;
      }
      body[data-ui-mode="mobile"] .pinned-alerts-bar {
        top: 72px;
        width: calc(100% - 14px);
      }
      body[data-ui-mode="mobile"].has-pinned-alerts #appLayout {
        margin-top: 64px;
      }
      body[data-ui-mode="mobile"] .top-nav > div:last-child {
        width: 100%;
        gap: 0.5rem;
      }
      body[data-ui-mode="mobile"] .top-nav .week-toggle {
        width: 100%;
        justify-content: space-between;
      }
      body[data-ui-mode="mobile"] .top-nav .control-surface {
        flex: 1 1 calc(50% - 0.5rem);
        min-width: 122px;
      }
      body[data-ui-mode="mobile"] .top-nav .control-btn {
        flex: 0 0 auto;
      }
      body[data-ui-mode="mobile"] .side-widget {
        height: auto !important;
      }
      body[data-ui-mode="mobile"] #examList,
      body[data-ui-mode="mobile"] #noteList,
      body[data-ui-mode="mobile"] #alertList,
      body[data-ui-mode="mobile"] #courseProgressList {
        max-height: 240px;
      }
      body[data-ui-mode="mobile"] .schedule-grid {
        display: flex;
        flex-direction: column;
        gap: 14px;
        background: transparent;
        border-radius: 0;
      }
      body[data-ui-mode="mobile"] .grid-header {
        display: none;
      }
      body[data-ui-mode="mobile"] .grid-cell {
        border-radius: 18px;
        min-height: auto;
      }
      body[data-ui-mode="mobile"] .time-col {
        position: static;
      }
      body[data-ui-mode="mobile"] .time-slot {
        border-radius: 18px;
        border-left: none;
      }
      body[data-ui-mode="mobile"] .mobile-day-header {
        display: block;
        font-size: 1.05rem;
        font-weight: 950;
        margin-bottom: 0.5rem;
      }
      body[data-ui-mode="mobile"] .grid-cell .add-ghost {
        display: none;
      }
      body[data-ui-mode="mobile"] .schedule-frame::before,
      body[data-ui-mode="mobile"] .schedule-frame::after {
        display: none;
      }

      body[data-ui-mode="desktop"] {
        overflow-x: auto;
      }
      body[data-ui-mode="desktop"] #appLayout {
        min-width: 1240px;
      }
      body[data-ui-mode="desktop"] #sidePanel {
        grid-column: span 3 / span 3 !important;
      }
      body[data-ui-mode="desktop"] #mainPanel {
        grid-column: span 9 / span 9 !important;
      }
      body[data-ui-mode="desktop"] .schedule-grid {
        display: grid !important;
        grid-template-columns: 106px repeat(6, minmax(190px, 1fr));
        gap: 1px;
        background: color-mix(in srgb, var(--border) 55%, transparent);
        border-radius: 24px;
      }
      body[data-ui-mode="desktop"] .grid-header {
        display: flex !important;
      }
      body[data-ui-mode="desktop"] .grid-cell {
        min-height: 132px;
        border-radius: 0;
      }
      body[data-ui-mode="desktop"] .time-col {
        position: sticky;
        right: 0;
      }
      body[data-ui-mode="desktop"] .time-slot {
        border-radius: 0;
        border-left: 1px solid rgba(255, 255, 255, 0.06);
      }
      body[data-theme="mono"][data-ui-mode="desktop"] .time-slot,
      body[data-theme="editorial"][data-ui-mode="desktop"] .time-slot,
      body[data-theme="material"][data-ui-mode="desktop"] .time-slot {
        border-left: 1px solid rgba(0, 0, 0, 0.08);
      }
      body[data-ui-mode="desktop"] .mobile-day-header {
        display: none !important;
      }
      body[data-ui-mode="desktop"] .grid-cell .add-ghost {
        display: block;
      }
      body[data-ui-mode="desktop"] .schedule-frame::before,
      body[data-ui-mode="desktop"] .schedule-frame::after {
        display: block;
      }

      /* ------------------------------
      Premium polish overrides
    ------------------------------ */
      .theme-card {
        border: 1px solid color-mix(in srgb, var(--border) 72%, transparent);
        box-shadow:
          0 20px 52px rgba(0, 0, 0, 0.24),
          inset 0 1px 0 rgba(255, 255, 255, 0.11);
      }
      .theme-card::after {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        border-radius: inherit;
        border: 1px solid color-mix(in srgb, var(--accent2) 24%, transparent);
        opacity: 0.4;
        z-index: 0;
      }
      .theme-card:hover {
        transform: translateY(-2px);
        box-shadow:
          0 28px 70px rgba(0, 0, 0, 0.3),
          inset 0 1px 0 rgba(255, 255, 255, 0.14);
      }
      nav.theme-card:hover {
        transform: none;
      }
      aside .theme-card {
        border-radius: 24px;
        backdrop-filter: blur(18px);
        -webkit-backdrop-filter: blur(18px);
      }
      aside .theme-card h3,
      aside .theme-card h4 {
        letter-spacing: 0.01em;
        text-shadow: 0 1px 0 rgba(0, 0, 0, 0.12);
      }
      #nextClassContainer h3 {
        font-size: 1.28rem;
      }
      #nextClassContainer .next-live-meta {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border-radius: 999px;
        padding: 4px 10px;
        margin-bottom: 10px;
        border: 1px solid color-mix(in srgb, var(--border) 76%, transparent);
        background: color-mix(in srgb, var(--card-bg) 82%, transparent);
        font-size: 11px;
        font-weight: 900;
      }
      #nextClassContainer .next-now-chip {
        border-radius: 999px;
        padding: 2px 8px;
        background: color-mix(in srgb, var(--accent2) 20%, transparent);
        border: 1px solid color-mix(in srgb, var(--accent2) 44%, transparent);
        font-size: 10px;
      }
      #nextClassContainer .next-class-no-wrap {
        margin-top: 8px;
        margin-bottom: 10px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border-radius: 14px;
        padding: 6px 10px;
        border: 1px solid rgba(56, 189, 248, 0.58);
        background: linear-gradient(
          125deg,
          rgba(6, 182, 212, 0.34),
          rgba(37, 99, 235, 0.28)
        );
        box-shadow:
          0 10px 20px rgba(8, 47, 73, 0.3),
          inset 0 1px 0 rgba(255, 255, 255, 0.2);
      }
      #nextClassContainer .next-class-no-label {
        font-size: 10px;
        font-weight: 900;
        color: #e0f2fe;
      }
      #nextClassContainer .next-class-no-badge {
        font-family: var(--font-time);
        font-size: 1rem;
        font-weight: 800;
        letter-spacing: 0.04em;
        color: #ecfeff;
        border-radius: 999px;
        padding: 4px 11px;
        border: 1px solid rgba(125, 211, 252, 0.5);
        background: rgba(15, 23, 42, 0.35);
      }
      #nextClassContainer .next-countdown {
        margin-top: 10px;
        display: inline-block;
        border-radius: 999px;
        padding: 4px 10px;
        border: 1px solid color-mix(in srgb, var(--accent) 46%, transparent);
        background: color-mix(in srgb, var(--accent) 15%, transparent);
        font-size: 11px;
        font-weight: 900;
      }
      #nextClassContainer .next-next-at {
        margin-top: 8px;
        font-size: 11px;
        opacity: 0.84;
      }
      #nextClassContainer .next-time-panel {
        margin-top: 8px;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        border-radius: 14px;
        padding: 7px 10px;
        border: 1px solid color-mix(in srgb, var(--accent2) 44%, transparent);
        background: color-mix(in srgb, var(--card-bg) 82%, transparent);
      }
      #nextClassContainer .next-time-clock {
        font-family: var(--font-time);
        font-size: 1.16rem;
        letter-spacing: 0.04em;
        font-weight: 700;
        border-radius: 10px;
        padding: 4px 9px;
        border: 1px solid color-mix(in srgb, var(--accent) 42%, transparent);
        background: linear-gradient(
          130deg,
          color-mix(in srgb, var(--accent) 24%, transparent),
          color-mix(in srgb, var(--accent2) 16%, transparent)
        );
      }
      #nextClassContainer .next-time-date {
        font-size: 11px;
        opacity: 0.84;
      }
      #nextClassContainer .next-minute-left {
        margin-top: 8px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border-radius: 999px;
        padding: 5px 12px;
        border: 1px solid color-mix(in srgb, var(--accent2) 44%, transparent);
        background: color-mix(in srgb, var(--accent2) 16%, transparent);
        font-size: 11px;
        font-weight: 900;
      }
      #nextClassContainer .next-minute-num {
        font-family: var(--font-time);
        letter-spacing: 0.04em;
        font-size: 0.95rem;
      }
      .pinned-alerts-bar {
        position: fixed;
        top: 86px;
        left: 50%;
        transform: translateX(-50%);
        width: min(980px, calc(100% - 20px));
        z-index: 45;
        display: flex;
        flex-direction: column;
        gap: 8px;
        pointer-events: none;
      }
      .pinned-alerts-bar.hidden {
        display: none !important;
      }
      .pinned-alert-item {
        width: 100%;
        appearance: none;
        text-align: right;
        color: var(--text);
        pointer-events: auto;
        border-radius: 16px;
        border: 1px solid rgba(239, 68, 68, 0.36);
        background: linear-gradient(
          145deg,
          rgba(239, 68, 68, 0.2),
          rgba(185, 28, 28, 0.08) 40%,
          color-mix(in srgb, var(--card-bg) 84%, transparent)
        );
        backdrop-filter: blur(14px);
        -webkit-backdrop-filter: blur(14px);
        box-shadow:
          0 12px 28px rgba(0, 0, 0, 0.26),
          inset 0 1px 0 rgba(255, 255, 255, 0.14);
        padding: 10px 14px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 14px;
      }
      .pinned-alert-item--note {
        border-color: rgba(239, 68, 68, 0.5);
      }
      .pinned-alert-main-btn {
        width: 100%;
        min-width: 0;
        appearance: none;
        border: 0;
        background: transparent;
        color: inherit;
        text-align: right;
        padding: 0;
        cursor: pointer;
      }
      .pinned-alert-main-btn:focus-visible {
        outline: 2px solid color-mix(in srgb, var(--accent2) 56%, transparent);
        outline-offset: 3px;
        border-radius: 10px;
      }
      .pinned-alert-main {
        min-width: 0;
        display: flex;
        flex-direction: column;
      }
      .pinned-alert-title {
        display: block;
        font-size: 13px;
        font-weight: 900;
        line-height: 1.65;
      }
      .pinned-alert-sub {
        display: block;
        margin-top: 3px;
        font-size: 11px;
        opacity: 0.9;
      }
      .pinned-alert-icon {
        flex: 0 0 auto;
        width: 26px;
        height: 26px;
        border-radius: 999px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 13px;
        border: 1px solid rgba(239, 68, 68, 0.42);
        background: rgba(239, 68, 68, 0.16);
      }
      .pinned-alert-item--food {
        border-color: rgba(220, 38, 38, 0.56);
        background: linear-gradient(
          145deg,
          rgba(248, 113, 113, 0.32),
          rgba(239, 68, 68, 0.2) 42%,
          rgba(127, 29, 29, 0.18)
        );
        border-radius: 18px;
        padding: 13px 16px;
        box-shadow:
          0 14px 30px rgba(127, 29, 29, 0.28),
          inset 0 1px 0 rgba(255, 255, 255, 0.22);
      }
      .pinned-alert-item--food .pinned-alert-title {
        font-size: 15px;
        line-height: 1.5;
      }
      .pinned-alert-item--food .pinned-alert-sub {
        font-size: 12px;
        margin-top: 4px;
        opacity: 0.9;
      }
      .pinned-alert-actions {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        flex: 0 0 auto;
      }
      .pinned-alert-icon--food {
        width: 34px;
        height: 34px;
        font-size: 17px;
        border-color: rgba(220, 38, 38, 0.64);
        background: rgba(220, 38, 38, 0.28);
      }
      .pinned-alert-close {
        width: 30px;
        height: 30px;
        border-radius: 999px;
        border: 1px solid rgba(248, 113, 113, 0.58);
        background: rgba(127, 29, 29, 0.2);
        color: #fee2e2;
        font-size: 20px;
        line-height: 1;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }
      .pinned-alert-close:hover {
        background: rgba(127, 29, 29, 0.36);
      }
      body.has-pinned-alerts #appLayout {
        margin-top: 58px;
      }
      #examList > div,
      #noteList > div,
      #alertList > div,
      #courseProgressList > div {
        position: relative;
        overflow: hidden;
        border-radius: 18px !important;
        border: 1px solid color-mix(in srgb, var(--border) 82%, transparent) !important;
        box-shadow:
          0 10px 26px rgba(0, 0, 0, 0.2),
          inset 0 1px 0 rgba(255, 255, 255, 0.1);
        transition:
          transform 0.16s ease,
          box-shadow 0.2s ease,
          border-color 0.2s ease;
      }
      #alertList .alert-card-title {
        font-size: 13px;
        line-height: 1.7;
        font-weight: 900;
      }
      #alertList .alert-card-meta {
        font-size: 11px;
        line-height: 1.65;
        opacity: 0.9;
      }
      #alertList .alert-card-highlight {
        font-size: 12px;
        line-height: 1.75;
        font-weight: 800;
      }
      #examList > div::before,
      #noteList > div::before,
      #alertList > div::before,
      #courseProgressList > div::before {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(
          140deg,
          color-mix(in srgb, var(--accent) 18%, transparent),
          transparent 44%,
          color-mix(in srgb, var(--accent2) 16%, transparent)
        );
        opacity: 0.55;
        pointer-events: none;
      }
      #examList > div:hover,
      #noteList > div:hover,
      #alertList > div:hover,
      #courseProgressList > div:hover {
        transform: translateY(-2px);
        border-color: color-mix(
          in srgb,
          var(--accent2) 36%,
          var(--border)
        ) !important;
        box-shadow:
          0 16px 35px rgba(0, 0, 0, 0.26),
          inset 0 1px 0 rgba(255, 255, 255, 0.12);
      }
      .course-progress-stats {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 8px;
        margin-bottom: 10px;
      }
      .course-progress-stat {
        border-radius: 14px;
        border: 1px solid color-mix(in srgb, var(--border) 80%, transparent);
        background: color-mix(in srgb, var(--card-bg) 86%, transparent);
        padding: 7px 8px;
        text-align: center;
      }
      .course-progress-stat .value {
        font-size: 12px;
        font-weight: 900;
        line-height: 1.2;
      }
      .course-progress-stat .label {
        margin-top: 2px;
        font-size: 10px;
        opacity: 0.68;
        font-weight: 800;
      }
      .course-progress-line {
        width: 100%;
        height: 8px;
        border-radius: 999px;
        border: 1px solid color-mix(in srgb, var(--border) 70%, transparent);
        background: color-mix(in srgb, var(--bg) 45%, transparent);
        overflow: hidden;
      }
      .course-progress-line > span {
        display: block;
        height: 100%;
        border-radius: inherit;
        width: var(--progress, 0%);
        background: linear-gradient(
          90deg,
          color-mix(in srgb, var(--accent) 82%, #ffffff 18%),
          color-mix(in srgb, var(--accent2) 84%, #ffffff 16%)
        );
        box-shadow: 0 0 14px color-mix(in srgb, var(--accent2) 34%, transparent);
      }
      body[data-style-pack="ultra"] .course-progress-stat {
        border-color: color-mix(in srgb, var(--accent2) 32%, var(--border));
      }
      body[data-style-pack="ultra"] .course-progress-line {
        border-color: color-mix(in srgb, var(--accent2) 28%, var(--border));
      }

      .schedule-frame::before {
        opacity: 0.34;
        background-size: 170% 170%;
        animation: frameFlow 9s ease-in-out infinite;
      }
      @keyframes frameFlow {
        0% {
          background-position: 0% 30%;
        }
        50% {
          background-position: 100% 70%;
        }
        100% {
          background-position: 0% 30%;
        }
      }
      .schedule-shell {
        position: relative;
        padding: 1.5px;
        background: linear-gradient(
          140deg,
          color-mix(in srgb, var(--accent) 42%, transparent),
          transparent 30%,
          color-mix(in srgb, var(--accent2) 40%, transparent)
        );
      }
      .schedule-shell::before {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: inherit;
        pointer-events: none;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.12),
          rgba(255, 255, 255, 0) 28%
        );
        opacity: 0.65;
      }
      .schedule-grid {
        border: 1px solid color-mix(in srgb, var(--border) 88%, transparent);
        box-shadow:
          inset 0 1px 0 rgba(255, 255, 255, 0.08),
          inset 0 -1px 0 rgba(0, 0, 0, 0.18),
          0 28px 80px rgba(0, 0, 0, 0.28);
      }
      .grid-header {
        letter-spacing: 0.03em;
        font-size: 12.5px;
        text-transform: uppercase;
      }
      .grid-cell {
        border: 1px solid transparent;
      }
      .grid-cell.hl {
        border-color: color-mix(in srgb, var(--accent) 34%, transparent);
      }
      .grid-cell:hover {
        transform: translateY(-2px);
        border-color: color-mix(in srgb, var(--accent2) 30%, transparent);
      }
      .time-slot {
        border-left: 1px solid
          color-mix(in srgb, var(--accent2) 22%, transparent);
      }
      .class-card {
        border-radius: 20px;
        box-shadow:
          0 12px 30px rgba(0, 0, 0, 0.24),
          inset 0 1px 0 rgba(255, 255, 255, 0.14);
      }
      .class-card::before {
        opacity: 0.42;
      }
      .class-card .badge {
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.26);
      }
      .class-title {
        font-size: 13px;
        letter-spacing: 0.01em;
      }

      body[data-style-pack="ultra"] .theme-card {
        border-color: color-mix(in srgb, var(--accent2) 34%, var(--border));
        box-shadow:
          0 30px 86px rgba(0, 0, 0, 0.34),
          inset 0 1px 0 rgba(255, 255, 255, 0.16);
      }
      body[data-style-pack="ultra"] .theme-card::after {
        opacity: 0.72;
        border-color: color-mix(in srgb, var(--accent2) 40%, transparent);
      }
      body[data-style-pack="ultra"] aside .theme-card {
        border-radius: 26px;
      }
      body[data-style-pack="ultra"] .logo-badge {
        box-shadow:
          0 16px 36px rgba(0, 0, 0, 0.34),
          inset 0 1px 0 rgba(255, 255, 255, 0.42);
      }
      body[data-style-pack="ultra"] .logo-badge::after {
        animation-duration: 4.6s;
      }
      body[data-style-pack="ultra"] .schedule-frame::before {
        opacity: 0.5;
        animation-duration: 6.2s;
      }
      body[data-style-pack="ultra"] .schedule-frame::after {
        box-shadow:
          0 34px 100px rgba(0, 0, 0, 0.42),
          inset 0 1px 0 rgba(255, 255, 255, 0.14);
      }
      body[data-style-pack="ultra"] .schedule-grid {
        border-color: color-mix(in srgb, var(--accent2) 30%, var(--border));
        box-shadow:
          inset 0 1px 0 rgba(255, 255, 255, 0.1),
          inset 0 -1px 0 rgba(0, 0, 0, 0.2),
          0 40px 98px rgba(0, 0, 0, 0.34);
      }
      body[data-style-pack="ultra"] .grid-header {
        font-size: 13px;
        letter-spacing: 0.055em;
      }
      body[data-style-pack="ultra"] .grid-cell.hl::after {
        opacity: 1;
      }
      body[data-style-pack="ultra"] .class-card {
        border-color: color-mix(in srgb, var(--accent) 28%, var(--border));
        box-shadow:
          0 18px 34px rgba(0, 0, 0, 0.3),
          inset 0 1px 0 rgba(255, 255, 255, 0.16);
      }
      body[data-style-pack="ultra"] .class-card:hover {
        transform: translateY(-2px) scale(1.018);
        filter: brightness(1.09);
      }
      body[data-style-pack="ultra"] #examList > div,
      body[data-style-pack="ultra"] #noteList > div,
      body[data-style-pack="ultra"] #alertList > div,
      body[data-style-pack="ultra"] #courseProgressList > div {
        border-color: color-mix(
          in srgb,
          var(--accent2) 32%,
          var(--border)
        ) !important;
      }
      body[data-style-pack="ultra"] #examList > div::before,
      body[data-style-pack="ultra"] #noteList > div::before,
      body[data-style-pack="ultra"] #alertList > div::before,
      body[data-style-pack="ultra"] #courseProgressList > div::before {
        opacity: 0.82;
      }
      body[data-style-pack="ultra"] #examList > div:hover,
      body[data-style-pack="ultra"] #noteList > div:hover,
      body[data-style-pack="ultra"] #alertList > div:hover,
      body[data-style-pack="ultra"] #courseProgressList > div:hover {
        transform: translateY(-3px);
      }
      @keyframes ultraAuraDrift {
        0% {
          transform: translate3d(0, 0, 0) scale(1);
          opacity: 0.42;
        }
        50% {
          transform: translate3d(14px, -10px, 0) scale(1.03);
          opacity: 0.66;
        }
        100% {
          transform: translate3d(0, 0, 0) scale(1);
          opacity: 0.42;
        }
      }
      @keyframes ultraLineFlow {
        0% {
          background-position: 0% 35%;
        }
        50% {
          background-position: 100% 65%;
        }
        100% {
          background-position: 0% 35%;
        }
      }
      @keyframes ultraSheenSweep {
        0% {
          transform: translateX(-140%);
        }
        100% {
          transform: translateX(220%);
        }
      }
      body[data-style-pack="ultra"] #appLayout {
        position: relative;
        isolation: isolate;
      }
      body[data-style-pack="ultra"] #appLayout::before {
        content: "";
        position: absolute;
        inset: -18px -16px;
        border-radius: 34px;
        pointer-events: none;
        z-index: -1;
        background:
          radial-gradient(
            900px 260px at 8% 0%,
            color-mix(in srgb, var(--accent) 24%, transparent),
            transparent 65%
          ),
          radial-gradient(
            1000px 280px at 92% 100%,
            color-mix(in srgb, var(--accent2) 24%, transparent),
            transparent 66%
          );
        filter: blur(3px);
        animation: ultraAuraDrift 10.8s ease-in-out infinite;
      }
      body[data-style-pack="ultra"] .top-nav {
        border-radius: 28px;
        border-color: color-mix(in srgb, var(--accent2) 40%, var(--border));
        background: color-mix(in srgb, var(--bg) 74%, transparent) !important;
        backdrop-filter: blur(24px);
        -webkit-backdrop-filter: blur(24px);
        box-shadow:
          0 26px 58px rgba(0, 0, 0, 0.33),
          inset 0 1px 0 rgba(255, 255, 255, 0.22);
      }
      body[data-style-pack="ultra"] .top-nav::before {
        opacity: 0.78;
      }
      body[data-style-pack="ultra"] .top-nav::after {
        border-width: 1.25px;
        border-color: color-mix(in srgb, var(--accent2) 52%, transparent);
      }
      body[data-style-pack="ultra"] .top-nav .control-surface,
      body[data-style-pack="ultra"] .top-nav .control-btn,
      body[data-style-pack="ultra"] .top-nav .week-toggle {
        border-color: color-mix(
          in srgb,
          var(--accent2) 34%,
          var(--border)
        ) !important;
        box-shadow:
          0 10px 20px rgba(0, 0, 0, 0.18),
          inset 0 1px 0 rgba(255, 255, 255, 0.14);
      }
      body[data-style-pack="ultra"] .top-nav .control-btn:hover,
      body[data-style-pack="ultra"] .top-nav .control-surface:focus {
        border-color: color-mix(
          in srgb,
          var(--accent2) 58%,
          var(--border)
        ) !important;
      }
      body[data-style-pack="ultra"] .tools-panel {
        border-radius: 24px;
        border-color: color-mix(in srgb, var(--accent2) 30%, var(--border));
      }
      body[data-style-pack="ultra"] .view-switch {
        border-color: color-mix(in srgb, var(--accent) 30%, var(--border));
      }
      body[data-style-pack="ultra"] .search-input {
        border-color: color-mix(in srgb, var(--accent2) 36%, var(--border));
      }
      body[data-style-pack="ultra"] .add-class-btn {
        position: relative;
        overflow: hidden;
        box-shadow:
          0 14px 34px color-mix(in srgb, var(--accent) 28%, transparent),
          inset 0 1px 0 rgba(255, 255, 255, 0.28);
      }
      body[data-style-pack="ultra"] .add-class-btn::before {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(
          120deg,
          transparent 15%,
          rgba(255, 255, 255, 0.38) 50%,
          transparent 80%
        );
        transform: translateX(-140%);
        animation: ultraSheenSweep 2.7s ease-in-out infinite;
        pointer-events: none;
      }
      body[data-style-pack="ultra"] .profile-card .stat-tile {
        position: relative;
        overflow: hidden;
        border-color: color-mix(in srgb, var(--accent2) 30%, var(--border));
        box-shadow:
          0 12px 26px rgba(0, 0, 0, 0.22),
          inset 0 1px 0 rgba(255, 255, 255, 0.16);
      }
      body[data-style-pack="ultra"] .profile-card .stat-tile::before {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        background: linear-gradient(
          135deg,
          color-mix(in srgb, var(--accent) 18%, transparent),
          transparent 45%,
          color-mix(in srgb, var(--accent2) 15%, transparent)
        );
        opacity: 0.7;
      }
      body[data-style-pack="ultra"] #statUnits,
      body[data-style-pack="ultra"] #statHours,
      body[data-style-pack="ultra"] #statClasses {
        letter-spacing: 0.01em;
        text-shadow: 0 2px 14px
          color-mix(in srgb, var(--accent2) 20%, transparent);
      }
      body[data-style-pack="ultra"] .side-widget {
        border-radius: 26px;
        border-color: color-mix(in srgb, var(--accent2) 34%, var(--border));
      }
      body[data-style-pack="ultra"] .side-widget > div:first-child h4 {
        letter-spacing: 0.03em;
      }
      body[data-style-pack="ultra"] .next-class-card {
        border-right-width: 5px;
      }
      body[data-style-pack="ultra"] .schedule-hint {
        border-radius: 18px;
        border-color: color-mix(in srgb, var(--accent2) 32%, var(--border));
      }
      body[data-style-pack="ultra"] .schedule-grid::before {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        background:
          linear-gradient(
            120deg,
            color-mix(in srgb, var(--accent) 10%, transparent),
            transparent 38%,
            color-mix(in srgb, var(--accent2) 10%, transparent)
          ),
          linear-gradient(
            90deg,
            transparent,
            rgba(255, 255, 255, 0.08),
            transparent
          );
        background-size:
          100% 100%,
          180% 100%;
        background-position:
          0 0,
          0 0;
        opacity: 0.42;
        animation: ultraLineFlow 7.6s ease-in-out infinite;
        z-index: 1;
      }
      body[data-style-pack="ultra"] .schedule-grid > * {
        position: relative;
        z-index: 2;
      }
      body[data-style-pack="ultra"] .grid-header::before {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.16),
          rgba(255, 255, 255, 0)
        );
        opacity: 0.85;
      }
      body[data-style-pack="ultra"] .class-card[data-type="odd"] {
        border-color: rgba(245, 158, 11, 0.45);
        box-shadow:
          0 18px 34px rgba(0, 0, 0, 0.3),
          inset -3px 0 0 rgba(245, 158, 11, 0.85),
          inset 0 1px 0 rgba(255, 255, 255, 0.16);
      }
      body[data-style-pack="ultra"] .class-card[data-type="even"] {
        border-color: rgba(59, 130, 246, 0.44);
        box-shadow:
          0 18px 34px rgba(0, 0, 0, 0.3),
          inset -3px 0 0 rgba(59, 130, 246, 0.88),
          inset 0 1px 0 rgba(255, 255, 255, 0.16);
      }
      body[data-style-pack="ultra"] .class-card[data-type="normal"] {
        border-color: color-mix(in srgb, var(--accent2) 38%, var(--border));
        box-shadow:
          0 18px 34px rgba(0, 0, 0, 0.3),
          inset -3px 0 0 color-mix(in srgb, var(--accent2) 72%, transparent),
          inset 0 1px 0 rgba(255, 255, 255, 0.16);
      }
      body[data-style-pack="ultra"] .list-class-card[data-type="odd"] {
        border-right: 4px solid rgba(245, 158, 11, 0.8) !important;
      }
      body[data-style-pack="ultra"] .list-class-card[data-type="even"] {
        border-right: 4px solid rgba(59, 130, 246, 0.82) !important;
      }
      body[data-style-pack="ultra"] .list-class-card[data-type="normal"] {
        border-right: 4px solid
          color-mix(in srgb, var(--accent2) 64%, transparent) !important;
      }
      body[data-style-pack="ultra"] .class-foot .badge {
        box-shadow:
          inset 0 1px 0 rgba(255, 255, 255, 0.28),
          0 5px 14px rgba(0, 0, 0, 0.18);
      }
      @keyframes ultraNavHalo {
        0% {
          transform: translate3d(0, 0, 0) scale(1);
          opacity: 0.4;
        }
        50% {
          transform: translate3d(-10px, 6px, 0) scale(1.04);
          opacity: 0.72;
        }
        100% {
          transform: translate3d(0, 0, 0) scale(1);
          opacity: 0.4;
        }
      }
      @keyframes ultraPanelFlow {
        0% {
          background-position: 0% 32%;
        }
        50% {
          background-position: 100% 68%;
        }
        100% {
          background-position: 0% 32%;
        }
      }
      @keyframes ultraGlassSweep {
        0% {
          transform: translateX(-140%);
          opacity: 0;
        }
        20% {
          opacity: 0.5;
        }
        100% {
          transform: translateX(220%);
          opacity: 0;
        }
      }
      @keyframes ultraCardLift {
        0% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-2px);
        }
        100% {
          transform: translateY(0);
        }
      }
      body[data-style-pack="ultra"] {
        --ultra-edge: color-mix(in srgb, var(--accent2) 45%, transparent);
        --ultra-fill: color-mix(in srgb, var(--accent) 22%, transparent);
      }
      body[data-style-pack="ultra"] .top-nav {
        overflow: hidden;
      }
      body[data-style-pack="ultra"] .top-nav::before {
        background:
          radial-gradient(
            900px 140px at 12% -10%,
            color-mix(in srgb, var(--accent) 26%, transparent),
            transparent 70%
          ),
          radial-gradient(
            900px 140px at 88% 120%,
            color-mix(in srgb, var(--accent2) 25%, transparent),
            transparent 70%
          );
        animation: ultraNavHalo 8.2s ease-in-out infinite;
      }
      body[data-style-pack="ultra"] .top-nav::after {
        background: linear-gradient(
          135deg,
          color-mix(in srgb, var(--accent) 38%, transparent),
          transparent 35%,
          color-mix(in srgb, var(--accent2) 38%, transparent)
        );
      }
      body[data-style-pack="ultra"] .week-toggle,
      body[data-style-pack="ultra"] .control-surface,
      body[data-style-pack="ultra"] .control-btn {
        background: color-mix(
          in srgb,
          var(--card-bg) 68%,
          transparent
        ) !important;
      }
      body[data-style-pack="ultra"] .week-toggle {
        box-shadow:
          inset 0 1px 0 rgba(255, 255, 255, 0.16),
          0 10px 26px rgba(0, 0, 0, 0.2);
      }
      body[data-style-pack="ultra"] .profile-card,
      body[data-style-pack="ultra"] .side-widget,
      body[data-style-pack="ultra"] .tools-panel {
        position: relative;
        overflow: hidden;
      }
      body[data-style-pack="ultra"] .profile-card::before,
      body[data-style-pack="ultra"] .side-widget::before,
      body[data-style-pack="ultra"] .tools-panel::before {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        background: linear-gradient(
          130deg,
          color-mix(in srgb, var(--accent) 16%, transparent),
          transparent 42%,
          color-mix(in srgb, var(--accent2) 15%, transparent)
        );
        background-size: 180% 180%;
        animation: ultraPanelFlow 7.8s ease-in-out infinite;
        opacity: 0.75;
        z-index: 0;
      }
      body[data-style-pack="ultra"] .profile-card > *,
      body[data-style-pack="ultra"] .side-widget > *,
      body[data-style-pack="ultra"] .tools-panel > * {
        position: relative;
        z-index: 1;
      }
      body[data-style-pack="ultra"] .stat-tile {
        animation: ultraCardLift 5.4s ease-in-out infinite;
      }
      body[data-style-pack="ultra"] .stat-tile:nth-child(2) {
        animation-delay: 0.6s;
      }
      body[data-style-pack="ultra"] .next-class-card {
        border-right-color: color-mix(
          in srgb,
          var(--accent2) 65%,
          var(--accent)
        ) !important;
      }
      body[data-style-pack="ultra"] .schedule-frame {
        isolation: isolate;
      }
      body[data-style-pack="ultra"] .schedule-frame::after {
        border: 1px solid color-mix(in srgb, var(--accent2) 32%, transparent);
      }
      body[data-style-pack="ultra"] .schedule-shell::after {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        border-radius: inherit;
        background: linear-gradient(
          120deg,
          transparent 15%,
          rgba(255, 255, 255, 0.35) 48%,
          transparent 82%
        );
        transform: translateX(-140%);
        animation: ultraGlassSweep 4.8s ease-in-out infinite;
        opacity: 0.5;
      }
      body[data-style-pack="ultra"] .grid-header {
        text-shadow:
          0 1px 0 rgba(0, 0, 0, 0.18),
          0 0 16px color-mix(in srgb, var(--accent2) 22%, transparent);
      }
      body[data-style-pack="ultra"] .time-slot {
        background:
          radial-gradient(
            500px 180px at 50% 0%,
            color-mix(in srgb, var(--accent2) 20%, transparent),
            transparent 70%
          ),
          linear-gradient(
            180deg,
            rgba(255, 255, 255, 0.08),
            rgba(255, 255, 255, 0.02)
          );
      }
      body[data-style-pack="ultra"] .grid-cell::after {
        background: radial-gradient(
          800px 300px at 50% 15%,
          color-mix(in srgb, var(--accent2) 28%, transparent),
          transparent 72%
        );
      }
      body[data-style-pack="ultra"] .grid-cell:hover {
        filter: brightness(1.1);
      }
      body[data-style-pack="ultra"] .class-card {
        backdrop-filter: blur(18px) saturate(1.08);
        -webkit-backdrop-filter: blur(18px) saturate(1.08);
      }
      body[data-style-pack="ultra"] .class-card::after {
        background:
          radial-gradient(
            900px 220px at 0% 0%,
            rgba(255, 255, 255, 0.2),
            transparent 62%
          ),
          linear-gradient(
            130deg,
            color-mix(in srgb, var(--accent2) 12%, transparent),
            transparent 45%
          );
      }
      body[data-style-pack="ultra"] .class-card .class-title {
        text-shadow: 0 0 12px
          color-mix(in srgb, var(--accent2) 14%, transparent);
      }
      body[data-style-pack="ultra"] .class-card:hover .class-title {
        letter-spacing: 0.02em;
      }
      body[data-style-pack="ultra"] .class-foot {
        margin-top: 11px;
      }
      body[data-style-pack="ultra"] .badge {
        border-color: rgba(255, 255, 255, 0.2);
      }
      body[data-style-pack="ultra"] .list-class-card {
        overflow: hidden;
      }
      body[data-style-pack="ultra"] .list-class-card::before {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        background: linear-gradient(
          130deg,
          color-mix(in srgb, var(--accent2) 20%, transparent),
          transparent 42%,
          color-mix(in srgb, var(--accent) 16%, transparent)
        );
        opacity: 0.52;
      }
      body[data-style-pack="ultra"] .list-class-card > * {
        position: relative;
        z-index: 1;
      }
      body[data-style-pack="ultra"] .chip {
        border-color: color-mix(in srgb, var(--accent2) 34%, var(--border));
      }
      body[data-style-pack="ultra"] .inp {
        border-color: color-mix(in srgb, var(--accent2) 32%, var(--border));
        background: color-mix(in srgb, var(--card-bg) 78%, transparent);
      }
      body[data-style-pack="ultra"] .inp:focus {
        box-shadow:
          0 0 0 4px color-mix(in srgb, var(--accent2) 18%, transparent),
          0 10px 26px rgba(0, 0, 0, 0.18);
      }
      body[data-style-pack="ultra"] ::-webkit-scrollbar-thumb {
        background: linear-gradient(
          180deg,
          color-mix(in srgb, var(--accent) 54%, transparent),
          color-mix(in srgb, var(--accent2) 56%, transparent)
        );
      }

      /* Inputs premium */
      .inp {
        width: 100%;
        padding: 0.55rem 0.7rem;
        border-radius: 14px;
        border: 1px solid var(--border);
        background: color-mix(in srgb, var(--card-bg) 70%, transparent);
        color: var(--text);
        outline: none;
        transition:
          border-color 0.18s ease,
          box-shadow 0.18s ease;
      }
      .inp:focus {
        border-color: color-mix(in srgb, var(--accent) 55%, var(--border));
        box-shadow: 0 0 0 4px color-mix(in srgb, var(--accent) 14%, transparent);
      }
      body[data-theme="mono"] .inp,
      body[data-theme="material"] .inp,
      body[data-theme="editorial"] .inp {
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(0, 0, 0, 0.12);
        color: var(--text);
      }
      .class-number-label {
        color: #fb923c;
      }
      .inp-class-number {
        border-color: rgba(251, 146, 60, 0.72);
        background: linear-gradient(
          120deg,
          rgba(251, 146, 60, 0.16),
          rgba(239, 68, 68, 0.12)
        );
      }
      .inp-class-number:focus {
        border-color: rgba(249, 115, 22, 0.94);
        box-shadow: 0 0 0 4px rgba(249, 115, 22, 0.18);
      }

      /* Table polish */
      .schedule-grid::before {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        border-radius: inherit;
        background:
          linear-gradient(
            180deg,
            color-mix(in srgb, var(--accent2) 12%, transparent),
            transparent 26%
          ),
          linear-gradient(
            90deg,
            transparent 0,
            color-mix(in srgb, var(--accent) 6%, transparent) 50%,
            transparent 100%
          );
        opacity: 0.58;
      }
      .grid-header[data-col]::before {
        content: "";
        width: 6px;
        height: 6px;
        border-radius: 999px;
        background: color-mix(in srgb, var(--accent2) 58%, transparent);
        box-shadow: 0 0 10px color-mix(in srgb, var(--accent2) 42%, transparent);
        position: absolute;
        top: 8px;
        right: 12px;
      }
      .class-card-normal {
        border-right: 3px solid
          color-mix(in srgb, var(--accent2) 40%, transparent);
      }
      .class-card-odd {
        border-right: 3px solid rgba(251, 191, 36, 0.7);
      }
      .class-card-even {
        border-right: 3px solid rgba(59, 130, 246, 0.72);
      }

      /* Mobile performance + smooth scroll */
      body[data-ui-mode="mobile"] {
        overflow-x: hidden;
        overscroll-behavior-y: contain;
      }
      body[data-ui-mode="mobile"] #mainPanel,
      body[data-ui-mode="mobile"] #sidePanel {
        contain: layout paint style;
      }
      body[data-ui-mode="mobile"] #scheduleContainer {
        content-visibility: auto;
        contain-intrinsic-size: 1200px;
      }
      body[data-ui-mode="mobile"] .mobile-day-card {
        content-visibility: auto;
        contain-intrinsic-size: 250px;
        scroll-margin-top: 68px;
      }
      body[data-ui-mode="mobile"] .theme-card,
      body[data-ui-mode="mobile"] .class-card,
      body[data-ui-mode="mobile"] .mobile-class-card {
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
        box-shadow:
          0 8px 20px rgba(0, 0, 0, 0.16),
          inset 0 1px 0 rgba(255, 255, 255, 0.08) !important;
      }
      body[data-ui-mode="mobile"] .theme-card:hover,
      body[data-ui-mode="mobile"] .class-card:hover,
      body[data-ui-mode="mobile"] .mobile-class-card:hover {
        transform: none !important;
        filter: none !important;
      }
      body[data-ui-mode="mobile"] .mobile-day-card,
      body[data-ui-mode="mobile"] .mobile-class-card {
        box-shadow:
          0 12px 26px rgba(0, 0, 0, 0.2),
          inset 0 1px 0 rgba(255, 255, 255, 0.12) !important;
      }
      body[data-ui-mode="mobile"] .mobile-class-card.is-now {
        box-shadow:
          0 16px 30px rgba(0, 0, 0, 0.24),
          0 0 0 1px color-mix(in srgb, var(--accent2) 26%, transparent) inset !important;
      }
      body[data-ui-mode="mobile"] #examList,
      body[data-ui-mode="mobile"] #noteList,
      body[data-ui-mode="mobile"] #alertList {
        max-height: min(42vh, 320px);
        overflow-y: auto;
        overscroll-behavior: contain;
        -webkit-overflow-scrolling: touch;
      }
      body[data-ui-mode="mobile"] .theme-fx .fx-node:nth-child(2n),
      body[data-ui-mode="mobile"] .symbol-layer .symbol-node:nth-child(2n),
      body[data-ui-mode="mobile"] .bg-hacker .col:nth-child(2n),
      body[data-ui-mode="mobile"] .orb-c,
      body[data-ui-mode="mobile"] .grain {
        display: none !important;
      }
      body[data-ui-mode="mobile"] .theme-fx .fx-node,
      body[data-ui-mode="mobile"] .symbol-layer .symbol-node {
        animation-duration: calc(var(--dur, 10s) * 1.28) !important;
      }
      body[data-perf-mode="lite"] .theme-fx,
      body[data-perf-mode="lite"] .symbol-layer,
      body[data-perf-mode="lite"] .scanline,
      body[data-perf-mode="lite"] .grain,
      body[data-perf-mode="lite"] .orb-c {
        display: none !important;
      }
      body[data-perf-mode="lite"] .theme-card,
      body[data-perf-mode="lite"] .class-card,
      body[data-perf-mode="lite"] .mobile-class-card,
      body[data-perf-mode="lite"] .pinned-alert-item {
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
      }
      body[data-perf-mode="lite"] .theme-card:hover,
      body[data-perf-mode="lite"] .class-card:hover,
      body[data-perf-mode="lite"] .mobile-class-card:hover {
        transform: none !important;
        filter: none !important;
      }
      body[data-perf-mode="lite"] .theme-fx .fx-node,
      body[data-perf-mode="lite"] .symbol-layer .symbol-node,
      body[data-perf-mode="lite"] .bg-hacker .col {
        animation: none !important;
      }

      @media (max-width: 1024px) {
        body[data-ui-mode="auto"] {
          overflow-x: hidden;
          overscroll-behavior-y: contain;
        }
        body[data-ui-mode="auto"] .pinned-alerts-bar {
          top: 72px;
          width: calc(100% - 14px);
        }
        body[data-ui-mode="auto"].has-pinned-alerts #appLayout {
          margin-top: 64px;
        }
        body[data-ui-mode="auto"] #mainPanel,
        body[data-ui-mode="auto"] #sidePanel {
          contain: layout paint style;
        }
        body[data-ui-mode="auto"] #scheduleContainer {
          content-visibility: auto;
          contain-intrinsic-size: 1200px;
        }
        body[data-ui-mode="auto"] .mobile-day-card {
          content-visibility: auto;
          contain-intrinsic-size: 250px;
          scroll-margin-top: 68px;
        }
        body[data-ui-mode="auto"] .theme-card,
        body[data-ui-mode="auto"] .class-card,
        body[data-ui-mode="auto"] .mobile-class-card {
          backdrop-filter: none !important;
          -webkit-backdrop-filter: none !important;
          box-shadow:
            0 8px 20px rgba(0, 0, 0, 0.16),
            inset 0 1px 0 rgba(255, 255, 255, 0.08) !important;
        }
        body[data-ui-mode="auto"] .mobile-day-card,
        body[data-ui-mode="auto"] .mobile-class-card {
          box-shadow:
            0 12px 26px rgba(0, 0, 0, 0.2),
            inset 0 1px 0 rgba(255, 255, 255, 0.12) !important;
        }
        body[data-ui-mode="auto"] .mobile-class-card.is-now {
          box-shadow:
            0 16px 30px rgba(0, 0, 0, 0.24),
            0 0 0 1px color-mix(in srgb, var(--accent2) 26%, transparent) inset !important;
        }
        body[data-ui-mode="auto"] #examList,
        body[data-ui-mode="auto"] #noteList,
        body[data-ui-mode="auto"] #alertList {
          max-height: min(42vh, 320px);
          overflow-y: auto;
          overscroll-behavior: contain;
          -webkit-overflow-scrolling: touch;
        }
        body[data-ui-mode="auto"] .theme-fx .fx-node:nth-child(2n),
        body[data-ui-mode="auto"] .symbol-layer .symbol-node:nth-child(2n),
        body[data-ui-mode="auto"] .bg-hacker .col:nth-child(2n),
        body[data-ui-mode="auto"] .orb-c,
        body[data-ui-mode="auto"] .grain {
          display: none !important;
        }
        body[data-ui-mode="auto"] .theme-fx .fx-node,
        body[data-ui-mode="auto"] .symbol-layer .symbol-node {
          animation-duration: calc(var(--dur, 10s) * 1.28) !important;
        }
      }

      /* Mobile Web Frame + UX Refinements */
      body[data-ui-mode="mobile"] {
        -webkit-tap-highlight-color: transparent;
      }
      body[data-ui-mode="mobile"] #mainPanel,
      body[data-ui-mode="mobile"] #sidePanel {
        min-width: 0;
      }
      body[data-ui-mode="mobile"] #appLayout {
        padding-top: calc(10px + env(safe-area-inset-top));
        padding-right: max(10px, env(safe-area-inset-right));
        padding-bottom: calc(12px + env(safe-area-inset-bottom));
        padding-left: max(10px, env(safe-area-inset-left));
        gap: 12px;
      }
      body[data-ui-mode="mobile"] .top-nav {
        top: calc(6px + env(safe-area-inset-top));
        border-radius: 18px;
      }
      body[data-ui-mode="mobile"] .pinned-alerts-bar {
        top: calc(70px + env(safe-area-inset-top));
      }
      body[data-ui-mode="mobile"].has-pinned-alerts #appLayout {
        margin-top: calc(68px + env(safe-area-inset-top));
      }
      body[data-ui-mode="mobile"] .theme-card,
      body[data-ui-mode="mobile"] .mobile-day-card,
      body[data-ui-mode="mobile"] .mobile-class-card,
      body[data-ui-mode="mobile"] .list-class-card {
        border-radius: 18px !important;
      }
      body[data-ui-mode="mobile"] .top-nav .control-surface,
      body[data-ui-mode="mobile"] .top-nav .control-btn,
      body[data-ui-mode="mobile"] .top-nav .week-toggle button,
      body[data-ui-mode="mobile"] .notify-perm-btn,
      body[data-ui-mode="mobile"] .mobile-add-btn,
      body[data-ui-mode="mobile"] .pinned-alert-item {
        min-height: 42px;
        touch-action: manipulation;
      }
      body[data-ui-mode="mobile"] #examList,
      body[data-ui-mode="mobile"] #noteList,
      body[data-ui-mode="mobile"] #alertList,
      body[data-ui-mode="mobile"] #courseProgressList {
        max-height: min(44vh, 320px);
      }
      body[data-ui-mode="mobile"] .symbol-layer,
      body[data-ui-mode="mobile"] .scanline {
        display: none !important;
      }
      body[data-ui-mode="mobile"] #modalOverlay {
        align-items: flex-end;
        padding-top: calc(8px + env(safe-area-inset-top));
        padding-right: max(8px, env(safe-area-inset-right));
        padding-bottom: calc(10px + env(safe-area-inset-bottom));
        padding-left: max(8px, env(safe-area-inset-left));
      }
      body[data-ui-mode="mobile"] #modalOverlay .theme-card {
        width: 100%;
        max-width: 100%;
        max-height: calc(88vh - env(safe-area-inset-top));
        overflow-y: auto;
      }

      @media (max-width: 1024px) {
        body[data-ui-mode="auto"] #mainPanel,
        body[data-ui-mode="auto"] #sidePanel {
          min-width: 0;
        }
        body[data-ui-mode="auto"] #appLayout {
          padding-top: calc(10px + env(safe-area-inset-top));
          padding-right: max(10px, env(safe-area-inset-right));
          padding-bottom: calc(12px + env(safe-area-inset-bottom));
          padding-left: max(10px, env(safe-area-inset-left));
          gap: 12px;
        }
        body[data-ui-mode="auto"] .top-nav {
          top: calc(6px + env(safe-area-inset-top));
          border-radius: 18px;
        }
        body[data-ui-mode="auto"] .pinned-alerts-bar {
          top: calc(70px + env(safe-area-inset-top));
        }
        body[data-ui-mode="auto"].has-pinned-alerts #appLayout {
          margin-top: calc(68px + env(safe-area-inset-top));
        }
        body[data-ui-mode="auto"] .theme-card,
        body[data-ui-mode="auto"] .mobile-day-card,
        body[data-ui-mode="auto"] .mobile-class-card,
        body[data-ui-mode="auto"] .list-class-card {
          border-radius: 18px !important;
        }
        body[data-ui-mode="auto"] .top-nav .control-surface,
        body[data-ui-mode="auto"] .top-nav .control-btn,
        body[data-ui-mode="auto"] .top-nav .week-toggle button,
        body[data-ui-mode="auto"] .notify-perm-btn,
        body[data-ui-mode="auto"] .mobile-add-btn,
        body[data-ui-mode="auto"] .pinned-alert-item {
          min-height: 42px;
          touch-action: manipulation;
        }
        body[data-ui-mode="auto"] #examList,
        body[data-ui-mode="auto"] #noteList,
        body[data-ui-mode="auto"] #alertList,
        body[data-ui-mode="auto"] #courseProgressList {
          max-height: min(44vh, 320px);
        }
        body[data-ui-mode="auto"] .symbol-layer,
        body[data-ui-mode="auto"] .scanline {
          display: none !important;
        }
        body[data-ui-mode="auto"] #modalOverlay {
          align-items: flex-end;
          padding-top: calc(8px + env(safe-area-inset-top));
          padding-right: max(8px, env(safe-area-inset-right));
          padding-bottom: calc(10px + env(safe-area-inset-bottom));
          padding-left: max(8px, env(safe-area-inset-left));
        }
        body[data-ui-mode="auto"] #modalOverlay .theme-card {
          width: 100%;
          max-width: 100%;
          max-height: calc(88vh - env(safe-area-inset-top));
          overflow-y: auto;
        }
      }
    </style>
  </head>

  <body
    data-theme="glass"
    data-style-pack="base"
    data-anim-enabled="on"
    data-anim-intensity="high"
    data-ui-mode="auto"
    data-perf-mode="normal"
    class="min-h-screen text-[var(--text)] bg-[var(--bg)] font-vazir relative overflow-x-hidden"
  >
    <!-- Background Engine -->
    <div id="bgAnim" class="bg-anim-layer">
      <div class="orb orb-a animate-pulse-slow"></div>
      <div class="orb orb-b animate-float"></div>
      <div class="orb orb-c animate-float" style="animation-duration: 9s"></div>

      <div class="bg-layer bg-glass" aria-hidden="true"></div>
      <div class="bg-layer bg-brutal" aria-hidden="true"></div>
      <div class="bg-layer bg-luxury" aria-hidden="true"></div>
      <div class="bg-layer bg-hacker" aria-hidden="true"></div>
      <div class="bg-layer bg-aurora" aria-hidden="true"></div>
      <div class="bg-layer bg-mono" aria-hidden="true"></div>
      <div class="bg-layer bg-soft" aria-hidden="true"></div>
      <div class="bg-layer bg-material" aria-hidden="true"></div>
      <div class="bg-layer bg-frosted" aria-hidden="true"></div>
      <div class="bg-layer bg-editorial" aria-hidden="true"></div>
      <div class="bg-layer bg-mathlight" aria-hidden="true"></div>
      <div class="bg-layer bg-mathdark" aria-hidden="true"></div>

      <div class="symbol-layer sym-glass" aria-hidden="true"></div>
      <div class="symbol-layer sym-brutal" aria-hidden="true"></div>
      <div class="symbol-layer sym-luxury" aria-hidden="true"></div>
      <div class="symbol-layer sym-hacker" aria-hidden="true"></div>
      <div class="symbol-layer sym-aurora" aria-hidden="true"></div>
      <div class="symbol-layer sym-mono" aria-hidden="true"></div>
      <div class="symbol-layer sym-soft" aria-hidden="true"></div>
      <div class="symbol-layer sym-material" aria-hidden="true"></div>
      <div class="symbol-layer sym-frosted" aria-hidden="true"></div>
      <div class="symbol-layer sym-editorial" aria-hidden="true"></div>
      <div class="symbol-layer sym-mathlight" aria-hidden="true"></div>
      <div class="symbol-layer sym-mathdark" aria-hidden="true"></div>

      <div class="scanline" aria-hidden="true"></div>
      <div class="grain" aria-hidden="true"></div>
    </div>

    <div
      id="pinnedAlertsBar"
      class="pinned-alerts-bar hidden"
      aria-live="polite"
    ></div>

    <!-- Modals -->
    <div
      id="modalOverlay"
      class="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm hidden items-center justify-center p-4"
    ></div>

    <!-- Layout -->
    <div
      id="appLayout"
      class="max-w-[1600px] mx-auto p-4 lg:p-8 grid grid-cols-12 gap-6"
    >
      <!-- Navbar -->
      <nav
        class="top-nav col-span-12 theme-card p-4 flex flex-wrap items-center justify-between gap-4 sticky top-4 z-40 bg-[var(--bg)]/75"
      >
        <div class="flex items-center gap-4">
          <div class="logo-badge select-none" aria-label="Academic Master">
            <svg
              class="logo-icon"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1.9"
                d="M3 9l9-5 9 5-9 5-9-5z"
              />
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1.9"
                d="M7 11.6V15c0 .6.3 1.2.9 1.5 1 .6 2.6 1.5 4.1 1.5 1.5 0 3.1-.9 4.1-1.5.6-.3.9-.9.9-1.5v-3.4"
              />
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1.9"
                d="M21 10v5"
              />
            </svg>
          </div>
          <div>
            <h1 id="navTitle" class="text-xl font-black tracking-tight"></h1>
            <p id="navSub" class="text-xs opacity-70"></p>
          </div>
        </div>

        <div class="flex items-center gap-2 lg:gap-4 flex-wrap">
          <!-- Week Toggle -->
          <div
            class="week-toggle flex p-1 rounded-2xl border border-[var(--border)] bg-[var(--bg)]/35 backdrop-blur-md"
          >
            <button
              onclick="app.setWeek('odd')"
              id="btnOdd"
              class="px-4 py-2 rounded-xl text-sm font-black transition-all"
            ></button>
            <button
              onclick="app.setWeek('even')"
              id="btnEven"
              class="px-4 py-2 rounded-xl text-sm font-black transition-all"
            ></button>
          </div>

          <!-- Theme Picker -->
          <select
            id="themeSelect"
            onchange="app.setTheme(this.value)"
            class="control-surface bg-transparent border border-[var(--border)] text-[var(--text)] text-sm rounded-2xl p-2.5 focus:outline-none font-black cursor-pointer backdrop-blur-md"
          ></select>

          <!-- Style Pack -->
          <select
            id="packSelect"
            onchange="app.setStylePack(this.value)"
            class="control-surface bg-transparent border border-[var(--border)] text-[var(--text)] text-sm rounded-2xl p-2.5 focus:outline-none font-black cursor-pointer backdrop-blur-md min-w-[136px]"
            title="Style Pack"
          ></select>

          <!-- Animation Mode -->
          <select
            id="animModeSelect"
            onchange="app.setAnimEnabled(this.value === 'on')"
            class="control-surface bg-transparent border border-[var(--border)] text-[var(--text)] text-sm rounded-2xl p-2.5 focus:outline-none font-black cursor-pointer backdrop-blur-md min-w-[128px]"
            title="Animation Mode"
          ></select>

          <!-- Animation Intensity -->
          <select
            id="animIntensitySelect"
            onchange="app.setAnimIntensity(this.value)"
            class="control-surface bg-transparent border border-[var(--border)] text-[var(--text)] text-sm rounded-2xl p-2.5 focus:outline-none font-black cursor-pointer backdrop-blur-md min-w-[112px]"
            title="Animation Intensity"
          ></select>

          <!-- UI Mode -->
          <select
            id="uiModeSelect"
            onchange="app.setUiMode(this.value)"
            class="control-surface bg-transparent border border-[var(--border)] text-[var(--text)] text-sm rounded-2xl p-2.5 focus:outline-none font-black cursor-pointer backdrop-blur-md min-w-[126px]"
            title="UI Mode"
          ></select>

          <!-- Anim Toggle -->
          <button
            id="btnAnimToggle"
            onclick="app.toggleAnim()"
            class="control-btn p-2.5 rounded-2xl border border-[var(--border)] hover:bg-[var(--accent)] hover:text-[var(--bg)] transition-colors backdrop-blur-md"
            title="Toggle Animation"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M13 10V3L4 14h7v7l9-11h-7z"
              />
            </svg>
          </button>

          <!-- Reset -->
          <button
            onclick="app.resetData()"
            class="control-btn danger-btn p-2.5 rounded-2xl border border-red-500/30 text-red-500 hover:bg-red-500 hover:text-white transition-colors backdrop-blur-md"
            title="Reset Data"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
              />
            </svg>
          </button>
        </div>
      </nav>

      <!-- Sidebar -->
      <aside id="sidePanel" class="col-span-12 lg:col-span-3 space-y-6">
        <!-- Profile Stats -->
        <div class="theme-card profile-card p-6">
          <div class="flex justify-between items-center mb-4">
            <div class="flex items-center gap-2">
              <h3 id="txtProfile" class="font-black text-lg"></h3>
              <button
                id="btnEditProfile"
                onclick="app.editProfileName()"
                class="w-7 h-7 rounded-xl border border-[var(--border)] text-[var(--muted)] hover:text-[var(--text)] hover:border-[var(--accent)] transition-colors flex items-center justify-center"
                title="Edit Profile Name"
              >
                <svg
                  class="w-3.5 h-3.5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.586a2 2 0 112.828 2.828L12 14l-4 1 1-4 8.586-8.586z"
                  />
                </svg>
              </button>
            </div>
            <span class="chip">Term 2</span>
          </div>

          <div class="grid grid-cols-2 gap-3 text-center">
            <div
              class="stat-tile p-3 rounded-2xl bg-[var(--bg)]/25 border border-[var(--border)] backdrop-blur-md"
            >
              <div class="text-2xl font-black" id="statUnits">17</div>
              <div
                class="text-[10px] opacity-70 font-black"
                id="txtUnits"
              ></div>
            </div>
            <div
              class="stat-tile p-3 rounded-2xl bg-[var(--bg)]/25 border border-[var(--border)] backdrop-blur-md"
            >
              <div class="text-2xl font-black" id="statHours">16.5</div>
              <div
                class="text-[10px] opacity-70 font-black"
                id="txtHours"
              ></div>
            </div>
          </div>

          <div
            class="stat-tile mt-3 p-3 rounded-2xl bg-[var(--bg)]/25 border border-[var(--border)] text-center backdrop-blur-md"
          >
            <div class="text-2xl font-black" id="statClasses">11</div>
            <div
              class="text-[10px] opacity-70 font-black"
              id="txtClasses"
            ></div>
          </div>
        </div>

        <!-- Next Class -->
        <div
          class="theme-card side-widget next-class-card p-6 relative overflow-hidden border-r-4 border-r-[var(--accent)]"
        >
          <h4
            id="txtNextClass"
            class="text-xs font-black opacity-60 uppercase mb-3 tracking-widest"
          ></h4>
          <div id="nextClassContainer" class="relative z-10"></div>
        </div>

        <!-- Exam Widget -->
        <div class="theme-card side-widget p-6 flex flex-col h-[340px]">
          <div class="flex justify-between items-center mb-4">
            <h4 id="txtExams" class="font-black"></h4>
            <button
              onclick="ui.openExamModal()"
              class="w-8 h-8 flex items-center justify-center rounded-full bg-[var(--accent)] text-[var(--bg)] hover:scale-110 transition-transform font-black shadow-lg"
            >
              +
            </button>
          </div>
          <div
            id="examList"
            class="flex-1 overflow-y-auto space-y-3 pr-2"
          ></div>
        </div>

        <!-- Notes Widget -->
        <div class="theme-card side-widget p-6 flex flex-col h-[340px]">
          <div class="flex justify-between items-center mb-4">
            <h4 id="txtNotesBoard" class="font-black"></h4>
            <button
              onclick="ui.openNoteModal()"
              class="w-8 h-8 flex items-center justify-center rounded-full bg-[var(--accent)] text-[var(--bg)] hover:scale-110 transition-transform font-black shadow-lg"
            >
              +
            </button>
          </div>
          <div
            id="noteList"
            class="flex-1 overflow-y-auto space-y-3 pr-2"
          ></div>
        </div>

        <!-- Course Progress Widget -->
        <div class="theme-card side-widget p-6 flex flex-col h-[340px]">
          <div class="flex justify-between items-center mb-4">
            <h4 id="txtCourseProgress" class="font-black"></h4>
            <button
              onclick="ui.openCourseProgressModal()"
              class="w-8 h-8 flex items-center justify-center rounded-full bg-[var(--accent)] text-[var(--bg)] hover:scale-110 transition-transform font-black shadow-lg"
              title="Add Course Progress"
              type="button"
            >
              +
            </button>
          </div>
          <div id="courseProgressSummary"></div>
          <div
            id="courseProgressList"
            class="flex-1 overflow-y-auto space-y-3 pr-2"
          ></div>
        </div>

        <!-- Alert Widget -->
        <div class="theme-card side-widget p-6 flex flex-col h-[300px]">
          <div class="flex justify-between items-center mb-4">
            <h4 id="txtAlerts" class="font-black"></h4>
            <div class="flex items-center gap-2">
              <button
                id="btnNotifyPermission"
                onclick="app.requestNotificationPermission(true)"
                class="notify-perm-btn"
                title="Notification Permission"
                type="button"
              >
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"
                  />
                </svg>
              </button>
              <button
                onclick="ui.openNoteModal(null, true)"
                class="w-8 h-8 flex items-center justify-center rounded-full bg-red-500 text-white hover:scale-110 transition-transform font-black shadow-lg"
                title="Add Alert"
              >
                +
              </button>
            </div>
          </div>
          <div
            id="alertList"
            class="flex-1 overflow-y-auto space-y-3 pr-2"
          ></div>
        </div>
      </aside>

      <!-- Main Content -->
      <main id="mainPanel" class="col-span-12 lg:col-span-9 space-y-6">
        <!-- Tools -->
        <div
          class="theme-card tools-panel p-3 flex flex-wrap gap-3 items-center justify-between"
        >
          <div
            class="view-switch flex gap-2 bg-[var(--bg)]/25 p-1 rounded-2xl border border-[var(--border)] backdrop-blur-md"
          >
            <button
              onclick="app.setView('grid')"
              id="viewGrid"
              class="px-3 py-2 rounded-xl text-sm font-black flex items-center gap-2 transition-all"
            >
              <svg
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"
                />
              </svg>
              <span id="txtGrid"></span>
            </button>
            <button
              onclick="app.setView('list')"
              id="viewList"
              class="px-3 py-2 rounded-xl text-sm font-black flex items-center gap-2 transition-all opacity-50"
            >
              <svg
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 6h16M4 12h16M4 18h16"
                />
              </svg>
              <span id="txtList"></span>
            </button>
          </div>

          <div class="flex-1 max-w-md relative">
            <input
              type="text"
              id="searchInput"
              oninput="app.search(this.value)"
              class="inp search-input pr-4 pl-10 text-sm"
              placeholder="..."
            />
            <svg
              class="w-4 h-4 absolute left-3 top-3 opacity-60"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
              />
            </svg>
          </div>

          <button
            onclick="ui.openClassModal()"
            class="add-class-btn px-5 py-2.5 bg-[var(--accent)] text-[var(--bg)] rounded-2xl font-black text-sm hover:brightness-110 transition-all shadow-xl flex items-center gap-2"
          >
            <span>+</span> <span id="txtAddClass"></span>
          </button>
        </div>

        <!-- Schedule -->
        <div id="scheduleContainer" class="animate-fade-in"></div>
      </main>
    </div>

    <script>
      const STR = {
        title:
          "\u0628\u0631\u0646\u0627\u0645\u0647 \u06a9\u0644\u0627\u0633\u06cc \u062f\u0627\u0646\u0634\u06af\u0627\u0647\u06cc",
        uni: "\u062f\u0627\u0646\u0634\u06af\u0627\u0647 \u0641\u0631\u062f\u0648\u0633\u06cc \u0645\u0634\u0647\u062f",
        name: "\u0627\u0645\u06cc\u0631\u0645\u0647\u062f\u06cc",
        weekOdd: "\u0647\u0641\u062a\u0647 \u0641\u0631\u062f",
        weekEven: "\u0647\u0641\u062a\u0647 \u0632\u0648\u062c",
        units: "\u0648\u0627\u062d\u062f \u06a9\u0644",
        hours: "\u0633\u0627\u0639\u062a \u062f\u0631 \u0647\u0641\u062a\u0647",
        classesCount:
          "\u062a\u0639\u062f\u0627\u062f \u06a9\u0644\u0627\u0633\u200c\u0647\u0627",
        nextClass: "\u06a9\u0644\u0627\u0633 \u0628\u0639\u062f\u06cc",
        exams: "\u0622\u0632\u0645\u0648\u0646\u200c\u0647\u0627",
        notesBoard:
          "\u06cc\u0627\u062f\u062f\u0627\u0634\u062a\u200c\u0647\u0627",
        addNote:
          "\u06cc\u0627\u062f\u062f\u0627\u0634\u062a \u062c\u062f\u06cc\u062f",
        noteClass: "\u06a9\u0644\u0627\u0633 \u0645\u0631\u062a\u0628\u0637",
        noteText:
          "\u0645\u062a\u0646 \u06cc\u0627\u062f\u062f\u0627\u0634\u062a",
        alertBoard: "\u0647\u0634\u062f\u0627\u0631\u0647\u0627",
        pinAlert:
          "\u0646\u0645\u0627\u06cc\u0634 \u062f\u0631 \u0647\u0634\u062f\u0627\u0631\u0647\u0627",
        noAlerts:
          "\u0647\u0634\u062f\u0627\u0631 \u0641\u0639\u0627\u0644\u06cc \u0648\u062c\u0648\u062f \u0646\u062f\u0627\u0631\u062f",
        alertDate:
          "\u062a\u0627\u0631\u06cc\u062e \u0647\u0634\u062f\u0627\u0631",
        alertTime: "\u0633\u0627\u0639\u062a \u0647\u0634\u062f\u0627\u0631",
        alertDay: "\u0631\u0648\u0632 \u0647\u0634\u062f\u0627\u0631",
        notifyWhen: "\u0632\u0645\u0627\u0646 \u0627\u0639\u0644\u0627\u0646",
        notifyText: "\u0645\u062a\u0646 \u0627\u0639\u0644\u0627\u0646",
        notifyTextRequired:
          "\u0645\u062a\u0646 \u0627\u0639\u0644\u0627\u0646 \u0631\u0627 \u0648\u0627\u0631\u062f \u06a9\u0646\u06cc\u062f.",
        notifyEnabled:
          "\u0641\u0639\u0627\u0644\u200c\u0633\u0627\u0632\u06cc \u0646\u0648\u062a\u06cc\u0641\u06cc\u06a9\u06cc\u0634\u0646",
        notifyAtTime:
          "\u062f\u0642\u06cc\u0642\u0627 \u0647\u0645\u0627\u0646 \u0633\u0627\u0639\u062a",
        notifyBefore5:
          "\u06f5 \u062f\u0642\u06cc\u0642\u0647 \u0642\u0628\u0644",
        notifyBefore10:
          "\u06f1\u06f0 \u062f\u0642\u06cc\u0642\u0647 \u0642\u0628\u0644",
        notifyBefore15:
          "\u06f1\u06f5 \u062f\u0642\u06cc\u0642\u0647 \u0642\u0628\u0644",
        notifyBefore20:
          "\u06f2\u06f0 \u062f\u0642\u06cc\u0642\u0647 \u0642\u0628\u0644",
        notifyBefore30:
          "\u06f3\u06f0 \u062f\u0642\u06cc\u0642\u0647 \u0642\u0628\u0644",
        notifyBefore45:
          "\u06f4\u06f5 \u062f\u0642\u06cc\u0642\u0647 \u0642\u0628\u0644",
        notifyBefore60: "\u06f1 \u0633\u0627\u0639\u062a \u0642\u0628\u0644",
        notifyBefore90:
          "\u06f1 \u0633\u0627\u0639\u062a \u0648 \u06f3\u06f0 \u062f\u0642\u06cc\u0642\u0647 \u0642\u0628\u0644",
        notifyBefore120: "\u06f2 \u0633\u0627\u0639\u062a \u0642\u0628\u0644",
        notifyBefore180: "\u06f3 \u0633\u0627\u0639\u062a \u0642\u0628\u0644",
        notifyBefore360: "\u06f6 \u0633\u0627\u0639\u062a \u0642\u0628\u0644",
        notifyBefore720:
          "\u06f1\u06f2 \u0633\u0627\u0639\u062a \u0642\u0628\u0644",
        notifyBefore1440: "\u06f1 \u0631\u0648\u0632 \u0642\u0628\u0644",
        notifyBefore2880: "\u06f2 \u0631\u0648\u0632 \u0642\u0628\u0644",
        notifyBefore10080: "\u06f1 \u0647\u0641\u062a\u0647 \u0642\u0628\u0644",
        notifyPermission:
          "\u0641\u0639\u0627\u0644\u200c\u0633\u0627\u0632\u06cc \u0627\u0639\u0644\u0627\u0646 \u0645\u0631\u0648\u0631\u06af\u0631",
        notifyPermissionGranted:
          "\u062f\u0633\u062a\u0631\u0633\u06cc \u0646\u0648\u062a\u06cc\u0641\u06cc\u06a9\u06cc\u0634\u0646 \u0641\u0639\u0627\u0644 \u0634\u062f.",
        notifyPermissionHint:
          "\u0628\u0631\u0627\u06cc \u062f\u0631\u06cc\u0627\u0641\u062a \u0627\u0639\u0644\u0627\u0646 \u062d\u062a\u0645\u0627 \u062f\u0633\u062a\u0631\u0633\u06cc \u0645\u0631\u0648\u0631\u06af\u0631 \u0631\u0627 \u0628\u062f\u0647\u06cc\u062f.",
        notifyPermissionDenied:
          "\u062f\u0633\u062a\u0631\u0633\u06cc \u0646\u0648\u062a\u06cc\u0641\u06cc\u06a9\u06cc\u0634\u0646 \u0631\u062f \u0634\u062f. \u0627\u0632 \u062a\u0646\u0638\u06cc\u0645\u0627\u062a \u0645\u0631\u0648\u0631\u06af\u0631 \u0641\u0639\u0627\u0644\u0634 \u06a9\u0646\u06cc\u062f.",
        notifyNotSupported:
          "\u0627\u06cc\u0646 \u0645\u0631\u0648\u0631\u06af\u0631 \u0627\u0632 \u0646\u0648\u062a\u06cc\u0641\u06cc\u06a9\u06cc\u0634\u0646 \u067e\u0634\u062a\u06cc\u0628\u0627\u0646\u06cc \u0646\u0645\u06cc\u200c\u06a9\u0646\u062f.",
        notifyContextFile:
          "\u0627\u06cc\u0646 \u0635\u0641\u062d\u0647 \u0628\u0627 \u0622\u062f\u0631\u0633 file:// \u0628\u0627\u0632 \u0634\u062f\u0647 \u0627\u0633\u062a. \u0628\u0631\u0627\u06cc \u0646\u0648\u062a\u06cc\u0641\u06cc\u06a9\u06cc\u0634\u0646\u060c \u0622\u0646 \u0631\u0627 \u0627\u0632 http://localhost \u06cc\u0627 https \u0627\u062c\u0631\u0627 \u06a9\u0646\u06cc\u062f.",
        notifyContextInsecure:
          "\u0627\u0639\u0644\u0627\u0646 \u0645\u0631\u0648\u0631\u06af\u0631 \u0641\u0642\u0637 \u0631\u0648\u06cc HTTPS \u06cc\u0627 localhost \u0641\u0639\u0627\u0644 \u0627\u0633\u062a.",
        notifySetupGuide:
          "\u0631\u0627\u0647\u0646\u0645\u0627:\\n1) \u062a\u0631\u0645\u06cc\u0646\u0627\u0644 \u0631\u0627 \u0628\u0627\u0632 \u06a9\u0646\u06cc\u062f \u0648 \u062f\u0631 \u067e\u0648\u0634\u0647 \u0641\u0627\u06cc\u0644 \u0627\u062c\u0631\u0627 \u06a9\u0646\u06cc\u062f: py -m http.server 8080\\n2) \u0627\u0632 \u0627\u06cc\u0646 \u0622\u062f\u0631\u0633 \u0628\u0627\u0632 \u06a9\u0646\u06cc\u062f: http://localhost:8080/UniversitySchedule.html\\n3) \u0646\u0634\u0627\u0646 \u0632\u0646\u06af \u0631\u0627 \u0628\u0632\u0646\u06cc\u062f \u0648 Allow \u0631\u0627 \u0627\u0646\u062a\u062e\u0627\u0628 \u06a9\u0646\u06cc\u062f.",
        alertDateRequired:
          "\u062a\u0627\u0631\u06cc\u062e \u0647\u0634\u062f\u0627\u0631 \u0631\u0627 \u0645\u0634\u062e\u0635 \u06a9\u0646\u06cc\u062f.",
        alertTimeRequired:
          "\u0633\u0627\u0639\u062a \u0647\u0634\u062f\u0627\u0631 \u0631\u0627 \u0645\u0634\u062e\u0635 \u06a9\u0646\u06cc\u062f.",
        examDateRequired:
          "\u062a\u0627\u0631\u06cc\u062e \u0622\u0632\u0645\u0648\u0646 \u0631\u0627 \u0645\u0634\u062e\u0635 \u06a9\u0646\u06cc\u062f.",
        examTimeRequired:
          "\u0633\u0627\u0639\u062a \u0622\u0632\u0645\u0648\u0646 \u0631\u0627 \u0645\u0634\u062e\u0635 \u06a9\u0646\u06cc\u062f.",
        examNotifyTextRequired:
          "\u0645\u062a\u0646 \u0627\u0639\u0644\u0627\u0646 \u0622\u0632\u0645\u0648\u0646 \u0631\u0627 \u0648\u0627\u0631\u062f \u06a9\u0646\u06cc\u062f.",
        examReminder:
          "\u06cc\u0627\u062f\u0622\u0648\u0631\u06cc \u0622\u0632\u0645\u0648\u0646",
        editProfile:
          "\u0648\u06cc\u0631\u0627\u06cc\u0634 \u0646\u0627\u0645 \u067e\u0631\u0648\u0641\u0627\u06cc\u0644",
        promptProfileName:
          "\u0646\u0627\u0645 \u067e\u0631\u0648\u0641\u0627\u06cc\u0644 \u0631\u0627 \u0648\u0627\u0631\u062f \u06a9\u0646\u06cc\u062f",
        profileNameRequired:
          "\u0646\u0627\u0645 \u067e\u0631\u0648\u0641\u0627\u06cc\u0644 \u0646\u0645\u06cc\u200c\u062a\u0648\u0627\u0646\u062f \u062e\u0627\u0644\u06cc \u0628\u0627\u0634\u062f.",
        stylePack: "\u067e\u06a9 \u0638\u0627\u0647\u0631\u06cc",
        packBase: "\u067e\u06a9 Base",
        packUltra: "\u067e\u06a9 Ultra",
        animMode:
          "\u062d\u0627\u0644\u062a \u0627\u0646\u06cc\u0645\u06cc\u0634\u0646",
        animEnabled:
          "\u0627\u0646\u06cc\u0645\u06cc\u0634\u0646 \u0631\u0648\u0634\u0646",
        animDisabled:
          "\u0627\u0646\u06cc\u0645\u06cc\u0634\u0646 \u062e\u0627\u0645\u0648\u0634",
        animIntensity:
          "\u0634\u062f\u062a \u0627\u0646\u06cc\u0645\u06cc\u0634\u0646",
        animIntensityLow: "\u06a9\u0645",
        animIntensityHigh: "\u0632\u06cc\u0627\u062f",
        uiMode: "\u062d\u0627\u0644\u062a \u0646\u0645\u0627\u06cc\u0634",
        uiModeAuto: "\u062e\u0648\u062f\u06a9\u0627\u0631",
        uiModeDesktop:
          "\u062d\u0627\u0644\u062a \u062f\u0633\u06a9\u062a\u0627\u067e",
        uiModeMobile:
          "\u062d\u0627\u0644\u062a \u0645\u0648\u0628\u0627\u06cc\u0644",
        animToggleOnTitle:
          "\u0627\u0646\u06cc\u0645\u06cc\u0634\u0646 \u0631\u0648\u0634\u0646 \u0627\u0633\u062a (\u06a9\u0644\u06cc\u06a9 \u0628\u0631\u0627\u06cc \u062e\u0627\u0645\u0648\u0634)",
        animToggleOffTitle:
          "\u0627\u0646\u06cc\u0645\u06cc\u0634\u0646 \u062e\u0627\u0645\u0648\u0634 \u0627\u0633\u062a (\u06a9\u0644\u06cc\u06a9 \u0628\u0631\u0627\u06cc \u0631\u0648\u0634\u0646)",
        classDurationFixed:
          "\u0645\u062f\u062a \u0647\u0631 \u06a9\u0644\u0627\u0633: \u06f1 \u0633\u0627\u0639\u062a \u0648 \u06f3\u06f0 \u062f\u0642\u06cc\u0642\u0647",
        classStartRequired:
          "\u0632\u0645\u0627\u0646 \u0634\u0631\u0648\u0639 \u06a9\u0644\u0627\u0633 \u0631\u0627 \u0645\u0634\u062e\u0635 \u06a9\u0646\u06cc\u062f.",
        unpin: "\u0622\u0646\u067e\u06cc\u0646",
        noNotes:
          "\u0647\u06cc\u0686 \u06cc\u0627\u062f\u062f\u0627\u0634\u062a\u06cc \u062b\u0628\u062a \u0646\u0634\u062f\u0647 \u0627\u0633\u062a",
        unknownClass:
          "\u06a9\u0644\u0627\u0633 \u0646\u0627\u0645\u0634\u062e\u0635",
        viewGrid: "\u0646\u0645\u0627\u06cc \u062c\u062f\u0648\u0644",
        viewList: "\u0646\u0645\u0627\u06cc \u0644\u06cc\u0633\u062a",
        addClass: "\u06a9\u0644\u0627\u0633 \u062c\u062f\u06cc\u062f",
        search: "\u062c\u0633\u062a\u062c\u0648...",
        timeLabel: "\u0632\u0645\u0627\u0646",
        days: [
          "\u0634\u0646\u0628\u0647",
          "\u06cc\u06a9\u0634\u0646\u0628\u0647",
          "\u062f\u0648\u0634\u0646\u0628\u0647",
          "\u0633\u0647 \u0634\u0646\u0628\u0647",
          "\u0686\u0647\u0627\u0631\u0634\u0646\u0628\u0647",
          "\u067e\u0646\u062c\u0634\u0646\u0628\u0647",
        ],
        noClass:
          "\u06a9\u0644\u0627\u0633\u06cc \u06cc\u0627\u0641\u062a \u0646\u0634\u062f",
        alertReset:
          "\u0622\u06cc\u0627 \u0627\u0632 \u0628\u0627\u0632\u06af\u0631\u062f\u0627\u0646\u06cc \u0627\u0637\u0644\u0627\u0639\u0627\u062a \u0627\u0637\u0645\u06cc\u0646\u0627\u0646 \u062f\u0627\u0631\u06cc\u062f\u061f",
        modalEdit: "\u0648\u06cc\u0631\u0627\u06cc\u0634",
        modalAdd: "\u0627\u0641\u0632\u0648\u062f\u0646",
        save: "\u0630\u062e\u06cc\u0631\u0647",
        delete: "\u062d\u0630\u0641",
        cancel: "\u0644\u063a\u0648",
        typeNormal: "\u0639\u0627\u062f\u06cc",
        typeOdd: "\u0641\u0642\u0637 \u0641\u0631\u062f",
        typeEven: "\u0641\u0642\u0637 \u0632\u0648\u062c",
        course: "\u0646\u0627\u0645 \u062f\u0631\u0633",
        classNumber: "\u0634\u0645\u0627\u0631\u0647 \u06a9\u0644\u0627\u0633",
        prof: "\u0627\u0633\u062a\u0627\u062f",
        unit: "\u0648\u0627\u062d\u062f",
        notes: "\u062a\u0648\u0636\u06cc\u062d\u0627\u062a",
        courseProgressBoard:
          "\u0648\u0636\u0639\u06cc\u062a \u067e\u06cc\u0634\u0631\u0648\u06cc \u062f\u0631\u0633",
        progressTracked:
          "\u062f\u0631\u0633 \u062b\u0628\u062a\u200c\u0634\u062f\u0647",
        progressAverage:
          "\u0645\u06cc\u0627\u0646\u06af\u06cc\u0646 \u067e\u06cc\u0634\u0631\u0648\u06cc",
        progressUntracked: "\u0628\u062f\u0648\u0646 \u062b\u0628\u062a",
        progressUntil:
          "\u062a\u0627 \u0627\u06cc\u0646\u062c\u0627 \u062a\u062f\u0631\u06cc\u0633 \u0634\u062f\u0647",
        progressPercent:
          "\u062f\u0631\u0635\u062f \u067e\u06cc\u0634\u0631\u0648\u06cc",
        progressSession: "\u062c\u0644\u0633\u0647 \u0641\u0639\u0644\u06cc",
        progressNextTopic:
          "\u0645\u0648\u0636\u0648\u0639 \u062c\u0644\u0633\u0647 \u0628\u0639\u062f",
        progressUpdatedAt: "\u0622\u067e\u062f\u06cc\u062a \u0622\u062e\u0631",
        progressNoData:
          "\u0647\u0646\u0648\u0632 \u0628\u0631\u0627\u06cc \u062f\u0631\u0633\u200c\u0647\u0627 \u067e\u06cc\u0634\u0631\u0648\u06cc \u062b\u0628\u062a \u0646\u0634\u062f\u0647 \u0627\u0633\u062a.",
        progressClassRequired:
          "\u062f\u0631\u0633 \u0645\u0631\u062a\u0628\u0637 \u0631\u0627 \u0627\u0646\u062a\u062e\u0627\u0628 \u06a9\u0646\u06cc\u062f.",
        progressUntilRequired:
          "\u0628\u062e\u0634 \u00ab\u062a\u0627 \u0627\u06cc\u0646\u062c\u0627 \u062a\u062f\u0631\u06cc\u0633 \u0634\u062f\u0647\u00bb \u0631\u0627 \u062a\u06a9\u0645\u06cc\u0644 \u06a9\u0646\u06cc\u062f.",
        addHint:
          "\u0628\u0631\u0627\u06cc \u0627\u0641\u0632\u0648\u062f\u0646\u060c \u0631\u0648\u06cc \u062e\u0627\u0646\u0647 \u062e\u0627\u0644\u06cc \u06a9\u0644\u06cc\u06a9 \u06a9\u0646\u06cc\u062f",
      };

      const THEMES = [
        { id: "glass", name: "Glassmorphism 2.0" },
        { id: "brutal", name: "Neo-Brutal Pro" },
        { id: "luxury", name: "Dark Luxury" },
        { id: "hacker", name: "Hacker Clean" },
        { id: "aurora", name: "Aurora Mesh" },
        { id: "mono", name: "Monochrome Minimal" },
        { id: "soft", name: "Soft Neumorphism" },
        { id: "material", name: "Material You" },
        { id: "frosted", name: "Frosted + Noise" },
        { id: "editorial", name: "Editorial" },
        { id: "mathlight", name: "Mathematics Light" },
        { id: "mathdark", name: "Mathematics Dark" },
      ];

      const DEFAULT_CLASSES = [
        {
          id: 1,
          name: "\u0645\u062f\u0644\u0633\u0627\u0632\u06cc \u0645\u0642\u062f\u0645\u0627\u062a\u06cc \u0631\u06cc\u0627\u0636\u06cc",
          prof: "\u0627\u0633\u062a\u0627\u062f \u0632\u0627\u062c",
          unit: 3,
          day: 0,
          start: "08:00",
          end: "10:00",
          type: "normal",
          note: "",
        },

        {
          id: 2,
          name: "\u0631\u06cc\u0627\u0636\u06cc \u0639\u0645\u0648\u0645\u06cc 2",
          prof: "\u0627\u0633\u062a\u0627\u062f \u0637\u0627\u0644\u0628\u06cc",
          unit: 4,
          day: 1,
          start: "08:00",
          end: "10:00",
          type: "normal",
          note: "",
        },
        {
          id: 3,
          name: "\u0645\u0628\u0627\u0646\u06cc \u062a\u0631\u06a9\u06cc\u0628\u06cc\u0627\u062a",
          prof: "\u0627\u0633\u062a\u0627\u062f \u0645\u06cc\u0631\u0632\u0627 \u0648\u0632\u06cc\u0631\u06cc",
          unit: 4,
          day: 1,
          start: "10:00",
          end: "12:00",
          type: "normal",
          note: "",
        },

        {
          id: 4,
          name: "\u0645\u0628\u0627\u0646\u06cc \u0639\u0644\u0648\u0645 \u0631\u06cc\u0627\u0636\u06cc 2",
          prof: "\u0647\u0627\u0646\u06cc\u0647 \u0645\u06cc\u0631 \u0627\u0628\u0631\u0627\u0647\u06cc\u0645\u06cc",
          unit: 2,
          day: 2,
          start: "08:00",
          end: "10:00",
          type: "normal",
          note: "",
        },
        {
          id: 5,
          name: "\u0632\u0628\u0627\u0646 \u0627\u0646\u06af\u0644\u06cc\u0633\u06cc",
          prof: "\u0646\u0627\u0645\u0634\u062e\u0635",
          unit: 3,
          day: 2,
          start: "14:00",
          end: "16:00",
          type: "even",
          note: "\u0634\u0631\u0648\u0639 \u0632\u0648\u062c",
        },

        {
          id: 6,
          name: "\u0645\u0628\u0627\u0646\u06cc \u062a\u0631\u06a9\u06cc\u0628\u06cc\u0627\u062a",
          prof: "\u0627\u0633\u062a\u0627\u062f \u0645\u06cc\u0631\u0632\u0627 \u0648\u0632\u06cc\u0631\u06cc",
          unit: 4,
          day: 3,
          start: "10:00",
          end: "12:00",
          type: "normal",
          note: "",
        },
        {
          id: 7,
          name: "\u0645\u062f\u0644\u0633\u0627\u0632\u06cc \u0645\u0642\u062f\u0645\u0627\u062a\u06cc \u0631\u06cc\u0627\u0636\u06cc",
          prof: "\u0627\u0633\u062a\u0627\u062f \u0632\u0627\u062c",
          unit: 3,
          day: 3,
          start: "14:00",
          end: "16:00",
          type: "odd",
          note: "\u0634\u0631\u0648\u0639 \u0641\u0631\u062f",
        },
        {
          id: 8,
          name: "\u0631\u06cc\u0627\u0636\u06cc \u0639\u0645\u0648\u0645\u06cc 2",
          prof: "\u0627\u0633\u062a\u0627\u062f \u0637\u0627\u0644\u0628\u06cc",
          unit: 4,
          day: 3,
          start: "16:00",
          end: "18:00",
          type: "normal",
          note: "",
        },

        {
          id: 11,
          name: "\u0645\u0628\u0627\u0646\u06cc \u0639\u0644\u0648\u0645 \u0631\u06cc\u0627\u0636\u06cc 2",
          prof: "\u0627\u0633\u062a\u0627\u062f \u067e\u0631\u0648\u06cc\u0632\u06cc",
          unit: 0,
          day: 4,
          start: "12:00",
          end: "14:00",
          type: "normal",
          note: "\u062d\u0644 \u062a\u0645\u0631\u06cc\u0646",
        },
        {
          id: 9,
          name: "\u0632\u0628\u0627\u0646 \u0627\u0646\u06af\u0644\u06cc\u0633\u06cc",
          prof: "\u0646\u0627\u0645\u0634\u062e\u0635",
          unit: 3,
          day: 4,
          start: "14:00",
          end: "16:00",
          type: "normal",
          note: "",
        },
        {
          id: 10,
          name: "\u0622\u0632\u0645\u0627\u06cc\u0634\u06af\u0627\u0647 \u0631\u06cc\u0627\u0636\u06cc 1",
          prof: "\u0627\u0633\u062a\u0627\u062f \u0641\u0631\u0634\u0686\u06cc\u0627\u0646",
          unit: 1,
          day: 4,
          start: "16:00",
          end: "18:00",
          type: "normal",
          note: "",
        },
      ];

      const TIME_SLOTS = [
        ["08:00", "10:00"],
        ["10:00", "12:00"],
        ["12:00", "14:00"],
        ["14:00", "16:00"],
        ["16:00", "18:00"],
        ["18:00", "20:00"],
      ];
      const CLASS_DURATION_MINUTES = 90;
      const NOTIFY_BEFORE_OPTIONS = [
        0, 5, 10, 15, 20, 30, 45, 60, 90, 120, 180, 360, 720, 1440, 2880, 10080,
      ];
      const WEEKLY_FOOD_REMINDER = {
        day: 3,
        hour: 15,
        minute: 0,
        text: "    !!!",
      };
      const PERF_PROFILE = (() => {
        const nav = typeof navigator !== "undefined" ? navigator : {};
        const ua = String(nav.userAgent || "");
        const isAndroid = /Android/i.test(ua);
        const media = (q) =>
          typeof window !== "undefined" &&
          typeof window.matchMedia === "function"
            ? window.matchMedia(q).matches
            : false;
        const coarsePointer = media("(pointer: coarse)");
        const reducedMotion = media("(prefers-reduced-motion: reduce)");
        const cpu = Number(nav.hardwareConcurrency || 0);
        const ram = Number(nav.deviceMemory || 0);
        const lowHardware = (cpu > 0 && cpu <= 6) || (ram > 0 && ram <= 4);
        const isMobile = isAndroid || coarsePointer;
        const lite = reducedMotion || (isMobile && lowHardware);
        const fxScale = lite ? 0.25 : isMobile ? 0.55 : 1;
        const loopMs = lite ? 30000 : isMobile ? 20000 : 15000;

        return {
          isAndroid,
          isMobile,
          lowHardware,
          reducedMotion,
          lite,
          fxScale,
          loopMs,
        };
      })();

      function scaleEffectCount(base, min = 4) {
        const n = Number(base) || 0;
        if (PERF_PROFILE.fxScale >= 0.999) return Math.max(min, n);
        return Math.max(min, Math.round(n * PERF_PROFILE.fxScale));
      }

      // Hacker binary rain builder (idempotent)
      function buildBinaryRain() {
        const layer = document.querySelector(".bg-hacker");
        if (!layer) return;
        if (layer.dataset.ready === "1") return;
        layer.dataset.ready = "1";

        const cols = scaleEffectCount(26, 8);
        const heightChars = PERF_PROFILE.lite
          ? 40
          : PERF_PROFILE.isMobile
            ? 56
            : 90;

        for (let i = 0; i < cols; i++) {
          const col = document.createElement("div");
          col.className = "col";
          let s = "";
          for (let k = 0; k < heightChars; k++)
            s += (Math.random() > 0.5 ? "1" : "0") + "\n";
          col.textContent = s;

          const left = i * (100 / cols) + Math.random() * 1.2;
          const dur = 6 + Math.random() * 9;
          const delay = -(Math.random() * dur);
          const size = 10 + Math.random() * 4;
          const opacity = 0.1 + Math.random() * 0.22;

          col.style.left = left + "%";
          col.style.fontSize = size + "px";
          col.style.opacity = opacity;
          col.style.setProperty("--dur", dur + "s");
          col.style.animationDuration = dur + "s";
          col.style.animationDelay = delay + "s";

          layer.appendChild(col);
        }
      }

      function rand(min, max) {
        return min + Math.random() * (max - min);
      }

      function buildThemeFx(themeId = null) {
        const activeTheme =
          String(
            themeId ||
              document.body?.getAttribute("data-theme") ||
              DEFAULT_SETTINGS.theme,
          ).trim() || DEFAULT_SETTINGS.theme;
        const configs = [
          {
            selector: ".bg-glass",
            className: "fx-glass",
            count: 26,
            size: [4, 12],
            alpha: [0.1, 0.36],
            dur: [10, 21],
          },
          {
            selector: ".bg-brutal",
            className: "fx-brutal",
            count: 14,
            size: [8, 18],
            alpha: [0.08, 0.2],
            dur: [8, 16],
          },
          {
            selector: ".bg-luxury",
            className: "fx-luxury",
            count: 24,
            size: [3, 10],
            alpha: [0.08, 0.3],
            dur: [11, 24],
          },
          {
            selector: ".bg-hacker",
            className: "fx-hacker",
            count: 20,
            size: [22, 42],
            alpha: [0.16, 0.42],
            dur: [5, 11],
            fall: true,
          },
          {
            selector: ".bg-aurora",
            className: "fx-aurora",
            count: 18,
            size: [6, 14],
            alpha: [0.08, 0.32],
            dur: [9, 18],
          },
          {
            selector: ".bg-mono",
            className: "fx-mono",
            count: 30,
            size: [20, 52],
            alpha: [0.08, 0.24],
            dur: [8, 14],
          },
          {
            selector: ".bg-soft",
            className: "fx-soft",
            count: 20,
            size: [10, 24],
            alpha: [0.08, 0.22],
            dur: [12, 22],
          },
          {
            selector: ".bg-material",
            className: "fx-material",
            count: 16,
            size: [12, 30],
            alpha: [0.08, 0.22],
            dur: [10, 20],
          },
          {
            selector: ".bg-frosted",
            className: "fx-frosted",
            count: 26,
            size: [4, 11],
            alpha: [0.1, 0.3],
            dur: [7, 16],
            fall: true,
          },
          {
            selector: ".bg-editorial",
            className: "fx-editorial",
            count: 18,
            size: [6, 14],
            alpha: [0.08, 0.2],
            dur: [12, 24],
          },
          {
            selector: ".bg-mathlight",
            className: "fx-mathlight",
            count: 22,
            size: [8, 16],
            alpha: [0.1, 0.28],
            dur: [9, 16],
          },
          {
            selector: ".bg-mathdark",
            className: "fx-mathdark",
            count: 26,
            size: [7, 15],
            alpha: [0.12, 0.34],
            dur: [9, 18],
          },
        ];

        configs.forEach((cfg) => {
          const cfgTheme = cfg.selector.replace(/^\.(bg)-/, "");
          if (cfgTheme !== activeTheme) return;

          const layer = document.querySelector(cfg.selector);
          if (!layer) return;
          if (layer.dataset.fxReady === "1") return;
          layer.dataset.fxReady = "1";

          const wrap = document.createElement("div");
          wrap.className = `theme-fx ${cfg.className}`;
          const nodeCount = scaleEffectCount(cfg.count, 4);

          for (let i = 0; i < nodeCount; i++) {
            const n = document.createElement("span");
            n.className = "fx-node";

            const size = rand(cfg.size[0], cfg.size[1]);
            const alpha = rand(cfg.alpha[0], cfg.alpha[1]);
            const dur = rand(cfg.dur[0], cfg.dur[1]);
            const dx = cfg.fall ? rand(-24, 24) : rand(-70, 70);
            const dy = cfg.fall ? rand(0, 24) : rand(-60, 60);
            const x = rand(0, 100);
            const y = cfg.fall ? rand(-110, 0) : rand(0, 100);

            n.style.setProperty("--x", `${x.toFixed(2)}%`);
            n.style.setProperty("--y", `${y.toFixed(2)}%`);
            n.style.setProperty("--size", `${size.toFixed(2)}px`);
            n.style.setProperty("--alpha", alpha.toFixed(2));
            n.style.setProperty("--dur", `${dur.toFixed(2)}s`);
            n.style.setProperty("--delay", `${(-rand(0, dur)).toFixed(2)}s`);
            n.style.setProperty("--dx", `${dx.toFixed(1)}px`);
            n.style.setProperty("--dy", `${dy.toFixed(1)}px`);
            n.style.setProperty("--rot", `${rand(-26, 26).toFixed(1)}deg`);
            n.style.setProperty("--blur", `${rand(0, 1.4).toFixed(2)}px`);

            wrap.appendChild(n);
          }

          layer.appendChild(wrap);
        });
      }

      function buildSymbolRain(themeId = null) {
        const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];
        const activeTheme =
          String(
            themeId ||
              document.body?.getAttribute("data-theme") ||
              DEFAULT_SETTINGS.theme,
          ).trim() || DEFAULT_SETTINGS.theme;

        const configs = [
          {
            selector: ".sym-glass",
            count: 34,
            chars: ["o", ".", "*"],
            size: [12, 22],
            alpha: [0.22, 0.52],
            dur: [6, 13],
            drift: [-42, 42],
          },
          {
            selector: ".sym-brutal",
            count: 30,
            chars: ["#", "+", "="],
            size: [11, 20],
            alpha: [0.2, 0.42],
            dur: [6, 12],
            drift: [-28, 28],
          },
          {
            selector: ".sym-luxury",
            count: 36,
            chars: ["*", ".", "+"],
            size: [10, 20],
            alpha: [0.2, 0.46],
            dur: [7, 15],
            drift: [-36, 36],
          },
          {
            selector: ".sym-hacker",
            count: 72,
            chars: ["0", "1"],
            size: [12, 18],
            alpha: [0.3, 0.7],
            dur: [2.8, 6.2],
            drift: [-18, 18],
          },
          {
            selector: ".sym-aurora",
            count: 32,
            chars: ["~", "+", "*"],
            size: [11, 20],
            alpha: [0.2, 0.48],
            dur: [6, 13],
            drift: [-40, 40],
          },
          {
            selector: ".sym-mono",
            count: 46,
            chars: ["|", ".", ":"],
            size: [10, 16],
            alpha: [0.18, 0.4],
            dur: [5, 10],
            drift: [-20, 20],
          },
          {
            selector: ".sym-soft",
            count: 34,
            chars: ["o", ".", "o"],
            size: [11, 20],
            alpha: [0.2, 0.42],
            dur: [7, 14],
            drift: [-38, 38],
          },
          {
            selector: ".sym-material",
            count: 34,
            chars: ["@", "o", "."],
            size: [11, 20],
            alpha: [0.2, 0.42],
            dur: [7, 14],
            drift: [-32, 32],
          },
          {
            selector: ".sym-frosted",
            count: 46,
            chars: ["*", ".", "*"],
            size: [9, 16],
            alpha: [0.24, 0.52],
            dur: [5, 10],
            drift: [-26, 26],
          },
          {
            selector: ".sym-editorial",
            count: 36,
            leaf: true,
            size: [11, 20],
            alpha: [0.22, 0.46],
            dur: [7, 14],
            drift: [-42, 42],
          },
          {
            selector: ".sym-mathlight",
            count: 42,
            chars: ["", "", "", "", "", "", "x", "y", "+", "="],
            size: [12, 20],
            alpha: [0.2, 0.44],
            dur: [6, 13],
            drift: [-34, 34],
          },
          {
            selector: ".sym-mathdark",
            count: 50,
            chars: [
              "",
              "",
              "",
              "",
              "",
              "",
              "",
              "x",
              "y",
              "z",
            ],
            size: [12, 22],
            alpha: [0.24, 0.56],
            dur: [5, 12],
            drift: [-40, 40],
          },
        ];

        configs.forEach((cfg) => {
          const cfgTheme = cfg.selector.replace(/^\.(sym)-/, "");
          if (cfgTheme !== activeTheme) return;

          const layer = document.querySelector(cfg.selector);
          if (!layer) return;
          if (layer.dataset.ready === "1") return;
          layer.dataset.ready = "1";
          const nodeCount = scaleEffectCount(cfg.count, 6);

          for (let i = 0; i < nodeCount; i++) {
            const node = document.createElement("span");
            node.className = cfg.leaf ? "symbol-node leaf" : "symbol-node";
            if (!cfg.leaf) node.textContent = pick(cfg.chars);

            const size = rand(cfg.size[0], cfg.size[1]);
            const alpha = rand(cfg.alpha[0], cfg.alpha[1]);
            const dur = rand(cfg.dur[0], cfg.dur[1]);
            const y = rand(3, 92);
            const x = rand(0, 100);
            const drift = rand(cfg.drift[0], cfg.drift[1]);
            const rot = rand(-35, 35);

            node.style.setProperty("--y", `${y.toFixed(2)}%`);
            node.style.setProperty("--x", `${x.toFixed(2)}%`);
            node.style.setProperty("--size", `${size.toFixed(2)}px`);
            node.style.setProperty("--alpha", alpha.toFixed(2));
            node.style.setProperty("--dur", `${dur.toFixed(2)}s`);
            node.style.setProperty("--delay", `${(-rand(0, dur)).toFixed(2)}s`);
            node.style.setProperty("--drift", `${drift.toFixed(1)}px`);
            node.style.setProperty("--rot", `${rot.toFixed(1)}deg`);

            layer.appendChild(node);
          }
        });
      }

      const STORAGE_KEY = "uni_schedule_db";
      const DEFAULT_SETTINGS = {
        week: "odd",
        theme: "glass",
        stylePack: "base",
        anim: true,
        animIntensity: "high",
        uiMode: "auto",
        view: "grid",
        profileName: STR.name,
      };

      const app = {
        data: {
          classes: [],
          exams: [],
          notes: [],
          courseProgress: [],
          settings: { ...DEFAULT_SETTINGS },
          searchQuery: "",
          dismissedReminders: {},
          notifiedReminders: {},
          dismissedPinnedAlerts: {},
        },
        notificationLoopId: null,
        notificationVisibilityBound: false,
        notificationCheckRunning: false,
        liveUiLoopId: null,
        liveUiVisibilityBound: false,
        searchPersistTimerId: null,
        searchRenderRafId: null,

        normalizeTime(value, fallback) {
          const s = String(value || "");
          return /^([01]\d|2[0-3]):[0-5]\d$/.test(s) ? s : fallback;
        },

        toMinutes(hhmm) {
          const [h, m] = this.normalizeTime(hhmm, "00:00")
            .split(":")
            .map(Number);
          return h * 60 + m;
        },

        addMinutes(hhmm, minutes = CLASS_DURATION_MINUTES) {
          const base = this.toMinutes(this.normalizeTime(hhmm, "08:00"));
          const total = Math.min(base + minutes, 23 * 60 + 59);
          const hh = String(Math.floor(total / 60)).padStart(2, "0");
          const mm = String(total % 60).padStart(2, "0");
          return `${hh}:${mm}`;
        },

        normalizeCourseKey(name) {
          return String(name || "")
            .trim()
            .replace(/\s+/g, " ")
            .toLowerCase();
        },

        findClassByCourseName(name, list = this.data.classes) {
          const key = this.normalizeCourseKey(name);
          if (!key) return null;
          const arr = Array.isArray(list) ? list : [];
          return (
            arr.find((c) => this.normalizeCourseKey(c?.name) === key) || null
          );
        },

        getCourseNameByClassId(classId, list = this.data.classes) {
          const arr = Array.isArray(list) ? list : [];
          const id = Number(classId);
          const cls = arr.find((c) => Number(c.id) === id);
          return cls ? String(cls.name || "").trim() : "";
        },

        getUniqueCourses(list = this.data.classes) {
          const arr = Array.isArray(list) ? list : [];
          const byKey = new Map();
          arr.forEach((c) => {
            const name = String(c?.name || "").trim();
            const key = this.normalizeCourseKey(name);
            if (!key) return;

            if (!byKey.has(key)) {
              byKey.set(key, {
                key,
                name,
                classId: Number(c.id),
                prof: String(c.prof || "").trim(),
              });
              return;
            }

            const prev = byKey.get(key);
            if (!prev.prof && c.prof) prev.prof = String(c.prof).trim();
          });

          return Array.from(byKey.values()).sort((a, b) =>
            a.name.localeCompare(b.name, "fa"),
          );
        },

        normalizeData(raw) {
          const normalized = {
            classes: [...DEFAULT_CLASSES],
            exams: [],
            notes: [],
            courseProgress: [],
            settings: { ...DEFAULT_SETTINGS },
            searchQuery: "",
            dismissedReminders: {},
            notifiedReminders: {},
            dismissedPinnedAlerts: {},
          };
          const source = raw && typeof raw === "object" ? raw : {};

          const validThemeIds = new Set(THEMES.map((t) => t.id));
          const validTypes = new Set(["normal", "odd", "even"]);

          const sourceClasses = Array.isArray(source.classes)
            ? source.classes
            : DEFAULT_CLASSES;
          normalized.classes = sourceClasses
            .filter((c) => c && typeof c === "object")
            .map((c, idx) => {
              const start = this.normalizeTime(c.start, "08:00");
              const end = this.addMinutes(start, CLASS_DURATION_MINUTES);
              return {
                id: Number.isFinite(Number(c.id))
                  ? Number(c.id)
                  : Date.now() + idx,
                name: String(c.name || "").trim() || STR.course,
                classNo: String(c.classNo || c.classNumber || "").trim(),
                prof: String(c.prof || ""),
                unit: Number.isFinite(Number(c.unit)) ? Number(c.unit) : 0,
                day: Math.min(5, Math.max(0, Number(c.day) || 0)),
                start,
                end,
                type: validTypes.has(c.type) ? c.type : "normal",
                note: String(c.note || ""),
              };
            });

          if (Array.isArray(source.exams)) {
            normalized.exams = source.exams
              .filter((e) => e && typeof e === "object")
              .map((e, idx) => ({
                id: Number.isFinite(Number(e.id))
                  ? Number(e.id)
                  : Date.now() + idx,
                title: String(e.title || "").trim(),
                date:
                  typeof e.date === "string" &&
                  /^\d{4}-\d{2}-\d{2}$/.test(e.date)
                    ? e.date
                    : "",
                time: this.normalizeTime(e.time, "09:00"),
                location: String(e.location || ""),
                notifyBeforeMin: NOTIFY_BEFORE_OPTIONS.includes(
                  Number(e.notifyBeforeMin),
                )
                  ? Number(e.notifyBeforeMin)
                  : 0,
                notifyText: String(e.notifyText || "").trim(),
                notifyEnabled:
                  typeof e.notifyEnabled === "boolean" ? e.notifyEnabled : true,
                lastNotifiedSignature: String(e.lastNotifiedSignature || ""),
                lastNotifiedAt: String(e.lastNotifiedAt || ""),
              }));
          }

          if (Array.isArray(source.notes)) {
            normalized.notes = source.notes
              .filter((n) => n && typeof n === "object")
              .map((n, idx) => {
                const important = Boolean(n.important);
                return {
                  id: Number.isFinite(Number(n.id))
                    ? Number(n.id)
                    : Date.now() + idx,
                  classId: Number.isFinite(Number(n.classId))
                    ? Number(n.classId)
                    : null,
                  text: String(n.text || "").trim(),
                  important,
                  createdAt: String(n.createdAt || new Date().toISOString()),
                  alertDate:
                    important &&
                    typeof n.alertDate === "string" &&
                    /^\d{4}-\d{2}-\d{2}$/.test(n.alertDate)
                      ? n.alertDate
                      : "",
                  alertTime: important
                    ? this.normalizeTime(n.alertTime, "")
                    : "",
                  notifyBeforeMin:
                    important &&
                    NOTIFY_BEFORE_OPTIONS.includes(Number(n.notifyBeforeMin))
                      ? Number(n.notifyBeforeMin)
                      : 0,
                  notifyText: important
                    ? String(n.notifyText || "").trim()
                    : "",
                  notifyEnabled: important
                    ? typeof n.notifyEnabled === "boolean"
                      ? n.notifyEnabled
                      : true
                    : false,
                  lastNotifiedSignature: String(n.lastNotifiedSignature || ""),
                  lastNotifiedAt: String(n.lastNotifiedAt || ""),
                };
              })
              .filter((n) => n.text);
          }

          if (Array.isArray(source.courseProgress)) {
            const candidateProgress = source.courseProgress
              .filter((p) => p && typeof p === "object")
              .map((p, idx) => ({
                id: Number.isFinite(Number(p.id))
                  ? Number(p.id)
                  : Date.now() + idx,
                classId: Number.isFinite(Number(p.classId))
                  ? Number(p.classId)
                  : null,
                courseName: String(p.courseName || "").trim(),
                taughtUntil: String(p.taughtUntil || "").trim(),
                coveragePercent: Math.min(
                  100,
                  Math.max(0, Number(p.coveragePercent) || 0),
                ),
                sessionNo: Math.max(0, Math.floor(Number(p.sessionNo) || 0)),
                nextTopic: String(p.nextTopic || "").trim(),
                updatedAt: String(p.updatedAt || new Date().toISOString()),
              }));

            const byCourse = new Map();
            candidateProgress.forEach((p) => {
              const fallbackName = this.getCourseNameByClassId(
                p.classId,
                normalized.classes,
              );
              const courseName = String(
                p.courseName || fallbackName || "",
              ).trim();
              const key = this.normalizeCourseKey(courseName);
              if (!key) return;

              const matchedClass = this.findClassByCourseName(
                courseName,
                normalized.classes,
              );
              const next = {
                ...p,
                classId: matchedClass ? Number(matchedClass.id) : null,
                courseName: matchedClass
                  ? String(matchedClass.name || "").trim()
                  : courseName,
              };

              const prev = byCourse.get(key);
              if (!prev) {
                byCourse.set(key, next);
                return;
              }

              const prevTs = new Date(prev.updatedAt || "").getTime();
              const nextTs = new Date(next.updatedAt || "").getTime();
              if (
                Number.isFinite(nextTs) &&
                (!Number.isFinite(prevTs) || nextTs > prevTs)
              ) {
                byCourse.set(key, next);
              }
            });

            normalized.courseProgress = Array.from(byCourse.values());
          }

          if (Array.isArray(source.dismissedReminders)) {
            source.dismissedReminders.forEach((key) => {
              const clean = String(key || "").trim();
              if (/^food-\d{4}-\d{2}-\d{2}$/.test(clean)) {
                normalized.dismissedReminders[clean] = true;
              }
            });
          } else if (
            source.dismissedReminders &&
            typeof source.dismissedReminders === "object"
          ) {
            Object.entries(source.dismissedReminders).forEach(([key, val]) => {
              const clean = String(key || "").trim();
              if (/^food-\d{4}-\d{2}-\d{2}$/.test(clean) && Boolean(val)) {
                normalized.dismissedReminders[clean] = true;
              }
            });
          }

          const reminderKeys = Object.keys(normalized.dismissedReminders)
            .sort()
            .slice(-32);
          normalized.dismissedReminders = {};
          reminderKeys.forEach((key) => {
            normalized.dismissedReminders[key] = true;
          });

          if (Array.isArray(source.notifiedReminders)) {
            source.notifiedReminders.forEach((key) => {
              const clean = String(key || "").trim();
              if (/^food-\d{4}-\d{2}-\d{2}$/.test(clean)) {
                normalized.notifiedReminders[clean] = new Date().toISOString();
              }
            });
          } else if (
            source.notifiedReminders &&
            typeof source.notifiedReminders === "object"
          ) {
            Object.entries(source.notifiedReminders).forEach(([key, val]) => {
              const clean = String(key || "").trim();
              if (!/^food-\d{4}-\d{2}-\d{2}$/.test(clean)) return;
              const stamp = String(val || "").trim();
              normalized.notifiedReminders[clean] =
                stamp || new Date().toISOString();
            });
          }

          const notifiedKeys = Object.keys(normalized.notifiedReminders)
            .sort()
            .slice(-32);
          const compactNotified = {};
          notifiedKeys.forEach((key) => {
            compactNotified[key] = normalized.notifiedReminders[key];
          });
          normalized.notifiedReminders = compactNotified;

          if (
            source.dismissedPinnedAlerts &&
            typeof source.dismissedPinnedAlerts === "object"
          ) {
            const noteIdSet = new Set(
              normalized.notes
                .filter((n) => Number.isFinite(Number(n?.id)))
                .map((n) => String(Number(n.id))),
            );
            Object.entries(source.dismissedPinnedAlerts).forEach(
              ([key, val]) => {
                const noteId = String(key || "").trim();
                const sig = String(val || "").trim();
                if (!/^\d+$/.test(noteId) || !sig) return;
                if (!noteIdSet.has(noteId)) return;
                normalized.dismissedPinnedAlerts[noteId] = sig;
              },
            );
          }
          const pinnedKeys = Object.keys(normalized.dismissedPinnedAlerts)
            .sort((a, b) => Number(b) - Number(a))
            .slice(0, 300);
          const compactPinned = {};
          pinnedKeys.forEach((key) => {
            compactPinned[key] = normalized.dismissedPinnedAlerts[key];
          });
          normalized.dismissedPinnedAlerts = compactPinned;

          if (source.settings && typeof source.settings === "object") {
            normalized.settings = {
              week: source.settings.week === "even" ? "even" : "odd",
              theme: validThemeIds.has(source.settings.theme)
                ? source.settings.theme
                : DEFAULT_SETTINGS.theme,
              stylePack:
                source.settings.stylePack === "ultra" ? "ultra" : "base",
              anim:
                typeof source.settings.anim === "boolean"
                  ? source.settings.anim
                  : DEFAULT_SETTINGS.anim,
              animIntensity:
                source.settings.animIntensity === "low" ? "low" : "high",
              uiMode:
                source.settings.uiMode === "desktop" ||
                source.settings.uiMode === "mobile"
                  ? source.settings.uiMode
                  : DEFAULT_SETTINGS.uiMode,
              view: source.settings.view === "list" ? "list" : "grid",
              profileName:
                typeof source.settings.profileName === "string" &&
                source.settings.profileName.trim()
                  ? source.settings.profileName.trim()
                  : DEFAULT_SETTINGS.profileName,
            };
          }

          if (typeof source.searchQuery === "string") {
            normalized.searchQuery = source.searchQuery.toLowerCase();
          }

          return normalized;
        },

        persist() {
          try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(this.data));
          } catch (err) {
            console.error("Storage write failed:", err);
          }
        },

        init() {
          let parsed = null;
          try {
            const stored = localStorage.getItem(STORAGE_KEY);
            parsed = stored ? JSON.parse(stored) : null;
          } catch {
            parsed = null;
          }

          this.data = this.normalizeData(parsed);
          this.applyPerformanceProfile();

          this.renderStatic();
          this.setTheme(this.data.settings.theme, true);
          this.setStylePack(this.data.settings.stylePack, true);
          this.setWeek(this.data.settings.week, true);
          this.setAnimEnabled(this.data.settings.anim, true);
          this.setAnimIntensity(this.data.settings.animIntensity, true);
          this.setUiMode(this.data.settings.uiMode, true);
          this.setView(this.data.settings.view, true);

          const searchInput = document.getElementById("searchInput");
          if (searchInput) searchInput.value = this.data.searchQuery;

          this.updateNotificationPermissionUI();
          this.startNotificationLoop();
          this.startLiveUiLoop();
          this.refreshUI();
          this.persist();
        },

        save() {
          this.persist();
          this.refreshUI();
        },

        setWeek(w, silent = false) {
          const week = w === "even" ? "even" : "odd";
          this.data.settings.week = week;

          const odd = document.getElementById("btnOdd");
          const even = document.getElementById("btnEven");
          odd.textContent = STR.weekOdd;
          even.textContent = STR.weekEven;

          odd.className =
            week === "odd"
              ? "px-4 py-2 rounded-xl text-sm font-black bg-[var(--accent)] text-[var(--bg)] shadow-xl transition-all"
              : "px-4 py-2 rounded-xl text-sm font-black opacity-50 hover:opacity-100 transition-all";

          even.className =
            week === "even"
              ? "px-4 py-2 rounded-xl text-sm font-black bg-[var(--accent)] text-[var(--bg)] shadow-xl transition-all"
              : "px-4 py-2 rounded-xl text-sm font-black opacity-50 hover:opacity-100 transition-all";

          if (!silent) this.save();
        },

        getProfileName() {
          const name = String(this.data.settings.profileName || "").trim();
          return name || STR.name;
        },

        setProfileName(name, silent = false) {
          this.data.settings.profileName =
            String(name || "").trim() || STR.name;
          const profileEl = document.getElementById("txtProfile");
          if (profileEl) profileEl.innerText = this.getProfileName();
          if (!silent) this.save();
        },

        editProfileName() {
          const next = prompt(STR.promptProfileName, this.getProfileName());
          if (next === null) return;
          const clean = String(next).trim();
          if (!clean) {
            alert(STR.profileNameRequired);
            return;
          }
          this.setProfileName(clean);
        },

        applyPerformanceProfile() {
          const mode = PERF_PROFILE.lite ? "lite" : "normal";
          document.body.setAttribute("data-perf-mode", mode);

          if (PERF_PROFILE.lite) {
            this.data.settings.anim = false;
            this.data.settings.animIntensity = "low";
            this.data.settings.stylePack = "base";
          } else if (
            PERF_PROFILE.isMobile &&
            this.data.settings.anim &&
            this.data.settings.animIntensity !== "low"
          ) {
            this.data.settings.animIntensity = "low";
          }
        },

        setTheme(t, silent = false) {
          const validThemeIds = new Set(THEMES.map((x) => x.id));
          const theme = validThemeIds.has(t) ? t : DEFAULT_SETTINGS.theme;

          this.data.settings.theme = theme;
          document.body.setAttribute("data-theme", theme);

          const themeSelect = document.getElementById("themeSelect");
          if (themeSelect) themeSelect.value = theme;

          const shouldBuildFx = this.data.settings.anim && !PERF_PROFILE.lite;
          if (shouldBuildFx && theme === "hacker") buildBinaryRain();
          if (shouldBuildFx) buildThemeFx(theme);
          if (shouldBuildFx && !PERF_PROFILE.isMobile) buildSymbolRain(theme);

          if (!silent) this.save();
        },

        setStylePack(p, silent = false) {
          const pack = p === "ultra" ? "ultra" : "base";
          this.data.settings.stylePack = pack;
          document.body.setAttribute("data-style-pack", pack);
          const packSelect = document.getElementById("packSelect");
          if (packSelect) packSelect.value = pack;
          if (!silent) this.save();
        },

        setAnimEnabled(enabled, silent = false) {
          const state = Boolean(enabled);
          this.data.settings.anim = state;

          document.body.setAttribute("data-anim-enabled", state ? "on" : "off");

          const animEl = document.getElementById("bgAnim");
          if (animEl) {
            if (state) animEl.classList.remove("anim-off");
            else animEl.classList.add("anim-off");
          }

          if (state) {
            const theme = this.data.settings.theme || DEFAULT_SETTINGS.theme;
            if (!PERF_PROFILE.lite && theme === "hacker") buildBinaryRain();
            if (!PERF_PROFILE.lite) buildThemeFx(theme);
            if (!PERF_PROFILE.lite && !PERF_PROFILE.isMobile)
              buildSymbolRain(theme);
          }

          const modeSel = document.getElementById("animModeSelect");
          if (modeSel) modeSel.value = state ? "on" : "off";

          const intensitySel = document.getElementById("animIntensitySelect");
          if (intensitySel) {
            intensitySel.disabled = !state;
            intensitySel.classList.toggle("opacity-50", !state);
          }

          const btn = document.getElementById("btnAnimToggle");
          if (btn) {
            btn.classList.toggle("opacity-50", !state);
            btn.classList.toggle("grayscale", !state);
            btn.title = state ? STR.animToggleOnTitle : STR.animToggleOffTitle;
            btn.setAttribute("aria-pressed", state ? "true" : "false");
          }

          if (!silent) this.save();
        },

        setAnimIntensity(level, silent = false) {
          const intensity = level === "low" ? "low" : "high";
          this.data.settings.animIntensity = intensity;
          document.body.setAttribute("data-anim-intensity", intensity);

          const intensitySel = document.getElementById("animIntensitySelect");
          if (intensitySel) intensitySel.value = intensity;

          if (!silent) this.save();
        },

        setUiMode(mode, silent = false) {
          const uiMode =
            mode === "desktop" || mode === "mobile" ? mode : "auto";
          this.data.settings.uiMode = uiMode;
          document.body.setAttribute("data-ui-mode", uiMode);

          const uiModeSel = document.getElementById("uiModeSelect");
          if (uiModeSel) uiModeSel.value = uiMode;

          if (!silent) this.save();
        },

        isMobileLayout() {
          const mode = this.data?.settings?.uiMode || "auto";
          if (mode === "mobile") return true;
          if (mode === "desktop") return false;
          if (window.matchMedia)
            return window.matchMedia("(max-width: 1023.98px)").matches;
          return window.innerWidth < 1024;
        },

        getAlertDateTime(note) {
          if (!note || !note.alertDate || !note.alertTime) return null;
          const dt = new Date(`${note.alertDate}T${note.alertTime}:00`);
          return Number.isNaN(dt.getTime()) ? null : dt;
        },

        getAlertDayLabel(dateStr) {
          if (!dateStr) return "-";
          const dt = new Date(`${dateStr}T00:00:00`);
          if (Number.isNaN(dt.getTime())) return "-";
          return dt.toLocaleDateString("fa-IR", { weekday: "long" });
        },

        getNotifyBeforeLabel(minutes) {
          const m = Number(minutes);
          const labelMap = {
            0: STR.notifyAtTime,
            5: STR.notifyBefore5,
            10: STR.notifyBefore10,
            15: STR.notifyBefore15,
            20: STR.notifyBefore20,
            30: STR.notifyBefore30,
            45: STR.notifyBefore45,
            60: STR.notifyBefore60,
            90: STR.notifyBefore90,
            120: STR.notifyBefore120,
            180: STR.notifyBefore180,
            360: STR.notifyBefore360,
            720: STR.notifyBefore720,
            1440: STR.notifyBefore1440,
            2880: STR.notifyBefore2880,
            10080: STR.notifyBefore10080,
          };
          return labelMap[m] || STR.notifyAtTime;
        },

        toLocalDateKey(value) {
          const dt = value instanceof Date ? value : new Date(value);
          if (Number.isNaN(dt.getTime())) return "";
          const y = String(dt.getFullYear()).padStart(4, "0");
          const m = String(dt.getMonth() + 1).padStart(2, "0");
          const d = String(dt.getDate()).padStart(2, "0");
          return `${y}-${m}-${d}`;
        },

        getWeeklyFoodReminderStart(now = new Date()) {
          const ref = now instanceof Date ? now : new Date(now);
          if (Number.isNaN(ref.getTime())) return null;

          const start = new Date(ref);
          const dayDiff = (ref.getDay() - WEEKLY_FOOD_REMINDER.day + 7) % 7;
          start.setDate(ref.getDate() - dayDiff);
          start.setHours(
            WEEKLY_FOOD_REMINDER.hour,
            WEEKLY_FOOD_REMINDER.minute,
            0,
            0,
          );

          if (start.getTime() > ref.getTime()) {
            start.setDate(start.getDate() - 7);
          }
          return start;
        },

        getWeeklyFoodReminderInfo(now = new Date()) {
          const start = this.getWeeklyFoodReminderStart(now);
          if (!start) return null;

          const key = `food-${this.toLocalDateKey(start)}`;
          if (
            !key ||
            (this.data.dismissedReminders &&
              this.data.dismissedReminders[key] === true)
          ) {
            return null;
          }

          const hh = String(WEEKLY_FOOD_REMINDER.hour).padStart(2, "0");
          const mm = String(WEEKLY_FOOD_REMINDER.minute).padStart(2, "0");
          const sinceLabel = start.toLocaleDateString("fa-IR", {
            weekday: "long",
            month: "long",
            day: "numeric",
          });

          return {
            key,
            title: WEEKLY_FOOD_REMINDER.text,
            subtitle: `${sinceLabel} | ${hh}:${mm}`,
          };
        },

        dismissWeeklyFoodReminder(key) {
          const clean = String(key || "").trim();
          if (!/^food-\d{4}-\d{2}-\d{2}$/.test(clean)) return;

          if (
            !this.data.dismissedReminders ||
            typeof this.data.dismissedReminders !== "object"
          ) {
            this.data.dismissedReminders = {};
          }
          this.data.dismissedReminders[clean] = true;

          const reminderKeys = Object.keys(this.data.dismissedReminders)
            .sort()
            .slice(-32);
          const compact = {};
          reminderKeys.forEach((k) => {
            compact[k] = true;
          });
          this.data.dismissedReminders = compact;
          this.save();
        },

        isPinnedNoteDismissed(note) {
          if (!note || !Number.isFinite(Number(note.id))) return false;
          const key = String(Number(note.id));
          const signature = this.getNoteNotificationSignature(note);
          return Boolean(
            this.data.dismissedPinnedAlerts &&
            typeof this.data.dismissedPinnedAlerts === "object" &&
            this.data.dismissedPinnedAlerts[key] === signature,
          );
        },

        dismissPinnedNoteAlert(id) {
          const noteId = Number(id);
          if (!Number.isFinite(noteId)) return;
          const note = this.data.notes.find((n) => Number(n.id) === noteId);
          if (!note) return;

          if (
            !this.data.dismissedPinnedAlerts ||
            typeof this.data.dismissedPinnedAlerts !== "object"
          ) {
            this.data.dismissedPinnedAlerts = {};
          }
          this.data.dismissedPinnedAlerts[String(noteId)] =
            this.getNoteNotificationSignature(note);

          const keys = Object.keys(this.data.dismissedPinnedAlerts)
            .sort((a, b) => Number(b) - Number(a))
            .slice(0, 300);
          const compact = {};
          keys.forEach((k) => {
            compact[k] = this.data.dismissedPinnedAlerts[k];
          });
          this.data.dismissedPinnedAlerts = compact;
          this.save();
        },

        clearPinnedNoteDismissal(id) {
          const noteId = Number(id);
          if (!Number.isFinite(noteId)) return;
          if (
            !this.data.dismissedPinnedAlerts ||
            typeof this.data.dismissedPinnedAlerts !== "object"
          ) {
            return;
          }
          delete this.data.dismissedPinnedAlerts[String(noteId)];
        },

        prunePinnedAlertDismissals() {
          if (
            !this.data.dismissedPinnedAlerts ||
            typeof this.data.dismissedPinnedAlerts !== "object"
          ) {
            this.data.dismissedPinnedAlerts = {};
            return;
          }
          const validIds = new Set(
            this.data.notes
              .filter((n) => Number.isFinite(Number(n?.id)))
              .map((n) => String(Number(n.id))),
          );
          const compact = {};
          Object.entries(this.data.dismissedPinnedAlerts).forEach(
            ([noteId, signature]) => {
              const key = String(noteId || "").trim();
              const sig = String(signature || "").trim();
              if (!validIds.has(key) || !sig) return;
              compact[key] = sig;
            },
          );
          const keys = Object.keys(compact)
            .sort((a, b) => Number(b) - Number(a))
            .slice(0, 300);
          this.data.dismissedPinnedAlerts = {};
          keys.forEach((k) => {
            this.data.dismissedPinnedAlerts[k] = compact[k];
          });
        },

        hasFoodReminderNotified(key) {
          const clean = String(key || "").trim();
          if (!/^food-\d{4}-\d{2}-\d{2}$/.test(clean)) return false;
          return Boolean(
            this.data.notifiedReminders &&
            typeof this.data.notifiedReminders === "object" &&
            this.data.notifiedReminders[clean],
          );
        },

        markFoodReminderNotified(key) {
          const clean = String(key || "").trim();
          if (!/^food-\d{4}-\d{2}-\d{2}$/.test(clean)) return;

          if (
            !this.data.notifiedReminders ||
            typeof this.data.notifiedReminders !== "object"
          ) {
            this.data.notifiedReminders = {};
          }
          this.data.notifiedReminders[clean] = new Date().toISOString();

          const keys = Object.keys(this.data.notifiedReminders)
            .sort()
            .slice(-32);
          const compact = {};
          keys.forEach((k) => {
            compact[k] = this.data.notifiedReminders[k];
          });
          this.data.notifiedReminders = compact;
        },

        triggerFoodReminderNotification(reminder, fireAt) {
          if (!("Notification" in window)) return false;
          if (Notification.permission !== "granted") return false;
          if (!reminder || !reminder.key) return false;
          try {
            const notify = new Notification(reminder.title, {
              body: ` ${reminder.subtitle}`,
              tag: `uni-food-${reminder.key}`,
              timestamp: fireAt ? fireAt.getTime() : Date.now(),
            });
            notify.onclick = () => {
              window.focus();
              notify.close();
            };
            return true;
          } catch (err) {
            console.warn("Food notification failed:", err);
            return false;
          }
        },

        getNoteNotificationSignature(note) {
          return [
            note.id,
            note.alertDate || "",
            note.alertTime || "",
            Number(note.notifyBeforeMin || 0),
            note.notifyEnabled ? 1 : 0,
            note.notifyText || "",
            note.text || "",
          ].join("|");
        },

        getExamNotificationSignature(exam) {
          return [
            exam.id,
            exam.date || "",
            exam.time || "",
            Number(exam.notifyBeforeMin || 0),
            exam.notifyEnabled ? 1 : 0,
            exam.notifyText || "",
            exam.title || "",
          ].join("|");
        },

        isNoteSchedulable(note) {
          return Boolean(
            note &&
            note.important &&
            note.notifyEnabled &&
            note.alertDate &&
            note.alertTime,
          );
        },

        isExamSchedulable(exam) {
          return Boolean(exam && exam.notifyEnabled && exam.date && exam.time);
        },

        getNotificationContextIssue() {
          if (
            typeof window !== "undefined" &&
            window.location &&
            window.location.protocol === "file:"
          ) {
            return "file";
          }
          if (typeof window !== "undefined" && !window.isSecureContext) {
            return "insecure";
          }
          return "";
        },

        getNotificationSetupMessage() {
          const issue = this.getNotificationContextIssue();
          const base =
            issue === "file"
              ? STR.notifyContextFile
              : issue === "insecure"
                ? STR.notifyContextInsecure
                : STR.notifyPermissionHint;
          const origin = window.location?.origin || window.location?.href || "";
          const originLine = origin ? `\n\nOrigin : ${origin}` : "";
          return `${base}${originLine}\n\n${STR.notifySetupGuide}`;
        },

        updateNotificationPermissionUI() {
          const btn = document.getElementById("btnNotifyPermission");
          if (!btn) return;

          const issue = this.getNotificationContextIssue();
          if (issue) {
            btn.dataset.state = "unsupported";
            btn.disabled = false;
            btn.title =
              issue === "file"
                ? STR.notifyContextFile
                : STR.notifyContextInsecure;
            return;
          }

          if (!("Notification" in window)) {
            btn.dataset.state = "unsupported";
            btn.disabled = true;
            btn.title = STR.notifyNotSupported;
            return;
          }

          btn.disabled = false;
          const p = Notification.permission;
          btn.dataset.state = p;

          if (p === "granted") btn.title = STR.notifyPermissionGranted;
          else if (p === "denied") btn.title = STR.notifyPermissionDenied;
          else btn.title = STR.notifyPermission;
        },

        requestNotificationPermission(showFeedback = false) {
          const issue = this.getNotificationContextIssue();
          if (issue) {
            this.updateNotificationPermissionUI();
            if (showFeedback) alert(this.getNotificationSetupMessage());
            return Promise.resolve("unsupported");
          }

          if (!("Notification" in window)) {
            this.updateNotificationPermissionUI();
            if (showFeedback) alert(STR.notifyNotSupported);
            return Promise.resolve("unsupported");
          }

          if (Notification.permission === "granted") {
            this.updateNotificationPermissionUI();
            if (showFeedback) alert(STR.notifyPermissionGranted);
            this.checkDueNotifications();
            return Promise.resolve("granted");
          }

          if (Notification.permission === "denied") {
            this.updateNotificationPermissionUI();
            if (showFeedback)
              alert(
                `${STR.notifyPermissionDenied}\n\n${this.getNotificationSetupMessage()}`,
              );
            return Promise.resolve("denied");
          }

          return Notification.requestPermission()
            .then((perm) => {
              this.updateNotificationPermissionUI();
              if (showFeedback) {
                if (perm === "granted") alert(STR.notifyPermissionGranted);
                else if (perm === "denied")
                  alert(
                    `${STR.notifyPermissionDenied}\n\n${this.getNotificationSetupMessage()}`,
                  );
                else alert(this.getNotificationSetupMessage());
              }
              if (perm === "granted") this.checkDueNotifications();
              return perm;
            })
            .catch(() => {
              this.updateNotificationPermissionUI();
              return "default";
            });
        },

        startNotificationLoop() {
          if (this.notificationLoopId) return;

          const run = () => this.checkDueNotifications();
          this.notificationLoopId = window.setInterval(
            run,
            PERF_PROFILE.loopMs,
          );
          run();

          if (!this.notificationVisibilityBound) {
            document.addEventListener("visibilitychange", () => {
              if (document.visibilityState === "visible")
                this.checkDueNotifications();
            });
            window.addEventListener("focus", () =>
              this.checkDueNotifications(),
            );
            this.notificationVisibilityBound = true;
          }
        },

        startLiveUiLoop() {
          if (this.liveUiLoopId) return;

          const run = () => {
            ui.renderNextClass();
            ui.renderPinnedAlerts();
          };

          this.liveUiLoopId = window.setInterval(run, PERF_PROFILE.loopMs);
          run();

          if (!this.liveUiVisibilityBound) {
            document.addEventListener("visibilitychange", () => {
              if (document.visibilityState === "visible") run();
            });
            window.addEventListener("focus", run);
            this.liveUiVisibilityBound = true;
          }
        },

        triggerNotification(note, fireAt) {
          if (!("Notification" in window)) return false;
          if (Notification.permission !== "granted") return false;

          const cls = this.data.classes.find((c) => c.id === note.classId);
          const className = cls ? cls.name : STR.unknownClass;
          const bodyParts = [
            className,
            `${STR.alertDay}: ${this.getAlertDayLabel(note.alertDate)}`,
            `${STR.alertTime}: ${note.alertTime || "-"}`,
            note.text || "",
          ].filter(Boolean);
          const title = note.notifyText || note.text || STR.alertBoard;
          try {
            const notify = new Notification(title, {
              body: bodyParts.join("\n"),
              tag: `uni-note-${note.id}`,
              timestamp: fireAt ? fireAt.getTime() : Date.now(),
            });
            notify.onclick = () => {
              window.focus();
              notify.close();
            };
            return true;
          } catch (err) {
            console.warn("Note notification failed:", err);
            return false;
          }
        },

        triggerExamNotification(exam, fireAt) {
          if (!("Notification" in window)) return false;
          if (Notification.permission !== "granted") return false;

          const bodyParts = [
            `${STR.alertDay}: ${this.getAlertDayLabel(exam.date)}`,
            `${STR.alertTime}: ${exam.time || "-"}`,
            exam.location || "",
          ].filter(Boolean);
          const title = exam.notifyText || exam.title || STR.examReminder;
          try {
            const notify = new Notification(title, {
              body: bodyParts.join("\n"),
              tag: `uni-exam-${exam.id}`,
              timestamp: fireAt ? fireAt.getTime() : Date.now(),
            });
            notify.onclick = () => {
              window.focus();
              notify.close();
            };
            return true;
          } catch (err) {
            console.warn("Exam notification failed:", err);
            return false;
          }
        },

        checkDueNotifications() {
          if (this.notificationCheckRunning) return;
          this.notificationCheckRunning = true;
          this.updateNotificationPermissionUI();

          try {
            if (!("Notification" in window)) return;
            if (Notification.permission !== "granted") return;

            const nowMs = Date.now();
            let changed = false;

            this.data.notes = this.data.notes.map((note) => {
              if (!this.isNoteSchedulable(note)) return note;

              const alertAt = this.getAlertDateTime(note);
              if (!alertAt) return note;

              const fireAtMs =
                alertAt.getTime() - Number(note.notifyBeforeMin || 0) * 60000;
              const signature = this.getNoteNotificationSignature(note);
              const alreadyNotified =
                note.lastNotifiedSignature === signature &&
                typeof note.lastNotifiedAt === "string" &&
                note.lastNotifiedAt.length > 0;

              if (alreadyNotified) return note;
              if (nowMs < fireAtMs) return note;
              if (nowMs - fireAtMs > 24 * 60 * 60 * 1000) return note;

              const sent = this.triggerNotification(note, new Date(fireAtMs));
              if (!sent) return note;

              changed = true;
              return {
                ...note,
                lastNotifiedSignature: signature,
                lastNotifiedAt: new Date().toISOString(),
              };
            });

            this.data.exams = this.data.exams.map((exam) => {
              if (!this.isExamSchedulable(exam)) return exam;

              const examAt = new Date(`${exam.date}T${exam.time}:00`);
              if (Number.isNaN(examAt.getTime())) return exam;

              const fireAtMs =
                examAt.getTime() - Number(exam.notifyBeforeMin || 0) * 60000;
              const signature = this.getExamNotificationSignature(exam);
              const alreadyNotified =
                exam.lastNotifiedSignature === signature &&
                typeof exam.lastNotifiedAt === "string" &&
                exam.lastNotifiedAt.length > 0;

              if (alreadyNotified) return exam;
              if (nowMs < fireAtMs) return exam;
              if (nowMs - fireAtMs > 24 * 60 * 60 * 1000) return exam;

              const sent = this.triggerExamNotification(
                exam,
                new Date(fireAtMs),
              );
              if (!sent) return exam;

              changed = true;
              return {
                ...exam,
                lastNotifiedSignature: signature,
                lastNotifiedAt: new Date().toISOString(),
              };
            });

            const weeklyReminder = this.getWeeklyFoodReminderInfo(
              new Date(nowMs),
            );
            if (
              weeklyReminder &&
              !this.hasFoodReminderNotified(weeklyReminder.key)
            ) {
              const startAt = this.getWeeklyFoodReminderStart(new Date(nowMs));
              if (startAt && nowMs >= startAt.getTime()) {
                const sent = this.triggerFoodReminderNotification(
                  weeklyReminder,
                  startAt,
                );
                if (sent) {
                  this.markFoodReminderNotified(weeklyReminder.key);
                  changed = true;
                }
              }
            }

            if (changed) this.persist();
          } finally {
            this.notificationCheckRunning = false;
          }
        },

        setView(v, silent = false) {
          const view = v === "list" ? "list" : "grid";
          this.data.settings.view = view;

          document.getElementById("viewGrid").className =
            view === "grid"
              ? "px-3 py-2 rounded-xl text-sm font-black flex items-center gap-2 bg-[var(--accent)] text-[var(--bg)] shadow-lg"
              : "px-3 py-2 rounded-xl text-sm font-black flex items-center gap-2 opacity-50";

          document.getElementById("viewList").className =
            view === "list"
              ? "px-3 py-2 rounded-xl text-sm font-black flex items-center gap-2 bg-[var(--accent)] text-[var(--bg)] shadow-lg"
              : "px-3 py-2 rounded-xl text-sm font-black flex items-center gap-2 opacity-50";

          if (!silent) this.save();
        },

        toggleAnim(forceState, silent = false) {
          const newState =
            typeof forceState === "boolean"
              ? forceState
              : !this.data.settings.anim;
          this.setAnimEnabled(newState, silent);
        },

        search(q) {
          this.data.searchQuery = (q || "").toLowerCase();

          if (this.searchRenderRafId) {
            window.cancelAnimationFrame(this.searchRenderRafId);
          }
          this.searchRenderRafId = window.requestAnimationFrame(() => {
            this.searchRenderRafId = null;
            this.refreshUI();
          });

          if (this.searchPersistTimerId) {
            window.clearTimeout(this.searchPersistTimerId);
          }
          const persistDelay = PERF_PROFILE.lite ? 700 : 300;
          this.searchPersistTimerId = window.setTimeout(() => {
            this.searchPersistTimerId = null;
            this.persist();
          }, persistDelay);
        },

        resetData() {
          if (confirm(STR.alertReset)) {
            this.data.classes = this.normalizeData({
              classes: DEFAULT_CLASSES,
            }).classes;
            this.data.exams = [];
            this.data.notes = [];
            this.data.courseProgress = [];
            this.data.searchQuery = "";
            this.data.dismissedReminders = {};
            this.data.notifiedReminders = {};
            this.data.dismissedPinnedAlerts = {};

            const searchInput = document.getElementById("searchInput");
            if (searchInput) searchInput.value = "";

            this.save();
          }
        },

        addClass(c) {
          if (c.id)
            this.data.classes = this.data.classes.map((x) =>
              x.id === c.id ? c : x,
            );
          else {
            c.id = Date.now();
            this.data.classes.push(c);
          }
          ui.closeModal();
          this.save();
        },

        deleteClass(id) {
          const removed = this.data.classes.find((x) => x.id === id) || null;
          const removedName = String(removed?.name || "").trim();

          this.data.classes = this.data.classes.filter((x) => x.id !== id);
          this.data.notes = this.data.notes.filter((x) => x.classId !== id);
          this.prunePinnedAlertDismissals();
          this.data.courseProgress = this.data.courseProgress
            .map((x) => {
              const baseName = String(
                x.courseName ||
                  this.getCourseNameByClassId(x.classId) ||
                  removedName,
              ).trim();
              const matched = this.findClassByCourseName(baseName);
              if (!matched) return null;
              return {
                ...x,
                classId: Number(matched.id),
                courseName: String(matched.name || baseName).trim(),
              };
            })
            .filter((x) => x && this.normalizeCourseKey(x.courseName));
          ui.closeModal();
          this.save();
        },

        addExam(e) {
          const normalized = {
            ...e,
            title: String(e.title || "").trim(),
            date:
              typeof e.date === "string" && /^\d{4}-\d{2}-\d{2}$/.test(e.date)
                ? e.date
                : "",
            time: this.normalizeTime(e.time, "09:00"),
            location: String(e.location || "").trim(),
            notifyBeforeMin: NOTIFY_BEFORE_OPTIONS.includes(
              Number(e.notifyBeforeMin),
            )
              ? Number(e.notifyBeforeMin)
              : 0,
            notifyText: String(e.notifyText || "").trim(),
            notifyEnabled:
              typeof e.notifyEnabled === "boolean" ? e.notifyEnabled : true,
            lastNotifiedSignature: "",
            lastNotifiedAt: "",
          };

          if (e.id)
            this.data.exams = this.data.exams.map((x) =>
              x.id === e.id ? normalized : x,
            );
          else {
            normalized.id = Date.now();
            this.data.exams.push(normalized);
          }
          ui.closeModal();
          this.save();
          this.checkDueNotifications();
        },

        deleteExam(id) {
          this.data.exams = this.data.exams.filter((x) => x.id !== id);
          ui.closeModal();
          this.save();
        },

        addNote(n) {
          const important = Boolean(n.important);
          const normalized = {
            ...n,
            text: String(n.text || "").trim(),
            important,
            alertDate:
              important &&
              typeof n.alertDate === "string" &&
              /^\d{4}-\d{2}-\d{2}$/.test(n.alertDate)
                ? n.alertDate
                : "",
            alertTime: important ? this.normalizeTime(n.alertTime, "") : "",
            notifyBeforeMin:
              important &&
              NOTIFY_BEFORE_OPTIONS.includes(Number(n.notifyBeforeMin))
                ? Number(n.notifyBeforeMin)
                : 0,
            notifyText: important ? String(n.notifyText || "").trim() : "",
            notifyEnabled: important
              ? typeof n.notifyEnabled === "boolean"
                ? n.notifyEnabled
                : true
              : false,
            lastNotifiedSignature: "",
            lastNotifiedAt: "",
          };

          if (n.id)
            this.data.notes = this.data.notes.map((x) =>
              x.id === n.id ? normalized : x,
            );
          else {
            normalized.id = Date.now();
            this.data.notes.push(normalized);
          }
          this.clearPinnedNoteDismissal(normalized.id || n.id);
          this.prunePinnedAlertDismissals();
          ui.closeModal();
          this.save();
          this.checkDueNotifications();
        },

        deleteNote(id) {
          this.data.notes = this.data.notes.filter((x) => x.id !== id);
          this.clearPinnedNoteDismissal(id);
          this.prunePinnedAlertDismissals();
          ui.closeModal();
          this.save();
        },

        addCourseProgress(p) {
          const requestedClassId = Number.isFinite(Number(p.classId))
            ? Number(p.classId)
            : null;
          const selectedClass = requestedClassId
            ? this.data.classes.find((c) => Number(c.id) === requestedClassId)
            : null;
          const rawCourseName = String(
            selectedClass?.name || p.courseName || "",
          ).trim();
          const courseKey = this.normalizeCourseKey(rawCourseName);
          const matchedClass = this.findClassByCourseName(rawCourseName);

          const normalized = {
            ...p,
            classId: matchedClass ? Number(matchedClass.id) : requestedClassId,
            courseName: matchedClass
              ? String(matchedClass.name || rawCourseName).trim()
              : rawCourseName,
            taughtUntil: String(p.taughtUntil || "").trim(),
            coveragePercent: Math.min(
              100,
              Math.max(0, Number(p.coveragePercent) || 0),
            ),
            sessionNo: Math.max(0, Math.floor(Number(p.sessionNo) || 0)),
            nextTopic: String(p.nextTopic || "").trim(),
            updatedAt: new Date().toISOString(),
          };

          if (!courseKey) return;
          if (!normalized.taughtUntil) return;

          const currentId = Number.isFinite(Number(p.id)) ? Number(p.id) : null;
          const existingSameCourse = this.data.courseProgress.find(
            (x) =>
              this.normalizeCourseKey(
                x.courseName || this.getCourseNameByClassId(x.classId),
              ) === courseKey && x.id !== currentId,
          );

          if (p.id) {
            normalized.id = Number(p.id);
            this.data.courseProgress = this.data.courseProgress.map((x) =>
              x.id === normalized.id ? normalized : x,
            );
            if (existingSameCourse) {
              this.data.courseProgress = this.data.courseProgress.filter(
                (x) => x.id !== existingSameCourse.id,
              );
            }
          } else if (existingSameCourse) {
            normalized.id = existingSameCourse.id;
            this.data.courseProgress = this.data.courseProgress.map((x) =>
              x.id === existingSameCourse.id ? normalized : x,
            );
          } else {
            normalized.id = Date.now();
            this.data.courseProgress.push(normalized);
          }

          ui.closeModal();
          this.save();
        },

        deleteCourseProgress(id) {
          this.data.courseProgress = this.data.courseProgress.filter(
            (x) => x.id !== id,
          );
          ui.closeModal();
          this.save();
        },

        toggleNoteImportant(id, important) {
          this.data.notes = this.data.notes.map((n) =>
            n.id === id
              ? {
                  ...n,
                  important:
                    typeof important === "boolean" ? important : !n.important,
                  notifyEnabled:
                    typeof important === "boolean"
                      ? important
                      : !n.important || n.notifyEnabled,
                  lastNotifiedSignature: "",
                  lastNotifiedAt: "",
                }
              : n,
          );
          const target = this.data.notes.find(
            (n) => Number(n.id) === Number(id),
          );
          if (!target || !target.important) {
            this.clearPinnedNoteDismissal(id);
          }
          this.prunePinnedAlertDismissals();
          this.save();
          this.checkDueNotifications();
        },

        checkConflict(c1, c2) {
          if (c1.day !== c2.day) return false;
          if (c1.id === c2.id) return false;
          return c1.start < c2.end && c1.end > c2.start;
        },

        getWeekClasses() {
          const week = this.data.settings.week;
          return this.data.classes.filter(
            (c) => c.type === "normal" || c.type === week,
          );
        },

        getVisibleClasses() {
          const q = this.data.searchQuery;
          return this.getWeekClasses().filter((c) => {
            const hay = (
              c.name +
              " " +
              (c.classNo || "") +
              " " +
              (c.prof || "") +
              " " +
              (c.note || "")
            ).toLowerCase();
            return !q || hay.includes(q);
          });
        },

        refreshUI() {
          ui.renderSchedule();
          ui.renderNextClass();
          ui.renderExams();
          ui.renderNotes();
          ui.renderCourseProgress();
          ui.renderAlerts();
          ui.renderPinnedAlerts();
          ui.renderStats();
        },

        renderStatic() {
          document.getElementById("navTitle").innerText = STR.title;
          document.getElementById("navSub").innerText = STR.uni;
          document.getElementById("txtProfile").innerText =
            this.getProfileName();
          document.getElementById("btnEditProfile").title = STR.editProfile;
          document.getElementById("txtUnits").innerText = STR.units;
          document.getElementById("txtHours").innerText = STR.hours;
          document.getElementById("txtClasses").innerText = STR.classesCount;
          document.getElementById("txtNextClass").innerText = STR.nextClass;
          document.getElementById("txtExams").innerText = STR.exams;
          document.getElementById("txtNotesBoard").innerText = STR.notesBoard;
          document.getElementById("txtCourseProgress").innerText =
            STR.courseProgressBoard;
          document.getElementById("txtAlerts").innerText = STR.alertBoard;
          document.getElementById("txtGrid").innerText = STR.viewGrid;
          document.getElementById("txtList").innerText = STR.viewList;
          document.getElementById("txtAddClass").innerText = STR.addClass;

          const searchInput = document.getElementById("searchInput");
          searchInput.placeholder = STR.search;
          searchInput.value = this.data.searchQuery || "";

          const sel = document.getElementById("themeSelect");
          sel.innerHTML = THEMES.map(
            (t) => `<option value="${t.id}">${t.name}</option>`,
          ).join("");

          const packSel = document.getElementById("packSelect");
          if (packSel) {
            packSel.title = STR.stylePack;
            packSel.innerHTML = `
              <option value="base">${STR.packBase}</option>
              <option value="ultra">${STR.packUltra}</option>
            `;
            packSel.value = this.data.settings.stylePack || "base";
          }

          const animModeSel = document.getElementById("animModeSelect");
          if (animModeSel) {
            animModeSel.title = STR.animMode;
            animModeSel.innerHTML = `
              <option value="on">${STR.animEnabled}</option>
              <option value="off">${STR.animDisabled}</option>
            `;
            animModeSel.value = this.data.settings.anim ? "on" : "off";
          }

          const animIntensitySel = document.getElementById(
            "animIntensitySelect",
          );
          if (animIntensitySel) {
            animIntensitySel.title = STR.animIntensity;
            animIntensitySel.innerHTML = `
              <option value="low">${STR.animIntensityLow}</option>
              <option value="high">${STR.animIntensityHigh}</option>
            `;
            animIntensitySel.value = this.data.settings.animIntensity || "high";
          }

          const uiModeSel = document.getElementById("uiModeSelect");
          if (uiModeSel) {
            uiModeSel.title = STR.uiMode;
            uiModeSel.innerHTML = `
              <option value="auto">${STR.uiModeAuto}</option>
              <option value="desktop">${STR.uiModeDesktop}</option>
              <option value="mobile">${STR.uiModeMobile}</option>
            `;
            uiModeSel.value = this.data.settings.uiMode || "auto";
          }

          this.setStylePack(this.data.settings.stylePack || "base", true);
          this.setAnimEnabled(this.data.settings.anim, true);
          this.setAnimIntensity(
            this.data.settings.animIntensity || "high",
            true,
          );
          this.setUiMode(this.data.settings.uiMode || "auto", true);
          this.updateNotificationPermissionUI();
        },
      };

      const ui = {
        escapeHtml(v) {
          return String(v ?? "").replace(/[&<>"']/g, (ch) => {
            const map = {
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            };
            return map[ch] || ch;
          });
        },

        renderSchedule() {
          const container = document.getElementById("scheduleContainer");
          const classes = app.getVisibleClasses();

          if (app.data.settings.view === "grid") {
            if (app.isMobileLayout()) {
              const addStart = TIME_SLOTS[0][0];
              const addEnd = app.addMinutes(addStart, CLASS_DURATION_MINUTES);
              const now = new Date();
              const todayIdx = (now.getDay() + 1) % 7;
              const nowMinutes = now.getHours() * 60 + now.getMinutes();
              let html = `
              <div class="theme-card schedule-hint p-3 mb-3 text-xs font-black" style="color: var(--muted);">
                ${STR.addHint}
              </div>
              <div class="mobile-schedule-board">
              `;

              STR.days.forEach((dayName, dayIndex) => {
                const dayClasses = classes
                  .filter((c) => c.day === dayIndex)
                  .sort((a, b) => a.start.localeCompare(b.start));
                const isToday = dayIndex === todayIdx;

                html += `
                <section class="mobile-day-card theme-card ${isToday ? "mobile-day-card--today" : ""}">
                  <div class="mobile-day-head">
                    <div class="mobile-day-title-wrap">
                      <div class="mobile-day-title">${dayName}</div>
                      ${isToday ? `<span class="mobile-today-pill"></span>` : ""}
                    </div>
                    <div class="mobile-day-head-right">
                      <button
                        class="mobile-add-btn"
                        onclick="ui.openClassModalPrefill(event, ${dayIndex}, '${addStart}', '${addEnd}')"
                        type="button"
                      >
                        + ${STR.addClass}
                      </button>
                    </div>
                  </div>
                  <div class="mobile-day-meta">
                    <span class="chip">${isToday ? " " : " "} | ${dayClasses.length} </span>
                  </div>
                  <div class="mobile-day-classes">
                `;

                if (dayClasses.length === 0) {
                  html += `
                    <button
                      class="mobile-empty-slot"
                      onclick="ui.openClassModalPrefill(event, ${dayIndex}, '${addStart}', '${addEnd}')"
                      type="button"
                    >
                      + ${STR.addClass}
                    </button>
                  `;
                } else {
                  dayClasses.forEach((c) => {
                    const isConflict = classes.some((other) =>
                      app.checkConflict(c, other),
                    );
                    const badgeClass =
                      c.type === "odd"
                        ? "badge-odd"
                        : c.type === "even"
                          ? "badge-even"
                          : "badge-normal";
                    const badgeText =
                      c.type === "odd"
                        ? STR.typeOdd
                        : c.type === "even"
                          ? STR.typeEven
                          : STR.typeNormal;
                    const startMinutes = app.toMinutes(c.start);
                    const endMinutes = app.toMinutes(c.end);
                    const statusClass =
                      dayIndex !== todayIdx
                        ? ""
                        : nowMinutes >= startMinutes && nowMinutes < endMinutes
                          ? "is-now"
                          : nowMinutes < startMinutes
                            ? "is-upcoming"
                            : "is-past";
                    const statusChipClass =
                      statusClass === "is-now"
                        ? "state-now"
                        : statusClass === "is-upcoming"
                          ? "state-upcoming"
                          : statusClass === "is-past"
                            ? "state-past"
                            : "";
                    const statusText =
                      statusClass === "is-now"
                        ? "  "
                        : statusClass === "is-upcoming"
                          ? " "
                          : statusClass === "is-past"
                            ? " "
                            : "";
                    const unitText =
                      Number.isFinite(Number(c.unit)) && Number(c.unit) > 0
                        ? `${Number(c.unit)} `
                        : "";
                    const classNo = this.escapeHtml(
                      String(c.classNo || "").trim(),
                    );
                    const safeName = this.escapeHtml(c.name || STR.course);
                    const safeProf = this.escapeHtml(c.prof || "-");
                    const safeNote = this.escapeHtml(c.note || "");
                    const safeStart = this.escapeHtml(c.start || "-");
                    const safeEnd = this.escapeHtml(c.end || "-");

                    html += `
                      <div class="mobile-class-card ${statusClass}" onclick="ui.openClassModalFromCard(event, ${c.id})">
                        <div class="mobile-class-top">
                          <span class="mobile-class-time">${safeStart}-${safeEnd}</span>
                          <span class="badge ${badgeClass}">${badgeText}</span>
                        </div>
                        <div class="mobile-class-title">${safeName}</div>
                        ${classNo ? `<div class="class-number-line"><span class="class-number-chip">${this.escapeHtml(STR.classNumber)}: ${classNo}</span></div>` : ""}
                        <div class="mobile-class-prof">${safeProf}</div>
                        ${safeNote ? `<div class="mobile-class-note">${safeNote}</div>` : ""}
                        <div class="mobile-class-foot">
                          <span class="mobile-state-chip ${statusChipClass}">${statusText}</span>
                          <span class="mobile-class-unit">${unitText}</span>
                        </div>
                        ${isConflict ? `<div class="mobile-class-conflict">  </div>` : ""}
                      </div>
                    `;
                  });
                }

                html += `
                  </div>
                </section>
                `;
              });

              html += `</div>`;
              container.innerHTML = html;
              return;
            }

            let html = `
            <div class="theme-card schedule-hint p-3 mb-3 text-xs font-black" style="color: var(--muted);">
              ${STR.addHint}
            </div>

            <div class="schedule-frame">
              <div class="schedule-shell">
                <div class="schedule-grid theme-card" id="scheduleGrid">
          `;

            // Header row
            html += `<div class="grid-header sticky-top time-col">${STR.timeLabel}</div>`;
            STR.days.forEach(
              (d, col) =>
                (html += `<div class="grid-header sticky-top" data-col="${col}">${d}</div>`),
            );

            // Rows
            TIME_SLOTS.forEach((slot, row) => {
              const [start, end] = slot;

              html += `
              <div class="grid-cell time-slot time-col" data-row="${row}">
                <div>${start}</div>
                <div class="opacity-60">-</div>
                <div>${end}</div>
              </div>
            `;

              STR.days.forEach((_, dayIndex) => {
                const slotClasses = classes.filter(
                  (c) =>
                    c.day === dayIndex && c.start >= start && c.start < end,
                );

                html += `
                <div class="grid-cell" data-row="${row}" data-col="${dayIndex}"
                  onclick="ui.openClassModalPrefill(event, ${dayIndex}, '${start}', '${end}')">
                  <span class="mobile-day-header">${STR.days[dayIndex]} ${start}-${end}</span>
                  <span class="add-ghost">+ ${STR.addClass}</span>
              `;

                slotClasses.forEach((c) => {
                  const isConflict = classes.some((other) =>
                    app.checkConflict(c, other),
                  );
                  const badgeClass =
                    c.type === "odd"
                      ? "badge-odd"
                      : c.type === "even"
                        ? "badge-even"
                        : "badge-normal";
                  const badgeText =
                    c.type === "odd"
                      ? STR.typeOdd
                      : c.type === "even"
                        ? STR.typeEven
                        : STR.typeNormal;
                  const classNo = this.escapeHtml(
                    String(c.classNo || "").trim(),
                  );
                  const safeName = this.escapeHtml(c.name || STR.course);
                  const safeProf = this.escapeHtml(c.prof || "-");
                  const safeNote = this.escapeHtml(c.note || "");
                  const safeStart = this.escapeHtml(c.start || "-");
                  const safeEnd = this.escapeHtml(c.end || "-");

                  html += `
                  <div class="class-card class-card-${c.type}" data-type="${c.type}" onclick="ui.openClassModalFromCard(event, ${c.id})">
                    ${isConflict ? `<div class="absolute top-2 left-2 w-2 h-2 bg-red-500 rounded-full animate-ping"></div>` : ""}
                    <div class="class-title">${safeName}</div>
                    ${classNo ? `<div class="class-number-line"><span class="class-number-chip">${this.escapeHtml(STR.classNumber)}: ${classNo}</span></div>` : ""}
                    <div class="class-meta truncate">${safeProf}</div>
                    ${safeNote ? `<div class="class-meta mt-1">${safeNote}</div>` : ""}
                    <div class="class-foot">
                      <span class="badge ${badgeClass}">${badgeText}</span>
                      <span class="text-[10px] font-black opacity-75" style="font-family: var(--font-en);">${safeStart}-${safeEnd}</span>
                    </div>
                  </div>
                `;
                });

                html += `</div>`;
              });
            });

            html += `</div></div></div>`;
            container.innerHTML = html;

            // Hover highlight row/col
            const grid = document.getElementById("scheduleGrid");
            const canHover =
              window.matchMedia && window.matchMedia("(hover: hover)").matches;
            if (grid && canHover) {
              grid.addEventListener("mousemove", (e) => {
                const cell = e.target.closest(".grid-cell");
                if (!cell || !grid.contains(cell)) return;
                const r = cell.dataset.row;
                const c = cell.dataset.col;
                grid
                  .querySelectorAll(".grid-cell.hl, .grid-header.hl")
                  .forEach((x) => x.classList.remove("hl"));
                if (r !== undefined)
                  grid
                    .querySelectorAll(`[data-row="${r}"]`)
                    .forEach((x) => x.classList.add("hl"));
                if (c !== undefined)
                  grid
                    .querySelectorAll(`[data-col="${c}"]`)
                    .forEach((x) => x.classList.add("hl"));
              });
              grid.addEventListener("mouseleave", () => {
                grid
                  .querySelectorAll(".grid-cell.hl, .grid-header.hl")
                  .forEach((x) => x.classList.remove("hl"));
              });
            }
          } else {
            // LIST VIEW (premium cards)
            let html = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">`;
            if (classes.length === 0)
              html = `<div class="text-center py-12 opacity-50">${STR.noClass}</div>`;

            classes.sort(
              (a, b) =>
                a.day * 10000 +
                a.start.replace(":", "") -
                (b.day * 10000 + b.start.replace(":", "")),
            );

            classes.forEach((c) => {
              const badgeClass =
                c.type === "odd"
                  ? "badge-odd"
                  : c.type === "even"
                    ? "badge-even"
                    : "badge-normal";
              const badgeText =
                c.type === "odd"
                  ? STR.typeOdd
                  : c.type === "even"
                    ? STR.typeEven
                    : STR.typeNormal;
              const classNo = this.escapeHtml(String(c.classNo || "").trim());
              const safeName = this.escapeHtml(c.name || STR.course);
              const safeProf = this.escapeHtml(c.prof || "-");
              const safeNote = this.escapeHtml(c.note || "");
              const safeStart = this.escapeHtml(c.start || "-");
              const safeEnd = this.escapeHtml(c.end || "-");

              html += `
              <div onclick="ui.openClassModal(${c.id})" class="theme-card list-class-card list-class-${c.type} p-4 cursor-pointer hover:brightness-105 transition-all" style="border: 1px solid var(--border);" data-type="${c.type}">
                <div class="flex items-center justify-between gap-2">
                  <div class="font-black text-sm truncate">${safeName}</div>
                  <span class="badge ${badgeClass}">${badgeText}</span>
                </div>
                ${classNo ? `<div class="mt-1"><span class="class-number-chip">${this.escapeHtml(STR.classNumber)}: ${classNo}</span></div>` : ""}
                <div class="text-xs mt-1" style="color: var(--muted);">${safeProf}</div>
                ${safeNote ? `<div class="text-xs mt-1" style="color: var(--muted);">${safeNote}</div>` : ""}
                <div class="mt-3 flex justify-between text-xs font-black">
                  <span class="chip">${STR.days[c.day]}</span>
                  <span class="chip" style="font-family: var(--font-en);">${safeStart}-${safeEnd}</span>
                </div>
              </div>
            `;
            });

            html += `</div>`;
            container.innerHTML = html;
          }
        },

        renderNextClass() {
          const now = new Date();
          const jsDay = now.getDay(); // Sun=0
          const myDay = (jsDay + 1) % 7; // Sat->0
          const curTimeVal = now.getHours() * 60 + now.getMinutes();
          const nowDateLabel = now.toLocaleDateString("fa-IR", {
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric",
          });
          const nowTimeLabel = now.toLocaleTimeString("en-GB", {
            hour: "2-digit",
            minute: "2-digit",
            hour12: false,
          });

          const candidates = app.getVisibleClasses().map((c) => {
            const [h, m] = c.start.split(":").map(Number);
            const timeVal = h * 60 + m;
            let dayDiff = c.day - myDay;
            if (dayDiff < 0) dayDiff += 7;
            if (dayDiff === 0 && timeVal < curTimeVal) dayDiff = 7;

            const startAt = new Date(now);
            startAt.setDate(now.getDate() + dayDiff);
            startAt.setHours(h, m, 0, 0);

            return {
              ...c,
              score: dayDiff * 24 * 60 + (timeVal - curTimeVal),
              startAt,
            };
          });

          candidates.sort((a, b) => a.score - b.score);
          const next = candidates[0];

          const container = document.getElementById("nextClassContainer");
          if (!container) return;

          const formatRemaining = (ms) => {
            const totalMin = Math.max(0, Math.floor(ms / 60000));
            const d = Math.floor(totalMin / 1440);
            const h = Math.floor((totalMin % 1440) / 60);
            const m = totalMin % 60;
            const parts = [];

            if (d > 0) parts.push(`${d.toLocaleString("fa-IR")} `);
            if (h > 0) parts.push(`${h.toLocaleString("fa-IR")} `);
            if (m > 0 || parts.length > 0)
              parts.push(`${m.toLocaleString("fa-IR")} `);
            if (parts.length === 0) return "   ";
            return parts.slice(0, 3).join("  ");
          };

          if (!next) {
            container.innerHTML = `
              <div class="next-live-meta">
                <span class="next-now-chip"></span>
                <span>${this.escapeHtml(nowDateLabel)}</span>
                <span class="next-time-clock">${this.escapeHtml(nowTimeLabel)}</span>
              </div>
              <div class="opacity-50 text-sm py-2">${STR.noClass}</div>
            `;
            return;
          }

          const badgeClass =
            next.type === "odd"
              ? "badge-odd"
              : next.type === "even"
                ? "badge-even"
                : "badge-normal";
          const badgeText =
            next.type === "odd"
              ? STR.typeOdd
              : next.type === "even"
                ? STR.typeEven
                : STR.typeNormal;
          const safeName = this.escapeHtml(next.name || STR.course);
          const safeClassNo = this.escapeHtml(
            String(next.classNo || "").trim(),
          );
          const safeProf = this.escapeHtml(next.prof || "-");
          const safeNote = this.escapeHtml(next.note || "");
          const safeStart = this.escapeHtml(next.start || "-");
          const nextDateLabel = next.startAt.toLocaleDateString("fa-IR", {
            weekday: "long",
            month: "long",
            day: "numeric",
          });
          const nextTimeLabel = next.startAt.toLocaleTimeString("en-GB", {
            hour: "2-digit",
            minute: "2-digit",
            hour12: false,
          });
          const remainingMs = next.startAt.getTime() - now.getTime();
          const remainingText = formatRemaining(remainingMs);
          const remainingMin = Math.max(0, Math.floor(remainingMs / 60000));
          const remainingMinEn = remainingMin.toLocaleString("en-US");

          container.innerHTML = `
          <div class="animate-fade-in">
            <div class="next-live-meta">
              <span class="next-now-chip"></span>
              <span>${this.escapeHtml(nowDateLabel)}</span>
              <span class="next-time-clock">${this.escapeHtml(nowTimeLabel)}</span>
            </div>
            <h3 class="text-xl font-black mb-1 leading-tight">${safeName}</h3>
            <p class="text-sm mb-2" style="color: var(--muted);">${safeProf}</p>
            ${safeNote ? `<p class="text-xs mb-3" style="color: var(--muted);">${safeNote}</p>` : `<div class="mb-3"></div>`}
            <div class="flex items-center gap-2 flex-wrap">
              <span class="chip">${STR.days[next.day]} <span style="font-family: var(--font-en);">${safeStart}</span></span>
              <span class="badge ${badgeClass}">${badgeText}</span>
            </div>
            ${safeClassNo ? `<div class="next-class-no-wrap"><span class="next-class-no-label">${this.escapeHtml(STR.classNumber)}</span><span class="next-class-no-badge">${safeClassNo}</span></div>` : ""}
            <div class="next-time-panel">
              <span class="next-time-date">${this.escapeHtml(nextDateLabel)}</span>
              <span class="next-time-clock">${this.escapeHtml(nextTimeLabel)}</span>
            </div>
            <div class="next-minute-left">
              <span>  </span>
              <span class="next-minute-num">${this.escapeHtml(remainingMinEn)}</span>
            </div>
            <div class="next-next-at">   </div>
            <div class="next-countdown">    ${this.escapeHtml(remainingText)} </div>
          </div>
        `;
        },

        renderExams() {
          const list = document.getElementById("examList");
          const exams = app.data.exams
            .slice()
            .sort((a, b) => new Date(a.date) - new Date(b.date));

          if (exams.length === 0) {
            list.innerHTML = `<div class="text-center opacity-40 text-xs mt-10">${STR.noClass}</div>`;
            return;
          }

          list.innerHTML = exams
            .map((e) => {
              const examDay = app.getAlertDayLabel(e.date);
              const notifyMeta = e.notifyEnabled
                ? app.getNotifyBeforeLabel(e.notifyBeforeMin)
                : "-";
              const notifyText = this.escapeHtml(
                String(e.notifyText || e.title || ""),
              );
              const safeTitle = this.escapeHtml(e.title || "-");
              const safeDate = this.escapeHtml(e.date || "-");
              const safeTime = this.escapeHtml(e.time || "-");
              const safeLocation = this.escapeHtml(e.location || "-");

              return `
          <div onclick="ui.openExamModal(${e.id})" class="p-3 rounded-2xl border border-[var(--border)] cursor-pointer hover:brightness-105 transition-all"
               style="background: color-mix(in srgb, var(--card-bg) 80%, transparent); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px);">
            <div class="flex justify-between gap-2">
              <span class="font-black text-xs truncate">${safeTitle}</span>
              <span class="font-black text-[10px] opacity-70" style="font-family: var(--font-en);">${safeDate}</span>
            </div>
            <div class="text-[10px] mt-1" style="color: var(--muted);">
              ${safeLocation} | <span style="font-family: var(--font-en);">${safeTime}</span>
            </div>
            <div class="text-[10px] mt-1 opacity-70">
              ${STR.alertDay}: ${this.escapeHtml(examDay)}
            </div>
            <div class="text-[10px] mt-1 opacity-70">
              ${STR.notifyWhen}: ${this.escapeHtml(notifyMeta)}
            </div>
            ${e.notifyEnabled ? `<div class="text-[10px] mt-1 opacity-70">${STR.notifyText}: ${notifyText}</div>` : ""}
          </div>
        `;
            })
            .join("");
        },

        deleteNoteFromCard(ev, id) {
          if (ev) ev.stopPropagation();
          app.deleteNote(id);
        },

        dismissWeeklyFoodReminder(ev, key) {
          if (ev) ev.stopPropagation();
          app.dismissWeeklyFoodReminder(key);
        },

        dismissPinnedNoteAlert(ev, id) {
          if (ev) ev.stopPropagation();
          app.dismissPinnedNoteAlert(id);
        },

        unpinNoteFromCard(ev, id) {
          if (ev) ev.stopPropagation();
          app.toggleNoteImportant(id, false);
        },

        deleteCourseProgressFromCard(ev, id) {
          if (ev) ev.stopPropagation();
          app.deleteCourseProgress(id);
        },

        renderNotes() {
          const list = document.getElementById("noteList");
          if (!list) return;

          const notes = app.data.notes
            .slice()
            .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

          if (notes.length === 0) {
            list.innerHTML = `<div class="text-center opacity-40 text-xs mt-10">${STR.noNotes}</div>`;
            return;
          }

          list.innerHTML = notes
            .map((n) => {
              const cls = app.data.classes.find((c) => c.id === n.classId);
              const classTitle = cls
                ? this.escapeHtml(cls.name)
                : this.escapeHtml(STR.unknownClass);
              const classMeta = cls
                ? `${STR.days[cls.day]} | <span style="font-family: var(--font-en);">${cls.start}-${cls.end}</span>`
                : this.escapeHtml(STR.unknownClass);

              const d = new Date(n.createdAt);
              const dateText = Number.isNaN(d.getTime())
                ? "-"
                : d.toLocaleDateString("fa-IR");
              const alertDay = app.getAlertDayLabel(n.alertDate);
              const alertMeta =
                n.alertDate && n.alertTime
                  ? `${alertDay} | <span style="font-family: var(--font-en);">${n.alertDate} ${n.alertTime}</span>`
                  : "-";
              const notifyMeta =
                n.important && n.notifyEnabled
                  ? `${app.getNotifyBeforeLabel(n.notifyBeforeMin)}`
                  : "-";
              const importantBadge = n.important
                ? `<span class="badge badge-alert"> ${STR.alertBoard}</span>`
                : "";

              return `
          <div onclick="ui.openNoteModal(${n.id})" class="p-3 rounded-2xl border border-[var(--border)] cursor-pointer hover:brightness-105 transition-all"
               style="background: color-mix(in srgb, var(--card-bg) 80%, transparent); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px);">
            <div class="flex justify-between items-start gap-2 mb-1">
              <span class="font-black text-xs leading-5">${classTitle}</span>
              <button onclick="ui.deleteNoteFromCard(event, ${n.id})"
                      class="w-6 h-6 rounded-full text-red-500 hover:bg-red-500/10 text-sm font-black leading-none"></button>
            </div>
            <div class="text-[11px] mb-2 opacity-80 flex items-center justify-between gap-2">${classMeta}${importantBadge}</div>
            <div class="text-[10px] mb-1 opacity-70">${STR.alertDay}: ${alertMeta}</div>
            <div class="text-[10px] mb-2 opacity-70">${STR.notifyWhen}: ${this.escapeHtml(notifyMeta)}</div>
            <div class="text-[11px] leading-5">${this.escapeHtml(n.text)}</div>
            <div class="text-[10px] mt-2 opacity-60" style="font-family: var(--font-en);">${dateText}</div>
          </div>
        `;
            })
            .join("");
        },

        renderCourseProgress() {
          const list = document.getElementById("courseProgressList");
          const summary = document.getElementById("courseProgressSummary");
          if (!list || !summary) return;

          const courses = app.getUniqueCourses();
          const courseIndex = new Map(courses.map((c, idx) => [c.key, idx]));

          const items = app.data.courseProgress.slice().sort((a, b) => {
            const ak = app.normalizeCourseKey(
              a.courseName || app.getCourseNameByClassId(a.classId),
            );
            const bk = app.normalizeCourseKey(
              b.courseName || app.getCourseNameByClassId(b.classId),
            );
            const ai = courseIndex.has(ak)
              ? courseIndex.get(ak)
              : Number.MAX_SAFE_INTEGER;
            const bi = courseIndex.has(bk)
              ? courseIndex.get(bk)
              : Number.MAX_SAFE_INTEGER;
            if (ai !== bi) return ai - bi;
            return new Date(b.updatedAt) - new Date(a.updatedAt);
          });

          const trackedCount = items.length;
          const totalCourses = courses.length;
          const untrackedCount = Math.max(0, totalCourses - trackedCount);
          const avgProgress = trackedCount
            ? Math.round(
                items.reduce(
                  (sum, p) => sum + Math.max(0, Number(p.coveragePercent) || 0),
                  0,
                ) / trackedCount,
              )
            : 0;

          const toFa = (n) => Number(n || 0).toLocaleString("fa-IR");
          summary.innerHTML = `
            <div class="course-progress-stats">
              <div class="course-progress-stat">
                <div class="value">${toFa(trackedCount)}</div>
                <div class="label">${STR.progressTracked}</div>
              </div>
              <div class="course-progress-stat">
                <div class="value">${toFa(avgProgress)}%</div>
                <div class="label">${STR.progressAverage}</div>
              </div>
              <div class="course-progress-stat">
                <div class="value">${toFa(untrackedCount)}</div>
                <div class="label">${STR.progressUntracked}</div>
              </div>
            </div>
          `;

          if (items.length === 0) {
            list.innerHTML = `<div class="text-center opacity-45 text-xs mt-10">${STR.progressNoData}</div>`;
            return;
          }

          list.innerHTML = items
            .map((p) => {
              const courseName = String(
                p.courseName || app.getCourseNameByClassId(p.classId),
              ).trim();
              const courseKey = app.normalizeCourseKey(courseName);
              const courseInfo =
                courses.find((c) => c.key === courseKey) || null;

              const classTitle = this.escapeHtml(
                courseInfo?.name || courseName || STR.unknownClass,
              );
              const classMeta = courseInfo?.prof
                ? `: ${this.escapeHtml(courseInfo.prof)}`
                : "";
              const percent = Math.min(
                100,
                Math.max(0, Math.round(Number(p.coveragePercent) || 0)),
              );
              const percentFa = toFa(percent);
              const taughtUntil = this.escapeHtml(p.taughtUntil || "-");
              const nextTopic = this.escapeHtml(p.nextTopic || "");
              const sessionNo = Math.max(
                0,
                Math.floor(Number(p.sessionNo) || 0),
              );
              const sessionChip =
                sessionNo > 0
                  ? `<span class="chip py-1 px-2"> ${toFa(sessionNo)}</span>`
                  : "";

              const updated = new Date(p.updatedAt || "");
              const updatedLabel = Number.isNaN(updated.getTime())
                ? "-"
                : updated.toLocaleDateString("fa-IR", {
                    month: "long",
                    day: "numeric",
                  });

              return `
                <div onclick="ui.openCourseProgressModal(${p.id})" class="p-3 rounded-2xl border border-[var(--border)] cursor-pointer hover:brightness-105 transition-all"
                     style="background: color-mix(in srgb, var(--card-bg) 80%, transparent); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px);">
                  <div class="flex justify-between items-start gap-2 mb-1">
                    <span class="font-black text-xs leading-5">${classTitle}</span>
                    <button onclick="ui.deleteCourseProgressFromCard(event, ${p.id})"
                            class="w-6 h-6 rounded-full text-red-500 hover:bg-red-500/10 text-sm font-black leading-none"></button>
                  </div>
                  ${classMeta ? `<div class="text-[10px] mb-2 opacity-75">${classMeta}</div>` : `<div class="mb-2"></div>`}
                  <div class="flex items-center justify-between gap-2 mb-1">
                    <span class="chip py-1 px-2">${percentFa}%</span>
                    ${sessionChip}
                  </div>
                  <div class="course-progress-line mb-2" style="--progress: ${percent}%;">
                    <span></span>
                  </div>
                  <div class="text-[11px] leading-5 mb-1">
                    <span class="opacity-70">${STR.progressUntil}:</span>
                    <span>${taughtUntil}</span>
                  </div>
                  ${nextTopic ? `<div class="text-[10px] opacity-75">${STR.progressNextTopic}: ${nextTopic}</div>` : ""}
                  <div class="text-[10px] mt-2 opacity-60">${STR.progressUpdatedAt}: ${this.escapeHtml(updatedLabel)}</div>
                </div>
              `;
            })
            .join("");
        },

        renderAlerts() {
          const list = document.getElementById("alertList");
          if (!list) return;

          const alerts = app.data.notes
            .filter((n) => n.important)
            .slice()
            .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

          if (alerts.length === 0) {
            list.innerHTML = `<div class="text-center opacity-40 text-xs mt-10">${STR.noAlerts}</div>`;
            return;
          }

          list.innerHTML = alerts
            .map((n) => {
              const cls = app.data.classes.find((c) => c.id === n.classId);
              const classTitle = cls
                ? this.escapeHtml(cls.name)
                : this.escapeHtml(STR.unknownClass);
              const classMeta = cls
                ? `${STR.days[cls.day]} | <span style="font-family: var(--font-en);">${cls.start}-${cls.end}</span>`
                : this.escapeHtml(STR.unknownClass);
              const alertDay = app.getAlertDayLabel(n.alertDate);
              const alertMeta =
                n.alertDate && n.alertTime
                  ? `${alertDay} | <span style="font-family: var(--font-en);">${n.alertDate} ${n.alertTime}</span>`
                  : "-";
              const notifyText = this.escapeHtml(
                String(n.notifyText || n.text || ""),
              );
              const notifyMeta = this.escapeHtml(
                app.getNotifyBeforeLabel(n.notifyBeforeMin),
              );

              return `
          <div onclick="ui.openNoteModal(${n.id})" class="alert-card p-3 rounded-2xl border border-red-500/30 cursor-pointer hover:brightness-105 transition-all"
               style="background: color-mix(in srgb, var(--card-bg) 82%, transparent); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px);">
            <div class="flex justify-between items-start gap-2 mb-1">
              <span class="alert-card-title">${classTitle}</span>
              <div class="flex items-center gap-1">
                <button onclick="ui.dismissPinnedNoteAlert(event, ${n.id})"
                        class="px-2 py-1 rounded-xl text-[10px] font-black text-sky-600 hover:bg-sky-500/10"></button>
                <button onclick="ui.unpinNoteFromCard(event, ${n.id})"
                        class="px-2 py-1 rounded-xl text-[10px] font-black text-amber-600 hover:bg-amber-500/10">${STR.unpin}</button>
                <button onclick="ui.deleteNoteFromCard(event, ${n.id})"
                        class="w-6 h-6 rounded-full text-red-500 hover:bg-red-500/10 text-sm font-black leading-none"></button>
              </div>
            </div>
            <div class="alert-card-meta mb-2">${classMeta}</div>
            <div class="alert-card-meta mb-1">${STR.alertDay}: ${alertMeta}</div>
            <div class="alert-card-meta mb-1">${STR.notifyWhen}: ${notifyMeta}</div>
            ${notifyText ? `<div class="alert-card-highlight mb-2">${STR.notifyText}: ${notifyText}</div>` : ""}
            <div class="alert-card-highlight">${this.escapeHtml(n.text)}</div>
          </div>
        `;
            })
            .join("");
        },

        renderPinnedAlerts() {
          const bar = document.getElementById("pinnedAlertsBar");
          if (!bar) return;

          const alerts = app.data.notes
            .filter((n) => n.important && !app.isPinnedNoteDismissed(n))
            .slice()
            .sort((a, b) => {
              const aHasDate = a.alertDate && a.alertTime;
              const bHasDate = b.alertDate && b.alertTime;
              if (aHasDate && bHasDate) {
                const at = new Date(
                  `${a.alertDate}T${a.alertTime}:00`,
                ).getTime();
                const bt = new Date(
                  `${b.alertDate}T${b.alertTime}:00`,
                ).getTime();
                if (Number.isFinite(at) && Number.isFinite(bt)) return at - bt;
              }
              if (aHasDate !== bHasDate) return aHasDate ? -1 : 1;
              return new Date(b.createdAt) - new Date(a.createdAt);
            });
          const weeklyFoodReminder = app.getWeeklyFoodReminderInfo();
          const pinnedItems = [];

          if (weeklyFoodReminder) {
            pinnedItems.push({
              type: "food",
              payload: weeklyFoodReminder,
            });
          }

          const noteCap = weeklyFoodReminder ? 2 : 3;
          alerts.slice(0, noteCap).forEach((n) => {
            pinnedItems.push({
              type: "note",
              payload: n,
            });
          });

          if (pinnedItems.length === 0) {
            bar.innerHTML = "";
            bar.classList.add("hidden");
            document.body.classList.remove("has-pinned-alerts");
            return;
          }

          bar.innerHTML = pinnedItems
            .map((item) => {
              if (item.type === "food") {
                const reminder = item.payload;
                const reminderKey = this.escapeHtml(reminder.key);
                return `
                  <div class="pinned-alert-item pinned-alert-item--food">
                    <span class="pinned-alert-main">
                      <span class="pinned-alert-title">${this.escapeHtml(reminder.title)}</span>
                      <span class="pinned-alert-sub">${this.escapeHtml(reminder.subtitle)}</span>
                    </span>
                    <span class="pinned-alert-actions">
                      <span class="pinned-alert-icon pinned-alert-icon--food"></span>
                      <button type="button" class="pinned-alert-close" onclick="ui.dismissWeeklyFoodReminder(event, '${reminderKey}')" aria-label=" "></button>
                    </span>
                  </div>
                `;
              }

              const n = item.payload;
              const cls = app.data.classes.find((c) => c.id === n.classId);
              const classTitle = cls
                ? this.escapeHtml(cls.name)
                : this.escapeHtml(STR.unknownClass);
              const due =
                n.alertDate && n.alertTime
                  ? `${this.escapeHtml(app.getAlertDayLabel(n.alertDate))} | <span style="font-family: var(--font-en);">${this.escapeHtml(n.alertDate)} ${this.escapeHtml(n.alertTime)}</span>`
                  : "  ";
              const shortText = this.escapeHtml(
                String(n.notifyText || n.text || ""),
              );

              return `
                  <div class="pinned-alert-item pinned-alert-item--note">
                    <button type="button" class="pinned-alert-main-btn" onclick="ui.openNoteModal(${n.id})">
                      <span class="pinned-alert-main">
                        <span class="pinned-alert-title"> ${classTitle}</span>
                        <span class="pinned-alert-sub">${due}</span>
                        ${shortText ? `<span class="pinned-alert-sub">${shortText}</span>` : ""}
                      </span>
                    </button>
                    <span class="pinned-alert-actions">
                      <span class="pinned-alert-icon">!</span>
                      <button type="button" class="pinned-alert-close" onclick="ui.dismissPinnedNoteAlert(event, ${n.id})" aria-label=" "></button>
                    </span>
                  </div>
                `;
            })
            .join("");

          bar.classList.remove("hidden");
          document.body.classList.add("has-pinned-alerts");
        },

        renderStats() {
          const weekClasses = app.getWeekClasses();

          // Units: sum of unique courses (max unit per course), ignore unit 0
          const map = new Map();
          for (const c of weekClasses) {
            const key = (c.name || "").trim();
            if (!key) continue;
            const u = Number(c.unit || 0);
            const prev = map.get(key) || 0;
            map.set(key, Math.max(prev, u));
          }
          const units = Array.from(map.values()).reduce(
            (a, b) => a + (b || 0),
            0,
          );

          const totalMinutes = weekClasses.reduce((sum, c) => {
            const diff = app.toMinutes(c.end) - app.toMinutes(c.start);
            return sum + Math.max(0, diff);
          }, 0);
          const hours = (totalMinutes / 60).toFixed(1);
          const classCount = weekClasses.length;

          document.getElementById("statUnits").innerText = String(units);
          document.getElementById("statHours").innerText = hours;
          document.getElementById("statClasses").innerText = String(classCount);
        },

        openCourseProgressModal(id = null) {
          const item = id
            ? app.data.courseProgress.find((x) => x.id === id)
            : null;
          const title = item ? STR.modalEdit : STR.modalAdd;
          const courses = app.getUniqueCourses();

          if (courses.length === 0) {
            const html = `
              <div class="theme-card p-6 w-full max-w-md shadow-2xl animate-fade-in" onclick="ui.stopEvent(event)"
                   style="background: color-mix(in srgb, var(--card-bg) 90%, transparent);">
                <h3 class="text-xl font-black mb-4">${STR.courseProgressBoard}</h3>
                <p class="text-sm opacity-80 mb-4">           .</p>
                <button type="button" onclick="ui.closeModal()" class="w-full py-2.5 bg-[var(--accent)] text-[var(--bg)] font-black rounded-2xl hover:brightness-110 shadow-xl">${STR.cancel}</button>
              </div>
            `;
            const overlay = document.getElementById("modalOverlay");
            overlay.innerHTML = html;
            overlay.classList.remove("hidden");
            overlay.classList.add("flex");
            return;
          }

          const itemCourseKey = app.normalizeCourseKey(
            item?.courseName || app.getCourseNameByClassId(item?.classId),
          );
          const defaultCourse =
            courses.find((c) => c.key === itemCourseKey) || courses[0];
          const defaultClassId = Number(defaultCourse.classId);
          const defaultPercent = Math.min(
            100,
            Math.max(0, Number(item?.coveragePercent) || 0),
          );
          const defaultSession = Math.max(
            0,
            Math.floor(Number(item?.sessionNo) || 0),
          );
          const defaultUntil = this.escapeHtml(String(item?.taughtUntil || ""));
          const defaultNextTopic = this.escapeHtml(
            String(item?.nextTopic || ""),
          );

          const html = `
            <div class="theme-card p-6 w-full max-w-md shadow-2xl animate-fade-in" onclick="ui.stopEvent(event)"
                 style="background: color-mix(in srgb, var(--card-bg) 90%, transparent);">
              <h3 class="text-xl font-black mb-4">${title} ${STR.courseProgressBoard}</h3>

              <form id="courseProgressForm" class="space-y-3">
                <input type="hidden" id="cp_id" value="${item ? item.id : ""}">

                <div class="text-[11px] opacity-70 font-black">${STR.noteClass}</div>
                <select class="inp" id="cp_class" required>
                  ${courses
                    .map(
                      (c) =>
                        `<option value="${c.classId}" ${Number(c.classId) === defaultClassId ? "selected" : ""}>${this.escapeHtml(c.name)}${c.prof ? ` - ${this.escapeHtml(c.prof)}` : ""}</option>`,
                    )
                    .join("")}
                </select>

                <div class="text-[11px] opacity-70 font-black">${STR.progressUntil}</div>
                <textarea class="inp min-h-[100px]" id="cp_until" placeholder="${STR.progressUntil}" required>${defaultUntil}</textarea>

                <div class="grid grid-cols-2 gap-2">
                  <div>
                    <div class="text-[11px] opacity-70 font-black mb-1">${STR.progressPercent}</div>
                    <input
                      type="range"
                      id="cp_percent_range"
                      min="0"
                      max="100"
                      step="1"
                      value="${defaultPercent}"
                      class="w-full accent-[var(--accent)]"
                    />
                  </div>
                  <div>
                    <div class="text-[11px] opacity-70 font-black mb-1">${STR.progressPercent}</div>
                    <input class="inp" type="number" id="cp_percent" min="0" max="100" step="1" value="${defaultPercent}">
                  </div>
                </div>

                <div class="grid grid-cols-2 gap-2">
                  <div>
                    <div class="text-[11px] opacity-70 font-black mb-1">${STR.progressSession}</div>
                    <input class="inp" type="number" id="cp_session" min="0" step="1" value="${defaultSession}">
                  </div>
                  <div>
                    <div class="text-[11px] opacity-70 font-black mb-1">${STR.progressNextTopic}</div>
                    <input class="inp" type="text" id="cp_next" placeholder="${STR.progressNextTopic}" value="${defaultNextTopic}">
                  </div>
                </div>

                <div class="flex gap-2 mt-4 pt-2" style="border-top: 1px solid var(--border);">
                  <button type="submit" class="flex-1 py-2.5 bg-[var(--accent)] text-[var(--bg)] font-black rounded-2xl hover:brightness-110 shadow-xl">${STR.save}</button>
                  ${item ? `<button type="button" onclick="app.deleteCourseProgress(${item.id})" class="px-3 py-2.5 text-red-500 hover:bg-red-500/10 rounded-2xl font-black">${STR.delete}</button>` : ""}
                  <button type="button" onclick="ui.closeModal()" class="px-3 py-2.5 opacity-70 hover:opacity-100 rounded-2xl font-black">${STR.cancel}</button>
                </div>
              </form>
            </div>
          `;

          const overlay = document.getElementById("modalOverlay");
          overlay.innerHTML = html;
          overlay.classList.remove("hidden");
          overlay.classList.add("flex");

          const percentRangeEl = document.getElementById("cp_percent_range");
          const percentInputEl = document.getElementById("cp_percent");

          const syncPercent = (raw) => {
            const value = Math.min(
              100,
              Math.max(0, Math.round(Number(raw) || 0)),
            );
            if (percentRangeEl) percentRangeEl.value = String(value);
            if (percentInputEl) percentInputEl.value = String(value);
          };

          if (percentRangeEl) {
            percentRangeEl.addEventListener("input", () =>
              syncPercent(percentRangeEl.value),
            );
          }
          if (percentInputEl) {
            percentInputEl.addEventListener("input", () =>
              syncPercent(percentInputEl.value),
            );
          }
          syncPercent(defaultPercent);

          document.getElementById("courseProgressForm").onsubmit = (ev) => {
            ev.preventDefault();

            const classId = Number(document.getElementById("cp_class").value);
            const selectedCourse =
              courses.find((c) => Number(c.classId) === classId) || null;
            const taughtUntil = document
              .getElementById("cp_until")
              .value.trim();
            const coveragePercent = Number(
              document.getElementById("cp_percent").value || 0,
            );
            const sessionNo = Number(
              document.getElementById("cp_session").value || 0,
            );
            const nextTopic = document.getElementById("cp_next").value.trim();

            if (!Number.isFinite(classId)) {
              alert(STR.progressClassRequired);
              return;
            }
            if (!taughtUntil) {
              alert(STR.progressUntilRequired);
              return;
            }

            app.addCourseProgress({
              id: document.getElementById("cp_id").value
                ? Number(document.getElementById("cp_id").value)
                : null,
              classId,
              courseName: selectedCourse ? selectedCourse.name : "",
              taughtUntil,
              coveragePercent,
              sessionNo,
              nextTopic,
            });
          };
        },

        openClassModalPrefill(ev, day, start, end) {
          if (ev?.target?.closest?.(".class-card")) return;
          this.openClassModal(null);
          setTimeout(() => {
            const d = document.getElementById("f_day");
            const s = document.getElementById("f_start");
            const e = document.getElementById("f_end");
            if (d) d.value = String(day);
            if (s) s.value = start;
            if (e) e.value = app.addMinutes(start, CLASS_DURATION_MINUTES);
          }, 0);
        },

        openClassModalFromCard(ev, id) {
          if (ev) ev.stopPropagation();
          this.openClassModal(id);
        },

        stopEvent(ev) {
          if (ev) ev.stopPropagation();
        },

        openClassModal(id = null) {
          const c = id ? app.data.classes.find((x) => x.id === id) : null;
          const title = c ? STR.modalEdit : STR.modalAdd;
          const initialStart = c ? c.start : "08:00";
          const initialEnd = c
            ? c.end
            : app.addMinutes(initialStart, CLASS_DURATION_MINUTES);

          const html = `
          <div class="theme-card p-6 w-full max-w-md shadow-2xl animate-fade-in" onclick="ui.stopEvent(event)"
               style="background: color-mix(in srgb, var(--card-bg) 90%, transparent);">
            <h3 class="text-xl font-black mb-4">${title} ${STR.course}</h3>

            <form id="classForm" class="space-y-3">
              <input type="hidden" id="f_id" value="${c ? c.id : ""}">

              <input class="inp" type="text" id="f_name" placeholder="${STR.course}" value="${this.escapeHtml(c ? c.name || "" : "")}" required>

              <div class="text-[11px] font-black class-number-label">${STR.classNumber}</div>
              <input class="inp inp-class-number" type="text" id="f_class_no" placeholder="${STR.classNumber}" value="${this.escapeHtml(c ? c.classNo || "" : "")}">

              <input class="inp" type="text" id="f_prof" placeholder="${STR.prof}" value="${this.escapeHtml(c ? c.prof || "" : "")}">

              <div class="flex gap-2">
                <input class="inp w-1/3" type="number" id="f_unit" placeholder="${STR.unit}" value="${c ? c.unit : 3}">
                <select class="inp w-2/3" id="f_day">
                  ${STR.days.map((d, i) => `<option value="${i}" ${c && c.day == i ? "selected" : ""}>${d}</option>`).join("")}
                </select>
              </div>

              <div class="flex gap-2">
                <input class="inp w-1/2" type="time" id="f_start" value="${initialStart}" step="1800">
                <input class="inp w-1/2 opacity-80" type="time" id="f_end" value="${initialEnd}" readonly tabindex="-1">
              </div>
              <div class="text-[11px] opacity-70 font-black">${STR.classDurationFixed}</div>

              <select class="inp" id="f_type">
                <option value="normal" ${c && c.type == "normal" ? "selected" : ""}>${STR.typeNormal}</option>
                <option value="odd" ${c && c.type == "odd" ? "selected" : ""}>${STR.typeOdd}</option>
                <option value="even" ${c && c.type == "even" ? "selected" : ""}>${STR.typeEven}</option>
              </select>

              <input class="inp" type="text" id="f_note" placeholder="${STR.notes}" value="${this.escapeHtml(c ? c.note || "" : "")}">

              <div class="flex gap-2 mt-4 pt-2" style="border-top: 1px solid var(--border);">
                <button type="submit" class="flex-1 py-2.5 bg-[var(--accent)] text-[var(--bg)] font-black rounded-2xl hover:brightness-110 shadow-xl">${STR.save}</button>
                ${c ? `<button type="button" onclick="app.deleteClass(${c.id})" class="px-3 py-2.5 text-red-500 hover:bg-red-500/10 rounded-2xl font-black">${STR.delete}</button>` : ""}
                <button type="button" onclick="ui.closeModal()" class="px-3 py-2.5 opacity-70 hover:opacity-100 rounded-2xl font-black">${STR.cancel}</button>
              </div>
            </form>
          </div>
        `;

          const overlay = document.getElementById("modalOverlay");
          overlay.innerHTML = html;
          overlay.classList.remove("hidden");
          overlay.classList.add("flex");

          const startInput = document.getElementById("f_start");
          const endInput = document.getElementById("f_end");
          const syncDuration = () => {
            if (!startInput || !endInput) return;
            endInput.value = app.addMinutes(
              startInput.value || "08:00",
              CLASS_DURATION_MINUTES,
            );
          };
          if (startInput) startInput.addEventListener("input", syncDuration);
          syncDuration();

          document.getElementById("classForm").onsubmit = (e) => {
            e.preventDefault();
            const name = document.getElementById("f_name").value.trim();
            const start = document.getElementById("f_start").value;
            const end = app.addMinutes(start, CLASS_DURATION_MINUTES);

            if (!name) {
              alert("   .");
              return;
            }
            if (!start) {
              alert(STR.classStartRequired);
              return;
            }

            app.addClass({
              id: document.getElementById("f_id").value
                ? Number(document.getElementById("f_id").value)
                : null,
              name,
              classNo: document.getElementById("f_class_no").value.trim(),
              prof: document.getElementById("f_prof").value.trim(),
              unit: Math.max(
                0,
                Number(document.getElementById("f_unit").value || 0),
              ),
              day: Number(document.getElementById("f_day").value),
              start,
              end,
              type: document.getElementById("f_type").value,
              note: document.getElementById("f_note").value.trim(),
            });
          };
        },

        openExamModal(id = null) {
          const ex = id ? app.data.exams.find((x) => x.id === id) : null;
          const title = ex ? STR.modalEdit : STR.modalAdd;
          const notifyBeforeDefault = NOTIFY_BEFORE_OPTIONS.includes(
            Number(ex?.notifyBeforeMin),
          )
            ? Number(ex.notifyBeforeMin)
            : 0;
          const notifyEnabledDefault =
            typeof ex?.notifyEnabled === "boolean" ? ex.notifyEnabled : true;
          const notifyTextDefault = String(ex?.notifyText || ex?.title || "");

          const html = `
          <div class="theme-card p-6 w-full max-w-md shadow-2xl animate-fade-in" onclick="ui.stopEvent(event)"
               style="background: color-mix(in srgb, var(--card-bg) 90%, transparent);">
            <h3 class="text-xl font-black mb-4">${title} ${STR.exams}</h3>

            <form id="examForm" class="space-y-3">
              <input type="hidden" id="e_id" value="${ex ? ex.id : ""}">
              <input class="inp" type="text" id="e_title" placeholder="Title" value="${this.escapeHtml(ex ? ex.title : "")}" required>

              <div class="grid grid-cols-2 gap-2">
                <input class="inp" type="date" id="e_date" value="${this.escapeHtml(ex ? ex.date : "")}" required>
                <input class="inp" type="time" id="e_time" value="${this.escapeHtml(ex ? ex.time : "")}" required>
              </div>

              <div class="text-[11px] opacity-80 font-black">${STR.alertDay}: <span id="e_day">-</span></div>

              <input class="inp" type="text" id="e_loc" placeholder="Location/Note" value="${this.escapeHtml(ex ? ex.location || "" : "")}">

                <div>
                  <div class="text-[11px] opacity-70 font-black mb-1">${STR.notifyWhen}</div>
                  <select class="inp" id="e_notify_before">
                    <option value="0" ${notifyBeforeDefault === 0 ? "selected" : ""}>${STR.notifyAtTime}</option>
                    <option value="5" ${notifyBeforeDefault === 5 ? "selected" : ""}>${STR.notifyBefore5}</option>
                    <option value="10" ${notifyBeforeDefault === 10 ? "selected" : ""}>${STR.notifyBefore10}</option>
                    <option value="15" ${notifyBeforeDefault === 15 ? "selected" : ""}>${STR.notifyBefore15}</option>
                    <option value="20" ${notifyBeforeDefault === 20 ? "selected" : ""}>${STR.notifyBefore20}</option>
                    <option value="30" ${notifyBeforeDefault === 30 ? "selected" : ""}>${STR.notifyBefore30}</option>
                    <option value="45" ${notifyBeforeDefault === 45 ? "selected" : ""}>${STR.notifyBefore45}</option>
                    <option value="60" ${notifyBeforeDefault === 60 ? "selected" : ""}>${STR.notifyBefore60}</option>
                    <option value="90" ${notifyBeforeDefault === 90 ? "selected" : ""}>${STR.notifyBefore90}</option>
                    <option value="120" ${notifyBeforeDefault === 120 ? "selected" : ""}>${STR.notifyBefore120}</option>
                    <option value="180" ${notifyBeforeDefault === 180 ? "selected" : ""}>${STR.notifyBefore180}</option>
                    <option value="360" ${notifyBeforeDefault === 360 ? "selected" : ""}>${STR.notifyBefore360}</option>
                    <option value="720" ${notifyBeforeDefault === 720 ? "selected" : ""}>${STR.notifyBefore720}</option>
                    <option value="1440" ${notifyBeforeDefault === 1440 ? "selected" : ""}>${STR.notifyBefore1440}</option>
                    <option value="2880" ${notifyBeforeDefault === 2880 ? "selected" : ""}>${STR.notifyBefore2880}</option>
                    <option value="10080" ${notifyBeforeDefault === 10080 ? "selected" : ""}>${STR.notifyBefore10080}</option>
                  </select>
                </div>

              <div>
                <div class="text-[11px] opacity-70 font-black mb-1">${STR.notifyText}</div>
                <input class="inp" type="text" id="e_notify_text" placeholder="${STR.notifyText}" value="${this.escapeHtml(notifyTextDefault)}">
              </div>

              <label class="flex items-center gap-2 text-xs font-black opacity-85 cursor-pointer">
                <input type="checkbox" id="e_notify_enabled" class="accent-green-500" ${notifyEnabledDefault ? "checked" : ""}>
                <span> ${STR.notifyEnabled}</span>
              </label>

              <div class="flex gap-2 mt-4 pt-2" style="border-top: 1px solid var(--border);">
                <button type="submit" class="flex-1 py-2.5 bg-[var(--accent)] text-[var(--bg)] font-black rounded-2xl hover:brightness-110 shadow-xl">${STR.save}</button>
                ${ex ? `<button type="button" onclick="app.deleteExam(${ex.id})" class="px-3 py-2.5 text-red-500 hover:bg-red-500/10 rounded-2xl font-black">${STR.delete}</button>` : ""}
                <button type="button" onclick="ui.closeModal()" class="px-3 py-2.5 opacity-70 hover:opacity-100 rounded-2xl font-black">${STR.cancel}</button>
              </div>
            </form>
          </div>
        `;

          const overlay = document.getElementById("modalOverlay");
          overlay.innerHTML = html;
          overlay.classList.remove("hidden");
          overlay.classList.add("flex");

          const examDateEl = document.getElementById("e_date");
          const examDayEl = document.getElementById("e_day");
          const syncExamDay = () => {
            if (!examDateEl || !examDayEl) return;
            examDayEl.textContent = app.getAlertDayLabel(examDateEl.value);
          };
          if (examDateEl) examDateEl.addEventListener("input", syncExamDay);
          syncExamDay();

          document.getElementById("examForm").onsubmit = (ev) => {
            ev.preventDefault();
            const title = document.getElementById("e_title").value.trim();
            const date = document.getElementById("e_date").value;
            const time = document.getElementById("e_time").value;
            const notifyBeforeMin = Number(
              document.getElementById("e_notify_before").value || 0,
            );
            const notifyText = document
              .getElementById("e_notify_text")
              .value.trim();
            const notifyEnabled =
              document.getElementById("e_notify_enabled").checked;

            if (!title) {
              alert("   .");
              return;
            }
            if (!date) {
              alert(STR.examDateRequired);
              return;
            }
            if (!time) {
              alert(STR.examTimeRequired);
              return;
            }
            if (notifyEnabled && !notifyText) {
              alert(STR.examNotifyTextRequired);
              return;
            }

            if (notifyEnabled) app.requestNotificationPermission(false);

            app.addExam({
              id: document.getElementById("e_id").value
                ? Number(document.getElementById("e_id").value)
                : null,
              title,
              date,
              time,
              location: document.getElementById("e_loc").value.trim(),
              notifyBeforeMin,
              notifyText,
              notifyEnabled,
            });
          };
        },

        openNoteModal(id = null, forceImportant = false) {
          const note = id ? app.data.notes.find((x) => x.id === id) : null;
          const title = note ? STR.modalEdit : STR.modalAdd;
          const classes = app.data.classes
            .slice()
            .sort(
              (a, b) =>
                a.day * 10000 +
                a.start.replace(":", "") -
                (b.day * 10000 + b.start.replace(":", "")),
            );

          if (classes.length === 0) {
            const html = `
          <div class="theme-card p-6 w-full max-w-md shadow-2xl animate-fade-in" onclick="ui.stopEvent(event)"
               style="background: color-mix(in srgb, var(--card-bg) 90%, transparent);">
            <h3 class="text-xl font-black mb-4">${STR.notesBoard}</h3>
            <p class="text-sm opacity-80 mb-4">         .</p>
            <button type="button" onclick="ui.closeModal()" class="w-full py-2.5 bg-[var(--accent)] text-[var(--bg)] font-black rounded-2xl hover:brightness-110 shadow-xl">${STR.cancel}</button>
          </div>
        `;
            const overlay = document.getElementById("modalOverlay");
            overlay.innerHTML = html;
            overlay.classList.remove("hidden");
            overlay.classList.add("flex");
            return;
          }

          const importantDefault = Boolean(note?.important || forceImportant);
          const alertDateDefault =
            note?.alertDate || new Date().toISOString().slice(0, 10);
          const alertTimeDefault = note?.alertTime || "09:00";
          const notifyBeforeDefault = NOTIFY_BEFORE_OPTIONS.includes(
            Number(note?.notifyBeforeMin),
          )
            ? Number(note.notifyBeforeMin)
            : 0;
          const notifyEnabledDefault =
            typeof note?.notifyEnabled === "boolean"
              ? note.notifyEnabled
              : importantDefault;
          const notifyTextDefault = String(
            note?.notifyText || note?.text || "",
          );

          const html = `
          <div class="theme-card p-6 w-full max-w-md shadow-2xl animate-fade-in" onclick="ui.stopEvent(event)"
               style="background: color-mix(in srgb, var(--card-bg) 90%, transparent);">
            <h3 class="text-xl font-black mb-4">${title} ${STR.notesBoard}</h3>

            <form id="noteForm" class="space-y-3">
              <input type="hidden" id="n_id" value="${note ? note.id : ""}">

              <div class="text-[11px] opacity-70 font-black">${STR.noteClass}</div>
              <select class="inp" id="n_class" required>
                ${classes
                  .map(
                    (c) =>
                      `<option value="${c.id}" ${note && note.classId === c.id ? "selected" : ""}>${this.escapeHtml(c.name)} - ${STR.days[c.day]} (${c.start}-${c.end})</option>`,
                  )
                  .join("")}
              </select>

              <div class="text-[11px] opacity-70 font-black">${STR.noteText}</div>
              <textarea class="inp min-h-[120px]" id="n_text" placeholder="${STR.noteText}" required>${note ? this.escapeHtml(note.text) : ""}</textarea>

              <label class="flex items-center gap-2 text-xs font-black opacity-85 cursor-pointer">
                <input type="checkbox" id="n_important" class="accent-red-500" ${importantDefault ? "checked" : ""}>
                <span> ${STR.pinAlert}</span>
              </label>

              <div id="n_alert_block" class="space-y-3 ${importantDefault ? "" : "hidden"}">
                <div class="grid grid-cols-2 gap-2">
                  <div>
                    <div class="text-[11px] opacity-70 font-black mb-1">${STR.alertDate}</div>
                    <input class="inp" type="date" id="n_alert_date" value="${alertDateDefault}">
                  </div>
                  <div>
                    <div class="text-[11px] opacity-70 font-black mb-1">${STR.alertTime}</div>
                    <input class="inp" type="time" id="n_alert_time" value="${alertTimeDefault}">
                  </div>
                </div>

                <div class="text-[11px] opacity-80 font-black">${STR.alertDay}: <span id="n_alert_day">-</span></div>

                <div>
                  <div class="text-[11px] opacity-70 font-black mb-1">${STR.notifyWhen}</div>
                  <select class="inp" id="n_notify_before">
                    <option value="0" ${notifyBeforeDefault === 0 ? "selected" : ""}>${STR.notifyAtTime}</option>
                    <option value="5" ${notifyBeforeDefault === 5 ? "selected" : ""}>${STR.notifyBefore5}</option>
                    <option value="10" ${notifyBeforeDefault === 10 ? "selected" : ""}>${STR.notifyBefore10}</option>
                    <option value="15" ${notifyBeforeDefault === 15 ? "selected" : ""}>${STR.notifyBefore15}</option>
                    <option value="20" ${notifyBeforeDefault === 20 ? "selected" : ""}>${STR.notifyBefore20}</option>
                    <option value="30" ${notifyBeforeDefault === 30 ? "selected" : ""}>${STR.notifyBefore30}</option>
                    <option value="45" ${notifyBeforeDefault === 45 ? "selected" : ""}>${STR.notifyBefore45}</option>
                    <option value="60" ${notifyBeforeDefault === 60 ? "selected" : ""}>${STR.notifyBefore60}</option>
                    <option value="90" ${notifyBeforeDefault === 90 ? "selected" : ""}>${STR.notifyBefore90}</option>
                    <option value="120" ${notifyBeforeDefault === 120 ? "selected" : ""}>${STR.notifyBefore120}</option>
                    <option value="180" ${notifyBeforeDefault === 180 ? "selected" : ""}>${STR.notifyBefore180}</option>
                    <option value="360" ${notifyBeforeDefault === 360 ? "selected" : ""}>${STR.notifyBefore360}</option>
                    <option value="720" ${notifyBeforeDefault === 720 ? "selected" : ""}>${STR.notifyBefore720}</option>
                    <option value="1440" ${notifyBeforeDefault === 1440 ? "selected" : ""}>${STR.notifyBefore1440}</option>
                    <option value="2880" ${notifyBeforeDefault === 2880 ? "selected" : ""}>${STR.notifyBefore2880}</option>
                    <option value="10080" ${notifyBeforeDefault === 10080 ? "selected" : ""}>${STR.notifyBefore10080}</option>
                  </select>
                </div>

                <div>
                  <div class="text-[11px] opacity-70 font-black mb-1">${STR.notifyText}</div>
                  <input class="inp" type="text" id="n_notify_text" placeholder="${STR.notifyText}" value="${this.escapeHtml(notifyTextDefault)}">
                </div>

                <label class="flex items-center gap-2 text-xs font-black opacity-85 cursor-pointer">
                  <input type="checkbox" id="n_notify_enabled" class="accent-green-500" ${notifyEnabledDefault ? "checked" : ""}>
                  <span> ${STR.notifyEnabled}</span>
                </label>
              </div>

              <div class="flex gap-2 mt-4 pt-2" style="border-top: 1px solid var(--border);">
                <button type="submit" class="flex-1 py-2.5 bg-[var(--accent)] text-[var(--bg)] font-black rounded-2xl hover:brightness-110 shadow-xl">${STR.save}</button>
                ${note ? `<button type="button" onclick="app.deleteNote(${note.id})" class="px-3 py-2.5 text-red-500 hover:bg-red-500/10 rounded-2xl font-black">${STR.delete}</button>` : ""}
                <button type="button" onclick="ui.closeModal()" class="px-3 py-2.5 opacity-70 hover:opacity-100 rounded-2xl font-black">${STR.cancel}</button>
              </div>
            </form>
          </div>
        `;

          const overlay = document.getElementById("modalOverlay");
          overlay.innerHTML = html;
          overlay.classList.remove("hidden");
          overlay.classList.add("flex");

          const importantEl = document.getElementById("n_important");
          const alertBlockEl = document.getElementById("n_alert_block");
          const alertDateEl = document.getElementById("n_alert_date");
          const alertDayEl = document.getElementById("n_alert_day");
          const notifyEnabledEl = document.getElementById("n_notify_enabled");

          const syncAlertBlock = () => {
            if (!importantEl || !alertBlockEl) return;
            const isOn = importantEl.checked;
            alertBlockEl.classList.toggle("hidden", !isOn);
            if (!isOn && notifyEnabledEl) notifyEnabledEl.checked = false;
          };

          const syncAlertDay = () => {
            if (!alertDayEl || !alertDateEl) return;
            alertDayEl.textContent = app.getAlertDayLabel(alertDateEl.value);
          };

          if (importantEl)
            importantEl.addEventListener("change", syncAlertBlock);
          if (alertDateEl) alertDateEl.addEventListener("input", syncAlertDay);
          syncAlertBlock();
          syncAlertDay();

          document.getElementById("noteForm").onsubmit = (ev) => {
            ev.preventDefault();

            const classId = Number(document.getElementById("n_class").value);
            const text = document.getElementById("n_text").value.trim();
            const important = document.getElementById("n_important").checked;
            const alertDate = important
              ? document.getElementById("n_alert_date").value
              : "";
            const alertTime = important
              ? document.getElementById("n_alert_time").value
              : "";
            const notifyBeforeMin = important
              ? Number(document.getElementById("n_notify_before").value || 0)
              : 0;
            const notifyText = important
              ? document.getElementById("n_notify_text").value.trim()
              : "";
            const notifyEnabled = important
              ? document.getElementById("n_notify_enabled").checked
              : false;

            if (!Number.isFinite(classId)) {
              alert("    .");
              return;
            }
            if (!text) {
              alert("   .");
              return;
            }
            if (important && !alertDate) {
              alert(STR.alertDateRequired);
              return;
            }
            if (important && !alertTime) {
              alert(STR.alertTimeRequired);
              return;
            }
            if (important && notifyEnabled && !notifyText) {
              alert(STR.notifyTextRequired);
              return;
            }

            if (important && notifyEnabled) {
              app.requestNotificationPermission(false);
            }

            app.addNote({
              id: document.getElementById("n_id").value
                ? Number(document.getElementById("n_id").value)
                : null,
              classId,
              text,
              important,
              alertDate,
              alertTime,
              notifyBeforeMin,
              notifyText,
              notifyEnabled,
              createdAt: note?.createdAt || new Date().toISOString(),
            });
          };
        },

        closeModal() {
          const overlay = document.getElementById("modalOverlay");
          overlay.classList.add("hidden");
          overlay.classList.remove("flex");
        },
      };

      document.getElementById("modalOverlay").onclick = ui.closeModal;
      window.onload = () => app.init();
    </script>
  </body>
</html>
